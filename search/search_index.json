{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"index.html","title":"Documentation Civiparoisse","text":"<p>Cette documentation vise trois publics distincts, mais qui peuvent chacun avoir besoin de l'ensemble des informations disponibles :</p> <ul> <li> <p>les utilisateurs de CiviParoisse : la section de documentation utilisateur vise \u00e0 fournir des informations pratiques quant \u00e0 l'utilisation de Civiparoisse, et \u00e0 les accompagner dans les manipulations. La section de formation permet aux utilisateurs de se former aux fonctionnalit\u00e9s de CiviParoisse.</p> </li> <li> <p>les membres du groupe de travail Civiparoisse : la section de documentation technique va concerner plus particuli\u00e8rement les personnes int\u00e9ress\u00e9es par les aspects informatiques.</p> </li> <li> <p>les futurs utilisateurs : la section de documentation de pr\u00e9sentation donne des explications globales sur le projet, et vise notamment \u00e0 proposer une information pr\u00e9alable aux paroisses qui seraient int\u00e9ress\u00e9es par Civiparoisse.</p> </li> </ul> <p>Bonne lecture !</p> <p>Si vous voulez en savoir plus sur le projet Civiparoisse, vous \u00eates invit\u00e9s \u00e0 contacter le Service Communication de l'UEPAL.</p>"},{"location":"FORMATION/index.html","title":"Formations CiviParoisse en ligne","text":""},{"location":"FORMATION/index.html#formations-pour-les-utilisateurs-de-civiparoisse","title":"Formations pour les utilisateurs de CiviParoisse","text":"<p>Retrouvez ici toutes les ressources de formation pour vous aider \u00e0 mieux utiliser CiviParoisse :</p> <ul> <li>Exercices de formation en ligne</li> <li>Diaporamas pr\u00e9sentant pas \u00e0 pas les fonctionnalit\u00e9s les plus courantes</li> </ul>"},{"location":"FORMATION/index.html#formations-pour-les-redacteurs-de-laide-en-ligne","title":"Formations pour les r\u00e9dacteurs de l'aide en ligne","text":"<ul> <li>Ressources Markdown</li> </ul>"},{"location":"FORMATION/DIAPORAMAS/index.html","title":"DIAPORAMAS","text":"<p>Vous trouverez ci-dessous les liens vers les diaporamas. Pas \u00e0 pas, d\u00e9couvrez les fonctionnalit\u00e9s les plus courantes de CiviParoisse.</p> <p>Page en cours d'\u00e9criture</p>"},{"location":"FORMATION/EXERCICES/index.html","title":"Exercices en ligne","text":"<p>Vous trouverez ci-dessous les liens vers les exercices en ligne. Familiarisez-vous avec les fonctionnalit\u00e9s de CiviParoisse, en suivant pas \u00e0 pas les consignes.</p> <p>Page en cours d'\u00e9criture</p>"},{"location":"FORMATION/EXERCICES/index.html#liste-des-tests","title":"Liste des tests","text":"<ul> <li>01 - Connexion Et Affichage</li> <li>02 - Cr\u00e9ation d'un Foyer</li> <li>03 - Cr\u00e9ation d'un Individu</li> </ul>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html","title":"01 - Connexion et affichage","text":""},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#001-connexion-a-la-base-de-donnees","title":"001 - Connexion \u00e0 la base de donn\u00e9es","text":"<ol> <li>Connectez-vous \u00e0 la base de donn\u00e9es en suivant les consignes donn\u00e9es par ailleurs.</li> <li>CONFIRMEZ que vous arrivez sur la page d\u2019accueil de CiviParoisse.</li> </ol>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#002-deconnexion-a-la-fermeture-de-la-fenetre-du-navigateur","title":"002 - D\u00e9connexion \u00e0 la fermeture de la fen\u00eatre du navigateur","text":"<ol> <li>Connectez-vous \u00e0 la base de donn\u00e9es avec Nom d\u2019Utilisateur et Mot de Passe.</li> <li>Une fois connect\u00e9 fermez la fen\u00eatre du navigateur par la X de fermeture du coin haut droit.</li> <li>Ouvrez une nouvelle fen\u00eatre du navigateur et saisissez \u00e0 nouveau l\u2019URL de test de CiviParoisse.</li> <li>CONFIRMEZ que vous avez bien acc\u00e8s \u00e0 la base de donn\u00e9es sans avoir \u00e0 vous connecter avec Nom d\u2019Utilisateur et Mot de Passe.</li> </ol> <p>Pour information : Civi Paroisse ne pr\u00e9voit une d\u00e9connexion automatique qu\u2019apr\u00e8s plusieurs jours.</p>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#003-deconnexion-par-la-barre-menu-civiparoisse","title":"003 - D\u00e9connexion par la barre Menu CiviParoisse","text":"<ol> <li>D\u00e9connectez-vous de CiviParoisse via le menu, dans le bandeau noir en haut de l\u2019\u00e9cran, en cliquant sur le \u00ab triangle vert \u00bb sur la gauche du menu.</li> <li>Retournez \u00e0 la page d\u2019accueil.</li> <li>CONFIRMEZ que vous devez \u00e0 nouveau saisir le nom d\u2019utilisateur et le mot de passe.</li> </ol>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#004-deconnexion-automatique","title":"004 - D\u00e9connexion automatique","text":"<p>Ce test est \u00e0 r\u00e9aliser sur plusieurs jours, et n\u00e9cessite de ne pas utiliser CiviParoisse durant plus d\u2019une semaine. Nous vous conseillons de le r\u00e9aliser \u00e0 la fin de votre s\u00e9rie de tests.</p> <ol> <li>Se connectez \u00e0 CiviParoisse selon la proc\u00e9dure habituelle.</li> <li>Fermez l\u2019onglet CiviParoisse dans votre navigateur.</li> <li>Ne pas utiliser CiviParoisse pendant plus d\u2019une semaine.</li> <li>Apr\u00e8s ce d\u00e9lai, saisissez l\u2019URL de test de CiviParoisse dans votre navigateur.</li> <li>CONFIRMEZ que vous devez saisir votre Nom d\u2019Utilisateur et votre Mot de passe.</li> </ol>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#005-affichage-des-elements-civiparoisse-sur-la-page-daccueil","title":"005 - Affichage des \u00e9l\u00e9ments CiviParoisse sur la page d'accueil","text":"<ol> <li>CONFIRMEZ que la page d'accueil affiche, entre autres, les \u00e9l\u00e9ments suivants :<ol> <li>Menu CiviParoisse.</li> <li>Liste des anniversaires des 7 prochains jours.</li> </ol> </li> </ol>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#006-boutons-du-menu-civiparoisse","title":"006 - Boutons du Menu CiviParoisse","text":"<ol> <li>Sur la page d'accueil, cliquez sur chaque bouton du Menu CiviParoisse.</li> <li>CONFIRMEZ qu'une nouvelle page s'affiche (et que cette page semble coh\u00e9rente avec le titre du bouton).</li> <li>Effectuez la m\u00eame manipulation avec le menu Paroisses dans le menu en haut de l'\u00e9cran.</li> <li>CONFIRMEZ qu\u2019une nouvelle page s\u2019affiche pour chaque item du menu (et que cette page semble coh\u00e9rente avec le titre du menu).</li> </ol>"},{"location":"FORMATION/EXERCICES/01_ConnexionEtAffichage.html#007-acces-au-mode-demploi","title":"007 - Acc\u00e8s au Mode d'emploi","text":"<ol> <li>Dans le menu CiviParoisse, cliquez sur le bouton Aide en ligne, et confirmez que la page \"Modes d'emploi CiviParoisse\" s'affiche.</li> <li>Sur la page qui s\u2019affiche, dans la partie Mode d\u2019emploi Utilisateurs, cliquez sur le lien \"Lien vers la documentation\".</li> <li>CONFIRMEZ que le mode d'emploi s'ouvre dans un nouvel onglet.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html","title":"02 - Cr\u00e9ation d'un foyer","text":""},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#001-remplir-le-formulaire-foyer-en-completant-tous-les-champs-et-valider-que-ces-donnees-se-retrouvent-bien-sur-la-fiche-foyer-ainsi-creee","title":"001 - Remplir le Formulaire Foyer en compl\u00e9tant tous les champs, et valider que ces donn\u00e9es se retrouvent bien sur la fiche Foyer ainsi cr\u00e9\u00e9e","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouveau Foyer \u00bb sur la page d\u2019accueil</li> <li>Remplissez tous les champs du formulaire et cliquer sur Enregistrer en bas de page.</li> <li>CONFIRMEZ que le foyer soit bien enregistr\u00e9, avec toutes les informations saisies, en le recherchant dans CiviParoisse.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#002-creer-un-foyer-sans-adresse","title":"002 - Cr\u00e9er un foyer sans adresse","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouveau Foyer \u00bb sur la page d\u2019accueil</li> <li>Remplissez le champ \u00ab Nom du Foyer \u00bb et cliquer sur Enregistrer en bas de page.</li> <li>CONFIRMEZ que l\u2019alerte d\u2019informations non renseign\u00e9es apparait. </li> <li>Compl\u00e9tez les informations manquantes.</li> <li>CONFIRMEZ que le foyer est bien enregistr\u00e9, en le recherchant dans CiviParoisse.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#003-creer-un-foyer-sans-numero-de-telephone-domicile","title":"003 - Cr\u00e9er un foyer sans Num\u00e9ro de t\u00e9l\u00e9phone domicile","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouveau Foyer \u00bb sur la page d\u2019accueil.</li> <li>Remplissez tous les champs except\u00e9 \u00ab T\u00e9l\u00e9phone Fixe Domicile \u00bb et cliquer sur enregistrer en bas de page.</li> <li>CONFIRMEZ que l\u2019alerte d\u2019informations non renseign\u00e9es apparait.</li> <li>CONFIRMEZ que le foyer a \u00e9t\u00e9 enregistr\u00e9 avec toutes les donn\u00e9es renseign\u00e9es except\u00e9 le T\u00e9l\u00e9phone fixe domicile.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#004-creer-un-foyer-sans-quartier","title":"004 - Cr\u00e9er un foyer sans quartier","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouveau Foyer \u00bb.</li> <li>Remplissez tous les champs except\u00e9 \u00ab Quartier (distribution, visiteurs\u2026) \u00bb et cliquer sur enregistrer en bas de page.</li> <li>CONFIRMEZ que le foyer a \u00e9t\u00e9 enregistr\u00e9 avec toutes les donn\u00e9es renseign\u00e9es except\u00e9 le quartier.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#005-saisie-dun-numero-de-telephone-correct-avec-indicatif-et-espace-et-sans-points","title":"005 - Saisie d\u2019un num\u00e9ro de t\u00e9l\u00e9phone correct (avec indicatif et espace et sans points)","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouveau Foyer \u00bb du menu Civi Paroisse.</li> <li>Remplissez le champ \u00ab Nom de Foyer \u00bb.</li> <li>Saisissez un num\u00e9ro de t\u00e9l\u00e9phone avec indicatif, espaces et sans point (au format +33 (0)X XX XX XX XX).</li> <li>Compl\u00e9tez les autres informations obligatoires.</li> <li>Cliquez sur Enregistrer en bas de page.</li> <li>CONFIRMEZ que le num\u00e9ro de t\u00e9l\u00e9phone est bien enregistr\u00e9 dans la fiche foyer (au m\u00eame format).</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#006-rajouter-une-note-a-une-fiche-foyer","title":"006 - Rajouter une Note \u00e0 une fiche Foyer","text":"<p>(F\u00e9vrier 2025) Description du test \u00e0 revoir. Merci de ne pas l\u2019effectuer en attendant.</p> <ol> <li>Ouvrez une fiche Foyer en passant par le menu Rechercher puis Rechercher les Contacts et en s\u00e9lectionnant pour la recherche le type de contact \u00ab Foyer \u00bb.</li> <li>Cliquez sur \u00ab Rechercher \u00bb</li> <li>S\u00e9lectionnez une fiche en cliquant sur \u00ab plus \u00bb (\u00e0 droite) puis \u00ab ajouter une note \u00bb.</li> <li>Remplissez les champs et enregistrez.</li> <li>Ouvrez la fiche en cliquant sur le nom du Foyer.</li> <li>CONFIRMEZ que la note apparait dans la fiche, sous \u00ab notes \u00bb en haut de page.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#007-regles-de-validation-nom-du-foyer","title":"007 - R\u00e8gles de validation Nom du Foyer","text":"<ol> <li>Cr\u00e9er un nouveau Foyer avec le formulaire de cr\u00e9ation disponible sur la page d'accueil.</li> <li>Saisissez un nom de foyer avec des caract\u00e8res sp\u00e9ciaux (comme &amp;, \u00a3, @, \u2026).</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger le nom du foyer.</li> <li>Corrigez la saisie en remplissant le nom du foyer sans caract\u00e8res sp\u00e9ciaux.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#008-regles-de-validation-nom-de-la-ville","title":"008 - R\u00e8gles de validation Nom de la Ville","text":"<ol> <li>Cr\u00e9ez un nouveau Foyer avec le formulaire de cr\u00e9ation disponible sur la page d'accueil.</li> <li>Saisissez un nom de ville contenant des caract\u00e8res sp\u00e9ciaux (comme &amp;, \u00a3, @, \u2026).</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger le nom de la ville.</li> <li>Corrigez la saisie en remplissant le nom de la ville, sans caract\u00e8res sp\u00e9ciaux.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/02_CreationFoyer.html#009-champ-mode-de-distribution-du-journal","title":"009 - Champ Mode de distribution du journal","text":"<ol> <li>Cr\u00e9ez une fiche Foyer \u00e0 partir du bouton sur la page d'accueil, et renseigner le mode de distribution du journal.</li> <li>Recherchez la fiche ainsi cr\u00e9\u00e9e.</li> <li>CONFIRMEZ que le Mode de distribution est correctement renseign\u00e9.</li> <li>Sur une fiche Foyer existante, modifiez le mode de distribution du journal.</li> <li>CONFIRMEZ que la modification est correctement enregistr\u00e9e.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html","title":"03 - Cr\u00e9ation d'un individu","text":""},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#001-creer-une-fiche-uniquement-avec-les-champs-obligatoires-a-partir-du-menu-accueil","title":"001 - Cr\u00e9er une fiche uniquement avec les champs obligatoires \u00e0 partir du menu \u00ab Accueil \u00bb","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Commencez la cr\u00e9ation d\u2019une fiche sur la page qui s\u2019ouvre.</li> <li>Cliquez sur la fen\u00eatre intitul\u00e9e \u00ab Choisir le Foyer ou l'Organisation d'appartenance \u00bb.</li> <li>Faites le choix dans la liste d\u00e9roulante.</li> <li>A la ligne Statut Individu, faites le choix (Adulte ou enfant) en cliquant dans la pastille correspondant \u00e0 votre choix.</li> <li>Dans le bloc d\u2019information \u00ab Civilit\u00e9 \u00bb, cochez la pastille correspondant \u00e0 la Civilit\u00e9 et au Genre.</li> <li>Renseignez le lien avec la paroisse, en cochant le bouton correspond.</li> <li>Remplissez les autres champs et listes d\u00e9roulantes.</li> <li>Cliquer sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>CONFIRMEZ que les informations ont \u00e9t\u00e9 prises en compte en recherchant la fiche de l\u2019individu.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#002-creer-une-fiche-en-omettant-1-champ-obligatoire-a-partir-du-menu-accueil","title":"002 - Cr\u00e9er une fiche en omettant 1 champ obligatoire \u00e0 partir du menu \u00ab Accueil \u00bb","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Cliquez sur la fen\u00eatre intitul\u00e9e \u00ab Choisir le Foyer ou l'Organisation d'appartenance \u00bb.</li> <li>Cliquez sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>CONFIRMEZ qu\u2019un message d\u2019erreur s\u2019affiche.</li> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Allez jusqu\u2019\u00e0 la partie intitul\u00e9e : Statut Individu.</li> <li>Faites le choix (Adulte ou enfant) en cliquant dans la pastille correspondant \u00e0 votre choix.</li> <li>Cliquez sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>CONFIRMEZ qu\u2019un message d\u2019erreur s\u2019affiche.</li> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Allez jusqu\u2019\u00e0 la partie intitul\u00e9e : \u00ab Civilit\u00e9 \u00bb.</li> <li>Cochez les pastilles correspondantes \u00e0 Civilit\u00e9 et \u00e0 Genre.</li> <li>Cliquez sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>CONFIRMEZ qu\u2019un message d\u2019erreur s\u2019affiche.</li> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Allez jusqu\u2019\u00e0 la partie intitul\u00e9e : Liens avec la Paroisse.</li> <li>Cochez la pastille correspondante.</li> <li>Cliquez sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>CONFIRMEZ qu\u2019un message d\u2019erreur s\u2019affiche.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#003-valider-le-formulaire-rempli-integralement-et-verifier-le-bon-resultat-champ-par-champ-a-partir-du-menu-accueil","title":"003 - Valider le formulaire rempli int\u00e9gralement et v\u00e9rifier le bon r\u00e9sultat champ par champ \u00e0 partir du menu \u00ab Accueil \u00bb","text":"<ol> <li>Cliquez sur l\u2019ic\u00f4ne \u00ab Nouvel individu / Particulier \u00bb sur la page d\u2019accueil.</li> <li>Commencez la cr\u00e9ation d\u2019une fiche sur la page qui s\u2019ouvre.</li> <li>Cliquez sur la fen\u00eatre intitul\u00e9e Choisir le Foyer ou l'Organisation d'appartenance.</li> <li>Faites le choix dans la liste d\u00e9roulante.</li> <li>Statut Individu : Faites le choix (Adulte ou enfant) en cliquant dans la pastille correspondant \u00e0 votre choix.</li> <li>Renseignez les deux fen\u00eatres Nom des parents, Nom des fr\u00e8res et s\u0153urs avec les listes d\u00e9roulantes.</li> <li>Dans le bloc d\u2019information \u00ab Civilit\u00e9 \u00bb, cochez les pastilles correspondantes \u00e0 la Civilit\u00e9 et au Genre.</li> <li>Par la suite renseignez les fen\u00eatres suivantes : Nom de famille et Nom de naissance.</li> <li>Faites le choix dans le calendrier pour renseigner la Date de naissance.</li> <li>Renseignez la fen\u00eatre Lieu de naissance.</li> <li>Renseignez les fen\u00eatres de bloc Information Contact : T\u00e9l\u00e9phone Portable Personnel, T\u00e9l\u00e9phone Professionnel, Courriel Personnel, Courriel professionnel, M\u00e9tier.</li> <li>Renseignez les Liens avec la Paroisse en cochant la pastille correspondante.</li> <li>Renseignez les listes d\u00e9roulantes Groupes et Etiquettes.</li> <li>Informations sur le couple : renseignez les fen\u00eatres propos\u00e9es, pour les informations suivantes :     a. S\u00e9lectionner le conjoint ou partenaire     b. Type de relation     c. Date du mariage     d. Date de la b\u00e9n\u00e9diction nuptiale     e. Paroisse de mariage     f. Verset de mariage     g. Divorc\u00e9 ?     h. Date de divorce     i. Date de veuvage</li> <li>Informations sur la religion : renseignez les fen\u00eatres propos\u00e9es, pour les informations suivantes :     a. Religion     b. Date de pr\u00e9sentation     c. Paroisse de pr\u00e9sentation     d. Date de bapt\u00eame     e. Paroisse de bapt\u00eame     f. Verset de bapt\u00eame     g. Date de confirmation     h. Paroisse de confirmation     i. Verset de confirmation</li> <li>Informations sur les musiciens : renseignez les fen\u00eatres propos\u00e9es, pour les informations suivantes :     a. Comp\u00e9tence Musique : instrument     b. Comp\u00e9tence Musique : voix     c. Num\u00e9ro de S\u00e9curit\u00e9 Sociale     d. Num\u00e9ro Guso     e. Fonctionnaire ?</li> <li>Cliquez sur la fen\u00eatre grise \u00ab Enregistrer \u00bb.</li> <li>Recherchez et ouvrez la fiche ainsi cr\u00e9e.</li> <li>CONFIRMEZ que la fiche contient correctement l\u2019ensemble des renseignements que vous avez saisis ci-dessus.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#004-liste-des-paroisses","title":"004 - Liste des paroisses","text":"<ol> <li>Commencez la cr\u00e9ation d\u2019un nouvel Individu, \u00e0 partir du bouton sur la page d\u2019accueil.</li> <li>CONFIRMEZ la pr\u00e9sence des paroisses suivantes dans la liste des paroisses, dans les champs \"Lieu de\u2026\" (mariage, pr\u00e9sentation, bapt\u00eame, etc\u2026) :<ul> <li>Strasbourg</li> <li>Mulhouse</li> <li>Sondernach</li> <li>Saint-Avold</li> <li>Bouxwiller</li> </ul> </li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#005-regles-de-validation-conjoints","title":"005 - R\u00e8gles de validation Conjoints","text":"<ol> <li>Cr\u00e9ez un nouvel Individu avec le formulaire de cr\u00e9ation disponible sur la page d'accueil</li> <li>A la partie \u00ab S\u00e9lectionner le conjoint ou partenaire \u00bb, choisissez le nom d'un conjoint, sans indiquer si c'est un \"Conjoint de\" ou un \"Partenaire de\".</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 renseigner le type de relation.</li> <li>Recommencez la cr\u00e9ation cette fois-ci en indiquant le type de relation, mais sans indiquer le nom du conjoint.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 renseigner le nom du conjoint.</li> <li>Corrigez la saisie en remplissant le nom du conjoint.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#006-regle-de-validation-mail","title":"006 - R\u00e8gle de validation Mail","text":"<ol> <li>Cr\u00e9ez un nouvel Individu avec le formulaire de cr\u00e9ation disponible sur la page d'accueil.</li> <li>Renseignez le champ Mail, en indiquant une adresse mail sans \u00e9crire le @ (arobase).</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger la saisie.</li> <li>Recommencez la cr\u00e9ation cette fois-ci en mettant des accents ou des caract\u00e8res sp\u00e9ciaux dans l\u2019adresse mail.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger la saisie.</li> <li>Corrigez la saisie en remplissant le mail correctement.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#007-regle-de-validation-lien-enfants-parents","title":"007 - R\u00e8gle de validation Lien enfants - parents","text":"<ol> <li>Cr\u00e9ez un nouvel Individu avec le formulaire de cr\u00e9ation disponible sur la page d'accueil.</li> <li>Indiquez que l\u2019Individu est un Enfant, et pas un Adulte, dans le champ Statut Individu. Mais ne renseignez pas le nom des parents.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger la saisie.</li> <li>Corrigez la saisie en remplissant le nom des parents.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#008-regle-de-validation-lien-fonctionnaire-guso","title":"008 - R\u00e8gle de validation Lien Fonctionnaire &amp; Guso","text":"<ol> <li>Cr\u00e9ez un nouvel Individu avec le formulaire de cr\u00e9ation disponible sur la page d'accueil.</li> <li>Indiquez un num\u00e9ro GUSO tout en bas du formulaire. Mais ne renseignez pas le champ Fonctionnaire.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ qu'un message d'erreur s'affiche demandant \u00e0 corriger la saisie.</li> <li>Corrigez la saisie en remplissant le champ Fonctionnaire.</li> <li>Validez la saisie.</li> <li>CONFIRMEZ que le message d\u2019erreur ne s\u2019affiche plus.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#009-creation-de-ladresse","title":"009 - Cr\u00e9ation de l'adresse","text":"<ol> <li>Cr\u00e9ez un nouvel Individu \u00e0 partir du bouton en page d'accueil, en le rattachant \u00e0 un foyer existant (et pour lequel une adresse est enregistr\u00e9e).</li> <li>Renseignez les autres champs obligatoires de la fiche.</li> <li>A la fin de la cr\u00e9ation, recherchez la fiche de ce nouvel individu. </li> <li>CONFIRMEZ que l'adresse du Foyer est correctement renseign\u00e9e sur la fiche de l'Individu.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#010-rajouter-une-photo-a-un-individu","title":"010 - Rajouter une photo \u00e0 un individu","text":"<ol> <li>Allez dans la fiche individuelle d\u2019un individu.</li> <li>Cliquez sur Modifier .</li> <li>Dans le bloc \u00ab Fiche contact \u00bb, cliquez sur \u00ab Parcourir \u00bb (Parcourir/t\u00e9l\u00e9charger une image).</li> <li>Enregistrez.</li> <li>CONFIRMEZ que la photo est visible sur la fiche de l\u2019Individu.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#011-rajouter-une-note-a-un-individu","title":"011 - Rajouter une Note \u00e0 un Individu","text":"<ol> <li>Allez dans la fiche individuelle d\u2019un individu.</li> <li>Cliquez sur le champ .</li> <li>Cr\u00e9ez une nouvelle note.</li> <li>Enregistrez.</li> <li>CONFIRMEZ que la note est visible sur la fiche individuelle de contact.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#012-rajouter-une-relation-a-une-fiche-existante","title":"012 - Rajouter une relation \u00e0 une fiche existante","text":"<ol> <li>Ouvrez une fiche Individu.</li> <li>Rajoutez une relation avec une autre fiche.</li> <li>CONFIRMEZ que la relation est visible sur la fiche de l\u2019Individu.</li> <li>Ouvrez la fiche avec laquelle la relation a \u00e9t\u00e9 cr\u00e9\u00e9.</li> <li>CONFIRMEZ que la relation est \u00e9galement visible sur l\u2019autre fiche.</li> <li>Ouvrez une fiche Foyer.</li> <li>Recommencez les points 2 \u00e0 5 (avec une autre relation).</li> <li>Ouvrez une fiche Organisation (la cr\u00e9er si besoin).</li> <li>Recommencez les points 2 \u00e0 5 (avec une autre relation).</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#013-supprimer-une-relation-a-une-fiche-existante","title":"013 - Supprimer une relation \u00e0 une fiche existante","text":"<ol> <li>Ouvrez une fiche Individu.</li> <li>Supprimez une des relations existantes.</li> <li>CONFIRMEZ que la Relation n\u2019est pas visible en tant que relation active.</li> <li>Allez sur l\u2019autre fiche qui \u00e9tait en relation.</li> <li>CONFIRMEZ que la Relation n\u2019est plus non plus visible.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#014-supprimer-un-individu-de-la-base","title":"014 - Supprimer un Individu de la base","text":"<ol> <li>Ouvrez une fiche Individu.</li> <li>Cliquez sur le bouton Actions.</li> <li>Choisissez Supprimer.</li> <li>Validez la suppression.</li> <li>CONFIRMEZ que la fiche est marqu\u00e9e avec un trait rouge barr\u00e9.</li> <li>Effectuez une recherche de la fiche.</li> <li>CONFIRMEZ que la fiche n\u2019est pas visible.</li> <li>Allez dans Rechercher / Recherche avanc\u00e9e (bandeau noir en haut de l\u2019\u00e9cran).</li> <li>Saisissez le nom de la fiche supprim\u00e9e dans \u00ab Nom complet ou partiel \u00bb.</li> <li>Dans les \u00ab Crit\u00e8res de base \u00bb, cliquez sur Rechercher dans la corbeille (Search Deleted Contacts).</li> <li>Cliquez sur Rechercher.</li> <li>CONFIRMEZ que la fiche est visible.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#015-restaurer-un-individu-supprime-par-erreur","title":"015 - Restaurer un Individu supprim\u00e9 par erreur","text":"<p>Ce test est \u00e0 effectuer apr\u00e8s avoir effectu\u00e9 le test ci-dessus (\u00ab Supprimer un Individu de la base \u00bb)</p> <ol> <li>Allez dans Rechercher / Recherche avanc\u00e9e.</li> <li>Saisissez le nom de la fiche concern\u00e9e dans \u00ab Nom complet ou partiel \u00bb.</li> <li>Dans les \u00ab Crit\u00e8res de base \u00bb, cliquer sur Rechercher dans la corbeille (Search Deleted Contacts).</li> <li>CONFIRMEZ que la fiche est visible.</li> <li>Cliquez sur la fiche.</li> <li>Cliquez sur le bouton Restaurer de la Corbeille.</li> <li>Validez la restauration de la fiche.</li> <li>CONFIRMEZ que la fiche n\u2019est pas plus barr\u00e9e de rouge.</li> <li>CONFIRMEZ que les anciennes relations sont bien \u00e0 nouveau affich\u00e9es.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#016-supprimer-un-individu-definitivement-de-la-base","title":"016 - Supprimer un Individu d\u00e9finitivement de la base","text":"<ol> <li>Reproduisez les \u00e9tapes du test 015 \u00ab Supprimer un Individu de la base \u00bb.</li> <li>Allez dans Rechercher / Recherche avanc\u00e9e.</li> <li>Saisissez le nom de la fiche concern\u00e9e dans \u00ab Nom complet ou partiel \u00bb.</li> <li>Dans les \u00ab Crit\u00e8res de base \u00bb, cliquez sur Rechercher dans la corbeille (Search Deleted Contacts).</li> <li>CONFIRMEZ que la fiche est visible.</li> <li>Cliquez sur la fiche.</li> <li>Cliquez sur le bouton \u00ab Supprimer d\u00e9finitivement \u00bb.</li> <li>Effectuez une recherche de la fiche.</li> <li>CONFIRMEZ que la fiche n\u2019est pas visible.</li> <li>Allez dans Rechercher / Recherche avanc\u00e9e.</li> <li>Dans les \u00ab Crit\u00e8res de base \u00bb, cliquez sur Rechercher dans la corbeille (Search Deleted Contacts).</li> <li>CONFIRMEZ que la fiche est n\u2019est plus visible.</li> </ol>"},{"location":"FORMATION/EXERCICES/03_CreationIndividu.html#017-fusionner-deux-fiches-du-meme-individu","title":"017 - Fusionner deux fiches du m\u00eame individu","text":"<p>Ce test sera document\u00e9 prochainement, merci d\u2019y revenir ult\u00e9rieurement.</p>"},{"location":"FORMATION/RESSOURCES/Ressources_Markdown.html","title":"Ressources Markdown","text":""},{"location":"FORMATION/RESSOURCES/Ressources_Markdown.html#titre1","title":"Titre1","text":""},{"location":"FORMATION/RESSOURCES/Ressources_Markdown.html#titre-niveau-2","title":"Titre niveau 2","text":""},{"location":"FORMATION/RESSOURCES/Ressources_Markdown.html#titre-niveau-3","title":"Titre niveau 3","text":"<p>gras</p> <p>italique</p> <p><code>extrait de code</code></p> <ul> <li>item niveau 1</li> <li>item niveau 1</li> <li>item niveau 2</li> <li> <p>item niveau 2</p> </li> <li> <p>item niveau 1</p> </li> <li>item niveau 1</li> <li>item niveau 2</li> </ul> <p>https://www.uepal.fr : lien direct</p> <p>lien vers site uepal</p> <p>lien vers une autre page</p> <p>lien vers une autre page avec ancre</p> <p></p> <p>TEST_PAS_ITALIQUE</p> <p>Tableau:</p> titre 1 titre2 data1 data2 data3 data4 <pre><code>FROM ubuntu\nCMD [bash]\n</code></pre> <p>Titre \u00e0 afficher</p> <p>Texte du warning</p> <p>Titre de la note</p> <p>Texte de la note</p> <p>Titre de la note abstract</p> <p>Texte du bloc</p> <p>Titre de l'information</p> <p>Texte de de l'information</p> <p>Titre de la note</p> <p>Texte du bloc</p> <p>Titre de la question</p> <p>Texte de la question</p> <p>Titre de l'avertissement</p> <p>Texte de l'avertissement</p> <p>Titre du bug</p> <p>Texte du bug</p> <p>Titre de l'exemple</p> <p>Texte de l'exemple</p> <p>Titre de la citation</p> <p>Texte de la citation</p> <p>Texte du bloc sans titre</p> <p>Titre de l'information</p> <p>Texte de l'information \u00e0 droite du texte</p> <p>Texte plac\u00e9 \u00e0 gauche du bloc information. Ce texte prend plusieurs lignes, pour occuper la place. Et une ligne de plus.</p> <p>Titre de l'information</p> <p>Texte de l'information \u00e0 gauche du texte</p> <p>Texte plac\u00e9 \u00e0 droite du bloc information. Ce texte prend plusieurs lignes, pour occuper la place. Et une ligne de plus.</p> Bloc developpable <p>Texte du bloc</p>"},{"location":"FORMATION/RESSOURCES/Ressources_Markdown.html#icones","title":"Ic\u00f4nes","text":"<p> Foyer  Individu  Organisation  Loupe  CiviCRM  </p>"},{"location":"PRESENTATION/index.html","title":"Pr\u00e9sentation du projet","text":"<p>Les documents de cette section ont pour objectif de d\u00e9finir le p\u00e9rim\u00e8tre et l'\u00e9cosyst\u00e8me du projet.</p> <p>De ce fait, on trouve :</p> <ul> <li>le p\u00e9rim\u00e8tre fonctionnel du projet</li> <li>la description de l'\u00e9cosyst\u00e8me du projet</li> <li>la description des livrables du projet</li> </ul>"},{"location":"PRESENTATION/presentation_ecosysteme.html","title":"Pr\u00e9sentation de l'\u00e9cosyst\u00e8me de Civiparoisse dans un contexte de communication de masse avec du public","text":"<p>Civiparoisse est un outil qui s'int\u00e8gre dans un projet paroissial. Ce syst\u00e8me d'information s'int\u00e8gre dans un environnement dont nous vous proposons de comprendre le r\u00f4le.</p>"},{"location":"PRESENTATION/presentation_ecosysteme.html#un-outil-simple-au-service-dune-organisation-et-dun-projet","title":"Un outil simple, au service d'une organisation et d'un projet","text":"<p>En entreprise, on consid\u00e8re fr\u00e9quemment que l'\u00e9l\u00e9ment fondateur est \"l'id\u00e9e de l'entreprise\", qui se mod\u00e9lise dans un business plan, une strat\u00e9gie, qui comporte des objectifs \u00e0 atteindre. L'entreprise se dote d'une structuration, une organisation, dont le but est d'atteindre les objectifs. L'organisation est elle-m\u00eame \u00e9paul\u00e9e \u00e0 travers d'outils, dont le syst\u00e8me d'information, pour atteindre les objectifs.</p> <p>En paroisse, la situation est analogue :</p> <ul> <li>l'\u00e9l\u00e9ment fondateur de la paroisse est la volont\u00e9 de constituer une communaut\u00e9 de paroissiens, avec un projet paroissial.</li> <li>l'organisation de la paroisse vise \u00e0 mettre en musique ce projet de vie paroissiale, au travers des structures institutionnelles (conseil presbyt\u00e9ral, consistoire, inspection, Uepal) mais \u00e9galement au travers de structures locales (groupes de rencontres comme groupe de bricolage, groupe musical, chorale, \u00e9cole du dimanche, cat\u00e9chisme, \u00e9tude biblique, ...) qui contribuent \u00e0 ce projet.</li> <li>les diff\u00e9rents acteurs de la paroisse ont besoin d'\u00e9changer des informations, pour lequel la mise en oeuvre d'un syst\u00e8me d'information peut faciliter les \u00e9changes.</li> </ul> <p>Le syst\u00e8me d'information (SI) est donc un support, mais non une fin en soi. La structure du SI en elle-m\u00eame importe peu, l'essentiel est qu'il facilite les \u00e9changes d'informations. Ce support a par exemple contribu\u00e9 \u00e0 maintenir le lien entre les paroissiens durant les p\u00e9riodes de confinement ou de distanciation sociale. L'int\u00e9gration de l'informatique, support de communication utilis\u00e9 dans la vie quotidienne, fait qu'une informatisation des paroisses devient un atout important pour s'adapter aux habitudes et besoins des paroissiens courants ou \u00e0 venir : les paroisses doivent donc disposer d'une certaine identit\u00e9 num\u00e9rique, qui va \u00eatre surtout utile \u00e0 la communication interne ou externe.</p> <p>Civiparoisse n'est donc in fine qu'un outil qui pourra rentrer dans le cadre du syst\u00e8me d'information, mais qui ne se suffit pas \u00e0 lui-m\u00eame.</p>"},{"location":"PRESENTATION/presentation_ecosysteme.html#positionnement-de-civiparoisse","title":"Positionnement de CiviParoisse","text":"<p>CiviParoisse veut faciliter des points \u00e9voqu\u00e9s au-dessus, comme :</p> <ul> <li>la gestion de la connaissance des relations avec vos interlocuteurs (paroissiens notamment, mais pas que)</li> <li>la cr\u00e9ation de lettres d'informations et de mailings cibl\u00e9s. Il aura \u00e9galement des d\u00e9pendances sur d'autres \u00e9l\u00e9ments techniques et informatiques (nom de domaine, certificats SSL, adresses de messagerie, charte graphique, etc...). Son utilisation s'int\u00e8gre donc dans des d\u00e9marches globales qui doivent avoir \u00eat\u00e9 r\u00e9fl\u00e9chies au pr\u00e9alable. C'est donc un outil dont il faut apprendre \u00e0 se servir. L'\u00e9quipe d'accompagnement Civiparoisse vous aidera bien entendu dans la structuration du projet pour votre paroisse, et vous accompagnera dans l'apprentissage de ce nouvel outil.</li> </ul>"},{"location":"PRESENTATION/presentation_ecosysteme.html#pour-aller-plus-loin-communication-sur-internet-identite-numerique-crm-rapports-webmarketing-outils","title":"Pour aller plus loin : communication sur Internet, identit\u00e9 num\u00e9rique, CRM, rapports, webmarketing, outils","text":"<p>La communication suppose plusieurs \u00e9l\u00e9ments :</p> <ul> <li>un \u00e9metteur : source du message</li> <li>un r\u00e9cepteur : cible du message</li> <li>un support : un medium de communication</li> <li>un code de communication : des conventions communes pour r\u00e9ussir \u00e0 faire passer le contenu</li> <li>un contenu : le sens que l'on veut faire passer.</li> </ul> <p>On d\u00e9duit de la liste pr\u00e9c\u00e9dente que l'\u00e9metteur doit \u00eatre identifi\u00e9, d'o\u00f9 la notion d'identit\u00e9 num\u00e9rique qui est \u00e0 d\u00e9velopper dans le cadre des communications sur Internet. Cette identit\u00e9 num\u00e9rique prend plusieurs formes :</p> <ul> <li>une charte graphique : un format de pr\u00e9sentation avec des signes distinctifs (jeux de couleurs, style de pr\u00e9sentation, logo)...</li> <li>un nom de domaine associ\u00e9 \u00e0 l'entit\u00e9</li> <li>des adresses de services (adresse de messagerie, num\u00e9ro de t\u00e9l\u00e9phone pour les SMS, adresse SIP pour les communications VoIP...)</li> <li>un ou plut\u00f4t plusieurs certificats SSL (certificats pour l'identit\u00e9, pour la signature)</li> </ul> <p>La connaissance du r\u00e9cepteur est \u00e9galement importante, puisque le code de communication est commun \u00e0 l'\u00e9metteur et au r\u00e9cepteur : on pourrait donc en particulier prendre soin de certains \u00e9l\u00e9ments comme le langage, les valeurs, les r\u00e9f\u00e9rences connues de l'\u00e9metteur et du r\u00e9cepteur. Cette connaissance est ce qui est traditionnellement g\u00e9r\u00e9/stock\u00e9 par les CRM (Customer Relationship Management), et les \u00e9metteurs cherchent \u00e0 extraire des donn\u00e9es depuis cette connaissance pour affiner au plus juste la communication par rapport au r\u00e9cepteur : le datamining, qui peut prendre des formes aussi simple que des extractions de rapports, ou des formes plus compliqu\u00e9es comme l'application d'algorithmes d'intelligence artificielle par exemple pour effectuer une segmentation des r\u00e9cepteurs.</p> <p>La possibilit\u00e9 de communiquer est n\u00e9cessaire en tant que support pour atteindre les objectifs du projet paroissial. De ce fait, il est int\u00e9ressant de chercher \u00e0 appliquer des notions de marketing \u00e0 cet effet, et de webmarketing dans le cadre des communications num\u00e9riques, afin de mettre le plus de chances de son c\u00f4t\u00e9 possible d'atteindre le but.</p> <p>Le support joue \u00e9galement un grand r\u00f4le, car les supports peuvent \u00eatre diversifi\u00e9s et compl\u00e9mentaires :</p> <ul> <li>le site web peut fournir une vision \"institutionnelle\" de la paroisse. Il s'adresse \u00e0 un public large, avec des parties de sites \u00e9ventuellement pr\u00e9par\u00e9es pour satisfaire l'int\u00e9r\u00eat de publics plus restreints. Il peut \u00e9galement se faire l'\u00e9cho de l'actualit\u00e9 d'une paroisse</li> <li>la lettre d'information pourra permettre de se tenir au courant de l'actualit\u00e9 de mani\u00e8re passive (sans faire d'action sp\u00e9cifique pour le r\u00e9cepteur)</li> <li>les mailings cibl\u00e9s : diffusion d'information \u00e0 des groupes, comme par exemple les participants \u00e0 une activit\u00e9</li> </ul>"},{"location":"PRESENTATION/presentation_fonctionnelle.html","title":"Civiparoisse : Aspects fonctionnels","text":"<p>Le projet CiviParoisse est un projet r\u00e9cent, qui fournit aux paroisses un outil de gestion op\u00e9rationnelle. Le projet a \u00e9t\u00e9 confort\u00e9 par le virage num\u00e9rique suite \u00e0 la crise sanitaire de 2020. Ce document pr\u00e9sente les diff\u00e9rents aspects du projet (notamment fonctionnels, techniques, organisationnels).</p>"},{"location":"PRESENTATION/presentation_fonctionnelle.html#introduction","title":"Introduction","text":"<p>Les fonctionnalit\u00e9s qui sont requises par les paroisses peuvent \u00eatre globalement regroup\u00e9es en 4 familles :</p> <ul> <li>La connaissance des personnes en lien avec la paroisse</li> <li>La communication avec ces personnes</li> <li>Les statistiques de la paroisse</li> <li>Une aide pour certains sujets de gestion li\u00e9s \u00e0 la paroisse.</li> </ul>"},{"location":"PRESENTATION/presentation_fonctionnelle.html#la-connaissance-des-personnes-en-lien-avec-la-paroisse-les-acteurs-de-la-paroisse","title":"La connaissance des personnes en lien avec la paroisse (les acteurs de la paroisse)","text":"<p>La connaissance des personnes en lien avec la paroisse est un \u00e9l\u00e9ment essentiel : une paroisse est en premier lieu une communaut\u00e9 de personnes, dont les interactions vont contribuer \u00e0 la vie de la paroisse. Cette connaissance requiert de conna\u00eetre et de mettre \u00e0 jour des donn\u00e9es personnelles usuelles (nom, pr\u00e9nom, adresse, t\u00e9l\u00e9phone, mail, \u2026), mais \u00e9galement des donn\u00e9es familiales (filiation), de m\u00eame que des donn\u00e9es sensibles (ayant trait \u00e0 la religion).</p> <p>On parle ici d\u2019acteurs de la paroisse, car des personnes de diff\u00e9rents profils peuvent y figurer :</p> <ul> <li>Les paroissiens, c\u2019est \u00e0 dire les membres de la paroisse, ainsi que des personnes ressources pour la paroisse (exemple : le tr\u00e9sorier de la paroisse)</li> <li>Des personnes externes mais dont il faut conserver les donn\u00e9es pour des situations particuli\u00e8res (exemple : informations sur les parents s\u00e9par\u00e9s d\u2019un cat\u00e9chum\u00e8ne)</li> <li>Des personnes morales peuvent \u00e9galement \u00eatre enregistr\u00e9es (exemples : entreprises, associations, institutions locales comme la municipalit\u00e9 ou une communaut\u00e9 de communes)</li> <li>Des groupes comme par exemple les activit\u00e9s paroissiales (exemples : chorale, cat\u00e9chum\u00e8nes, sacristains, organistes, ouvroir, \u2026), ou aussi des groupes ponctuels de communication</li> </ul> <p>Outre les donn\u00e9es sur les acteurs en eux-m\u00eames, il est \u00e9galement important de pouvoir disposer de pr\u00e9cisions sur la relation entre les acteurs : par exemple, dans le cadre d\u2019une famille, savoir qui sont les parents et qui sont les enfants. Ou bien dans le cadre d'une activit\u00e9, savoir qui est le responsable de l'activit\u00e9. Ces relations peuvent d\u2019ailleurs \u00e9voluer dans le temps (ex : les conseillers presbyt\u00e9raux, qui ont des mandats limit\u00e9s dans la dur\u00e9e), mais peuvent \u00e9galement \u00eatre multiples (ex : certains conseillers presbyt\u00e9raux sont en plus membre du bureau ; des paroissiens peuvent \u00eatre des membres consultatifs du conseil presbyt\u00e9ral pour des domaines d\u2019expertise sp\u00e9cifique, ...).</p>"},{"location":"PRESENTATION/presentation_fonctionnelle.html#la-communication-avec-les-acteurs-de-la-paroisse","title":"La communication avec les acteurs de la paroisse","text":"<p>La communication des paroisses repose traditionnellement sur plusieurs vecteurs :</p> <ul> <li>les annonces lors des cultes</li> <li>le journal paroissial papier</li> <li>le bouche \u00e0 oreille</li> <li>les appels t\u00e9l\u00e9phoniques</li> </ul> <p>Ces m\u00e9thodes sont peu adapt\u00e9es aux \u00e9volutions technologiques du XXI\u00e8me si\u00e8cle :</p> <ul> <li>le mail</li> <li>les r\u00e9seaux sociaux</li> <li>les sites web.</li> </ul> <p>Civiparoisse cherche \u00e0 optimiser la communication par mail envers les diff\u00e9rents acteurs. On peut distinguer plusieurs cas d\u2019utilisation :</p> <ul> <li>La newsletter : c\u2019est le pendant \u00e9lectronique du journal paroissial, avec des informations \u00ab g\u00e9n\u00e9rales \u00bb. Ces mails s'adressent souvent \u00e0 un public tr\u00e8s large.</li> <li>Les campagnes de mails cibl\u00e9s : on envoie des mails avec des informations sur des sujets pr\u00e9cis \u00e0 des personnes s\u00e9lectionn\u00e9es en fonction des crit\u00e8res li\u00e9s \u00e0 la connaissance des acteurs</li> <li>La communication vers une personne : Civiparoisse peut afficher dans les mails les coordonn\u00e9es d\u2019une personne, et ainsi permettre l'envoi de mails individualis\u00e9s. Il sera m\u00eame \u00e0 terme envisageable de simplifier les appels t\u00e9l\u00e9phoniques, par clic sur le num\u00e9ro de t\u00e9l\u00e9phone.</li> <li>Les mails syst\u00e8me d\u2019administration : logs, alertes, \u2026</li> </ul> <p>Dans le cas d\u2019une communication pour le compte de la paroisse, il y a des besoins compl\u00e9mentaires, mais qui sortent du cadre du projet :</p> <ul> <li>L'identit\u00e9 num\u00e9rique de la paroisse sur internet : son site web</li> <li>L'identit\u00e9 visuelle de la paroisse, dont d\u00e9coulent des chartes graphiques pour les diff\u00e9rents m\u00e9dias</li> <li>Des connaissances et comp\u00e9tences en webmarketing, notamment pour les communications de masse</li> <li>L'organisation \u00e0 un niveau plus global : projet de paroisse, organisation interne de la paroisse pour r\u00e9aliser ses projets, stockage des donn\u00e9es num\u00e9riques, ...</li> </ul> <p>Le projet Civiparoisse n\u2019a pas vocation \u00e0 h\u00e9berger un site web de paroisse, en raison de la nature des donn\u00e9es op\u00e9rationnelles d\u00e9j\u00e0 h\u00e9berg\u00e9es, qui ne sont pas publiques. De m\u00eame, les r\u00e9seaux sociaux sont des outils externes qui se situent plut\u00f4t sur des plateformes h\u00e9berg\u00e9es tierces (YouTube, Facebook, Twitter, LinkedIn\u2026) avec d\u2019\u00e9ventuelles int\u00e9grations sur un site web qui ne sont pas non plus pr\u00e9vues dans ce projet.</p>"},{"location":"PRESENTATION/presentation_fonctionnelle.html#les-statistiques-de-la-paroisse","title":"Les statistiques de la paroisse","text":"<p>Les paroisses sont consommatrices de statistiques, pour des fins diverses :</p> <ul> <li>Rapport sur les diff\u00e9rents \u00e9v\u00e8nements : les bapt\u00eames, confirmations, mariage, d\u00e9c\u00e8s sur l\u2019ann\u00e9e \u00e9coul\u00e9e</li> <li>Rapports op\u00e9rationnels : liste des personnes ayant un anniversaire proche, liste des donn\u00e9es qui commencent \u00e0 dater et doivent donc \u00eatre v\u00e9rifi\u00e9es, les paroissiens pr\u00e9sents sur un secteur donn\u00e9, etc...</li> <li>Analyses des donn\u00e9es collect\u00e9es, pour mieux ajuster le projet de paroisse : rapports d\u00e9mographiques, rapports sur les comp\u00e9tences\u2026</li> </ul>"},{"location":"PRESENTATION/presentation_fonctionnelle.html#laide-pour-certains-besoins-de-gestion","title":"L'aide pour certains besoins de gestion","text":"<p>La paroisse est tenue de maintenir le registre paroissial, duquel on doit pouvoir sortir au besoin une proposition de liste des \u00e9lecteurs. La gestion de ces documents n\u00e9cessite le traitement d\u2019informations pr\u00e9cises, que ce soit sur les croyances, le bapt\u00eame, le lieu de r\u00e9sidence.</p> <p>Un autre p\u00f4le de ce besoin est la g\u00e9n\u00e9ration de re\u00e7us de dons, ce qui implique donc le traitement de donn\u00e9es comptables.</p> <p>Ces besoins d'aide s\u2019int\u00e8grent dans les autres besoins \u00e9voqu\u00e9s ci-dessus, sans se substituer aux obligations l\u00e9gales de la paroisse, et seront amen\u00e9s \u00e0 \u00e9voluer pour s\u2019adapter aux \u00e9volutions des textes (droit local, r\u00e8glement int\u00e9rieur des \u00e9glises, d\u00e9cisions du Directoire de l\u2019UEPAL, d\u00e9cisions pr\u00e9fectorales\u2026).</p>"},{"location":"PRESENTATION/presentation_livrables.html","title":"Pr\u00e9sentation des livrables Civiparoisse","text":"<p>La philosophie du projet est de laisser les paroisses qui souhaitent utiliser Civiparoisse libres et responsables de leurs choix. De ce fait, Civiparoisse d\u00e9finit un certain nombre de livrables que les paroisses pourront utiliser si elles le souhaitent. Ces livrables correspondent \u00e0 des niveaux d'int\u00e9gration de Civiparoisse dans des environnements de plus en plus \u00e9tendus. </p>"},{"location":"PRESENTATION/presentation_livrables.html#approches-envisagees-pour-les-paroisses","title":"Approches envisag\u00e9es pour les paroisses","text":"<p>La mise en \u0153uvre de la solution est envisageable sous trois formes, en fonction des souhaits des paroisses :</p> <ul> <li> <p>Mise \u00e0 disposition d\u2019une infrastructure d\u2019h\u00e9bergement \u00ab centralis\u00e9e \u00bb, o\u00f9 seront d\u00e9ploy\u00e9es les instances packag\u00e9es d\u00e9crites ci-dessous : cette solution est la voie privil\u00e9gi\u00e9e, avec \u00e0 la cl\u00e9 des \u00e9conomies d\u2019\u00e9chelles (en particulier les moyens humains utilis\u00e9s, mais \u00e9galement les mat\u00e9riels). Il s'agira ici d'un \u00ab produit standardis\u00e9 d\u2019h\u00e9bergement \u00bb pour lequel les paroisses \u00e9mettront leurs souhaits d'\u00e9volution.</p> </li> <li> <p>Les paroisses peuvent souhaiter disposer d\u2019un \u00ab package logiciel \u00bb et assurer les aspects infrastructures elles-m\u00eames : ceci permet aux paroisses qui d\u00e9sirent administrer leur solution sur une infrastructure existante de le faire elle-m\u00eame, tout en profitant toutefois d\u2019une solution logicielle commune. Dans ce cas de figure, la paroisse assume \u00e9galement les \u00e9l\u00e9ments de gestion et de mise \u00e0 jour de son infrastructure.</p> </li> <li> <p>Le code d\u00e9velopp\u00e9 \u00e9tant sous licence de logiciel libre, les paroisses peuvent \u00e9ventuellement r\u00e9utiliser le code et choisir d\u2019h\u00e9berger la solution elles-m\u00eame, voire m\u00eame de cr\u00e9er leur propre solution.  Notre exp\u00e9rience ayant montr\u00e9 que les ressources humaines ayant des comp\u00e9tences en informatique sont rares dans les paroisses, nous d\u00e9conseillons fortement cette solution, et n'assurerons aucun service apr\u00e8s-vente pour les paroisses retenant cette solution.</p> </li> </ul>"},{"location":"PRESENTATION/presentation_livrables.html#les-livrables-de-civiparoisse","title":"Les livrables de Civiparoisse","text":"<p>On retrouve donc, dans un degr\u00e9 d'int\u00e9gration croissant :</p>"},{"location":"PRESENTATION/presentation_livrables.html#composants-logiciels-specifiques","title":"Composants logiciels sp\u00e9cifiques","text":"<p>Ces composants sont pour l'heure au nombre de deux : </p> <ul> <li> <p>plugin d'installation de CiviCRM</p> </li> <li> <p>extension CiviCRM contenant le code de Civiparoisse.</p> </li> </ul>"},{"location":"PRESENTATION/presentation_livrables.html#images-docker","title":"Images Docker","text":"<p>Si l\u2019on regarde l\u2019\u00e9volution des pratiques d\u2019h\u00e9bergement informatique, on est pass\u00e9 progressivement des serveurs physiques d\u00e9di\u00e9s aux machines virtuelles, et depuis quelques ann\u00e9es, avec l\u2019av\u00e8nement de la tendance devops, on assiste plut\u00f4t \u00e0 un passage \u00e0 des architectures microservices containaris\u00e9s.</p> <p>Dans le cadre du package logiciel pour la production, il est judicieux de passer par des containers et l\u2019infrastructure microservices. En effet, ce type d\u2019architecture est con\u00e7ue pour faciliter les mises \u00e0 jour des infrastructures de mani\u00e8re rapide, en recr\u00e9ant les images des containers via des fichiers de build. De plus, on peut avoir une s\u00e9paration plus nette entre les chemins qui sont en lecture \u00e9crite et ceux en lecture seule, avec en particulier la notion de volumes. Cette notion de volume peut d\u2019ailleurs aussi \u00eatre exploit\u00e9e pour chercher \u00e0 concentrer les \u00e9l\u00e9ments de configuration des environnements dans des endroits sp\u00e9cifiques (config map kubernetes par exemple), et les donn\u00e9es sensibles (clefs par exemple) peuvent \u00eatre stock\u00e9s dans des volumes de secrets. Enfin, les logs peuvent \u00eatre disponibles via les entr\u00e9es sorties standard.</p> <p>En revanche, pour des d\u00e9monstrations, l\u2019installation dans une machine virtuelle est plus accessible et plus simple \u00e0 mettre en \u0153uvre.</p> <p>Les images tendent \u00e0 s'affiner progressivement ; pour l'heure, on retrouve les images suivantes :</p> <ul> <li> <p>composer_base : une image avec une version de composer dont les d\u00e9pendances sont compatibles avec le code de CiviCRM</p> </li> <li> <p>composer_files : image qui va mettre en oeuvre un fichier composer.json permettant de r\u00e9cup\u00e9rer l'ensemble des fichiers n\u00e9cessaires \u00e0 l'installation du syst\u00e8me</p> </li> <li> <p>tools : image qui ajoute des outils d'usage g\u00e9n\u00e9ral et qui va servir en tant qu'image \"tout terrain\" pour des images \u00e0 utilisation \"\u00e9ph\u00e9m\u00e8re\"</p> </li> <li> <p>init : image pour initialiser une instance (au niveau des fichiers et de la base de donn\u00e9es) de CiviCRM, avec une configuration initiale basique</p> </li> <li> <p>cron : image pour ex\u00e9cuter les t\u00e2ches p\u00e9riodiques</p> </li> <li> <p>selfkeys : image pour figer un ensemble de clefs autosign\u00e9es pour faciliter les d\u00e9ploiements de d\u00e9monstration</p> </li> <li> <p>httpd : le serveur web interne, qui est acc\u00e9d\u00e9 indirectement pour r\u00e9pondre aux utilisateurs</p> </li> <li> <p>proxy : reverse proxy qui va authentifier les requ\u00eates des utilisateurs et les transmettre au serveur web interne.</p> </li> </ul> <p>Des docker-compose compl\u00e8tent ces images pour monter rapidement un environnement pour faire une d\u00e9monstration ou des essais.</p>"},{"location":"PRESENTATION/presentation_livrables.html#integration-kubernetes","title":"Int\u00e9gration Kubernetes","text":"<ul> <li>un package Helm : le package permet de fournir un processus de d\u00e9ploiement dans des plateformes Kubernetes</li> </ul>"},{"location":"PRESENTATION/presentation_livrables.html#hebergement","title":"H\u00e9bergement","text":"<ul> <li>un h\u00e9bergement dans une infrastructure n\u00e9goci\u00e9e par l'Uepal (pour les paroisses ayant choisi l'h\u00e9bergement centralis\u00e9).</li> </ul> <p>L'ensemble des codes seront livr\u00e9s dans des d\u00e9p\u00f4ts Git \u00e0 acc\u00e8s public. Il est \u00e0 noter que ces d\u00e9p\u00f4ts \u00e0 acc\u00e8s public ne sont pas les d\u00e9p\u00f4ts utilis\u00e9s pour le d\u00e9veloppement, et ne contiendront que des \"versions num\u00e9rot\u00e9es\" des codes.</p>"},{"location":"PRESENTATION/presentation_livrables.html#prerequis-pour-lutilisation-des-livrables","title":"Pr\u00e9requis pour l'utilisation des livrables","text":"<p>Les pr\u00e9requis constituent des \u00e9l\u00e9ments que les paroisses qui souhaitent utiliser les images devront g\u00e9rer elles-m\u00eames. Nous n'avons pas l'ambitions de couvrir tous les sujets, ni les aborder sp\u00e9cifiquement ici, mais on peut citer en premi\u00e8re intention les points suivants :</p> <ul> <li> <p>les paroisses devront administrer Civicrm et Drupal, et savoir utiliser la solution : les paroisses devront avoir un responsable qui sera administrateur Civicrm et Drupal, pour effectuer les op\u00e9rations courantes d\u2019administration (cr\u00e9ation, d\u00e9sactivation de comptes, reset de mot de passe...)</p> </li> <li> <p>les paroisses devront savoir comment reconstruire une image : ceci est notamment n\u00e9cessaire pour palier au cas o\u00f9 un patch de s\u00e9curit\u00e9 devrait rapidement appliqu\u00e9</p> </li> <li> <p>les images, lorsqu\u2019utilis\u00e9es dans des containers, n\u00e9cessitent des volumes de donn\u00e9es pour les donn\u00e9es persistantes. Ces volumes seront g\u00e9r\u00e9s par l\u2019h\u00f4te. On aura besoin de plusieurs volumes, avec la particularit\u00e9 que les volumes de fichiers m\u00e9tiers seront partag\u00e9s entre containers (cron, web, et sauvegarde, notamment). Les volumes devront \u00eatre chiffr\u00e9s, et la sauvegarde devra \u00eatre chiffr\u00e9e et d\u00e9port\u00e9e vers un site distant en France (pour offrir les meilleures garanties quant \u00e0 la s\u00e9curisation des donn\u00e9es)</p> </li> <li> <p>l\u2019h\u00f4te : il faut le voir comme un environnement d\u2019ex\u00e9cution qui a \u00e9t\u00e9 fiabilis\u00e9, de haute disponibilit\u00e9, et le plus s\u00e9curis\u00e9 possible </p> </li> <li> <p>un nom de domaine est requis, car il est utile en particulier pour les enregistrements DNS sp\u00e9cifiques pour les techniques antispam (DKIM, SPF)</p> </li> <li> <p>de plus, il faudra g\u00e9rer un service de messagerie li\u00e9 au domaine, en particulier pour r\u00e9cup\u00e9rer et traiter les retours en erreur des envois de mails en masse. Les envois de mails en masse devront d\u2019ailleurs passer par un prestataire sp\u00e9cialis\u00e9, qui saura mieux g\u00e9rer des probl\u00e8mes de mails consid\u00e9r\u00e9s comme spams, et pourra \u00e9ventuellement avoir des serveurs reconnus comme des sources de trafic l\u00e9gitime</p> </li> <li> <p>il faudra non seulement placer l\u2019ensemble de l\u2019infrastructure derri\u00e8re un pare-feu, mais il faudra \u00e9galement pr\u00e9voir un acc\u00e8s \u00e0 CiviParoisse uniquement via un VPN, acc\u00e9d\u00e9 via une authentification forte</p> </li> <li> <p>des certificats vont \u00e9galement \u00eatre n\u00e9cessaires, en particulier pour le serveur web, ce qui pose le probl\u00e8me de la gestion des clefs et d\u2019une PKI. L\u2019ensemble des flux r\u00e9seaux devra \u00eatre chiffr\u00e9</p> </li> <li> <p>il faudra \u00e9galement mettre en place des outils de supervision / monitoring des containers, de m\u00eame que la r\u00e9cup\u00e9ration et l\u2019analyse des logs.</p> </li> </ul> <p>Vu la complexit\u00e9, les comp\u00e9tences, et la disponibilit\u00e9 des ressources, autant mat\u00e9rielles qu\u2019humaines, qui entrent en jeu, nous recommandons fortement de profiter des \u00e9conomies d'\u00e9chelle propos\u00e9es par l\u2019h\u00e9bergement (et intrins\u00e8quement l\u2019administration) centralis\u00e9s des instances.</p>"},{"location":"TECHNIQUE/index.html","title":"DOCUMENTATION TECHNIQUE","text":"<p>Cette partie vous permet d'acc\u00e9der \u00e0 toute la documentation technique du projet CiviParoisse. Vous y trouverez les \u00e9l\u00e9ments suivants :</p> <ul> <li>POC : Documentation du Proof Of Concept</li> <li>PREPOC : Documentation de pr\u00e9paration au Proof Of Concept</li> <li>ROLES : Documentation des r\u00f4les et permissions octroy\u00e9s aux utilisateurs</li> <li>MAIL: Documentation des mails</li> <li>LOGICIEL: Documentation de la stack logicielle</li> <li>INTEGRATION_CONTINUE: Documentation de l'int\u00e9gration continue</li> </ul>"},{"location":"TECHNIQUE/roles.html","title":"Int\u00e9gration des r\u00f4les des utilisateurs","text":"<p>Les r\u00f4les utilisateurs sont un sujet complexe. Un r\u00f4le regroupe un ensemble de permissions qui sont n\u00e9cessaires \u00e0 la r\u00e9alisation d'une t\u00e2che. On attribue ensuite \u00e0 un utilisateur le ou les r\u00f4les qui lui sont n\u00e9cessaires.</p> <p>Au niveau de CiviCRM, en sur-couche de Drupal, les permissions utilis\u00e9es sont int\u00e9gr\u00e9es dans Drupal, si bien que la gestion des r\u00f4les se ferait r\u00e9ellement au niveau de Drupal et pas au niveau de CiviCRM. Cette documentation ne parle pas encore du syst\u00e8me d'ACL propos\u00e9 par CiviCRM.</p> <p>Attention : L'exception de l'utilisateur Drupal UID 1</p> <p>Cet utilisateur est une exception dans Drupal, car il est pr\u00e9vu pour toujours se voir donner toutes les permissions.</p>"},{"location":"TECHNIQUE/roles.html#schemas-yaml-des-roles","title":"Sch\u00e9mas yaml des r\u00f4les","text":"<p>Les r\u00f4les sont stock\u00e9s comme des objets de configuration, et se retrouvent de ce fait dans la table <code>config</code> de Drupal, et commencent par <code>user.role</code>. Etant donn\u00e9 que ce sont des objets de configuration, ils sont d\u00e9crits par un sch\u00e9ma (<code>/app/web/core/modules/user/config/schema/user.schema.yml</code>) :</p> <pre><code>user.role.*:\n  type: config_entity\n  label: 'User role settings'\n  mapping:\n    id:\n      type: string\n      label: 'ID'\n    label:\n      type: label\n      label: 'Label'\n    weight:\n      type: integer\n      label: 'User role weight'\n    is_admin:\n      type: boolean\n      label: 'User is admin'\n    permissions:\n      type: sequence\n      label: 'Permissions'\n      sequence:\n        type: string\n        label: 'Permission'\n</code></pre> <p>Nous avons choisi de coder les r\u00f4les dans des fichiers yaml, en les cr\u00e9ant sur une instance de d\u00e9veloppement. Puis nous supprimons leur uuid, et nous les r\u00e9cup\u00e9rons pour les int\u00e9grer dans les autres instances, o\u00f9 le nom de fichier d\u00e9termine le nom de l'objet de configuration.</p>"},{"location":"TECHNIQUE/roles.html#gestion-technique","title":"Gestion technique","text":""},{"location":"TECHNIQUE/roles.html#export-dun-role","title":"Export d'un r\u00f4le","text":"<pre><code>drush config:get user.role.r1 &gt;user.role.r1.yml\ncat user.role.r1.yml\n</code></pre> <pre><code>uuid: b0d165ca-3a16-4996-9aa8-e57366a22a2c\nlangcode: fr\nstatus: true\ndependencies:\n  module:\n    - block\n    - civicrm\nid: r1\nlabel: R1\nweight: 4\nis_admin: null\npermissions:\n  - 'administer blocks'\n  - 'authenticate with password'\n</code></pre> <p>Pour supprimer au passage l'UUID :</p> <pre><code>cat user.role.r1.yml |grep -v uuid &gt;TEST/user.role.r1.yml\n</code></pre>"},{"location":"TECHNIQUE/roles.html#import-des-roles","title":"Import des r\u00f4les","text":"<p>Pour importer le fichier yaml, il faut faire attention de bien indiquer un import partiel (sans quoi les objets de configuration non existants sont supprim\u00e9s). La source est le r\u00e9pertoire dans lequel sont stock\u00e9s les fichiers \u00e0 importer.</p> <pre><code>drush --no-interaction config:import --partial --source=/app/TEST -vvv\n</code></pre>"},{"location":"TECHNIQUE/roles.html#verification-de-letat","title":"V\u00e9rification de l'\u00e9tat","text":"<p>Pour v\u00e9rifier la source de configuration pour les diff\u00e9rents objets :</p> <pre><code>drush config:status\n</code></pre>"},{"location":"TECHNIQUE/roles.html#implementation-dans-civiparoisse","title":"Impl\u00e9mentation dans CiviParoisse","text":"<p>Nous avons int\u00e9gr\u00e9 les r\u00f4les dans un package composer suppl\u00e9mentaire \u00e0 l'aide d'un d\u00e9p\u00f4t git, et nous utilisons les commandes drush lors de l'installation initiale et lors des mises \u00e0 jour. De ce fait, les packages de r\u00f4les seront versionn\u00e9s et la correspondance de versions sera ma\u00eetris\u00e9e via le composer.json principal. De plus, ces fichiers seront pr\u00e9sents directement dans les images Docker, qui elles-m\u00eames peuvent \u00eatre tagg\u00e9es, et donc versionn\u00e9es.</p>"},{"location":"TECHNIQUE/roles.html#strategie-a-long-terme","title":"Strat\u00e9gie \u00e0 long terme","text":"<p>Toutefois, il faut veiller \u00e0 une certaine \"compatibilit\u00e9 ascendante\", de sorte \u00e0 ne pas casser les droits et surtout les droits non donn\u00e9s aux utilisateurs. Cette compatibilit\u00e9 pourra passer par des nouveaux ensembles de r\u00f4les, qui seront mis \u00e0 disposition des paroisses.</p> <p>Un cas particulier doit cependant \u00eatre pr\u00e9vu : le cas o\u00f9 les permissions \u00e9voluent dans CiviCRM ou Drupal. Dans ce cas pr\u00e9cis, on peut envisager de supprimer les droits des anciens r\u00f4les cr\u00e9es par Civiparoisse et pr\u00e9parer un nouveau jeu de r\u00f4les : l'utilisateur UID 1 pourra de toute mani\u00e8re intervenir pour mettre en place les nouveaux droits. C'est une approche s\u00fbre, dans la mesure o\u00f9 on ne donnera \u00e0 aucun moment par m\u00e9garde des droits trop importants \u00e0 des utilisateurs. Comme l'utilisateur UID 1 n'est pas un utilisateur de la paroisse (mais l'\u00e9quipe technique interne Civiparoisse), il faudra convenir, avec chaque paroisse, du User qui doit r\u00e9cup\u00e9rer les nouveaux droits de gestion, pour qu'il effectue l'affectation des nouveaux droits au sein de sa paroisse.</p>"},{"location":"TECHNIQUE/roles.html#liste-des-droits-dun-systeme-attention-aux-droits-actifs-et-inactifs","title":"Liste des droits d'un syst\u00e8me : attention aux droits actifs et inactifs","text":"<p>CiviCRM dispose dans l'API4 d'un <code>Permission.get</code>. Il faut faire attention, car CiviCRM va lister les droits qui sont actifs et non actifs, par rapport \u00e0 CiviCRM. Ceci est d\u00fb au fait que la liste des droits de CiviCRM vient d'impl\u00e9mentations du hook utilis\u00e9 dans <code>CRM_Utils_Hook::permissionList</code>, et en particulier : CRM_Core_Permission::findCiviPermission.</p> <p>En revanche, si on passe par l'API Drupal, on aura plut\u00f4t des commandes du genre</p> <pre><code>drush php:eval \"var_dump(array_keys(\\\\Drupal::service('user.permissions')-&gt;getPermissions()));\"\n</code></pre> <p>Et dans ce cas, Drupal r\u00e9cup\u00e8re les permissions pour CiviCRM via un callback (d\u00e9fini dans le module Drupal civicrm : civicrm.permissions.yml) depuis <code>Drupal\\civicrm\\CivicrmPermissions</code> et sa fonction <code>permissions</code> qui appele <code>CRM_Core_Permission::basicPermission(FALSE,TRUE)</code> et ne r\u00e9cup\u00e8re donc que les droits actifs.</p> <p>En toute rigueur, nous respecterons l'usage de la politique du moindre privil\u00e8ge : si un droit n'est pas actif, il convient de ne l'affecter \u00e0 aucun r\u00f4le.</p>"},{"location":"TECHNIQUE/ARCHIVES/index.html","title":"Archives","text":"<p>Cette section contient les liens vers de la documentation technique \"historique\". Elle demeure toutefois dans la documentation car elle peut aborder des \u00e9l\u00e9ments qui pourraient s'av\u00e9rer utile malgr\u00e9 tout.</p> <ul> <li>Historique: serveur m\u00e9dias</li> <li>Historique : Int\u00e9gration Auth Proxy</li> <li>Authentification</li> <li>Docker<ul> <li>Description g\u00e9n\u00e9rale</li> <li>Images</li> <li>Composer_base</li> <li>Composer_files</li> <li>tools</li> <li>init</li> <li>cron</li> <li>selfkeys</li> <li>httpd</li> <li>authenticator</li> <li>proxy</li> <li>db_tls_server</li> <li>db_tls_client</li> <li>update</li> </ul> </li> <li>DB_SSL</li> <li>Kubernetes<ul> <li>Maquettage</li> <li>Ressources utiles</li> <li>Chart Helm<ul> <li>Description g\u00e9n\u00e9rale</li> <li>DB et DB proxy</li> <li>Serveur web interne</li> <li>Proxy et authenticateur</li> <li>Cron</li> <li>Volumes (persistants)</li> <li>Secrets</li> <li>R\u00e9servations</li> </ul> </li> </ul> </li> <li>Historique : Diff\u00e9rentiels du prepoc</li> <li>Diff IMG Docker</li> <li>Diff Chart Helm</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/serveur_media.html","title":"Serveur de m\u00e9dias","text":"<p>Archiv\u00e9 le 1er mai 2023</p>"},{"location":"TECHNIQUE/ARCHIVES/serveur_media.html#besoin","title":"Besoin","text":"<p>Le serveur de m\u00e9dias est une fonctionnalit\u00e9 n\u00e9cessaire, compl\u00e9mentaire \u00e0 l'envoi de mails par CiviCRM. En effet, pour que les mails ne soient pas de taille trop importante, on d\u00e9pose souvent les fichiers souvent utilis\u00e9s ou plus lourds (images par exemple) dans un serveur de m\u00e9dias, o\u00f9 le m\u00e9dia sera r\u00e9cup\u00e9r\u00e9 \u00e0 la vol\u00e9e lors des consultations des mails. Bien entendu, les fichiers confidentiels ne doivent pas \u00eatre envoy\u00e9s par mail sans pr\u00e9caution (chiffrement par exemple), et on \u00e9vitera \u00e9galement de les laisser \u00e0 disposition de tous sur un serveur non authentifi\u00e9.</p> <p>Un deuxi\u00e8me besoin compl\u00e9mentaire est la possibilit\u00e9 de d\u00e9poser une page web qui repr\u00e9sente un mail envoy\u00e9, et qui serait difficile \u00e0 lire du c\u00f4t\u00e9 de l'exp\u00e9diteur. Ce besoin doit toutefois \u00eatre \u00e9tudi\u00e9 au cas par cas, car  ce genre de mail est en contradiction avec les mails personnalis\u00e9s (mails sous forme de templates avec des champs de donn\u00e9es par exemple). Il semble par ailleurs que r\u00e9aliser une page web qui afficherait des donn\u00e9es personnalis\u00e9es par le biais d'un \u00e9l\u00e9ment comme un token d'authentification dans l'URL serait hasardeux, et poserait des questions quant \u00e0 la protection des donn\u00e9es (sauf \u00e0 disposer par exemple d'une clef publique de chiffrement pour envoyer du contenu \u00e0 un utilisateur).</p> <p>Il est \u00e0 noter que m\u00eame dans le cadre des mails personnalis\u00e9s, les mails ne sont la plupart du temps pas chiffr\u00e9s par des clefs asym\u00e9triques, comme par exemple via des technologies telles que S/MIME. De ce fait, bien que les transferts entre serveurs de mails peuvent \u00eatre chiffr\u00e9s, le contenu des mails pourrait toutefois \u00eatre d\u00e9couvert lors du transit sur un serveur (et les mails sont g\u00e9n\u00e9ralement analys\u00e9s avec des outils comme des antispams ou des antivirus). Il est donc essentiel de faire particuli\u00e8rement attention \u00e0 ce que les donn\u00e9es qui transitent dans les mails ne soient pas des donn\u00e9es sensibles.</p> <p>Pour en revenir au besoin, il est donc n\u00e9cessaire de s'authentifier aupr\u00e8s du syst\u00e8me pour pouvoir d\u00e9poser des fichiers, mais il n'est pas n\u00e9cessaire ensuite de s'authentifier pour les r\u00e9cup\u00e9rer.</p>"},{"location":"TECHNIQUE/ARCHIVES/serveur_media.html#eventuel-besoin-complementaire-serveur-dechanges-de-fichiers-analyse-de-possibles-solutions","title":"Eventuel besoin compl\u00e9mentaire : serveur d'\u00e9changes de fichiers ; analyse de possibles solutions","text":"<p>Certaines paroisses peuvent avoir besoin d'une solution simple de stockage de fichiers pour certains projets, avec des acc\u00e8s r\u00e9serv\u00e9s \u00e0 certaines personnes. Ce besoin n\u00e9cessite donc des outils suppl\u00e9mentaires : </p> <ul> <li>une authentification de l'ensemble des utilisateurs</li> <li>un m\u00e9canisme de contr\u00f4les des droits sur les fichiers</li> </ul> <p>Pour autant, il reste n\u00e9cessaire que certains documents soient acc\u00e9d\u00e9s sans authentification et via le protocole HTTP</p> <p>Plusieurs types d'outils semblent fournir des solutions :</p> <ul> <li> <p>le stockage sur des services clouds : Google Drive est un exemple qui permet le stockage de documents, et la gestion des droits sur les documents ; n\u00e9anmoins, certains utilisateurs peuvent se montrer r\u00e9ticents \u00e0 utilisateur des services directement issus des GAFAS. On pourrait \u00e9galement penser \u00e0 Azure Blob Storage.</p> </li> <li> <p>les logiciels de type Enterprise Content Management / Document Management System : elles fournissent des solutions qui d\u00e9passent fonctionnellement le besoin, et semblent pour la plupart \u00eatre assez lourdes et impliqueraient des ressources assez importantes aussi bien humaines que machines pour \u00eatre exploit\u00e9es correctement. Par ailleurs, certains logiciels disposent d'une version communaut\u00e9 et d'une version payante, et que des \u00e9carts importants dans les num\u00e9ros de version existent. Enfin, on trouve quelques projets de logiciel libre DMS plus l\u00e9gers, mais dont le code source n'est parfois plus maintenu ou ne semble plus \u00eatre en phase avec les pratiques actuelles</p> </li> <li> <p>les solutions construites sur des briques importantes syst\u00e8me/infrastructure : dans ce genre de solution, les paroisses devraient disposer de comp\u00e9tences techniques (ex : annuaire LDAP, gestion des utilisateurs et groupes Unix, SSH...) qui semblent difficilement \u00e0 leur port\u00e9e</p> </li> </ul> <p>Les recherches n'ont pas permis de d\u00e9terminer une solution satisfaisante \u00e0 int\u00e9grer dans le projet pour le besoin. Etant donn\u00e9 que ce besoin n'est pas imm\u00e9diatement en lien avec CiviCRM, et que les solutions Drive semblent \u00eatre les plus simples \u00e0 mettre en oeuvre, ce besoin compl\u00e9mentaire ne sera pas adress\u00e9 par le projet.</p>"},{"location":"TECHNIQUE/ARCHIVES/serveur_media.html#solution-proposee-hors-scope-projet","title":"Solution propos\u00e9e (hors scope projet)","text":"<p>La solution que l'on retient pour le moment pour le serveur de m\u00e9dias est une instance de Drupal avec une base de donn\u00e9es sqlite, dans le but de faire un serveur aussi l\u00e9ger que possible.</p> <p>Le projet comporte des versions modifi\u00e9es des images utilis\u00e9es pour CiviCRM : </p> <ul> <li>composer_media_base : la version de composer livr\u00e9e avec Ubuntu ne supporte pas le <code>auth-plugin : true</code> ; du coup il fallait r\u00e9cup\u00e9rer une version qui le supporte</li> <li>media_files : la r\u00e9cup\u00e9ration des fichiers n\u00e9cessaires</li> <li>media_tools : l'image avec les fichiers et les outils</li> <li>media_init : l'image pour l'installation des volumes</li> <li>media_httpd : l'image pour le serveur web</li> <li>media_cron : l'image pour le cron</li> </ul> <p>L'image selfkeys a \u00e9t\u00e9 modifi\u00e9e pour int\u00e9grer la signature d'un certificat pour ce serveur.</p> <p>Etant donn\u00e9 que ces images sont d\u00e9riv\u00e9es des images principales, on se reportera \u00e0 la documentation de ces derni\u00e8res pour comprendre le fonctionnement des images d\u00e9riv\u00e9es.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/index.html","title":"Index","text":"<p>Archiv\u00e9 le 1er mai 2023</p> <p>Cette section liste des documents concernant l'int\u00e9gration de Civiparoisse.</p> <ul> <li>Etude technique de l'authentification</li> <li>Docker</li> <li>Images docker</li> <li>Kubernetes</li> <li>DB_SSL</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/db_ssl.html","title":"Connexion chiffr\u00e9e \u00e0 la BD MySQL","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>La connexion chiffr\u00e9e \u00e0 la BD est un \u00e9l\u00e9ment qui ne doit pas \u00eatre n\u00e9glig\u00e9 : l'acc\u00e8s \u00e0 la BD doit \u00eatre limit\u00e9 et ne doit pas \u00eatre permis \u00e0 d'autres intervenants que le cron et serveur web interne, et le trafic doit \u00eatre chiffr\u00e9 pour assurer la confidentialit\u00e9 des informations.</p> <p>De m\u00eame, les donn\u00e9es doivent \u00eatre stock\u00e9es dans la BD de mani\u00e8re chiffr\u00e9e. Ce chiffrement n'est pas forc\u00e9ment effectu\u00e9 par le SGBD, car il peut \u00e9ventuellement \u00eatre effectu\u00e9 par le syst\u00e8me de fichiers. On retiendra, par simplicit\u00e9, ce sc\u00e9nario.</p> <p>En ce qui concerne la connexion \u00e0 la BD, un point important est qu'il convient de distinguer deux types d'acc\u00e8s :</p> <ul> <li>l'acc\u00e8s r\u00e9seau, par une stack TCP/IP : cet acc\u00e8s doit \u00eatre s\u00e9curis\u00e9 par SSL</li> <li>l'acc\u00e8s par socket : cet acc\u00e8s est g\u00e9r\u00e9 par les droits d'acc\u00e8s du fichier de socket, et la communication proprement dite se passe au niveau du kernel : la surcouche SSL ne s'applique pas.</li> </ul> <p>Pour mettre en oeuvre la connexion chiffr\u00e9e, plusieurs approches sont possibles :</p> <ul> <li> <p>l'acc\u00e8s chiffr\u00e9 jusqu'\u00e0 la BD en passant par les m\u00e9canismes de MySQL : il y a effectivement un support SSL int\u00e9gr\u00e9 dans MySQL, mais il faut bien remarquer que ce support n'est pas semblable \u00e0 une connexion SSL de HTTPS : la connexion est n\u00e9goci\u00e9e au niveau protocolaire : voir &lt;&gt;https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_connection_phase.html&gt;. Si CiviCRM semble pr\u00e9voir d\u00e8s l'installation la configuration SSL \u00e0 la BD, cela ne semble pas \u00eatre le cas de Drush/Drupal, et rend ce m\u00e9canisme difficile \u00e0 utiliser et n\u00e9cessite plusieurs configurations \u00e0 maintenir (CiviCRM et Drupal).</p> </li> <li> <p>l'acc\u00e8s par un proxy SQL : le proxy SQL proprement dit intervient au niveau protocolaire dans les communications. On peut citer deux proxys : </p> <ul> <li> <p>MySQLRouter : ce proxy est disponible sous Ubuntu, et fait partie du code du server MySQL. Il est simple \u00e0 configurer, et permet normalement de faire la distinction entre la connection client-proxy et la connection proxy-serveur, de sorte que le TLS puisse \u00eatre n\u00e9goci\u00e9 de mani\u00e8re distincte. Toutefois, un bug introduit dans la version 8.0.24 fait que m\u00eame si l'on ne souhaite au niveau du client qu'ouvrir uniquement une socket Unix (et pas un acc\u00e8s r\u00e9seau), un acc\u00e8s r\u00e9seau est quand m\u00eame ouvert sur un port al\u00e9atoire. De ce fait, ce logiciel n'a pas \u00e9t\u00e9 retenu.</p> </li> <li> <p>ProxySQL https://proxysql.com/ : ce proxy est un logiciel tiers Opensource. Son fonctionnement n\u00e9cessite de stocker les identifiants de connexion dans sa configuration. Ceci n'est pas souhait\u00e9, et le logiciel a donc \u00e9t\u00e9 \u00e9cart\u00e9 pour cette raison.</p> </li> </ul> </li> <li> <p>l'acc\u00e8s par un tunnel SSL : le tunnel SSL est en fait une encapsulation des donn\u00e9es protocolaires dans un flux TCP SSL ; le plus simple pour obtenir ce fonctionnement est d'utiliser socat, tout aussi bien en tant que client qu'en serveur, avec les configurations ad\u00e9quates: la partie serveur va \u00e9couter en SSL sur une socket inet et va brancher le flux apr\u00e8s authentification SSL sur la socket de MySQL, tandis que la partie client va fournir une socket unix et faire transiter gr\u00e2ce \u00e0 une authentification par certificat SSL d\u00fbment configur\u00e9 le trafic vers le serveur. L'int\u00e9r\u00eat de ce syst\u00e8me est qu'il est simple \u00e0 mettre en oeuvre, et qu'il est transparent au niveau applicatif. L'inconv\u00e9nient est qu'il n\u00e9cessite d'utiliser le design pattern sidecar pour fournir les connexions, ce qui augmente quelque peu les ressources utilis\u00e9es. On remarquera toutefois que cette approche sidecar est dans les normes, puisqu'elle est par exemple propos\u00e9e pour certains acc\u00e8s \u00e0 Google Cloud SQL : voir https://cloud.google.com/sql/docs/mysql/sql-proxy</p> </li> </ul> <p>En d\u00e9finitive, l'approche de tunnel SSL via socat est celle retenue. Sa configuration est relativement facile, et est effectu\u00e9e dans les images docker <code>DB_TLS_CLIENT</code> et <code>DB_TLS_SERVER</code>.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/db_ssl.html#annexe-probleme-mysqlrouter","title":"Annexe : probl\u00e8me MySQLRouter","text":"<p>Le probl\u00e8me se situe peut-\u00eatre sur le fichier mysql_routing.cc : https://github.com/mysql/mysql-server/blob/fbdaa4def30d269bc4de5b85de61de34b11c0afc/router/src/routing/src/mysql_routing.cc#L185</p> <pre><code>  if (context_.get_bind_address().port() &gt; 0 ||\n      context_.get_bind_named_socket().is_set()) {\n    auto res = start_acceptor(env);\n    if (!res) {\n      clear_running(env);\n      throw std::runtime_error(\n          string_format(\"Failed setting up TCP service using %s: %s\",\n                        context_.get_bind_address().str().c_str(),\n                        res.error().message().c_str()));\n    }\n</code></pre> <p>Il est possible que le probl\u00e8me soit apparu dans la 8.0.24 dont un des sympt\u00f4mes (mais qui n'explique pas le probl\u00e8me) est le code d'au-dessus. Un test de compilation (bricol\u00e9e pour outrepasser un probl\u00e8me de FIPS) et d'ex\u00e9cution n'a pas montr\u00e9 le probl\u00e8me avec la 8.0.23 en v\u00e9rifiant /proc/pid/net/tcp et tcp6.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html","title":"Docker","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Docker permet de mettre en oeuvre une architecture microservices, avec des images sp\u00e9cialis\u00e9es, adapt\u00e9es aux environnements gr\u00e2ce par exemple \u00e0 des variables d'environnement que l'on peut passer en argument de docker-run (par exemple).</p> <p>Le but des images est d'\u00eatre des images les plus stables possibles - id\u00e9alement des images que l'on pourrait utiliser en lecture seule. Les parties variables seraient id\u00e9alement toutes dans des volumes.</p> <p>Chaque Dockerfile du projet dispose d'une directive <code>LABEL</code> directement apr\u00e8s la directive <code>FROM</code> initiale, de sorte \u00e0 pouvoir invalider simplement le cache en modifiant les valeurs des labels.</p> <p>Un script de build des images ( <code>build.sh</code>) est fourni dans le d\u00e9p\u00f4t.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#liste-des-images","title":"Liste des images","text":"<p>Un certain nombre d'images Docker est n\u00e9cessaire pour ex\u00e9cuter un environnement Civiparoisse complet.</p> <p>Ces images, dans l'ordre de build, sont :</p> <ul> <li>composer_base</li> <li>composer_files</li> <li>tools</li> <li>init</li> <li>cron</li> <li>selfkeys</li> <li>httpd</li> <li>authenticator</li> <li>proxy</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#dependances-des-images-entre-elles","title":"D\u00e9pendances des images entre elles","text":"<p>En se basant sur la directive FROM des Dockerfiles, on obtient les d\u00e9pendances suivantes :</p> <ul> <li>ubuntu</li> <li>authenticator</li> <li>selfkeys</li> <li>composer_base<ul> <li>composer_files</li> <li>tools<ul> <li>cron</li> <li>init</li> </ul> </li> </ul> </li> <li>ubuntu/apache2</li> <li>httpd</li> <li>proxy</li> <li>ubuntu/mysql             </li> </ul> <p>Toutefois, il y a \u00e9galement des injections de donn\u00e9es d'une image \u00e0 l'autre  via <code>COPY --from</code> : * selfkeys     * authenticator     * httpd     * proxy * composer_files     * httpd     * tools         * indirectement (cf from ): cron         * indirectement (cf from ): init    </p> <p>Le but de ces d\u00e9pendances est de \"stabiliser\" le contenu des images build\u00e9es, pour que le contenu qui doit \u00eatre pr\u00e9sent dans plusieurs images soit identique.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#principe-de-fonctionnement","title":"Principe de fonctionnement","text":"<p>On suppose l'existence d'un forwarder TCP pricipal qui va faire l'aiguillage vers le bon reverse-proxy  de paroisse en se basant sur le Server Name Indication, qui appara\u00eet en clair dans la connexion TLS. Il y a donc une connexion TLS entre le client et le serveur TLS, mais deux liaisons TCP (client/forwarder et forwarder/reverse proxy).</p> <p>Le reverse proxy va authentifier les utilisateurs, au travers des identifiants Drupal convoy\u00e9s via du HTTP Basic au-dessus d'une liason TLS, et probablement un autre moyen (certificat SSL par exemple). En ce qui concerne les identifiants, ils sont test\u00e9 au travers d'un authenticateur qui est branch\u00e9 sur le reverse proxy au travers d'une socket Unix. Chaque requ\u00eate adress\u00e9e au reverse proxy doit \u00eatre authentifi\u00e9e, et d\u00e9clenchera un appel \u00e0 l'authenticateur.</p> <p>L'authenticateur va effectuer une requ\u00eate vers le serveur web interne pour v\u00e9rifier que l'utilisateur est bien reconnu. Si tel est le cas, le reverse proxy va transf\u00e9rer la requ\u00eate vers le serveur web interne pour \u00eatre trait\u00e9e.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#gestion-des-droits-sur-les-fichiers","title":"Gestion des droits sur les fichiers","text":"<p>La gestion des droits sur les fichiers est un sujet complexe. On suppose que les syst\u00e8mes de fichiers mis en oeuvre dans le syst\u00e8me proposent une gestion des droits traditionnels \"\u00e0 la Unix\", avec des droits read-write-exec que l'on peut attribuer \u00e0 un propri\u00e9taire, un groupe, et le reste du monde ; et on suppose qu'on peut identifier le propri\u00e9taire et le groupe de r\u00e9f\u00e9rence des fichiers.</p> <p>Etant donn\u00e9 qu'en principe seul le propri\u00e9taire et root peuvent changer les permissions sur un fichier, et qu'il est pr\u00e9f\u00e9rable que le compte root ne soit pas trop utilis\u00e9 (par exemple pour \u00e9viter par la suite une ex\u00e9cution en root via du bit SUID), il a \u00e9t\u00e9 privil\u00e9gi\u00e9 de cr\u00e9er un compte sp\u00e9cifique, verrouill\u00e9, dont le but est d'\u00eatre propri\u00e9taire des fichiers : le compte paroisse (UID 1000). Un groupe paroisse (GID 1000) est \u00e9galement provisionn\u00e9.</p> <p>Le principe g\u00e9n\u00e9ral est que les fichiers (pour l'instant, non syst\u00e8me) qui sont pr\u00e9sents dans les images sont des fichiers destin\u00e9s \u00e0 \u00eatre en lecture seule, tandis que les fichiers des volumes seront en lecture \u00e9criture. Il s'agit d'appliquer le principe des droits minimaux pour effectuer les op\u00e9rations.</p> <p>L'id\u00e9e est de donner aux fichiers le propri\u00e9taire paroisse, et le groupe www-data. De l\u00e0, on peut positionner les droits sur les fichiers.</p> <p>De m\u00eame, il y a un compte authenticator (UID 1001) et un groupe authenticator (GID 1001) qui ont \u00e9t\u00e9 cr\u00e9es sur l'image d'authenticateur. Compte \u00e9galement verrouill\u00e9.</p> <p>En ce qui concerne les clefs, il faut se rappeler qu'Apache lit les clefs en tant que l'utilisateur lanc\u00e9 (root) avant de descendre ses droits. Du coup, les clefs n'ont pas besoin d'\u00eatre lues par www-data.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#volumes-principaux","title":"Volumes principaux","text":"<p>Ces volumes sont :</p> <ul> <li>civicomp_dbvol: le volume de base de donn\u00e9es</li> <li>civicomp_filevol: le volume des fichiers, avec les fichiers sp\u00e9cifiques \u00e0 l'instance courante</li> <li>civicomp_privatevol : le volume des fichiers priv\u00e9s</li> </ul> <p>Les volumes sont mont\u00e9s avec l'option <code>nocopy: true</code> car ce fonctionnement correspond au fonctionnement en environnement Kubernetes. En environnement Kubernetes, il y aura des montages suppl\u00e9mentaires (les secrets et les variables d'environnement, par exemple).</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#docker-compose","title":"Docker-compose","text":"<p>Deux docker-compose sont disponibles. L'un d'eux, <code>docker-init.yml</code> est pr\u00e9vu pour initialiser les volumes, tandis que l'autre (<code>docker-compose.yml</code>, nom par d\u00e9faut) est utilis\u00e9 pour l'ex\u00e9cution classique.</p> <p>L'int\u00e9r\u00eat du docuker-compose r\u00e9side dans le fait que docker-compose va s'occuper de faire les liaisons n\u00e9cessaires entre les containers et les volumes, sans avoir besoin de saisir des lignes de commande fastidieuses. C'est donc un syst\u00e8me analogue \u00e0 ce qu'on retrouve dans la d\u00e9claration d'objets dans Kubernetes.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#initialisation-des-volumes","title":"Initialisation des volumes","text":"<p>On suppose qu'on se trouve dans le r\u00e9pertoire contenant les fichiers compose.</p> <pre><code>docker-compose -f docker-init.yml up\ndocker-compose -f docker-init.yml rm\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/docker.html#utilisation-de-lenvironnement-docker-au-quotidien","title":"Utilisation de l'environnement Docker au quotidien","text":"<p>Il faut penser \u00e0 mettre \u00e0 jour son <code>/etc/hosts</code> pour disposer de la r\u00e9solution de noms n\u00e9cessaire.  Ensuite, on peut faire des op\u00e9rations quotidiennes avec des commandes comme, par exemple (en \u00e9tant dans le r\u00e9pertoire contenant les fichiers compose) :</p> <pre><code>docker-compose -d up\n# [on fait le travail]\ndocker-compose stop\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html","title":"Etude : Authentification Apache / CiviCRM","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>L\u2019authentification de CiviCRM peut correspondre \u00e0 deux notions, qui ne se recoupent pas forc\u00e9ment :</p> <ul> <li>l\u2019utilisateur qui est logu\u00e9 dans le CMS : on se base alors sur les m\u00e9canismes du CMS, qui peuvent \u00eatre diff\u00e9rents en fonction des CMS</li> <li>le contact enregistr\u00e9 dans le CRM : ce protocole permet \u00e9galement de reconna\u00eetre comme utilisateur CiviCRM un contact. Par ailleurs, Authx dispose \u00e9galement d\u2019une page qui expose l\u2019identification de l\u2019utilisateur courant (/civicrm/authx/id), page qui a \u00e9galement l\u2019avantage d\u2019\u00eatre l\u00e9g\u00e8re \u00e0 charger.</li> </ul> <p>Dans le cadre du projet CiviParoisse, il n\u2019est pas souhaitable, pour des questions de s\u00e9curit\u00e9 et de confidentialit\u00e9 des donn\u00e9es, qu\u2019un contact sans compte dans le CMS puisse interagir avec le CRM. Il s\u2019agira donc de faire en sorte que seuls les utilisateurs logu\u00e9s dans le CMS puissent avoir un acc\u00e8s au syst\u00e8me.</p> <p>L\u2019acc\u00e8s au CMS devra d\u2019ailleurs \u00eatre compris de mani\u00e8re assez large : en effet, si on consid\u00e8re des documents qui sont stock\u00e9s sous formes de fichiers directement accessibles via Apache, le CMS ne sera pas charg\u00e9 pour l\u2019acc\u00e8s \u00e0 ces fichiers et donc le contr\u00f4le d\u2019acc\u00e8s que pourrait effectuer le CMS ne se fera pas. Or, les contr\u00f4les sont \u00e9galement requis sur ces fichiers. Il s\u2019agit donc d\u2019effectuer une authentification directement au niveau du serveur web.</p> <p>Pour autant, le processus doit rester simple pour les utilisateurs finaux : il s\u2019agit donc de ne pas leur demander de retenir trop de mots de passe : il faut donc que l\u2019authentification effectu\u00e9e au niveau de Apache puisse \u00eatre propag\u00e9e au CMS. Toutefois, \u00e9tant donn\u00e9 que les utilisateurs pourraient choisir des mots de passe simple (ou les \u00e9crire sur des morceaux de papier), il convient de proposer une authentification \u00e0 2 facteurs, par exemple en se basant non seulement sur une connaissance (le mot de passe), mais \u00e9galement une possession (un certificat SSL, voire un token de s\u00e9curit\u00e9).</p> <p>Le travail \u00e0 effectuer est donc assez complexe, et a n\u00e9cessit\u00e9 des recherches pouss\u00e9es. Ce travail peut se diviser en deux parties, l\u2019une concernant l\u2019authentification par mot de passe, et l\u2019autre concernant l\u2019authentification par certificat SSL et HSM ; en revanche, il faudra \u00e9galement veiller \u00e0 la correspondance des identit\u00e9s entre les deux m\u00e9thodes (ne pas autoriser le certificat d\u2019un utilisateur A et le mot de passe d\u2019un utilisateur B lors d\u2019un seul login).</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#authentification-par-mot-de-passe","title":"Authentification par mot de passe","text":""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#le-choix-du-cms-drupal","title":"Le choix du CMS : Drupal","text":"<p>L\u2019authentification par mot de passe est g\u00e9r\u00e9e par le CMS. CiviCRM propose un support de 4 CMS (Drupal, Backdrop, Wordpress et Joomla). Ces CMS proposent tous nativement une authentification par nom d\u2019utilisateur et mot de passe, avec un hash sal\u00e9 du mot de passe stock\u00e9 en base de donn\u00e9es. De la sorte, si la base de donn\u00e9es fuite, les mots de passe ne sont pas pour autant pr\u00e9sents, car les fonctions de hash cherchent \u00e0 \u00eatre des fonctions \u00e0 sens unique qui ne permettent pas de pr\u00e9dire des collisions de hashes (lorsque cela arrive, la fonction ne peut plus \u00eatre utilis\u00e9e comme fonction de s\u00e9curit\u00e9). Les fonctions de hashes utilis\u00e9es peuvent diff\u00e9rer, mais il semble que la plupart des CMS supportent les hashes calcul\u00e9s par le code du projet phpass (https://www.openwall.com/phpass/). On notera toutefois que la page du projet indique qu\u2019il faudrait pr\u00e9f\u00e9rer l\u2019utilisation des fonctions natives de PHP 5.5 et ult\u00e9rieur.</p> <p>M\u00eame si l\u2019on observe une certaine unicit\u00e9 de mani\u00e8re de faire chez les CMS support\u00e9s, la n\u00e9cessit\u00e9 de d\u00e9finir le CMS qui sera utilis\u00e9 arrive quand m\u00eame rapidement, puisqu\u2019il s\u2019agira d\u2019impl\u00e9menter un SSO entre le serveur web et le CMS. Les recherches effectu\u00e9es ont conduit \u00e0 privil\u00e9gier Drupal, pour plusieurs raisons :</p> <ul> <li> <p>les recherches sur les proc\u00e9dures d\u2019installation ont montr\u00e9 l\u2019int\u00e9r\u00eat, pour l\u2019automatisation de l\u2019installation et la mise \u00e0 jour des syst\u00e8mes, de disposer d\u2019un gestionnaire de versions. Or, CiviCRM utilise Composer, qui est \u00e9galement utilis\u00e9 par Drupal. A l\u2019inverse, Backdrop et Wordpress ne semblent pas int\u00e9grer officiellement la gestion des d\u00e9pendances via Composer. Au niveau de Joomla, le support de Composer est souhait\u00e9 et int\u00e9gr\u00e9 dans la feuille de route, mais n\u2019est pas encore atteint.</p> </li> <li> <p>Drupal utilise le framework Symfony, et ce framework dispose d\u2019un support d\u2019authentification HTTP Basic : le syst\u00e8me int\u00e8gre donc d\u00e9j\u00e0 des composants qui faciliteront le SSO entre le serveur web et le CMS</p> </li> <li> <p>le projet CiviParoisse est historiquement bas\u00e9 sur le CMS Drupal ; les b\u00e9n\u00e9voles qui travaillent sur les aspects techniques ont de ce fait cherch\u00e9 \u00e0 remonter en local des instances Drupal + CiviCRM, d\u2019o\u00f9 une \u00e9ventuelle r\u00e9utilisation ou mont\u00e9e en comp\u00e9tences sur ce CMS</p> </li> <li> <p>il semblerait que CiviCRM ait des affinit\u00e9s avec Drupal (comme par exemple les conventions de code qui ont \u00e9t\u00e9 r\u00e9utilis\u00e9es).</p> </li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#le-choix-du-serveur-web-apache","title":"Le choix du serveur web : Apache","text":"<p>Le choix du serveur web est \u00e9galement un choix important, car il en existe un grand nombre (Apache, Nginx, Jetty, Lighttpd pour ne citer qu\u2019eux). Apache est le serveur web qui est traditionnellement employ\u00e9 \u00ab par d\u00e9faut \u00bb dans les sites web PHP (stack LAMP ou WAMP, avec A pour Apache), et de ce fait est susceptible d\u2019\u00eatre mieux connu par les b\u00e9n\u00e9voles que les autres solutions. De ce fait, m\u00eame si d\u2019autres serveurs pourraient \u00e9ventuellement \u00eatre employ\u00e9s, la recherche s\u2019est concentr\u00e9e sur l\u2019interfa\u00e7age avec Apache. Toutefois, si le besoin se fait sentir, on pourra chercher \u00e0 se tourner vers d\u2019autres solutions (dont Nginx).</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#strategie-dinterfacage","title":"Strat\u00e9gie d\u2019interfa\u00e7age","text":"<p>La strat\u00e9gie d\u2019interfa\u00e7age va chercher \u00e0 utiliser au maximum les codes existants pour d\u00e9velopper (et maintenir) un minimum de m\u00e9canismes sp\u00e9cifiques. De ce fait, deux axes vont \u00eatre mis en \u0153uvre :</p> <ul> <li> <p>la consommation des identifiants pr\u00e9sent\u00e9s par Apache \u00e0 Drupal pour disposer d\u2019un m\u00e9canisme SSO.</p> </li> <li> <p>la mise \u00e0 disposition \u00e0 Apache d\u2019un m\u00e9canisme de validation des donn\u00e9es d\u2019authentification, m\u00e9canisme fourni par Drupal ou CiviCRM (authx)</p> </li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#consommation-des-identifiants-presentes-par-apache-a-drupal","title":"Consommation des identifiants pr\u00e9sent\u00e9s par Apache \u00e0 Drupal","text":"<p>La consommation des donn\u00e9es d\u2019authentification pr\u00e9sent\u00e9es par Apache \u00e0 du code PHP est assez standardis\u00e9e : traditionnellement, le serveur Apache peut fournir une variable d\u2019environnement <code>REMOTE_USER</code> pour indiquer l\u2019identifiant d\u2019un utilisateur, si l\u2019authentification a \u00e9t\u00e9 effectu\u00e9e au niveau d\u2019Apache. Lorsqu\u2019il s\u2019agit d\u2019une authentification de type HTTP Basic, les donn\u00e9es sont pr\u00e9sent\u00e9es \u00e9galement \u00e0 PHP via les variables <code>$_SERVER['PHP_AUTH_USER']</code> et <code>$_SERVER[\u2018PHP_AUTH_PW\u2019]</code>.</p> <p>Comme on le verra plus tard, Apache n\u2019est pas en mesure de v\u00e9rifier de fa\u00e7on autonome les donn\u00e9es d\u2019identification, et devra se reposer sur Drupal et PHP pour faire le travail via de l\u2019authentification de type HTTP Basic. Cette authentification de type HTTP Basic sera transmise avec chaque requ\u00eate de page.</p> <p>Le HTTP Basic est support\u00e9 via Symfony, mais n\u2019est pas consid\u00e9r\u00e9 comme une m\u00e9thode d\u2019authentification globale (utilisable tout le temps par d\u00e9faut, \u00e0 l\u2019inverse de l\u2019authentification par cookie). Il s\u2019agit donc au niveau de Drupal de cr\u00e9er un petit module qui permet d\u2019injecter le fournisseur HTTP Basic comme un fournisseur global via un fichier .services.yml : <pre><code>services:\nbasic_auth.authentication.basic_auth:\nclass: Drupal\\basic_auth\\Authentication\\Provider\\BasicAuth\narguments: [ '@config.factory', '@user.auth', '@flood', '@entity_type.manager' ]\ntags:\n- { name: authentication_provider, provider_id: 'basic_auth', priority: 100, global: TRUE }\n</code></pre> <p>C\u2019est le seul r\u00e9glage \u00e0 effectuer pour consommer les donn\u00e9es. Si les donn\u00e9es d\u2019authentification ne sont pas juste, une erreur de type 4XX est renvoy\u00e9e. En revanche, il reste \u00e0 la charge d\u2019Apache de toujours envoyer les donn\u00e9es d\u2019identification pour qu\u2019elles soient consomm\u00e9es (le header HTTP Authorization : Basic devra \u00eatre pr\u00e9sent dans toutes les requ\u00eates), sans quoi un code 200 pourrait \u00eatre renvoy\u00e9 \u00e0 tort.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#mise-a-disposition-des-donnees-dauthentification","title":"Mise \u00e0 disposition des donn\u00e9es d\u2019authentification","text":"<p>Apache s\u00e9pare conceptuellement le processus d\u2019authentification en deux, \u00e0 savoir les m\u00e9canismes permettant de r\u00e9cup\u00e9rer les donn\u00e9es d\u2019identification fournies par un navigateur web d\u2019une part, et la comparaison avec des fournisseurs d\u2019authentification d\u2019autre part.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#fournisseur-authnz-external","title":"Fournisseur Authnz External","text":"<p>En ce qui concerne le fournisseur d\u2019authentification, Apache propose plusieurs m\u00e9thodes. Malheureusement, aucune m\u00e9thode \u00ab native \u00bb ne convient, car la m\u00e9thode reposant sur l\u2019exploitation d\u2019une base de donn\u00e9es suppose la connaissance de la m\u00e9thode de hash pour que le hash puisse \u00eatre calcul\u00e9 sur les donn\u00e9es brutes.</p> <p>En ce qui concerne le support FastCGI, bien que celui-ci soit s\u00e9duisant sur le papier, le support FastCGI propos\u00e9 par php (php-cgi) et par fpm (php-fpm) n\u2019a pas permis d\u2019obtenir un fonctionnement tel qu\u2019un script d\u00e9fini sur la ligne de commande soit ex\u00e9cut\u00e9 et que le fastcgi ne soit utilis\u00e9 que pour fournir les donn\u00e9es d\u2019authentification. Il aurait donc fallu se tourner vers d\u2019autres impl\u00e9mentations FastCGI, ce qui aurait suppos\u00e9 des d\u00e9veloppements et donc la maintenance de ces d\u00e9veloppements.</p> <p>En revanche, il existe un fournisseur tiers qui est le module <code>authnz_external</code>. Ce module tiers est disponible directement dans les packages de Ubuntu LTS, et de ce fait son support est assur\u00e9 via la distribution. Ce module permet l\u2019ex\u00e9cution d\u2019un programme externe, auquel on peut fournir parplusieurs moyens les donn\u00e9es d\u2019identification. Le module utilisera le code de retour du programme pour d\u00e9terminer si l\u2019authentification a r\u00e9ussi (code de retour \u00e0 z\u00e9ro) ou \u00e9chou\u00e9 (code de retour diff\u00e9rent de z\u00e9ro).</p> <p>Comme on l\u2019a vu pr\u00e9c\u00e9demment dans le SSO d\u2019Apache vers Drupal, en envoyant une requ\u00eate HTTP vers Drupal avec de l\u2019authentification Basic fournira un code de retour qui indiquera si l\u2019authentification a r\u00e9ussi ou non. Il va donc s\u2019agir d\u2019utiliser un programme tiers pour r\u00e9cup\u00e9rer les identifiants, effectuer la requ\u00eate, et renvoyer le bon code de retour, en s\u2019assurant que l\u2019identifiant et le mot de passe soient toujours sett\u00e9s dans la requ\u00eate.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#script-shell-principal-wget-script-askpass","title":"Script shell principal, wget, script askpass","text":"<p>La commande wget est une commande d\u2019utilisation assez commune, qui permet d\u2019effectuer en particulier une requ\u00eate HTTP. Cette commande supporte le HTTPS (en authentification et en v\u00e9rification du certificat serveur), et propose via l\u2019option \u2013use-askpass l\u2019utilisation d\u2019un programme \u00ab askpass \u00bb tiers pour fournir les informations d\u2019identification via STDOUT (une ex\u00e9cution du programme tiers pour le nom d\u2019utilisateur, une autre pour le mot de passe). Charge au programme askpass de r\u00e9cup\u00e9rer le mot de passe, de v\u00e9rifier sa longueur, et de le retransmettre via STDOUT s\u2019il est non vide. Ce programme askpass devra soigner son code de retour : 0 si tout va bien ou une valeur diff\u00e9rente s\u2019il y a un probl\u00e8me. D\u2019apr\u00e8s mes tests, le code de retour de askpass est pris en compte par wget, et s\u2019il est diff\u00e9rent de 0, wget r\u00e9agira \u00e9galement dans son code de retour . Ce point est d\u2019ailleurs plus ou moins confirm\u00e9 par la lecture du code source et l\u2019exemple dans la page man de posix_spawnp (utilis\u00e9 pour lancer le programme) :</p> <p><pre><code>//Code source wget : main.c :\nargv[0] = opt.use_askpass;\nargv[1] = question;\nargv[2] = NULL;\nstatus = posix_spawnp (&amp;pid, opt.use_askpass, &amp;fa, NULL, argv, environ);\nif (status)\n{\nfprintf (stderr, \"Error spawning %s: %d\\n\", opt.use_askpass, status);\nexit (WGET_EXIT_GENERIC_ERROR);\n}\n</code></pre> Exemple dans la man page:</p> <pre><code>The program below demonstrates the use of various functions in the POSIX spawn API. The program accepts command-line attributes that can be used to create file actions and attributes objects. The remaining command-line arguments are used as the executable name and command-line arguments of the program that is executed in the child.\n\nIn the first run, the date(1) command is executed in the child, and the posix_spawn() call employs no file actions or attributes objects.\n\n$ ./a.out date\nPID of child: 7634\nTue Feb 1 19:47:50 CEST 2011\nChild status: exited, status=0\n\nIn the next run, the -c command-line option is used to create a file actions object that closes standard output in the child. Consequently, date(1) fails when trying to perform output and exits with a status of 1.\n\n$ ./a.out -c date\nPID of child: 7636\ndate: write error: Bad file descriptor\nChild status: exited, status=1\n</code></pre> <p>Par ailleurs, wget permet via l\u2019option \u2013auth-no-challenge d\u2019envoyer directement l\u2019authentification HTTP Basic sans requ\u00e9rir le challenge initial : ce point est tr\u00e8s important,dans la mesure o\u00f9 une page sans authentification pourrait renvoyer \u00e9galement du code 200, comme vu pr\u00e9c\u00e9demment dans l\u2019impl\u00e9mentation SSO.</p> <p>On se souviendra qu\u2019\u00e9tant donn\u00e9 qu\u2019Unix cr\u00e9e des processus par fork, les descripteurs de fichiers disponibles dans un processus p\u00e8re sont \u00e9galement dupliqu\u00e9s dans un processus fils au niveau du fork. En l\u2019occurence, mod_authnz_external permet de transmettre via la m\u00e9thode \u00ab pipe \u00bb les donn\u00e9es via STDIN, et le fork effectu\u00e9 par mod_authnz_external, puis le script shell principal, puis par le script wget font que le script askpass pourra lire chaque donn\u00e9e sur STDIN. Cette mani\u00e8re de faire a un gros avantage : les donn\u00e9es d\u2019identification ne seront pas pr\u00e9sentes dans l\u2019environnement des applications, et de ce fait ne peuvent pas \u00eatre r\u00e9cup\u00e9r\u00e9es aussi facilement que via de l\u2019ex\u00e9cution de commande ps ou des balades dans /proc.</p> <p>On en arrive donc aux \u00e9bauches suivantes :</p> <pre><code>#!/bin/bash\n# Script shell Askpass :\nread -s t\nif test -n \"$t\"\nthen\necho \"$t\"\nexit 0\nelse\nexit 1\nfi\n</code></pre> <pre><code>#!/bin/bash\n#Script shell Principal :\nwget -d --use-askpass=\"/home/ubuntu/DRUPAL_COMPOSER2/AUTH/askpass.sh\"\n--auth-no-challenge --\ncertificate=\"/etc/apache2/KEYS/server.x509\"\n--private-key=\"/etc/apache2/KEYS/server.key\"\n--ca-\ncertificate=\"/etc/apache2/KEYS/ca.x509\" https://drucomp2.test:444/civicrm/authx/id -O /dev/null\nexit $?\n</code></pre> <p>Bien entendu, ces scripts peuvent encore \u00eatre am\u00e9lior\u00e9s (par exemple v\u00e9rifier le code de retour des read), rendus plus g\u00e9n\u00e9riques pour l\u2019installation automatique, utiliser des clefs sp\u00e9cifiques\u2026</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#cible-pour-lauthentification-authx","title":"Cible pour l\u2019authentification : authx","text":"<p>A vrai dire, n\u2019importe quelle page authentifi\u00e9e pourrait faire l\u2019affaire en tant que cible (du moment qu\u2019elle ne modifie pas le syst\u00e8me). Pour autant, j\u2019ai vu deux cibles plus int\u00e9ressantes que les autres, en raison des informations qu\u2019elles peuvent fournir pour du d\u00e9bogage ; en effet, elles indiquent toutes les deux si l\u2019utilisateur est logu\u00e9 :</p> <ul> <li>civicrm/authx/id : int\u00e9gr\u00e9 dans CiviCRM</li> <li>user/login_status?_format=xml : int\u00e9gr\u00e9 dans Drupal.</li> </ul> <p>L\u2019int\u00e9r\u00eat de authx est qu\u2019il fournit des informations suppl\u00e9mentaires par rapport \u00e0 l\u2019\u00e9ventuel contact associ\u00e9 \u00e0 l\u2019utilisateur.</p> <p>En outre, il faut configurer authx, en fonction des indications donn\u00e9es dans le guide du d\u00e9veloppeur CiviCRM :</p> <pre><code>cv.phar ev 'Civi::settings()-&gt;set(\"authx_guards\",[\"perm\"]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_param_cred\",[]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_param_user\",\"require\");'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_header_cred\",[\"pass\"]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_header_user\",\"require\");'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_xheader_cred\",[]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_xheader_user\",\"require\");'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_login_cred\",[]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_login_user\",\"require\");'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_auto_cred\",[]);'\ncv.phar ev 'Civi::settings()-&gt;set(\"authx_auto_user\",\"require\");'\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#configuration-apache-mise-en-uvre-dun-reverse-proxy-et-authentification-a-deux-facteurs-ssl-et-basic","title":"Configuration Apache : mise en \u0153uvre d\u2019un reverse proxy et authentification \u00e0 deux facteurs (SSL et basic)","text":"<p>Les tests ont montr\u00e9 tr\u00e8s rapidement un probl\u00e8me \u00e0 r\u00e9soudre lorsqu\u2019on utilise qu\u2019un seul site : si Apache cherche \u00e0 s\u2019interroger lui-m\u00eame sur la validit\u00e9 d\u2019une page, on arrive \u00e0 une boucle r\u00e9cursive qui fait exploser le nombre de requ\u00eates wget, et la requ\u00eate ne peut donc pas aboutir.</p> <p>Le moyen le plus simple pour r\u00e9gler ce probl\u00e8me est de faire reposer l\u2019authentification SSO non pas directement sur le virtualhost de Drupal, mais plut\u00f4t sur un reverse proxy se pla\u00e7ant en amont : il suffit par exemple d\u2019ouvrir un autre port pour le virtualhost de Drupal, mais sur 127.0.0.1, de sorte \u00e0 ce que le virtualhost ne soit pas directement accessible depuis l\u2019ext\u00e9rieur (par exemple : 127.0.0.1:444/tcp). Le reverse proxy, lui, va \u00e9couter sur 0.0.0.0:443/tcp.</p> <p>Cette configuration, outre le fait de r\u00e9gler le probl\u00e8me de boucle, pourrait \u00e9galement se r\u00e9v\u00e9ler utile pour isoler le p\u00e9rim\u00e8tre d\u2019un probl\u00e8me : en effet, un administrateur pourra \u00e9ventuellement faire du port forwarding via SSH pour acc\u00e9der \u00e0 distance au port 444 si n\u00e9cessaire (\u00e0 condition qu\u2019il se connecte \u00e0 distance \u00e0 la machine). On peut \u00e9ventuellement chercher \u00e0 limiter cette possibilit\u00e9 en instaurant une authentification par certificat entre le reverse proxy et le virtualhost drupal. Par ailleurs, le fait d\u2019utiliser du SSL pour cette connexion interne permet \u00e9galement d\u2019\u00e9viter de laisser circuler en clair des mots de passe qui pourraient \u00eatre captur\u00e9s via tcpdump par exemple. Un autre type de solution technique qui aurait fait \u00e9galement l\u2019affaire aurait \u00e9t\u00e9 de l\u2019IPSEC en mode transport : n\u00e9anmoins, il semble plus maintenable d\u2019utiliser du SSL, tout simplement car des connaissances sur ce sujet sont plus ou moins d\u00e9j\u00e0 exig\u00e9es du fait de la n\u00e9cessit\u00e9 actuelle de la mise en \u0153uvre de HTTPS.</p> <p>On en arrive \u00e0 une \u00e9bauche de configuration telle que suit. Cette \u00e9bauche pourra \u00eatre am\u00e9lior\u00e9e en d\u00e9diant une autorit\u00e9 de certification d\u2019une part aux connexions des clients vers le reverse proxy et d\u2019autre part \u00e0 la connexion entre le reverse proxy et le vhost Drupal.</p> <pre><code>Listen 127.0.0.1:444\n&lt;VirtualHost 127.0.0.1:443&gt;\n#LogLevel debug\n#CustomLog \"/var/log/apache2/debug_jm.log\" \"REMOTE_USER: %{REMOTE_USER}x {SSL_CLIENT_S_DN_CN}x --- %v %h %l %u %t \\\"%r\\\" %&gt;s %b\"\nServerName drucomp2.test\nAddExternalAuth dea \"/home/ubuntu/DRUPAL_COMPOSER2/AUTH/externalauth.sh\"\nSetExternalAuthMethod dea pipe\nSSLEngine on\nSSLCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\nSSLCertificateFile \"/etc/apache2/KEYS/drucomp2.x509\"\nSSLCertificateKeyFile \"/etc/apache2/KEYS/drucomp2.pem\"\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLProxyVerify require\nSSLProxyMachineCertificateFile \"/etc/apache2/KEYS/proxy_client.pem\"\nSSLProxyCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\n&lt;Location /&gt;\n&lt;RequireAll&gt;\nRequire ssl\nRequire ssl-verify-client\nRequire valid-user\nRequire expr (%{REMOTE_USER} == %{SSL_CLIENT_S_DN_CN} ) &amp;&amp; (-n %{REMOTE_USER})\n&lt;/RequireAll&gt;\nAuthType Basic\nAuthName \"Apache Level\"\nAuthBasicProvider external\nAuthExternal dea\nAuthBasicAuthoritative on\nProxyPass \"https://drucomp2.test:444/\"\nProxyPassReverse \"https://drucomp2.test:444/\"\n&lt;/Location&gt;\nSSLProxyCheckPeerCN On\nSSLProxyCheckPeerName on\nSSLProxyVerify require\nSSLProxyEngine on\nSSLOptions +StrictRequire\nSSLVerifyClient require\n&lt;/VirtualHost&gt;\n&lt;VirtualHost 127.0.0.1:444&gt;\n#LogLevel debug\nDocumentRoot /home/ubuntu/DRUPAL_COMPOSER2\nServerName drucomp2.test\nphp_admin_value sendmail_path \"/usr/bin/env catchmail -f test@mailcatcher.test\"\nphp_admin_value CIVICRM_DB_CACHE_CLASS NoCache\n&lt;Directory /home/ubuntu/DRUPAL_COMPOSER2&gt;\nSSLRequireSSL\nRequire all granted\nAllowOverride All\n&lt;/Directory&gt;\nSSLEngine on\nSSLCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\nSSLCertificateFile \"/etc/apache2/KEYS/drucomp2.x509\"\nSSLCertificateKeyFile \"/etc/apache2/KEYS/drucomp2.pem\"\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLVerifyClient require\n&lt;/VirtualHost&gt;\n</code></pre> <p>Cette configuration pr\u00e9sente par ailleurs d\u00e9j\u00e0 une configuration pour forcer une authentification par certificat SSL, avec une v\u00e9rification particuli\u00e8re : la v\u00e9rification de la correspondance entre l\u2019utilisateur authentifi\u00e9 via mod_external ( dans <code>REMOTE_USER</code> ) et le common name du distinguished name du certificat SSL du client ( <code>SSL_CLIENT_S_DN_CN</code> ). A nouveau, on prend la pr\u00e9caution de v\u00e9rifier que l\u2019identifiant n\u2019est pas vide, m\u00eame si cela ne devrait pas arriver vu les pr\u00e9cautions prises dans le askpass.</p> <p>A l\u2019usage, avec les caches d\u00e9sactiv\u00e9s, on constate imm\u00e9diatement une grosse augmentation de charge syst\u00e8me lors de la mise en \u0153uvre : en effet, pour toute requ\u00eate entrante, il y a en r\u00e9alit\u00e9 trois requ\u00eates ex\u00e9cut\u00e9es (requ\u00eate entrante, requ\u00eate d\u2019autorisation, requ\u00eate de traitement). Il faut voir que cette configuration emp\u00eache \u00e9galement certaines mises en cache au niveau de Drupal, mises en caches qui sont interdites nativement en raison de l\u2019authentification basique.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#authentification-par-clef-privee-et-certificat-ssl-sur-hsm","title":"Authentification par clef priv\u00e9e (et certificat SSL) sur HSM","text":"<p>L\u2019authentification par clef priv\u00e9e et certificat SSL sur Hardware Security Module est un moyen pour fournir une authentification mat\u00e9rielle, dans la mesure o\u00f9, en g\u00e9n\u00e9ral, les modules de s\u00e9curit\u00e9 permettent de g\u00e9n\u00e9rer des clefs priv\u00e9es, mais ne permettent pas de les exporter (certains modules permettent toutefois une sauvegarde chiffr\u00e9e de la clef priv\u00e9e). Le module peut prendre plusieurs formes, dont usuellement la forme d\u2019un token USB, similaire \u00e0 une clef USB. Les fonctionnalit\u00e9s qui seront utilis\u00e9es sur ces clefs sont les fonctionnalit\u00e9s PIV (Personnal Identity Verification). G\u00e9n\u00e9ralement, les constructeurs de telles clefs fournissent des API pour acc\u00e9der au mat\u00e9riel, qui impl\u00e9mentent le support de PKCS11. C\u2019est justement sur la mise en \u0153uvre de PKCS11 dans le serveur web que va reposer en grande partie l\u2019authentification par clef, \u00e0 la place des fichiers de clefs.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#une-contrainte-lourde-la-gestion-dune-autorite-de-certification","title":"Une contrainte lourde : la gestion d\u2019une autorit\u00e9 de certification","text":"<p>Cette authentification par clef et certificat suppose une gestion des clefs rigoureuse, et implique une contrainte relativement forte : la mise en \u0153uvre d\u2019une infrastructure \u00e0 clefs publiques (Public Key Infrastructure). Cette infrastructure suppose au minimum la pr\u00e9sence d\u2019une autorit\u00e9 de certification (CA) qui est un tiers de confiance qui va attester de l\u2019identit\u00e9 li\u00e9e \u00e0 une clef publique. L\u2019autorit\u00e9 de certification doit \u00eatre g\u00e9r\u00e9e de mani\u00e8re rigoureuse pour que la confiance subsiste, et requiert donc la mise en \u0153uvre de processus organisationnels formalis\u00e9s, compris, et accept\u00e9s par toutes les parties.</p> <p>Le travail de l\u2019autorit\u00e9 de certification est non seulement la signature des certificats, mais \u00e9galement la r\u00e9vocation des clefs compromises (Certificate Revocation List, accessible soit sous forme de fichier, soit sous forme de service de r\u00e9pondeur OCSP Online Certificate Status Protocol) ). Ce travail de r\u00e9vocation n\u00e9cessite une disponibilit\u00e9 tr\u00e8s rapide de l\u2019autorit\u00e9, en plus de la coop\u00e9ration des utilisateurs.</p> <p>La mise en \u0153uvre d\u2019une autorit\u00e9 de certification internalis\u00e9e est donc un pr\u00e9requis lourd qu\u2019il ne faut pas sous-estimer. Il existe de la litt\u00e9rature sp\u00e9cialis\u00e9e \u00e0 ce sujet. Il y a \u00e9ventuellement une autre piste compl\u00e9mentaire : s\u2019adresser \u00e0 l\u2019ANSSI (ex : https://www.ssi.gouv.fr/uploads/2015/07/catalogue-cfssi-anssi_2020-2021.pdf ) ou aux services du minist\u00e8re de l\u2019int\u00e9rieur si une \u00ab externalisation \u00bb pourrait \u00eatre envisag\u00e9e.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#preparation-dun-hsm-deux-exemples","title":"Pr\u00e9paration d\u2019un HSM : deux exemples","text":"<p>Deux exemples peuvent \u00eatre explor\u00e9s : l\u2019utilisation d\u2019une clef usb Yubikey (ex:Yubikey 4), et l\u2019utilisation d\u2019une impl\u00e9mentation d\u2019\u00e9mulation logicielle : SoftHSM(v2). L\u2019int\u00e9r\u00eat de l\u2019\u00e9mulation est qu\u2019il peut servir \u00e0 mod\u00e9liser les services sur les machines de d\u00e9velopp ement sans disposer de mat\u00e9riel particulier.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#clef-yubikey","title":"Clef Yubikey","text":"<p>L\u2019exemple de la clef Yubikey n\u2019est pas un exemple \u00ab anodin \u00bb, dans la mesure o\u00f9 Yubico (https://www.yubico.com/?lang=fr) supporte l\u2019environnement Linux (les packages de gestion des Yubikeys sont disponibles en standard dans Ubuntu) et fournit une documentation sur son site web (https://developers.yubico.com/PIV/). Les prix des clefs sur le site de Yubico semblent accessibles (https://www.yubico.com/fr/store/ : \u00e0 partir de 45\u20acHT pour une clef). J\u2019ai une clef Yubikey 4 que j\u2019avais achet\u00e9e il y a plusieurs ann\u00e9es pour exp\u00e9rimenter. </p> <p>La premi\u00e8re chose \u00e0 faire serait d\u2019abord de personnaliser les codes d\u2019acc\u00e8s de la clef. Deux codes sont g\u00e9n\u00e9ralement utilisables : le PIN utilisateur et le PIN de l\u2019officier de s\u00e9curit\u00e9 (ou code PUK). Par ailleurs, dans le cadre de la clef Yubikey, personnaliser la clef de Management serait \u00e9galement judicieux (voir https://developers.yubico.com/PIV/Introduction/Admin_access.html ). Je n\u2019ai n\u00e9anmoins pas effectu\u00e9 ces t\u00e2ches.</p> <p>Les fonctionnalit\u00e9s PIV sont g\u00e9r\u00e9es par un outil sp\u00e9cifique : <code>yubico-piv-tool</code>, qui est un outil en ligne de commande. La premi\u00e8re chose est de g\u00e9n\u00e9rer un couple clef publique / clef priv\u00e9e pour l\u2019usage d\u2019authentification. Ces clefs \u00e9tant multi-usages, il convient tout d\u2019abord de d\u00e9terminer l'emplacement m\u00e9moire (slot) qui devra \u00eatre utilis\u00e9, en se r\u00e9f\u00e9rant \u00e0 la documentation (https://developers.yubico.com/PIV/Introduction/Certificate_slots.html) : ledit slot est le 9a. L\u2019outil yubico-piv-tool permettrait par ailleurs \u00e9galement de changer pin, puk et clef de management. Un autre outil permet de configurer les fonctionnalit\u00e9s disponibles : <code>ykman</code>, et permet explicitement de lister les p\u00e9riph\u00e9riques et les services activ\u00e9s.</p> <p><pre><code>yubico-piv-tool -a generate -s 9a -A RSA2048\n</code></pre> La commande affiche ensuite la clef publique g\u00e9n\u00e9r\u00e9e. On peut la retrouver via la g\u00e9n\u00e9ration d\u2019une requ\u00eate de certificat, qui est l\u2019\u00e9tape suivante :</p> <pre><code>yubico-piv-tool -a verify-pin -a request-certificate -s 9a -S'/CN=admin/OU=test/O=drucomp2.test' -o cert.req\n</code></pre> <p>On notera la syntaxe du sujet du certificat, qui utilise des slashes \u00e0 la place des virgules.</p> <p>On peut ensuite signer la requ\u00eate de certificat, comme par exemple avec :</p> <pre><code>openssl x509 -req -in YUBICO/cert.req -out YUBICO/cert.x509 -days 365 -CA ca.x509 -CAkey ca.key -CAserial ca.srl\n</code></pre> <p>Il n\u2019y a ensuite plus qu\u2019\u00e0 importer le certificat :</p> <p><pre><code>yubico-piv-tool -s9a -aimport-certificate -i cert.x509\n</code></pre> A ce moment, la clef est pr\u00eate pour attester d\u2019une identit\u00e9 \u2013 \u00e0 condition de faire confiance \u00e0 l\u2019autorit\u00e9 de certification qui a sign\u00e9 le certificat.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#softhsm2","title":"SoftHSM2","text":"<p>SoftHSM2 permet de fournir une \u00e9mulation de mat\u00e9riel de s\u00e9curit\u00e9, utile pour apprendre. N\u00e9anmoins, le fait que ce soit une \u00e9mulation logicielle a un impact important : les droits sur les fichiers s\u2019appliquent, ce qui n\u2019est pas le cas avec du mat\u00e9riel : ceci a pos\u00e9 probl\u00e8me pour l\u2019acc\u00e8s aux clefs via apache, lorsque www-data n\u2019avait pas les droits sur les fichiers, en lan\u00e7ant une erreur assez g\u00e9n\u00e9rique (object invalid handle). Le d\u00e9buggage de ce probl\u00e8me a n\u00e9cessit\u00e9 l\u2019installation des symboles de d\u00e9buggage d\u2019apache, la modification du nombre de workers (pour passer \u00e0 1), et la r\u00e9cup\u00e9ration des codes sources des librairies (via apt source) pour pouvoir attacher \u00e0 gdb le worker apache et faire du pas \u00e0 pas dans le code source pour arriver jusqu\u2019\u00e0 la source du probl\u00e8me.</p> <p>La mise en \u0153uvre de SoftHSM2 est assez ressemblante \u00e0 celle de la Yubikey. La premi\u00e8re des choses est d\u2019identifier les slots disponibles :</p> <pre><code>softhsm2-util--show-slots\n</code></pre> <p>De l\u00e0, il faut initialiser les pins de l\u2019utilisateur et du security officer :</p> <pre><code>softhsm2-util --init-token --slot 0 --so-pin 12345678 --pin 123456 --label serverhsm\n</code></pre> <p>G\u00e9n\u00e9rer la paire de clefs : on utilise pkcs11-tool (package opensc)</p> <pre><code>pkcs11-tool --module /usr/lib/arm-linux-gnueabihf/softhsm/libsofthsm2.so --login --keypairgen --key-type rsa:2048 --usage-sign --token-label serverhsm --label serverkey\n</code></pre> <p>De l\u00e0, il faut trouver l\u2019URI PKCS11 de la clef utilis\u00e9e : p11tool (package gnutls-bin) : on r\u00e9cup\u00e8re d\u2019abord la liste des tokens, avec leur URI, puis on liste celles du support qui nous int\u00e9resse</p> <pre><code>p11tool --list-tokens\np11tool --login --list-all pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm\n</code></pre> <p>G\u00e9n\u00e9rer la requ\u00eate de certificat :</p> <pre><code>openssl req -new -engine pkcs11 -keyform engine -key \"pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm;object=serverkey;type=private\" -subj \"/C=FR/ST=France/L=Strasbourg/O=TEST/OU=INFRA/CN=drucomp2.test\" -out serverhsm.req\n</code></pre> <p>Il ne reste plus que la signature du certificat :</p> <pre><code>openssl x509 -req -in serverhsm.req -out serverhsm.x509 -extfile ext -ext ext -CA ca.x509 -CAkey ca.key -CAserial ca.srl -sha256 -days 365\n</code></pre> <p>Et l\u2019import du certificat :</p> <pre><code>pkcs11-tool --module /usr/lib/arm-linux-gnueabihf/softhsm/libsofthsm2.so serverhsm --label servercert --write-object serverhsm.x509 --type cert --login --token-label\n</code></pre> <p>Comme indiqu\u00e9 pr\u00e9c\u00e9demment, il faudra faire attention \u00e0 ce que les fichiers soient accessibles par l\u2019utilisateur qui les utilisera.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#mise-en-uvre-du-hsm-pour-les-connexions-web","title":"Mise en \u0153uvre du HSM pour les connexions web","text":"<p>Le HSM va \u00eatre utilis\u00e9 \u00e0 deux endroits : au niveau du serveur web, et au niveau du navigateur web.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#prise-en-charge-par-apache","title":"Prise en charge par Apache","text":"<p>Apache dispose de deux supports pour la prise en charge de PKCS11 : le premier support est le module gnutls. Ce module est d\u00e9j\u00e0 ancien, et les tests effectu\u00e9s montrent que ce module ne met pas \u00e0 disposition les donn\u00e9es comme le DN du sujet du certificat au niveau des directives Require : de ce fait, ce module ne peut pas faire l\u2019affaire.</p> <p>Le deuxi\u00e8me module est le module ssl : ce module a vu un d\u00e9but de support de PKCS11 depuis la version 2.4.42. Ce support est donc r\u00e9cent, car la version d\u2019Apache fournie par Ubuntu 20.04 LTS est la version 2.4.41, ne permettant pas le support de la fonctionnalit\u00e9. De ce fait, il est n\u00e9cessaire de passer temporairement \u00e0 la version 21.04 d\u2019Ubuntu, qui embarque Apache 2.4.46 ; passer \u00e0 la version normale signifie \u00e9galement disposer d\u2019une dur\u00e9e de support r\u00e9duite \u00e0 9 mois, au lieu de 5 ans.</p> <p>Le support est minimaliste : il concerne le certificat et la clef du serveur : les directives de configuration peuvent accepter depuis 2.4.42 de la possibilit\u00e9 de saisir des URI PKCS11, URI que l\u2019on peut d\u00e9terminer via p11tool. Ce point est probl\u00e9matique pour le reverse proxy, qui, lui, ne supporte pas d\u2019URI PKCS11 au niveau de la directive <code>SSLProxyMachineCertificateFile</code>. On arrive \u00e0 comprendre ce non-support en raison de l\u2019approche de cette directive : stocker l\u2019ensemble des certificats dans un path ou dans un fichier pour permettre au proxy de s\u2019authentifier aupr\u00e8s des serveurs distants, ce qui est incompatible avec les URI PKCS11, qui, elles, sont plut\u00f4t utilis\u00e9es pour adresser des ressources sp\u00e9cifiques.</p> <p>Dans le cas pr\u00e9sent, un contournement est possible via iptables : en effet, on peut supposer que l\u2019instance qui h\u00e9bergera le reverse proxy et le site seront situ\u00e9s dans une m\u00eame instance d\u2019Apache, et donc auront \u00e0 disposition le m\u00eame kernel. De ce fait, on peut mettre \u00e0 profit une fonctionnalit\u00e9 de marquage des paquets r\u00e9seaux d\u2019iptables, associ\u00e9e \u00e0 une condition sur l\u2019origine des paquets : on marquera sur la cha\u00eene OUTPUT, sur le loopback, les paquets issus de www-data destin\u00e9s au site drupal proprement dit, et on n\u2019acceptera sur la cha\u00eene INPUT, \u00e0 l\u2019entr\u00e9e du loopback et \u00e0 destination du site drupal, que des paquets d\u00fbment marqu\u00e9s. Un exemple de configuration est tel que suit :</p> <pre><code>iptables -A OUTPUT -o lo -p tcp --dst 127.0.0.1 --src 127.0.0.1 --dport 444 -m owner --uid-owner www-data -j MARK --set-mark 33\niptables -A INPUT -i lo -p tcp --dst 127.0.0.1 --src 127.0.0.1 --dport 444 -m mark --mark 33 -j ACCEPT\niptables -A INPUT -p tcp --dport 444 -j DROP\n</code></pre> <p>Les paquets qui arrivent au serveur Drupal seront donc identifi\u00e9s indirectement, ce qui permet ne plus avoir besoin du certificat SSL pour l\u2019authentification au niveau de Drupal. En revanche, le chiffrement des donn\u00e9es reste toutefois requis.</p> <p>On en arrive donc \u00e0 une configuration d\u2019exemple comme la suivante :</p> <pre><code>Listen 127.0.0.1:444\n&lt;VirtualHost 127.0.0.1:443&gt;\nLogLevel debug\nCustomLog \"/var/log/apache2/debug_jm.log\" \"REMOTE_USER: %{REMOTE_USER}x SUBJECT_CN: % {SSL_CLIENT_S_DN_CN}x --- %v %h %l %u %t \\\"%r\\\" %&gt;s %b\"\nServerName drucomp2.test\nAddExternalAuth dea \"/home/ubuntu/DRUPAL_COMPOSER2/AUTH/externalauth.sh\"\nSetExternalAuthMethod dea pipe\nSSLEngine on\nSSLCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\nSSLCertificateFile \"pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm;object=servercert;type=cert\"\nSSLCertificateKeyFile \"pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm;object=serverkey;type=private\"\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLProxyVerify require\n#SSLProxyMachineCertificateFile \"/etc/apache2/KEYS/proxy_client.pem\"\nSSLProxyCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\n&lt;Location /&gt;\n&lt;RequireAll&gt;\nRequire ssl\nRequire ssl-verify-client\nRequire valid-user\nRequire expr (%{REMOTE_USER} == %{SSL_CLIENT_S_DN_CN} ) &amp;&amp; (-n %{REMOTE_USER})\n&lt;/RequireAll&gt;\nAuthType Basic\nAuthName \"Apache Level\"\nAuthBasicProvider external\nAuthExternal dea\nAuthBasicAuthoritative on\nProxyPass \"https://drucomp2.test:444/\"\nProxyPassReverse \"https://drucomp2.test:444/\"\n&lt;/Location&gt;\nSSLProxyCheckPeerCN On\nSSLProxyCheckPeerName on\nSSLProxyVerify require\nSSLProxyEngine on\nSSLOptions +StrictRequire\nSSLVerifyClient require\n&lt;/VirtualHost&gt;\n&lt;VirtualHost 127.0.0.1:444&gt;\nCustomLog \"/var/log/apache2/debug_jm_core.log\" \"REMOTE_USER: %{REMOTE_USER}x SUBJECT_CN:%{SSL_CLIENT_S_DN_CN}x --- %v %h %l %u %t \\\"%r\\\" %&gt;s %b\"\nLogLevel debug\nDocumentRoot /home/ubuntu/DRUPAL_COMPOSER2\nServerName drucomp2.test\nphp_admin_value sendmail_path \"/usr/bin/env catchmail -f test@mailcatcher.test\"\nphp_admin_value CIVICRM_DB_CACHE_CLASS NoCache\n&lt;Directory /home/ubuntu/DRUPAL_COMPOSER2&gt;\nSSLRequireSSL\nRequire all granted\nAllowOverride All\n&lt;/Directory&gt;\nSSLEngine on\nSSLCACertificateFile \"/etc/apache2/KEYS/ca.x509\"\nSSLCertificateFile \"pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm;object=servercert;type=cert\"\nSSLCertificateKeyFile \"pkcs11:model=SoftHSM%20v2;manufacturer=SoftHSM%20project;serial=75bb53774ddd60dc;token=serverhsm;object=serverkey;type=private\"\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\n#SSLVerifyClient require\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#prise-en-charge-hsm-au-niveau-du-navigateur","title":"Prise en charge HSM au niveau du navigateur","text":"<p>Firefox, dans ses pr\u00e9f\u00e9rences, dispose d\u2019un bouton pour appeler une interface de gestion des p\u00e9riph\u00e9riques de s\u00e9curit\u00e9. Il suffit ensuite de pr\u00e9ciser les modules d\u2019interfa\u00e7age PKCS11 \u00e0 charger (par exemple /usr/lib/arm-linux-gnueabihf/softhsm/libsofthsm2.so ou /usr/lib/arm-linux-gnueabihf/libykcs11.so ). Ensuite, les certificats sont rendus disponibles du moment que l\u2019utilisateur se connecte aux tokens.</p> <p>En ce qui concerne chromium, la situation est plus compliqu\u00e9e : en th\u00e9orie, chromium chercherait des informations dans une base NSS situ\u00e9e dans $HOME/.pki/nssdb. Cette base peut \u00eatre g\u00e9r\u00e9e par l\u2019utilitaire modutil (package libnss3-tools), pour demander \u00e0 chromium de charger les m\u00eames modules que ceux pr\u00e9sent\u00e9s \u00e0 firefox. N\u00e9anmoins, la version de chromium livr\u00e9e avec Ubuntu est une version dans le format \u00ab snap \u00bb ; et le package, tel que configur\u00e9, ne permet pas d\u2019acc\u00e9der au r\u00e9pertoire nssdb. Ce probl\u00e8me est r\u00e9pertori\u00e9 chez Ubuntu (https://bugs.launchpad.net/ubuntu/+source/chromium-browser/+bug/1899478 et https://bugs.launchpad.net/ubuntu/+source/chromium-browser/+bug/1859643 ). De plus, le montage de l\u2019interface home dans un snap devrait se limiter aux fichiers non cach\u00e9s (donc qui ne commence pas par un point ) ; du coup, cela rend le probl\u00e8me plus difficile \u00e0 r\u00e9soudre, car le chemin de la BD NSS semble \u00eatre en dur dans le code de chromium (https://github.com/chromium/chromium/blob/master/crypto/nss_util.cc ).</p> <p>En conclusion, on remarque que les b\u00e9n\u00e9fices de l\u2019identification par certificat peuvent \u00eatre appr\u00e9ciables, mais que ces b\u00e9n\u00e9fices ne peuvent \u00eatre acquis qu\u2019en mettant les ressources techniques, humaines, et mat\u00e9rielles en face. Enfin, on n\u2019oubliera pas que l\u2019authentification par certificat peut \u00e9galement \u00eatre mise en \u0153uvre dans certaines solutions VPN, ce qui signifie que cette technologie peut servir \u00e0 plusieurs niveaux. Des recherches compl\u00e9mentaires sur la gestion de CA et sur les VPN (au sens large) pourraient donc \u00eatre judicieuses.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/etude_authentification.html#addendum-mise-en-cache-de-lauthentification","title":"Addendum : mise en cache de l'authentification","text":"<p>L'int\u00e9gration de l'authentification issue de Drupal avec Apache est co\u00fbteuse : pour toute requ\u00eate envoy\u00e9e au reverse-proxy, deux requ\u00eates peuvent \u00eatre envoy\u00e9es au serveur web interne : </p> <ul> <li>la requ\u00eate pour v\u00e9rifier les identifiants</li> <li>si l'authentification est valide, la requ\u00eate de base pour effectuer le travail proprement dit.</li> </ul> <p>En pratique, le maquettage a montr\u00e9 que ce syst\u00e8me est particuli\u00e8rement impactant pour le bon fonctionnement du syst\u00e8me, car il ne faut pas oublier que toute ressource va \u00eatre soumise \u00e0 authentification - dont les images. Il arrive donc que plus de resources soient n\u00e9cessaires pour l'authentification que pour le travail demand\u00e9.</p> <p>Il ne faut par ailleurs pas oublier que dans le cadre d'un d\u00e9ploiement \u00e0 grande \u00e9chelle, cette consommation de ressources va impliquer plus de ressources n\u00e9cessaires au fonctionnement du syst\u00e8me, et donc des co\u00fbts plus importants.</p> <p>Il s'av\u00e8re que <code>mod_authnz_external</code> dispose d'un n\u00e9cessaire pour utiliser <code>mod_authn_socache</code> pour disposer d'un cache d'identifiants. Le cache utilis\u00e9 peut par exemple \u00eatre <code>mod_socache_shmcb</code>, qui va stocker les identifiants dans de la m\u00e9moire partag\u00e9e.</p> <p>V\u00e9rification faite dans le code de <code>authnz_external</code>, une fonction de la libapr est utilis\u00e9e pour g\u00e9n\u00e9rer l'entr\u00e9e en cache. Au niveau du cache, ce sera une empreinte SHA1 qui va \u00eatre stock\u00e9e. La libapr permettrait quatre types d'identifiants :</p> <ul> <li>en clair</li> <li>bcrypt</li> <li>md5</li> <li>sha1</li> </ul> <p>L'utilisation de SHA1 n'est plus consid\u00e9r\u00e9e comme s\u00fbre,ce qui am\u00e8ne \u00e0 d\u00e9conseiller l'utilisation du cache \u00e0 cause de ce stockage du mot de passe. Toutefois, si l'authentification r\u00e9alis\u00e9e est une authentification \u00e0 facteurs multiples (dont une authentification forte), on pourrait toutefois consid\u00e9rer que l'importante du mot de passe n'est plus aussi forte, et que le risque devient un peu plus acceptable - m\u00eame si une d\u00e9cision politique doit clairement \u00eatre prise \u00e0 ce sujet avant mise en production.</p> <p>En ce qui concerne la mise en cache de l'authentification, on peut consid\u00e9rer l'exemple suivant :</p> <pre><code>AuthnCacheEnable on\nAuthnCacheSOCache shmcb\n&lt;VirtualHost 0.0.0.0:443&gt;\nServerName ${SERVERNAME}\nAddExternalAuth dea \"/AUTH/externalauth.sh\"\nSetExternalAuthMethod dea pipe\nSSLEngine on\nSSLCertificateFile ${SERVER_CERT}\nSSLCertificateKeyFile ${SERVER_KEY}\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLProxyVerify require\nSSLProxyMachineCertificateFile ${PROXY_MACHINE_CERT}\nSSLProxyCACertificateFile ${PROXY_CA}\nSSLProxyCheckPeerCN on\nSSLProxyCheckPeerName on\nSSLProxyVerify require\nSSLProxyEngine on\nSSLOptions +StrictRequire\nSSLVerifyClient none\n&lt;Location \"/\"&gt;\nAuthExternalContext ${AUTH_CONTEXT}\n&lt;RequireAll&gt;\nRequire ssl\nRequire valid-user\n&lt;/RequireAll&gt;\nAuthType Basic\nAuthName \"Civiparoisse\"\nAuthBasicProvider socache external\nAuthnCacheProvideFor external\nAuthExternalProvideCache on\nAuthnCacheContext server\nAuthnCacheTimeout 300\nAuthExternal dea\nAuthBasicAuthoritative on\n&lt;/Location&gt;\nProxyPass \"/\" \"https://${INTERN_SERVERNAME}:444/\"\n&lt;/VirtualHost&gt;\n</code></pre> <p>On constate la directive <code>AuthExternalProvideCache</code> qui va demander \u00e0 <code>authnz_external</code> de remplir le cache, et on constate qu'on a un provider d'authentification suppl\u00e9mentaire : socache, avec un timeout de 300secondes. Le contexte va agir sur la clef. On a encore deux directives globales qui d\u00e9finissent le backend de cache utilis\u00e9, et l'activation du cache.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/index.html","title":"Images Docker","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <ul> <li>Authenticateur</li> <li>Composer : base</li> <li>Composer: fichiers</li> <li>Cron</li> <li>DB_TLS : Client</li> <li>DB_TLS : Serveur</li> <li>HTTPD</li> <li>INIT</li> <li>PROXY AUTH</li> <li>CLEFS : selfkeys</li> <li>TOOLS</li> <li>UPDATE</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/authenticator.html","title":"Authenticateur","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>L'authenticateur a pour vocation de v\u00e9rifier si les identifiants transmis par un utilisateur (au travers du reverse proxy) sont valides, en les testant vers une URL sp\u00e9cifique.</p> <p>L'authentification en elle-m\u00eame a \u00e9t\u00e9 trait\u00e9e dans une \u00e9tude sp\u00e9cifique.</p> <p>Un utilisateur et un groupe <code>authenticator</code> ont \u00e9t\u00e9 rajout\u00e9s de sorte \u00e0 faire tourner le script d'authentification via cet utilisateur. Le propri\u00e9taire des fichiers reste root, de sorte que ce soient les droits du groupe qui soient (normalement) utilis\u00e9s pour ex\u00e9cuter le script shell d'authentification.</p> <p>Pour le m\u00eame syst\u00e8me a \u00e9t\u00e9 utilis\u00e9 pour la mise \u00e0 disposition de la socket : l'owner est paroisse, et www-data y acc\u00e8de gr\u00e2ce au positionnement du groupe.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/authenticator.html#raf","title":"RAF","text":"<p>Voir s'il y a moyen de simplifier / factoriser les comptes tout en gardant le m\u00eame niveau de protection induit par les diff\u00e9renciations.</p> <pre><code>FROM ubuntu\nLABEL uepal.name=\"authenticator\" uepal.version=\"0.0.1\"\nENV INTERN_SERVERNAME=\"intern.civicrm.test\" AUTH_CLIENT_CERT=\"/var/run/secrets/KEYS/auth_client.x509\" AUTH_CLIENT_KEY=\"/var/run/secrets/KEYS/auth_client.pem\" AUTH_CLIENT_CA=\"/var/run/secrets/KEYS/ca.x509\" AUTH_CONTEXT=\"/var/run/AUTH_CLIENT_CONFIG\" CONTEXT=\"/var/run/AUTH_CLIENT_CONFIG\"\nRUN groupadd -g 1000 -f paroisse &amp;&amp; useradd -d /nonexistent -e 1 -g 1000 -u 1000 -M -N -s /usr/sbin/nologin paroisse &amp;&amp; usermod -L paroisse &amp;&amp; groupadd -g 1001 -f authenticator &amp;&amp; useradd -d /nonexistent -e 1 -g 1001 -u 1001 -M -N -s /usr/sbin/nologin authenticator &amp;&amp; usermod -L authenticator &amp;&amp; mkdir /exec &amp;&amp; mkdir /var/run/AUTH_CLIENT_CONFIG &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y wget socat &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; mkdir /app &amp;&amp; mkdir /AUTH &amp;&amp; install -d /var/run/secrets/KEYS &amp;&amp; chmod 550 /var/run/secrets &amp;&amp; chmod 550 /var/run/secrets/KEYS &amp;&amp; chown root:authenticator -R /var/run/secrets\nCOPY exec.sh /exec/\nCOPY AUTH/* AUTH/\nCOPY AUTH_CLIENT_CONFIG/* /var/run/AUTH_CLIENT_CONFIG/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/auth_client* /var/run/secrets/KEYS/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/ca.x509 /var/run/secrets/KEYS/\nRUN chown root:authenticator /var/run/secrets/KEYS/* &amp;&amp; chmod 440 /var/run/secrets/KEYS/* &amp;&amp; chown root:authenticator -R /exec &amp;&amp; chmod -R 550 /exec\nVOLUME /authentication\nCMD [\"/exec/exec.sh\"]\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/authenticator.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Description Valeur par d\u00e9faut INTERN_SERVERNAME Nom du serveur interne \"intern.civicrm.test\" AUTH_CLIENT_CERT chemin du certificat client authenticateur \"/var/run/secrets/KEYS/auth_client.x509\" AUTH_CLIENT_KEY chemin de la clef pour le client authenticateur \"/var/run/secrets/KEYS/auth_client.pem\" AUTH_CLIENT_CA chemin du CA \"/var/run/secrets/KEYS/ca.x509\" AUTH_CONTEXT chemin du r\u00e9pertoire de configuration \"/var/run/AUTH_CLIENT_CONFIG\" CONTEXT chemin du r\u00e9pertoire de configuration \"/var/run/AUTH_CLIENT_CONFIG\""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/authenticator.html#ecoute-sur-socket-unix","title":"Ecoute sur socket unix","text":"<p>L'authenticateur \u00e9coute sur une socket Unix, car c'est un bon moyen de faire des communications entre containers d'un m\u00eame pod sans passer par le r\u00e9seau. Etant donn\u00e9 que l'authenticateur vient \u00e0 la base d'une image unifi\u00e9 entre authenticateur, serveur web interne et reverse proxy, le plus simple a \u00e9t\u00e9 d'utiliser socat pour brancher une socket unix sur un script d\u00e9j\u00e0 existant :</p> <pre><code>#!/bin/bash\nsocat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt UNIX-LISTEN:/authentication/authenticator,fork,user=paroisse,group=www-data,mode=0660,unlink-early EXEC:/AUTH/externalauth.sh,su=authenticator\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_base.html","title":"Image composer_base","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Cette image est une des images de base du syst\u00e8me. De ce fait, cette image contient le n\u00e9cessaire commun n\u00e9cessaire aux images d\u00e9riv\u00e9es. Son but principal est de fournir une version utilisable de composer.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_base.html#contenu-necessaire-commun-aux-images-derivees","title":"Contenu n\u00e9cessaire commun aux images d\u00e9riv\u00e9es","text":"<p>Le n\u00e9cessaire int\u00e8gre la mise \u00e0 jour de l'image, la mise au bon fuseau horaire, l'installation d'outils comme wget et php et les utilitaires xml.</p> <p>De m\u00eame il y a la cr\u00e9ation de l'utilisateur et du groupe paroisse.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_base.html#bug-de-compatibilite-composersymfonycivicrm","title":"Bug de compatibilit\u00e9 composer/symfony/civicrm","text":"<p>Cette image est une image qui a \u00e9t\u00e9 construite pour r\u00e9gler une probl\u00e9matique technique li\u00e9e \u00e0 une interaction entre les d\u00e9pendances de composer et le code source natif de civicrm :</p> <pre><code>PHP Fatal error:  Uncaught TypeError: Return value of \"Civi\\CompilePlugin\\Command\\CompileCommand::execute()\" must be of the type int, \"null\" returned. in /composer/vendor/symfony/console/Command/Command.php:301\nStack trace:\n#0 /composer/vendor/symfony/console/Application.php(1015): Symfony\\Component\\Console\\Command\\Command-&gt;run()\n#1 /composer/vendor/symfony/console/Application.php(299): Symfony\\Component\\Console\\Application-&gt;doRunCommand()\n#2 /composer/vendor/composer/composer/src/Composer/Console/Application.php(336): Symfony\\Component\\Console\\Application-&gt;doRun()\n#3 /composer/vendor/symfony/console/Application.php(171): Composer\\Console\\Application-&gt;doRun()\n#4 /composer/vendor/composer/composer/src/Composer/Console/Application.php(131): Symfony\\Component\\Console\\Application-&gt;run()\n#5 /composer/vendor/composer/composer/bin/composer(84): Composer\\Console\\Application-&gt;run()\n#6 {main}\n  thrown in /composer/vendor/symfony/console/Command/Command.php on line 301\n</code></pre> <p>Composer a une d\u00e9pendance sur symfony/console ; si composer est packag\u00e9 avec une version 5.4 ou plus, la d\u00e9pendance requiert que la m\u00e9thode execute de  https://github.com/civicrm/composer-compile-plugin/blob/master/src/Command/CompileCommand.php retourne un entier (cf https://github.com/symfony/console/blob/5.4/Command/Command.php ligne 301).</p> <p>Avec l'image composer \"officielle\" je n'ai pas le probl\u00e8me car le code de la d\u00e9pendance n'inclut pas l'exception. En revanche, elle est d\u00e9clench\u00e9e par le composer packag\u00e9 par ubuntu dans la 21.10.</p> <p>La solution est donc de pr\u00e9parer un composer en utilisant une version inf\u00e9rieure de symfony : via composer.json, on peut pr\u00e9parer cette version en utilisant le composer fourni par le syst\u00e8me : </p> <pre><code>{\n\"require\":{\n\"composer/composer\":\"^2\",\n\"symfony/console\":\"^4\"\n}\n}\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html","title":"Composer_files","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>L'image composer_files permet de figer les fichiers \u00e0 d\u00e9ployer pour une instance CiviCRM, ce qui permet de comprendre les inclusions effectu\u00e9es depuis le Dockerfile (<code>COPY --from</code>, pr\u00e9sents notamment dans tools, et indirectement init et cron, ainsi que dans httpd).</p> <pre><code>{\n\"config\":{\n\"allow-plugins\":true,\n\"store-auths\":false\n},\n\"repositories\":[{\n\"type\":\"git\",\n\"url\":\"/composer_registry/DRUPAROISSE\"\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/CIVIPAROISSE\"\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/SETUP\"\n},{\n\"type\":\"package\",\n\"package\":[{\n    \"name\":\"eileenmcnaughton/org.wikimedia.geocoder\",\n    \"version\":\"1.8\",\n    \"source\":{\n        \"type\":\"git\",\n        \"url\":\"https://github.com/eileenmcnaughton/org.wikimedia.geocoder.git\",\n        \"reference\":\"1.8\"\n     }\n},{\n    \"name\":\"systopia/de.systopia.birthdays\",\n    \"version\":\"1.4\",\n    \"source\":{\n        \"type\":\"git\",\n        \"url\":\"https://github.com/systopia/de.systopia.birthdays.git\",\n        \"reference\":\"1.4\"\n     }\n},{\n    \"name\":\"civicrm/org.civicrm.recentmenu\",\n    \"version\":\"1.3\",\n    \"source\":{\n        \"type\":\"git\",\n        \"url\":\"https://github.com/civicrm/org.civicrm.recentmenu.git\",\n        \"reference\":\"1.3\"\n    }\n}]\n}\n],\n    \"extra\":{\n    \"installer-paths\": {\n            \"web/core\": [\"type:drupal-core\"],\n            \"web/libraries/{$name}\": [\"type:drupal-library\"],\n            \"web/modules/contrib/{$name}\": [\"type:drupal-module\"],\n            \"web/profiles/contrib/{$name}\": [\"type:drupal-profile\"],\n            \"web/themes/contrib/{$name}\": [\"type:drupal-theme\"],\n            \"drush/Commands/contrib/{$name}\": [\"type:drupal-drush\"],\n            \"web/modules/custom/{$name}\": [\"type:drupal-custom-module\"],\n            \"web/profiles/custom/{$name}\": [\"type:drupal-custom-profile\"],\n            \"web/themes/custom/{$name}\": [\"type:drupal-custom-theme\"]\n        },\n\"drupal-scaffold\":{\n\"locations\":{\n\"web-root\":\"web/\"\n},\n\"allowed-packages\":[\"drupal/recommended-project\"]\n},\n\"compile-mode\":\"all\",\n\"compile-passthru\":\"always\",\n\"enable-patching\":true,\n        \"compile-whitelist\": [\"civicrm/civicrm-core\", \"civicrm/composer-compile-lib\"],\n\"drupal-l10n\":{\n\"languages\":[\"fr\"]\n},\n\"compile\":[\n{\"run\":\"@sh /bin/bash -c pwd ; export VERSION=`xmllint -xpath '/version/version_no/text()' vendor/civicrm/civicrm-core/xml/version.xml`; wget -O- https://download.civicrm.org/civicrm-${VERSION}-l10n.tar.gz|tar -z -f- -C vendor/civicrm/civicrm-core -x --strip-components=1\"}\n],\n\"patches\":{\n\"systopia/de.systopia.birthdays\":{\n\"Curly brace adjustement\":\"patches/birthdays.patch\"\n}\n}\n},\n\"require\":{\n\"drush/drush\":\"~11\",\n\"drupal/recommended-project\":\"~9.2\",\n\"drupal-composer/drupal-l10n\":\"~2\",\n\"cweagans/composer-patches\":\"~1.7\",\n\"eileenmcnaughton/org.wikimedia.geocoder\":\"1.8\",\n\"systopia/de.systopia.birthdays\":\"1.4\",\n\"civicrm/org.civicrm.recentmenu\":\"1.3\",\n\"civicrm/civicrm-core\":\"~5.47.0\",\n\"civicrm/civicrm-packages\":\"~5.47.0\",\n\"civicrm/civicrm-drupal-8\":\"~5.47.0\",\n\"civicrm/civicrm-asset-plugin\":\"~1.1\",\n\"civicrm/composer-downloads-plugin\":\"~3\",\n\"civicrm/composer-compile-plugin\":\"~0.17\",\n\"uepal/fr.uepalparoisse.civiparoisse\":\"0.0.1\",\n\"uepal/fr.uepalparoisse.druparoisse\":\"0.0.1\",\n\"uepal/civisetup\":\"0.0.1\"\n},\n\"minimum-stability\":\"dev\",\n\"prefer-stable\":true\n}\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#allow-plugins","title":"Allow plugins","text":"<p>** Pour le moment, la directive allow plugins a \u00e9t\u00e9 plac\u00e9e \u00e0 true, ce qui autorise l'ex\u00e9cution des plugins sans avoir besoin de les sp\u00e9cifier. Toutefois, on pourrait pr\u00e9f\u00e9rer une liste de plugins explicitement d\u00e9clar\u00e9s. **</p> <p>** Ce param\u00e8tre a \u00e9t\u00e9 mis \u00e0 true pour le moment car la valeur par d\u00e9faut de ce param\u00e8tre va passer en juillet 2022 de <code>null</code> \u00e0 <code>{}</code> : autorisation implicite \u00e0 aucun plugin autoris\u00e9 (voir https://getcomposer.org/doc/06-config.md#allow-plugins) **</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#diversite-des-sources","title":"Diversit\u00e9 des sources","text":"<p>Plusieurs types de sources sont utilis\u00e9es :</p> <ul> <li>les packages de Packagist : pour les packages \"standards\"</li> <li>les packages qui viennent de d\u00e9p\u00f4t Git qui disposent d'un n\u00e9cessaire pour composer (composer.json) et de versionning (via des tags notamment) : type git</li> <li>les packages qui viennent de d\u00e9p\u00f4t Git mais qui n'ont pas le n\u00e9cessaire pour composer : ces packages sont d\u00e9clar\u00e9s de mani\u00e8re explicite, avec la r\u00e9f\u00e9rence vers la source : type package</li> </ul> <p>Les packages de sources locales de Civiparoisse sont destin\u00e9s \u00e0 \u00eatre remplac\u00e9 par les d\u00e9p\u00f4ts publics git une fois qu'une version aura \u00e9t\u00e9 stabilis\u00e9e et distribu\u00e9e.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#presence-de-drush-dans-les-packages-requis","title":"Pr\u00e9sence de drush dans les packages requis","text":"<p>Drush est pr\u00e9sent dans les packages requis. Ceci peut surprendre a priori, mais l'exp\u00e9rimentation montre qu'il est r\u00e9ellement n\u00e9cessaire : en effet, Drush est utilis\u00e9 pour ex\u00e9cuter les appels de cron, mais en ayant acc\u00e8s aux volumes de fichiers du serveur web interne ainsi qu'\u00e0 la base de donn\u00e9es. Lors de son ex\u00e9cution, Drush supplante dans certains services (notamment les logs) les classes qu'il fournit. Si lors de l'ex\u00e9cution de Drush les caches sont reg\u00e9n\u00e9r\u00e9s, les supplantations de Drush seront pr\u00e9sents dans les caches. Lorsque le cache est r\u00e9utilis\u00e9 sur le serveur web interne, le serveur doit avoir acc\u00e8s aux classes de Drush pour ne pas tomber sur une erreur.</p> <p>** On retiendra donc que Drush est n\u00e9cessaire pour ces classes, mais qu'on peut envisager de ne pas laisser les droits en ex\u00e9cution sur les ex\u00e9cutables dans les fichiers. **</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#patches","title":"Patches","text":"<p>Le package <code>cweagans/composer-patches</code> permet d'indiquer des fichiers de patches \u00e0 d\u00e9ployer : un fichier du package systopia/de.systopia.birthdays devait \u00eatre mis \u00e0 jour pour r\u00e9gler un probl\u00e8me de syntaxe d\u00e9pr\u00e9ci\u00e9.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#scaffolding","title":"Scaffolding","text":"<p>Le scaffolding est le fait de r\u00e9partir les fichiers entre le DocumentRoot du site et un autre lieu hors du DocumentRoot. Cette r\u00e9partition est pr\u00e9vue par le package <code>drupal/recommended-project</code> ; toutefois, il a fallu reprendre la majorit\u00e9 de cette configuration dans le fichier composer.json de l'image pour que ce scaffolding puisse avoir lieu, car il est n\u00e9cessaire que cette configuration se situe dans le composer.json principal.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/composer_files.html#traductions","title":"Traductions","text":"<p>Les traductions ont deux sources : * pour Drupal, il s'agit du package <code>drupal-composer/drupal-l10n</code> * pour CiviCRM, les traductions sont r\u00e9cup\u00e9r\u00e9es via une \u00e9tape de (post)-compilation, o\u00f9 l'on va r\u00e9cup\u00e9rer d'abord la version de CiviCRM depuis un fichier XML pr\u00e9sent dans les sources, puis r\u00e9cup\u00e9rer sur le net les traductions, et enfin les d\u00e9compresser au bon endroit.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/cron.html","title":"Cron","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Cette image est tr\u00e8s simple : elle est pr\u00e9vue pour ex\u00e9cuter les t\u00e2ches cron \u00e0 la fois de civicrm et drupal. Elle est pr\u00e9vue pour qu'on y connecte les volumes via montage, mais elle doit acc\u00e9der les BD mysql de l'instance.</p> <p>Sa planification d'ex\u00e9cution doit \u00eatre pr\u00e9vue dans Kubernetes. </p> <pre><code>#!/bin/bash\nsudo www-data cv --cwd=/app api job.execute\nsudo www-data drush --no-interaction --quiet --root /app core:cron\n</code></pre> <pre><code>FROM uepal_test/tools\nCOPY exec.sh /exec/exec.sh\nRUN chown -R root:root /exec &amp;&amp; chmod -R 500 /exec\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/db_tls_client.html","title":"DB_TLS_CLIENT : proxy pour le tunnel SSL","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Cette image permet de fournir un point de terminaison de tunnel SSL pour chiffrer le trafic BD entre un client et un serveur. Le client se connecte \u00e0 une socket unix (en PHP, en tant que client qui va vouloir passer par le tunnel, et en premier lieu par la socket.on va profiter pour r\u00e9gler correctement le chemin de la socket par d\u00e9faut, et on pourra utiliser le nom <code>localhost</code> pour passer pr\u00e9f\u00e9rablement par la socket unix).</p> <p>L'image exploite <code>socat</code> pour pr\u00e9parer le tunnel :</p> <pre><code>#!/bin/bash\nsocat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt UNIX-LISTEN:/SOCK/mysqld.sock,fork,user=paroisse,group=www-data,mode=0660,unlink-early  OPENSSL:${DEST_HOST}:${DEST_PORT},certificate=${CLIENT_CERT},key=${CLIENT_KEY},cafile=${CAFILE},verify=1,cipher=TLSv1.2,pf=ip4,commonname=${DEST_CN}\necho \"socat client exit code : \" $?\nexit 0\n</code></pre> <p>En ce qui concerne la n\u00e9gociation TLS, on se reportera aux \u00e9l\u00e9ments mentionn\u00e9s au niveau du serveur proxy. Tout au plus, on remarque que le nom que doit pr\u00e9senter le serveur est mentionn\u00e9 sp\u00e9cifiquement dans la ligne de commande. La socket unix est pr\u00e9vue pour \u00eatre utilisable par les membres du groupe www-data, donc par Apache.</p> <p>La particularit\u00e9 que pr\u00e9sente dans ce script est la pr\u00e9sence du echo et du exit. Le code de retour d'un script bash est normalement le code de retour de la derni\u00e8re commande ex\u00e9cut\u00e9e. Pour qu'un pod de job soit termin\u00e9 dans Kubernetes, il faut que l'ensemble des containers du pod aient termin\u00e9 leur ex\u00e9cution. Cette image \u00e9tant un sidecar, lorsqu'on utilise cette image via un cron, on partage sp\u00e9cifiquement l'espace des processus entre les containeurs du pod du cron. De la sorte, lorsque le cron a termin\u00e9 sa \"charge utile\", il lance un <code>pkill socat</code> qui va d\u00e9clencher l'envoi d'un signal <code>SIGTERM</code>. A ce moment, socat va effectivement s'arr\u00eater, mais il va renvoyer un code de retour dit \"synth\u00e9tique\" : il indique qu'il a \u00e9t\u00e9 tu\u00e9 avec un SIGTERM, en utilisant le code 143=128 (tu\u00e9) + 15 (num\u00e9ro de signal SIGTERM), selon https://www.baeldung.com/linux/status-codes. Or, si Kubernetes remarque une sortie diff\u00e9rente de 0, il va consid\u00e9rer que le processus ne s'est pas termin\u00e9 normalement, donc il va relancer le container (\u00e0 v\u00e9rifier : s'il ne relance pas carr\u00e9ment tout le pod). On r\u00e9cup\u00e8re le code de sortie pour le logguer et on force le code de sortie pour contenter Kubernetes.</p> <p>Pour rappel : les num\u00e9ros de signaux :</p> <pre><code>root@7107cbe21154:/app# kill -l\n 1) SIGHUP   2) SIGINT   3) SIGQUIT  4) SIGILL   5) SIGTRAP\n 6) SIGABRT  7) SIGBUS   8) SIGFPE   9) SIGKILL 10) SIGUSR1\n11) SIGSEGV 12) SIGUSR2 13) SIGPIPE 14) SIGALRM 15) SIGTERM\n16) SIGSTKFLT   17) SIGCHLD 18) SIGCONT 19) SIGSTOP 20) SIGTSTP\n21) SIGTTIN 22) SIGTTOU 23) SIGURG  24) SIGXCPU 25) SIGXFSZ\n26) SIGVTALRM   27) SIGPROF 28) SIGWINCH    29) SIGIO   30) SIGPWR\n31) SIGSYS  34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3\n38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8\n43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13\n48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12\n53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7\n58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2\n63) SIGRTMAX-1  64) SIGRTMAX    \n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/db_tls_client.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker CAFILE Fichier d'autorit\u00e9 de certification /var/run/secrets/KEYS/db_ca.x509 CLIENT_CERT Fichier de certificat client /var/run/secrets/KEYS/db_intern_client.x509 CLIENT_KEY Fichier de clef client /var/run/secrets/KEYS/db_intern_client.pem DEST_HOST H\u00f4te de destination civicrmdbproxy DEST_PORT Port de destination 443 DEST_CN Common Name du serveur civicrmdbproxy"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/db_tls_server.html","title":"DB_TLS_SERVER : ambassadeur pour connexion TLS","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Le r\u00f4le de cette image est de fournir une terminaison de tunnel TLS vers un serveur MySQL. On utilise <code>socat</code> \u00e0 cet effet.</p> <pre><code>#!/bin/bash\nsocat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt OPENSSL-LISTEN:${SERVER_PORT},certificate=${SERVER_CERT},key=${SERVER_KEY},cafile=${CAFILE},verify=1,fork,bind=0.0.0.0,pf=ip4,cipher=TLSv1.2 UNIX-CONNECT:${SOCK}\n</code></pre> <p>Au niveau de la configuration, on retrouve des \u00e9l\u00e9ments connus comme les temporisations, et le d\u00e9buggage. En ce qui concerne la n\u00e9gociation TLS, on constate qu'une autorit\u00e9 de certification est utilis\u00e9e et que les certificats pr\u00e9sent\u00e9s au serveur doivent \u00eatre valides. Le choix du cipher TLSv1.2 n'est pas anodin : en effet, le choix du cipher conditionne les algorithmes utilisables lors de la connexion SSL, et les algorithmes de TLSv1.2 et support\u00e9s par openssl requi\u00e8reraient tous une authentification \u00e0 clef publique, si l'on s'en r\u00e9f\u00e8re \u00e0 la sortie de <code>openssl ciphers</code>, pour voir les ciphers support\u00e9s en tls1_2 :</p> <pre><code>root@6883307658b0:/app# openssl ciphers -tls1_2 -V -stdname -s\n          0xC0,0x2C - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384       - ECDHE-ECDSA-AES256-GCM-SHA384  TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AESGCM(256)            Mac=AEAD\n          0xC0,0x30 - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384         - ECDHE-RSA-AES256-GCM-SHA384    TLSv1.2 Kx=ECDH     Au=RSA   Enc=AESGCM(256)            Mac=AEAD\n          0x00,0x9F - TLS_DHE_RSA_WITH_AES_256_GCM_SHA384           - DHE-RSA-AES256-GCM-SHA384      TLSv1.2 Kx=DH       Au=RSA   Enc=AESGCM(256)            Mac=AEAD\n          0xCC,0xA9 - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 - ECDHE-ECDSA-CHACHA20-POLY1305  TLSv1.2 Kx=ECDH     Au=ECDSA Enc=CHACHA20/POLY1305(256) Mac=AEAD\n          0xCC,0xA8 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256   - ECDHE-RSA-CHACHA20-POLY1305    TLSv1.2 Kx=ECDH     Au=RSA   Enc=CHACHA20/POLY1305(256) Mac=AEAD\n          0xCC,0xAA - TLS_DHE_RSA_WITH_CHACHA20_POLY1305_SHA256     - DHE-RSA-CHACHA20-POLY1305      TLSv1.2 Kx=DH       Au=RSA   Enc=CHACHA20/POLY1305(256) Mac=AEAD\n          0xC0,0x2B - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256       - ECDHE-ECDSA-AES128-GCM-SHA256  TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AESGCM(128)            Mac=AEAD\n          0xC0,0x2F - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256         - ECDHE-RSA-AES128-GCM-SHA256    TLSv1.2 Kx=ECDH     Au=RSA   Enc=AESGCM(128)            Mac=AEAD\n          0x00,0x9E - TLS_DHE_RSA_WITH_AES_128_GCM_SHA256           - DHE-RSA-AES128-GCM-SHA256      TLSv1.2 Kx=DH       Au=RSA   Enc=AESGCM(128)            Mac=AEAD\n          0xC0,0x24 - TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384       - ECDHE-ECDSA-AES256-SHA384      TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AES(256)               Mac=SHA384\n          0xC0,0x28 - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384         - ECDHE-RSA-AES256-SHA384        TLSv1.2 Kx=ECDH     Au=RSA   Enc=AES(256)               Mac=SHA384\n          0x00,0x6B - TLS_DHE_RSA_WITH_AES_256_CBC_SHA256           - DHE-RSA-AES256-SHA256          TLSv1.2 Kx=DH       Au=RSA   Enc=AES(256)               Mac=SHA256\n          0xC0,0x23 - TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256       - ECDHE-ECDSA-AES128-SHA256      TLSv1.2 Kx=ECDH     Au=ECDSA Enc=AES(128)               Mac=SHA256\n          0xC0,0x27 - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256         - ECDHE-RSA-AES128-SHA256        TLSv1.2 Kx=ECDH     Au=RSA   Enc=AES(128)               Mac=SHA256\n          0x00,0x67 - TLS_DHE_RSA_WITH_AES_128_CBC_SHA256           - DHE-RSA-AES128-SHA256          TLSv1.2 Kx=DH       Au=RSA   Enc=AES(128)               Mac=SHA256\n          0xC0,0x0A - TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA          - ECDHE-ECDSA-AES256-SHA         TLSv1   Kx=ECDH     Au=ECDSA Enc=AES(256)               Mac=SHA1\n          0xC0,0x14 - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA            - ECDHE-RSA-AES256-SHA           TLSv1   Kx=ECDH     Au=RSA   Enc=AES(256)               Mac=SHA1\n          0x00,0x39 - TLS_DHE_RSA_WITH_AES_256_CBC_SHA              - DHE-RSA-AES256-SHA             SSLv3   Kx=DH       Au=RSA   Enc=AES(256)               Mac=SHA1\n          0xC0,0x09 - TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA          - ECDHE-ECDSA-AES128-SHA         TLSv1   Kx=ECDH     Au=ECDSA Enc=AES(128)               Mac=SHA1\n          0xC0,0x13 - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA            - ECDHE-RSA-AES128-SHA           TLSv1   Kx=ECDH     Au=RSA   Enc=AES(128)               Mac=SHA1\n          0x00,0x33 - TLS_DHE_RSA_WITH_AES_128_CBC_SHA              - DHE-RSA-AES128-SHA             SSLv3   Kx=DH       Au=RSA   Enc=AES(128)               Mac=SHA1\n          0x00,0x9D - TLS_RSA_WITH_AES_256_GCM_SHA384               - AES256-GCM-SHA384              TLSv1.2 Kx=RSA      Au=RSA   Enc=AESGCM(256)            Mac=AEAD\n          0x00,0x9C - TLS_RSA_WITH_AES_128_GCM_SHA256               - AES128-GCM-SHA256              TLSv1.2 Kx=RSA      Au=RSA   Enc=AESGCM(128)            Mac=AEAD\n          0x00,0x3D - TLS_RSA_WITH_AES_256_CBC_SHA256               - AES256-SHA256                  TLSv1.2 Kx=RSA      Au=RSA   Enc=AES(256)               Mac=SHA256\n          0x00,0x3C - TLS_RSA_WITH_AES_128_CBC_SHA256               - AES128-SHA256                  TLSv1.2 Kx=RSA      Au=RSA   Enc=AES(128)               Mac=SHA256\n          0x00,0x35 - TLS_RSA_WITH_AES_256_CBC_SHA                  - AES256-SHA                     SSLv3   Kx=RSA      Au=RSA   Enc=AES(256)               Mac=SHA1\n          0x00,0x2F - TLS_RSA_WITH_AES_128_CBC_SHA                  - AES128-SHA                     SSLv3   Kx=RSA      Au=RSA   Enc=AES(128)               Mac=SHA1\n</code></pre> <p>En TLS 1.3, les ciphers support\u00e9s ne pr\u00e9cisent le protocole d'authentification. Il a donc sembl\u00e9 plus judicieux de l'\u00e9viter :</p> <pre><code>root@6883307658b0:/app# openssl ciphers -tls1_3 -V -stdname -s\n          0x13,0x02 - TLS_AES_256_GCM_SHA384                        - TLS_AES_256_GCM_SHA384         TLSv1.3 Kx=any      Au=any   Enc=AESGCM(256)            Mac=AEAD\n          0x13,0x03 - TLS_CHACHA20_POLY1305_SHA256                  - TLS_CHACHA20_POLY1305_SHA256   TLSv1.3 Kx=any      Au=any   Enc=CHACHA20/POLY1305(256) Mac=AEAD\n          0x13,0x01 - TLS_AES_128_GCM_SHA256                        - TLS_AES_128_GCM_SHA256         TLSv1.3 Kx=any      Au=any   Enc=AESGCM(128)            Mac=AEAD\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/db_tls_server.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker CAFILE certificat d'autorit\u00e9 /var/run/secrets/KEYS/db_ca.x509 SERVER_CERT certificat du serveur /var/run/secrets/KEYS/civicrmdbproxy.x509 SERVER_KEY clef du certificat serveur /var/run/secrets/KEYS/civicrmdbproxy.pem SOCK chemin local de la socket /SOCK/mysqld.sock SERVER_PORT port d'\u00e9coute du serveur 443"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/httpd.html","title":"Image HTTPD","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Cette image a pour vocation de faire tourner le serveur web interne. Elle d\u00e9rive de <code>ubuntu/apache2</code> et int\u00e8gre des \u00e9l\u00e9ments issus d'images tierces par copie (<code>COPY --from</code> dans le Dockerfile).</p> <pre><code>FROM ubuntu/apache2\nLABEL uepal.name=\"httpd\" uepal.version=\"0.0.1\"\nENV INTERN_SERVERNAME=\"intern.civicrm.test\" INTERN_CA=\"/var/run/secrets/KEYS/ca.x509\" INTERN_CERT=\"/var/run/secrets/KEYS/intern.civicrm.test.x509\" INTERN_KEY=\"/var/run/secrets/KEYS/intern.civicrm.test.pem\" AUTH_CLIENT_CN=\"auth_client\" PROXY_CLIENT_CN=\"proxy_client\" AUTH_CONTEXT=\"/var/run/AUTH_CLIENT_CONFIG\"\nRUN groupadd -g 1000 -f paroisse &amp;&amp; useradd -d /nonexistent -e 1 -g 1000 -u 1000 -M -N -s /usr/sbin/nologin paroisse &amp;&amp; usermod -L paroisse &amp;&amp; mkdir /exec &amp;&amp; mkdir /var/run/AUTH_CLIENT_CONFIG &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y php8.1 php8.1-cli php8.1-curl php8.1-gd php8.1-intl php8.1-mysql php8.1-opcache php8.1-xml php8.1-bcmath php8.1-mbstring php8.1-soap php8.1-xsl php8.1-zip &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; mkdir /app &amp;&amp; mkdir /AUTH &amp;&amp; install -d /var/run/secrets/KEYS\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/intern* /var/run/secrets/KEYS/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/ca* /var/run/secrets/KEYS/\nCOPY --from=uepal_test/composer_files /app /app/\nCOPY civicrm.conf /etc/apache2/sites-available/\nRUN service apache2 stop &amp;&amp; a2enmod ssl &amp;&amp; a2enmod rewrite &amp;&amp; a2ensite civicrm &amp;&amp; chown root:root /etc/apache2/sites-available/civicrm.conf &amp;&amp; chmod 400 /etc/apache2/sites-available/civicrm.conf &amp;&amp; chown -R root:root /var/run/secrets/KEYS &amp;&amp; chgrp www-data /var/run/secrets/KEYS &amp;&amp; chmod 510 /var/run/secrets/KEYS &amp;&amp; chmod 440 /var/run/secrets/KEYS/*\nVOLUME /app/web/sites /app/private\nEXPOSE 444\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/httpd.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Description Valeur par d\u00e9faut INTERN_SERVERNAME Nom du serveur interne \"intern.civicrm.test\" INTERN_CA Chemin du CA interne \"/var/run/secrets/KEYS/ca.x509\" INTERN_KEY Chemin de la clef li\u00e9e au certificat \"/var/run/secrets/KEYS/intern.civicrm.test.pem\" AUTH_CLIENT_CN Common name de l'authenticateur \"auth_client\" PROXY_CLIENT_CN Common name du client du reverse-proxy \"proxy_client\" AUTH_CONTEXT Contexte pass\u00e9 \u00e0 l'authenticateur \"/var/run/AUTH_CLIENT_CONFIG\""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/httpd.html#configuration-dapache","title":"Configuration d'Apache","text":"<p>La configuration d'Apache a une particularit\u00e9 : la grande utilisation des variables d'environnements d\u00e9clar\u00e9es : on retrouve cette possibilit\u00e9 dans la documentation Apache (https://httpd.apache.org/docs/current/fr/env.html). On force une authentification via certificat SSL, et on force en plus que le common name du certificat soit dans une liste d\u00e9finie (certificat issu pour l'authenticateur ou le reverse-proxy partie client).</p> <pre><code>Listen 0.0.0.0:444\n&lt;VirtualHost 0.0.0.0:444&gt;\nServerName ${INTERN_SERVERNAME}\nDocumentRoot /app/web\n&lt;Directory /app/web&gt;\nAllowOverride All\nSSLRequireSSL\n&lt;RequireAll&gt;\nRequire ssl\nRequire expr \"(%{SSL_CLIENT_S_DN_CN} in {%{ENV:AUTH_CLIENT_CN},%{ENV:PROXY_CLIENT_CN}})\"\n&lt;/RequireAll&gt;\n&lt;/Directory&gt;\nSSLEngine on\nSSLCACertificateFile ${INTERN_CA}\nSSLCertificateFile ${INTERN_CERT}\nSSLCertificateKeyFile ${INTERN_KEY}\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLVerifyClient require\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/init.html","title":"Image init","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/init.html#description","title":"Description","text":"<p>Cette image est pr\u00e9vue pour initialiser les volumes d'une instance. Elle est pr\u00e9vue pour effectuer les t\u00e2ches d'installation sp\u00e9cifi\u00e9es dans un script shell, utilisant grandement les variables d'environnement.</p> <p>Les secrets (dont mots de passe) sont sens\u00e9s \u00eatre pass\u00e9s via des fichiers mont\u00e9s dans l'environnement du container, comme ce qui est pr\u00e9vu dans Kubernetes pour la mise \u00e0 disposition des secrets, ce qui permet d'ailleurs la personnalisation des installations.</p> <p>A noter que si les volumes ne sont pas vides, le script est pr\u00e9vu pour ne rien faire.</p> <pre><code>FROM uepal_test/tools\nLABEL uepal.name=\"init\" uepal.version=\"0.0.1\"\nENV PAROISSE_NAME=\"Paroisse Uepal de test\" PAROISSE_ADDR=\"1b,quai Saint Thomas\" PAROISSE_CITY=\"Strasbourg\"  PAROISSE_PHONE=\"0011223344\" PAROISSE_ZIPCODE=\"67000\" CIVI_DOMAIN=\"DomaineParoisse\" DBNAME_CIVICRM=\"civicrm\" DBNAME_DRUPAL=\"drupal\" DBNAME_CIVILOG=\"civilog\" DBHOST=\"civicrmdb\" DBUSER=\"exploitant\" DBSECRET=\"dbsecret\"  DRUPAL_ADMIN_USER_SECRET=\"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET=\"drupal_password\" SERVERNAME=\"civicrm.test\" TRUSTED_HOST_PATTERNS=\"['^civicrm\\\\.test$','^intern\\\\.civicrm\\\\.test$']\" MAILADMIN_ADDR=\"admin@civicrm.test\" MAILADMIN_NAME=\"Admin ADMIN\" MAILADMIN_DESCR=\"mail admin descr\" MAILDIR=\"/maildir\" SITENAME=\"Site de test civicrm\"\nRUN rsync -av /app/web/sites/ /app/web/sites_orig &amp;&amp; rsync -av /var/lib/mysql/ /var/lib/mysql_orig &amp;&amp; rm -Rf /app/web/sites/* &amp;&amp; rm -Rf /var/lib/mysql/*\nCOPY exec.sh /exec/exec.sh\nCOPY secrets /var/run/secrets/\nRUN chown -R root:root /exec &amp;&amp; chmod -R 500 /exec &amp;&amp; chown -R root:root /var/run/secrets &amp;&amp; find /var/run/secrets -type f -exec chmod 400 '{}' \\; &amp;&amp; find /var/run/secrets -type d -exec chmod 500 '{}' \\;\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/init.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker PAROISSE_NAME Nom de la paroisse \"Paroisse Uepal de test\" PAROISSE_ADDR Adresse de la paroisse \"1b,quai Saint Thomas\" PAROISSE_CITY Ville de la paroisse \"Strasbourg\" PAROISSE_PHONE Num\u00e9ro de t\u00e9l\u00e9phone de la paroisse \"0011223344\" PAROISSE_ZIPCODE Code postal de la paroisse \"67000\" CIVI_DOMAIN Nom du domaine civicrm \"DomaineParoisse\" DBNAME_CIVICRM Nom DB CiviCRM \"civicrm\" DBNAME_DRUPAL Nom DB Drupal \"drupal\" DBNAME_CIVILOG Nom DB Audit CiviCRM \"civilog\" DBHOST Hote base de donn\u00e9es \"civicrmdb\" DBUSER Utilisateur au niveau des BD mysql \"exploitant\" DBSECRET Nom du secret pour le mot de passe \"dbsecret\" DRUPAL_ADMIN_USER_SECRET Nom du secret pour l'utilisateur administrateur Drupal \"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET Nom du secret pour le mot de passe administrateur Drupal \"drupal_password\" SERVERNAME Nom du serveur externe \"civicrm.test\" TRUSTED_HOST_PATTERNS Patterns de hosts autoris\u00e9s pour Drupal \"['^civicrm\\.test$','^intern\\.civicrm\\.test$']\" MAILADMIN_ADDR Adresse mail de l'administrateur \"admin@civicrm.test\" MAILADMIN_NAME Nom de l'administrateur pour l'adresse mail \"Admin ADMIN\" MAILADMIN_DESCR Description de l'adresse mail admin \"mail admin descr\" MAILDIR Path du r\u00e9pertoire de mails entrants (maildir) \"/maildir\" SITENAME Nom du site \"Site de test civicrm\""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/init.html#raf","title":"RAF","text":"<ul> <li>Am\u00e9liorer les trusted_host_patterns, pour rajouter le \"intern\" en dur, en plus des autres patterns.</li> <li>S'occuper du MAILDIR (pas dans l'image init, mais dans le reste : Docker et Helm)</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/proxy.html","title":"Reverse-proxy","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Le reverse proxy permet de requ\u00e9rir l'authentification sur l'ensemble des requ\u00eates entrantes. Il dispose d'un acc\u00e8s au serveur web interne via la un certificat (proxy client).</p> <p>Il est \u00e0 noter que l'utilisation de deux certificats diff\u00e9rents (authenticator pour l'authenticateur, et proxy pour le proxy) et de deux containers diff\u00e9rents se justifie : lorsqu'Apache d\u00e9marre, il utilise ses droits root pour la lecture des fichiers, dont les fichiers de clefs, tandis que les clefs sont ex\u00e9cut\u00e9es via www-data, qui n'a donc plus le droit aux fichiers de clefs (tant que les droits sont bien positionn\u00e9s). Le script d'authentification fonctionne \u00e9galement gr\u00e2ce au compte www-data ; or, on ne veut pas qu'un \u00e9ventuel attaquant qui aurait pris le contr\u00f4le de www-data puisse avoir acc\u00e8s au certificat : d'o\u00f9 l'utilisation de l'autre container et de la socket pour introduire une s\u00e9paration,et la protection du certificat de l'authenticateur.</p> <pre><code>FROM ubuntu/apache2\nLABEL uepal.name=\"proxy\" uepal.version=\"0.0.1\"\nENV SERVERNAME=\"civicrm.test\" INTERN_SERVERNAME=\"intern.civicrm.test\" SERVER_CERT=\"/var/run/secrets/KEYS/civicrm.test.x509\" SERVER_KEY=\"/var/run/secrets/KEYS/civicrm.test.pem\" PROXY_MACHINE_CERT=\"/var/run/secrets/KEYS/proxy_client_unified.pem\" PROXY_CA=\"/var/run/secrets/KEYS/ca.x509\"  AUTH_CONTEXT=\"/var/run/AUTH_CLIENT_CONFIG\"\nRUN groupadd -g 1000 -f paroisse &amp;&amp; useradd -d /nonexistent -e 1 -g 1000 -u 1000 -M -N -s /usr/sbin/nologin paroisse &amp;&amp; usermod -L paroisse &amp;&amp; mkdir /exec &amp;&amp; mkdir /var/run/AUTH_CLIENT_CONFIG &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y libapache2-mod-authnz-external socat &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; mkdir /app &amp;&amp; mkdir /AUTH &amp;&amp; install -d /var/run/secrets/KEYS\nCOPY AUTH/* AUTH/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/civicrm.test.* /var/run/secrets/KEYS/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/proxy_client_unified.pem /var/run/secrets/KEYS/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/ca.x509 /var/run/secrets/KEYS/\nCOPY proxy.conf /etc/apache2/sites-available/\nRUN service apache2 stop &amp;&amp; a2enmod authnz_external &amp;&amp; a2enmod proxy &amp;&amp; a2enmod proxy_http &amp;&amp; a2enmod ssl &amp;&amp; a2enmod rewrite &amp;&amp; a2ensite proxy\nRUN chown root:root /etc/apache2/sites-available/proxy.conf &amp;&amp; chmod 400 /etc/apache2/sites-available/proxy.conf &amp;&amp; chown -R paroisse:www-data /AUTH &amp;&amp; chmod 550 -R /AUTH &amp;&amp; chown -R root:root /var/run/secrets/KEYS &amp;&amp; chmod 500 /var/run/secrets/KEYS &amp;&amp; chmod 400 /var/run/secrets/KEYS/*\nEXPOSE 443\nVOLUME /authenticator\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/proxy.html#variables-denvironnement","title":"Variables d'environnement","text":"Nom Description Valeur par d\u00e9faut SERVERNAME nom externe du serveur \"civicrm.test\" INTERN_SERVERNAME nom du serveur interne \"intern.civicrm.test\" SERVER_CERT certificat du serveur externe \"/var/run/secrets/KEYS/civicrm.test.x509\" SERVER_KEY clef priv\u00e9e associ\u00e9e au certificat du serveure externe \"/var/run/secrets/KEYS/civicrm.test.pem\" PROXY_MACHINE_CERT certificat et clef pour la partie client interne vers le serveur interne \"/var/run/secrets/KEYS/proxy_client_unified.pem\" PROXY_CA CA vis \u00e0 vis de la communication vers le serveur interne \"/var/run/secrets/KEYS/ca.x509\" AUTH_CONTEXT contexte d'authentification : r\u00e9pertoire o\u00f9 se trouve la configuration \"/var/run/AUTH_CLIENT_CONFIG\""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/proxy.html#configuration-apache","title":"Configuration Apache","text":"<p>La configuration Apache utilise les variables d'environnement  (voir https://httpd.apache.org/docs/current/fr/env.html). Pour le moment, l'utilisation du SSL est requise, mais une authentification par certificat n'a pas encore \u00e9t\u00e9 d\u00e9cid\u00e9e (m\u00eame si elle a \u00e9t\u00e9 \u00e9tudi\u00e9e dans l'\u00e9tude d'authentification).</p> <p>Les ports ont \u00e9t\u00e9 forc\u00e9s : </p> <ul> <li>443 pour le reverse proxy</li> <li>444 pour le serveur interne</li> </ul> <p>Cela est encore un reste de la configuration en image unique regroupant reverse-proxy, authenticateur et serveur web interne.</p> <pre><code>&lt;VirtualHost 0.0.0.0:443&gt;\nServerName ${SERVERNAME}\nAddExternalAuth dea \"/AUTH/externalauth.sh\"\nSetExternalAuthMethod dea pipe\nSSLEngine on\nSSLCertificateFile ${SERVER_CERT}\nSSLCertificateKeyFile ${SERVER_KEY}\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\nSSLProxyVerify require\nSSLProxyMachineCertificateFile ${PROXY_MACHINE_CERT}\nSSLProxyCACertificateFile ${PROXY_CA}\nSSLProxyCheckPeerCN on\nSSLProxyCheckPeerName on\nSSLProxyVerify require\nSSLProxyEngine on\nSSLOptions +StrictRequire\nSSLVerifyClient none\n&lt;Location \"/\"&gt;\nAuthExternalContext ${AUTH_CONTEXT}\n&lt;RequireAll&gt;\nRequire ssl\nRequire valid-user\n&lt;/RequireAll&gt;\nAuthType Basic\nAuthName \"Civiparoisse\"\nAuthBasicProvider external\nAuthExternal dea\nAuthBasicAuthoritative on\n&lt;/Location&gt;\nProxyPass \"/\" \"https://${INTERN_SERVERNAME}:444/\"\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/proxy.html#script-dauthentification","title":"Script d'authentification","text":"<p>L'import avec le script d'authentification est la valeur de sortie (z\u00e9ro ou diff\u00e9rent de z\u00e9ro). La valeur du retour \u00e0 utiliser est pass\u00e9e sur la communication socket vers l'authenticateur.</p> <p>Les timeouts avec des temps relativement \u00e9lev\u00e9s sont une pr\u00e9caution qui a permis de r\u00e9soudre un probl\u00e8me lors des tests, probl\u00e8me qui pourrait vraisemblablement se retrouver nettement moins fr\u00e9quemment en production : lorsqu'un c\u00f4t\u00e9 de la communication socket ferme son flux, une temporisation est d\u00e9clench\u00e9e par socat pour fermer l'autre c\u00f4t\u00e9 du flux : cette temporisation \u00e9tait insuffisante pour le traitement de la requ\u00eate pendant les tests, d'o\u00f9 l'augmentation de la temporisation \u00e0 une valeur haute (50 secondes).</p> <pre><code>#!/bin/bash\nresult=`socat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt STDIO UNIX-CONNECT:/authentication/authenticator`\necho \"BOF $result EOF\"\nif [[ \"$result\" = \"0\" ]]\nthen\nexit 0\nfi\nexit 8\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/proxy.html#raf","title":"RAF","text":"<p>A voir si on conserve les logs et le niveau de d\u00e9bug. Voir aussi pour un Web Application Firewall</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/selfkeys.html","title":"Selfkeys","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Cette image permet uniquement de g\u00e9n\u00e9rer une hi\u00e9rarchie de certificats SSL pour faire un CA autosign\u00e9 et des certificats qui vont utiliser ce CA comme racine.</p> <p>La cr\u00e9ation de l'image Docker ne va pas cr\u00e9er les fichiers de clefs : le script keys.sh doit \u00eatre lanc\u00e9 pour g\u00e9n\u00e9rer les fichiers. Ceci est fait expr\u00e8s, pour pouvoir rebuilder une image avec les m\u00eames clefs.</p> <p>En effet, l'image a en plus le (bon) go\u00fbt de ne pas embarquer la clef priv\u00e9e CA : du coup, il n'est pas possible de g\u00e9n\u00e9rer d'autres certitificats avec le CA comme racine.</p> <p>A noter que les certificats pr\u00e9vus pour les serveurs sont d\u00f4t\u00e9s d'un subjectAltName, comme cela semble \u00eatre requis pour Chromium.</p> <pre><code>FROM ubuntu\nLABEL uepal.name=\"keys\" uepal.version=\"0.0.1\"\nRUN mkdir /KEYS &amp;&amp; mkdir /KEYS/USAGE &amp;&amp; chmod -R 500 /KEYS &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY USAGE/* /KEYS/USAGE/\nWORKDIR /KEYS\nCMD [\"/bin/bash\",\"-c\", \"echo 'Hello KEYS'\"]\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/selfkeys.html#certificats-generes","title":"Certificats g\u00e9n\u00e9r\u00e9s","text":"<p>Les certificats g\u00e9n\u00e9r\u00e9s sont les suivants :</p> <ul> <li>ca : certificat d'authorit\u00e9</li> <li>intern.civicrm.test: certificat pour le serveur web interne (httpd)</li> <li>civicrm.test : certificat pour le reverse-proxy, pr\u00e9sent\u00e9 \u00e0 l'ext\u00e9rieur</li> <li>proxy_client : certificat pour le reverse-proxy, pr\u00e9sent\u00e9 au serveur web interne</li> <li>auth_client : certificat pour l'authenticateur, pr\u00e9sent\u00e9 au serveur web interne</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/tools.html","title":"Tools : image des outils","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>L'image des outils est une sorte d'image g\u00e9n\u00e9rale, \u00e0 tout faire, non sp\u00e9cialis\u00e9e, qui sert de support pour les op\u00e9rations sp\u00e9cifiques (initialisation d'une instance, mise \u00e0 jour d'une instance (RAF), ex\u00e9cution de cron).</p> <pre><code>FROM uepal_test/composer_base\nLABEL uepal.name=\"tools\" uepal.version=\"0.0.1\"\nARG MYSQLVERSION=8.0.28-0ubuntu4\nENV MYSQLVERSIONENV=${MYSQLVERSION}\nRUN echo \"MySQLVERSION : \"${MYSQLVERSION}\nRUN mkdir /tools &amp;&amp; mkdir /exec &amp;&amp; touch /usr/share/man/man5/maildir.maildrop.5.gz &amp;&amp; touch /usr/share/man/man7/maildirquota.maildrop.7.gz &amp;&amp; touch /usr/share/man/man1/makedat.1.gz &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y gnupg mysql-client nano openssh-client mc mysql-server mysql-server-8.0=${MYSQLVERSION} mysql-server-core-8.0=${MYSQLVERSION} mysql-client mysql-client-core-8.0=${MYSQLVERSION} maildrop rsync lftp openssh-client dnsutils &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY composer.* /tools/\nCOPY exec.sh /exec/exec.sh\nWORKDIR /tools\nRUN /composer/vendor/bin/composer install &amp;&amp; ln -s /tools/vendor/drush/drush/drush /usr/local/bin/drush &amp;&amp; ln -s /tools/vendor/bin/drupal /usr/local/bin/drupal &amp;&amp; wget https://download.civicrm.org/cv/cv.phar -O /usr/local/bin/cv &amp;&amp; chmod 755 /usr/local/bin/cv &amp;&amp; chmod 755 /exec/exec.sh &amp;&amp; maildirmake /maildir &amp;&amp; install -d /var/run/secrets\nCOPY --from=uepal_test/composer_files /app /app/\nWORKDIR /app\nVOLUME /var/lib/mysql /app/web/sites /maildir /app/private\nCMD [\"/exec/exec.sh\"]\n</code></pre> <p>Cette image n'est pas pr\u00e9vue pour \u00eatre \"en contact direct\" avec des connexions entrantes, ni une utilisation comme serveur. Elle n'est en aucun cas \"durcie\".</p> <p>Les outils sont install\u00e9s de plusieurs mani\u00e8res :  * packages Ubuntu (mysql, maildrop, rsync, lftp, gnupg, nano...) * packages Composer (dont drupal-console et drush) * t\u00e9l\u00e9chargement direct (cv)</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/tools.html#installation-dune-version-specifique-de-mysql","title":"Installation d'une version sp\u00e9cifique de MySQL","text":"<p>L'installation d'une version sp\u00e9cifique de MySQL n'est pas un pr\u00e9requis. En revanche, le but de cette installation sp\u00e9cifique vient du fait que l'image <code>ubuntu/mysql</code> n'est pas forc\u00e9ment mise \u00e0 jour au m\u00eame rythme qu'une image <code>ubuntu</code>, ce qui peut conduire \u00e0 des diff\u00e9rences de versions. Ces diff\u00e9rences ont d'ailleurs d\u00e9j\u00e0 fait que des fichiers de BD MySQL cr\u00e9es avec une version sup\u00e9rieure (8.0.29) n'ont pas voulu fonctionner avec une version inf\u00e9rieure (8.0.28) : d'o\u00f9 la mise en place de l'argument pour la version mysql, avec une version par d\u00e9faut, qui est r\u00e9percut\u00e9e sur l'installation de packages Ubuntu.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/update.html","title":"Image update","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/update.html#description","title":"Description","text":"<p>Cette image est pr\u00e9vue pour finaliser une mise \u00e0 jour d'une instance. La mise \u00e0 jour des fichiers de code et des fichiers de traduction se fait certes via composer, mais il y a lieu ensuite d'effectuer les mises \u00e0 jour en particulier pour le niveau BD (et \u00e9ventuellement effectuer des manipulations au niveau des fichiers dans les volumes de l'installation, s'il y a lieu).</p> <p>Cette image descend des tools, et elle est pr\u00e9vue pour monter la base de donn\u00e9es. Toutefois, une modification de l'owner des fichiers a \u00e9t\u00e9 n\u00e9cessaire, car une modification analogue est effectu\u00e9e dans l'image ubuntu/mysql, afin que l'owner des fichiers soit bien l'utilisateur mysql, mais avec l'UID de l'utilisateur mysql de l'image. Cette modification est \"d\u00e9faite\" par l'initilisation du container ubuntu/mysql.</p> <p>L'image effectue plusieurs rafra\u00eechissements de cache, afin de chercher \u00e0 tenir compte des modifications qui auraient pu avoir lieu \u00e0 l'\u00e9tape juste avant du script.</p> <p>Il est \u00e0 noter que pour les traductions, il faut, au niveau de Drupal, importer le fichier de traduction, tandis que le fichier n\u00e9cessiterait simplement d'\u00eatre remplac\u00e9 au niveau de CiviCRM, selon le fonctionnement de l'extension de mise \u00e0 jour existante https://github.com/cividesk/com.cividesk.l10n.update/.</p> <p>Le code de cette image recopie une partie du code de l'init. Il faudra donc faire \u00e9voluer les deux images de concert.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/DOCKER/update.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker DBHOST Serveur DB civicrmdb SERVERNAME Nom externe du serveur civicrm.test"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/index.html","title":"Kubernetes","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <ul> <li>Maquettage</li> <li>Ressources</li> <li>Helm</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/maquettage.html","title":"Kubernetes : maquettage","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Kubernetes est l'environnement cible pour les environnements Civiparoisse. En effet, Kubernetes permet de g\u00e9rer un cluster de machines pour pouvoir ex\u00e9cuter des conteneurs sur le cluster.</p> <p>Il va y avoir en fait deux clusters :</p> <ul> <li>un cluster que l'on pourrait assimiler \u00e0 un cluster de calcul, qui va disposer des ressources mat\u00e9rielles pour ex\u00e9cuter les charge</li> <li>un cluster de stockage</li> </ul> <p>Les deux clusters doivent \u00eatre interconnect\u00e9s avec des ressources r\u00e9seau ad\u00e9quates.</p> <p>Le travail principal avec Kubernetes consiste \u00e0 d\u00e9finir de mani\u00e8re d\u00e9clarative, via des fichiers appel\u00e9s manifestes, \u00e9crits en JSON ou YAML, des ressources qui vont servir \u00e0 configurer des charges de travail \u00e0 ex\u00e9cuter.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/maquettage.html#minikube","title":"Minikube","text":"<p>En pratique, l'environnement utilis\u00e9 pour le d\u00e9veloppement est Minikube, qui est un environnement Kubernetes packag\u00e9, pr\u00e9vu pour apprendre. Avec Minikube, on est limit\u00e9 \u00e0 un cluster Kubernetes \u00e0 un seul noeud, mais on dispose d'une \u00e9mulation simple d'un syst\u00e8me de stockage persistant qui va stocker les donn\u00e9es sur le disque dur du syst\u00e8me (default-storageclass et storage-provisionner).</p> <p>** Remarque sur le storage-provisionner : ce provisionneur est un provisionneur tr\u00e8s simple, qui va utiliser l'espace dans /var/hostpath-provisionner du container Docker de Minikube. Cet espace est g\u00e9r\u00e9 \u00e0 l'aide du namespace et du nom de claim. Lorsque le PersistentVolumeClaim est supprim\u00e9, les donn\u00e9es ne seront pas forc\u00e9ment (et plut\u00f4t probablement pas) supprim\u00e9es. De ce fait, il convient de les effacer manuellement pour ne pas polluer une \u00e9ventuelle r\u00e9installation ult\u00e9rieure. **</p> <p>Minikube dispose de plusieurs modes de fonctionnement, dont le mode usuel, \u00e0 savoir Docker in Docker, ce qui veut dire qu'il faut rendre les images disponibles au Docker de Minikube pour pouvoir les utiliser - c'est relativement simple puisque Minikube a pr\u00e9vu la commande n\u00e9cessaire pour attaquer le Docker de minikube gr\u00e2ce \u00e0 la configuration de l'environnement : <code>eval $(minikube -p minikube docker-env)</code>.</p> <p>L'environnement de Minikube propose enfin aussi un dashboard dans un environnement web, ce qui est utile pour d\u00e9buter, pour les d\u00e9monstrations, et le d\u00e9buggage. N\u00e9anmoins, il convient de se familiariser \u00e9galement avec kubectl, kubectl \u00e9tant une outil qui sera utilis\u00e9 dans la plupart des environnements.</p> <p>L'environnement de production ne sera \u00e9videmment pas Minikube, mais sera soit un environnement de cloud public, soit un environnement de cloud h\u00e9berg\u00e9 ; dans tous les cas, il devra \u00eatre manag\u00e9 par des ressources tierces.</p> <p>Quelques commandes utiles : </p> <ul> <li> <p><code>minikube start</code> : d\u00e9marre le cluster par d\u00e9faut</p> </li> <li> <p><code>minikube stop</code>: arr\u00eate le cluster par d\u00e9faut</p> </li> <li> <p><code>minikube ip</code>: indique l'IP de cluster de minikube : utile pour faire la r\u00e9solution de nom dans /etc/hosts pour faire pointer les noms vers le cluster minikube depuis l'h\u00f4te</p> </li> <li> <p><code>minikube ssh</code>: acc\u00e8s SSH au container de minikube</p> </li> <li> <p><code>eval $(minikube docker-env)</code> : configuration du terminal courant pour se connecter au daemon docker de minikube (pour builder et puller les images par exemple)</p> </li> </ul> <p>*** Attention : pour le moment, il est n\u00e9cessaire de builder les images dans le docker de minikube pour les rendre disponibles pour Minikube. De m\u00eame, il est n\u00e9cessaire de faire attention \u00e0 la pull policy, et id\u00e9alement de puller soi-m\u00eame les images dans le docker de minikube, afin de les rendre utilisables par Minikube ***</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/maquettage.html#principe-de-fonctionnement-dacheminement-des-communications","title":"Principe de fonctionnement d'acheminement des communications","text":"<p>Les connexions entrantes sont dirig\u00e9es vers un point d'entr\u00e9e du cluster (ex : via les enregistrements DNS). On d\u00e9termine ensuite la bonne ressource (reverse proxy) destinataire, et on ex\u00e9cute la requ\u00eate dessus.</p> <p>On a un environnement \"mod\u00e8le\" qui va \u00eatre utilis\u00e9 pour d\u00e9ployer chaque environnement de paroisse, et qui va tirer parti des images g\u00e9n\u00e9r\u00e9es au niveau de Docker. Cet environnement mod\u00e8le est packag\u00e9 gr\u00e2ce \u00e0 Helm (https://helm.sh/).</p> <p></p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/maquettage.html#reverse-proxy-frontal-tcp-nginx-ingress-controller","title":"Reverse-Proxy frontal TCP : nginx ingress controller","text":"<p>On parle ici non pas du controller ingress nginx livr\u00e9 par Kubernetes, mais de celui livr\u00e9 par Nginx (F5) lui-m\u00eame : https://docs.nginx.com/nginx-ingress-controller/ et https://hub.docker.com/r/nginx/nginx-ingress/ . Son installation est assez simple, car il suffit de suivre les inscructions de https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/ pour installer le n\u00e9cessaire, en ligne de commande.</p> <p>Quelques remarques sont toutefois n\u00e9cessaires :</p> <ul> <li>pour l'ingress controller (deployments/daemon-set/nginx-ingress.yaml), il est n\u00e9cessaire d'ajouter sur la ligne de commmande les param\u00e8tres : </li> </ul> <pre><code>          - -enable-custom-resources\n          - -enable-tls-passthrough\n</code></pre> <ul> <li> <p>il est n\u00e9cessaire d'utiliser le daemonSet et non pas le deployment pour que notamment le port 443 soit accessible depuis l'ip du cluster minikube</p> </li> <li> <p>La configuration de chaque object TransportServer, qui va permettre de configurer le tunneling, est inclus dans le package de livrable Helm.</p> </li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/maquettage.html#recuperation-des-identifiants-drupal-apres-installation","title":"R\u00e9cup\u00e9ration des identifiants Drupal apr\u00e8s installation","text":"<p>Il est n\u00e9cessaire d'aller r\u00e9cup\u00e9rer les valeurs dans les secrets :  <pre><code>kubectl get secrets secret -n helmtls -o json\n</code></pre></p> <p>Les valeurs qui sont indiqu\u00e9es sont encod\u00e9es en base64. Il convient donc de les d\u00e9coder avec des commandes telles que :</p> <p><pre><code>echo \"valeur\"|openssl base64 -a -d -in - -out -; echo \"\"\n</code></pre> (Le deuxi\u00e8me echo est pr\u00e9sent pour ajouter une ligne vide et faciliter les copier-coller de la sortie).</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/ressources.html","title":"Ressources utiles","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Petite liste avec quelques ressources utiles :</p> <ul> <li>Concepts Kubernetes : https://kubernetes.io/docs/concepts/ : documentation des concepts tr\u00e8s int\u00e9ressante et n\u00e9cessaire pour \u00e9crire les manifestes</li> <li>Design Patterns (OpenShift): https://www.redhat.com/en/resources/oreilly-kubernetes-patterns-cloud-native-apps : \u00e9crit par un employ\u00e9 de redhat, livre Oreilly tr\u00e8s int\u00e9ressant avec des explications d\u00e9taill\u00e9es sur les fondamentaux et les concepts plus \u00e9volu\u00e9s des architectures K8S. Un livre \u00e0 garder sous la main.</li> <li>Design Patterns (Azure) : https://docs.microsoft.com/en-us/azure/architecture/patterns/</li> <li>Azure : ebook kubernetes (dont un O'Reilly) : https://azure.microsoft.com/en-us/resources/kubernetes-ebook-collection/</li> <li>K8S Operators : https://www.redhat.com/en/resources/oreilly-kubernetes-operators-automation-ebook</li> <li>K8S Storage for dummies : https://www.redhat.com/en/resources/storage-patterns-kubernetes-dummies-ebook</li> <li>Documentation installation nginx-ingress de F5 : https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/</li> <li>Ebooks chez Vmware Tanzu : https://tanzu.vmware.com/content/ebooks : dont des livres O'Reilly</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/index.html","title":"Chart Helm","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <ul> <li>DESCRIPTION GENERALE</li> <li>DB et DB Proxy</li> <li>Serveur web interne</li> <li>Proxy et authenticateur</li> <li>CRON</li> <li>Volumes</li> <li>Secrets</li> <li>R\u00e9servations</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/cron.html","title":"Cron","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>L'impl\u00e9mentation de l'appel \u00e0 cron utilise le cronjob. Le cron est synchronis\u00e9 via le container d'initialisation sur la disponibilit\u00e9 du proxy DB. On se rappelera que le proxy DB n'est activ\u00e9 que du moment o\u00f9 la BD elle-m\u00eame et les fichiers sont initialis\u00e9s via le container d'init de <code>stateful_set_db</code>. De plus, le container cron int\u00e8gre au d\u00e9but de son code d'ex\u00e9cution une routine d'attente pour \u00eatre certain que la BD est disponible (via  <code>mysqladmin ping</code>)</p> <p>La particularit\u00e9 du pod de cron est que pour que le pod se termine correctement, les deux containers doivent non seulement sortir, mais \u00e9galement sortir sans erreur (code de retour 0). Ceci implique qu'il faut arr\u00eater le container de proxy db (sidecar d'acc\u00e8s \u00e0 la BD), et pour ce faire, il faut pouvoir le tuer via les signaux, d'o\u00f9 le <code>shareProcessNamespace: true</code>.</p> <p>Pour le moment, le cronjob est d\u00e9clar\u00e9, mais est suspendu (<code>suspend: true</code>). Il faudra penser \u00e0 modifier ce point avant passage en production.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/db_dbproxy.html","title":"DB et DB proxy","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>La BD est h\u00e9berg\u00e9e dans un stateful set. La BD est pr\u00e9vue pour \u00eatre acc\u00e9d\u00e9e par une socket Unix directement, ou par un tunnel SSL : d'o\u00f9 les deux services distincts, m\u00eame s'il est vrai qu'il est moins pertinent d'avoir un service DB puisque ce service n'est pas pr\u00e9vu pour \u00eatre acc\u00e9d\u00e9 par le r\u00e9seau.</p> <p>Une cons\u00e9quence de cette architecture est qu'en PHP, si on configure correctement le chemin par d\u00e9faut des sockets, on peut utiliser le nom sp\u00e9cial <code>localhost</code> pour passer par la socket Unix et acc\u00e9der, directement ou indirectement \u00e0 la BD</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/db_dbproxy.html#initialisation","title":"Initialisation","text":"<p>Un container d'initialisation est charg\u00e9 d'initialiser l'ensemble des ressources (fichiers et base de donn\u00e9es). Il pourra \u00eatre envisag\u00e9 que ce container puisse \u00e9galement proc\u00e9der aux mises \u00e0 jours des donn\u00e9es (c'est \u00e0 dire, effectuer les modifications qui impactent la BD et les fichiers propres \u00e0 chaque paroisse - les images \u00e9tant mises \u00e0 jour en les reconstruisant).</p> <p>Il est \u00e0 noter que ce stateful set doit \u00eatre op\u00e9rationnel pour que les autres \u00e9l\u00e9ments puissent s'activer (synchronisation via containers d'initialisation).</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/db_dbproxy.html#configuration-bd","title":"Configuration BD","text":"<p>Selon la documentation de MySQL https://dev.mysql.com/doc/refman/8.0/en/memory-use.html, MySQL est pr\u00e9vu pour tenir dans environ 512M de RAM. Ceci est confirm\u00e9 en pratique par l'utilisation du performance_schema :</p> <pre><code>```mysql&gt; SELECT SUBSTRING_INDEX(event_name,'/',2) AS\n    -&gt;        code_area, FORMAT_BYTES(SUM(current_alloc))\n    -&gt;        AS current_alloc\n    -&gt;        FROM sys.x$memory_global_by_current_bytes\n    -&gt;        GROUP BY SUBSTRING_INDEX(event_name,'/',2)\n    -&gt;        ORDER BY SUM(current_alloc) DESC;\n+---------------------------+---------------+\n| code_area                 | current_alloc |\n+---------------------------+---------------+\n| memory/performance_schema | 214.94 MiB    |\n| memory/innodb             | 196.09 MiB    |\n| memory/sql                | 9.39 MiB      |\n| memory/mysys              | 8.58 MiB      |\n| memory/temptable          | 1.00 MiB      |\n| memory/mysqld_openssl     | 808.83 KiB    |\n| memory/mysqlx             | 3.38 KiB      |\n| memory/vio                | 1.16 KiB      |\n| memory/myisam             |  728 bytes    |\n| memory/csv                |  120 bytes    |\n| memory/blackhole          |  120 bytes    |\n+---------------------------+---------------+\n11 rows in set (0.02 sec)\nmysql&gt; select * from sys.memory_global_total;\n+-----------------+\n| total_allocated |\n+-----------------+\n| 448.20 MiB      |\n+-----------------+\n1 row in set (0.01 sec)\n</code></pre> <pre><code>root@b64de810e1b6:/# ps -ua\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0   4140  3368 pts/0    Ss   13:45   0:00 bash\nmysql         12  1.1 10.0 2228664 389164 pts/0  Sl+  13:45   0:02 mysqld\nroot         155  0.0  0.0   4136  3392 pts/1    Ss   13:46   0:00 bash\nroot         226  0.0  0.0   6420  1600 pts/1    R+   13:49   0:00 ps -ua\n</code></pre> <p>On constate en particulier l'utilisation de 215MB de ram pour performance_schema, alors que cette partie de la BD ne va pas r\u00e9ellement \u00eatre utilis\u00e9e. Du coup, il est envisageable de d\u00e9sactiver performance_schema. Apr\u00e8s d\u00e9sactivation, on ne peut plus utiliser la requ\u00eate SQL, mais on peut continuer \u00e0 utiliser <code>ps -ua</code> : <pre><code>mysql&gt; SELECT SUBSTRING_INDEX(event_name,'/',2) AS\n    -&gt;        code_area, FORMAT_BYTES(SUM(current_alloc))\n    -&gt;        AS current_alloc\n    -&gt;        FROM sys.x$memory_global_by_current_bytes\n    -&gt;        GROUP BY SUBSTRING_INDEX(event_name,'/',2)\n    -&gt;        ORDER BY SUM(current_alloc) DESC;\nEmpty set (0.01 sec)\nmysql&gt; select * from sys.memory_global_total;\n+-----------------+\n| total_allocated |\n+-----------------+\n| NULL            |\n+-----------------+\n1 row in set (0.02 sec)\n</code></pre></p> <p><pre><code>root@b64de810e1b6:/etc/mysql/conf.d# ps -ua\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0   4140  3368 pts/0    Ss   13:45   0:00 bash\nroot         155  0.0  0.0   4136  3400 pts/1    Ss   13:46   0:00 bash\nmysql        461  2.5  4.0 1940420 156368 pts/0  Sl+  13:52   0:01 mysqld\nroot         545  0.0  0.0   6420  1640 pts/1    R+   13:52   0:00 ps -ua\n</code></pre> Comme j'ai fait les op\u00e9rations dans un m\u00eame container, on peut voir que plus de la moiti\u00e9 de la RAM n'est plus utilis\u00e9e apr\u00e8s avoir mis <code>performance_schema = 0</code>.</p> <p>L'autre modification effectu\u00e9e est de positionner <code>skip_networking = 1</code> de sorte que le port r\u00e9seau ne soit plus \u00e9cout\u00e9, \u00e9tant qu'un acc\u00e8s direct est \u00e0 proscrire sans support chiffr\u00e9 configur\u00e9.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/db_dbproxy.html#proxy","title":"Proxy","text":"<p>Le proxy est en fait une utilisation d'un tunnel socat vers la socket de mysql. On prend en fait soin de positionner le r\u00e9pertoire de la socket dans un <code>emptyDir</code> stock\u00e9 en m\u00e9moire et d\u00e9clar\u00e9 dans les specs, et on partage ce volume entre le container de db et la terminaison serveur du proxy : c'est une application du design pattern sidecar.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/description_generale.html","title":"Chart Helm: description g\u00e9n\u00e9rale","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/description_generale.html#helm","title":"Helm","text":"<p>Helm est un syst\u00e8me de packaging pour Kubernetes. L'int\u00e9r\u00eat de Helm est qu'il permet de pr\u00e9parer des mod\u00e8les de d\u00e9ploiement d'application, dans un package appel\u00e9 \"chart\". En pratique, il permet notamment d'avoir des mod\u00e8les (templates) pour d\u00e9ployer des ressources Kubernetes, et permet d'injecter des valeurs dans ces ressources. Ces valeurs peuvent \u00eatre par exemple pr\u00e9cises dans des fichiers de valeurs, ou \u00eatre calcul\u00e9es depuis des commandes indiqu\u00e9es dans les fichiers, ou m\u00eame \u00eatre r\u00e9cup\u00e9r\u00e9es depuis un cluster Kubernetes (par exemple des clefs de chiffrement).</p> <p>Helm constitue donc un outil essentiel pour packager un environnement de paroisse.</p> <p>L'installation de Helm se fait assez simplement en r\u00e9cup\u00e9rant l'archive Helm depuis https://github.com/helm/helm/releases, en v\u00e9rifiant la somme de contr\u00f4le, en d\u00e9compressant l'archive, et en mettant Helm a un endroit accessible depuis le path (avec les droits d'ex\u00e9cution).</p> <p>Quelques commandes utiles : </p> <ul> <li> <p><code>helm install --create-namespace -n helmtls helmciviparoisse .</code> : depuis le package Helm de civiparoisse (le <code>.</code>), installer une release (ici nomm\u00e9e <code>helmciviparoisse</code>) dans un namespace cr\u00e9e pour l'occasion (ici <code>helmtls</code>), en utilisant les valeurs par d\u00e9faut</p> </li> <li> <p><code>helm uninstall -n helmtls helmciviparoisse</code>: d\u00e9sinstaller les ressources de la release <code>helmciviparoisse</code> dans le namespace <code>helmtls</code></p> </li> <li> <p><code>helm list -n helmtls</code> : r\u00e9cup\u00e9rer les noms de releases d'un namespace (ici <code>helmtls</code>)</p> </li> </ul> <p>** Attention : pour le moment, il faut builder les images uepal_test dans l'environnement docker de Minikube. De plus, il faut puller manuellement les images ubuntu, ubuntu/apache, ubuntu/mysql, \u00e0 cause des interactions avec le tag latest et la pull Policy mise \u00e0 none dans le package helm **</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/description_generale.html#description-des-types-dobjets-utilises-dans-le-chart-helm","title":"Description des types d'objets utilis\u00e9s dans le chart Helm","text":"<p>Il s'agit ici de d\u00e9finir une liste des types d'objets avec une br\u00e8ve description ; on se r\u00e9f\u00e8rera bien entendu \u00e0 la documentation Kubernetes (https://kubernetes.io/fr/docs/concepts/) et Nginx (https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/) pour des explications compl\u00e8tes.</p> <p>On va trouver des objets de bas niveau, qui sont des objets de base, qui vont \u00eatre employ\u00e9s et g\u00e9r\u00e9s implicitement par les objets de plus haut niveau, dont notamment :</p> <ul> <li> <p>Pod : le pod est un environnement d'ex\u00e9cution qui peut \u00eatre partag\u00e9 par un ou plusieurs containers. Les containers du pod auront tous acc\u00e8s au r\u00e9seau entre eux via le loopback (127.0.0.1), et ont un espace m\u00e9moire partag\u00e9. Outre les containers qui constituent la charge de travail pricipale du pod, on peut trouver des containers d'initialisation, qui sont lanc\u00e9s les uns apr\u00e8s les autres pour initialiser l'environnement du pod.</p> </li> <li> <p>ReplicaSet : un replicaSet se charge de maintenir actif un certain nombre de ressources de Pod bas\u00e9s sur un m\u00eame mod\u00e8le. Dans le cas de Civiparoisse, le passage par le ReplicaSet est plut\u00f4t anecdotique, dans la mesure o\u00f9 l'on ne maintiendra qu'un seul pod pour chaque t\u00e2che. Toutefois, le replicaSet est utilis\u00e9 indirectement par les d\u00e9ploiements.</p> </li> <li> <p>Namespace : le namespace est l'espace de nom, qui va permettre de regrouper les objets sp\u00e9cifiques \u00e0 une m\u00eame application (ici, un environnement Civiparoisse). Le namespace sera cr\u00e9e lors du d\u00e9ploiement du package Helm, via une option de la ligne de commande. De ce fait, on ne trouvera pas explicitement de d\u00e9finition du namespace.</p> </li> </ul> <p>En ce qui concerne les types d'objets explicitement d\u00e9clar\u00e9s, on retrouve : </p> <ul> <li> <p>PersistentVolumeClaim : cette ressource permet de d\u00e9finir un volume de stockage que l'on veut obtenir aupr\u00e8s d'un fournisseur (classe de stockage), avec des propri\u00e9t\u00e9s particuli\u00e8res (nom, taille du stockage, type d'acc\u00e8s...)</p> </li> <li> <p>ConfigMap : cette ressource permet de d\u00e9finir des couples clef-valeur qui vont ensuite \u00eatre rendus disponibles sous forme de variables d'environnement ou de montage de fichiers dans le conteneur. Ces objets ne sont pas pr\u00e9vus pour contenir des informations sensibles (mot de passes ou clefs par exemple)</p> </li> <li> <p>Secret : cette ressource permet le stockage d'informations sensibles dans le cluster Elle n'est normalement pas stock\u00e9 dans un conteneur, mais est mont\u00e9e comme fichier.</p> </li> <li> <p>CronJob : permet l'ex\u00e9cution p\u00e9riodique d'un type de pod</p> </li> <li> <p>Service : le service permet de publier au niveau du cluster la pr\u00e9sence d'un service qui est retrouv\u00e9 \u00e0 l'aide de s\u00e9lecteurs ; la publication se fait au niveau du DNS et dans les variables d'environnement.</p> </li> <li> <p>Deployment : objet d'ex\u00e9cution de charge pour les t\u00e2ches ne n\u00e9cessitant pas de gestion d'\u00e9tat ; ex : authenticateur</p> </li> <li> <p>StatefulSet : objet d'ex\u00e9cution de charge pour les t\u00e2ches n\u00e9cessitant une gestion d'\u00e9tat, et un nommage fixe ; ex : bd</p> </li> <li> <p>TransportServer : permet de configurer le TLS passthrough pour acc\u00e9der au pod reverse proxy d'une paroisse</p> </li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/description_generale.html#description-grosses-mailles-du-chart-helm","title":"Description grosses mailles du chart Helm","text":"<p>Le fichier principal du chart Helm est Chart.yaml. Ce fichier contient le versionning du package, mais surtout les annotations, qui peuvent \u00eatre utilis\u00e9es comme des constantes dans les templates. Dans ces annotations, on a en particulier les indications des images et des tags associ\u00e9s (pour le moment, tag latest, mais que sera \u00e0 changer pour le versionning r\u00e9el pour la production).</p> <p>Le principe de fonctionnement est d\u00e9crit dans la section d\u00e9di\u00e9e plus haut.</p> <p>Le fichier values.yaml contient des d\u00e9finitions de variables qui peuvent \u00eatre ensuite remplac\u00e9es lors de l'installation du chart. Ce sont les r\u00e9glages des valeurs de ce fichier qui va \u00eatre propre \u00e0 chaque paroisse (en plus des volumes de stockage).</p> <p>Le namespace sera d\u00e9fini \u00e0 l'installation du chart.</p> <p>Les constantes et les variables vont permettre de setter notamment les variables d'environnement ; les variables d'environnement sont expliqu\u00e9es au niveau des images Docker du projet.</p> <p>Le r\u00e9pertoire charts est pr\u00e9vu pour contenir des sous-charts. Ce r\u00e9pertoire est pour le moment vide.</p> <p>Le r\u00e9pertoire des templates contient les d\u00e9finitions des diff\u00e9rents composants pr\u00e9sent\u00e9s. Il n'y a que peu de choses \u00e0 dire, si ce n'est sur les secrets : les secrets peuvent \u00eatre r\u00e9cup\u00e9r\u00e9s depuis Kubernertes, de sorte \u00e0 ce qu'ils ne soient pas remplac\u00e9s par de nouvelles valeurs : c'est important pour les mot de passes. Ce m\u00e9canisme est \u00e9galement mis en oeuvre au niveau des clefs, car il est arriv\u00e9 que certains containers n'ont pas \u00e9t\u00e9 red\u00e9marr\u00e9s lors d'un upgrade et utilisaient les anciennes clefs, ce qui a d\u00e9clench\u00e9 un probl\u00e8me de communication entre les containers.</p> <p>Les containers d'initialisation ont plusieurs utilit\u00e9s :</p> <ul> <li>ils permettent d'initialiser des volumes avec des donn\u00e9es initiales, si les volumes sont vides</li> <li>ils permettent d'effectuer une synchronisation entre containers, en attendant qu'un service soit disponible par exemple, dans le container d'init.</li> </ul> <p>En ce qui concerne la synchronisation, l'ordre de d\u00e9marrage est fix\u00e9 dans une certaine mesure : </p> <ul> <li>le stateful set de base de donn\u00e9es d\u00e9marre en premier, en initilisant si n\u00e9cessaire la BD et les volumes persistants</li> <li>le serveur web interne d\u00e9marre ensuite</li> <li> <p>le serveur proxy d\u00e9marre enfin</p> </li> <li> <p>le cron peut d\u00e9marrer du moment que la BD est initialis\u00e9e, c'est \u00e0 dire que le stateful set de BD est pr\u00eat.</p> </li> </ul> <p>Le design pattern <code>sidecar</code> (et ses variantes) est utilis\u00e9 \u00e0 plusieurs reprises dans ce chart :</p> <ul> <li> <p>au niveau de la BD, les connexions sont chiffr\u00e9es / chiffrables via des connexions SSL dont les terminaisons sont dans des sidecars</p> </li> <li> <p>au niveau du proxy, l'authentificateur est \u00e9galement un sidecar</p> </li> </ul> <p>En termes de synchronisation / attentes :</p> <ul> <li>mysqladmin ping permet de v\u00e9rifier si une BD est disponible</li> <li>nslookup permet de v\u00e9rifier si un nom est r\u00e9solu ; ce test n'est toutefois pas trop int\u00e9ressant, car un service peut avoir une IP assign\u00e9e m\u00eame s'il n'y a pas de points de terminaisons associ\u00e9s au service</li> <li>nc -z permet de v\u00e9rifier si un port est ouvert</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/httpd.html","title":"Serveur web interne","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Il n'y a pas grand chose \u00e0 dire \u00e0 ce niveau, si ce n'est qu'on attend sur la disponibilit\u00e9 du proxy DB dans un container d'initialisation, puis qu'on utilise un sidecar pour se connecter \u00e0 la BD.</p> <p>La plupart des param\u00e8tres de configuration sont pass\u00e9s dans l'environnement via une configMap, tandis que les fichiers des clefs sont mont\u00e9s via des secrets.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/proxy_auth.html","title":"Proxy web et authenticateur","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Le proxy web est d\u00e9clar\u00e9 dans un d\u00e9ploiement, car il n'a pas de r\u00e9el \u00e9tat. Il dispose \u00e9ventuellement d'un cache d'authentification, mais les entr\u00e9es de ce cache n'ont pas vocation \u00e0 rester valide longtemps, et il peut \u00eatre reconstruit au fur et \u00e0 mesure de l'utilisation de civiparoisse.</p> <p>Le proxy web est synchronis\u00e9 sur le serveur web interne via un container d'initialisation qui attend l'ouverture du port (v\u00e9rification p\u00e9riodique avec <code>nc -z</code>).</p> <p>Le mod\u00e8le MPM du proxy a \u00e9t\u00e9 pass\u00e9 en prefork pour n'utiliser qu'une seule technologie dans le projet (simplification des comp\u00e9tences requises).</p> <p>Le proxy a un sidecar : le container d'authentification ; les deux discutent via une socket mont\u00e9e dans un emptyDir en m\u00e9moire.</p> <p>La plupart de la configuration est stock\u00e9e dans des config maps inject\u00e9es dans l'environnement, ainsi que dans des secrets.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/reservations.html","title":"R\u00e9servations de ressources","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/reservations.html#considerations-generales","title":"Consid\u00e9rations G\u00e9n\u00e9rales","text":"<p>La r\u00e9servation des ressources est un domaine important dans Kubernetes, car les r\u00e9servations permettent de mieux planifier l'ex\u00e9cution des pods. Les ressources attribu\u00e9es seraient garanties quand la demande et la limite sont \u00e9quivalentes. D'o\u00f9 la mise en oeuvre de limitations et de requ\u00eates de m\u00eames valeurs, et ce au niveau CPU et m\u00e9moire.</p> <p>Le profilage des ressources consomm\u00e9es joue sur plusieurs \u00e9l\u00e9ments :</p> <ul> <li>la RAM et l'espace disque sont des ressources critiques : en particulier, si l'on n'a plus de RAM, le container peut crasher ; en revanche, au niveau CPU, on jouera plut\u00f4t sur les performances (\u00e0 moins d'avoir des prol\u00e9matiques de temporisation)</li> <li>la BD est pr\u00e9vue initialement pour tenir dans 512Mo ; en d\u00e9sactivant performance_schema, on devrait pouvoir tenir dans 350Mo</li> <li>on peut limiter au niveau d'Apache le nombre de requ\u00eates servies simultan\u00e9ment ; ces requ\u00eates, lorsqu'elles arrivent sur du code PHP, font entrer en jeu la limite m\u00e9moire de PHP. On arrive alors \u00e0 borner la plus grosse d\u00e9pense m\u00e9moire</li> <li>le cron travaille avec un seul environnement PHP \u00e0 la fois : il devrait donc \u00eatre possible de borner sa consommation de RAM</li> <li>il y a le probl\u00e8me de l'authentification de toutes les requ\u00eates : si on passe \u00e0 la double authentification, on peut envisager d'utiliser le cache d'authentification malgr\u00e9 sa structure qui n'est plus satisfaisante, ce qui permettrait une meilleure utilisation des ressources</li> <li>on ne peut pas encore d\u00e9terminer avec pr\u00e9cision les espaces disques qui seront \u00e0 allouer, que ce soit pour les volumes persistants ou pour les volumes \u00e9ph\u00e9m\u00e8res (dont logs)</li> <li>il a \u00e9t\u00e9 pr\u00e9vu de pouvoir changer les valeurs des ressources dans chaque d\u00e9ploiement de release : en effet, la charge d\u00e9pend aussi de l'utilisation (intensive ou non) qui sera faite de l'outil. Il peut \u00eatre compr\u00e9hensible de chercher \u00e0 contenter les plus gros consommateurs tant que ce n'est pas au d\u00e9triment des autres consommateurs</li> <li>il ne faut pas oublier que le nombre cible de d\u00e9ploiements est tr\u00e8s cons\u00e9quent : de ce fait, des petites \u00e9conomies de ressources peuvent avoir toutefois un effet notable</li> <li>on ne peut pas additionner aveugl\u00e9ment les ressources de tous les containers : il faut \u00e9galement consid\u00e9rer l'ordre de d\u00e9marrage des pods, et le fait que les containers d'init d'un pod n'existent pas en m\u00eame temps que les containers qui constituent la v\u00e9ritable charge de travail</li> <li>il ne faut pas oublier que toutes les ressources du cloud ont un co\u00fbt associ\u00e9, d'o\u00f9 l'apparition d'une nouvelle d\u00e9marche : le FinOps, qui cherche \u00e0 optimiser l'utilisation des ressources et le co\u00fbt.</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/reservations.html#estimations-des-ressources-dune-instance","title":"Estimations des ressources d'une instance","text":""},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/reservations.html#hypotheses-de-travail","title":"Hypoth\u00e8ses de travail","text":"<p>Il est n\u00e9cessaire de poser un certain nombre d'hypoth\u00e8ses de travail :</p> <ul> <li> <p>on va supposer que l'on va utiliser le cache d'authentification ; en effet, le co\u00fbt d'une authentification multifacteur via du SSL est un co\u00fbt quasiment consid\u00e9rable comme fixe (prix des clefs de s\u00e9curit\u00e9, et \u00e9ventuellement, prix des certificats (annuels ou multiannuels)s'ils ne sont pas autog\u00e9n\u00e9r\u00e9s), alors que la puissance consomm\u00e9e d\u00e9pend du nombre de requ\u00eates, et influe donc sur le co\u00fbt de revient mensuel de l'instance : on va limiter le nombre de requ\u00eates traitables simultan\u00e9ment.</p> </li> <li> <p>on va se baser sur des ressources garanties (request=limit sur les r\u00e9servations), pour ne pas avoir en th\u00e9orie de probl\u00e8mes d'\u00e9viction</p> </li> <li> <p>il faudra rajouter le co\u00fbt d'un probable firewall qui viendra en coupure des flux</p> </li> <li> <p>on va passer sur un mod\u00e8le de threading Apache en mpm_prefork, qui est de toute fa\u00e7on utilis\u00e9 pour le PHP si on n'utilise pas php-fpm, et on va utiliser par simplicit\u00e9 ce mod\u00e8le de threading \u00e0 la fois sur le serveur web interne et le reverse proxy</p> </li> <li> <p>le minimum de m\u00e9moire (memory_limit requis par Drupal est 64M); toutefois selon https://docs.civicrm.org/installation/en/latest/general/requirements/ il faudrait passer au moins \u00e0 256M</p> </li> <li> <p>les logs passeront par un DaemonSet EFK ou \u00e9quivalent : du coup, le conteneur de gestion des logs n'est pas comptabilis\u00e9 dans l'infrastructure d'une instance</p> </li> <li> <p>on suppose qu'on n'int\u00e8gre pas de serveur de m\u00e9dias, qu'on n'int\u00e8gre pas le traitement des mails entrants (donc traitement manuel), et qu'on sp\u00e9cialise le traitement des mails sortants</p> </li> <li> <p>configuration mpm_prefork :</p> </li> </ul> <p><pre><code>MAX_CONNECTIONS_PER_CHILD=1\nMAX_REQUEST_WORKERS=4\nSERVER_LIMIT=4\nSTART_SERVERS=4\nMIN_SPARE_SERVERS=0\nMAX_SPARE_SERVERS=4\n</code></pre> Du coup, on sert 4 connexions simultan\u00e9es, ce qui pourrait \u00eatre suffisant pour un seul utilisateur.</p> Conteneur Description Limite m\u00e9moire Limite CPU proxy reverse proxy d'authentification 256Mi 250m proxy_init init du reverse proxy 50Mi 100m auth (proxy_authenticator) authentificateur 256Mi 250m cron ex\u00e9cution cron 384Mi 250m cron_dbproxy acc\u00e8s tunnel BD SSL pour cron 50Mi 100m cron_init initialisation du pod cron 50Mi 100m httpd serveur web interne 1536Mi 1000m httpd_dbproxy acc\u00e8s tunnel BD SSL pour serveur web 100Mi 100m httpd_init initialisation du pod server web interne 50Mi 100m db conteneur BD 512Mi 250m db_init initialisation environnement BD 1024Mi 1000m dbproxy acc\u00e8s tunnel BD SSL pour le serveur BD 100Mi 100m <p>Ordre de d\u00e9marrage (sans sp\u00e9cialisation du mail sortant):</p> <p>Les containeurs d'initialisation impl\u00e9mentent les contraintes suivantes :</p> <ul> <li><code>db_init</code> permet de lancer <code>db</code> et <code>dbproxy</code> </li> <li><code>httpd_init</code> d\u00e9pend de <code>dbproxy</code> pour lancer <code>httpd_dbproxy</code> et <code>httpd</code></li> <li><code>cron_init</code> d\u00e9pend de dbproxy pour lancer <code>cron</code> et <code>cron_dbproxy</code></li> <li><code>proxy_init</code> d\u00e9pend du lancement de <code>httpd</code> pour lancer <code>proxy</code> et <code>auth</code></li> </ul> <p>On en obtient un \u00e9quivalent de graphe de d\u00e9pendances :</p> <ul> <li><code>db_init</code><ul> <li><code>db</code></li> <li><code>dbproxy</code><ul> <li><code>httpd_init</code><ul> <li><code>httpd_dbproxy</code></li> <li><code>httpd</code><ul> <li><code>proxy_init</code><ul> <li><code>proxy</code></li> <li><code>auth</code></li> </ul> </li> </ul> </li> </ul> </li> <li><code>cron_init</code><ul> <li><code>cron</code></li> <li><code>cron_dbproxy</code></li> </ul> </li> </ul> </li> </ul> </li> </ul> <p>On peut d\u00e9duire deux phases de lancement d'une instance :</p> <ul> <li>installation initiale : seul <code>db_init</code> est lanc\u00e9 : 1024Mi, 1000m</li> <li>ensuite, le pire cas est quand tous les services tournent, car <code>httpd_init</code>, <code>proxy_init</code> et <code>cron_init</code> consomment moins que les services proprement dits. Toutefois, l'unit\u00e9 \u00e9tant le pod d'ex\u00e9cution (\u00e0 cause du scheduling sur les noeuds), il faut faire des sommes s\u00e9par\u00e9es pour chaque pod :<ul> <li>pod db : 1124Mi et 1100m</li> <li>pod cron : 434Mi et 350m</li> <li>pod httpd : 1636Mi et 1100m</li> <li>pod proxy : 512Mi et 500m</li> </ul> </li> </ul> <p>Ce \u00e0 quoi on ajoute la sp\u00e9cialisation du mail sortant :</p> <ul> <li>Client d'acc\u00e8s \u00e0 50Mi et 100m pour le pod httpd et le pod proxy</li> <li>Pod sp\u00e9cifique d'envoi des mails : 256Mi et 200m</li> </ul> <p>On en arrive donc, avec la sp\u00e9cialisation du mail sortant :</p> <ul> <li>pod db : 1124Mi et 1100m</li> <li>pod cron : 484Mi et 450m</li> <li>pod httpd : 1686Mi et 1200m</li> <li>pod proxy : 512Mi et 500m</li> <li>pod mail_sortant : 256Mi et 200m</li> </ul> <p>Donc une consommation totale max de : 4062Mi et 3450m</p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/secrets.html","title":"Secrets","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Les secrets sont de deux types :</p> <ul> <li> <p>le stockage des donn\u00e9es sensibles de type \"mot de passe\" : mot de passe DB, utilisateur/mot de passe admin Drupal : ces donn\u00e9es sont g\u00e9n\u00e9r\u00e9es par d\u00e9faut (en particulier avec la fonction <code>randAlpha</code> de Helm), et r\u00e9utilis\u00e9es si elles existent</p> </li> <li> <p>les infrastructures de clef : trois CA sont utilis\u00e9s :</p> <ul> <li>le CA pour le certificat pr\u00e9sent\u00e9 aux utilisateurs, au travers du proxy/auth</li> <li>le CA utilis\u00e9 pour les tunnels SSL pour la communication avec la BD : certificat pour le serveur db, pour le proxy db pour le serveur web interne, pour le proxy db pour cron</li> <li>le CA utilis\u00e9 pour les communications avec le serveur web interne : serveur web interne, partie client interne du proxy, authenticateur</li> </ul> </li> </ul> <p>On utilise \u00e9galement la fonction <code>lookup</code> de Helm pour conserver les clefs existantes et avoir ainsi une stabilit\u00e9 des clefs.   </p>"},{"location":"TECHNIQUE/ARCHIVES/INTEGRATION_AUTH_PROXY/KUBERNETES/HELM/volumes.html","title":"Volumes (persistants)","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Les volumes dont il est question ici sont les volumes persistants. Les volumes temporaires sont la plupart du temps utilis\u00e9 dans le contexte d'une mise \u00e0 disposition d'une socket Unix via un emptyDir.</p> <p>Les volumes sont g\u00e9r\u00e9s au travers de PersistentFolumeClaim sur une classe de stockage, avec un mode ReadwriteMany. Les tailles pr\u00e9sentes dans le chart seront \u00e0 adapter \u00e0 l'usage.</p> <p>On retrouve trois volumes persistants :</p> <ul> <li>dbvolclaim : le stockage des fichiers de la BD</li> <li>filevolclaim : le stockage des fichiers du site civicrm</li> <li>privatevolclaim: le stockage des fichiers priv\u00e9s du site civicrm</li> </ul> <p>D'autres volumes pourront faire leur apparition, notamment pour la sauvegarde, les logs, les mails.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/index.html","title":"Documentation diff\u00e9rentielle","text":"<p>Archiv\u00e9 le 1er mai 2023</p> <p>Elements diff\u00e9rents par rapport \u00e0 la documentation (historique) qui int\u00e9grait le reverse proxy d'authentification.</p> <ul> <li>Diff\u00e9rentiel des images Docker</li> <li>Diff\u00e9rentiel du chart Helm</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html","title":"Documentation diff\u00e9rentielle des images Docker pour le POC","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Les dockerfiles ont \u00e9t\u00e9 modifi\u00e9s pour tenir compte des d\u00e9cisions expliqu\u00e9es dans l'introduction.</p> <p>La branche <code>PRE_POC</code> qui a \u00e9t\u00e9 constitu\u00e9e pour le poc se base sur dev, et a re\u00e7u le merge des branches suivantes : </p> <ul> <li><code>ENV_KEV_KEYS</code></li> <li><code>CIVIP_49_Import</code></li> <li><code>RESERVATIONS</code></li> <li><code>DB_MYROUTER</code></li> </ul> <p>Un gros effort de nettoyage manuel a ensuite \u00e9t\u00e9 requis. Il est \u00e9galement \u00e0 pr\u00e9voir que le merge de CIVIP_49 dans l'extension Civiparoisse passera par de la r\u00e9solution de conflits qui n'a \u00e9t\u00e9 faite que sommairement pour le moment, puisque le code de Civiparoisse devrait \u00e0 terme disparaitre du d\u00e9p\u00f4t des Dockerfiles.</p> <p>On se retrouve avec les images suivantes, dont on ne va d\u00e9tailler que les diff\u00e9rences par rapport \u00e0 la version initiale :</p> <ul> <li>COMPOSER_BASE</li> <li>COMPOSER_FILES</li> <li>CRON</li> <li>HTTPD</li> <li>HTTPD_DEBUG</li> <li>INIT</li> <li>KEYS_INIT</li> <li>MYSQL_TLS_ROUTER</li> <li>MYSQL_TLS_SERVER</li> <li>SELFKEYS</li> <li>TOOLS</li> <li>TOOLS_DEBUG</li> <li>UPDATE</li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#composer_base","title":"<code>COMPOSER_BASE</code>","text":"<p><code>COMPOSER_BASE</code> n'a pas connu d'\u00e9volution notable.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#composer_files","title":"<code>COMPOSER_FILES</code>","text":"<p><code>COMPOSER_FILES</code> n'a plus besoin d'inclure le module druparoisse, puisque ce module \u00e9tait li\u00e9 au SSO Drupal. En revanche, comme il y a eu int\u00e9gration des travaux d'imports, le d\u00e9p\u00f4t de la librairie de parsage pour l'import devient une nouvelle d\u00e9pendance du composer.json.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#cron","title":"CRON","text":"<p><code>CRON</code> n' a pas connu d'\u00e9volution notable.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#httpd","title":"HTTPD","text":"<p>Le r\u00f4le de cette image est de faire tourner le serveur web frontal, sans proxy. De ce fait, le fichier de configuration du site s'est simplifi\u00e9, et l'image publie maintenant le port 443 (et plus 444).</p> <p><pre><code>&lt;VirtualHost 0.0.0.0:443&gt;\nServerName ${SERVERNAME}\nDocumentRoot /app/web\n&lt;Directory /app/web&gt;\nAllowOverride All\nSSLRequireSSL\n&lt;RequireAll&gt;\nRequire ssl\n&lt;/RequireAll&gt;\n&lt;/Directory&gt;\nSSLEngine on\nSSLCertificateFile ${SERVER_CERT}\nSSLCertificateKeyFile ${SERVER_KEY}\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\n&lt;/VirtualHost&gt;\n</code></pre> Les variables d'environnement ont \u00e9galement \u00e9t\u00e9 adapt\u00e9es :</p> Variable Description Valeur par d\u00e9faut MAX_CONNECTIONS_PER_CHILD Nombre de connexions servies par un worker avant d'\u00eatre recycl\u00e9 1 MAX_REQUEST_WORKERS Nombre de connexions simultan\u00e9es 4 SERVER_LIMIT Nombre de workers simultan\u00e9s 4 START_SERVERS Nombre de workers \u00e0 d\u00e9marrer 4 MIN_SPARE_SERVERS Nombre de workers inactifs minimum 1 MAX_SPARE_SERVERS Nombre de workers inactifs maximum 4 SERVERNAME Nom de l'h\u00f4te \"civicrm.test\" SERVER_CERT Chemin du fichier de certificat \"/var/run/secrets/KEYS/extern.x509\" SERVER_KEY Chemin du fichier de clef SSL \"/var/run/secrets/KEYS/extern.pem\""},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#httpd_debug","title":"<code>HTTPD_DEBUG</code>","text":"<p><code>HTTPD_DEBUG</code> n'a pas connu d'\u00e9volution notable.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#init","title":"INIT","text":"<p><code>INIT</code> a connu des modifications pour tenir compte de plusieurs \u00e9volutions : * la configuration de la BD est pass\u00e9e dans l'image toosl, de m\u00eames que les secrets par d\u00e9fauts, car ils sont \u00e9galement n\u00e9cessaires pour l'update * la notion de l'h\u00f4te 'intern' dispara\u00eet. * la configuration force l'utilisation de localhost comme h\u00f4te de DB, car on pr\u00e9voit que la connexion se fera par socket au proxy de BD. * mysql a une configuration plus importante qu'au pr\u00e9alable : cette configuration tient compte des pr\u00e9requis de la doc syst\u00e8me de CiviCRM, limite les droits du compte de BD pour Civicrm, et le compte root a maintenant un mot de passe. La configuration du compte root a \u00e9t\u00e9 modifi\u00e9e pour ne plus utiliser l'authentification par socket, car ce type d'authentification aurait pu fausser l'authentification des tunnels SSL socat. * la configuration Drupal li\u00e9e au proxy a \u00e9t\u00e9 comment\u00e9e, de sorte \u00e0 pouvoir \u00eatre r\u00e9activ\u00e9e facilement * la configuration du module authx de CiviCRM a \u00e9t\u00e9 comment\u00e9e, de m\u00eame que l'activation de ce module CiviCRM * le module druparoisse n'est plus install\u00e9, donc n'est plus activ\u00e9 * Drupal est configur\u00e9 pour utiliser <code>/civicrm</code> pour la page de front et <code>/user/login</code> pour la page 403 du site</p> <p>Configuration mysql : <pre><code>[mysqld]\nsql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\nskip_networking=1\nskip-log-bin\n</code></pre></p> <p>Les variables d'environnement utilis\u00e9es par l'image refl\u00e8tent \u00e9galement en partie ces \u00e9volutions :</p> Variable Signification Default Docker PAROISSE_NAME Nom de la paroisse \"Paroisse Uepal de test\" PAROISSE_ADDR Adresse de la paroisse \"1b,quai Saint Thomas\" PAROISSE_CITY Ville de la paroisse \"Strasbourg\" PAROISSE_PHONE Num\u00e9ro de t\u00e9l\u00e9phone de la paroisse \"0011223344\" PAROISSE_ZIPCODE Code postal de la paroisse \"67000\" CIVI_DOMAIN Nom du domaine civicrm \"DomaineParoisse\" DBNAME_CIVICRM Nom DB CiviCRM \"civicrm\" DBNAME_DRUPAL Nom DB Drupal \"drupal\" DBNAME_CIVILOG Nom DB Audit CiviCRM \"civilog\" DBHOST Hote base de donn\u00e9es \"localhost\" DBUSER Utilisateur au niveau des BD mysql \"exploitant\" DBSECRET Nom du secret pour le mot de passe du compte de BD mysql \"dbsecret\" DBROOTSECRET Nom du secret pour le mot de passe du compte root de BD mysql \"dbrootsecret\" DRUPAL_ADMIN_USER_SECRET Nom du secret pour l'utilisateur administrateur Drupal \"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET Nom du secret pour le mot de passe administrateur Drupal \"drupal_password\" SERVERNAME Nom du serveur externe \"civicrm.test\" TRUSTED_HOST_PATTERNS Patterns de hosts autoris\u00e9s pour Drupal \"['^civicrm\\.test$']\" MAILADMIN_ADDR Adresse mail de l'administrateur \"admin@civicrm.test\" MAILADMIN_NAME Nom de l'administrateur pour l'adresse mail \"Admin ADMIN\" MAILADMIN_DESCR Description de l'adresse mail admin \"mail admin descr\" MAILDIR Path du r\u00e9pertoire de mails entrants (maildir) \"/maildir\" SITENAME Nom du site \"Site de test civicrm\""},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#keys_init","title":"KEYS_INIT","text":"<p>Cette image a \u00e9t\u00e9 introduite pour pouvoir initialiser des jeux de clefs SSL en fonction du nom de domaine souhait\u00e9 par un d\u00e9veloppeur. Elle est pr\u00e9vue pour mettre l'ensemble des clefs dans un r\u00e9pertoire dans lequel on volume devrait \u00eatre mont\u00e9.</p> Variable Signification Default Docker SERVERNAME Nom du serveur externe \"civicrm.test\" <p>Cette image a \u00e9t\u00e9 modifi\u00e9e du fait que l'on a supprim\u00e9 le proxy, et que l'on n'utilise pas les tunnels SSL socat.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#mysql_tls_router","title":"MYSQL_TLS_ROUTER","text":"<p>Cette image embarque une configuration de mysqlrouter, qui force l'utilisation du SSL pour le SGBD cible, mais ne requiert pas le SSL pour le client (d'o\u00f9 une connexion privilig\u00e9e via une socket unix). De cette mani\u00e8re, on pourra se connecter \u00e0 un serveur MySQL \"classique\" en SSL, et on ne se prive pas d'une \u00e9ventuelle utilisation d'un \"MySQL as a service\".</p> <p>Configuration mysqlrouter.conf : </p> <p><pre><code>[DEFAULT]\nlogging_folder = \"\"\nlevel = debug\nsinks = consolelog\n\n[routing]\nprotocol = classic\nsocket = /SOCK/mysqld.sock\ndestinations = civicrmdb:3306\nserver_ssl_verify = VERIFY_CA\nserver_ssl_mode = REQUIRED\nserver_ssl_ca = /KEYS/db_ca.x509\nclient_ssl_mode = DISABLED\nrouting_strategy = next-available\nbind_port = 3306\nbind_address = 127.0.0.1\n\n[consolelog]\ndestination = /dev/stdout\n</code></pre> Cette image n'a pas de variable d'environnement, car MySQL ne permet d'en sp\u00e9cifier dans le fichier de configuration. Toutefois, dans le chart Helm, on pourra envisager si n\u00e9cessaire d'utiliser des variables g\u00e9r\u00e9es par Helm pour stocker le fichier de configuration. Ainsi, il pourrait \u00e9galement \u00eatre envisag\u00e9 d'utiliser une image officielle d\u00fbment configur\u00e9e au lieu d'une image personnalis\u00e9e.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#mysql_tls_server","title":"MYSQL_TLS_SERVER","text":"<p>Cette image est nouvelle. Elle sp\u00e9cifie l'obligation d'avoir un transport chiffr\u00e9, et positionne le mode SQL tel que prescrit par CiviCRM.</p> <p>Configuration mysqld :  <pre><code>[mysqld]\nrequire-secure-transport=ON\nssl_ca=/KEYS/db_ca.x509\nssl_cert=/KEYS/civicrmdb.x509\nssl_key=/KEYS/civicrmdb.pem\nsql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\nskip-log-bin\ntls_version=TLSv1.3\n</code></pre> Cette image n'a pas de variable d'environnement explicite. Toutefois, elle h\u00e9rite de ubuntu/mysql et utilise les clefs g\u00e9n\u00e9r\u00e9es dans SELFKEYS.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#selfkeys","title":"SELFKEYS","text":"<p>Cette image s'est simplifi\u00e9e du fait du proxy et des tunnels DB SSL qui ne sont plus mis en oeuvre. On dispose de deux CA (un pour le certificat serveur, et l'autre pour le certificat BD), et deux certificats sont g\u00e9n\u00e9r\u00e9s.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#tools","title":"TOOLS","text":"<p>La configuration de la BD est pass\u00e9e dans l'image toosl, de m\u00eames que les secrets par d\u00e9fauts, car ils sont \u00e9galement n\u00e9cessaires pour l'update</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#tools_debug","title":"TOOLS_DEBUG","text":"<p><code>TOOLS_DEBUG</code> n'a pas connu d'\u00e9volution notable.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/docker_diff.html#update","title":"UPDATE","text":"<p>On force le fait d'utiliser localhost comme BD du fait qu'on n'ajoute plus de r\u00e9solution de nom sp\u00e9cifique ; les secrets sont n\u00e9cessaires pour le shutdown de la BD. La configuration BD et les secrets \u00e9tant communs \u00e0 INIT et UPDATE, ils ont \u00e9t\u00e9 mont\u00e9s vers tools.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html","title":"POC : Documentation diff\u00e9rentielle du Chart Helm","text":"<p>Documentation archiv\u00e9e le 1er mai 2023.</p> <p>Le chart Helm s'est simplifi\u00e9 \u00e0 cause des d\u00e9cisions prises. Toutefois les principes de fonctionnement sont rest\u00e9s les m\u00eames : chaque instance se trouve dans un namespace, avec des volumes de stockages persistants d\u00e9di\u00e9s \u00e0 l'instance.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#services","title":"Services","text":"<p>On ne trouve plus que deux services : le service civicrmdb et le service civicrmhttpd.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#secrets","title":"Secrets","text":"<ul> <li> <p>secrets.yaml : un mot de passe al\u00e9atoire est g\u00e9n\u00e9r\u00e9 pour le compte root de la BD.</p> </li> <li> <p>secret_keys.yaml : la configuration a \u00e9t\u00e9 r\u00e9duite \u00e0 cause des certificats qui ne sont plus n\u00e9cessaires ; en revanche, un certificat est g\u00e9n\u00e9r\u00e9 pour le SGBD.</p> </li> </ul>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#configmaps","title":"ConfigMaps","text":"<ul> <li>La configuration du serveur db a \u00e9t\u00e9 mise \u00e0 jour de fa\u00e7on analogue \u00e0 l'image docker : </li> </ul> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-db-server\n  namespace: {{ .Release.Namespace }}\ndata:\n  mysqldcnf: |\n    [mysqld]\n    performance_schema = 0\n    require-secure-transport=ON\n    ssl_ca= {{ .Chart.Annotations.dbserversslca }}\n    ssl_cert= {{ .Chart.Annotations.dbserversslcert }}\n    ssl_key= {{ .Chart.Annotations.dbserversslkey }}\n    sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\n    skip-log-bin\n    tls_version=TLSv1.3\n</code></pre> <ul> <li>La configuration de la BD d'init d\u00e9sactive l'acc\u00e8s r\u00e9seau \u00e0 la BD : </li> </ul> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-db\n  namespace: {{ .Release.Namespace }}\ndata:\n  mysqldcnf: |\n    [mysqld]\n    skip_networking = 1\n</code></pre> <ul> <li>configuration HTTPD : cette configuration s'est simplifi\u00e9e, puisqu'on n'a plus la notion de serveur interne et de proxy.</li> </ul> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-httpd\n  namespace: {{ .Release.Namespace }}\ndata:\n  SERVERNAME: {{ .Values.servername | quote }}\n  SERVER_CERT: {{ .Values.httpd.serverCert | quote }}\n  SERVER_KEY: {{ .Values.httpd.serverKey | quote }}\n  MAX_CONNECTIONS_PER_CHILD: {{ .Values.httpd.internMaxConnectionsPerChild | quote }}\n  MAX_REQUEST_WORKERS: {{ .Values.httpd.internMaxRequestWorkers | quote }}\n  SERVER_LIMIT: {{ .Values.httpd.internServerLimit | quote }}\n  START_SERVERS: {{ .Values.httpd.internStartServers | quote }}\n  MIN_SPARE_SERVERS: {{ .Values.httpd.internMinSpareServers | quote }}\n  MAX_SPARE_SERVERS: {{ .Values.httpd.internMaxSpareServers | quote }}\n</code></pre> <ul> <li>configuration pour l'update : cette configuration est n\u00e9cessaire car le secret du compte root mysql est en particulier n\u00e9cessaire pour le shutdown de mysql.</li> </ul> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-update\n  namespace: {{ .Release.Namespace }}\ndata:\n  SERVERNAME: {{ .Values.servername | quote }}\n  DBHOST: {{ .Values.init.dbhost | quote }}\n  DRUPAL_ADMIN_USER_SECRET: {{ .Chart.Annotations.secretrefsDrupalAdminUserSecret | quote }}\n  DRUPAL_ADMIN_PASSWORD_SECRET: {{ .Chart.Annotations.secretrefsDrupalAdminPasswordSecret | quote }}\n  DBSECRET: {{ .Chart.Annotations.secretrefsDbsecret | quote }}\n  DBROOTSECRET: {{ .Chart.Annotations.secretrefsDbrootsecret | quote }}\n</code></pre>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#passthrough","title":"Passthrough","text":"<p>Le passthrough fait passer directement au service civicrmhttpd les requ\u00eates entrantes, en lieu et place du proxy.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#volumeclaims","title":"Volumeclaims","text":"<p>Etant donn\u00e9 que l'infrastructure de stockage ne supporte a priori pas le ReadWriteMany, on passe au ReadWriteOnce, ce qui signifie qu'un seul noeud Kubernetes peut \u00e0 la fois monter le syst\u00e8me de fichiers. L'impact est que l'ensemble des pods qui ont besoin du volume persistant doivent s'ex\u00e9cuter sur le m\u00eame noeud Kubernetes.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#cronjob","title":"Cronjob","text":"<p>Le principal changement du cronjob est l'int\u00e9gration de mysqlrouter pour l'acc\u00e8s \u00e0 la BD en lieu et place des tunnels SSL, ce qui n\u00e9cessite \u00e0 nouveau l'espace de noms des processus partag\u00e9s au niveau du pod, pour arr\u00eater mysqlrouter apr\u00e8s l'ex\u00e9cution du cron.</p>"},{"location":"TECHNIQUE/ARCHIVES/PREPOC_DIFF/helm_diff.html#statefulsets","title":"StatefulSets","text":"<p>Le statefulset de la BD int\u00e8gre l'utilisation des certificats SSL au niveau du SGBD, et la terminaison du tunnel SSL est supprim\u00e9e.</p> <p>Le statefulset du serveur httpd int\u00e8gre l'utilisation de mysqlrouter en lui et place du tunnel SSL, et les changements (simplifications) sur les certificats li\u00e9s \u00e0 la non utilisation du proxy.</p> <p>Il y a un autre statefulset : le stateful set des tools. Ce statefulset a un nombre de r\u00e9plicas qui vaut 0. Il permet surtout d'avoir un environnement sous la main qui sera rapidement accessible pour effectuer des op\u00e9rations comme l'import : on passera le nombre de r\u00e9plicas \u00e0 1, puis on se connectera au container du pod via un <code>kubectl exec</code>. L'int\u00e9r\u00eat du statefulset est ici son nom pr\u00e9visible qui simplifie la construction de la ligne de commande.</p>"},{"location":"TECHNIQUE/EXPLOITATION/index.html","title":"Exploitation","text":"<p>L'exploitation d\u00e9crit les \u00e9l\u00e9ments qui vont servir \u00e0 la maintenance en condition op\u00e9rationnel du syst\u00e8me.</p> <ul> <li>Les logs</li> </ul>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html","title":"Logs","text":""},{"location":"TECHNIQUE/EXPLOITATION/logs.html#generalites","title":"G\u00e9n\u00e9ralit\u00e9s","text":"<p>Les logs sont une partie tr\u00e8s importante de l'exploitation des syst\u00e8mes d'informations, car ils peuvent contenir des traces de l'utilisation (normale, comme malveillante) du syst\u00e8me d'information (SI).</p> <p>On trouve fr\u00e9quemment des syst\u00e8mes de logs sous forme de fichiers, de tables de BD, ou m\u00eame sous forme d'\u00e9v\u00e8nements implant\u00e9s dans les logiciels.</p> <p>Au niveau de Kubernetes, le mode de remont\u00e9e des logs le plus commun est l'\u00e9criture sur le STDOUT et le STDERR du processus qui tourne dans le pod. En compl\u00e9ment, il est \u00e9galement \u00eatre assez courant d'utiliser des sidecars pour effectuer des logs, par exemple pour r\u00e9cup\u00e9rer le contenu de certains fichiers (\u00e9quivalent \u00e0 du <code>tail -f</code>, ou une utilisation de tubes (nomm\u00e9s)).</p> Autres m\u00e9canismes de log <p>Au niveau des syst\u00e8mes, on constate \u00e9galement un autre m\u00e9canisme qui est utilis\u00e9 sur des syst\u00e8mes classiques : le syslog (<code>man 3 syslog</code>, fonction non syst\u00e8me). Le syslog est non seulement disponible comme service r\u00e9seau, mais il est \u00e9galement pr\u00e9vu via la <code>libc</code> que les appels aux fonctions <code>syslog</code> utilisent <code>/dev/log</code> comme socket Unix de destination. (En terme de services r\u00e9seau, on pourrait \u00e9galement penser aux serveurs AAA, avec le troisi\u00e8me A pour Accounting (par exemple FreeRadius)).</p> Syslog et socket Unix <p>Attention : les sockets Unix disposent \u00e9galement des diff\u00e9rents modes d'utilisation, notamment <code>SOCK_STREAM</code> et <code>SOCK_DGRAM</code>. Selon https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.38/administration-guide/31#TOPIC-2026236, syslog aurait originellement utilis\u00e9 le mode <code>SOCK_STREAM</code> et qu'\u00e0 cause d'une attaque DOS ce mode aurait chang\u00e9 en <code>SOCK_DGRAM</code>. Lorsqu'on regarde diff\u00e9rentes impl\u00e9mentations (notamment rsyslog, systemd, et syslog-ng), il semblerait que soit propos\u00e9 par d\u00e9faut l'utilisation de <code>SOCK_DGRAM</code>.</p> <p>Il existe aussi des fonctions de syslog en tant qu'appels syst\u00e8mes (<code>man 2 syslog</code>, appel syst\u00e8me), qui lui s'occupe des logs g\u00e9n\u00e9r\u00e9s par le kernel.</p> T\u00e9l\u00e9m\u00e9trie <p>En plus de ces \u00e9l\u00e9ments, il semblerait que les logs soient un constituant de la t\u00e9l\u00e9m\u00e9trie. La t\u00e9l\u00e9m\u00e9trie peut \u00eatre int\u00e9ressante, car elle est englobe un certain nombre de choses, que ce soit du tra\u00e7age de code, via de l'instrumentation manuelle et/ou automatique, un tra\u00e7age \u00e9ventuellement distribu\u00e9 entre les syst\u00e8mes (propagation d'un contexte), la remont\u00e9e de m\u00e9triques, et la remont\u00e9e des logs. Ce syst\u00e8me peut \u00eatre int\u00e9ressant dans le futur. Pour le moment, son int\u00e9r\u00eat semble toutefois limit\u00e9, car Civiparoisse n'est pas encore une architecture ultra-complexe, et les interactions entre \u00e9l\u00e9ments ne sont pas encore trop nombreuses. Toutefois, c'est un sujet qu'il faudra surveiller de pr\u00e8s, car il peut faciliter le travail des administrateurs puisque le tra\u00e7age distribu\u00e9 pourrait devenir une sorte de clef de voute reliant les diff\u00e9rents types d'information d\u00e9crivant une m\u00eame situation.</p> FluentBit et Syslog Unix : les modes unix_udp et unix_tcp <p>Dans l'entr\u00e9e syslog de FluentBit (https://docs.fluentbit.io/manual/pipeline/inputs/syslog), il faut comprendre le mode <code>unix_udp</code> comme une ouverture de socket en <code>AF_UNIX</code> et <code>SOCK_DGRAM</code>, tandis que le mode <code>unix_tcp</code> est une ouverture de socket en <code>AF_UNIX</code> et <code>SOCK_STREAM</code>.</p> A r\u00e9fl\u00e9chir : logs comme un flux \u00e0 parser ou un flux d'\u00e9v\u00e8nements <p>Lorsqu'on travaille avec des fichiers de logs, on cherche \u00e0 d\u00e9terminer des blocs de lignes qui vont ensemble, et qui constituent une entr\u00e9e de log \"atomique\". En travaillant avec des flux d'\u00e9v\u00e8nements, il serait \u00e9ventuellement possible d'obtenir cette granularit\u00e9 que l'on a au d\u00e9part avec l'emploi des commandes g\u00e9n\u00e9rant les logs. Une id\u00e9e serait de chercher \u00e0 obtenir cette granularit\u00e9 via un log par syslog, mais syslog va \u00eatre limit\u00e9 dans les tailles de messages \u00e0 cause du moyen de transport - alors que les stack traces peuvent devenir lourdes...</p>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#au-niveau-de-civiparoisse","title":"Au niveau de Civiparoisse","text":"<p>Au niveau de l'infrastructure Civiparoisse, on constate qu'il y a plusieurs sources de donn\u00e9es de logs :</p> <ul> <li>les logiciels serveurs eux-m\u00eames : Apache, MySQL, Traefik, et PHP (pour le cron).</li> <li>les stacks logicielles : au niveau de Drupal, on retrouve une infrastructure de log o\u00f9 l'on peut plugger des sorties de logs ; au niveau de CiviCRM, on dispose de plusieurs possibilit\u00e9s qui coexistent, comme les logs en BD, et ce dans plusieurs tables (dont celle pr\u00e9vue sp\u00e9cialement pour les logs), mais \u00e9galement les logs vers des fichiers.</li> <li>on pourrait \u00e9ventuellement consid\u00e9rer les donn\u00e9es d'audit (base de log de CiviCRM) comme source, mais cette table renferme intrins\u00e8quement des donn\u00e9es d'utilisateurs, et ne semble pas aussi pertinente pour les logs d'administration utilisables au quotidien - bien qu'ils pourraient se r\u00e9v\u00e9ler tr\u00e8s pr\u00e9cieux pour analyser des modifications de donn\u00e9es.</li> </ul> <p>Il est important \u00e9galement de pouvoir s\u00e9parer les diff\u00e9rentes sources de logs :</p> <ul> <li>les logs de BD (les diff\u00e9rentes instances mysql)</li> <li>les logs HTTP (g\u00e9n\u00e9rateurs possibles : Apache et Traefik)</li> <li>les logs issus de PHP (traitement de requ\u00eates Apache)</li> <li>les logs issus de PHP (traitement des t\u00e2ches cron)</li> </ul> <p>On constate donc que presque chaque pod sera une source de log, et contiendra des \u00e9l\u00e9ments sp\u00e9cifiques (sauf Apache, qui pourra \u00e9galement r\u00e9cup\u00e9rer les logs PHP, du fait de l'utilisation du module PHP de Apache, et non pas de PHP-FPM).</p>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#apache","title":"Apache","text":"<p>La solution la plus simple, et qui est en oeuvre, est de cr\u00e9er des liens : liens de <code>/var/log/apache2/error.log</code> vers <code>/dev/stderr</code> et <code>/var/log/apache2/access.log</code> vers <code>/dev/stdout</code> et <code>/var/log/apache2/other_vhosts_access.log</code>  vers <code>/dev/stdout</code>. Le <code>LogLevel</code> est sur <code>warn</code>, et il n'y a pas de directive <code>BufferedLogs</code>, dont la valeur par d\u00e9faut est off.</p> <p>Le n\u00e9cessaire est donc fait.</p> <p>Une autre approche serait de configurer ErrorLog, TransferLog, et ou GlobalLog vers <code>/dev/stderr</code> ou <code>/dev/stdout</code>.</p>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#mysql","title":"MySQL","text":"<p>MySQL dispose d'une configuration par d\u00e9faut pour les logs d'erreur, qui envoie les logs erreurs et les warnings sur une cible qui sous linux est par d\u00e9faut stderr. Les logs sont document\u00e9s : https://dev.mysql.com/doc/refman/8.0/en/server-logs.html</p> <p>De toute mani\u00e8re, il faut \u00eatre en mesure d'interpr\u00e9ter les messages r\u00e9cup\u00e9r\u00e9s via la configuration par d\u00e9faut, car les erreurs qui peuvent arriver avant la prise en compte des configurations peuvent \u00e9ventuellement \u00eatre loggu\u00e9s via les m\u00e9canismes par d\u00e9faut.</p> <p>Valeurs par d\u00e9faut : <pre><code> log_error                                      | stderr                                      |\n| log_error_services                             | log_filter_internal; log_sink_internal      |\n| log_error_suppression_list                     |                                             |\n| log_error_verbosity                            | 2                                           |\n| log_output                                     | FILE                                        |\n</code></pre></p> <p>MySQL dispose en plus de l'ErrorLog d'autres types de logs :</p> <ul> <li>GeneralQueryLog : peut \u00e0 l'occasion \u00eatre utile</li> <li>BinaryLog : \u00e9ventuellement \u00e0 d\u00e9sactiver</li> <li>RelayLog</li> <li>SlowQueryLog : peut \u00eatre utile</li> <li>DDLLog : g\u00e9r\u00e9 par les m\u00e9canismes internes de MySQL</li> </ul> <p>Eventuels ajustements de configuration :</p> <pre><code>log_error_services='log_filter_internal; log_sink_internal'\nlog_output=FILE\nlog_error=stderr\nlog_error_verbosity=3\nlog_timestamps=UTC\ngeneral_log=0\nlong_query_time=2\nslow_query_log=ON\nslow_query_log_file=/dev/stdout\n</code></pre> <p>argument de ligne de commande : </p> <pre><code>--skip-log-bin\n</code></pre>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#php","title":"PHP","text":"<p>La plupart des valeurs de configuration relatives aux logs sont sp\u00e9cifi\u00e9s dans le php.ini. Le seule param\u00e8tre qui n'est pas indiqu\u00e9 est le param\u00e8tre <code>error_log</code> - dans le cas pr\u00e9sent, ces logs passeront donc par Apache pour sortir.</p> <p>Dans le fichier de prod : </p> <pre><code>error_reporting = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT\ndisplay_errors = Off\ndisplay_startup_errors = Off\nlog_errors = On\nlog_errors_max_len = 1024\nignore_repeated_errors = Off\nignore_repeated_source = Off\nreport_memleaks = On\n</code></pre> <p>Eventuellement, on pourrait changer les valeurs suivantes :</p> <pre><code>log_errors_max_len = 0\nerror_log = /dev/stderr\nerror_reporting = E_ALL\n</code></pre>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#drupal","title":"Drupal","text":"<p>Il existe plusieurs modules pour effectuer une sortie vers stdout ou stderr, dont en particulier le module <code>drupal/log_stdout</code>(https://www.drupal.org/project/log_stdout), que l'on peut configurer pour utiliser \u00e9galement stderr :</p> <pre><code>drush --no-interaction --root /app pm:enable log_stdout\ndrush --no-interaction --root /app config:set -n log_stdout.settings use_stderr 1\n</code></pre>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#civicrm","title":"CiviCRM","text":"<p>CiviCRM permet d'utiliser, pour la grande partie des messages, le loggueur issu du CMS. Du coup, la configuration de Drupal, et l'activation de l'utilisation du logger syst\u00e8me devraient d\u00e9j\u00e0 avoir un impact significatif :</p> <pre><code>cv --cwd=/app setting:set userFrameworkLogging=1\n</code></pre>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#cron-civicrm","title":"Cron CiviCRM","text":"<p>Il existe un certain nombre de logs compl\u00e9mentaires qui sont stock\u00e9s via des objets, dont notamment <code>CRM_Core_Dao_JobLog</code>, <code>CRM_Core_Dao_SystemLog</code>. On pourra utiliser notamment le hook postSave, qui devrait pouvoir \u00eatre utilisable du fait des DAO : https://docs.civicrm.org/dev/en/latest/hooks/hook_civicrm_postSave_table_name/</p>"},{"location":"TECHNIQUE/EXPLOITATION/logs.html#ce-qui-va-reellement-etre-mis-en-place","title":"Ce qui va r\u00e9ellement \u00eatre mis en place","text":"<p>MYSQL : on va rester sur la verbosity 2, les <code>log_error_services</code> par d\u00e9faut, le <code>log_error</code> par d\u00e9faut. En revanche, on va activer <code>long_query_time=2</code> <code>slow_query_log=1</code> et <code>slow_query_log_file=/dev/stdout</code></p> <p>APACHE : on ne fait rien, puisque le n\u00e9cessaire est d\u00e9j\u00e0 fait d'une certaine mani\u00e8re</p> <p>PHP : on ne modifie rien : le <code>error_log</code> est par d\u00e9faut, et le <code>log_errors_max_len</code> ne sert \u00e0 rien en PHP 8.0 et est supprim\u00e9 en PHP 8.1 selon https://www.php.net/manual/en/errorfunc.configuration.php ; en ce qui concerne les erreurs <code>E_DEPRECATED</code> concerne les fonctions qui seront supprim\u00e9es dans les prochaines versions et <code>E_STRICT</code> serait des suggestions de modification de code, selon https://www.php.net/manual/en/errorfunc.constants.php#constant.e-deprecated.</p> <p>DRUPAL : activation de <code>log_stdout</code> avec la configuration pr\u00e9vue</p> <p>CIVICRM : activation du <code>userFrameworkLogging</code></p> <p>CRON Civicrm : dans l'extension, utiliser les postSave pour le JobLog et le SystemLog. En revanche, la documentation https://docs.civicrm.org/dev/en/latest/hooks/hook_civicrm_postSave_table_name/ dit clairement qu'il faut faire attention \u00e0 ne pas d\u00e9clencher une boucle. Du coup, on va faire nous-m\u00eame une sortie directe vers stdout ou stderr :</p> <ul> <li>JobLog : on envoie tout le JobLog sur stdout ; et en plus, si le JobLog comporte le mot clef Failure (v\u00e9rification faite dans https://github.com/civicrm/civicrm-core/blob/8cd192cbbb963444923f1dc0acb5185dc53f1e3e/CRM/Utils/Check/Component/Env.php#L795), on envoie la ligne en plus dans stderr</li> <li>SystemLog : il y a un champ level qui utilise les niveaux PSR3 https://www.php-fig.org/psr/psr-3/. Si on a du notice, du info ou du debug, on l'envoie sur stdout ; sinon, on l'envoie sur stderr.</li> </ul> <p><pre><code>    const EMERGENCY = 'emergency';\n    const ALERT     = 'alert';\n    const CRITICAL  = 'critical';\n    const ERROR     = 'error';\n    const WARNING   = 'warning';\n    const NOTICE    = 'notice';\n    const INFO      = 'info';\n    const DEBUG     = 'debug';\n</code></pre> Ecrire sur stdout et stderr : voir https://www.php.net/manual/en/wrappers.php.php, https://www.php.net/manual/en/reserved.constants.php#constant.stdout, et surtout https://www.php.net/manual/en/features.commandline.io-streams.php ; en gros il faudra faire du fopen, du fwrite, du fflush et du fclose sur du php://stdout ou du php://stderr. On va mettre les \u00e9l\u00e9ments dans des classes avec singleton, et utiliser constructeur et destructeur pour ouvrir et fermer correctement les fichiers. Voir https://www.php.net/manual/fr/language.oop5.decon.php. A noter que l'\u00e9criture sur les flux de php est ce qui a \u00e9t\u00e9 impl\u00e9ment\u00e9 dans le module drupal log_stdout.    </p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/index.html","title":"Int\u00e9gration continue","text":"<p>L'int\u00e9gration est un sujet complexe. Le but de l'int\u00e9gration continue est de v\u00e9rifier si un syst\u00e8me v\u00e9rifie des exigences, et que ces v\u00e9rifications soient effectu\u00e9es de mani\u00e8re automatique. En fonction de la nature du syst\u00e8me impact\u00e9, il peut \u00eatre envisag\u00e9 d'utiliser un ou plusieurs tunnels : on pourrait par exemple vouloir ex\u00e9cuter des tests unitaires si du \"code m\u00e9tier\", \u00e0 dominante fonctionnelle, serait int\u00e9gr\u00e9 dans Civiparoisse. Pour l'heure, il est surtout important de disposer d'un tunnel de test et validation d'une image Civiparoisse avant sa publication, et son \u00e9ventuel d\u00e9ploiement.</p> <p>Les tunnels d'int\u00e9grations sont des \u00e9l\u00e9ments qui sont complexes \u00e0 mettre en oeuvre. Il est n\u00e9cessaire de traiter diff\u00e9rents sujets de mani\u00e8re sp\u00e9cifique :</p> <ul> <li>Docker : build et push</li> <li>Tests automatis\u00e9s : Codeception</li> <li>Tests automatis\u00e9s : Phpunit</li> <li>Composer</li> <li>Trivy</li> <li>SonarLint et SonarQube</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html","title":"Composer et int\u00e9gration continue","text":"<p>Composer permet d'industrialiser une grande partie de la gestion du code de la solution Civiparoisse. L'\u00e9cosyst\u00e8me Composer permet de faciliter la mise \u00e0 jour des packages logiciels de la solution, et permet m\u00eame d'\u00eatre averti de certaines failles de s\u00e9curit\u00e9. Les v\u00e9rifications pourront devenir en fonction des n\u00e9cessit\u00e9s une ou plusieurs \u00e9tapes des tunnels d'int\u00e9gration continue.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#importance-du-fichier-composerjson-et-composerlock","title":"Importance du fichier composer.json et composer.lock","text":"<p>En th\u00e9orie, le fichier composer.lock est une cons\u00e9quence du fichier composer.json, et n'aurait pas besoin d'\u00eatre versionn\u00e9. C'est vrai lorsqu'on a une installation \u00e0 faire, puisque le composer.lock est g\u00e9n\u00e9r\u00e9 \u00e0 ce moment l\u00e0. En revanche, dans le cadre d'une maintenance op\u00e9rationnelle, le composer.lock devient tr\u00e8s important, car il fait parti des \u00e9l\u00e9ments qui pourront \u00eatre utilis\u00e9s dans le cadre du Software Bill Of Materials, et qui pourra \u00eatre utilis\u00e9 par des outils comme Dependabot pour v\u00e9rifier si des packages utilis\u00e9s dans le projet ont des failles de s\u00e9curit\u00e9 (voir https://docs.github.com/en/code-security/dependabot/dependabot-version-updates/configuration-options-for-the-dependabot.yml-file), ou si des mises \u00e0 jour sont disponibles.</p> <p>Il devient donc important de pouvoir g\u00e9n\u00e9rer un fichier de lock, et de le versionner.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#plateforme-dutilisation-de-composer","title":"Plateforme d'utilisation de Composer","text":"<p>Probl\u00e9matique de la plateforme d'utilisation de Composer</p> <p>Etant donn\u00e9 que les packages Composer list\u00e9s d\u00e9pendent \u00e9galement de la plateforme courante d'ex\u00e9cution de Composer (version PHP, extensions PHP charg\u00e9es), il semble n\u00e9cessaire d'ex\u00e9cuter Composer depuis une image qui aura des caract\u00e9ristiques PHP \u00e9quivalentes \u00e0 l'image de production.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#generation-du-fichier-de-lock-uniquement","title":"G\u00e9n\u00e9ration du fichier de lock uniquement","text":"<p>On va utiliser la commande <code>composer validate --check-lock</code> pour v\u00e9rifier la correspondance entre les fichiers composer.json et composer.lock principaux.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#creation-dun-fichier-de-lock","title":"Cr\u00e9ation d'un fichier de lock","text":"<p>On peut utiliser <code>composer update -n --no-install</code> pour g\u00e9n\u00e9rer le fichier de lock.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#synchronisation-entre-composerjson-et-composerlock","title":"Synchronisation entre composer.json et composer.lock","text":"<p>On peut utiliser <code>composer update -n --no-install</code> pour mettre \u00e0 jour le fichier de lock. </p> <p>Param\u00e8tre --lock : risque de d\u00e9synchronisation</p> <p>A noter que l'utilisation du param\u00e8tre <code>--lock</code> mettrait uniquement \u00e0 jour les sommmes de contr\u00f4le sans mettre \u00e0 jour le contenu du fichier lock.</p> <p>Eventuellement, si des plugins sont charg\u00e9s, on peut vouloir ne pas utiliser les plugins, et rajouter l'option <code>--no-plugins</code> si des plugins sont pr\u00e9sents et que l'on ne souhaite pas les charger.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#verification-des-vulnerabilites","title":"V\u00e9rification des vuln\u00e9rabilit\u00e9s","text":"<p>Deux types de v\u00e9rifications sont possibles :</p> <ul> <li>On peut souhaiter vouloir v\u00e9rifier un lock file : <code>composer audit --locked</code> va retourner via le code de retour le nombre de vuln\u00e9rabilit\u00e9s (on esp\u00e8re 0, mais \u00e7a peut monter jusqu'\u00e0 255).</li> <li>On peut aussi vouloir v\u00e9rifier en fonction de ce qui est install\u00e9 : <code>composer audit</code> - mais il faut que les fichiers aient \u00e9t\u00e9 install\u00e9s, sans quoi il n'y a pas de v\u00e9rification effectu\u00e9e.</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#verification-des-mises-a-jour-possibles","title":"V\u00e9rification des mises \u00e0 jour possibles","text":"<p>On peut utiliser <code>composer show -lo</code> pour voir quels packages pourraient b\u00e9n\u00e9ficier de mises \u00e0 jour, et quelle est la derni\u00e8re version qui est disponible. En plus, Composer analyse le niveau de difficult\u00e9 (et donc int\u00e8gre intrins\u00e8quement une partie de la dimension du risque) de la mise \u00e0 jour.</p> <p>On peut travailler en se basant sur le lock file en utilisant <code>composer show -lo --locked</code> ; sans cette option, la commande travaille avec ce qui est install\u00e9. De m\u00eame, on peut souhaiter avoir un code de retour diff\u00e9rent de z\u00e9ro s'il y a des mises \u00e0 jours qui sont propos\u00e9es, gr\u00e2ce \u00e0 l'option <code>--strict</code>.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#verification-des-extensions-de-la-plateforme","title":"V\u00e9rification des extensions de la plateforme","text":"<p>La commande <code>composer check-platform-reqs</code> peut v\u00e9rifier si tous les pr\u00e9requis d'extensions PHP sont pr\u00e9sents dans la plateforme. Par d\u00e9faut, le r\u00e9pertoire vendor est utilis\u00e9 pour recenser les pr\u00e9requis, mais s'il n'est pas pr\u00e9sent ou si l'option <code>--lock</code> est pr\u00e9cis\u00e9e, on utilise les pr\u00e9conisations du fichier composer.lock.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#installation-de-cv-et-drush","title":"Installation de cv et drush","text":"<p>Etant donn\u00e9 qu'on r\u00e9duit le nombre d'images et qu'on ne construit qu'une image Civiparoisse, il devient int\u00e9ressant d'int\u00e9grer cv et drush depuis Composer, puisque cela semble \u00e0 nouveau possible. On peut \u00e9ventuellement envisager d'installer cv et drush dans des lieux diff\u00e9rents, et utiliser des fichiers composer.json et composer.lock suppl\u00e9mentaires, de sorte \u00e0 pouvoir continuer \u00e0 b\u00e9n\u00e9ficier des outils de maintenance int\u00e9gr\u00e9s par Composer.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/composer_ci.html#composer-bump","title":"Composer bump","text":"<p>La commande <code>composer bump</code> permettrait de modifier le composer.json pour que les versions vis\u00e9es par le composer.json sont au minimum \u00e9gales \u00e0 celles install\u00e9es, pour \u00e9viter que des d\u00e9pendances soient downgrad\u00e9es. Il faudrait voir dans le temps si cette commande peut \u00eatre utile.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/docker_build_push.html","title":"Docker : build-push et s\u00e9paration des op\u00e9rations","text":"<p>Dans le contexte d'un tunnel d'int\u00e9gration de Civiparoisse, l'id\u00e9al serait de cr\u00e9er un build \"candidat\", puis de le faire v\u00e9rifier par le tunnel avant de le publier s'il a pass\u00e9 tout le tunnel.</p> <p>Cela suppose donc que les actions de build d'une image et du push vers un repository soient deux op\u00e9rations s\u00e9par\u00e9es et distinctes. Dans le cadre d'un workflow, on peut tr\u00e8s bien builder \u00e0 la main une image, et la pousser \u00e9galement manuellement par la suite (voir https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#pushing-container-images).</p> <p>N\u00e9anmoins, la pratique r\u00e9pandue est d'utiliser des actions Github d\u00e9j\u00e0 existantes, en particulier celles que fournit Docker (https://github.com/docker/build-push-action). On pourrait se dire que le fait qu'on soit oblig\u00e9 de builder l'image lorsqu'on utilise cette action va \u00eatre probl\u00e9matique, car on pousserait un code qui pourrait ne pas \u00eatre le m\u00eame que celui test\u00e9. Toutefois, c'est l\u00e0 que peut intervenir le cache : \u00e0 Dockerfile et fichiers de contexte constants, Docker peut utiliser les layers qui ont d\u00e9j\u00e0 \u00e9t\u00e9 compil\u00e9s pour pr\u00e9parer une nouvelle image. Ceci signifie aussi que si on recompile une image, la compilation va \u00eatre tr\u00e8s rapide, puisque les caches pourront \u00eatre r\u00e9utilis\u00e9s. La pr\u00e9sence du cache n'est pas une garantie formelle que les layers seront r\u00e9utilis\u00e9s, mais pr\u00e9sente une probabilit\u00e9 que l'on peut juger suffisante dans le cadre du projet Civiparoisse pour admettre qu'il y a de fortes chances que les layers seront r\u00e9utilis\u00e9s et que ce sera donc effectivement du code qui a valid\u00e9 le tunnel d'int\u00e9gration qui va \u00eatre pouss\u00e9 vers le registre d'images \u00e0 la fin du traitement (voir https://docs.docker.com/build/guide/layers/, https://docs.docker.com/build/cache/, et la pratique des labels en d\u00e9but de Dockerfile, pour induire une petite modification qui va forcer \u00e0 rebuilder la stack \u00e0 partir de l'instruction LABEL).</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html","title":"Qualit\u00e9 de code : SonarLint et SonarQube","text":""},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html#contexte-general","title":"Contexte g\u00e9n\u00e9ral","text":"<p>La qualit\u00e9 de code est un \u00e9l\u00e9ment fondamental pour la maintenance d'un code. Cette qualit\u00e9 de code se traduit souvent par le respect de r\u00e8gles. La premi\u00e8re r\u00e8gle \u00e0 respecter \u00e9tant d'ailleurs le respect de la syntaxe et de la grammaire du langage de programmation utilis\u00e9, puis \u00e9galement les mani\u00e8res de programmer pr\u00e9vues (programmation imp\u00e9rative, fonctionnelle, orient\u00e9e objet...).</p> <p>Les r\u00e8gles sont aussi connues dans une certaine mesure comme des bests practices, qui sont par ailleurs souvent impl\u00e9ment\u00e9es dans des frameworks - comme par exemple Symfony, comme utilis\u00e9 dans Drupal et CiviCRM. Les frameworks permettent de r\u00e9utiliser une base de code \u00e9prouv\u00e9e et de limiter le code sp\u00e9cifique \u00e0 une application, ce qui limite donc la maintenance du code sp\u00e9cifique.</p> <p>Un code est souvent l'oeuvre de plusieurs d\u00e9veloppeurs : les d\u00e9veloppeurs doivent donc garder une certaine coh\u00e9rence au travers de l'ensemble du code, ce qui aboutit \u00e0 des conventions utilis\u00e9es sur un projet, qui peuvent avoir trait \u00e0 des r\u00e8gles de nommages de classes, de m\u00e9thodes, \u00e0 la largeur que doit faire une tabulation, \u00e0 l'utilisation ou non de tabulation. De ce fait, la convention doit \u00eatre connue et partag\u00e9e par les d\u00e9veloppeurs.</p> <p>On en arrive donc \u00e0 des outils qui vont chercher \u00e0 impl\u00e9menter des mod\u00e8les de r\u00e8gles, ainsi que des v\u00e9rifications si le code respecte lesdites r\u00e8gles, ou si le code pr\u00e9sente des probl\u00e8mes. Au niveau de PHP, il existe un certain nombre d'outils comme par exemple <code>php_cs</code>, <code>php_md</code>, pour ne citer qu'eux. </p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html#sonarlint","title":"SonarLint","text":"<p>Au niveau du d\u00e9veloppement de Civiparoisse, un autre outil est particuli\u00e8rement appr\u00e9ciable : il s'agit de SonarLint.</p> <p>SonarLint est plut\u00f4t \u00e0 consid\u00e9rer comme un ensemble d'outils multilangages qui peuvent s'int\u00e9grer dans un certain nombre d'IDE, ce qui fait qu'on ne force pas un d\u00e9veloppeur \u00e0 utiliser un IDE en particulier. De plus, SonarLint int\u00e8gre d\u00e9j\u00e0 un certain nombre de r\u00e8gles (dont certaines ont d'ailleurs d\u00e9j\u00e0 permis de trouver des bugs dans le code de l'extension Civiparoisse !). Avec l'int\u00e9gration \u00e0 l'IDE, on cherche donc d\u00e8s la conception du code \u00e0 \u00e9viter un certain nombre d'\u00e9cueils, et donc on cherche \u00e0 \u00e9viter de la dette technique. Certaines impl\u00e9mentations de SonarLint (puisque ce sont des plugins d'IDE) sont sous licence LGPL-3.0, donc Open Source.</p> <p>SonarLint est particuli\u00e8rement appr\u00e9ciable \u00e9galement en raison de la qualit\u00e9 des explications qui sont fournies au niveau des r\u00e8gles : ces explications sont une plus-value importante, car elles pourront parfaire la formation des d\u00e9veloppeurs.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html#sonarqube-et-sonarscanner","title":"SonarQube et SonarScanner","text":"<p>SonarLint est encore plus appr\u00e9ciable si on utilise conjointement SonarQube : alors qu'on cherche avec SonarLint \u00e0 \u00e9viter des probl\u00e8mes sur chaque fichier en particulier, avec des r\u00e8gles configur\u00e9es pour son IDE, SonarQube peut centraliser les r\u00e8gles \u00e0 appliquer sur un projet (on notera que ce partage est fait dans d'autres outils via des fichiers dans le d\u00e9p\u00f4t git).</p> <p>L'int\u00e9r\u00eat principal de SonarQube (dont certaines versions sont \u00e9galement Open Source) est qu'il va r\u00e9cup\u00e9rer les r\u00e9sultats d'analyse de code qui sont effectu\u00e9s par un autre outil : sonar-scanner, qui dispose \u00e9galement de certaines versions Open Source. Les r\u00e9sultats du scanner vont \u00eatre remont\u00e9s et exploit\u00e9s via l'interface de SonarQube. SonarQube peut remonter les probl\u00e8mes de chaque fichier, mais peut \u00e9galement remonter des probl\u00e8mes plus globaux, comme des duplications de blocs de codes, et dispose d'une interface qui semble ergonomique et efficace.</p> <p>Avec les analyses successives, on peut \u00e9galement suivre la qualit\u00e9 du d\u00e9veloppement. Il est \u00e9galement possible d'int\u00e9grer ce suivi dans certains tunnels d'int\u00e9gration continue, de sorte \u00e0 \u00e9viter de publier un code qui n'est pas satisfaisant aux normes d\u00e9finies pour le projet.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html#sonarcloud","title":"SonarCloud","text":"<p>SonarCloud est un produit payant sous forme de Software As A Service.  On peut donc le voir dans un certain point de vue comme un SonarQube manag\u00e9. Le mod\u00e8le de licence courant d\u00e9pend du nombre de lignes de codes analys\u00e9es ; pour l'heure, Civiparoisse ne d\u00e9passe pas les 100 000 lignes (plut\u00f4t moins de 15 000 lignes selon une ex\u00e9cution <code>phploc</code> avec les param\u00e8tres par d\u00e9faut), et serait donc factur\u00e9 (selon le mod\u00e8le de licensing courant - voir https://www.sonarsource.com/plans-and-pricing/#sonarcloud) dans la plage de prix la plus basse.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/sonarqube_ci.html#en-conclusion","title":"En conclusion","text":"<p>L'usage qui a d\u00e9j\u00e0 \u00e9t\u00e9 fait des versions Open Source gratuites de SonarLint et SonarQube a montr\u00e9 un grand potentiel dans l'utilisation de ces outils, et pr\u00e9sentent un int\u00e9r\u00eat certain pour le projet. L'adoption de SonarCloud sera \u00e0 \u00e9tudier sp\u00e9cifiquement, \u00e9galement en fonction de la place que l'on veut faire (ou non) \u00e0 l'outil dans les tunnels d'int\u00e9gration du projet Civiparoisse - d'autant plus que des co\u00fbts suppl\u00e9mentaires pourraient s'ajouter (ex : minutes de workflow github).</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html","title":"Tests d'acceptation automatis\u00e9s : Codeception","text":"<p>Les tests logiciels automatis\u00e9s sont un domaine important du g\u00e9nie logiciel. Les tests permettent de v\u00e9rifier que des modifications de code ou d'environnement n'entra\u00eenent pas des r\u00e9gressions, et facilitent donc la maintenance op\u00e9rationnelle des logiciels.</p> <p>Au niveau de Civiparoisse, on constate qu'il n'y a que peu de code sp\u00e9cifique, et que ce code sp\u00e9cifique est plut\u00f4t destin\u00e9 \u00e0 du param\u00e9trage qu'\u00e0 de l'impl\u00e9mentation de fonctionnalit\u00e9s. De ce fait, les tests les plus utiles sont les tests d'acceptation automatis\u00e9s, qui vont v\u00e9rifier de bout en bout le bon fonctionnement du logiciel. De plus, ces tests de bout en bout peuvent contribuer \u00e0 la documentation du projet, puisqu'ils impl\u00e9mentent des sc\u00e9narios reproduisant des utilisations r\u00e9elles.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#introduction-a-codeception","title":"Introduction \u00e0 Codeception","text":"<p>L'outil utilis\u00e9 pour r\u00e9aliser ces tests est Codeception. Codeception est \u00e9crit en PHP, et propose une mani\u00e8re d'\u00e9crire des tests de mani\u00e8re tr\u00e8s intuitive au niveau des tests d'acceptation, en utilisant des classes \"Acteurs\" regroupant toutes les actions disponibles. Il est installable via Composer et propose une architecture modulaire, en fonction des besoins des projets.</p> <p>Parall\u00e8lement aux modules, on retrouve \u00e9galement un autre type d'\u00e9l\u00e9ments de code qui a \u00e9t\u00e9 personalis\u00e9 : il s'agit des extensions de Codeception. Les extensions ont plut\u00f4t un r\u00f4le support par rapport aux modules : ils peuvent par exemple personnaliser la mani\u00e8re dont les logs sont effectu\u00e9s, ils peuvent enregistrer des screenshots... Une extension d\u00e9rivant de l'extension Recorder a d'ailleurs \u00e9t\u00e9 pr\u00e9par\u00e9e de sorte \u00e0 pouvoir commenter des \u00e9tapes de test, de sorte \u00e0 am\u00e9liorer l'aspect \"documentation utilisateur\" des tests.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#principe-des-tests","title":"Principe des tests","text":"<p>Le principe des tests qui vont \u00eatre r\u00e9alis\u00e9s va \u00eatre le suivant :</p> <ul> <li> <p>Codeception va dialoguer via le protocole WebDriver avec un Driver de Navigateur (chromedriver pour chrome ou chromium, geckodriver pour firefox, pour ce citer qu'eux) ; ce dialogue est un dialogue HTTP en clair, qu'il peut \u00eatre utile \u00e0 l'occasion de capturer via des outils r\u00e9seaux tels que tcpdump ou wireshark, car ils peuvent fournir par moment des indications pr\u00e9cieuses sur des cas d'erreurs.</p> </li> <li> <p>Le driver va lancer le navigateur et s'interfacer avec lui.</p> </li> <li> <p>Le navigateur va tenter d'effectuer les actions qu'on lui demande : naviguer sur le site et effectuer des interactions sp\u00e9cifiques.</p> </li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#configuration-initiale","title":"Configuration initiale","text":"<p>Codeception utilise un fichier de configuration principal, au format yaml : codeception.yml. La mise en place de la configuration de Codeception a d\u00e9but\u00e9e par la cr\u00e9ation du mod\u00e8le via <code>codecept init acceptance</code>. Il devient ensuite simple de faire \u00e9voluer la configuration gr\u00e2ce \u00e0 la documentation.</p> <p>La configuration initiale est :</p> Codeception.yaml initial (cliquer pour d\u00e9plier) <pre><code># suite config\nsuites:\n    acceptance:\n        actor: AcceptanceTester\n        path: .\n        modules:\n            enabled:\n                - WebDriver:\n                    url: http://localhost\n                    browser: chrome\n                - \\Helper\\Acceptance\n\n        # add Codeception\\Step\\Retry trait to AcceptanceTester to enable retries\n        step_decorators:\n            - Codeception\\Step\\ConditionalAssertion\n            - Codeception\\Step\\TryTo\n            - Codeception\\Step\\Retry\n\nextensions:\n    enabled: [Codeception\\Extension\\RunFailed]\n\nparams: \n    - env\n\ngherkin: []    \n\n# additional paths\npaths:\n    tests: tests\n    output: tests/_output\n    data: tests/_data\n    support: tests/_support\n    envs: tests/_envs\n\nsettings:\n    shuffle: false\n    lint: true\n</code></pre> <p>Au niveau des fichiers g\u00e9n\u00e9r\u00e9s, on retrouve :</p> <pre><code>./tests/LoginCest.php\n./tests/_data/.gitkeep\n./tests/_output/.gitkeep\n./tests/_support/Helper/Acceptance.php\n./tests/_support/AcceptanceTester.php\n./tests/_support/_generated/AcceptanceTesterActions.php\n./codeception.yml\n</code></pre> <p>Le fichier LoginCest.php est un exemple de fichier de test g\u00e9n\u00e9r\u00e9 initialement :</p> <pre><code>&lt;?php\nclass LoginCest \n{    \n    public function _before(AcceptanceTester $I)\n    {\n        $I-&gt;amOnPage('/');\n    }\n\n    public function loginSuccessfully(AcceptanceTester $I)\n    {\n        // write a positive login test \n    }\n\n    public function loginWithInvalidPassword(AcceptanceTester $I)\n    {\n        // write a negative login test\n    }       \n}\n</code></pre> <p>La classe AcceptanceTester.php est g\u00e9n\u00e9r\u00e9e et int\u00e8gre le trait AcceptanceTesterActions, qui est g\u00e9n\u00e9r\u00e9 pour ajouter les m\u00e9thodes publiques int\u00e9gr\u00e9s dans le module Acceptance (fichier <code>tests/_support/Helper/Acceptance.php</code>).</p> <p>Il est possible de reconstruire l'AcceptanceTester de mani\u00e8re manuelle (<code>codecept build</code>) ; l'AcceptanceTester est de toute mani\u00e8re reconstruit avant l'ex\u00e9cution des tests : c'est gr\u00e2ce \u00e0 ce m\u00e9canisme que l'AcceptanceTester tient \u00e9galement compte des actions situ\u00e9es dans les modules actifs de Codeception.</p> <p>Le module Acceptance permet d'impl\u00e9menter des routines qui peuvent \u00eatre utilis\u00e9es un peu partout dans les tests, comme par exemple, le login, le logout, ou dans le cas plus sp\u00e9cifique de CiviCRM, l'acc\u00e8s \u00e0 une fiche contact via son nom tri\u00e9 (<code>sort_name</code>).</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#configuration-projet","title":"Configuration projet","text":"<p>La configuration utilis\u00e9e pour les tests automatis\u00e9s est pr\u00e9sent\u00e9e en-dessous :</p> Codeception.yml projet  (cliquer pour d\u00e9plier) <pre><code># suite config\nsuites:\n    acceptance:\n        actor: AcceptanceTester\n        path: .\n        extensions:\n            enabled:\n                - Uepal\\Documentor\\Documentor:                 \n                    delete_successful: false\n                    delete_orphaned: true\n                - Codeception\\Extension\\Logger:\n                    max_files: 1\n        modules:\n            enabled:\n                - Db:\n                    dsn: 'mysql:host=127.0.0.1;dbname=%cividbdatabase%'\n                    user: '%cividbusername%'\n                    password: '%cividbpassword%'         \n                    initial_queries :\n                      - \"SET time_zone='%tz%'\"\n                - Asserts:\n                - WebDriver:\n                    url: '%weburl%'\n                    browser: 'chrome'\n                    window_size: '1920x1080'                    \n                    path: ''\n                    port: 9515\n                    host: '127.0.0.1'\n                    capabilities:\n                        unhandledPromptBehavior: \"accept\"\n                        acceptInsecureCerts: true\n                        chromeOptions:\n                            args: [\"--headless\", \"--disable-gpu\"]\n                            prefs:\n                              download.default_directory: \"./tests/_output\"\n                    wait: 60\n                - \\Helper\\Acceptance:\n                    adminusername: '%adminusername%'\n                    adminpassword: '%adminpassword%'\n                    gestionnaireusername: '%gestionnaireusername%'\n                    gestionnairepassword: '%gestionnairepassword%'\n                    utilisateurparoissialusername: '%utilisateurparoissialusername%'\n                    utilisateurparoissialpassword: '%utilisateurparoissialpassword%'\n                    sleeptime: 10\n\n\n        # add Codeception\\Step\\Retry trait to AcceptanceTester to enable retries\n        step_decorators:\n            - Codeception\\Step\\ConditionalAssertion\n            - Codeception\\Step\\TryTo\n            - Codeception\\Step\\Retry\n\nextensions:\n    enabled: [Codeception\\Extension\\RunFailed]\n\nparams: \n    - env\n    - codecept_config/params.yml\n    - codecept_config/db_params.yml\n    - codecept_config/tz.yml\ngherkin: []    \n\n# additional paths\npaths:\n    tests: tests\n    output: tests/_output\n    data: tests/_data\n    support: tests/_support\n    envs: tests/_envs\n\nsettings:\n    shuffle: false\n    lint: true\n</code></pre> <p>Il m\u00e9rite quelques commentaires :</p> <ul> <li>Les modules utilis\u00e9s sont le module WebDriver (communication avec le navigateur), le module Db (communication avec mysql) et Assert (pour des tests de logiques, comme du AssertTrue).</li> <li>L'extension Documentor est une extension pr\u00e9par\u00e9e pour le projet, qui h\u00e9rite de l'extension Codeception\\Extension\\Recorder et permet l'utilisation des actions de commentaire (comme <code>amGoingTo</code>) pour ajouter des commentaires dans les slides g\u00e9n\u00e9r\u00e9es.</li> <li>L'extension Codeception\\Extension\\Logger permet de g\u00e9n\u00e9rer un fichier de log avec des entr\u00e9es dat\u00e9es, ce qui est tr\u00e8s utile pour v\u00e9rifier comment se sont d\u00e9roul\u00e9s les tests, et combien de temps ont pris chaque test ; l'extension s'int\u00e8gre correctement dans les fichiers de Codeception gr\u00e2ce \u00e0 l'utilisation de Composer.</li> <li>Les param\u00e8tres de configuration des modules et des extensions sont situ\u00e9s dans la hi\u00e9rarchie mentionnant leur nom.</li> <li>La configuration de la base de donn\u00e9es a n\u00e9cessit\u00e9 de rajouter l'indication du fuseau horaire : cette indication permet surtout de s'adapter \u00e0 un poste utilisateur (par exemple sur le fuseau Europe/Paris) et un syst\u00e8me configur\u00e9 en UTC, lorsqu'on utilise des v\u00e9rifications horaires (par exemple quand on cherche un mail dans la base de donn\u00e9es).</li> <li>le navigateur utilis\u00e9 est chromium ou chrome. Il est utilis\u00e9 en mode headless, c'est \u00e0 dire que l'on n'utilise pas d'affichage \u00e0 proprement parler, comme on pourrait le faire via Xvfb, et \u00e9ventuellement un gestionnaire de fen\u00eatres. Du coup, il convient d'indiquer la r\u00e9solution souhait\u00e9e. Cette r\u00e9solution sera non pas la r\u00e9solution de la fen\u00eatre d'affichage, mais la r\u00e9solution du viewport. Les tailles d'affichages peuvent par exemple jouer sur les r\u00e9sultats de certains tests en particulier en cas de superpositions d'\u00e9l\u00e9ments graphiques. Le fait d'utiliser le mode headless permet de fixer un comportement, et d'\u00e9viter des diff\u00e9rences de comportement dans le temps.</li> <li>Des capacit\u00e9s particuli\u00e8res ont \u00e9t\u00e9 demand\u00e9es au navigateur : certaines sont explicites, comme le mode headless (et la d\u00e9sactivation de l'utilisation du gpu), ou la personnalisation du r\u00e9pertoire de destination des fichiers t\u00e9l\u00e9charg\u00e9, ou l'acceptation de certificats non reconnus comme s\u00fbrs (tr\u00e8s utile pour les certificats autosign\u00e9s). En revanche, la capacit\u00e9 unhandledPromptBehavior voir (https://www.w3.org/TR/webdriver1/#dfn-user-prompt-handler) est n\u00e9cessaire car les navigateurs r\u00e9cents \u00e9mettent de temps \u00e0 autre des demandes de confirmation, tel que le r\u00e9envoi d'un formulaire ou la sortie d'une page o\u00f9 on a renseign\u00e9 des informations.</li> <li>Etant donn\u00e9 que la plupart des sc\u00e9narios de tests n\u00e9cessitent qu'un utilisateur soit loggu\u00e9, il faut \u00e9galement pr\u00e9voir les informations de login dans la configuration.</li> <li>Le fichier permet l'utilisation de variables not\u00e9s entre des symboles pourcents, et les variables sont remplac\u00e9es par les \u00e9l\u00e9ments indiqu\u00e9s dans la section params (ici, on consultera d'abord, l'environnement de l'ex\u00e9cution de Codeception, puis les fichiers mentionn\u00e9s). Le remplacement est effectu\u00e9 assez t\u00f4t dans le traitement de la configuration, ce qui fait qu'il est possible de mettre des param\u00e8tres dans un grand nombre d'endroits.</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#ecriture-des-tests","title":"Ecriture des tests","text":"<p>L'\u00e9criture des tests suit une logique assez simple :</p> <ul> <li>On commence tout d'abord par d\u00e9finir un sc\u00e9nario utilisateur complet que l'on veut int\u00e9grer dans un test.</li> <li>On identifie les d\u00e9pendances sur des donn\u00e9es que le test va avoir : ces d\u00e9pendances de donn\u00e9es peuvent \u00eatre soit int\u00e9gr\u00e9es dans la base de donn\u00e9es, lors de la pr\u00e9paration initiale pour les tests (\u00e9tablissement d'une Golden Database), soit int\u00e9gr\u00e9es \u00e0 la vol\u00e9e, \u00e0 l'occasion de l'ex\u00e9cution du sc\u00e9nario (comme la mise en place de fixtures lors d'un test unitaire).</li> <li>En \u00e9crivant le test, on va le d\u00e9rouler en m\u00eame temps manuellement dans un navigateur : l'utilisation des outils de d\u00e9veloppements permettra d'identifier des s\u00e9lecteurs pour d\u00e9signer les \u00e9l\u00e9ments avec lesquels interagir. Les s\u00e9lecteurs sont g\u00e9n\u00e9ralement des s\u00e9lecteurs css, des s\u00e9lecteurs xpath, ou des noms d'\u00e9l\u00e9ments de formulaires.</li> <li>On va chercher \u00e0 ex\u00e9cuter un test uniquement via l'utilisation des groupes de tests : on peut par exemple rajouter une annotation de groupe de type <code>@group nom_de_groupe</code> dans le docblock situ\u00e9 au-dessus d'une fonction de test. De la sorte, on pourra pr\u00e9ciser \u00e0 Codeception le nom du groupe de tests \u00e0 ex\u00e9cuter, et on pourra ainsi d\u00e9bugger le test que l'on est en train d'\u00e9crire.</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#retour-dexperience-sur-lecriture-des-tests","title":"Retour d'exp\u00e9rience sur l'\u00e9criture des tests","text":"<p>En pratique, il y a quelques difficult\u00e9s qui apparaissent :</p> <ul> <li>Le sc\u00e9nario utilisateur doit \u00eatre suffisamment clair, pr\u00e9cis et explicite (d\u00e9taill\u00e9) pour pouvoir permettre son impl\u00e9mentation.</li> <li>Il est rare de r\u00e9ussir \u00e0 \u00e9crire un test correctement du premier coup : plusieurs ex\u00e9cutions successives du sc\u00e9nario sont souvent n\u00e9cessaires jusqu'\u00e0 arriver \u00e0 un sc\u00e9nario enti\u00e8rement fonctionnel. Toutefois, il est ennuyeux et peu efficace de devoir resetter l'environnement de donn\u00e9es \u00e0 chaque ex\u00e9cution lors de l'\u00e9criture du code. Ainsi, on cherchera \u00e0 \u00e9crire des tests r\u00e9p\u00e9tables : les donn\u00e9es qui sont normalement laiss\u00e9es \"non alt\u00e9r\u00e9s\" \u00e0 l'issue des tests, ou qui sont uniquement utilis\u00e9es en lecture par des donn\u00e9es de tests, peuvent \u00eatre int\u00e9gr\u00e9es dans une approche GoldenDatabase. Les autres donn\u00e9es, en revanche, chercheront \u00e0 \u00eatre uniques. Le nom d'un individu cr\u00e9e lors d'un test pourra par exemple \u00eatre constitu\u00e9 d'un pr\u00e9fixe identifiant le test et la personne dans le test, et d'un suffixe qui est un estampillage horaire. Ceci en fait une valeur unique par ex\u00e9cution, et simplifie \u00e9galement l'acc\u00e8s aux \u00e9l\u00e9ments gr\u00e2ce au ciblage pr\u00e9cis permis par les valeurs uniques - sans compter que les estimpillages horaires sont croissants. Cela facilite donc les v\u00e9rifications d'un d\u00e9veloppeur lors de v\u00e9rification sucessives au cours de l'\u00e9criture du test.</li> <li>La difficult\u00e9 principale est d'\u00e9crire de bons s\u00e9lecteurs. La plupart des s\u00e9lecteurs sont g\u00e9n\u00e9ralement simples \u00e0 \u00e9crire, en utilisant un id ou une classe CSS. Les difficult\u00e9s commencent lorsqu'on doit travailler sur des \u00e9l\u00e9ments avec des interfaces complexes, dont certains \u00e9l\u00e9ments sont g\u00e9n\u00e9r\u00e9s \u00e0 la vol\u00e9e (explorateur API, searchKit pour ne citer qu'eux).<ul> <li>Un autre type de difficult\u00e9 arrive lorsqu'on cherche \u00e0 v\u00e9rifier plusieurs conditions simultan\u00e9ment : dans ce genre de cas, le XPath est g\u00e9n\u00e9ralement assez souple et permet d'exprimer les conditions par rapport aux noeuds du document, au prix parfois d'une certaine lourdeur d'\u00e9criture. Il y a parfois m\u00eame lieu de faire des v\u00e9rifications d'une mani\u00e8re diff\u00e9rente, lorsqu'on cherche \u00e0 v\u00e9rifier qu'il n'y a pas un \u00e9l\u00e9ment : on peut faire ex\u00e9cuter du code javascript pour r\u00e9cup\u00e9rer un nombre d'\u00e9l\u00e9ments correspondant \u00e0 une condition, et v\u00e9rifier que ce nombre vaut z\u00e9ro.</li> </ul> </li> <li>Lorsqu'on a \u00e9crit un s\u00e9lecteur, on va vouloir le tester, ou, si l'on se trouve face \u00e0 du code difficilement compr\u00e9hensible, on va pouvoir chercher \u00e0 retrouver les \u00e9l\u00e9ments vis\u00e9s par un s\u00e9lecteur. A ce moment, la console javascript du navigateur est particuli\u00e8rement utile : on peut utiliser `jQuery('mon s\u00e9lecteur CSS'), $x('mon s\u00e9lecteur xpath'), et si ce dernier ne marche pas, utiliser document.evaluate (voir par exemple https://developer.mozilla.org/en-US/docs/Web/API/Document/evaluate). De la sorte, il arrive fr\u00e9quemment que si l'on survole ou clique sur un \u00e9l\u00e9ment de r\u00e9sultat, il appara\u00eet en surbrillance dans le rendu HTML \u00e0 l'\u00e9cran. Cette technique pourrait d'ailleurs m\u00eame participer \u00e0 l'utilisation des tests comme documentation.</li> <li>Les widgets sp\u00e9cifiques : si Codeception est particuli\u00e8rement bien pourvu pour travailler avec des \u00e9l\u00e9ments HTML classiques, il y a cependant lieu de noter que des sch\u00e9mas types d'interaction avec certains \u00e9l\u00e9ments, comme les s\u00e9lecteurs de date ou les autocompl\u00e9tions, reviennent assez r\u00e9guli\u00e8rement. Lorsqu'on rencontre un widget, il est donc int\u00e9ressant de chercher dans le code existant s'il n'a pas d\u00e9j\u00e0 \u00e9t\u00e9 rencontr\u00e9, afin de se simplifier le travail d'interaction. Il pourrait \u00e9ventuellement \u00eatre envisag\u00e9 de cr\u00e9er des fonctions g\u00e9n\u00e9riques pour manipuler les widgets. Mais il semblerait toutefois que des variantes existent, et dont il faudrait \u00e9galement tenir compte : il n'est donc pas \u00e9vident qu'une telle librairie serait vraiment opportune.</li> <li>Les commentaires : il ne faut pas h\u00e9siter \u00e0 commenter quasiment chaque ligne d'action, pour indiquer clairement l'intention li\u00e9e \u00e0 l'action. En effet, si une action ou une v\u00e9rification ne s'effectue plus correctement, il n'est pas \u00e9vident qu'un s\u00e9lecteur soit suffisamment explicite pour comprendre l'intention du d\u00e9veloppeur li\u00e9e \u00e0 l'action. Le fait de commenter le code permet donc non seulement d'aiguiller l'utilisateur, mais \u00e9galement le d\u00e9veloppeur lorsqu'il devra remanier un test qui ne fonctionne plus.</li> <li>Les tests r\u00e9alis\u00e9s peuvent \u00eatre longs et complexes \u00e0 \u00e9crire. Il peut tr\u00e8s bien s'av\u00e9rer \u00eatre n\u00e9cessaire de mettre en oeuvre des \u00e9l\u00e9ments de g\u00e9nie logiciel (fonctions prot\u00e9g\u00e9es par exemple, pour du code qui est r\u00e9utilis\u00e9 plusieurs fois au sein d'une classe de test, ou mise \u00e0 disposition de code via le module helper Acceptance). On en d\u00e9duit donc que l'\u00e9criture de tests constitue de l'\u00e9criture de code logiciel qui doit chercher \u00e0 respecter les bonnes pratiques et usages des technologies mises en oeuvres.</li> <li>Il a des temporisations qui sont li\u00e9es au temps de traitement des requ\u00eates, d'o\u00f9 la mise en place de temps d'attente (la fonction sleepForDisplay qui utilise la fonction wait). A l'inverse, il faut \u00e9galement configurer CiviCRM pour ne pas supprimer automatiquement les notifications de l'\u00e9cran apr\u00e8s un certain d\u00e9lai : ces suppressions cumul\u00e9es aux temps d'attentes risqueraient de mettre en \u00e9chec un bon nombre d'assertions qui visent les messages de notification.</li> <li>Une autre difficult\u00e9 est l'\u00e9criture dans certains \u00e9l\u00e9ments. Il arrive que l'on doive cibler des \u00e9l\u00e9ments qui sont marqu\u00e9s comme \u00e9ditables et qui ne sont pas des \u00e9l\u00e9ments de formulaire. A ce moment, on utilise des fonctions comme <code>type</code>. On peut \u00e9galement \u00eatre tent\u00e9 d'utiliser du javascript pour positionner un contenu. N\u00e9anmoins, le fait de passer par le javascript peut ne pas d\u00e9clencher un certain nombre d'\u00e9v\u00e8nements qui se d\u00e9clencheraient en utilisation \"traditionnelle\" par un utilisateur humain de la page. Ce genre d'approche doit donc \u00eatre \u00e9vit\u00e9e dans la mesure du possible.</li> <li>Il y a \u00e9galement parfois des interactions avec des t\u00e2ches CRON. La solution la plus simple trouv\u00e9e pour le moment est de se loguer en administrateur dans CiviCRM, et d\u00e9clencher un appel aux t\u00e2ches CRON via l'API JS. En attendant un temps suffisant, on peut ensuite chercher \u00e0 v\u00e9rifier si la t\u00e2che a \u00e9t\u00e9 ex\u00e9cut\u00e9e.</li> <li>El\u00e9ments situ\u00e9s dans un iframe : il faut indiquer quand il faut consid\u00e9rer un iframe \u00e0 codeception, et revenir ensuite \u00e0 la frame principale.</li> <li>El\u00e9ments ouverts dans un autre onglet : il faut penser \u00e0 utiliser les fonctions associ\u00e9es (switch to next tab, close tab).</li> <li>V\u00e9rification du r\u00e9sultat d'un code ex\u00e9cut\u00e9 en JS : la m\u00e9thode la plus simple de v\u00e9rifier le retour a \u00e9t\u00e9 d'\u00e9crire directement du contenu dans la page HTML, des essais avec des notifications JS du type window.alert n'ayant pas donn\u00e9 les r\u00e9sultats escompt\u00e9s lors de l'\u00e9criture du code.</li> <li>V\u00e9rification des mails : CiviCRM propose de stocker les mails qui devraient \u00eatre envoy\u00e9s en temps normal dans une table. Cette mani\u00e8re de faire permet d'\u00e9viter de d\u00e9ployer un environnement plus cons\u00e9quent, et plus difficile \u00e0 exploiter depuis Codeception. On peut effectuer des v\u00e9rifications sur la base de donn\u00e9es depuis Codeception. En se notant avant l'ex\u00e9cution d'un test l'estampillage horaire, il devient possible de d\u00e9duire quels sont les mails stock\u00e9s qui ont \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9s lors du test courant (en tenant compte comme d\u00e9crit plus haut du fuseau horaire), et d'effectuer des v\u00e9rifications dans les destinataires, les sujets, et les contenus.</li> <li>Survol d'\u00e9l\u00e9ments : il y a eu des difficult\u00e9s pour le survol des \u00e9l\u00e9ments de menu avec les fonctions comme moveMouseOver. Le contournement a \u00e9t\u00e9 de cliquer sur un \u00e9l\u00e9ment de menu, mais sans cliquer sur le lien \u00e9ventuellement associ\u00e9, donc ne pas mettre une indication de lien <code>a</code> dans les s\u00e9lecteurs.</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#objectifs-des-tests-automatises-dans-le-cadre-de-civiparoisse","title":"Objectifs des tests automatis\u00e9s dans le cadre de Civiparoisse","text":"<p>L'int\u00e9gration continue consiste \u00e0 d\u00e9clencher, en r\u00e9ponse \u00e0 certains \u00e9v\u00e8nements, une s\u00e9rie d'actions visant \u00e0 v\u00e9rifier si le code est de qualit\u00e9. On peut trouver lors de ces actions des tests de tout type. Ils sont effectu\u00e9s pour d\u00e9tecter au plus t\u00f4t des \u00e9ventuelles imperfections dans du code livr\u00e9 : il s'agit donc de garde-fous tr\u00e8s utiles. L'int\u00e9gration continue devient m\u00eame essentielle si l'on souhaite faire du d\u00e9ploiement continu, c'est \u00e0 dire mettre automatiquement du code d\u00e8s qu'il est disponible - l'id\u00e9e \u00e9tant que des petits changements fr\u00e9quemment mis en production vont produire, lorsque mis en production, des probl\u00e8mes plus r\u00e9duits et \u00e9ventuellement plus faciles \u00e0 r\u00e9soudre qu'un changement radical et massif dans le code.</p> <p>Au niveau de Civiparoisse, ces tests vont servir non seulement \u00e0 \u00e9viter d'\u00e9ventuelles r\u00e9gressions dues aux d\u00e9veloppements, mais on va \u00e9galement utiliser le lancement des tests pour v\u00e9rifier qu'un certain niveau de fonctionnalit\u00e9 minimum est atteint par un build particulier avant d'\u00eatre \u00e9ventuellement mis en production. Cela est d'ailleurs particuli\u00e8rement critique dans le cadre de Civiparoisse, lorsqu'il s'agit de d\u00e9ployer des builds avec des corrections de vuln\u00e9rabilit\u00e9s logicielles, o\u00f9 il faut \u00eatre assez r\u00e9actif.</p> <p>Comme Civiparoisse est h\u00e9berg\u00e9 sur Github pour les d\u00e9veloppements, et que le projet ne dispose pas d'une infrastructure informatique internalis\u00e9e \u00e0 l'UEPAL, il semble judicieux d'utiliser Github, au travers des workflows Github, pour impl\u00e9menter les tests automatis\u00e9s - un certain niveau de consommations de ressources \u00e9tant d'ailleurs int\u00e9gr\u00e9 dans certaines offres Github.</p> <p>Une autre contrainte de l'int\u00e9gration continue est qu'elle puisse \u00eatre utilisable par un d\u00e9veloppeur pour v\u00e9rifier si son travail n'a pas pos\u00e9 de probl\u00e8me. Sans oublier que les tests sont des composants logiciels que les d\u00e9veloppeurs doivent \u00e9galement maintenir.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#reflexions-resultant-des-objectifs","title":"R\u00e9flexions r\u00e9sultant des objectifs","text":"<p>Etant donn\u00e9 qu'il va s'agir de tester l'int\u00e9gration des \u00e9l\u00e9ments, l'\u00e9l\u00e9ment que l'on va chercher \u00e0 tester va \u00eatre un build de l'image Civiparoisse, ce qui veut dire qu'il faut utiliser une infrastructure qui utilise la containeraisation, et plut\u00f4t sous Linux, pour rester dans le m\u00eame domaine de comp\u00e9tences que l'image Civiparoisse.</p> <p>Ceci est effectivement pr\u00e9vu au niveau de Github : Github pr\u00e9voit d'ex\u00e9cuter chaque job d'un workflow dans un runner, qui peut \u00eatre soit fourni par un tiers (typiquement un self-hosted runner, qu'il faut alors maintenir soi-m\u00eame, ce qui serait difficile dans le cadre de Civiparoisse), ou alors fourni par Github. Dans le cadre du runner fourni par Github, il est possible d'avoir plusieurs choix de distribution de base, dont en particulier Ubuntu 22.04. Cependant, Github propose une machine virtuelle d\u00e9j\u00e0 pr\u00e9par\u00e9e dans une certaine mesure pour le d\u00e9veloppement, selon https://github.com/actions/runner-images/blob/main/images/linux/Ubuntu2204-Readme.md, dont en particulier :</p> <ul> <li>docker, docker-compose</li> <li>minikube, helm, kubectl</li> <li>chrome, chromium et chromedriver</li> <li>xvfb</li> <li>firefox et geckodriver</li> <li>composer, php 8, mysql, apache2</li> </ul> <p>Etant donn\u00e9 qu'il s'agit de disposer rapidement d'un environnement simplement atteignable par un d\u00e9veloppeur, il semble plus simple d'utiliser une infrastructure limit\u00e9e au minimum en utilisant docker-compose. Bien entendu, cela signifie aussi que le fonctionnement test\u00e9 ne sera pas exactement celui qui sera utilis\u00e9 en production. On utilisera directement le serveur web Apache embarqu\u00e9 dans Civiparoisse sans passer par un proxy Traefik. Il serait en fait possible de rajouter Traefik dans le docker-compose, mais \u00e9tant donn\u00e9 qu'il ne s'agirait quand m\u00eame pas d'une installation semblable \u00e0 celle en production (les moyens de configurations mis en oeuvre sont diff\u00e9rents, par exemple), cela semble \u00eatre peu opportun de s'emb\u00eater \u00e0 installer le reverse proxy.</p> <p>Il a \u00e9t\u00e9 pr\u00e9f\u00e9r\u00e9 de ne pas utiliser le mysql embarqu\u00e9 dans la VM, car il semble plus simple aussi du point de vue de mise en oeuvre pour un d\u00e9veloppeur de laisser faire le travail par un container. L'image mysql est rapidement t\u00e9l\u00e9charg\u00e9e et d\u00e9marr\u00e9e, et on profite au passage des m\u00e9canismes d'initialisation pr\u00e9vus dans l'image.</p> <p>En revanche, installer dans un container un navigateur et un driver peut devenir compliqu\u00e9 (d'exp\u00e9rience), avec des images qui deviennent lourdes, et l\u00e0 on dispose des \u00e9l\u00e9ments pr\u00e9install\u00e9s dans l'h\u00f4te. De la m\u00eame mani\u00e8re, un d\u00e9veloppeur qui travaille sur sa machine pourra modifier la configuration de codeception pour faire afficher le navigateur, ou m\u00eame utiliser le navigateur de son choix. On utilisera donc le navigateur et le driver pr\u00e9install\u00e9s. En plus, comme php et Composer sont install\u00e9s, et qu'on voit dans les sources du runner github qu'il y a les extensions php n\u00e9cessaires qui sont install\u00e9es d'office (https://github.com/actions/runner-images/blob/main/images/linux/scripts/installers/php.sh), on pourra d\u00e9ployer le code de test (et codeception) de deux mani\u00e8res diff\u00e9rentes :</p> <ul> <li>soit par composer</li> <li>soit par les actions github</li> </ul> <p>Le fait de passer par Composer pour la r\u00e9cup\u00e9ration et l'installation du code de test a un autre avantage assez important : il permet de d\u00e9coupler le code de test du tunnel d'int\u00e9gration, et permet de lier via les tags l'\u00e9volution du code de build de l'image civiparoisse et l'\u00e9volution des tests. Par ailleurs, cette liaison r\u00e8gle \u00e9galement un probl\u00e8me d'acc\u00e8s aux donn\u00e9es de diff\u00e9rents d\u00e9p\u00f4ts au niveau du runner Github, puisqu'on peut publier le code de test comme on le fait pour les autres packages composer pour builder Civiparoisse. A vrai dire, pendant la phase de conception du tunnel, avant publication du package des tests, un d\u00e9p\u00f4t tagg\u00e9 contenu dans un fichier tar.gz a \u00e9t\u00e9 embarqu\u00e9 dans une branche, le d\u00e9p\u00f4t est d\u00e9compress\u00e9 dans le tunnel, puis ce d\u00e9p\u00f4t local, qui est d\u00e9clar\u00e9 dans le composer.json, est utilis\u00e9 pour installer le code de test dans l'environnement.</p> <p>Le fichier de test de workflow github r\u00e9sume ce test:</p> Fichier de test de workflow (cliquer pour d\u00e9plier) <pre><code>name: Int\u00e9gration Continue\n\non:\n  workflow_dispatch:\nenv:\n  INTERNALTAG: uepal_test/civiparoisseci:citest\n  WEBNAME : civiparoisseci.test\n  TESTRELPATH: tests/WORK/vendor/uepal/fr.uepalparoisse.ci \n\ndefaults:\n  run:\n    shell: bash\n\njobs:\n  citunnel:\n   runs-on: ubuntu-22.04\n   steps:\n   - name: Checkout repository\n     uses: actions/checkout@v3\n   - name: build Image for local use\n     run: |\n       cd ${GITHUB_WORKSPACE} &amp;&amp; docker build -t ${INTERNALTAG} .\n   - name: Pull mysql\n     run: |\n       docker pull mysql\n   - name: Prepare uncompress embedded git repo for tests\n     run: |\n       cd ${GITHUB_WORKSPACE}/tests &amp;&amp; tar -xvzf REF.tar.gz\n   - name: Prepare codeception\n     run: |\n       cd ${GITHUB_WORKSPACE}/tests/WORK &amp;&amp; composer upgrade\n   - name: Run db service\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose up -d db &amp;&amp; bash isupdb.sh\n   - name: install civiparoisse\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose up php_initialize\n   - name: update civiparoisse\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose up php_update\n   - name: inject test data\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose up php_configure\n   - name: launch webserver\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose up -d php_webserver\n   - name: launch chromedriver\n     run: |\n       chromedriver&amp;\n   - name: inject name resolution into hosts\n     run: |       \n       echo \"127.0.0.1 ${WEBNAME}\" | sudo tee -a /etc/hosts\n   - name: run tests (and write down a failure)\n     run: |\n        (cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; ${GITHUB_WORKSPACE}/tests/WORK/vendor/bin/codecept run -g ci -vvv --steps) || (echo \"TEST FAILURE OCCURED\" &gt;${RUNNER_TEMP}/error.txt)\n   - uses: actions/upload-artifact@v3\n     with:\n       name: test-result-ci-${{ github.run_number }}-${{ github.run_attempt }}\n       path: ${{ github.workspace }}/${{ env.TESTRELPATH }}/tests\n       retention-days: 2\n   - name: stop containers\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; docker-compose down -v\n   - name: kill chromedriver\n     run: |\n       pkill chromedriver\n   - name: \"last task - exit with non zero code if error\"\n     run: |\n       cd ${GITHUB_WORKSPACE}/${TESTRELPATH} &amp;&amp; bash exitcode.sh\n</code></pre> <p>L'utilisation d'une action github est un autre moyen, qui est au bout du compte tout aussi simple \u00e0 mettre en oeuvre, voire m\u00eame plus simple : github permet de r\u00e9cup\u00e9rer d'acc\u00e9der au contenu des actions d'un autre d\u00e9p\u00f4t priv\u00e9 si ledit d\u00e9p\u00f4t autorise les acc\u00e8s pour les actions (cela se configure dans les param\u00e8tres du d\u00e9p\u00f4t, dans l'interface web de github). Github se chargera de lui-m\u00eame de r\u00e9cup\u00e9rer le code du d\u00e9p\u00f4t, et l'action pourra \u00eatre r\u00e9utilis\u00e9e dans diff\u00e9rents workflows, et permettra de r\u00e9duire la quantit\u00e9 globale de code des workflows.</p> <p>L'action en question est une action de type composite, qui mime en un certain nombre de points les \u00e9l\u00e9ments disponibles dans un workflow. Dans une action, le code du repository de l'action est disponible lors de l'ex\u00e9cution de l'action dans le r\u00e9pertoire appel\u00e9 par <code>${{ github.action_path }}</code>. Le fait que ce soit une action permet de l'int\u00e9grer dans un job en tant que step, ce qui veut dire que l'on pourra b\u00e9n\u00e9ficier des effets des \u00e9tapes pr\u00e9c\u00e9dentes du job, puisqu'elles sont ex\u00e9cut\u00e9es sur le m\u00eame runner.</p> <p>On en arrive \u00e0 un ficher action.yml tel que suit :</p> Action.yml (cliquer pour d\u00e9plier) <pre><code>name: 'Tests codeception'\ndescription: 'Ex\u00e9cution des tests automatis\u00e9s'\ninputs:\n  sutimage:\n    description: 'System Under Test Image (must already be available) - works with Linux runner'\n    required: true\n    default: 'uepal_test/civiparoisseci:citest'\nruns:\n  using: \"composite\"\n  steps:\n    - name: Pull mysql\n      if: runner.os == 'Linux'      \n      run: |\n        docker pull mysql\n      shell: bash\n    - name: Prepare codeception\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }} &amp;&amp; composer upgrade\n      shell: bash\n    - name: Run db service\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }} &amp;&amp; docker-compose up -d db &amp;&amp; bash isupdb.sh\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: install civiparoisse\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }}  &amp;&amp; docker-compose up php_initialize\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: update civiparoisse\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }}  &amp;&amp; docker-compose up php_update\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: inject test data\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }}  &amp;&amp; docker-compose up php_configure\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: launch webserver\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }}  &amp;&amp; docker-compose up -d php_webserver\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: launch chromedriver\n      if: runner.os == 'Linux'      \n      run: |\n        chromedriver&amp;\n      shell: bash\n    - name: inject name resolution into hosts\n      if: runner.os == 'Linux'      \n      run: |       \n        echo \"127.0.0.1 ${WEBNAME}\" | sudo tee -a /etc/hosts\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: run tests (and write down a failure)\n      if: runner.os == 'Linux'      \n      run: |\n         (cd ${{ github.action_path }} &amp;&amp; vendor/bin/codecept run -g ci -vvv --steps) || (echo \"TEST FAILURE OCCURED\" &gt;${RUNNER_TEMP}/error.txt)\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n        RUNNER_TEMP: ${{ runner.temp }}\n    - uses: actions/upload-artifact@v3\n      if: runner.os == 'Linux'      \n      with:\n        name: test-result-ci-${{ github.run_number }}-${{ github.run_attempt }}\n        path: ${{ github.action_path }}/tests\n        retention-days: 2\n    - name: stop containers\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }} &amp;&amp; docker-compose down -v\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n    - name: kill chromedriver\n      if: runner.os == 'Linux'      \n      run: |\n        pkill chromedriver\n      shell: bash\n    - name: \"last task - exit with non zero code if error\"\n      if: runner.os == 'Linux'      \n      run: |\n        cd ${{ github.action_path }} &amp;&amp; bash exitcode.sh\n      shell: bash\n      env: \n        SUTIMAGE: ${{ inputs.sutimage }}\n        WEBNAME: civiparoisseci.test\n        RUNNER_TEMP: ${{ runner.temp }}\n</code></pre> <p>Un exemple de workflow d'utilisation est en-dessous. Il y a plusieurs mani\u00e8res de sp\u00e9cifier le commit de r\u00e9f\u00e9rence qui contient l'action : on peut utiliser les tags, ou une r\u00e9f\u00e9rence directe de commit (sachant que le tag peut pointer dans le temps vers un autre commit, ce qui ne peut pas se produire si on indique directement le commit que l'on souhaite).</p> Exemple d'int\u00e9gration sous forme d'action (cliquer pour d\u00e9plier) <pre><code>name: Int\u00e9gration Continue Avec Action\n\non:\n  workflow_dispatch:\nenv:\n  INTERNALTAG: uepal_test/civiparoisseci:citest\n\ndefaults:\n  run:\n    shell: bash\n\njobs:\n  citunnelaction:\n   runs-on: ubuntu-22.04\n   steps:\n   - name: Checkout repository\n     uses: actions/checkout@v3\n   - name: build Image for local use\n     run: |\n       cd ${GITHUB_WORKSPACE} &amp;&amp; docker build -t ${INTERNALTAG} .\n   - name: execute tests\n     uses: UEPAL-CiviParoisse/integration_continue@11c25005a4d144eab0d9cfae094d0f859c2c92e5\n     with:\n       sutimage: ${{ env.INTERNALTAG }}\n</code></pre> <p>Une autre probl\u00e9matique se pose \u00e9galement : la question de l'utilisation du mode avec affichage ou sans affichage (headless). L'affichage se ferait dans Xvfb, et la question se pose effectivement dans certains cas, car certains navigateurs n'auraient, au moins historiquement, pas utilis\u00e9 le m\u00eame code de rendu en headless qu'en mode normal. Toutefois, cela ajouterait un peu de complexit\u00e9 sans en voir l'int\u00e9r\u00eat imm\u00e9diatement. Cependant, il faut se souvenir de cette possibilit\u00e9, pour qu'on puisse passer en affichage Xvfb en cas de besoin.</p>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_automatises.html#resume-de-la-solution-retenue","title":"R\u00e9sum\u00e9 de la solution retenue","text":"<p>Pour r\u00e9sumer la solution obtenue :</p> <ul> <li>Tester les images fraichement build\u00e9es de Civiparoisse.</li> <li>Utiliser l'infrastructure docker install\u00e9e sur le runner maintenu par Github pour d\u00e9ployer localement une instance civiparoisse.</li> <li>Utiliser une action github pour faire la liaison avec le code de test.</li> <li>Utiliser un php, composer, browserdriver et un browser install\u00e9s sur le runner pour interagir avec codeception et l'installation locale civiparoisse.</li> </ul> <p>Le d\u00e9p\u00f4t d\u00e9di\u00e9 aux tests va contenir les fichiers n\u00e9cessaires pour l'infrastructure de test :</p> <ul> <li>le docker-compose.yaml et les fichiers supports attenants mont\u00e9s via des volumes (ex : clefs, certificats, et fichiers de secrets \"par d\u00e9faut\", qui vont \u00eatre utilis\u00e9s pour le test en local).</li> <li>les tests proprement dits.</li> <li>la d\u00e9claration de d\u00e9pendance sur codeception.</li> <li>l'extension pour la documentation.</li> </ul>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/tests_phpunit.html","title":"Tests automatis\u00e9s : Phpunit","text":"<p>Les tests r\u00e9alis\u00e9 avec Phpunit sont des tests qui sont de plus bas niveaux que ceux r\u00e9alis\u00e9s avec Codeception : il s'agit pour le moment de tests unitaires qui sont pr\u00e9vus pour tester le bon fonctionnement d'un morceau de code (fonction / m\u00e9thode d'une classe habituellement).</p> <p>Les tests pr\u00e9sents pour le moment dans l'extension Civiparoisse ont \u00e9t\u00e9 r\u00e9alis\u00e9s dans un but pr\u00e9cis : il s'agissait essentiellement de disposer d'un garde-fou pour se pr\u00e9munir d'\u00e9ventuelles r\u00e9gressions lors du refactoring de code sur la partie import - mapping depuis S\u00e9raphin.</p> <p>Pour le moment, l'ex\u00e9cution de ces tests utilise uniquement le boot de niveau ClassLoader de CiviCRM. De ce fait, une base de donn\u00e9es n'est pas encore requise. N\u00e9anmoins, pour pouvoir les ex\u00e9cuter, il est n\u00e9cessaire que les classes de CiviCRM soient disponibles. On ne peut ex\u00e9cuter ces tests que depuis un syst\u00e8me qui contient l'ensemble des fichiers.</p> <p>Cette contrainte a pouss\u00e9 a la cr\u00e9ation d'une action github sp\u00e9cifique, qui utilise en particulier un script shell pour installer les fichiers depuis Composer, puis de cr\u00e9er un civicrm.settings.php factice, sans base de donn\u00e9es, avant de lancer les tests proprement dits. L'id\u00e9e est de brancher l'action dans un workflow de l'extension, et de profiter que le d\u00e9p\u00f4t est clon\u00e9 en local et checkout\u00e9 dans la branche d\u00e9sir\u00e9e pour pouvoir cr\u00e9er une branche git d\u00e9riv\u00e9e \u00e9quivalente, et de lancer les tests depuis cette branche.</p> <pre><code>name: 'Tests phpunit'\ndescription: 'Ex\u00e9cution des tests unitaires automatis\u00e9s'\nruns:\n  using: \"composite\"\n  steps:\n    - name: Checkout repository\n      uses: actions/checkout@v3\n    - name: Launch test script\n      if: runner.os == 'Linux'\n      run: |\n        cd ${{github.action_path }} &amp;&amp; bash action.sh\n      shell: bash\n      env:\n        GITSRC: ${{ github.workspace }}\n        WORKDIR: ${{ runner.temp }}\n</code></pre> <p>Le coeur de cette action composite est le script shell <code>action.sh</code>, script qui va profiter de certains \u00e9l\u00e9ments pr\u00e9sents dans le runner Ubuntu de Github (en particulier git, composer et phpunit). Etant donn\u00e9 que l'affichage est loggu\u00e9 par Github, on peut en premier lieu se contenter de ces \u00e9l\u00e9ments, ainsi que du code de retour de phpunit, pour \u00e9tudier les \u00e9ventuelles erreurs rencontr\u00e9es. Ce script n\u00e9cessite de passer deux r\u00e9pertoires en variables d'environnement :</p> <ul> <li>GITSRC : le lieu o\u00f9 le code git a \u00e9t\u00e9 checkout\u00e9</li> <li>WORKDIR : un r\u00e9pertoire de travail o\u00f9 le script va pr\u00e9parer la structure des fichiers, avant d'ex\u00e9cuter les tests.</li> </ul> <pre><code>#!/bin/bash\nset +xev\n#script pour faire les tests unitaires \n#sur l'extension civiparoisse\n\n# variables d'environnement\n# GITSRC : le chemin du d\u00e9pot CIVIPAROISSE en local, d\u00e9j\u00e0 checkout\u00e9\n# WORKDIR : le chemin du r\u00e9pertoire dans lequel on va bosser\nexport GITBRANCH=unittest #le nom de branche que l'on va mettre sur le clone du d\u00e9p\u00f4t\nexport COMPOSERVERSION=dev-unittest #la version correspondante au GITTAG dans la nomenclature composer\nexport GITWORKDIR=${WORKDIR}/GIT #le r\u00e9pertoire du clone git\nexport COMPOSERWORKDIR=${WORKDIR}/COMPOSER #le r\u00e9pertoire de travail de composer\nexport CIVICRM_SETTINGS=${COMPOSERWORKDIR}/web/sites/default/civicrm.settings.php #le fichier de settings\nexport PATH=${COMPOSERWORKDIR}/vendor/bin:${PATH} #on modifie le path pour ajouter le r\u00e9pertoire bin\nexport TESTPATH=${COMPOSERWORKDIR}/ext/fr.uepalparoisse.civiparoisse\n\n#on copie le d\u00e9p\u00f4t git (d\u00e9j\u00e0 checkout\u00e9)\ncp -R ${GITSRC} ${GITWORKDIR}\n# on cr\u00e9e une branche dans ce d\u00e9p\u00f4t copi\u00e9 avec le nom\ngit -C ${GITWORKDIR} checkout -b ${GITBRANCH}\n#on cr\u00e9e le r\u00e9pertoire de travail de composer\ninstall -d ${COMPOSERWORKDIR}\n# on \u00e9crit le composer.json qui va bien\ncat &gt;${COMPOSERWORKDIR}/composer.json &lt;&lt;EOF\n{\n\"config\": {\n    \"allow-plugins\": true,\n    \"store-auths\": false\n  },\n\"repositories\": [\n {\n      \"type\": \"git\",\n      \"url\":\"${GITWORKDIR}\"\n    }\n],\n\"extra\": {\n    \"installer-paths\": {\n      \"web/core\": [\n        \"type:drupal-core\"\n      ],\n      \"web/libraries/{$name}\": [\n        \"type:drupal-library\"\n      ],\n      \"web/modules/contrib/{$name}\": [\n        \"type:drupal-module\"\n      ],\n      \"web/profiles/contrib/{$name}\": [\n        \"type:drupal-profile\"\n      ],\n      \"web/themes/contrib/{$name}\": [\n        \"type:drupal-theme\"\n      ],\n      \"drush/Commands/contrib/{$name}\": [\n        \"type:drupal-drush\"\n      ],\n      \"web/modules/custom/{$name}\": [\n        \"type:drupal-custom-module\"\n      ],\n      \"web/profiles/custom/{$name}\": [\n        \"type:drupal-custom-profile\"\n      ],\n      \"web/themes/custom/{$name}\": [\n        \"type:drupal-custom-theme\"\n      ]\n    },\n    \"drupal-scaffold\": {\n      \"locations\": {\n        \"web-root\": \"web/\"\n      },\n      \"allowed-packages\": [\n        \"drupal/recommended-project\"\n      ]\n    },\n    \"compile-mode\": \"all\",\n    \"compile-passthru\": \"always\",\n    \"enable-patching\": true,\n    \"compile-whitelist\": [\n      \"civicrm/civicrm-core\",\n      \"civicrm/composer-compile-lib\"\n    ]\n},\n\"require\": {\n    \"drupal/recommended-project\": \"9.5.10\",\n    \"drupal/core-recommended\": \"9.5.10\",\n    \"drupal/core-project-message\": \"9.5.10\",\n    \"drupal/core-composer-scaffold\": \"9.5.10\",\n    \"cweagans/composer-patches\": \"~1.7.3\",\n    \"civicrm/civicrm-core\": \"5.65.0\",\n    \"civicrm/civicrm-packages\": \"5.65.0\",\n    \"civicrm/civicrm-drupal-8\": \"5.65.0\",\n    \"civicrm/civicrm-asset-plugin\": \"1.1.3\",\n    \"civicrm/composer-downloads-plugin\": \"3.0.1\",\n    \"civicrm/composer-compile-plugin\": \"0.20\",\n    \"uepal/fr.uepalparoisse.civiparoisse\":\"${COMPOSERVERSION}\",\n    \"civicrm/cv\":\"*\",\n    \"phpunit/phpunit\":\"*\"\n   },\n  \"minimum-stability\": \"dev\",\n  \"prefer-stable\": true\n}\nEOF\n#on d\u00e9clenche l'installation via composer\ncomposer --no-interaction -d ${COMPOSERWORKDIR} install -vvv\n#on cr\u00e9e un fichier de settings\ncat &gt;${CIVICRM_SETTINGS} &lt;&lt;EOF\n&lt;?php\n\ndefine('CIVICRM_MAIL_SMARTY',1);\nglobal \\$civicrm_root, \\$civicrm_setting, \\$civicrm_paths;\ndefine('CIVICRM_UF', 'Drupal8');\n\\$civicrm_paths['civicrm.files']['url'] = 'https://civiparoisseci.test//sites/default/files/civicrm';\n\\$civicrm_paths['civicrm.files']['path'] = \"${COMPOSERWORKDIR}/web/sites/default/files/civicrm\";\n\\$civicrm_paths['civicrm.private']['path'] = \"${COMPOSERWORKDIR}/private\";\n\\$civicrm_setting['domain']['extensionsDir'] = \"${COMPOSERWORKDIR}/ext\";\n\\$civicrm_setting['domain']['extensionsURL'] = 'https://civiparoisseci.test//libraries/civicrm';\n\\$civicrm_root = \"${COMPOSERWORKDIR}/vendor/civicrm/civicrm-core/\";\nif (!defined('CIVICRM_TEMPLATE_COMPILEDIR')) {\n  define( 'CIVICRM_TEMPLATE_COMPILEDIR', \"${COMPOSERWORKDIR}/web/sites/default/files/civicrm/templates_c\");\n}\nif (!defined('CIVICRM_UF_BASEURL')) {\n  define( 'CIVICRM_UF_BASEURL'      , 'https://civiparoisseci.test');\n}\n\nif (!defined('CIVICRM_DOMAIN_ID')) {\n  define( 'CIVICRM_DOMAIN_ID', 1);\n}\ndefine('CIVICRM_DEADLOCK_RETRIES', 3);\nif (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN' &amp;&amp; !defined('CIVICRM_EXCLUDE_DIRS_PATTERN')) {\n  define('CIVICRM_EXCLUDE_DIRS_PATTERN', '@/(\\.|node_modules|js/|css/|bower_components|packages/|sites/default/files/private)@');\n}\n\\$include_path = '.'           . PATH_SEPARATOR .\n                \\$civicrm_root . PATH_SEPARATOR .\n                \\$civicrm_root . DIRECTORY_SEPARATOR . 'packages' . PATH_SEPARATOR .\n                get_include_path( );\nif ( set_include_path( \\$include_path ) === false ) {\n   echo \"Could not set the include path&lt;p&gt;\";\n   exit( );\n}\n\nif (!defined('CIVICRM_CLEANURL')) {\n  if (function_exists('variable_get') &amp;&amp; variable_get('clean_url', '0') != '0') {\n    define('CIVICRM_CLEANURL', 1 );\n  }\n  elseif ( function_exists('config_get') &amp;&amp; config_get('system.core', 'clean_url') != 0) {\n    define('CIVICRM_CLEANURL', 1 );\n  }\n  elseif( function_exists('get_option') &amp;&amp; get_option('permalink_structure') != '' ) {\n    define('CIVICRM_CLEANURL', 1 );\n  }\n  else {\n    define('CIVICRM_CLEANURL', 0);\n  }\n}\nif (version_compare(PHP_VERSION, '8.1') &lt; 0) {\n  ini_set('auto_detect_line_endings', '1');\n}\n\n// make sure the memory_limit is at least 64 MB\n\\$memLimitString = trim(ini_get('memory_limit'));\n\\$memLimitUnit   = strtolower(substr(\\$memLimitString, -1));\n\\$memLimit       = (int) \\$memLimitString;\nswitch (\\$memLimitUnit) {\n    case 'g': \\$memLimit *= 1024;\n    case 'm': \\$memLimit *= 1024;\n    case 'k': \\$memLimit *= 1024;\n}\nif (\\$memLimit &gt;= 0 and \\$memLimit &lt; 134217728) {\n    ini_set('memory_limit', '128M');\n}\n\nrequire_once 'CRM/Core/ClassLoader.php';\nCRM_Core_ClassLoader::singleton()-&gt;register();\n\nEOF\n# et on lance les tests\nphpunit -c ${TESTPATH}/phpunit.xml --include-path ${TESTPATH}\n</code></pre>"},{"location":"TECHNIQUE/INTEGRATION_CONTINUE/trivy_ci.html","title":"Trivy","text":"<p>Trivy est un scanner de vuln\u00e9rabilit\u00e9s open-source (https://github.com/aquasecurity/trivy et pour la documentation : https://aquasecurity.github.io/trivy/v0.44/). L'utilisation de ce genre d'outil est essentiel, car il permet notamment de garder un oeil sur le panel de vuln\u00e9rabilit\u00e9s d'un syst\u00e8me, et il permet de d\u00e9finir un Software Bill Of Materials (SBOM), et de chercher les vuln\u00e9rabilit\u00e9s par rapport au SBOM.</p> <p>Trivy dispose de plusieurs modes de recherches de vuln\u00e9rabilit\u00e9s, dont le mode fs, le mode repo (git repository) et le mode image (pour les images de containers). Il faut remarquer que les mani\u00e8res de rechercher les vuln\u00e9rabilit\u00e9s diff\u00e8rent en fonction du mode. Il est donc int\u00e9ressant d'utiliser plusieurs moyens en parall\u00e8le pour avoir une vision plus compl\u00e8te des d\u00e9pendances d'un projet.</p> <p>De plus, Trivy dispose d\u00e9j\u00e0 d'une action Github disponible (https://aquasecurity.github.io/trivy/v0.44/tutorials/integrations/github-actions/ et https://github.com/aquasecurity/trivy-action/blob/master/action.yaml) - et cette action semble assez souple pour s'adapter \u00e0 un grand nombre de sc\u00e9narios. Il y aurait m\u00eame moyen d'int\u00e9grer le SBOM dans Github via une action Github (https://github.com/marketplace/actions/spdx-dependency-submission-action), ce qui permettrait \u00e9galement de profiter de la surveillance des d\u00e9pendances au moyen de Dependabot.</p> <p>Au niveau de Civiparoisse, on peut donc envisager plusieurs points o\u00f9 l'on va mettre Trivy en oeuvre :</p> <ul> <li>avant le tunnel : lors de la cr\u00e9ation d'une release, lorsqu'on a pr\u00e9par\u00e9 le composer.json et le composer.lock, g\u00e9n\u00e9rer deux SBOM.</li> <li>durant le tunnel d'int\u00e9gration : analyser l'image qui est forg\u00e9e dans le tunnel.</li> <li>durant le tunnel d'int\u00e9gration : g\u00e9n\u00e9rer un SBOM qui va \u00eatre ajout\u00e9 \u00e0 un endroit sp\u00e9cifique, afin de pouvoir ex\u00e9cuter des analyses de vuln\u00e9rabilit\u00e9s en se basant sur le SBOM.</li> <li>lors du workflow cron : analyser les vuln\u00e9rabilit\u00e9s via les SBOM g\u00e9r\u00e9s.</li> </ul> <p>L'utilisation de trivy est en ligne de commande, et est tr\u00e8s simple lorsqu'il est install\u00e9 directement sur une machine.</p>"},{"location":"TECHNIQUE/LOGICIEL/index.html","title":"Aspects logiciels","text":""},{"location":"TECHNIQUE/LOGICIEL/index.html#developpements-specifiques","title":"D\u00e9veloppements sp\u00e9cifiques","text":"<p>Les besoins fonctionnels seront trait\u00e9s via des d\u00e9veloppements sp\u00e9cifiques s\u2019appuyant sur CiviCRM, qui est un CRM \u00e9crit en PHP n\u00e9cessitant un CMS et une stack LAMP. Le CMS Drupal a \u00e9t\u00e9 choisi \u00e0 cet effet. </p> <p>Les d\u00e9veloppements sp\u00e9cifiques sont r\u00e9partis \u00e0 ce jour en trois modules :</p> <ul> <li> <p>un module Civicrm : ce module int\u00e8gre les adaptations de CiviCRM n\u00e9cessaires pour les fonctions \u00ab coeur de m\u00e9tier \u00bb.</p> </li> <li> <p>un module plugin d'installation pour Civicrm : ce module int\u00e8gre certains aspects d'installation initiale de CiviCRM qui ne sont pas ou difficilement pr\u00e9vus pour la ligne de commande.</p> </li> <li> <p>le code des tests automatis\u00e9s : les tests automatis\u00e9s sont bas\u00e9s sur codeception, et sont d\u00e9ploy\u00e9s via une stack technique en parall\u00e8le de CiviCRM.</p> </li> </ul> <p>A noter qu'historiquement, il existait \u00e9galement un module Drupal qui remplissait un besoin technique (permettre l\u2019utilisation de l\u2019authentification de type basic).</p> <p>Chaque module est versionn\u00e9 dans git, et constitue un package composer. Le choix d\u2019utiliser composer n\u2019est pas anodin : il est utilis\u00e9 \u00e0 la fois par CiviCRM et Drupal, ce qui uniformise dans une certaine mesure la gestion des fichiers source du projet.</p> <p>Il a \u00e9t\u00e9 d\u00e9cid\u00e9 de suivre la gestion git \u00ab gitflow \u00bb (https://www.atlassian.com/fr/git/tutorials/comparing-workflows/gitflow-workflow ). Le suivi des d\u00e9veloppements se fait via les outils mis \u00e0 disposition sur Github (dont notamment les issues).</p>"},{"location":"TECHNIQUE/LOGICIEL/index.html#qualite-du-code","title":"Qualit\u00e9 du code","text":"<p>Le code sp\u00e9cifique est pour l\u2019heure globalement stabilis\u00e9. N\u00e9anmoins, il devra \u00eatre envisag\u00e9 de mettre en place des tests automatis\u00e9s pour fiabiliser les d\u00e9veloppements, voire m\u00eame de faire de l\u2019int\u00e9gration continue.</p>"},{"location":"TECHNIQUE/LOGICIEL/index.html#distribution-du-code-specifique","title":"Distribution du code sp\u00e9cifique","text":"<p>Le code a pour vocation d\u2019\u00eatre sous licence \u00ab logiciel libre \u00bb (licence exacte \u00e0 d\u00e9finir). De ce fait, il conviendra de publier le code source dans un d\u00e9p\u00f4t git \u00ab public \u00bb. Toutefois, mettre \u00e0 disposition le code n\u2019implique pas de mettre \u00e0 disposition le d\u00e9tail des interactions des intervenants (ni leur identit\u00e9). De ce fait, il est pr\u00e9vu que la publication sur le d\u00e9p\u00f4t git public se fasse \u00e0 travers un fetch remote de profondeur 1 et un checkout en orphan release de FETCH_HEAD, de sorte \u00e0 conserver uniquement le code, et pas l\u2019historique. Cette mani\u00e8re de proc\u00e9der permettra toutefois les comparaisons d\u2019une version \u00e0 l\u2019autre, ainsi que la mise en place des tags qui sont n\u00e9cessaires pour identifier les versions.</p>"},{"location":"TECHNIQUE/LOGICIEL/index.html#utilisation-de-modules-tiers","title":"Utilisation de modules tiers","text":"<p>D\u2019autres modules / extensions peuvent \u00e9galement \u00eatre n\u00e9cessaires au projet : il s\u2019agira de les int\u00e9grer, dans la mesure du possible, comme des packages composer. Au pire des cas, on pourra utiliser un repository de type \u00ab package \u00bb dans composer (cf https://getcomposer.org/doc/05-repositories.md#package-2 ).</p>"},{"location":"TECHNIQUE/LOGICIEL/index.html#documents","title":"Documents","text":"<p>Cette section r\u00e9pertoire les documentations relatives au d\u00e9veloppement logiciel de Civiparoisse.</p> <ul> <li>Distribution du code</li> <li>Environnement de dev</li> <li>Customisation environnement de dev</li> <li>Importation des donn\u00e9es</li> </ul>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html","title":"Distribution du code de Civiparoisse","text":"<p>La distribution du code de Civiparoisse est un point crucial de l\u2019industrialisation de l\u2019installation des instances CiviCRM. On a d\u00e9j\u00e0 vu que Composer procurait une facilit\u00e9 d\u2019installation et de mise \u00e0 jour des instances de Drupal et du coeur de CiviCRM. Il est donc int\u00e9ressant de capitaliser sur Composer. Pour ce faire, il \u00e9tait tout d\u2019abord n\u00e9cessaire d\u2019unifier les modules civiparoisse existants en un seul, de le pr\u00e9parer pour devenir un package, puis g\u00e9n\u00e9rer les packages, et enfin les utiliser.</p>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html#unification-des-extensions-civiparoisse","title":"Unification des extensions Civiparoisse","text":"<p>L\u2019unification des extensions Civiparoisse s\u2019est impos\u00e9e pour plusieurs raisons :</p> <ul> <li> <p>les diff\u00e9rentes extensions avaient fonctionnellement le m\u00eame but : fournir la gestion op\u00e9rationnelle des paroisses, et d\u00e9pendaient les unes des autres pour fournir la fonctionnalit\u00e9 globale : ces \u00e9ventuelles interd\u00e9pendances auraient pu devenir probl\u00e9matique pour la maintenance des extensions, d\u2019aunt plus que certains \u00e9l\u00e9ments n\u00e9cessitent des \u00ab racines \u00bb (par exemple : cr\u00e9ation d\u2019un menu \u00ab racine \u00bb Uepal)</p> </li> <li> <p>diff\u00e9rentes extensions peuvent conduire \u00e0 de la duplication de code : en effet, certains m\u00e9canismes comme la gestion des menus, les settings, auraient pu \u00eatre requis dans le temps par plusieurs modules</p> </li> <li> <p>la gestion de versions est facilit\u00e9e : une seule version \u00e9tait d\u00e9j\u00e0 pr\u00e9vue pour tout le code via les tags git : on pourra donc aligner la version de info.xml et les tags</p> </li> <li> <p>les s\u00e9parations qui semblaient n\u00e9cessaires restent pr\u00e9sentes, mais sont int\u00e9gr\u00e9es dans des niveaux plus profonds : on retrouve diff\u00e9rents \u00ab namespaces \u00bb, comme CRM_Civiparoisse_Parametres,CRM_Civiparoisse_Pages\u2026 Il en est de m\u00eame pour les templates associ\u00e9s</p> </li> <li> <p>Composer peut utiliser un d\u00e9p\u00f4t git comme un repository qui contient un package versionn\u00e9 avec les tags ; si on ne souhaite pas utiliser directement le d\u00e9p\u00f4t git, il est \u00e9galement possible de g\u00e9n\u00e9rer un site web \u00ab statique \u00bb avec Satis (https://github.com/composer/satis ) qui contient les packages g\u00e9n\u00e9r\u00e9s, et utiliser ce site web comme repository Composer.</p> </li> </ul> <p>La fusion des diff\u00e9rentes extensions a eu lieu dans l\u2019issue 39.</p>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html#preparation-a-lutilisation-du-depot-git-comme-repository-composer","title":"Pr\u00e9paration \u00e0 l\u2019utilisation du d\u00e9p\u00f4t Git comme repository Composer","text":"<p>Le code, une fois unifi\u00e9, peut \u00eatre utilis\u00e9 assez simplement comme un package composer : il suffit d\u2019un fichier composer.json qui indique le vendor et le nom du package, mis \u00e0 la racine du code, comme par exemple :</p> <pre><code>{\n\"name\":\"uepal/fr.uepalparoisse.civiparoisse\"\n}\n</code></pre> <p>Ensuite, les versions du code sont g\u00e9r\u00e9es avec des tags git qui prennent la forme du pr\u00e9fixe \u00ab v \u00bb auquel on accole le num\u00e9ro de version (on obtient par exemple v0.0.1, v0.0.2,\u2026). (Voir https://getcomposer.org/doc/articles/versions.md , https://getcomposer.org/doc/02-libraries.md et https://getcomposer.org/doc/05-repositories.md#vcs ).</p> <p>CiviCRM facilite la maintenance des extensions qui sont des packages Composer : en effet, CiviCRM inclut dans les lieux o\u00f9 il cherche les extensions le lieu \u00ab CMS_ROOT/vendor \u00bb, qui n\u2019est autre que le lieu o\u00f9 Composer met par d\u00e9faut les fichiers issus d\u2019un composer update. Il est \u00e0 noter que le plugin d\u2019installeur n\u2019a pas fonctionn\u00e9 avec la proc\u00e9dure d\u2019installation, car un r\u00e9pertoire ext situ\u00e9 \u00e0 la racine du projet n\u2019est pas scann\u00e9 par d\u00e9faut pour les extensions.</p>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html#mise-a-disposition-du-package","title":"Mise \u00e0 disposition du package","text":"<p>On arrive ensuite \u00e0 la distribution du package, qui peut \u00eatre r\u00e9alis\u00e9e par deux approches compl\u00e9mentaires : distribuer le package via un d\u00e9p\u00f4t git, et \u00e9ventuellement distribuer le package via un site web.</p>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html#mise-a-disposition-via-depot-git","title":"Mise \u00e0 disposition via d\u00e9p\u00f4t Git","text":"<p>La mise \u00e0 disposition via d\u00e9p\u00f4t Git est plus ou moins obligatoire, dans la mesure o\u00f9 les g\u00e9n\u00e9rateurs de site web utiliseront le d\u00e9p\u00f4t Git comme source.</p> <p>Il convient de ne pas utiliser directement comme source le d\u00e9p\u00f4t de d\u00e9veloppement, car celui-ci contient l\u2019historique du travail, dont les messages de commit, ainsi que les emails des d\u00e9veloppeurs : ces \u00e9l\u00e9ments n\u2019ont pas besoin d\u2019\u00eatre vus par tous. On utilisera de ce fait un autre d\u00e9p\u00f4t Git (sur Github) que l\u2019on va utiliser uniquement pour publier les releases.</p> <p>La proc\u00e9dure de mise \u00e0 disposition va faire intervenir trois d\u00e9p\u00f4ts au total :</p> <ul> <li>le d\u00e9p\u00f4t de publication</li> <li>le d\u00e9p\u00f4t des sources</li> <li>un d\u00e9p\u00f4t local de travail</li> </ul> <p>La proc\u00e9dure est au bout du compte assez simple, on va travailler uniquement depuis le d\u00e9p\u00f4t local de travail:</p> <ul> <li>on cr\u00e9e le d\u00e9p\u00f4t de travail en clonant le d\u00e9p\u00f4t de publication (git clone)</li> <li>on ajoute une r\u00e9f\u00e9rence au d\u00e9p\u00f4t source au d\u00e9p\u00f4t de travail : depuis le d\u00e9p\u00f4t de travail :</li> </ul> <p><pre><code>git remote add source &lt;url ou chemin du d\u00e9p\u00f4t d\u2019origine&gt;\n</code></pre> * depuis le d\u00e9p\u00f4t de travail, on r\u00e9cup\u00e8re le commit correspondant au tag, et qui sera mis dans <code>FETCH_HEAD</code> selon ce qu\u2019on voit dans la sortie de la commande :</p> <pre><code>git fetch --depth 1 source tags/v2.0\n</code></pre> <ul> <li>on cr\u00e9e une branche en orphan (sans historique et sans commit) depuis <code>FETCH_HEAD</code> :</li> </ul> <pre><code>git checkout --orphan release_v2 FETCH_HEAD\n</code></pre> <ul> <li>on commite : attention \u00e0 l\u2019identit\u00e9 configur\u00e9e (nom et mail d\u2019utilisateur), et au message de commit : ces infos seront publi\u00e9es ensuite.</li> </ul> <pre><code>git commit -m \"Release v2.0\"\n</code></pre> <ul> <li>on taggue :</li> </ul> <pre><code>git tag v2.0 release_v2\n</code></pre> <ul> <li>on pousse le tag vers le d\u00e9p\u00f4t de release (qui est origin depuis le clone) :</li> </ul> <pre><code>git push origin tags/v2.0\n</code></pre> <p>On peut tester ensuite le fonctionnement : on cr\u00e9e un composer.json du genre :</p> <pre><code>{\n\"repositories\":[\n{\n\"type\":\"vcs\",\n\"url\":\"file:///home/ubuntu/DRUPAL_TEST/test3/release\"\n}],\n\"require\":{\n\"uepal/fr.uepalparoisse.civiparoisse\":\"2.0\"\n}\n}\n</code></pre> <p>Et ensuite, on peut utiliser composer pour lister les packages :</p> <p><pre><code>ubuntu@wpcore:~/DRUPAL_TEST/test3/usage$ ./composer.phar show -a uepal/fr.uepalparoisse.civiparoisse\nXdebug: [Step Debug] Could not connect to debugging client. Tried:\n127.0.0.1:9003 (through xdebug.client_host/xdebug.client_port) :-(\nWarning from https://repo.packagist.org: Support for Composer 1 is deprecated and some packages will not be available. You should upgrade to Composer 2. See https://blog.packagist.com/deprecating-composer-1-support/\nname     : uepal/fr.uepalparoisse.civiparoisse\ndescrip. :\nkeywords :\nversions : v2.0\ntype     : library\nhomepage :\nsource   : [git] /home/ubuntu/DRUPAL_TEST/test3/release\na85389ed3454e345d2bc67d4b0873f5d06e5dab8\ndist     : []\nnames    : uepal/fr.uepalparoisse.civiparoisse\n</code></pre> On peut \u00e9galement installer le package pour tester.</p> <p>Si l\u2019on veut mettre le code \u00e0 la disposition de tous, on peut tr\u00e8s bien faire du d\u00e9p\u00f4t de release un d\u00e9p\u00f4t \u00ab public \u00bb.</p>"},{"location":"TECHNIQUE/LOGICIEL/distribution_code_composer.html#mise-a-disposition-via-site-web","title":"Mise \u00e0 disposition via site web","text":"<p>La g\u00e9n\u00e9ration des packages \u00e0 mettre sur un site web pr\u00e9suppose de l\u2019utilisation d\u2019un syst\u00e8me de versionning (en l\u2019occurence, un d\u00e9p\u00f4t git) qui va \u00eatre interrog\u00e9 pour g\u00e9n\u00e9rer les packages de code qui vont \u00eatre mis \u00e0 disposition. Le plus propre est de connecter l\u2019outil sur le d\u00e9p\u00f4t de release g\u00e9n\u00e9r\u00e9 dans le point au-dessus, car il appara\u00eet que les sources sont r\u00e9f\u00e9renc\u00e9es dans les fichiers json g\u00e9n\u00e9r\u00e9s.</p> <p>Si les sources sont publiques, et donc mises \u00e0 la disposition de tous, alors on peut \u00e9ventuellement penser \u00e0 publier directement chez packagist.org, qui va s\u2019occuper lui-m\u00eame de parcourir p\u00e9riodiquement le d\u00e9p\u00f4t git de release et g\u00e9n\u00e9rer les packages (voir : https://packagist.org/about ). En revanche, il faut \u00e9ventuellement mettre en place une configuration de hook sur le d\u00e9p\u00f4t git pourque github avertisse packagist quand une modification est effectu\u00e9e, de sorte \u00e0 ne pas avoir besoin d\u2019attendre le d\u00e9lai de la semaine.</p> <p>Si on veut utiliser un d\u00e9p\u00f4t priv\u00e9, il faudra alors plut\u00f4t se tourner vers packagist.com (https://packagist.com/ ), mais il y aura alors des co\u00fbts associ\u00e9s. Un autre type de solution est la g\u00e9n\u00e9ration du site web via Satis (https://github.com/composer/satis ). Satis est configur\u00e9 via un ficher de configuration, qui est par d\u00e9faut <code>satis.json</code>. Un exemple de configuration est le suivant :</p> <pre><code>{\n\"name\":\"uepal/satis\",\n\"homepage\":\"http://satis.test\",\n\"repositories\":[\n{\n\"type\":\"vcs\",\n\"url\":\"/home/ubuntu/DRUPAL_TEST/test3/release\"\n}\n],\n\"require-all\":true,\n\"archive\":{\n\"directory\":\"dist\",\n\"format\":\"tar\",\n\"checksum\":true,\n\"skip-dev\":true\n},\n\"output-dir\": \"TEST_RELEASE\",\n\"output-html\":true,\n\"providers\":true,\n\"pretty-print\":true\n}\n</code></pre> <p>Les param\u00e8tres variants sont la homepage, qui sera l\u2019URL de publication finale du contenu, les repositories qui seront analys\u00e9s pour g\u00e9n\u00e9rer les packages, et l\u2019output-dir, qui est le r\u00e9pertoire de destination. Un simple appel de satis avec le param\u00e8tre build permettra ensuite de g\u00e9n\u00e9rer le site. La documentation de satis est assez compl\u00e8te (dont https://github.com/composer/satis/blob/main/docs/using.md et https://github.com/composer/satis/blob/main/docs/config.md ), et compl\u00e8te \u00e9galement celle de Composer pour les d\u00e9p\u00f4ts priv\u00e9s (https://getcomposer.org/doc/articles/handling-private-packages.md ). Comme il s\u2019agira d\u2019un site web \u00ab ind\u00e9pendant \u00bb dans une certaine mesure, on pourra mettre en \u0153uvre des \u00e9l\u00e9ments comme l\u2019authentification des clients.</p> <p>La g\u00e9n\u00e9ration peut par exemple donner des fichiers comme :</p> <pre><code>ubuntu@wpcore:~/DRUPAL_COMPOSER2/TOOLS/satis/TEST$ ls -lR\n.:\ntotal 156\ndrwxrwxr-x 3 ubuntu ubuntu 4096 nov. 13 16:14 dist\n-rw-rw-r-- 1 ubuntu ubuntu 140235 nov. 13 16:14 index.html\ndrwxrwxr-x 3 ubuntu ubuntu 4096 nov. 13 16:14 p\ndrwxrwxr-x 3 ubuntu ubuntu 4096 nov. 13 16:14 p2\n-rw-rw-r-- 1 ubuntu ubuntu 369 nov. 13 16:14 packages.json\n./dist:\ntotal 4\ndrwxrwxr-x 3 ubuntu ubuntu 4096 nov.13 16:14 uepal\n./dist/uepal:\ntotal 4\ndrwxrwxr-x 2 ubuntu ubuntu 4096 nov.13 16:14 fr-uepalparoisse-civiparoisse./dist/uepal/fr-uepalparoisse-civiparoisse:\ntotal 1128\n-rw-rw-r-- 1 ubuntu ubuntu 382464 nov. 13 16:14 uepal-fr-uepalparoisse-civiparoisse-v0.0.1-66a904.tar\n-rw-rw-r-- 1 ubuntu ubuntu 382464 nov. 13 16:14 uepal-fr-uepalparoisse-civiparoisse-v0.0.2-ff0663.tar\n-rw-rw-r-- 1 ubuntu ubuntu 382464 nov. 13 16:14 uepal-fr-uepalparoisse-civiparoisse-v0.0.3-283727.tar\n./p:\ntotal 4\ndrwxrwxr-x 2 ubuntu ubuntu 4096 nov.13 16:14 uepal\n./p/uepal:\ntotal 4\n-rw-rw-r-- 1 ubuntu ubuntu 3889 nov. 13 16:14 'fr.uepalparoisse.civiparoisse$1060f03e1bdec900db4bd55eb8eb8bb1ad05795428765663e44247de1f6d7ecd.json'\n./p2:\ntotal 4\ndrwxrwxr-x 2 ubuntu ubuntu 4096 nov. 13 16:14 uepal\n./p2/uepal:\ntotal 8\n-rw-rw-r-- 1 ubuntu ubuntu 744 nov. 13 16:14 fr.uepalparoisse.civiparoisse~dev.json\n-rw-rw-r-- 1 ubuntu ubuntu 3167 nov. 13 16:14 fr.uepalparoisse.civiparoisse.json\n</code></pre> <p>La consommation du package se fait ensuite en sp\u00e9cifiant dans le composer.json du projet d\u2019installation \u00e0 la fois le d\u00e9p\u00f4t priv\u00e9 et le package requis, comme par exemple pour l\u2019exp\u00e9rimentation :</p> <p><pre><code>{\n\"repositories\":[{\n\"type\":\"composer\",\n\"url\":\"http://satis.test\"\n}],\n\"extra\":{\n\"enable-patching\":true,\n\"compile-whitelist\": [\"civicrm/civicrm-core\", \"civicrm/composer-compile-lib\"]\n},\n\"require\":{\n\"drupal/recommended-project\":\"&gt;=9.2\",\n\"drush/drush\":\"&gt;=10\",\n\"drupal/console\":\"&gt;=1\",\n\"civicrm/civicrm-core\":\"&gt;=5.38\",\n\"civicrm/civicrm-packages\":\"&gt;=5.38\",\n\"civicrm/civicrm-drupal-8\":\"&gt;=5.38\",\n\"civicrm/civicrm-asset-plugin\":\"&gt;=1.1\",\n\"civicrm/composer-downloads-plugin\":\"&gt;=3\",\n\"uepal/fr.uepalparoisse.civiparoisse\":\"0.0.3\"\n},\n\"minimum-stability\":\"dev\",\n\"prefer-stable\":true,\n\"config\":{\n\"secure-http\":false\n}\n}\n</code></pre> Le secure-http \u00e0 FALSE a \u00e9t\u00e9 utilis\u00e9 pour ne pas avoir besoin de faire une configuration fastidieuse du SSL dans l\u2019exp\u00e9rimentation, \u00e9tant donn\u00e9 que dans le cadre d\u2019une mise en production on utiliserait probablement des certificats reconnus sans avoir besoin de r\u00e9glages sp\u00e9cifiques.</p> <p>Apr\u00e8s utilisation du composer update, on retrouve ensuite dans le r\u00e9pertoire <code>vendor/uepal/fr.uepalparoisse.civiparoisse</code> l\u2019ensemble de l\u2019extension.</p> <p>On comprend donc que chaque m\u00e9thode a des avantages et des inconv\u00e9nients, mais on peut globalement supposer que l\u2019utilisation du d\u00e9p\u00f4t git uniquement convient pour un petit nombre d\u2019instances, tandis que l\u2019utilisation d\u2019un site web fournira des facilit\u00e9s d\u2019installation pour des instances plus nombreuses, dans la mesure o\u00f9 le site web pourra disposer de fonctionnalit\u00e9s suppl\u00e9mentaires (par exemple un proxy cache qui pourra \u00eatre utile pour \u00e9conomiser du trafic r\u00e9seau pour la r\u00e9cup\u00e9ration des packages Composer, sans compter une s\u00e9paration plus nette entre les outils de d\u00e9veloppements et les outils de production).</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html","title":"Environnement de d\u00e9veloppement","text":""},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#principe-de-fonctionnement","title":"Principe de fonctionnement","text":"<p>L'id\u00e9e de l'environnement de d\u00e9veloppement est de fournir des outils rapides et efficaces pour faire les travaux de d\u00e9veloppement, sans s'encombrer d'une infrastructure compl\u00e8te. Cette structure est pr\u00e9vue pour des travaux sur des fonctionnalit\u00e9s internes \u00e0 Civiparoisse, mais n'est pas suffisante s'il y a besoin de tester des \u00e9l\u00e9ments plus importants qui mettent en jeu l'infrastructure (ex : envoi / r\u00e9ception de mail).</p> <p>Dans le d\u00e9pot des Dockerfiles, il y a non seulement le n\u00e9cessaire pour constituer les images, mais \u00e9galement trois docker-compose : </p> <ul> <li><code>docker-init.yml</code> : contient un container d'initialisation</li> <li><code>docker-compose.yml</code> : contient une stack minimale, avec la DB, l'authenticateur, et le proxy et le serveur web</li> <li><code>docker-compose-bind.yml</code> : contient la m\u00eame stack, mais avec une variable d'environnement pour faire un montage en bind du r\u00e9pertoire <code>/app</code></li> </ul> <p>L'id\u00e9e est la suivante :</p> <ul> <li>initialiser un environnement pour avoir une installation propre</li> <li>r\u00e9cup\u00e9rer en local l'ensemble des fichiers de l'environnement</li> <li>remplacer les emplacements qui contiennent le code sp\u00e9cifique de civiparoisse par des clones git</li> <li>utiliser la copie pour la faire tourner dans Docker</li> </ul>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#resolution-de-noms","title":"R\u00e9solution de noms","text":"<p>Le nom utilis\u00e9 dans les images est <code>civicrm.test</code>. Il y a lieu d'\u00e9crire une entr\u00e9e dans <code>/etc/hosts</code> pour r\u00e9soudre ce nom vers <code>127.0.0.1</code>.</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#initialisation-du-repertoire-de-destination","title":"Initialisation du r\u00e9pertoire de destination","text":"<pre><code>#!/bin/bash\n\necho \"export CIVIPAROISSEDEV=~/devciviparoisse\" &gt;&gt;~/.bashrc\nsource ~/.bashrc\nmkdir -p ${CIVIPAROISSEDEV}\n</code></pre> <p>On d\u00e9finit la variable CIVIPAROISSEDEV dans le bashrc de sorte que la variable soit disponible, et charg\u00e9e via le shell (bash).</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#recuperation-des-dockerfiles","title":"R\u00e9cup\u00e9ration des Dockerfiles","text":"<p>Les dockerfiles se trouvent dans un d\u00e9p\u00f4t sp\u00e9cifique : <code>git@github.com:UEPAL-CiviParoisse/Dockerfiles.git</code></p> <p>Il faut compiler les images du Dockerfile (pour l'instant, branche <code>ENV_DEV</code>), via le build.sh pr\u00e9sent dans le d\u00e9p\u00f4t. La compilation des images prend un certain temps (et un temps certain).</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#initialisation-dune-installation","title":"Initialisation d'une installation","text":"<pre><code>docker-compose -f docker-init.yml up\ndocker-compose -f docker-init.yml down --remove-orphans\n</code></pre> <p>Ceci initialise surtout les volumes dont on aura besoin</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#recuperation-des-donnees-en-local","title":"R\u00e9cup\u00e9ration des donn\u00e9es en local","text":"<p>On lance l'environnement :</p> <pre><code>docker-compose -f docker-compose.yml up -d\n</code></pre> <p>Le but est d'avoir le conteneur du serveur web lanc\u00e9. On utilise <code>docker container ls</code> pour voir la liste des conteneurs lanc\u00e9s. Le nom du conteneur d\u00e9pendra du r\u00e9pertoire contenant le clone du d\u00e9p\u00f4t des dockerfiles.</p> <pre><code>docker container ls\nCONTAINER ID   IMAGE                        COMMAND                  CREATED              STATUS              PORTS                            NAMES\n7d607761b474   uepal_test/proxy             \"apache2-foreground\"     About a minute ago   Up About a minute   80/tcp, 127.0.0.1:443-&gt;443/tcp   git_dockerfiles_civiproxy_1\n00d5bf0ad884   uepal_test/authenticator     \"/exec/exec.sh\"          About a minute ago   Up About a minute                                    git_dockerfiles_civiauthenticator_1\nd960762f63b0   uepal_test/httpd             \"apache2-foreground\"     About a minute ago   Up About a minute   80/tcp, 444/tcp                  git_dockerfiles_civihttpd_1\n898dca63e562   ubuntu/mysql                 \"docker-entrypoint.s\u2026\"   About a minute ago   Up About a minute   3306/tcp, 33060/tcp              git_dockerfiles_cividb_1\n22b88b8c9cde   uepal_test/mkdocs-material   \"mkdocs serve --dev-\u2026\"   2 hours ago          Up 2 hours          127.0.0.1:8000-&gt;8000/tcp         mkdocs_material\n</code></pre> <p>Ici, le nom du conteneur est : <code>git_dockerfiles_civihttpd_1</code>. </p> <p>On va r\u00e9cup\u00e9rer l'ensemble du r\u00e9pertoire /app en local, et on va utiliser des r\u00e8gles ACL pour positionner des droits pour l'utilisateur courant (et ainsi, on aura moins besoin de jongler entre les droits dans le conteneur et l'environnement de travail). La copie cr\u00e9ant de nouveaux fichiers, et comme on va binder les volumes, il faut \u00e9galement positionner les droits sur les fichiers du bind. Dans le conteneur courant, www-data est un utilisateur dont l'UID est 33 (pour le moment, mais \u00e7a peut changer en fonction de la vie des images); d'o\u00f9 la mise en place des droits pour l'utilisateur 33.</p> <pre><code>sudo docker cp git_dockerfiles_civihttpd_1:/app/ ${CIVIPAROISSEDEV}\nsudo setfacl -R -m u:$(whoami):rwx ${CIVIPAROISSEDEV}\nsudo setfacl -R -m u:33:rxw ${CIVIPAROISSEDEV}\n</code></pre> <p>On arr\u00eate les conteneurs :</p> <pre><code>docker-compose -f docker-compose.yml down\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#branchement-des-depots-gits","title":"Branchement des d\u00e9p\u00f4ts gits","text":"<p>Les d\u00e9p\u00f4ts gits viendront remplacer les fichiers de l'image, via de l'effacement puis des clones.</p> D\u00e9p\u00f4t Description Chemin <code>git@github.com:UEPAL-CiviParoisse/Extensions_CiviCRM.git</code> Fichiers extension civiparoisse <code>${CIVIPAROISSEDEV}/app/vendor/uepal/fr.uepalparoisse.civiparoisse</code> <code>git@github.com:UEPAL-CiviParoisse/CIVIP_INSTALL.git</code> Setup civicrm-civiparoisse <code>${CIVIPAROISSEDEV}/app/vendor/uepal/civisetup</code> <code>git@github.com:UEPAL-CiviParoisse/Modules_Drupal.git</code> Module drupal civiparoisse <code>${CIVIPAROISSEDEV}/app/web/modules/contrib/fr.uepalparoisse.druparoisse</code> <p>Lorsqu'on branche les d\u00e9p\u00f4ts gits, on va certainement faire :</p> <ul> <li>un mv ou rm des fichiers pr\u00e9sents en local dans les r\u00e9pertoires cibles, </li> <li>des <code>git clone</code> pour remplacer les fichiers</li> <li>des <code>git checkout</code> pour se positionner dans les bonnes branches</li> <li>des <code>setfacl</code> pour positionner les droits pour le serveur web</li> </ul> <p>Lorsqu'on change les branches, il faudra penser \u00e0 vider les caches (par exemple via les interfaces d'administration).</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#lancement-de-lenvironnement-pour-dev","title":"Lancement de l'environnement pour dev","text":"<p>L'environnement pour le d\u00e9veloppement est un peu particulier, dans la mesure o\u00f9 l'on va utiliser un conteneur httpd modifi\u00e9 pour inclure Xdebug, ainsi qu'un montage bind des fichiers locaux. De m\u00eame, le r\u00e9seau utilis\u00e9 est un seul r\u00e9seau (en raison de probl\u00e8mes de mise au point sur les scopes). Pour le lancer : </p> <pre><code>docker-compose -f docker-compose-bind.yml up -d\n</code></pre> <p>Pour arr\u00eater : </p> <pre><code>docker-compose -f docker-compose-bind.yml down\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#mots-de-passe-par-defaut","title":"Mots de passe par d\u00e9faut","text":"<p>Les mots de passe sont pr\u00e9sents dans les secrets li\u00e9s \u00e0 l'image <code>init</code>.</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev.html#configuration-xdebug-pour-vscode-launchjson","title":"Configuration xdebug pour vscode : launch.json","text":"<p>On ouvre le dossier ${CIVIPAROISSEDEV}/app dans vscode. Vscode propose une extension pour xdebug : identificateur : <code>xdebug.php-debug</code>.</p> <p>Cette extension utilise un fichier <code>launch.json</code> pour configurer une instance de xdebug. Il convient de faire attention d'\u00e9couter sur toutes les IP et sur le bon port (9003), ainsi que de configurer le pathMapping, pour la correspondance des fichiers sources.</p> <pre><code>{\n    // Utilisez IntelliSense pour en savoir plus sur les attributs possibles.\n    // Pointez pour afficher la description des attributs existants.\n    // Pour plus d'informations, visitez : https://go.microsoft.com/fwlink/?linkid=830387\n    \"version\": \"0.2.0\",\n    \"configurations\": [\n        {\n            \"name\": \"Listen for Xdebug\",\n            \"type\": \"php\",\n            \"request\": \"launch\",\n            \"port\": 9003,\n            \"hostname\": \"::\",\n            \"pathMappings\": {\n                \"/app\":\"${workspaceFolder}\"\n            }\n\n        }\n\n    ]\n}\n</code></pre> <p>Une fois que cela est fait, il suffit donc de positionner les points d'arr\u00eats et de lancer le d\u00e9bugger.</p> <p>A noter que xdebug, tel que configur\u00e9, est pr\u00e9vu pour envoyer des requ\u00eates dans tous les cas \u00e0 l'IDE.</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev_env.html","title":"Personnalisation de l'environnement de d\u00e9veloppement","text":"<p>Attention !</p> <p>Les \u00e9l\u00e9ments de ce fichier n'ont pas \u00e9t\u00e9 v\u00e9rifi\u00e9s ; les lignes de commandes n'ont pas \u00e9t\u00e9 test\u00e9es.</p> <p>L'environnement de d\u00e9veloppement a \u00e9t\u00e9 pens\u00e9 initialement pour utiliser les images issues des Dockerfiles avec les variables d'environnement par d\u00e9faut. Toutefois, il est parfois n\u00e9cessaire de pouvoir personnaliser les valeurs, dont notamment le nom du serveur, et ceci peut avoir un impact sur les clefs TLS.</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev_env.html#aspects-theoriques","title":"Aspects th\u00e9oriques","text":""},{"location":"TECHNIQUE/LOGICIEL/environnement_dev_env.html#personnalisation-de-lenvironnement","title":"Personnalisation de l'environnement","text":"<p>L'approche qui est pr\u00e9vue pour Helm est d'utiliser le fichier de valeurs, qui h\u00e9rite des valeurs par d\u00e9faut, pour pr\u00e9parer les \u00e9l\u00e9ments de configuration n\u00e9cessaires (ConfigMap, Secrets, entre autres) des pods. En revanche, cette approche est plus difficile \u00e0 mettre en oeuvre dans le cas de Compose.</p> <p>L'approche retenue est d'utiliser les fichiers d'environnement. On trouve trois type de fichiers :</p> <ul> <li>le fichier d'environnement sp\u00e9cifi\u00e9 au niveau de la ligne de commande (<code>--env-file</code>) : ce fichier permet d'utiliser des variables qui sont r\u00e9f\u00e9renc\u00e9es directement dans le fichier yml de docker-compose, et les valeurs peuvent \u00eatre propag\u00e9es, si elles sont au minimum mentionn\u00e9es dans le docker-compose, jusqu'au container</li> <li>le premier fichier d'environnement sp\u00e9cifi\u00e9 au niveau des configurations via <code>env_file</code> : ce fichier est pr\u00e9vu pour contenir des valeurs \"par d\u00e9faut\" qui sont normalement celles pr\u00e9sentes dans les images. Ces valeurs peuvent se retrouver par <code>docker image inspect &lt;nom image&gt;</code>.</li> <li>le deuxi\u00e8me fichier d'environnement sp\u00e9cifi\u00e9 via <code>env_file</code> (fichier avec suffixe <code>override dans la configuration</code>): comme c'est le deuxi\u00e8me fichier, il sera pris en compte en priorit\u00e9 par rapport au premier fichier.</li> </ul> <p>Lorsque l'on souhaite modifier l'environnement, il faut donc modifier le fichier envfile principal et les fichiers d'override, en gardant la correspondance des valeurs.</p> <p>Attention !</p> <p>Si on modifie <code>SERVERNAME</code>, il faut \u00e9galement penser \u00e0 inclure la modification dans le <code>TRUSTED_HOST_PATTERNS</code>.</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev_env.html#clefs-tls","title":"Clefs TLS","text":"<p>Au niveau de Helm, le template qui g\u00e8re les clefs TLS est capable de pr\u00e9parer les hi\u00e9rarchies de certificats (avec CA autosign\u00e9s), et est pr\u00e9vu pour ne remplacer les clefs que si elles n'existent pas.</p> <p>Au niveau de docker-compose, ce m\u00e9canisme n'existe pas, et il a \u00e9t\u00e9 n\u00e9cessaire de pr\u00e9parer une image KEYS_INIT pour pr\u00e9parer les jeux de clefs qui vont \u00eatre stock\u00e9s dans un montage de type bind (vers le r\u00e9pertoire <code>genkeys</code>).</p> <p>Pour utiliser cette image, il faudra passer la valeur de la variable d'environnement SERVERNAME au container. Le fichier docker-init-envkeys.yml est pr\u00e9vu pour cela, en utilisant en plus le fichier principal d'environnement (<code>--env-file</code>).</p>"},{"location":"TECHNIQUE/LOGICIEL/environnement_dev_env.html#aspects-pratiques","title":"Aspects pratiques","text":"<p>En pratique, on suivra le cheminement suivant pour utiliser ces \u00e9l\u00e9ments :</p> <ul> <li>r\u00e9cup\u00e9ration du d\u00e9p\u00f4t des Dockerfiles, et se positionner sur la branche (peut-\u00eatre <code>ENV_DEV_KEYS</code>)</li> <li>personnalisation des fichiers d'environnement <code>envfile</code> principal et les fichiers <code>envfile_*_override</code>, en fonction des besoins du d\u00e9veloppeur </li> <li>build des images, gr\u00e2ce au script <code>build.sh</code></li> <li>g\u00e9n\u00e9ration des clefs :</li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-init-envkeys.yml --env-file envfile up\ndocker-compose -f docker-init-envkeys.yml --env-file envfile down\n</code></pre> <ul> <li>installation de l'environnement (volumes et BD) : </li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-init-env.yml --env-file envfile up\ndocker-compose -f docker-init-env.yml --env-file envfile down\n</code></pre> <ul> <li>d\u00e9marrage avec l'environnement des containers :</li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-compose-env.yml --env-file envfile up\n</code></pre> <ul> <li>se logguer dans le syst\u00e8me pour v\u00e9rifier que tout s'est bien pass\u00e9</li> <li>r\u00e9cup\u00e9rer le /app du container de serveur web interne comme d\u00e9crit dans l'environnement de dev (en pensant \u00e0 r\u00e9gler aussi les droits)</li> <li>arr\u00eater l'environnement des containers :</li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-compose-env.yml --env-file envfile down\n</code></pre> <ul> <li>d\u00e9marrer l'environnement bind\u00e9 avec les r\u00e9pertoires locaux (comme d\u00e9crits dans l'environnement de d\u00e9veloppement)</li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-compose-bind-env.yml --env-file envfile up\n</code></pre> <ul> <li> <p>faire le travail d\u00e9sir\u00e9 (d\u00e9veloppement)</p> </li> <li> <p>arr\u00eater l'environnement</p> </li> </ul> <pre><code>#!/bin/bash\ndocker-compose -f docker-compose-bind-env.yml --env-file envfile down\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/importation.html","title":"Importation initiale","text":"<p>Civiparoisse a besoin de donn\u00e9es pour pouvoir rendre service aux paroisses. Les donn\u00e9es initiales ont \u00e9t\u00e9 collect\u00e9es et stock\u00e9es dans un fichier excel ad-hoc, dont le format est d\u00e9crit dans un document tiers. Deux \u00e9tapes sont n\u00e9cessaires pour importer les donn\u00e9es : parser le fichier excel, puis exploiter les donn\u00e9es.</p>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#parsage-des-donnees","title":"Parsage des donn\u00e9es","text":"<p>Le parsage du fichier excel peut \u00eatre effectu\u00e9 gr\u00e2ce \u00e0 la librairie phpoffice/phpspreadsheet, qui est une d\u00e9pendance (r\u00e9cente) de CiviCRM. Les donn\u00e9es pars\u00e9es correspondent \u00e0 une partie d'une pseudo-table globale de connaissances sur les paroissiens.</p> <p>Il a sembl\u00e9 judicieux de mettre le code relatif au parsage des donn\u00e9es dans une biblioth\u00e8que s\u00e9par\u00e9e, afin de pouvoir \u00e9ventuellement r\u00e9utiliser le code de parsage pour une validation du fichier Excel hors CiviCRM.</p> <p>Le parsage est conceptuellement simple : on cr\u00e9e des parseurs de colonnes issus d'une m\u00eame classe abstraite pour analyser les diff\u00e9rents cellules d'une ligne de donn\u00e9es, et on met les r\u00e9sultats du parsage dans une structure de donn\u00e9es.</p> <p>Parser une ligne consiste donc \u00e0 ex\u00e9cuter l'ensemble des parseurs disponibles.</p> <p>Le code pr\u00e9voit des contr\u00f4les sur les donn\u00e9es ; une donn\u00e9e jug\u00e9e invalide est ignor\u00e9e. Les contr\u00f4les similaires (par exemple sur la casse, ou sur des expressions rationnelles) sont impl\u00e9ment\u00e9es dans des classes abstraites qui d\u00e9coulent du parseur principal afin de factoriser le code.</p> <p>On liste en-dessous les parseurs, et les contr\u00f4les effectu\u00e9s. On arrive \u00e0 d\u00e9duire du nom du parseur le champ concern\u00e9 du fichier Excel. En plus des champs proprement dit, on r\u00e9cup\u00e8re \u00e9galemement le num\u00e9ro de ligne. Celui-ci pourra \u00e9ventuellement \u00eatre utile pour les logs de message d'erreur.</p> <p>Bug</p> <p>Remarque globale pour tous les parsers \"Oui/Non\" : v\u00e9rifier que Excel renvoie bien Oui/Non, et pas Vrai/Faux</p> <p>Bug</p> <p>Code Postal : attention on peut avoir des CP suisses en 4 chiffres, voir \u00e9ventuellement des CP d'autres pays</p> <p>Bug</p> <p>T\u00e9l\u00e9phones : on peut avoir des num\u00e9ros \u00e0 l'\u00e9tranger (Allemagne, Suisse, ...)    </p> Parseur Contr\u00f4le AdresseLigne1Parser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) AdresseLigne2Parser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) AdresseLigne3Parser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) AdulteParser Doit correspondre soit \u00e0 la cha\u00eene <code>'Oui'</code> soit \u00e0 la cha\u00eene <code>'Non'</code> CiviliteParser Doit correspondre soit \u00e0 la cha\u00eene <code>'M.'</code> soit \u00e0 la cha\u00eene <code>'Mme'</code> CodePostalParser Doit matcher <code>'/^([[:upper:]]+-)?[0-9]{5}$/'</code> DateNaissanceParser Doit \u00eatre parsable avec le format DateTime <code>'d/m/Y|'</code> DiversParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) ElecteurParser Doit correspondre soit \u00e0 la cha\u00eene <code>'Oui'</code> soit \u00e0 la cha\u00eene <code>'Non'</code> EmailAutreParser Doit passer avec <code>filter_var</code> avec <code>FILTER_VALIDATE_EMAIL</code> EmailPriveParser Doit passer avec <code>filter_var</code> avec <code>FILTER_VALIDATE_EMAIL</code> EnfantParser Doit correspondre soit \u00e0 la cha\u00eene <code>'Oui'</code> soit \u00e0 la cha\u00eene <code>'Non'</code> FoyerAppartenanceParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) LieuNaissanceParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) NomConjointParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) NomNaissanceParser Doit matcher la Regex <code>'#^[[:upper:]]+([ \\-\\'/][[:upper:]]+)*$#'</code> NomParentsParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) NomParser Doit matcher la Regex <code>'#^[[:upper:]]+([ \\-\\'/][[:upper:]]+)*$#'</code> PaysParser Ne pas matcher la cha\u00eene vide (Regex : <code>'/^[[:space:]]*$/'</code>) PrenomParser Doit matcher la regex <code>'/^[[:upper:]][[:lower:]\u00e9\u00e8\u00ea\u00eb\u00fc\u00f4\u00ef\u00e0\u00f9]+(-[[:upper:]][[:lower:]\u00e9\u00e8\u00ea\u00eb\u00fc\u00f4\u00ef\u00e0\u00f9]+)*$/'</code> RowIndexParser La valeur doit \u00eatre non vide et num\u00e9rique (<code>is_numeric</code>) TelephoneAutreParser Doit matcher la Regex <code>'#^00 33 [12345679] [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$#'</code> TelephoneFixeParser Doit matcher la Regex <code>'#^00 33 [123459] [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$#'</code> TelephonePortableParser Doit matcher la Regex <code>'#^00 33 [67] [0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$#'</code> VilleParser Doit matcher la Regex <code>'#^[[:upper:]]+([ \\-\\'/][[:upper:]]+)*$#'</code>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#exploitation-des-donnees","title":"Exploitation des donn\u00e9es","text":"<p>Plusieurs approches semblent convenir pour exploiter cette pseudo-table :</p> <ul> <li>travailler directement en m\u00e9moire, en calculant et en mettant \u00e0 jour des structures de donn\u00e9es.</li> <li>passer par des requ\u00eates SQL que ce soit avec un moteur s\u00e9par\u00e9 (par exemple sqlite) ou en utilisant MySQL, et, par exemple, des tables temporaires (voir https://dev.mysql.com/doc/refman/8.0/en/create-temporary-table.html)</li> <li>construction petit \u00e0 petit des enregistrements, avec utilisation de fonctions getOrCreate, et en mettant un peu d'intelligence dans le ParsedContact pour exploiter les donn\u00e9es</li> </ul>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#import-des-elements-lies-au-contact","title":"Import des \u00e9l\u00e9ments li\u00e9s au Contact","text":"<p>Le parsage cr\u00e9e des objets de type Uepal\\CiviImport\\ParsedContact. Pour importer les \u00e9l\u00e9ments, il faut d'abord commencer par identifier les entit\u00e9s cibles de CiviCRM :</p> <ul> <li>le contact : on aura un contact par ligne. Les attributs qui seront stock\u00e9s sont les suivants :</li> <li> <pre><code> protected function computeContactParams(): array\n  {\n    $cfUtils = CRM_Civiparoisse_Utils_CustomFields::getSingleton();\n    $parsedContact = $this-&gt;getCompositeImportData()-&gt;getParsedContact();\n    $candidates = [\"prefix_id:label\" =&gt; $parsedContact-&gt;getCivilite(),\n      \"gender_id:name\" =&gt; $this-&gt;computeContactGenderName($parsedContact),\n      \"contact_type:name\" =&gt; \"Individual\",\n      \"last_name\" =&gt; $parsedContact-&gt;getNom(),\n      $cfUtils-&gt;getFieldNameId(\"nom_naissance\") =&gt; $parsedContact-&gt;getNomNaissan\nce(),\n      \"first_name\" =&gt; $parsedContact-&gt;getPrenom(),\n      \"birth_date\" =&gt; CRM_Civiparoisse_Utils_DateFormatter::formatDate($parsedCo\nntact-&gt;getDateNaissance()),\n      $cfUtils-&gt;getFieldNameId(\"lieu_naissance\") =&gt; $parsedContact-&gt;getLieuNaissance(),\n      'household_name' =&gt; $parsedContact-&gt;getFoyerAppartenance()];\n    $candidates = array_filter($candidates);\n    return ['values' =&gt; $candidates];\n  }\n</code></pre> </li> <li> <p>le t\u00e9l\u00e9phone mobile :</p> </li> </ul> <pre><code>  protected function computeMobilePhoneParams(): array\n  {\n    return ['values' =&gt; ['location_type:name' =&gt; 'Accueil',\n      'phone_type_id:name' =&gt; 'Mobile',\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getContactId(),\n      'phone' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getTelephonePortable(),\n      'is_primary' =&gt; 1]];\n  }\n</code></pre> <ul> <li>le t\u00e9l\u00e9phone professionnel appel\u00e9 auparavant \"autre\"</li> </ul> <pre><code>  protected function computeOtherPhoneParams(): array\n  {\n    return ['values' =&gt; ['location_type:name' =&gt; 'Travail',\n      'phone_type_id:name' =&gt; 'Phone',\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getContactId(),\n      'phone' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getTelephoneAutre(),\n      'is_primary' =&gt; 0]];\n  }\n</code></pre> <ul> <li>le mail priv\u00e9 :</li> </ul> <pre><code> protected function computeEmailPriveParam() : array\n  {\n    return ['values' =&gt; ['email' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getEmailPrive(),\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getContactId(),\n      'location_type:name' =&gt; 'Accueil',\n      'is_primary' =&gt; TRUE]];\n\n  }\n</code></pre> <ul> <li>le mail professionnel :</li> </ul> <p><pre><code>  protected function computeEmailAutreParam() : array\n  {\n    return ['values' =&gt; ['email' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getEmailAutre(),\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getContactId(),\n      'location_type_id:name' =&gt; 'Travail',\n      'is_primary' =&gt; 0\n    ]];\n  }\n</code></pre> * la note compl\u00e9mentaire :</p> <pre><code> protected function computeNoteDiversParam(): array\n  {\n    return ['values' =&gt; [\n      'note' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getDivers(),\n      'entity_table:name' =&gt; 'Contact',\n      'entity_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getContactId(),\n      'contact_id' =&gt;CRM_Core_Session::getLoggedInContactID(),\n      'subject' =&gt; 'Note import'\n    ]];\n  }\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#import-des-elements-lies-au-foyer","title":"Import des \u00e9l\u00e9ments li\u00e9s au foyer","text":"<ul> <li>le foyer : un foyer sera constitu\u00e9 par un nom de foyer, une adresse, et un num\u00e9ro de t\u00e9l\u00e9phone fixe. Toute alt\u00e9ration d'un des champs conduira \u00e0 un nouveau foyer ; on se souviendra que le foyer est un type de contact. Le foyer est consid\u00e9r\u00e9 comme une unit\u00e9 familiale (parents et \u00e9ventuellement enfants).</li> <li><pre><code> protected function computeHouseholdParams(): array\n  {\n    return ['values' =&gt; [\n      'contact_type' =&gt; 'Household',\n      'display_name' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getFoyerAppartenance(),\n      'household_name' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getFoyerAppartenance()\n    ]];\n  }\n</code></pre></li> <li>l'adresse : l'adresse sera rattach\u00e9e au foyer. Du fait de la construction du fichier, il serait difficile de faire les s\u00e9parations fines des constituants de l'adresse pour les faire rentrer exactement dans les champs de civicrm. On utilise donc les lignes d'adresse supl\u00e9mentaire pour le stockage.</li> </ul> <pre><code> protected function computeAddressParams(): array\n  {\n    return ['values' =&gt; ['street_address' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getAdresseLigne1(),\n      'supplemental_address_1' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getAdresseLigne2(),\n      'supplemental_address_2' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getAdresseLigne3(),\n      'postal_code' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getCodePostal(),\n      'city' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getVille(),\n      'country_id:label' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getPays(),\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getFoyerId(),\n      'is_primary' =&gt; TRUE,\n      'location_type_id:name' =&gt; 'Accueil']];\n  }\n</code></pre> <p>Bug</p> <p>Pour l'adresse il faut rajouter une variable location_type   'location_type_id' =&gt; 1, // 1 = domicile, 2 = travail, 3 \u00e0 5 pas utilis\u00e9s dans notre projet </p> <ul> <li>le num\u00e9ro de t\u00e9l\u00e9phone fixe : chaque num\u00e9ro est une entit\u00e9 distincte. Le num\u00e9ro fixe est reli\u00e9 au foyer, tandis que le num\u00e9ro mobile et le num\u00e9ro autre est reli\u00e9 au contact. La distinction entre les num\u00e9ros de t\u00e9l\u00e9phones se fait via le champ <code>location_type_id</code> et phone_type_id (\u00e0 v\u00e9rifier : les valeurs de <code>location_type</code> que l'on souhaite utiliser):</li> </ul> <pre><code>protected function computePhoneParams(): array\n  {\n    return ['values' =&gt; [\n      'contact_id' =&gt; $this-&gt;getCompositeImportData()-&gt;getFoyerId(),\n      'phone' =&gt; $this-&gt;getCompositeImportData()-&gt;getParsedContact()-&gt;getTelephoneFixe(),\n      'location_type_id:name' =&gt; 'Accueil',\n      'phone_type_id:name' =&gt; 'Phone',\n      'is_primary' =&gt; 1\n    ]];\n  }\n</code></pre> <p>Bug</p> <p>Pour les t\u00e9l\u00e9phones, il faut g\u00e9rer deux variables</p> <p>'location_type_id' =&gt; 1, // 1 = domicile, 2 = travail, 3 \u00e0 5 pas utilis\u00e9s dans notre projet   'phone_type_id' =&gt; 2, // 1= fixe, 2 = portable, 3 = fax, 4 et 5 pas utilis\u00e9s dans notre projet</p> <p>Bug</p> <p>CAUTION : je ne suis pas s\u00fbr que ce soit les bonnes valeurs du location_type</p> <ul> <li>les emails : chaque email constitue \u00e9galement une entit\u00e9 distincte, \u00e9galement reli\u00e9e au contact, et on utilise \u00e9galement le <code>location_type</code> pour distinguer les emails :</li> </ul> <p>Bug</p> <p>Pour les mails, je ne suis pas s\u00fbr que les valeurs location_type ci-dessous soient les bonnes</p> <p>'location_type_id' =&gt; 1, // 1 = domicile, 2 = travail, 3 \u00e0 5 pas utilis\u00e9s dans notre projet </p>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#la-liaison-entre-les-contacts-individuels-et-les-adresses","title":"La liaison entre les contacts individuels et les adresses","text":"<p>Il s'agit ici de cr\u00e9er des adresses pour chaque contact individuel : ces adresses vont \u00eatre rattach\u00e9es aux adresses du foyer.</p> <pre><code> protected function computeContactAddrWorkload() : array\n  {\n    return ['values'=&gt;[\n      'contact_id'=&gt;$this-&gt;getCompositeData()-&gt;getContactId(),\n      'master_id'=&gt;$this-&gt;getCompositeData()-&gt;getFoyerAddrId()\n    ]];\n  }\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#les-relations-entre-les-contacts-foyers-et-le-membership","title":"Les relations entre les contacts, foyers, et le membership","text":"<ul> <li>relation membre de foyer : il s'agi de mat\u00e9rialiser le fait qu'un contact fasse parti d'un foyer. </li> </ul> <pre><code>protected function computeMemberOfHouseholdParams(int $ord): array\n  {\n    return ['values' =&gt; ['relationship_type_id:name' =&gt; 'Household Member of',\n      'contact_id_a' =&gt; $this-&gt;getCompositeImportData($ord)-&gt;getContactId(),\n      'contact_id_b' =&gt; $this-&gt;getCompositeImportData($ord)-&gt;getFoyerId()]];\n  }\n</code></pre> <ul> <li>relation adulte : il s'agit en fait des \"chefs de famille\" - chefs de foyers. Le fait d'activer la case \u00e0 cocher indique qu'il faut g\u00e9n\u00e9rer une relation chef de famille vers le foyer</li> </ul> <pre><code>protected function computeHeadOfHouseholdParams(int $ord): array\n  {\n    $compositeImportData = $this-&gt;getCompositeImportData($ord);\n    return ['values' =&gt; ['relationship_type_id:name' =&gt; 'Head of Household for',\n      'contact_id_a' =&gt; $compositeImportData-&gt;getContactId(),\n      'contact_id_b' =&gt; $compositeImportData-&gt;getFoyerId()]];\n  }\n</code></pre> <ul> <li>membre \u00e9lecteur : il s'agit d'un type de membership vers l'organisation de la paroisse ; ce membership est mis en oeuvre du moment que Electeur est activ\u00e9.</li> </ul> <pre><code> protected function computeElecteurParams(int $ord): array\n  {\n    return ['values' =&gt; ['membership_type_id.name' =&gt; 'Electeur\u00b7trice',\n      'contact_id' =&gt; $this-&gt;getCompositeImportData($ord)-&gt;getContactId()]];\n  }\n</code></pre> <ul> <li>relation conjoint : On effectue une liaison en v\u00e9rifiant nom et pr\u00e9nom ; on privil\u00e9giera le fait de faire parti d'un m\u00eame foyer pour la s\u00e9lection du conjoint. Le type de relation lui-m\u00eame d\u00e9pendra du nom du foyer, car le nom du foyer refl\u00e8te le mariage ou la libre union.</li> </ul> <pre><code> protected function computeSpouseParams(int $ord): array\n  {\n    $spouseId = $this-&gt;retrieveSpouseId($ord);\n    $contactId = $this-&gt;getCompositeImportData($ord)-&gt;getContactId();\n    $relationship = $this-&gt;computeSpouseRelationTypeName($ord);\n    return ['values' =&gt; ['relationship_type_id:name' =&gt; $relationship,\n      'contact_id_a' =&gt; $contactId,\n      'contact_id_b' =&gt; $spouseId]];\n  }\n</code></pre> <ul> <li>relation parent : la relation de parents indique le nom des deux parents. On distingue le fait que les parents soit mari\u00e9s ou non pour calculer le nom individuel recherch\u00e9 de chaque parent. Le parent est cherch\u00e9 en priorit\u00e9 dans le foyer, et ensuite dans l'ensemble des contacts.</li> </ul> <pre><code>protected function computeParentParam(int $ord, int $parentId): array\n  {\n    $contactId = $this-&gt;getCompositeImportData($ord)-&gt;getContactId();\n    return ['values' =&gt; ['relationship_type_id:name' =&gt; 'Child of',\n      'contact_id_a' =&gt; $contactId,\n      'contact_id_b' =&gt; $parentId]];\n  }\n</code></pre> <ul> <li>membre enfant inscrit: un enfant est uniquement membre du foyer, marqu\u00e9 comme enfant,non marqu\u00e9 comme \u00e9lecteur et n'\u00e9tant pas majeur. </li> </ul> <pre><code>  protected function computeEnfantInscritParam(int $ord): array\n  {\n    return ['values' =&gt; ['membership_type_id.name' =&gt; 'Inscrit\u00b7e Enfant',\n      'contact_id' =&gt; $this-&gt;getCompositeImportData($ord)-&gt;getContactId()]];\n  }\n</code></pre> <ul> <li>relation de fratrie : la relation de fratrie est uniquement activ\u00e9 lorsque les deux parents sont les m\u00eames. </li> </ul> <pre><code> protected function computeFratrieParam(int $ord,int  $fratrieId) : array\n  {\n    $contactId = $this-&gt;getCompositeImportData($ord)-&gt;getContactId();\n    return ['values' =&gt; ['relationship_type_id:name' =&gt; 'Sibling of',\n      'contact_id_a' =&gt; $contactId,\n      'contact_id_b' =&gt; $fratrieId]];\n  }\n</code></pre>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#guidelines-pour-limport","title":"Guidelines pour l'import","text":"<p>Le but est ici uniquement de g\u00e9rer un import initial. Toutefois, si les donn\u00e9es de diff\u00e9rents lots sont enti\u00e8rement disjointes, on peut envisager des imports successifs \u00e0 partir de plusieurs fichiers - m\u00eame s'il faut garder \u00e0 l'esprit que le d\u00e9veloppement n'a pas \u00e9t\u00e9 pr\u00e9vu pour \u00e7a.</p>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#outillage-limage-tools","title":"Outillage : l'image tools","text":"<p>La proc\u00e9dure d'import est pr\u00e9vue pour \u00eatre lanc\u00e9e depuis la ligne de commande (outil cv). De ce fait, on utilisera l'image des outils pour acc\u00e9der au n\u00e9cessaire, en effectuant les montages requis (en particulier montage des fichiers, et montage du point d'acc\u00e8s \u00e0 la BD). Le fichier lui-m\u00eame pourra \u00eatre \u00e9galement mont\u00e9 dans l'image, ou copi\u00e9 dans le container lors de l'ex\u00e9cution (par exemple via <code>docker cp</code>).</p>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#parsage","title":"Parsage","text":"<p>Avant de lancer l'import proprement dit, il faut v\u00e9rifier si le parsage se fait correctement. Il est en effet arriv\u00e9 lors des tests qu'un fichier au format xlsx modifi\u00e9 par LibreOffice a pos\u00e9 probl\u00e8me lors du parsage (mauvaise consid\u00e9ration de la derni\u00e8re ligne renseign\u00e9e). Dans ce genre de cas, on privil\u00e9giera des enregistrements dans des formats natifs (ods, xlsx) du moment que les formats sont support\u00e9s par phpspreadsheet.</p> <pre><code>#!/bin/bash\n#export PHP_IDE_CONFIG=\"serverName=civicrm.test\"\nexport CIVIPAROISSE_IMPORT_FILEPATH=\"/app/test2.ods\"\nexport CIVIPAROISSE_IMPORT_SHEETNAME=\"Feuil1\"\ncv ev 'var_dump(CRM_Civiparoisse_Import_Importer::parse(new Uepal\\CiviImport\\MiniLogger()))'\n</code></pre> <p>Le parseur est pr\u00e9vu pour utiliser un logger sp\u00e9cifi\u00e9 en param\u00e8tre. Trois loggers sont notamment \u00e0 consid\u00e9rer :</p> <ul> <li> <p>le MiniLogger : <code>new Uepal\\CiviImport\\MiniLogger())</code> : ce logger est inclus dans le code du parseur, et il utilise le error_log de PHP pour logguer les messages</p> </li> <li> <p>le Logger de Civicrm (<code>CRM_Core_Error_Log</code>) : l'acc\u00e8s \u00e0 ce Logger suppose la pr\u00e9sence de CiviCRM. Un helper a \u00e9t\u00e9 pr\u00e9par\u00e9 pour acc\u00e9der \u00e0 ce logger : <code>CRM_Civiparoisse_Utils_Logger::getLogger</code> :</p> </li> </ul> <pre><code> /**\n   * General Purpose CiviCRM logger (psr_log)\n   * @return LoggerInterface\n   */\n  public static function getLogger(): LoggerInterface\n  {\n    return (Container::singleton()-&gt;get('psr_log'));\n  }\n</code></pre> <ul> <li>le Logger pr\u00e9sent dans <code>\\Psr\\Log\\NullLogger</code> : ce logger fait parti du package Composer psr/log, et fait partie des d\u00e9pendances requises par le parseur. Son int\u00e9r\u00eat est qu'il ne fait rien, donc ne va pas effectuer des logs, et permet de garder une sortie \u00e9cran \"propre\" pour voir ce qui a \u00e9t\u00e9 pars\u00e9.</li> </ul> <p>A l'occasion des parsages, on fera en particulier attention si les dates correspondent, et si le nombre d'enregistrement est juste. Le parsage est fait en \"Best Effort\" : une valeur qui n'est pas valid\u00e9e par les contr\u00f4les du syst\u00e8me sera ignor\u00e9e.</p>"},{"location":"TECHNIQUE/LOGICIEL/importation.html#importation","title":"Importation","text":"<p>L'importation est r\u00e9alis\u00e9e \u00e9galement en ligne de commande.</p> <pre><code>#!/bin/bash\n#export PHP_IDE_CONFIG=\"serverName=civicrm.test\"\nexport CIVIPAROISSE_IMPORT_FILEPATH=\"/app/test2.ods\"\nexport CIVIPAROISSE_IMPORT_SHEETNAME=\"Feuil1\"\ncv ev -U drupaladmin 'CRM_Civiparoisse_Import_Importer::parseImport(CRM_Civiparoisse_Utils_Logger::getLogger())'\n</code></pre> <p>Si on consid\u00e8re un syst\u00e8me fra\u00eechement install\u00e9, un moyen qui semble \u00eatre assez efficace pour effacer une importation est de supprimer l'ensemble des contacts dont l'ID est strictement sup\u00e9rieur \u00e0 2, en n'utilisant pas la corbeille (trash). Ceci peut \u00eatre r\u00e9alis\u00e9 depuis l'explorateur d'API v4, depuis les menus de CiviCRM.</p> <p>On peut v\u00e9rifier les r\u00e9sultats de l'importation de plusieurs mani\u00e8res :</p> <ul> <li>analyser l'ex\u00e9cution de l'import via Xdebug et un IDE</li> <li>analyser le contenu de la BD via MySQL</li> <li>analyser le contenu de la BD via des appels API</li> <li>analyser le contenu de la BD depuis l'interface web de civicrm</li> </ul>"},{"location":"TECHNIQUE/MAIL/index.html","title":"Mail","text":"<ul> <li>Probl\u00e9matique des mails</li> <li>Ecosyst\u00e8me</li> <li>Image sp\u00e9cialis\u00e9e d'envoi</li> <li>Image sp\u00e9cialis\u00e9e de r\u00e9ception</li> <li>Serveur mail de d\u00e9mo : Opensmtpd et Dovecot</li> </ul>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html","title":"Ecosyst\u00e8me des mails de masse","text":"<p>Les mails de masse sont des outils de communication qui sont permis et support\u00e9s par un certain nombre de techniques compl\u00e9mentaires, dont une partie d\u00e9pend de l'int\u00e9gration technique de CiviCRM, et du p\u00e9rim\u00e8tre fonctionnel retenu dans le cadre du projet. Il est donc int\u00e9ressant de faire d'abord un \u00e9tat des lieux des fonctionnalit\u00e9s natives propos\u00e9es par CiviCRM, avant de voir l'usage souhait\u00e9 et les adaptations requises.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#le-natif-existant","title":"Le natif existant","text":""},{"location":"TECHNIQUE/MAIL/ecosysteme.html#ciblage-des-destinataires-smart-groups","title":"Ciblage des destinataires : smart groups","text":"<p>Il est important que le mail soit pertinent pour ses destinataires. De ce fait, on cherchera \u00e0 identifier ces personnes en se basant sur des crit\u00e8res se basant sur les donn\u00e9es stock\u00e9es dans CiviCRM.</p> <p>Pour identifier les destinataires, une possibilit\u00e9 est de cr\u00e9er des groupes, voire des groupes dynamiques (smart groups : https://docs.civicrm.org/user/fr/latest/organising-your-data/smart-groups/). L'int\u00e9r\u00eat des groupes dynamiques est que l'on peut recalculer les destinataires, et ainsi mettre \u00e0 jour les destinataires.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#contenu-textuel-du-mail-de-masse-personnalisation","title":"Contenu textuel du mail de masse : personnalisation","text":"<p>Le mail de masse est envoy\u00e9 \u00e0 un grand nombre de personnes, ce qui est une forme de communication diff\u00e9rente que les communications d'une personne \u00e0 une unique autre ; ce sujet peut donc n\u00e9cessiter une formation sp\u00e9cifique.</p> <p>M\u00eame si le mail de masse s'adresse \u00e0 un grand nombre, un certain degr\u00e9 de personnalisation du mail peut aider \u00e0 renforcer l'int\u00e9r\u00eat du destinataire pour le mail. A cet effet, CiviCRM pr\u00e9voit un m\u00e9canisme de tokens pour injecter des donn\u00e9es personnalis\u00e9es dans les mails. On retrouve par exemple des donn\u00e9es sur l'instance CiviCRM elle-m\u00eame, mais \u00e9galement des donn\u00e9es relatives au contact (par exemple, nom, pr\u00e9nom...).</p> <p>M\u00eame si la personnalisation cherche \u00e0 renforcer le lien avec l'utilisateur, il ne faut pas oublier que les mails circulent la plupart du temps dans un format d\u00e9chiffrable au niveau d'un noeud de transport (notamment MTA ou MDA). On peut donc supposer qu'il est pr\u00e9f\u00e9rable de ne pas inclure des donn\u00e9es sensibles dans les mails. Toutefois, il est \u00e0 remarquer que des donn\u00e9es sensibles peuvent parfois \u00eatre d\u00e9duites du fait de l'envoi d'un mail sur un sujet particulier...</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#mise-en-forme-de-mails-de-masse","title":"Mise en forme de mails de masse","text":"<p>Les mails sont g\u00e9n\u00e9ralement transmissibles au niveau des mails de masse de CiviCRM peuvent \u00eatre sous deux formes :</p> <ul> <li>texte brut : dans ce mode, seul, \u00e9ventuellement, des \u00e9l\u00e9ments comme les retours \u00e0 la ligne et l'ascii-art peuvent intervenir dans la mise en forme au niveau de l'exp\u00e9diteur. Ce mode d'envoi \u00e0 l'int\u00e9r\u00eat d'\u00eatre tr\u00e8s simple, tr\u00e8s l\u00e9ger, et permet de se concentrer sur le contenu r\u00e9dactionnel, et devrait \u00eatre utilisable dans la plupart des clients mails. Toutefois, le texte brut pr\u00e9sente l'inconv\u00e9nient de ne pas v\u00e9hiculer facilement des \u00e9l\u00e9ments significatifs relatifs \u00e0 l'identit\u00e9 num\u00e9rique d'une entit\u00e9 (logo/images, charte graphique), et  ne fournit pas nativement de liens vers des \u00e9l\u00e9ments ext\u00e9rieurs qui sont utilisables par exemple pour les statistiques des mails</li> <li> <p>format html : gr\u00e2ce aux liens vers des \u00e9l\u00e9ments externes, on peut incorporer au mail des images, on peut v\u00e9hiculer dans une certaine mesure une charte graphique via des styles CSS, on peut tenter d'obtenir des statistiques d'ouverture des mails, voire m\u00eame de d\u00e9terminer les \u00e9l\u00e9ments qui ont d\u00e9clench\u00e9 le plus de clics utilisateurs dans le mail. Toutefois, le format html est difficile \u00e0 mettre en oeuvre, notamment en raison des diff\u00e9rences plus que notables de pr\u00e9sentation des mails en fonction des clients mails utilis\u00e9s (clients lourds, interface webmail, interface en mode texte pour ne citer qu'eux). Ces diff\u00e9rences ont conduit \u00e0 l'adoption de pratiques particuli\u00e8res pour chercher \u00e0 obtenir un rendu acceptable pour le plus grand nombre. On trouve des conseils sur des sites d'acteurs sp\u00e9cialis\u00e9s comme : </p> </li> <li> <p>https://www.caniemail.com/ : Can I email : ce site est le pendant pour les mails de https://caniuse.com/, et pr\u00e9sente la compatibilit\u00e9 de techniques par rapport aux clients mails</p> </li> <li>https://www.litmus.com/resources/ : Litmus</li> <li>https://www.emailonacid.com/white-papers/ : Email on Acid</li> <li>https://www.sarbacane.com/email-marketing/comment-faire : Sarbacane (peut proposer des prestations de formation)</li> <li>https://mosaico.io/ : Mosaico : logiciel d'interface utilisateur pour simplifier la mise en forme des mails, en partant de mod\u00e8les (templates) pr\u00e9con\u00e7us</li> <li>https://www.phplist.org/manual/books/phplist-manual/page/targeting-your-campaigns : phpList : choix des destinataires</li> </ul> <p>En ce qui concerne la mise en forme HTML, en plus de la litt\u00e9rature qui d\u00e9crit les pratiques employ\u00e9es par certains professionnels, on peut constater qu'il existerait des outils CSS sp\u00e9cialis\u00e9s, tels que :</p> <ul> <li>https://bootstrapemail.com/</li> <li>https://get.foundation/emails.html : Framework foundation pour les mails</li> </ul> <p>Etant donn\u00e9 la difficult\u00e9 de cr\u00e9er des mails adapt\u00e9s ex nihilo, il semble judicieux de partir d'un template (soit un fourni par Mosaico, soit un qui sera cr\u00e9e \u00e0 partir d'un framework CSS pour les mails) que l'on int\u00e8grera \u00e0 Mosaico. Le passage par Mosaico permet de fournir une interface utilisateur simplifi\u00e9e qui permet \u00e0 l'utilisateur de ne pas avoir \u00e0 \u00e9crire directement du HTML si ce n'est pas ce qu'il souhaite faire. Si un utilisateur souhaite \u00e9crire du code HTML, l'interface lui en laisse toutefois la possibilit\u00e9.</p> <p>L'utilisation de ces outils n'est toutefois pas un gage de r\u00e9ussite, car le sujet reste malgr\u00e9 tout complexe.</p> <p>Il est \u00e0 noter que les templates CiviCRM et Mosaico sont diff\u00e9rents : les templates CiviCRM peuvent contenir trois sections (header, body, footer), tandis que les templates Mosaico forcent le header et footer \u00e0 null, pour tout travailler au niveau du body.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#integration-dimages","title":"Int\u00e9gration d'images","text":"<p>L'int\u00e9gration d'images dans un mail devra tr\u00e8s probablement passer par le stockage des fichiers images sur un serveur de m\u00e9dias, accessible sans authentification. Un type d'images un peu particulier que l'on trouve dans certains mails est l'image d'un pixel transparent : l'int\u00e9r\u00eat de cette image est que si son URL est param\u00e9tr\u00e9e et personnalis\u00e9e dans chaque mail, on peut obtenir des estimations sur le nombre d'ouvertures du mail.</p> <p>Au niveau de CiviCRM, on peut sp\u00e9cifier un r\u00e9pertoire pour les fichiers d'images, ainsi qu'une URL sp\u00e9cifique. Toutefois, on a tout int\u00e9r\u00eat \u00e0 d\u00e9finir ces indications d\u00e8s l'installation, et on a int\u00e9r\u00eat \u00e0 passer ce serveur en HTTPS, en raison de l'acc\u00e8s \u00e0 CiviCRM qui devra se faire depuis HTTPS - sans quoi les navigateurs refuseront de charger les ressources.</p> <p>Etant donn\u00e9 que CiviCRM v\u00e9rifie qu'il a le droit d'acc\u00e9der au r\u00e9pertoire des images en \u00e9criture, et que l'int\u00e9gration des images concerne bien plus que les images de la gallerie de Mosaico, il est improbable de pouvoir rajouter simplement des images venant d'un serveur distant. Si l'on souhaite int\u00e9grer des images venant de serveur tiers, il faudra int\u00e9grer manuellement les images via du code HTML.</p> <p>Toutefois, on peut comprendre l'approche de consid\u00e9rer que les images sont stock\u00e9es sur le serveur local : en effet, les images peuvent \u00eatre redimenssionn\u00e9es par rapport \u00e0 leur taille d'utilisation, en tenant compte d'\u00e9lements tels que la configuration li\u00e9e aux \u00e9crans de type Retina, qui demandent des r\u00e9solutions plus \u00e9lev\u00e9es.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#urls-relatives-aux-mails","title":"URLs relatives aux mails","text":"<p>On retrouve plusieurs types d'URLs qui vont avoir trait aux mails :</p> <ul> <li>url vers un pixel transparent pour les statistiques</li> <li>urls d'action (unsubscribe, optout,resubscribe, welcome...)</li> <li>url de ressources tierces (images notamment)</li> <li>urls de redirection vers des contenus (avec comptabilisation des actions)</li> </ul> <p>Certaines de ces URL vont avoir des \u00e9l\u00e9ments sp\u00e9cifiques dans leur query string : des checksums et des informations sur des envent_queue. </p> <pre><code>mysql&gt; describe civicrm_mailing_event_queue;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int unsigned | NO   | PRI | NULL    | auto_increment |\n| job_id     | int unsigned | NO   | MUL | NULL    |                |\n| email_id   | int unsigned | YES  | MUL | NULL    |                |\n| contact_id | int unsigned | NO   | MUL | NULL    |                |\n| hash       | varchar(255) | NO   | MUL | NULL    |                |\n| phone_id   | int unsigned | YES  | MUL | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n6 rows in set (0.02 sec)\n</code></pre>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#sommes-de-controle","title":"Sommes de contr\u00f4le","text":"<p>On retrouve plusieurs types de sommes de contr\u00f4le, qui sont li\u00e9s \u00e0 des \"hashs\". M\u00eame si les valeurs sont appel\u00e9es hashs, ce ne sont pas forc\u00e9ment des hashs, plut\u00f4t des valeurs plus ou moins al\u00e9atoires. Un but de ces sommes de contr\u00f4le est de se prot\u00e9ger dans une certaine mesure de la forge d'URLs.</p> <ul> <li> <p>hash sur un contact : ce champ peut \u00eatre utilis\u00e9 dans le cadre d'un checksum, dans la cr\u00e9ation d'une signature \"fa\u00e7on HMAC\", qui inclut en particulier le hash (secret), l'id du contact, l'heure de signature, et la dur\u00e9e de validit\u00e9 du checksum. Le hash \u00e9tant secret, et les autres valeurs \u00e9tant donn\u00e9es dans la query string, il est possible de recalculer le hash et de v\u00e9rifier si les champs entrant en jeu dans la signature ont \u00e9t\u00e9 alt\u00e9r\u00e9s</p> </li> <li> <p>hash sur un mailing : ce champ est parfois rajout\u00e9 directement dans une URL pour confirmer/remplacer l'identit\u00e9 du mailing que l'on souhaite acc\u00e9der : le hash \u00e9tant une valeur al\u00e9atoire, il y a certes un risque de collision, mais cette mani\u00e8re de faire permet d'\u00e9viter de pouvoir boucler sur des mails</p> </li> <li> <p>hash sur un event queue : il incluerait le job_id, le contact_id et l'email_id, auquel on concat\u00e8ne le temps (fonction time()). Etant donn\u00e9 que le temps n'est pas sauvegard\u00e9, on ne peut pas recalculer cette somme de contr\u00f4le. On peut en revanche v\u00e9rifier selon le stockage si c'est bien la valeur attendue, de mani\u00e8re analogue au hash de mailing.</p> </li> </ul> <p>On constate donc qu'un champ de m\u00eame nom peut \u00eatre utilis\u00e9 diff\u00e9remment en fonctions des tables. C'est un \u00e9l\u00e9ment quelque peu d\u00e9routant.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#informations-sur-lacces-au-contenu-lie","title":"Informations sur l'acc\u00e8s au contenu li\u00e9","text":"<p>CiviCRM dispose nativement de la possibilit\u00e9 de remplacer des URL d'\u00e9l\u00e9ments par des redirections g\u00e9n\u00e9r\u00e9es et stock\u00e9es en local. L'int\u00e9r\u00eat de cette technique est que l'on peut ainsi obtenir une sorte de retour sur les \u00e9l\u00e9ments qui fonctionnent dans un mail.</p> <pre><code>mysql&gt; describe civicrm_mailing_trackable_url;\n+------------+--------------+------+-----+---------+----------------+\n| Field      | Type         | Null | Key | Default | Extra          |\n+------------+--------------+------+-----+---------+----------------+\n| id         | int unsigned | NO   | PRI | NULL    | auto_increment |\n| url        | text         | NO   |     | NULL    |                |\n| mailing_id | int unsigned | NO   | MUL | NULL    |                |\n+------------+--------------+------+-----+---------+----------------+\n3 rows in set (0.01 sec)\n\nmysql&gt; describe civicrm_mailing_event_trackable_url_open;\n+------------------+--------------+------+-----+-------------------+-------------------+\n| Field            | Type         | Null | Key | Default           | Extra             |\n+------------------+--------------+------+-----+-------------------+-------------------+\n| id               | int unsigned | NO   | PRI | NULL              | auto_increment    |\n| event_queue_id   | int unsigned | NO   | MUL | NULL              |                   |\n| trackable_url_id | int unsigned | NO   | MUL | NULL              |                   |\n| time_stamp       | timestamp    | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |\n+------------------+--------------+------+-----+-------------------+-------------------+\n4 rows in set (0.01 sec)\n</code></pre>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#mailing-automation","title":"Mailing automation","text":"<p>Le mailing automation est une fonctionnalit\u00e9 qui permet de d\u00e9clencher des mails (r\u00e9ponses \u00e0 des \u00e9v\u00e8nements). La source de l'\u00e9v\u00e8nement peut \u00eatre un mail de retour avec des champs VERP, ou la consultation d'une URL sp\u00e9cifique. CiviCRM peut alors envoyer un mail particulier en r\u00e9ponse \u00e0 l'\u00e9v\u00e8nement, en fonction de sa configuration. Des templates sp\u00e9cifiques sont pr\u00e9vus en fonction des cas.</p> <p>Dans <code>CRM_Core_SelectValues</code> :</p> <pre><code>  public static function mailingComponents() {\n    return [\n      'Header' =&gt; ts('Header'),\n      'Footer' =&gt; ts('Footer'),\n      'Reply' =&gt; ts('Reply Auto-responder'),\n      'OptOut' =&gt; ts('Opt-out Message'),\n      'Subscribe' =&gt; ts('Subscription Confirmation Request'),\n      'Welcome' =&gt; ts('Welcome Message'),\n      'Unsubscribe' =&gt; ts('Unsubscribe Message'),\n      'Resubscribe' =&gt; ts('Resubscribe Message'),\n    ];\n  }\n</code></pre> <p>Et \u00e9galement dans <code>CRM_Core_SelectValues</code> :</p> <pre><code>  public static function mailingTokens() {\n    return [\n      '{action.unsubscribe}' =&gt; ts('Unsubscribe via email'),\n      '{action.unsubscribeUrl}' =&gt; ts('Unsubscribe via web page'),\n      '{action.resubscribe}' =&gt; ts('Resubscribe via email'),\n      '{action.resubscribeUrl}' =&gt; ts('Resubscribe via web page'),\n      '{action.optOut}' =&gt; ts('Opt out via email'),\n      '{action.optOutUrl}' =&gt; ts('Opt out via web page'),\n      '{action.forward}' =&gt; ts('Forward this email (link)'),\n      '{action.reply}' =&gt; ts('Reply to this email (link)'),\n      '{action.subscribeUrl}' =&gt; ts('Subscribe via web page'),\n      '{mailing.key}' =&gt; ts('Mailing key'),\n      '{mailing.name}' =&gt; ts('Mailing name'),\n      '{mailing.group}' =&gt; ts('Mailing group'),\n      '{mailing.viewUrl}' =&gt; ts('Mailing permalink'),\n    ] + self::domainTokens();\n  }\n</code></pre>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#lusage-et-les-adaptations-pour-civiparoisse","title":"L'usage et les adaptations pour Civiparoisse","text":"<p>Une caract\u00e9ristique fondamentale de Civiparoisse est que l'ensemble des acc\u00e8s au coeur du syst\u00e8me sont authentifi\u00e9s. Cette caract\u00e9ristique doit perdurer pour que le syst\u00e8me reste conceptuellement simple. Or, on constate que les interactions entre les mails et l'environnement sont potentiellement fortes, ce qui complique les choses. Des compromis doivent donc \u00eatre trouv\u00e9s.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#lusage-specifique-des-mails-de-masse","title":"L'usage sp\u00e9cifique des mails de masse","text":"<p>La mise en oeuvres de mails de masse est diff\u00e9rente des mails envoy\u00e9s de personne \u00e0 personne, et de ce fait, on peut supposer qu'une formation sp\u00e9cifique soit prodigu\u00e9e aux utilisateurs.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#les-mails-generes-multipartalternative-avec-texthtml-et-textplain","title":"Les mails g\u00e9n\u00e9r\u00e9s : multipart/alternative, avec text/html et text/plain","text":"<p>Mosaico semble fournir un int\u00e9r\u00eat pour la mise en oeuvre des mails, car il limite les risques de casse involontaire des mails. Il semble donc int\u00e9ressant de privil\u00e9gier l'utilisation de cet outil.</p> <p>Les mails qui sont g\u00e9n\u00e9r\u00e9s par le syst\u00e8me sont d\u00e9j\u00e0 pr\u00e9vus pour \u00eatre \u00e0 la fois en html et en text/plain. De son c\u00f4t\u00e9, un Mail User Agent va privil\u00e9gier l'affichage d'un seul rendu (celui qu'il est sens\u00e9 comprendre, de plus grande pr\u00e9f\u00e9rence), et l'utilisateur n'est pas forc\u00e9ment au courant qu'il dispose dans le mail de plusieurs versions du contenu, dont une en texte brut. Au lieu de faire un lien vers une page web, il serait plus int\u00e9ressant de faire remarquer \u00e0 l'utilisateur que s'il a du mal \u00e0 lire le mail, qu'il cherche \u00e0 changer de source de message, ou d'afficher la source du mail (puisqu'une version est du texte brut).</p> <p>En revanche, il conviendra \u00e9ventuellement de laisser l'utilisateur pr\u00e9parer manuellement la version textuelle du mail, car cette version simplifi\u00e9e ne correspond pas forc\u00e9ment \u00e0 la version graphique, pour que le mail reste le plus lisible possible. </p> <p>On devra donc adapter les interfaces de l'adaptateur de mosaico \u00e0 cet effet.</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#les-images-stockees-sur-un-serveur-tiers","title":"Les images : stock\u00e9es sur un serveur tiers","text":"<p>La philosophie de l'adaptateur de Mosaico est de stocker les images sur le serveur local, en g\u00e9n\u00e9rant des versions \u00e0 des tailles adapt\u00e9es aux mails g\u00e9n\u00e9r\u00e9s. On comprend donc l'int\u00e9r\u00eat de ce fonctionnement, mais il ne peut pas s'appliquer dans Civiparoisse. </p> <p>**La meilleure solution est de stocker les images sur un serveur tiers, et de d\u00e9velopper un bloc Mosaico pour cet usage, en sensibilisant les utilisateurs aux probl\u00e9matiques relatives aux images, de sorte \u00e0 ce qu'ils optimisent eux-m\u00eames les m\u00e9dias qu'ils souhaitent utiliser. **</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#tracking","title":"Tracking","text":"<p>Le tracking propos\u00e9 par CiviCRM est certes utilis\u00e9 dans le monde de l'entreprise, mais il est fait d'une mani\u00e8re quelque peu cach\u00e9e, qui est au minimum questionnable dans le cadre d'une paroisse et de ses valeurs. Il semble donc peu appropri\u00e9 d'utiliser le tracking d'ouverture du mail tel que propos\u00e9 nativement, et encore moins le tracking de contenu.</p> <p>Toutefois, des statistiques d'utilisation semblent \u00eatre les bienvenues. On se souviendra \u00e0 cette fin qu'il existe le syst\u00e8me appel\u00e9  Message Disposition Notification RFC 8098, qui peut demander des notifications par rapport au suivi du mail. Un tel retour sera probablement faible, mais il aura l'avantage d'\u00eatre plus transparent par rapport \u00e0 l'utilisateur, et pourra \u00e9ventuellement m\u00eame fournir des informations sur les Mail User Agent utilis\u00e9s.</p> <p>** Il faudra donc impl\u00e9menter la demande de notifications MDN. **</p>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#mail-automation","title":"Mail automation","text":"<p>Le mail automation permet surtout de g\u00e9n\u00e9rer une r\u00e9action suite \u00e0 un clic de lien ou \u00e0 la r\u00e9ception d'un mail ( adresse avec VERP). Pour fournir la fonctionnalit\u00e9, il semble faisable d'utiliser des liens mailto, tel que d\u00e9crit dans RFC 6068.</p> <p>Cette RFC pr\u00e9cise d'ailleurs dans son point 4 qu'on ne peut que supposer que l'utilisation des champs <code>subject</code> et <code>body</code> sera disponible. Toutefois, ceci suffit d\u00e9j\u00e0 pour inclure des informations dans l'un ou l'autre champ, de mani\u00e8re assez analogue \u00e0 ce que l'on fait pour les liens que l'on inclut dans les mails.</p> <p>Si les informations comme les sommes de contr\u00f4le sont transmises, il devient alors possible de les v\u00e9rifier (\u00e9ventuellement via des formulaires \u00e0 d\u00e9velopper) avant qu'un utilisateur de Civiparoisse effectue les actions demand\u00e9es par un tiers.</p> <p>Dans le cadre de cette fonctionnalit\u00e9, il faudrait donc d\u00e9velopper deux cat\u00e9gories d'\u00e9l\u00e9ments :</p> <ul> <li>la g\u00e9n\u00e9ration des URL mailto ad\u00e9quates</li> <li>les formulaires (admin) de v\u00e9rification des donn\u00e9es</li> </ul>"},{"location":"TECHNIQUE/MAIL/ecosysteme.html#elements-hypothetiquement-utiles-pour-le-futur","title":"El\u00e9ments hypoth\u00e9tiquement utiles pour le futur","text":"<p>Deux types d'\u00e9l\u00e9ments pourraient \u00eatre int\u00e9ressants pour le futur :</p> <ul> <li>la possibilit\u00e9 d'utiliser SMIME pour chiffrer les messages envoy\u00e9s, en utilisant la clef publique du destinataire</li> <li>la possibilit\u00e9 d'utiliser SMIME pour signer les messages envoy\u00e9s, pour que les destinataires puissent v\u00e9rifier l'authenticit\u00e9 des messages.</li> </ul> <p>Ces deux \u00e9l\u00e9ments supposent toutefois des connaissances et une sensibilisation pouss\u00e9es dont ne disposent pas actuellement la plupart des utilisateurs.</p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html","title":"R\u00e9ception de mails","text":"<p>La r\u00e9ception des mails suppose d'abord l'envoi d'un mail \u00e0 recevoir. Les mails transitent g\u00e9n\u00e9ralement par un ou plusieurs MTA avant d'arriver \u00e0 un MDA, mais avec <code>msmtp</code> il est \u00e9galement possible d'utiliser le protocole LMTP pour transmettre \u00e0 un MDA le mail directement.</p> <p>Dans le cadre de l'exp\u00e9rimentation, trois \u00e9l\u00e9ments ont \u00e9t\u00e9 mis en oeuvre :</p> <ul> <li>un client mail, qui va transmettre le mail au MDA</li> <li>un serveur MDA</li> <li>un programme de r\u00e9cup\u00e9ration des mails</li> </ul>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#client-mail","title":"Client mail","text":"<p>Un mail de test a \u00e9t\u00e9 forg\u00e9 manuellement : <pre><code>From: src@src.test\nTo: dst@dst.test\nSubject: test\n\nMessage\n</code></pre></p> <p>Comme expliqu\u00e9 en introduction, msmtp peut utiliser le protocole LMTP. Cette possibilit\u00e9 a \u00e9t\u00e9 exploit\u00e9e via une configuration ad\u00e9quate : <pre><code>defaults\naccount default\nhost dovecot\nport 24\nuser src@src.test\npassword pass\nprotocol lmtp\nlogfile -\n</code></pre></p> <p>Et l'envoi est pr\u00e9vu par une commande : <pre><code>#!/bin/bash\ncat /mail/test1.txt| msmtp -t -i -C ${MSMTPCONFIGFILE} --read-envelope-from\n</code></pre></p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#serveur-mda-imap","title":"Serveur MDA (IMAP)","text":"<p>Plusieurs serveurs ont \u00e9t\u00e9 test\u00e9s en vue d'une exp\u00e9rimentation en approche \"quick and dirty\". Cette approche a \u00e9t\u00e9 pr\u00e9f\u00e9r\u00e9e pour le moment car il n'est pas s\u00fbr que le fonctionnement s\u00e9par\u00e9 de CiviCRM sera r\u00e9ellement int\u00e9gr\u00e9, et d'autre part, le serveur IMAP est typiquement un \u00e9l\u00e9ment fourni par un provider tiers. Le gros de l'effort n'\u00e9tait donc a priori pas \u00e0 fournir sur ce sujet.</p> <p>Pourtant, la s\u00e9lection d'un serveur MDA a n\u00e9cessit\u00e9 plus de temps qu'envisag\u00e9 a priori :</p> <ul> <li>le premier serveur test\u00e9 est <code>localmail</code> : \u00e9crit en python, il propose une bo\u00eete mail unique, sans mot de passe, avec un support de SMTP et d'IMAP. Le probl\u00e8me rencontr\u00e9 avec ce serveur est que le client de r\u00e9cup\u00e9ration de mails (fetchmail) d\u00e9tectait une diff\u00e9rence de taille entre les tailles annonc\u00e9es et les flux transmis</li> <li>le serveur <code>courier-imap</code> : ce serveur semblait \u00eatre un bon candidat, mais je n'ai pas trouv\u00e9 rapidement de documentation satisfaisante. Il a donc \u00e9t\u00e9 \u00e9cart\u00e9</li> <li>le serveur <code>cyrus-imap</code> : ce serveur a une documentation suffisante, mais il y a eu un probl\u00e8me sur les d\u00e9penances des librairies pour son installation via les paquets natifs de ubuntu : un probl\u00e8me sur les libraires perl, qui est un probl\u00e8me connu, lors du lancement de l'outil d'administration cyradm : https://bugs.launchpad.net/ubuntu/+source/cyrus-imapd/+bug/1971547. De ce fait, ce serveur a \u00e9t\u00e9 \u00e9galement \u00e9cart\u00e9</li> <li>le serveur <code>dovecot</code> : ce serveur dispose d'une documentation fournie, et est en plus assez intuitif au niveau de sa configuration. Ubuntu propose d'ailleurs des fichiers de configuration suffisamment comment\u00e9s pour pouvoir faire une configuration rapide. Cerise sur le g\u00e2teau, dovecot fournit une image Docker pour les exp\u00e9rimentations : https://hub.docker.com/r/dovecot/dovecot/. N\u00e9anmoins, la compilation d'une image modifi\u00e9e, depuis les sources https://github.com/dovecot/docker a \u00e9t\u00e9 requise, en se basant sur la version 2.3.19.1, \u00e0 cause de l'architecture mat\u00e9rielle utilis\u00e9e pour les tests (armhf) : il s'agissait donc d'utiliser uniquement les paquets pr\u00e9vus par la distribution Debian (celle utilis\u00e9e dans le FROM du Dockerfile) pour avoir des packages disponibles vis \u00e0 vis de l'architecture armhf : mise en commentaire : </li> </ul> <p><pre><code>#ADD dovecot.gpg /etc/apt/trusted.gpg.d\n#ADD dovecot.list /etc/apt/sources.list.d\n</code></pre> et modification du nom de package <code>dovecot-lua</code> en <code>dovecot-auth-lua</code>.</p> <p>Cette image est fonctionnelle, et propose une configuration qui accepte les comptes avec le mot de passe \"pass\", et propose notamment un support LMTP et IMAP. La configuration a \u00e9t\u00e9 modifi\u00e9e pour autoriser rapidement l'authentification en texte clair (\u00e0 ne pas utiliser en production :ajout de <code>disable_plaintext_auth=no</code> dans dovecot.conf). Ce serveur a fait le travail attendu lors des tests.</p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#maildirfetcher","title":"Maildirfetcher","text":"<p>Le travail consiste ensuite \u00e0 r\u00e9cup\u00e9rer les mails et \u00e0 les mettre \u00e0 disposition dans un dossier Maildir. A cette fin, il faut :</p> <ul> <li>initialiser un dossier Maildir et les d\u00e9pendances : outil <code>maildirmake</code></li> <li>r\u00e9cup\u00e9rer les mails : outil <code>fetchmail</code></li> <li>injecter les mails dans le Maildir : outil <code>putmail</code></li> </ul> <p>Etant donn\u00e9 que fetchmail s'ex\u00e9cutera comme un \"service\", il est pr\u00e9f\u00e9rable qu'il ne soit pas ex\u00e9cut\u00e9 avec les droits root, mais avec un compte inf\u00e9rieur. Il faut donc prendre en compte cette particularit\u00e9 dans les scripts.</p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#initialisation-du-dossier-de-maildir-et-dossiers-dependants","title":"Initialisation du dossier de Maildir et dossiers d\u00e9pendants","text":"<p>Maildrop est fourni avec un outil <code>maildirmake</code> qui permet de cr\u00e9er un dossier Maildir. Une subtitlit\u00e9 a toutefois \u00e9t\u00e9 mise en oeuvre : pour r\u00e9gler des probl\u00e8mes de mise en oeuvre des droits, le dossier a \u00e9t\u00e9 cr\u00e9e avec les droits roots, et les permissions ont ensuite \u00e9t\u00e9 sett\u00e9es, ce afin de ne pas avoir \u00e0 donner des permissions d'\u00e9critures au niveau parent - ce qui peut \u00eatre particuli\u00e8rement emb\u00eatant par rapport \u00e0 des r\u00e9pertoires de montage de volumes.</p> <p>De m\u00eame, fetchmail n\u00e9cessite un dossier avec droits d'\u00e9criture pour les fichiers d'ID : ce dossier a \u00e9t\u00e9 pr\u00e9vu dans un sous-dossier d'un volume mont\u00e9.</p> <p>Enfin, fetchmail pr\u00e9voit \u00e9galement d'\u00e9crire son pid dans un fichier : \u00e9tant donn\u00e9 que ce contenu d\u00e9pend fondamentalement du conteneur d'ex\u00e9cution, le plus simple est de le stocker dans /tmp.</p> <p>On arrive donc \u00e0 un script d'initialisation des volumes, ex\u00e9cut\u00e9 en root, semblable \u00e0 :</p> <p><pre><code>#!/bin/bash\nif [[ ! (-n `find /MAILDIR -maxdepth 0 -type d -empty `) ]]\n  then\n   echo \"Already initialized\"\n   exit 0;\nfi\nmaildirmake /MAILDIR/Maildir\nmkdir /IDFILES/idfiles\nchown -R www-data:www-data /IDFILES/idfiles\nchmod 700 /IDFILES/idfiles\nchown -R www-data:www-data /MAILDIR/Maildir\n</code></pre> Le test a \u00e9t\u00e9 repris des scripts de l'image init.</p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#fetchmail","title":"Fetchmail","text":"<p>Fetchmail permet de r\u00e9cup\u00e9rer les mails via des protocoles tels que IMAP ou POP et peut les envoyer autre part, par exemple via SMTP, ou m\u00eame vers un Mail Delivery Agent (MDA).</p> <p>Comme pr\u00e9cis\u00e9 auparavant, fetchmail est ex\u00e9cut\u00e9 via des droits restreints. On en arrive donc \u00e0 un script quelque peu particulier pour la commande \u00e0 ex\u00e9cuter dans le container :</p> <p><pre><code>#!/bin/bash\n/exec/initializer.sh\nsudo -u www-data -E /exec/mailfetcher.sh\n</code></pre> Le param\u00e8tre <code>-E</code> permet de transmettre l'ensemble des variables d'environnement, et ce, de mani\u00e8re non modifi\u00e9e. L'int\u00e9r\u00eat de cette pratique est que l'on r\u00e9cup\u00e8re l'ensemble des variables d'environnement qui ont \u00e9t\u00e9 sett\u00e9es pour le container, mais l'inconv\u00e9nient est que des variables comme HOME ne sont pas sett\u00e9s avec l'utilisateur qui ex\u00e9cute les commandes. Du coup, il faut se m\u00e9fier lors des appels \u00e0 des fichiers, car ils pourraient facilement chercher \u00e0 acc\u00e9der (sans succ\u00e8s, normalement) au contenu de <code>/root</code>. A noter qu'on aurait \u00e9galement pu pr\u00e9ciser la liste des variables d'environnement \u00e0 transmettre, mais ceci signifierait que cette liste devrait \u00e9galement \u00eatre maintenue dans le temps. Il n'y a donc pas de solution parfaite ici.</p> <p>En ce qui concerne le script d'ex\u00e9cution de fetchmail :</p> <p><pre><code>#!/bin/bash\necho ${FETCHMAILCONFIGFILE}\nfetchmail -vvv --nodetach  -f ${FETCHMAILCONFIGFILE} -i /IDFILES/idfiles/idfile --pidfile /tmp/fetchmail.pid --norewrite --mda \"/exec/putmail.sh\"\n</code></pre> Les \u00e9l\u00e9ments qui doivent \u00eatre prioritaires et prendre le dessus par rapport au contenu du fichier de configuration sont indiqu\u00e9s directement sur la ligne de commande : il s'agit des r\u00e9glages pour les chemins, le fait que fetchmail doit \u00eatre \"transparent\" (<code>norewrite</code>), et surtout le for\u00e7age de la valeur de <code>--mda</code> pour ex\u00e9cuter putmail.</p> <p>Le fichier de configuration contient les \u00e9l\u00e9ments qui permettront d'acc\u00e9der au serveur IMAP. Pour le test, le fichier est :</p> <pre><code>set daemon 60\npoll dovecot protocol IMAP service 143:\n    username \"dst@dst.test\" there password \"pass\" keep sslproto ''\n</code></pre> <p>La premi\u00e8re ligne permet d'indiquer le fonctionnement en mode daemon, avec un d\u00e9lai de 60 secondes entre les r\u00e9cup\u00e9rations de courier. La ligne poll contient les options qui sont relatives au serveur de mail \u00e0 acc\u00e9der : nom d'h\u00f4te, protocole, port.</p> <p>Fetchmail est particuli\u00e8rement exigeant au niveau des options de poll : il exige que toutes les options relatives au serveur soient indiqu\u00e9es avant toute option relative \u00e0 l'utilisateur ou aux utilisateurs (sans quoi une erreur de syntaxe est souvent d\u00e9clench\u00e9e). Cette exigence de syntaxe n\u00e9cessite bien souvent de se r\u00e9f\u00e9rer \u00e0 la page de manuel, car il est parfois d\u00e9licat de bien identifier ce qui rel\u00e8ve du serveur et ce qui rel\u00e8ve de l'utilisateur.</p> <p>Au niveau de l'utilisateur, on sp\u00e9cifie le nom d'utilisateur distant le <code>there</code> et le mot de passe. L'option <code>keep</code> garde les mails sur le serveur distant, tandis que l'option <code>sslproto ''</code> a permis de d\u00e9sactiver l'emploi du SSL pour le maquettage. L'option <code>fetchall</code> a d\u00fb \u00eatre supprim\u00e9e de la configuration : elle d\u00e9clenchait le ret\u00e9l\u00e9chargement des messages qui \u00e9taient d\u00e9j\u00e0 pr\u00e9sents, ce qui n'\u00e9tait pas \u00e9vident par rapport au manuel.</p> <p>Lors d'une int\u00e9gration Kubernetes, on pourra \u00eatre tent\u00e9 de passer le set daemon en option de ligne de commande. Une autre approche pourrait \u00eatre l'ex\u00e9cution via cronjob Kubernetes, ce qui supprimerait l'utilisation du mode daemon.</p>"},{"location":"TECHNIQUE/MAIL/fetchmail.html#putmail","title":"Putmail","text":"<p>Le MDA s\u00e9lectionn\u00e9 est livr\u00e9 avec le package <code>mailutils-mda</code> : il s'agit de putmail. Il recoit via <code>STDIN</code> le mail \u00e0 stocker, et l'int\u00e8gre dans le Maildir fourni en param\u00e8tre. Etant donn\u00e9 que putmail est appel\u00e9 par fetchmail, ses droits d'ex\u00e9cution sont \u00e9galement restreints.</p> <p>On n'utilise pas de configuration particuli\u00e8re pour putmail : il n'y a donc pas besoin de chercher dans $HOME pour des pr\u00e9f\u00e9rences, $HOME qui pourrait encore \u00eatre sett\u00e9 \u00e0 /root si l'on reprend tel quel les variables d'environnement initiales du container. Donc autant ne pas tenter de charger des pr\u00e9f\u00e9rences : option <code>--no-config</code></p> <p>Script lanc\u00e9 par fetchmail : putmail.sh : </p> <pre><code>#!/bin/bash\nputmail --no-config /MAILDIR/Maildir\nexit $?\n</code></pre>"},{"location":"TECHNIQUE/MAIL/mail.html","title":"Probl\u00e9matique des mails","text":"<p>La probl\u00e9matique des mails est multiple dans Civiparoisse :</p> <ul> <li>des mails peuvent \u00eatre envoy\u00e9s vers un seul destinataire \u00e0 travers l'interface de Civiparoisse</li> <li>des mails de masse peuvent \u00eatre envoy\u00e9s vers une multitude de destinataires</li> <li>des mails de bounce peuvent \u00eatre re\u00e7us.</li> </ul> <p>Pour pr\u00e9server l'image de marque des paroisses, il est important de s'assurer qu'une attaque qui prendrait le contr\u00f4le de Civiparoisse (au niveau CiviCRM) ne puisse que difficilement avoir acc\u00e8s aux identifiants de mails : d'o\u00f9 l'utilisation de m\u00e9canismes d'envoi/r\u00e9ceptions indirects en lieu et place des possibilit\u00e9s offertes directement par CiviCRM.</p> <p>L'envoi et de r\u00e9ceptions de mails utilisent des protocoles (et par conns\u00e9quent des logiciels) diff\u00e9rents, quoique compl\u00e9mentaires :</p> <ul> <li>le protocole SMTP est utilis\u00e9 lors de l'envoi d'un mail depuis un MUA (Mail User Agent), et de la transmission du mail jusqu'\u00e0 sa destination finale</li> <li>diff\u00e9rents enregistrements DNS (dont les enregistrements MX et TXT pour DKIM) sont mis en oeuvre pour d\u00e9terminer les cibles d'acheminements du mail</li> <li>le protocole LMTP peut \u00eatre utilis\u00e9 pour transf\u00e9rer un mail du MTA (Mail Transfer Agent) au MDA (Mail Delivery Agent)</li> <li>un MUA peut soit attaquer directement une bo\u00eete mail locale (par exemble au format mbox ou maildir) ou on peut r\u00e9cup\u00e9rer avec d'autres protocoles comme IMAP le contenu de la bo\u00eete.</li> </ul> <p>Il y a donc lieu de voir en voir en d\u00e9tail les deux probl\u00e9matiques.</p> <ul> <li>envoi de mail</li> <li>r\u00e9cup\u00e9ration de mail avec consultation maildir</li> <li>plateform de test : opensmtpd et dovecot</li> </ul>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html","title":"Container de test : opensmtpd et dovecot","text":"<p>La d\u00e9cision de simplification des infrastructures a fait que l'approche retenue n'est pas la sp\u00e9cialisation des mails au travers de containers d\u00e9di\u00e9s \u00e0 la r\u00e9ception et \u00e0 l'envoi, mais l'utilisation directe des containers httpd et cron pour r\u00e9aliser ces fonctions.</p> <p>Ceci entra\u00eene qu'il est bon de disposer d'un environnement de test o\u00f9 l'on peut simuler l'envoi et la r\u00e9ception des mails de mani\u00e8re approchante \u00e0 la r\u00e9alit\u00e9. Un container a \u00e9t\u00e9 r\u00e9alis\u00e9 \u00e0 ces fins, en utilisant supervisor, opensmtpd et dovecot :</p> <ul> <li>supervisor est un programme permet de g\u00e9rer le lancement de plusieurs programmes/services, en s'occupant en plus de journaliser les sorties (standard et d'erreur) des programmes. Il peut \u00eatre configur\u00e9 pour relancer les programmes s'ils s'arr\u00eatent</li> <li>opensmtpd est un MTA qui doit s'occuper de r\u00e9cup\u00e9rer les mails via le protocole SMTP, et de le transmettre ensuite au MDA</li> <li>dovecot est le MDA : on peut utiliser l'utilitaire <code>dovecot-lda</code> livr\u00e9 avec dovecot pour int\u00e9grer les mails entrants dans les boites mails des utilisateurs</li> <li>un client mail (MUA) est \u00e9galement n\u00e9cessaire : mutt a \u00e9t\u00e9 utilis\u00e9 \u00e0 cet effet, \u00e9tant donn\u00e9 qu'il est utilisable en interface texte, ce qui simplifie son int\u00e9gration dans le m\u00eame container.</li> </ul> <p>Quelques remarques :</p> <p>Danger</p> <ul> <li>le container cr\u00e9e n'a pas du tout vocation \u00e0 passer en production : il n'est pr\u00e9vu que pour de l'exp\u00e9rimentation : en particulier, les aspects de s\u00e9curit\u00e9 n'ont pas \u00e9t\u00e9 trait\u00e9s dans ce container, et les configurations n'ont pas \u00e9t\u00e9 affin\u00e9es : le but \u00e9tait d'avoir une maquette fonctionnelle mais sommaire</li> </ul> <ul> <li>un autre MTA a \u00e9t\u00e9 envisag\u00e9 : msmtpd, qui est int\u00e9gr\u00e9 dans les versions r\u00e9centes de msmtp (n\u00e9cessit\u00e9 de passer par la compilation du code source dans certaines distributions) : toutefois, l'analyse du code et de captures de trames a montr\u00e9 un probl\u00e8me de communication etnre mutt et msmtpd en SMTP, avec l'authentification PLAIN (https://www.rfc-editor.org/rfc/rfc4616) : la RFC pr\u00e9voit trois champs dans l'authentification :l'identit\u00e9 optionnelle d'autorisation, l'identit\u00e9 d'authentification et le mot de passe. Mutt envoie les trois champs, alors que msmtpd, dans le code source consult\u00e9, pr\u00e9voierait que le champ de l'identit\u00e9 d'autorisation devrait \u00eatre vide, ce qui emp\u00eache l'authentification d'\u00eatre valid\u00e9e par le serveur.</li> </ul>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#but","title":"But","text":"<p>Le but de l'exp\u00e9rimentation est de :</p> <ul> <li>disposer d'un compte SMTP pour l'envoi de mail, avec des identifiants distincts des identifiants IMAP</li> <li>disposer de deux comptes IMAP pour la r\u00e9ception des mails</li> <li>disposer du support TLS.</li> </ul> <p>Ces conditions refl\u00e8tent donc dans une certaine mesure les conditions r\u00e9elles, o\u00f9 l'on aura un provider de mail qui va fournir l'h\u00e9bergement du compte mail avec support IMAP et SMTP d'une part, et un provider d'envoi de mails de masse qui va supporter l'envoi de mails en masse pour le compte mail en question. Les mots de passe des deux providers seront donc diff\u00e9rents.</p> <p>Les noms des utilisateurs SMTP et IMAP, ainsi que les mots de passe, ont \u00e9t\u00e9 pass\u00e9 en variables d'environnement, si l'image venait \u00e0 \u00e9voluer et augmenter en qualit\u00e9 pour pouvoir \u00eatre int\u00e9gr\u00e9e dans des clusters de d\u00e9mo.</p> <p>Danger</p> <p>Comme indiqu\u00e9 plus haut, le but \u00e9tait de faire un maquettage sommaire, tout juste fonctionnelle. L'image obtenue n'est donc pas \u00e0 d\u00e9ployer (et surtout pas en production).</p>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#dockerfile","title":"Dockerfile","text":"<pre><code>FROM ubuntu:focal\nLABEL uepal.name=\"uepal/test_msmtp_dovecot\" uepal.version=\"0.0.1\"\nENV LANG=C.UTF-8\nENV SMTP_USER=smtpuser SMTP_PASSWD=smtppass IMAP_PASSWD=imappass IMAP_USER1=imapuser1 IMAP_USER2=imapuser2\nRUN apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata\nRUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y git build-essential wget curl mc nano less telnet autoconf automake libtool-bin gettext texinfo libgnutls28-dev gnutls-bin pkg-config net-tools tcpdump mutt opensmtpd\n#RUN git clone https://git.marlam.de/git/msmtp.git /MSMTP\n#RUN cd /MSMTP &amp;&amp; autoreconf -i &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install\nRUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y supervisor supervisor-doc dovecot-core dovecot-imapd \nRUN mkdir /MUTT &amp;&amp; mkdir /KEYS\nADD server.key /KEYS\nADD server.crt /KEYS\n# RUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nRUN  groupadd -g 1000 vmail &amp;&amp; useradd -u 1000 -g 1000 vmail -d /var/vmail &amp;&amp; passwd -l vmail &amp;&amp; chown vmail:vmail /var/mail &amp;&amp; chown root:vmail /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod u+s /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod g+x /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod o-rwx /usr/lib/dovecot/dovecot-lda\nADD smtpd_standalone.conf /etc/smtpd_standalone.conf\nADD standalone.conf /etc/dovecot/standalone.conf\nADD supervisor_opensmtpd.conf /etc/supervisor/conf.d/supervisor_opensmtpd.conf\nADD supervisor_dovecot.conf /etc/supervisor/conf.d/supervisor_dovecot.conf\nADD mutt* /MUTT/\nADD smtpd.sh /\nCMD [\"supervisord\",\"-c\",\"/etc/supervisor/supervisord.conf\",\"-n\"]\n</code></pre> <p>Le Dockerfile pr\u00e9sent\u00e9 au-dessus n'est pas minimal, car il pr\u00e9sente \u00e9galement le n\u00e9cessaire pour la compilation de msmtp. Le fichier de certificat est un certificat autosign\u00e9, qui contient du SubjectAltName pour le DNS localhost et l'IP 127.0.0.1. Un utilisateur et un groupe vmails ont \u00e9t\u00e9 rajout\u00e9s pour pouvoir utiliser smtpd avec un compte non root pour l'envoi des mails. De plus, le groupe vmail est positionn\u00e9 sur l'utilitaire dovecot-lda avec le bit SUID et l'owner root pour r\u00e9gler rapidement les probl\u00e8mes de droits \u00e9voqu\u00e9s dans la documentation de dovecot-lda (https://doc.dovecot.org/configuration_manual/protocols/lda/). Un autre type de solution aurait \u00e9t\u00e9 de passer par le protocole LMTP.</p>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#supervisor","title":"Supervisor","text":"<p>La configuration de supervisor dans Ubuntu est relativement simple, car Ubuntu pr\u00e9voit d'inclure les fichiers de <code>/etc/supervisor/conf.d</code> dans sa configuration. En compl\u00e9ment du daemon supervisord, on dispose \u00e9galement de l'utilitaire supervisorctl, qui est tr\u00e8s pratique pour relire la configuration de supervisor et red\u00e9marrer un service.</p> <p>En ce qui concerne les fichiers ajout\u00e9s :</p> <ul> <li>d\u00e9marrage de dovecot :</li> </ul> <pre><code>[program:dovecot]\ncommand=/usr/sbin/dovecot -F -c /etc/dovecot/standalone.conf\nenvironment=IMAP_USER1=%(ENV_IMAP_USER1)s,IMAP_USER2=%(ENV_IMAP_USER2)s,IMAP_PASSWD=%(ENV_IMAP_PASSWD)s\n</code></pre> <p>La partie environnement n'est toutefois pas n\u00e9cessaire. En effet, supervisor passe par d\u00e9faut l'environnement aux processus qu'il contr\u00f4le. Il est toutefois possible de modifier l'environnement comme on le voit au-dessus (m\u00eame si ici, ces modifications ne servent en fait \u00e0 rien). Il est toutefois remarquable que l'environnement dans le processus Dovecot appara\u00eet comme vide dans le fichier <code>/proc/&lt;pid&gt;/environ</code> - ce qui a caus\u00e9 les recherches sur l'environnement lors du d\u00e9buggage.</p> <ul> <li>d\u00e9marrage de opensmtpd :</li> </ul> <pre><code>[program:smtpd]\ncommand=/smtpd.sh\n</code></pre> <ul> <li>Fichier smtpd.sh :</li> </ul> <pre><code>#!/bin/bash\nset -xev\necho -e \"${SMTP_USER}\\t`smtpctl encrypt ${SMTP_PASSWD}`\" &gt;/KEYS/smtp_passwd\necho -e \"${IMAP_USER1}@test.test\\t${IMAP_USER1}\" &gt;/KEYS/vusers\necho -e \"${IMAP_USER2}@test.test\\t${IMAP_USER2}\" &gt;/KEYS/vusers\necho -e \"${IMAP_USER1}\" &gt;/KEYS/users\necho -e \"${IMAP_USER2}\" &gt;&gt;/KEYS/users\n\nexec /usr/sbin/smtpd -d -f /etc/smtpd_standalone.conf -v\n</code></pre> <p>Ce fichier montre une technique d'initialisation en passant par un script shell, qui va se terminer par une commande exec pour remplacer le shell par le dernier programme qui va \u00eatre utilis\u00e9. Cette m\u00e9thode est souvent utilis\u00e9e dans les fichiers de point d'entr\u00e9e des containers Docker.</p> <p>OpenSMTPD utilise des fichiers de tables, avec du format <code>clefTABvaleur</code>. Le fichier <code>/KEYS/smtp_passwd</code> est utilis\u00e9 pour le stockage des mots de passe reconnus ar OpenSMTPD ; il semblerait qu'il soit n\u00e9cessaire de passer par des fichiers pour pouvoir utiliser <code>smtpctl</code> pour effectuer le chiffrement du mot de passe, car OpenSMTPD ne semble pas accepter les mots de passe non chiffr\u00e9s dans une table directement \u00e9crite dans le fichier de configuration d'OpenSMTPD.</p> <p>Le fichier <code>/KEYS/vusers</code> est un fichier pour g\u00e9n\u00e9rer une liste d'alias, ou plut\u00f4t contient la correspondance entre adresse et mail et utilisateur virtuel (non syst\u00e8me) pour dovecot.</p> <p>Le fichier <code>/KEYS/users</code> n'est pas utilis\u00e9.</p>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#opensmtpd","title":"OpenSMTPD","text":"<ul> <li>le passage par le code d'OpenSMTPD a \u00e9t\u00e9 \u00e9galement utile, notamment pour comprendre un probl\u00e8me de configuration li\u00e9 \u00e0 l'utilisation du compte root (code sp\u00e9cifique / limitations dans certains cas lorsque l'uid 0 est utilis\u00e9e)</li> <li>OpenSMTPD connait un probl\u00e8me au niveau du support SSL dans la Ubuntu 22.04, avec OpenSSL 3.0 : https://github.com/OpenSMTPD/OpenSMTPD/issues/1171 . Ce probl\u00e8me a n\u00e9cessit\u00e9 de repasser en Ubuntu 20.04 dans le cadre de cette exp\u00e9rimentation.</li> </ul> <pre><code>smtpuser = \"smtpuser\"\nsmtppass= \"smtppass\"\npki \"localpki\" cert \"/KEYS/server.crt\" key \"/KEYS/server.key\"\n#table passwd {$smtpuser=$smtppass}\ntable passwdt \"file:/KEYS/smtp_passwd\"\ntable vusers {imapuser1=vmail,imapuser2=vmail}\ntable users \"file:/KEYS/users\"\naction \"deliv\" mda \"/usr/lib/dovecot/dovecot-lda -c /etc/dovecot/standalone.conf -d %{rcpt.user}\" virtual &lt;vusers&gt; user vmail\n\nlisten on 0.0.0.0 pki \"localpki\" tls auth &lt;passwdt&gt;\nmatch auth from any for any action \"deliv\"\n</code></pre> <p>Les deux premi\u00e8res lignes servent \u00e0 d\u00e9finir des variables qui \u00e9taient pr\u00e9vues pour l'essai de mot de passe en dur qui est comment\u00e9.</p> <p>La table vusers utilise une variante du format autoris\u00e9, o\u00f9 on ne sp\u00e9cifie que la partie avant le nom de domaine de l'adresse mail.</p> <p>La directive listen permet d'\u00e9couter sur une socket (par d\u00e9faut port 25) en pr\u00e9cisant les clefs ssl pour le starttls et la table d'authentification \u00e0 utiliser (on notera les sup\u00e9rieurs et inf\u00e9rieurs qui entourent le nom de la table et qui font partie de la syntaxe).</p> <p>La directive match permet de d\u00e9finir comment un mail sera trait\u00e9 : en l'occurence un mail qui vient d'une source authentifi\u00e9e (dans les nouvelles versions <code>auth</code> devient <code>from auth</code>) sera trait\u00e9e par l'action nomm\u00e9e <code>deliv</code>.</p> <p>L'action <code>deliv</code> utilise la m\u00e9thode mda, de sorte \u00e0 ce qu'un programme d\u00e9fini en argument soit utilis\u00e9 pour faire transiter le mail. Le programme prend le mail sur son entr\u00e9e standard (STDIN). L'indication <code>%{rcpt.user}</code> correspond \u00e0 la partie avant le nom de domaine de l'adresse mail de destination. On utilise la table <code>vusers</code> pour faire la correspondance entre adresse et un utilisateur du syst\u00e8me (cela est n\u00e9cessaire au minimum pour cette m\u00e9thode de livraison). Enfin, on sp\u00e9cifie l'utilisateur qui sera utilis\u00e9 pour ex\u00e9cuter le programme de livraison du mail.</p> <p>Lors de l'exp\u00e9rimentation, on appr\u00e9cie particuli\u00e8rement l'utilitaire <code>smtpctl</code>, qui permet notamment d'activer les traces (dont <code>smtpctl trace all</code>), voir l'\u00e9tat des files (<code>smtpctl show queue</code>) et permet de replanifier imm\u00e9diatement l'envoi des mails (<code>smtpctl schedule all</code>).</p>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#dovecot","title":"Dovecot","text":"<p>La configuration a \u00e9t\u00e9 tr\u00e8s largement reprise de https://github.com/dovecot/docker/blob/main/2.3.20/dovecot.conf</p> <ul> <li>/etc/dovecot/standalone.conf : </li> </ul> <pre><code>mail_home=/var/mail/%Lu\nmail_location=sdbox:~/Mail\nmail_uid=1000\nmail_gid=1000\nfirst_valid_uid=1000\nlast_valid_uid=1000\ndisable_plaintext_auth=no\nprotocols = imap\nssl=yes\nssl_cert = &lt;/KEYS/server.crt\nssl_key = &lt;/KEYS/server.key\npassdb {\n  driver = static\n  args = password=%{env:IMAP_PASSWD}\n}\nnamespace {\n  inbox = yes\n  separator = /\n}\nlisten = *\nimport_environment = IMAP_USER1 IMAP_USER2 IMAP_PASSWD\n</code></pre> <p>Le param\u00e8tre <code>mail_home</code> indique le r\u00e9pertoire dans lequel sera stock\u00e9 les mails. Le format <code>%Lu</code> correspond au nom d'utilisateur en minuscule (L : transformation lowercase). Le param\u00e8tre mail_location sp\u00e9cifie le format et le stockage des mails. Le format sdbox est un format sp\u00e9cifique \u00e0 dovecot.</p> <p>Les uid et gid correspondent aux valeurs utilis\u00e9es pour l'acc\u00e8s aux mails.</p> <p>On autorise dans le cadre des tests l'utilisation de l'authentification sous forme de texte, et on ne force pas mais autorise l'utilisation du SSL.</p> <p>La section <code>passdb</code> permet d'utiliser un mot de passe statique qui sera reconnu pour les comptes ; on se r\u00e9f\u00e8re \u00e0 l'environnement pour r\u00e9cup\u00e9rer la valeur du mot de passe.</p> <p>En ce qui concerne l'espace de nom, il s'agit de r\u00e9glages qui d\u00e9pendent \u00e9galement du format de la bo\u00eete de mail.</p> <p>La directive import_environment permet de sp\u00e9cifier des variables d'environnement pass\u00e9es aux processus enfants.</p>"},{"location":"TECHNIQUE/MAIL/opensmtpd_dovecot.html#mutt","title":"Mutt","text":"<ul> <li>mutt_user1.sh : script pour le lancement de mutt</li> </ul> <pre><code>#!/bin/bash\nmutt -n -F /MUTT/muttrc_user1\n</code></pre> <p>Le param\u00e8tre <code>n</code> permet de ne pas utiliser la configuration syst\u00e8me, tandis que <code>F</code> sp\u00e9cifie le fichier de configuration \u00e0 utiliser, ce qui est particuli\u00e8rement arrangeant lorsqu'on veut utiliser plusieurs configuration depuis un m\u00eame compte utilisateur syst\u00e8me.</p> <ul> <li>muttrc_user1 : fichier de configuration pour Mutt</li> </ul> <pre><code>set smtp_url = \"smtp://${SMTP_USER}:${SMTP_PASSWD}@127.0.0.1:25\"\nset spoolfile = \"imap://${IMAP_USER1}:${IMAP_PASSWD}@127.0.0.1:143/INBOX\"\nset mail_check = 60\nset realname = \"${IMAP_USER1}\"\nset from = \"${IMAP_USER1}@test.test\"\nset ssl_force_tls = no\nset ssl_starttls = yes\nset ssl_ca_certificates_file = \"/KEYS/server.crt\"\n</code></pre> <p>Le fichier de configuration supporte l'utilisation des variables d'environnement, et la plupart des param\u00e8tres sont assez transparents. En ce qui concerne l'utilisation des ports non ssl, il convient de ne pas oublier le m\u00e9canisme STARTTLS pour passer sur une communication chiffr\u00e9e - ce qui est diff\u00e9rent d'une communication o\u00f9 le protocole applicatif utilise une sous-couche avec une session SSL.</p>"},{"location":"TECHNIQUE/MAIL/sendmail.html","title":"Envoi de mail","text":"<p>L'envoi de mail est caract\u00e9ris\u00e9 par la mise en oeuvre de trois \u00e9l\u00e9ments :</p> <ul> <li>le programme d'envoi de mail (client mail), qui va transf\u00e9rer le mail vers le \"smarthost\"</li> <li>le \"smarthost\" qui permet d'encapsuler l'acc\u00e8s aux identifiants, de signer le mail (signature DKIM ) et de transf\u00e9rer le mail vers le serveur</li> <li>le serveur SMTP proprement dit.</li> </ul>"},{"location":"TECHNIQUE/MAIL/sendmail.html#client-mail","title":"Client mail","text":"<p>Dans le cadre de l'envoi des mails, le plus simple est d'utiliser la transmission par socket unix entre le client mail et le proxy : on r\u00e9utilise donc la transmission via socat mise en oeuvre entre le reverse-proxy et l'authenticateur.</p> <p>Le client mail est configur\u00e9 facilement dans la mesure o\u00f9 en PHP on dispose de l'envoi par d\u00e9faut via sendmail, qui est configur\u00e9 au niveau syst\u00e8me par la directive de configuration <code>sendmail_path</code> de php.ini ; l'approche propos\u00e9e en exemple est le <code>sendmail -t -i</code>, qui a notamment comme propri\u00e9t\u00e9 de fournir le destinataire dans les ent\u00eates du mail. Le champ From est \u00e9galement quasi-obligatoire. On a donc dans php.ini :  <pre><code>sendmail_path = \"/mail/sendmail.sh\"\n</code></pre> Et comme exemple d'envoi de mail de test : </p> <p><pre><code>#!/usr/bin/php\n&lt;?php\n$ret=mail('dst@dst.test','subject','message','From: \"SRC\" &lt;src@src.test&gt;',\"\");\necho $ret;\n</code></pre> En ce qui concerne le script socat :</p> <pre><code>#!/bin/bash\nset pipefail\nsocat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt STDIO UNIX-CONNECT:/MAILSOCK/sendmail\nexit 0\n</code></pre>"},{"location":"TECHNIQUE/MAIL/sendmail.html#smarthost","title":"Smarthost","text":"<p>Le smarthost r\u00e9cup\u00e8re le mail via socat, comme il se doit :</p> <pre><code>#!/bin/bash\nsocat -d -d -d -D -t 50 -T 50 -lf /tmp/socat.txt UNIX-LISTEN:/MAILSOCK/sendmail,fork,user=paroisse,group=www-data,mode=0660,unlink-early EXEC:/mail/msmtp.sh,su=mailer\n</code></pre> <p>Le script appel\u00e9 se compose en deux parties : la signature, puis la transmission du mail :</p> <pre><code>#!/bin/bash\ndkimsign \"${DKIMSELECTOR}\" \"${DKIMDOMAIN}\" \"${DKIMKEYFILE}\" | msmtp -t -i -C ${MSMTPCONFIGFILE} --read-envelope-from\n</code></pre>"},{"location":"TECHNIQUE/MAIL/sendmail.html#signature-et-verification-de-signature","title":"Signature et v\u00e9rification de signature","text":"<p>Le programme (script) utilis\u00e9 est dkimsign. Il prend un mail sur STDIN et transmet le mail sign\u00e9 (donc avec ajout du header de signature) sur STDOUT, ce qui facilite son utilisation via des pipes.</p> <p>Pour la signature DKIM, la clef DKIM choisie est une clef 2048 bit, g\u00e9n\u00e9r\u00e9e via openssl genrsa. Le s\u00e9lecteur indique le nom de l'entr\u00e9e DNS qui est utilis\u00e9e pour la clef publique, et le domaine est le domaine de l'entr\u00e9e TXT de ladite clef.</p> <p>Si on r\u00e9cup\u00e8re le mail entre temps (par exemple en pontant avec <code>tee</code>), on peut v\u00e9rifier le mail avec dkimverify, \u00e0 condition d'avoir un serveur DNS avec la clef.</p> <p>Le serveur que l'on peut utiliser pour maquette rapidement est PowerDNS. Il est en effet rapide de le configurer pour utiliser le backend sqlite, puis d'utiliser pdnsutil pour cr\u00e9er les zones n\u00e9cessaires et finalement l'entr\u00e9e TXT :</p> <p><pre><code>pdnsutil add-record _domainkey.civicrm.test. civikim1 txt \"\\\"v = DKIM1 ; h = sha256 ; k= rsa ; p = MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAw8JkeF4R+gmkCYwsF6Afm9eM0TSshC/Wrs7MDwCi2pnRAFJCdZr5VKhBQ9Je4fINNo4D8lV+fJVIZYymvaa8bz5nTjLl5F5FtwbJzzmvlDpmUJpii9WGt3HsUEiMGo/xSGhVFLJigTNTzqIGaN7R8mpQPAzzCLe9PnsdJeO1Csh3QHKe3zjd1WdWaoH5/oO/d7WgN1ZFGBBZjtN4OzSgKhZP6mAbTozdPs6p5YwTN+TFr/Sm19kRHrw/gMsEPchgLVMdJ3r1ZZlMVPX9MPqaiYPdgvEbfrTw+UvI1YmdOyt0Slz7ajV4XyLGN5QSiYWv7uquuRdSItqMTsfubjCRXQIDAQAB\\\"\"\n</code></pre> L'entr\u00e9e TXT se fait obligatoirement dans un sous-domaine <code>_domainkey</code>. Ici, le s\u00e9lecteur est <code>civikim1</code>. Les param\u00e8tres de l'entr\u00e9e sont l'algorithme de hash (h), l'algorithme de signature (k), et la clef publique, sous forme d'encodage base64 du format DER de la clef publique.</p> <p>On se souviendra que dans la signature de mail g\u00e9n\u00e9r\u00e9e, tous les en-t\u00eates ne sont pas prot\u00e9g\u00e9s par la signature. En revanche, le contenu du mail est prot\u00e9g\u00e9 par la signature. Ceci peut s'expliquer que les diff\u00e9rents acteurs sur le trajet du mail peuvent int\u00e9grer leurs headers dans le mail, et cela peut donc de comprendre la pr\u00e9sence du hash des headers dans la signature.</p>"},{"location":"TECHNIQUE/MAIL/sendmail.html#envoi-du-mail","title":"Envoi du mail","text":"<p>Msmtp a \u00e9t\u00e9 s\u00e9lectionn\u00e9 pour l'envoi des mails. En r\u00e9alit\u00e9, un bon nombre de programmes analogues existe, mais msmtp a la particularit\u00e9 de disposer d'un grand nombre d'options pour l'authentification, ainsi que le support de SSL : on a donc un outil qui, on peut esp\u00e9rer, saura s'adapter aux exigences d'un bon nombre de serveurs SMTP.</p> <p>Le param\u00e8tre <code>--read-envelope-from</code> sp\u00e9cifie que le programme doit lire le champ <code>From</code> de l'en-t\u00eate du mail pour le MAIL FROM.</p> <p>Le coeur de configuration, qui changera pour chaque paroisse, est embarqu\u00e9 dans un fichier de configuration, comme par exemple :</p> <p><pre><code>defaults\naccount default\nhost mailcatcher\nport 25\nauth off\nprotocol smtp\nlogfile -\n</code></pre> On cr\u00e9e ici une configuration \"par d\u00e9faut\", ici en sp\u00e9cifiant un envoi par smtp vers le port 25, sans authentification. En production, on utiliserait de l'authentification et on configurerait le support SSL/TLS.</p>"},{"location":"TECHNIQUE/MAIL/sendmail.html#serveur-de-mail","title":"Serveur de mail","text":"<p>Le serveur de mail de test utilis\u00e9 est mailcatcher. Il est simple de mise en oeuvre et dispose d'une interface web pour pouvoir r\u00e9cup\u00e9rer les mails (et alors \u00e9galement tester la signature du mail).   </p>"},{"location":"TECHNIQUE/POC/index.html","title":"POC : Proof Of Concept","text":"<ul> <li>Remontage en local</li> </ul>"},{"location":"TECHNIQUE/POC/remontage_local.html","title":"Remontage d'un cluster en local pour Civiparoisse : Quick &amp; Dirty","text":"<p>Le but est de pouvoir disposer d'une installation locale pour pouvoir construire et ex\u00e9cuter une image Civiparoisse.</p> <p>Les pr\u00e9requis sont :</p> <ul> <li>Sur l'h\u00f4te : Docker, minikube, et helm.</li> <li>G\u00e9n\u00e9rer une clef et un certificat par d\u00e9faut pour Traefik.</li> <li>Dans le cluster minikube : cert-manager et traefik.</li> <li>Disposer des sources de l'image Civiparoisse.</li> </ul>"},{"location":"TECHNIQUE/POC/remontage_local.html#minikube","title":"Minikube","text":"<p>L'installation de minikube se fait en r\u00e9cup\u00e9rant le package depuis https://github.com/kubernetes/minikube/releases, puis en l'installant, en fonction de l'architecture de la machine h\u00f4te (par exemple avec <code>dpkg -i &lt;nom package.deb&gt;</code> pour Debian/Ubuntu).</p> <p>Ensuite, on d\u00e9cide du nom du cluster que l'on va vouloir monter : par exemple si on veut utiliser un cluster nomm\u00e9 <code>dev</code>, on pourra d\u00e9marrer le cluster avec :</p> <pre><code>minikube -p dev start\n</code></pre> <p>On se rajoutera un alias pour kubectl, de sorte \u00e0 pouvoir l'utiliser de mani\u00e8re simple :</p> <pre><code>alias kubectl='minikube -p dev kubectl --'\n</code></pre> <p>Pour stopper le cluster apr\u00e8s utilisation :</p> <pre><code>minikube -p dev stop\n</code></pre> <p>Pour supprimer le cluster : </p> <pre><code>minikube -p dev delete\n</code></pre>"},{"location":"TECHNIQUE/POC/remontage_local.html#helm","title":"Helm","text":"<p>On peut r\u00e9cup\u00e9rer Helm depuis https://github.com/helm/helm/releases, et on le met dans un endroit accessible depuis le PATH.</p>"},{"location":"TECHNIQUE/POC/remontage_local.html#traefik","title":"Traefik","text":""},{"location":"TECHNIQUE/POC/remontage_local.html#generation-de-la-clef","title":"G\u00e9n\u00e9ration de la clef","text":"<p>Exemple : </p> <pre><code>openssl genrsa -out=wildcard.pem 2048\n\ncat &gt;wildcard.ext &lt;&lt;EOF\n[ext]\nsubjectAltName=DNS:*.civiparoissek8s.test\nEOF\n\nopenssl req -new -key wildcard.pem -subj \"/C=FR/ST=France/L=Strasbourg/O=TEST/OU=INFRA/CN=*.civiparoissek8s.test\" -out wildcard.req\n\nopenssl x509 -req -in wildcard.req -out wildcard.x509 -days 3649 -signkey wildcard.pem -extfile wildcard.ext -extensions ext\n</code></pre>"},{"location":"TECHNIQUE/POC/remontage_local.html#integration-de-la-clef-dans-kubernetes","title":"Int\u00e9gration de la clef dans Kubernetes","text":"<p>Exemple : <pre><code>kubectl create secret tls  wildcardsecret --cert=./wildcard.x509 --key=./wildcard.pem -n default\n</code></pre></p>"},{"location":"TECHNIQUE/POC/remontage_local.html#installation-de-traefik","title":"Installation de Traefik","text":"<p>On r\u00e9cup\u00e8re Traefik via git depuis https://github.com/traefik/traefik-helm-chart.git Le chart se trouve dans le r\u00e9pertoire traefik. On va rajouter un fichier de valeurs, nomm\u00e9 par exemple <code>values_dev.yaml</code> :  <pre><code>deployment:\n  kind: DaemonSet\nmetrics:\n  prometheus: null\nhostNetwork: true\nupdateStrategy:\n  type: OnDelete\nglobalArguments:\n  - \"--global.checknewversion\"\nports:\n  websecure:\n      port: 443\n      http:\n      tls: {}\nservice:\n  type: NodePort\nlogs:\n  general:\n    level: DEBUG\n  access:\n    enabled: true\n</code></pre></p> <p>Et on va installer traefik :</p> <pre><code>helm install -n traefik --create-namespace --values values_dev.yaml traefik .\n</code></pre>"},{"location":"TECHNIQUE/POC/remontage_local.html#configuration-du-certificat-par-defaut","title":"Configuration du certificat par d\u00e9faut","text":"<p>On cr\u00e9e un fichier <code>tls_store.yaml</code> :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TLSStore\nmetadata:\n  name: default\n  namespace: default\nspec:\n  certificates:\n    - secretName: wildcardsecret\n  defaultCertificate:\n    secretName: wildcardsecret\n</code></pre> <p>Et on l'int\u00e8gre :</p> <pre><code>kubectl apply -f tls_store.yaml\n</code></pre>"},{"location":"TECHNIQUE/POC/remontage_local.html#cert-manager","title":"Cert-manager","text":"<p>Les sources de cert-manager doivent \u00eatre build\u00e9es avant de pouvoir les utiliser. Il est donc plus arrangeant de l'installer depuis des versions pr\u00e9construites avec Helm :</p> <pre><code>helm repo add jetstack https://charts.jetstack.io\nhelm repo update\nhelm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set installCRDs=true --set prometheus.enabled=false --version 1.13.1\n</code></pre> <p>Ensuite, on va initialiser des ClusterIssuer, qui vont pouvoir g\u00e9n\u00e9rer des certificats au niveau du cluster : un g\u00e9n\u00e9rateur de certificats autosign\u00e9s d'abord, que l'on va utiliser pour pr\u00e9parer une autorit\u00e9 locale, le tout via des d\u00e9finitions se basant sur des CRDs :</p> <p>dans <code>self_signed.yaml</code> :</p> <pre><code>apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: devself-issuer\nspec:\n  selfSigned: {}\n</code></pre> <p>on le charge :</p> <pre><code>kubectl apply -f self_signed.yaml\n</code></pre> <p>dans <code>dev_ca_certificate.yaml</code> :</p> <pre><code>apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: dev-ca\n  namespace: cert-manager\nspec:\n  isCA: true\n  commonName: dev-ca\n  secretName: dev-ca-secret\n  issuerRef:\n    name: devself-issuer\n    kind: ClusterIssuer\n    group: cert-manager.io\n</code></pre> <p>on le charge :</p> <pre><code>kubectl apply -f dev_ca_certificate.yaml\n</code></pre> <p>Et enfin l'issuer dans <code>dev_ca_issuer.yaml</code> :</p> <pre><code>apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: dev-ca-issuer\nspec:\n  ca:\n    secretName: dev-ca-secret\n</code></pre> <p>On le charge :</p> <pre><code>kubectl apply -f dev_ca_issuer.yaml\n</code></pre>"},{"location":"TECHNIQUE/POC/remontage_local.html#installation-de-civiparoisse","title":"Installation de Civiparoisse","text":"<p>On r\u00e9cup\u00e8re un clone du d\u00e9p\u00f4t git. Ensuite, on configure l'utilisation de Docker de minikube pour le terminal courant :</p> <pre><code>eval $(minikube -p dev docker-env)\n</code></pre> <p>De l\u00e0, on peut builder l'image :</p> <pre><code>docker build -t uepal_test/civiparoisseci:citest .\n</code></pre> <p>Pour l'installation proprement dit, il faut :</p> <ul> <li>Cr\u00e9er un namespace.</li> <li>Cr\u00e9er le secret avec les identifiants.</li> <li>Installer via Helm.</li> </ul> <p>Le namespace : <code>dev_namespace.yaml</code> : </p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: dev\n</code></pre> <pre><code>kubectl apply -f dev_namespace.yaml\n</code></pre> <p>Le secret : <code>dev_secret.yaml</code> : </p> <pre><code>apiVersion: v1\nstringData:\n  DRUPAL_ADMIN_PASSWORD: \"admin\"\n  DRUPAL_ADMIN_USER: \"admin\"\n  IMAP_HOST: \"127.0.0.1\"\n  IMAP_INBOX_FOLDER: \"inbox\"\n  IMAP_IS_SSL: \"1\"\n  IMAP_PASSWORD: \"imappass\"\n  IMAP_PORT: \"993\"\n  IMAP_USERNAME: \"imapuser\"\n  SMTP_HOST: \"127.0.0.1\"\n  SMTP_PASSWORD: \"smtppass\"\n  SMTP_PORT: \"25\"\n  SMTP_USERNAME: \"smtpuser\"\nkind: Secret\nmetadata:\n  name: civiparoisse-configuration-dev\n  namespace: dev\ntype: Opaque\n</code></pre> <pre><code>kubectl apply -f dev_secret.yaml\n</code></pre> <p>Et enfin, se mettre dans le r\u00e9pertoire du chart, et on va utiliser le <code>dev_values.yaml</code> d\u00e9j\u00e0 pr\u00e9sent dans le code, pour d\u00e9clencher l'installation :</p> <pre><code>helm install  -n dev --values values_dev.yaml dev .\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/index.html","title":"PREPOC","text":"<p>Cette section de la documention est pr\u00e9vue pour recevoir les documents li\u00e9s \u00e0 l'exp\u00e9rimentation Proof Of Concept :</p> <ul> <li>Description g\u00e9n\u00e9rale des pr\u00e9paratifs</li> <li>Etudes - pr\u00e9cis techniques</li> <li>Op\u00e9rationnel</li> </ul>"},{"location":"TECHNIQUE/PREPOC/prepoc.html","title":"Documentation du Pr\u00e9-POC (Proof Of Concept)","text":"<p>Avant d'effectuer le POC proprement dit, il s'agit d'affiner le syst\u00e8me global envisag\u00e9 pour pouvoir d\u00e9ployer une version repr\u00e9sentative de Civiparoisse.</p>"},{"location":"TECHNIQUE/PREPOC/prepoc.html#utilisabilite","title":"Utilisabilit\u00e9","text":"<p>L'UEPAL souhaite privil\u00e9gier l'utilisabilit\u00e9 de CiviParoisse. En cons\u00e9quence, le reverse proxy envisag\u00e9 pour authentifier l'ensemble des requ\u00eates ne sera pas mis en oeuvre dans cette version.</p> <p>De m\u00eame, le syst\u00e8me semble plus facilement op\u00e9rationnel s'il n'a pas d'impacts directs sur les syst\u00e8mes d'information existants dans les paroisses (notamment DNS).</p>"},{"location":"TECHNIQUE/PREPOC/prepoc.html#efficience-des-ressources-attribuees","title":"Efficience des ressources attribu\u00e9es","text":"<p>Il nous est demand\u00e9 de chercher \u00e0 optimiser l'utilisation des ressources, ce qui correspond au moins partiellement \u00e0 une d\u00e9marche Finops.</p> <p>Le livre Cloud FinOps d'Oreilly est consid\u00e9r\u00e9 comme livre de r\u00e9f\u00e9rence ; ce livre propose une double approche : une optimisation des ressources utilis\u00e9es par les \u00e9quipes techniques (en particulier, supprimer les ressources r\u00e9serv\u00e9es et plus utilis\u00e9es) d'une part, et une optimisation du montage financier avec le fournisseur cloud d'autre part.</p> <p>En ce qui concerne l'optimisation des ressources utilis\u00e9es, plusieurs leviers peuvent \u00e9ventuellement \u00eatre actionn\u00e9s :</p> <ul> <li> <p>Les r\u00e9servations de ressources comportent une demande de base, et un niveau d'utilisation maximum. Au lieu de faire correspondre les deux niveaux de r\u00e9servations, ce qui correspond \u00e0 des ressources garanties si les charges de travail sont planifi\u00e9es, on va faire une diff\u00e9rence entre les deux niveaux de ressource, en esp\u00e9rant que les charges de travail maximales ne soient pas atteintes simultan\u00e9ment sur l'ensemble des instances. Cette approche n'a pas \u00e9t\u00e9 retenue dans notre projet pour le moment.</p> </li> <li> <p>Toutes les instances de Civiparoisse mettent en oeuvre un moteur mysql : il pourrait \u00eatre plus efficace de provisionner un seul moteur mysql, mais avec plus de ressources : les ressources sont donc mises plus en commun en comptant sur le fait que l'ensemble des utilisateurs ne lanceront pas des travaux lourds sur la BD en m\u00eame temps. Par ailleurs, le service MySQL pourrait \u00e9ventuellement sorti hors de Kubernetes, puisque les providers clouds proposent souvent MySQL comme un service qui peut \u00eatre achet\u00e9 \u00e0 part. De ce fait, il convient alors de garder une connexion \"classique\" vers la base de donn\u00e9es, ce qui conduit \u00e0 utiliser un proxy \"classique\" pour la connexion chiffr\u00e9e vers la BD : mysqlrouter semble \u00eatre une solution de compromis int\u00e9ressante dans ce cas. De m\u00eame, il faut \u00e9galement mettre \u00e0 jour le syst\u00e8me d'installation pour ne pas donner SUPER \u00e0 l'utilisateur de BD. Cette approche n'a pas \u00e9t\u00e9 retenue dans notre projet pour le moment.</p> </li> <li> <p>La mise en oeuvre de PHP-FPM pourrait \u00e9ventuellement aider \u00e9galement \u00e0 optimiser l'utilisation des ressources : on peut en effet chercher \u00e0 d\u00e9finir la taille du pool PHP d'une instance, et limiter en parall\u00e8le le nombre de requ\u00eates trait\u00e9es simultan\u00e9ment par Apache : la diff\u00e9rence entre les deux permet de servir les fichiers statiques plus rapidement, et pourrait concourir \u00e0 des charges de travail mieux connues et mieux ma\u00eetris\u00e9es. Cette approche n'a pas \u00e9t\u00e9 retenue dans notre projet pour le moment.</p> </li> <li> <p>Pour le moment, il a \u00e9t\u00e9 d\u00e9cid\u00e9 de se passer de conteneurs sp\u00e9cialis\u00e9s pour l'envoi et la r\u00e9cup\u00e9ration des mails ; CiviCRM fera donc \u00e9galement ces travaux, et disposera de ce fait des identifiants n\u00e9cessaires.</p> </li> </ul>"},{"location":"TECHNIQUE/PREPOC/prepoc.html#constitution-dune-instance-civiparoisse","title":"Constitution d'une instance Civiparoisse","text":"<p>L'instance Civiparoisse sera constitu\u00e9e par :</p> <ul> <li>un pod avec la BD, et son service associ\u00e9 (mysql)</li> <li>un pod avec le container serveur web, et un mysqlrouter, et le service associ\u00e9 (httpd)</li> <li>un pod de cronjob avec le container cron et un mysqlrouter</li> <li>un pod de cronjob pour la sauvegarde avec un mysqlrouter : sauvegarde avec mysqldump et tar gz des fichiers</li> </ul>"},{"location":"TECHNIQUE/PREPOC/prepoc.html#services-centraux","title":"Services centraux","text":"<p>DNS : \u00e0 voir si on peut passer avec le plugin kubernetes pour la d\u00e9couverte, metadatas pour la publication de metadonn\u00e9es et le plugin template en se basant sur les metadatas pour avoir une r\u00e9ponse g\u00e9n\u00e9rique.</p> <p>EFK : \u00e0 voir si on ne peut pas faire un Fluentd g\u00e9n\u00e9ral et balancer tous les logs vers un seul service.</p> <p>Ces deux pistes n'ont pas encore \u00e9t\u00e9 \u00e9tudi\u00e9es dans le cadre de notre projet.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/index.html","title":"Etudes et pr\u00e9cis techniques","text":"<ul> <li>Infrastructure</li> <li>Trafic initiateur entrant</li> <li>Maquettage Traefik</li> <li>Identit\u00e9s et certificats</li> <li>Web Application Firewall</li> <li>Int\u00e9gration CA Ubuntu</li> <li>Minikube + Traefik + Wildcard</li> </ul>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html","title":"Identit\u00e9s et certificats","text":"<p>Un certificat SSL permet d'associer des donn\u00e9es d'identit\u00e9 \u00e0 une clef publique. Dans le cadre du projet Civiparoisse, la notion d'identit\u00e9 est complexe, d\u00e9j\u00e0 du fait des interactions entre l'UEPAL et les paroisses. Il y a donc lieu de dresser un \u00e9tat des lieux des identit\u00e9s qui entrent dans le cadre de Civiparoisse, ainsi qu'un rapide r\u00e9sum\u00e9 du contexte technique vis \u00e0 vis des clefs et des CA, avant de voir quelles sont les \u00e9ventuels sc\u00e9narios techniques qui pourraient \u00eatre envisag\u00e9s.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#identites-dans-civiparoisse","title":"Identit\u00e9s dans Civiparoisse","text":"<p>Un certain nombre d'identit\u00e9s gravitent de mani\u00e8re plus ou moins rapproch\u00e9es autour du projet Civiparoisse :</p> <ul> <li>l'identit\u00e9 de chaque paroisse et \u00e9galement de l'UEPAL, en dehors du projet Civiparoisse :<ul> <li>identit\u00e9 juridique : nom, adresse,...</li> <li>identit\u00e9 num\u00e9rique : nom de domaine, adresse de sites web, pr\u00e9sentation de la paroisse sur le site de l'UEPAL, r\u00e9seaux sociaux, adresses de messagerie,...</li> <li>identit\u00e9 visuelle : li\u00e9e au site web, mais \u00e9ventuellemnt \u00e9galement dans d'autres supports de communication (pr\u00e9sentations/diapositives, publications...)</li> </ul> </li> <li>les URL d'acc\u00e8s \u00e0 Civiparoisse : il y a certes les URL pour acc\u00e9der \u00e0 CiviCRM, mais il y a \u00e9galement la possibilt\u00e9 d'affichage des mailings envoy\u00e9s vers l'ext\u00e9rieur</li> <li>l'identit\u00e9 visuelle int\u00e9gr\u00e9e dans les mails (templates) et pour les interactions avec CiviCRM par des personnes lambdas (formulaires)</li> <li>les adresses et domaines de messagerie pour les mails de masse</li> </ul> <p>Une premi\u00e8re approche serait de se dire que Civiparoisse est un outil au service des paroisses et des acteurs en relation avec les paroisses, et que de ce fait, il faudrait mettre l'identit\u00e9 de chaque paroisse en avant, de sorte qu'une seule identit\u00e9 homog\u00e8ne pour chaque paroisse soit mise en avant. Toutefois, ceci suppose que chaque paroisse soit en mesure d'effectuer les configurations dans son syst\u00e8me d'information pour pr\u00e9parer la place de CiviCRM d'une part, et g\u00e9n\u00e8re, voire d\u00e9l\u00e8gue un certificat pour CiviCRM (cette d\u00e9l\u00e9guation devant \u00eatre correctement encadr\u00e9e). De plus, la paroisse doit \u00e9galement \u00eatre en mesure d'int\u00e9grer son identit\u00e9 au niveau des formulaires Drupal/CiviCRM et des templates de mails. On comprend donc que ceci est en contradiction par rapport \u00e0 la simplification et l'accent que l'UEPAL souhaite mettre sur l'utilisabilit\u00e9.</p> <p>A l'oppos\u00e9, une autre approche est de dire que si une paroisse souhaite l'int\u00e9gration enti\u00e8re avec son syst\u00e8me d'information, il vaut mieux qu'elle h\u00e9berge d'elle-m\u00eame la solution. </p> <p>De ce fait, nous mettrons l'accent dans l'offre h\u00e9berg\u00e9e sur l'aspect \"pr\u00eat \u00e0 utiliser\", en pr\u00e9parant et cultivant un aspect de paroisses utilisant un outil mis \u00e0 disposition par l'UEPAL : s'il semble prudent de s\u00e9parer les identit\u00e9s au niveau du mailing de masse, afin que les mailings issus d'une paroisse n'en impactent pas une autre, une seule identit\u00e9 de template de mail est configur\u00e9e avec les informations de la paroisse. En ce qui concerne les URL de CiviCRM, une identit\u00e9 \"technique\" (domaine d\u00e9di\u00e9 \u00e0 l'outil, avec mise \u00e0 disposition d'un sous-domaine pour chaque paroisse) est choisie. L'identit\u00e9 de l'UEPAL est mise en avant comme fournisseur de l'outil, du fait du nom de domaine. Ceci conduit \u00e0 un proxy entrant utilisant le nom d'h\u00f4te comme indication de paroisse cible.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#contexte-technique-de-letude","title":"Contexte technique de l'\u00e9tude","text":""},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#chiffrement-et-confiance","title":"Chiffrement et confiance","text":"<p>Le chiffrement des donn\u00e9es permet de prot\u00e9ger la confidentialit\u00e9 des donn\u00e9es. On distingue deux types de chiffrements : </p> <ul> <li>le chiffrement sym\u00e9trique, o\u00f9 la m\u00eame clef est utilis\u00e9e pour chiffrer et d\u00e9chiffrer</li> <li>le chiffrement asym\u00e9trique, o\u00f9 on dispose d'une bi-clef : une clef publique et une clef priv\u00e9e.</li> </ul> <p>Le chiffrement asym\u00e9trique a plusieurs utilisations, notamment le chiffrement, mais \u00e9galement la signature de documents. En chiffrement, la clef publique permet de chiffrer les donn\u00e9es et la clef priv\u00e9e permet de d\u00e9chiffrer les donn\u00e9es. En signature, la clef priv\u00e9e permet de signer les donn\u00e9es, tandis que la clef publique permet de v\u00e9rifier la signature.</p> <p>La confidentialit\u00e9 de la communication n'est qu'une composante de la s\u00e9curit\u00e9 de la communication : en effet, l'identit\u00e9 des parties est \u00e9galement fondamentale. C'est pourquoi les certificats qui attestent de l'identit\u00e9 li\u00e9e \u00e0 une clef publique sont \u00e9galement importants. Les utilisateurs doivent donc d\u00e9cider s'ils font confiance \u00e0 un certificat ou non.</p> <p>Deux mod\u00e8les principaux de distribution de la confiance existent : </p> <ul> <li>un mod\u00e8le d\u00e9centralis\u00e9, o\u00f9 la confiance est acquise petit \u00e0 petit \u00e0 travers des utilisateurs qui attestent de l'identit\u00e9 d'une clef publique, et c'est le nombre d'utilisateurs qui attestent de l'identit\u00e9 d'un propri\u00e9taire de clef qui forge la confiance en l'association : c'est par exemple le cas pour OpenPGP</li> <li>un mod\u00e8le plus centralis\u00e9, o\u00f9 on fait confiance \u00e0 un tiers qui est une autorit\u00e9 de certification. C'est le mod\u00e8le qui est utilis\u00e9 pour les certificats X.509 utilis\u00e9s notamment pour SSL/TLS (et donc HTTPS).</li> </ul> <p>Pour des raisons \u00e9videntes de s\u00e9curit\u00e9, le trafic vers et depuis l'infrastructure de Civiparoisse se doit d'\u00eatre chiffr\u00e9, et il faut donc d\u00e9cider de comment mettre en oeuvre les certificats.</p> <p>On notera que l'utilisation des certificats n'est qu'un composant faisant parti d'un tout qui assure la s\u00e9curit\u00e9 de Civiparoisse. En termes de clefs, il faudra penser aussi \u00e0 utiliser DNSSec pour chercher \u00e0 authentifier les r\u00e9ponses DNS.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#generation-de-clef","title":"G\u00e9n\u00e9ration de clef","text":"<p>La g\u00e9n\u00e9ration de clefs peut \u00eatre effectu\u00e9e en fonction des situations sur diff\u00e9rents supports, que ce soit un fichier, ou m\u00eame sur du mat\u00e9riel d\u00e9di\u00e9. Une des probl\u00e9matiques qui importe lors de la g\u00e9n\u00e9ration de la clef est que l'on dispose d'une bonne source d'al\u00e9a, en plus de choisir une longueur de clef et un algorithme qui satisfont les pr\u00e9requis de l'autorit\u00e9 de certification. Il est n\u00e9cessaire d\u00e8s sa g\u00e9n\u00e9ration de stocker la clef priv\u00e9e de mani\u00e8re s\u00e9curis\u00e9e.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#stockage-des-clefs","title":"Stockage des clefs","text":"<p>Au niveau de Kubernetes, les donn\u00e9es secr\u00e8tes sont g\u00e9r\u00e9es dans des objets appel\u00e9s (\u00e0 juste titre) \"Secrets\". La commande kubectl dispose m\u00eame de la possibilit\u00e9 de cr\u00e9er des secrets sp\u00e9cialement con\u00e7us pour stocker clef priv\u00e9 et clef publique (avec des noms de champs sp\u00e9cifiques : tls.crt et tls.key). Kubernetes, en fonction des d\u00e9ploiements des cloud providers, peut \u00e9ventuellement stocker les secrets de mani\u00e8re chiffr\u00e9e, pour chercher justement \u00e0 garantir que les secrets restent confidentiels (voir https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/).</p> <p>Il existerait \u00e9galement des modules de s\u00e9curit\u00e9 mat\u00e9riels (HSM) sp\u00e9cifiques pour les clouds.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#role-des-autorites-de-certifications","title":"R\u00f4le des autorit\u00e9s de certifications","text":"<p>Les autorit\u00e9s de certifications sont des tiers de confiance auxquelles on fait confiance (ou pas) dans leur certification de l'identit\u00e9 d'un porteur de clef publique. Les autorit\u00e9s de certifications diffusent \u00e0 grande \u00e9chelle leurs certificats, qu'elles signent elles-m\u00eames : ces certificats sont appel\u00e9s des certificats racines.</p> <p>Cette confiance peut \u00eatre distribu\u00e9e, avec des limitations ou non (par exemple, limitation dans les noms des certificats, limitation \u00e0 la longueur de la cha\u00eene de certificats), \u00e0 des autorit\u00e9s subalternes, en fonction des besoins. Tout le probl\u00e8me pour un utilisateur est de r\u00e9ussir \u00e0 cr\u00e9er une cha\u00eene de certificats qui lui permet d'arriver \u00e0 un certificat racine auquel l'utilisateur fait confiance.</p> <p>En pratique, la plupart des navigateurs sont pr\u00e9vus pour acc\u00e9der \u00e0 des magasins de certificats, qui peuvent stocker en particulier des certificats racines auquel des \u00e9diteurs de logiciel (navigateur ou syst\u00e8me d'exploitation par exemple) ont choisi de donner leur confiance (et, par d\u00e9faut, en fonction des r\u00e9glages ou non, la confiance des utilisateurs de ces logiciels).</p> <p>L'autorit\u00e9 de certification a donc un r\u00f4le central dans l'\u00e9tablissement des certificats et dans la r\u00e9vocation \u00e9ventuelle de certificats (publication de listes de certificats r\u00e9voqu\u00e9s, serveurs permettant de v\u00e9rifier si un certificat est r\u00e9voqu\u00e9 ou non). Une fonctionnalit\u00e9 compl\u00e9mentaire est l'estampillage horaire des documents sign\u00e9s par un fournisseur de confiance tiers pour l'estampillage : l'estampillage permet de d\u00e9finir qu'un document a exist\u00e9 a une date donn\u00e9e, et devient important pour savoir si l'on peut consid\u00e9rer que la mise en oeuvre d'une clef priv\u00e9e pour une signature \u00e9tait encore acceptable ou non au moment (ou juste apr\u00e8s) la signature.</p> <p>Le fonctionnement d'une autorit\u00e9 de certification repose \u00e9galement en grande partie dans le fait de suivre des proc\u00e9dures pr\u00e9cises. Dans cette id\u00e9e, la RFC 3647 pr\u00e9voit notamment deux documents que sont la <code>Certificate Policy</code> et le <code>Certification Practice Statement</code> qui sont sens\u00e9s expliquer dans une certaine mesure ce que l'on peut faire ou pas avec un certificat, et comment l'autorit\u00e9 de certification compte effectuer son travail. Ce sont des documents assez techniques, toutefois ils peuvent \u00e9ventuellement aider \u00e0 comparer des autorit\u00e9s de certifications entre elles. A cela s'ajoute qu'il y aura probablement des relations contractuelles qui engageront r\u00e9ciproquement \u00e0 la fois l'autorit\u00e9 de certification et le porteur de la clef priv\u00e9e : la signature d'un certificat est donc g\u00e9n\u00e9rateur de droits mais \u00e9galement de devoirs pour le porteur de la clef priv\u00e9e.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#differents-profils-policies-de-certifications","title":"Diff\u00e9rents profils (policies) de certifications","text":"<p>Les certificats d\u00e9livr\u00e9s \u00e0 un porteur d'une clef priv\u00e9e peuvent attester de diff\u00e9rents \u00e9l\u00e9ments, en fonction de ses pratiques, comme par exemple :</p> <ul> <li>un certificat peut valider le contr\u00f4le sur un nom DNS particulier (par exemple un serveur web)</li> <li>un certificat peut valider le contr\u00f4le sur une zone DNS particuli\u00e8re (notament dans le cas des certificats wildcard )</li> <li>un certificat peut valider l'existence d'une organisation/personne</li> </ul> <p>On notera qu'un certificat ne peut certes que couvrir les donn\u00e9es d'identit\u00e9 d'une entit\u00e9, mais elle peut toutefois couvrir diff\u00e9rents noms d'une entit\u00e9, en utilisant les Subject Alternative Names ; une telle approche peut par exemple se justifier lorsqu'on fait du domain sharding pour du HTTP/1.1 pour inciter un naviguateur \u00e0 \u00e9tablir un plus grand nombre de connexions en parall\u00e8les pour r\u00e9cup\u00e9rer diff\u00e9rents \u00e9l\u00e9ments utilis\u00e9s dans une page, et ainsi chercher \u00e0 r\u00e9duire le temps de chargement global de la page.</p> <p>On en d\u00e9duit l'importance de la <code>Certificate Policy</code> et du <code>Certification Practive Statement</code> au point o\u00f9 que les documents aff\u00e9rents peuvent \u00eatre mentionn\u00e9s (via un <code>Object IDentifier</code> OID) dans les certificats. Il faudrait donc prendre connaissance des documents avant d'accepter les certificats.</p> <p>En pratique, le CA/Browser Forum d\u00e9finit plusieurs policies</p> <ul> <li>des pr\u00e9requis minimum : https://cabforum.org/baseline-requirements-documents/ : d\u00e9finit plusieurs policies</li> <li>une validation \u00e9tendue : https://cabforum.org/extended-validation/</li> </ul> <p>Il fut un temps o\u00f9 les certificats \u00e0 validation \u00e9tendue \u00e9taient mis en avant dans certains navigateurs, dans la mesure o\u00f9 le nom juridique pr\u00e9sent\u00e9 par le certificat \u00e9tait affich\u00e9 de mani\u00e8re assez visible ; toutefois, cette mise en avant serait r\u00e9duite actuellement (voir https://en.wikipedia.org/wiki/Extended_Validation_Certificate).</p> <p>A cela s'ajoute des r\u00e8glements sp\u00e9cifiques, comme le r\u00e9glement europ\u00e9en eIDAS et au niveau fran\u00e7ais le R\u00e9f\u00e9rentiel G\u00e9n\u00e9ral de S\u00e9curit\u00e9. Ces dispositifs r\u00e8glementaires cherchent \u00e0 harmoniser et coordonner les produits et services utilis\u00e9s dans l'identification \u00e9lectronique.</p> <p>En particulier, les autorit\u00e9s administratives doivent respecter les pr\u00e9conisations du RGS.</p> <p>Enfin, on notera que m\u00eame l'Etat g\u00e8re une autorit\u00e9 de certification : voir  https://www.ssi.gouv.fr/administration/services-securises/igca/.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#limitations-des-certificats","title":"Limitations des certificats","text":"<p>Les certificats sont des outils techniques, mais ce ne sont que des outils : la vigilance des utilisateurs est notamment requise pour v\u00e9rifier que le domaine affich\u00e9 est le bon - toute diff\u00e9rence pouvant amener \u00e0 consulter un autre domaine.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#dans-le-cadre-de-civiparoisse","title":"Dans le cadre de Civiparoisse","text":"<p>A priori, plusieurs strat\u00e9gies d'utilisations de certificats peuvent \u00eatre techniquement envisag\u00e9es :</p> <ul> <li>utiliser un certificat wildcard : le certificat wildcard permet de couvrir l'ensemble des noms d'un domaine</li> <li>utiliser un certificat avec des Subject Alternative Names multiples : on dispose d'une identit\u00e9, mais avec un ensemble de noms li\u00e9s : cette m\u00e9thode permet d'utiliser des certificats qui offrent des garanties plus importantes, mais il faut remarquer que le certificat devra \u00eatre r\u00e9\u00e9dit\u00e9 s'il faut rajouter des noms suppl\u00e9mentaires. Par ailleurs, en fonction des autorit\u00e9s de certification, il y a un nombre maximal de SAN qui sont autoris\u00e9s</li> <li>utiliser un seul certificat sur un reverse proxy et router non pas en fonction du host, mais en fonction du chemin : ceci signifie que le reverse proxy devra se positionner en coupure et dialoguera en HTTPS avec les naviguateurs : il n'y aura qu'une seule identit\u00e9 qui sera v\u00e9hicul\u00e9e, aussi bien au niveau du hostname qu'au niveau du certificat</li> <li>maintenir au niveau de l'UEPAL une autorit\u00e9 de certification subsidiaire, pour un domaine distinct, et \u00e9diter des certificats : la bonne maintenance d'une autorit\u00e9 de certification semble tr\u00e8s d\u00e9licate, et n\u00e9cessiterait probablement des ressources cons\u00e9quentes.</li> </ul> <p>Consid\u00e9rant que les besoins de signatures digitales des paroisses sont pour le moment tr\u00e8s limit\u00e9s, voire inexistants, nous mettons en place pour d\u00e9marrer une strat\u00e9gie base\u00e9 sur un unique certificat wildcard.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/identites_certificats.html#resources-utiles","title":"Resources utiles","text":"<p>Livre tr\u00e8s int\u00e9ressant : https://www.dunod.com/sciences-techniques/architectures-securite-protocoles-standards-et-deploiement</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html","title":"Infrastructure POC","text":""},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#infrastructure-ovh","title":"Infrastructure OVH","text":"<p>L'infrastructure OVH est une infrastructure de cloud public. De ce fait, on utilise des ressources non d\u00e9di\u00e9es sp\u00e9cifiquement au projet, mais partag\u00e9es, o\u00f9 chaque client r\u00e9serve des ressources et paie en fonction de son utilisation. Le cloud public repose en lui-m\u00eame sur une infrastructure OpenStack. Les clusters Kubernetes interagissent avec OpenStack gr\u00e2ce \u00e0 un cloud provider.</p> <p>Openstack propose diff\u00e9rents services :</p> <ul> <li>des services r\u00e9seaux (Neutron)</li> <li>des services de load-balancing (Octavia)</li> <li>des services d'instances (Nova)</li> <li>des services de gestion de secrets (Barbican)</li> <li>des services de stockage (Cinder)</li> </ul> <p>Lorsque cela est n\u00e9cessaire, il semble possible d'intervenir sur les ressources via la configuration OpenStack. Toutefois, il semblerait judicieux d'utiliser cette possibilit\u00e9 avec parcimonie pour \u00e9viter de trop d\u00e9pendre de l'infrastructure sous-jacente (et donc avoir du mal \u00e0 d\u00e9placer le cluster)</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#principe-de-fonctionnement","title":"Principe de fonctionnement","text":"<p>A voir si c'est n\u00e9cessaire : un h\u00f4te ssh avec les outils (kubectl par exemple)</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#phases-dinstallation","title":"Phases d'installation","text":"<ul> <li>Cr\u00e9ation d'un compte OVH</li> <li>Cr\u00e9ation d'une instance de projet public cloud avec ajout du moyen de paiement sur l'instance de projet https://docs.ovh.com/fr/public-cloud/creer-un-projet-public-cloud/</li> <li>Cr\u00e9er un vRack (visible ensuite dans le bare metal), puis Cr\u00e9er un Private Network dans le vRack : https://docs.ovh.com/gb/en/publiccloud/network-services/public-cloud-vrack/</li> <li>Cr\u00e9er le cluster Kubernetes https://docs.ovh.com/gb/en/kubernetes/creating-a-cluster/</li> <li></li> </ul> <p>Cr\u00e9ation d'une clef SSH RSA 4096 =&gt; disponible sur de la Yubikey 5, mais pas sur la BIO. Et il nous faut plus qu'une Yubikey, car il faut avoir des clefs de secours. A voir si c'est n\u00e9cessaire : Cr\u00e9ation des comptes utilisateurs pour les API S3, API OpenStack et GUI Openstack Horizon</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#infrastructure-reseau","title":"Infrastructure r\u00e9seau","text":"<ul> <li>Le r\u00e9seau local \u00e0 l'infrastructure cloud, comparable \u00e0 un r\u00e9seau local d'entreprise, se base sur le vRack d'OVH. C'est un r\u00e9seau de niveau 2 (Ethernet), qui permet si n\u00e9cessaire l'utilisation de VLAN.</li> <li>Au dessus du vRack se constitue le r\u00e9seau priv\u00e9 du public cloud</li> <li>Le trafic sortant vers internet n\u00e9cessite une passerelle sortante SNAT (n\u00e9cessit\u00e9 d'une IP source publique : source nat )</li> <li>Le trafic entrant depuis Internet passe par un load balancer qui dispose d'une IP flottante ; le load balancer d'OVH est Octavia, de Openstack.</li> </ul>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#ressources-utiles","title":"Ressources utiles","text":"<ul> <li>https://docs.ovh.com/fr/public-cloud/</li> <li>https://docs.ovh.com/gb/en/publiccloud/network-services/public-cloud-vrack/ </li> <li>https://docs.ovh.com/fr/publiccloud/network-services/networking-concepts/</li> <li>https://docs.ovh.com/fr/publiccloud/network-services/getting-started-with-load-balancer-public-cloud/</li> <li>https://www.ovhcloud.com/fr/public-cloud/floating-ip/</li> <li>https://www.openstack.org/marketplace/public-clouds/ovh-group/ovh-public-cloud</li> <li>https://www.isitix.com/en/blog/tech/openstack-public-cloud-ovh-management</li> <li>https://docs.ovh.com/fr/publiccloud/network-services/</li> <li>https://docs.ovh.com/fr/public-cloud/firewall_security_pci/</li> <li>https://docs.ovh.com/gb/en/kubernetes/ : doc de base pour Kubernetes</li> <li>https://docs.ovh.com/gb/en/kubernetes/kubernetes-plugins-software-versions-reserved-resources/ : important : le document montre les ressources r\u00e9serv\u00e9es \u00e0 Kubernetes dans les machines b2 ; et il montre aussi qu'on a flannel, calico, cinder. https://docs.ovh.com/gb/en/kubernetes/configuring-kubectl/ : configuration du kubectl : n\u00e9cessaire \u00e0 l'exploitation ; attention toutefois https://docs.ovh.com/gb/en/kubernetes/deploying-an-application/ : type LoadBalancer pour d\u00e9ployer un  service</li> </ul> <p>https://docs.ovh.com/gb/en/kubernetes/ovh-kubernetes-persistent-volumes/ : tr\u00e8s important : classes de stockage utilisables : csi-cinder-classic et csi-cinder-high-speed ; mode utilis\u00e9 : ReadWriteOnce : question : est-ce que ce ne serait pas judicieux de cr\u00e9er une classe de stockage sp\u00e9cifique pour le projet, histoire de pouvoir migrer quand il faudra ? A voir si c'est judicieux...</p> <p>https://docs.ovh.com/gb/en/kubernetes/using-lb/ : information importante : chaque loadBalancer va avoir son ip, et si on expose plusieurs services, cela pourrait devenir co\u00fbteux =&gt; d'o\u00f9 l'ingress derri\u00e8re le load balancer.</p> <p>https://docs.ovh.com/gb/en/kubernetes/getting-source-ip-behind-loadbalancer/ : justement l'exemple avec l'ingress nginx, mais c'est celui de kubernetes, pas celui de F5.</p> <p>https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/octavia-ingress-controller/using-octavia-ingress-controller.md#get-started-with-octavia-ingress-controller-for-kubernetes</p> <p>https://docs.openstack.org/magnum/ocata/dev/kubernetes-load-balancer.html : tr\u00e8s important : int\u00e8gre la notion de cloud provider : c'est ce qui fait la liaison entre K8s et Openstack.</p> <p>https://github.com/kubernetes/cloud-provider-openstack : la glue entre K8S et Openstack</p> <p>https://github.com/kubernetes/cloud-provider : la spec des impl\u00e9mentations de cloud provider</p> <p>https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/openstack-cloud-controller-manager/expose-applications-using-loadbalancer-type-service.md : TRES IMPORTANT : la grosse explication de la glue du load balancer : de ce que je comprends, si l'annotation <code>loadbalancer.openstack.org/load-balancer-id</code> n'existe pas, le load balancer cr\u00e9e pour le service sera indiqu\u00e9 dans ce champ ; s'il est d\u00e9j\u00e0 renseign\u00e9, le load balancer sera r\u00e9utilis\u00e9. Et il ne faut pas changer la valeur apr\u00e8s cr\u00e9ation du service, d'autant plus que cette annotation est prioritaire sur les autres \u00e9l\u00e9ments de d\u00e9finition du load balancer. R\u00e9cup\u00e9ration du load balancer via : <code>kubectl describe service service-1 | grep loadbalancer.openstack.org/load-balancer-id</code></p> <p>https://docs.openstack.org/octavia/zed/user/guides/basic-cookbook.html</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/infrastructure.html#notes-doc-openstack-neutron","title":"Notes Doc Openstack Neutron","text":"<p>Page 116/134 : One-to-one NAT In one-to-one NAT, the NAT router maintains a one-to-one mapping between private IP addresses and public IP addresses. OpenStack uses one-to-one NAT to implement \ufb02oating IP addresses.</p> <p>P 117 : in general, the OpenStack Networking software components that handle layer-3 operations impact perfor- mance and reliability the most. To improve performance and reliability, provider networks move layer-3 operations to the physical network infrastructure.</p> <p>P 119 : sch\u00e9ma int\u00e9ressant de diff\u00e9rents types de r\u00e9seaux</p> <p>P 120 : Security groups Security groups provide a container for virtual \ufb01rewall rules that control ingress (inbound to instances) and egress (outbound from instances) network tra\ufb03c at the port level. Security groups use a default deny policy and only contain rules that allow speci\ufb01c tra\ufb03c. Each port can reference one or more security groups in an additive fashion. The \ufb01rewall driver translates security group rules to a con\ufb01guration for the underlying packet \ufb01ltering technology such as iptables. Each project contains a default security group that allows all egress tra\ufb03c and denies all ingress tra\ufb03c. You can change the rules in the default security group. If you launch an instance without specifying a security group, the default security group automatically applies to it. Similarly, if you create a port without specifying a security group, the default security group automatically applies to it.</p> <p>P122 :LBaaS The Load-Balancer-as-a-Service (LBaaS) API provisions and con\ufb01gures load balancers. The reference implementation is based on the HAProxy software load balancer. See the Octavia project for more infor- mation.</p> <p>P123 : FWaaS The Firewall-as-a-Service (FWaaS) API allows to apply \ufb01rewalls to OpenStack objects such as projects, routers, and router ports.</p> <p>FWaaS v2 The newer FWaaS implementation, v2, provides a much more granular service. The notion of a \ufb01rewall has been replaced with \ufb01rewall group to indicate that a \ufb01rewall consists of two policies: an ingress policy and an egress policy. A \ufb01rewall group is applied not at the router level (all ports on a router) but at the port level. Currently, router ports can be speci\ufb01ed. For Ocata, VM ports can also be speci\ufb01ed.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/integration_ca.html","title":"Int\u00e9gration de CA dans ubuntu","text":"<p>Ubuntu a pr\u00e9vu un m\u00e9canisme sp\u00e9cifique (et simple) pour int\u00e9grer des CA dans le syst\u00e8me, et qui est reconnu notamment par PHP. Il est document\u00e9 \u00e0 https://ubuntu.com/server/docs/security-trust-store. Il s'agit :</p> <ul> <li>d'installer le package <code>ca-certificates</code></li> <li>de mettre le certificat CA en format PEM dans le r\u00e9pertoire <code>/usr/local/share/ca-certificates</code></li> <li>de lancer <code>update-ca-certificates</code> : ce dernier script va tenir compte du certificat ajout\u00e9.</li> </ul> <p>Un test avec un simple programme PHP peut \u00eatre utlis\u00e9 pour v\u00e9rifier si le CA est reconnu ou non. L'exemple en-dessous a \u00e9t\u00e9 r\u00e9alis\u00e9e avec le container httpd de test pr\u00e9par\u00e9 pour l'exp\u00e9rimentation Traefik, en modifiant la r\u00e9solution de nom du container pour r\u00e9soudre civicrm.test vers 127.0.0.1 dans <code>/etc/hosts</code>.</p> <pre><code>&lt;?php\n$c=curl_init(\"https://civicrm.test/index.php\");\ncurl_setopt($c,CURLOPT_RETURNTRANSFER,true);\ncurl_setopt($c,CURLOPT_SSL_VERIFYPEER,true);\n$ret=curl_exec($c);\n$info=curl_getinfo($c);\nvar_dump($info);\necho \"=============\\n\";\nvar_dump($ret);\n</code></pre> <p>Le test avant et apr\u00e8s int\u00e9gration du certificat a montr\u00e9 que l'URL n'a pas \u00e9t\u00e9 r\u00e9cup\u00e9r\u00e9e avant int\u00e9gration, alors qu'elle a \u00e9t\u00e9 r\u00e9cup\u00e9r\u00e9e apr\u00e8s int\u00e9gration.</p> <p>En revanche, il semblerait que tous les programmes n'utilisent pas ces m\u00e9canismes qui cherchent \u00e0 standardiser l'utilisation de CA au niveau syst\u00e8me : ainsi, un test sommaire avec Mutt n'a pas sembl\u00e9 fonctionner ; toutefois, Mutt propose une option d\u00e9di\u00e9e pour indiquer les CA : <code>ssl_ca_certificates_file</code>. Donc l'int\u00e9gration reste \u00e9galement faisable avec mutt.</p> <p>Cette technique permet donc l'int\u00e9gration de certificats au niveau syst\u00e8me. Dans le cadre de l'infrastructure microservices, l'int\u00e9gration de certificats pourra \u00e9ventuellement se faire lors de l'initialisation des containers. Il serait \u00e9galement possible de rajouter les certificats CA \"priv\u00e9s\" (par opposition aux certificats reconus par les grands acteurs) dans les images, mais cela semble a priori moins pertinent, puisque un CA \"priv\u00e9\" est a priori plut\u00f4t aff\u00e9rent \u00e0 un d\u00e9ploiement.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html","title":"Initialisation minikube Traefik avec un certificat wildcard","text":"<p>Cette initialisation d\u00e9coule du maquettage Traefik d\u00e9j\u00e0 effectu\u00e9 dans le cadre de la r\u00e9alisation des cas typiques d'utilisation, mais reste une \u00e9tude de maquettage.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#initialisation-minikube","title":"Initialisation minikube","text":"<p>On suppose que minikube est d\u00e9j\u00e0 install\u00e9. S'il ne l'est pas, on peut l'installer simplement sur les plateformes Debian/Ubuntu, car il existe des paquets pour apt.</p> <p>Du moment que minikube est install\u00e9, il faut initialiser un cluster. Il n'y a pas de sp\u00e9cificit\u00e9 \u00e0 ce niveau, si ce n'est \u00e9ventuellement de modifier les ressources maximales allouables au cluster et le choix d'une autre Container Network Interface que celle par d\u00e9faut.</p> <pre><code>minikube -p prepoc start --memory='3g' --cpus=3 --cni=calico\n</code></pre> <p>Dans l'exemple au-dessus, on utilise un cluster non par d\u00e9faut, en lui autorisant l'utilisation de 3Go de RAM et de 3 coeurs de CPU. Le CNI sett\u00e9 est calico, dans l'optique d'une utilisation ult\u00e9rieure des Network Policies de Kubernetes.</p> <p>Le fait d'utiliser un cluster non par d\u00e9faut va n\u00e9cessiter d'adapter \u00e9galement la mani\u00e8re dont kubectl va interagir avec le cluster (et probablement par ricochet, la mani\u00e8re dont Helm va aussi interagir aussi avec le cluster). Etant donn\u00e9 que minikube int\u00e8gre \u00e9galement une commande kubectl, le plus simple est de configurer un alias :</p> <p><pre><code>alias kubectl='minikube -p prepoc kubectl --'\n</code></pre> Du coup, on pourra utiliser simplement la commande kubectl pour interagir avec le cluster. Il convient d'ailleurs de mettre cet alias dans un <code>~/.bashrc</code> de sorte \u00e0 ce qu'il soit disponible plus simplement.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#installation-traefik","title":"Installation Traefik","text":""},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#recuperation-git","title":"R\u00e9cup\u00e9ration Git","text":"<p>L'installation de Traefik se fait via un chart helm dont on personnalise le fichier de valeurs. On r\u00e9cup\u00e8re le chart depuis git :</p> <pre><code>git clone https://github.com/traefik/traefik-helm-chart.git\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#fichier-de-valeurs","title":"Fichier de valeurs","text":"<p>Le fichier de valeurs qui peut \u00eatre utilis\u00e9 est le suivant : </p> <pre><code>poc.yaml \ndeployment:\n  kind: DaemonSet\nmetrics:\n  prometheus: null\nhostNetwork: true\nupdateStrategy:\n  type: OnDelete\nglobalArguments:\n  - \"--global.checknewversion\"\nports:\n  websecure:\n      port: 443\n      http:\n      tls:\nlogs:\n  general:\n    level: DEBUG\n  access:\n    enabled: true\n</code></pre> <p>Un certain nombre de commentaires est \u00e0 faire sur ce fichier :</p> <ul> <li>on utilise un DaemonSet pour initialiser un contr\u00f4lleur par noeud du cluster, de sorte \u00e0 ce que le trafic entrant puisse \u00eatre dirig\u00e9 via un loadBalancer sur n'importe quel noeud du cluster</li> <li>hostNetwork \u00e0 true : on utilise la connection r\u00e9seau de l'h\u00f4te - donc de minikube dans ce cas pour les points d'entr\u00e9es qui sont configur\u00e9s : \u00e7a devrait rendre les points d'entr\u00e9e disponibles.</li> <li>updateStrategy : deux sont disponible : OnDelete et RollingUpdate. Il est plus simple d'utiliser OnDelete dans les tests, car RollingUpdate suppose qu'il existe un nombre maximum d'instances qui peuvent \u00eatre indisponibles \u00e0 un moment donn\u00e9, ce qui est emb\u00eatant pour un cluster mononoeud</li> <li>globalArguments : le fichier de valeurs par d\u00e9faut propose encore d'autres arguments, dont en particulier <code>--global.sendanonymoususage</code>, d'o\u00f9 la surcharge pour \u00e9viter l'envoi de donn\u00e9es d'utilisation</li> <li>la configuration des ports : le nom utilis\u00e9 dans la litt\u00e9rature Traefik pour HTTPS est habituellement <code>websecure</code>, et la configuration d\u00e9ploy\u00e9e sugg\u00e8re que l'on travaille avec le port en HTTP (et pas TCP ou UDP) et avec TLS</li> <li>les logs : le log des acc\u00e8s a \u00e9t\u00e9 activit\u00e9, et le niveau de log a \u00e9t\u00e9 positionn\u00e9 sur <code>DEBUG</code> a des fins de d\u00e9buggage. Toutefois ces valeurs devront \u00eatre r\u00e9vis\u00e9es pour une \u00e9ventuelle production.</li> </ul> <p>L'installation proprement dite se fait (en ayant configur\u00e9 kubectl toutefois ) via helm, en supposant qu'on est dans le r\u00e9pertoire du fichier <code>Chart.yaml</code> et qu'on a utilis\u00e9 le fichier <code>values_prepoc.yaml</code> pour l'override des valeurs d'installation que l'on souhaite changer. L'utilisation d'un namespace tiers est optionnel - toutefois il permet de mieux ranger et retrouver les \u00e9l\u00e9ments des diff\u00e9rents composants.</p> <pre><code>helm install -n traefik --create-namespace --values values_prepoc.yaml traefik .\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#certificat-et-tlsstore-par-defaut","title":"Certificat et TLSStore par d\u00e9faut","text":"<p>Cette \u00e9tape est n\u00e9cessaire pour avoir une configuration TLS par d\u00e9faut qui n'aura pas besoin d'\u00eatre sp\u00e9cifi\u00e9e au niveau de chaque d\u00e9ploiement d'instance Civiparoisse.</p> <p>On suppose qu'on a r\u00e9cup\u00e9r\u00e9 un certificat wildcard depuis les scripts pr\u00e9sents dans les images <code>SELFKEYS</code> ou <code>KEYS_INIT</code> du projet. En ce qui concerne les clefs pour une mise en production sur infrastructure publique, il semble \u00e9ventuellement plus int\u00e9ressant d'automatiser la r\u00e9cup\u00e9ration de certification via des outils comme CertManager et l'interfa\u00e7age avec par exemple le protocole ACME.</p> <p>Les paires de clefs peuvent \u00eatre int\u00e9gr\u00e9es dans un cluster via la commande kubectl :</p> <pre><code>kubectl create secret tls  wildcardsecret --cert=./wildcard.x509 --key=./wildcard.pem -n default\n</code></pre> <p>On utilise ici le namespace par d\u00e9faut (indiqu\u00e9 explicitement, m\u00eame si c'est inutile puisqu'il s'agit justement du namespace par d\u00e9faut). Ensuite, pour exploiter le certificat, il vaut cr\u00e9er un objet de type TLSStore qui sera l'objet de TLSStore par d\u00e9faut (donc utilis\u00e9 par Traefik lorsque rien n'est mentionn\u00e9) : cet objet issu d'une CustomRessourceDefinition de Traefik doit s'appeller <code>default</code> et doit \u00eatre dans le namespace <code>default</code>. Le fait que l'objet est issu d'un CRD explique pourquoi on l'installe apr\u00e8s le chart Helm de Traefik.</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TLSStore\nmetadata:\n  name: default\n  namespace: default\nspec:\n  certificates:\n    - secretName: wildcardsecret\n  defaultCertificate:\n    secretName: wildcardsecret\n</code></pre> <p>De l\u00e0, Traefik est pr\u00eat \u00e0 \u00eatre utilis\u00e9 via l'adaptation du package Helm pour Civiparoisse.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#adaptation-helm-de-civiparoisse-pour-lexploitation-de-traefik","title":"Adaptation Helm de Civiparoisse pour l'exploitation de Traefik","text":"<p>Initialement, Civiparoisse avait \u00e9t\u00e9 pr\u00e9vu pour du SSL Passthrough et de l'authentification multifacteurs (Certificat SSL + mot de passe ). Ici, le trafic entrant passe par deux connections HTTPS : </p> <ul> <li>une liaison HTTPS entre le naviguateur et Traefik, qui utilise le certificat wildcard, et qui est donc couverte par ce qui a \u00e9t\u00e9 vu au-dessus.</li> <li>une liaison HTTPS entre Traefik et l'instance Civiparoisse concern\u00e9e, qui utilise le certificat et le CA g\u00e9n\u00e9r\u00e9s (nomm\u00e9s <code>extern</code>) lors de l'installation de l'instance Civiparoisse. Il faut donc en particulier faire la configuration n\u00e9cessaire pour que Traefik accepte le CA sp\u00e9cifique \u00e0 l'instance.</li> </ul> <p>La modification au niveau de l'installation (container d'INIT) a consist\u00e9 \u00e0 remettre en place la configuration reverse proxy qui avait \u00e9t\u00e9 mise en place initialement.</p> <p>Il y a \u00e9galement une modification de la g\u00e9n\u00e9ration du certificat pr\u00e9sent\u00e9 par Httpd, pour ajouter le nom externe comme Subject Alternate Name (sans quoi, Traefik n'acceptera pas le certificat m\u00eame si le CA est reconnu) : <pre><code>{{- $extern := genSignedCert .Values.externalhost nil (list $externalHost ) 365 $ca }}\n</code></pre></p> <p>Le certificat CA sera stock\u00e9 de mani\u00e8re explicite dans un secret TLS dans le namespace de l'instance de Civiaproisse</p> <pre><code>---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: externca\n  namespace: {{ .Release.Namespace }}\ntype: tls\ndata:\n  tls.crt: {{ $selfcert.cacert | default ($ca.Cert | b64enc) }}\n</code></pre> <p>On cr\u00e9e une route HTTP pour la configuration de Traefik pour matcher l'external host, et envoyer le trafic vers l'instance civicrm, en sp\u00e9cifiant le port de destination, ainsi que le d\u00e9tail de configuration de transport sp\u00e9cifi\u00e9 dans un objet de type <code>ServersTransport</code> :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressproxy\n  namespace: {{ .Release.Namespace }}\nspec:\n  entryPoints:\n    - websecure\n  routes:\n    - match: \"Host(`{{ .Values.externalhost }}`)\"\n      kind: Rule\n      services:\n        - name: civicrmhttpd\n          namespace: {{ .Release.Namespace }}\n          port: 443\n          serversTransport: transport-selfsigned\n  tls: {}\n</code></pre> <p>L'objet de type <code>ServersTransport</code> sp\u00e9cifie le nom que le certificat pr\u00e9sent\u00e9 doit v\u00e9rifier (donc le nom externe, ici), et sp\u00e9cifie le CA racine qui doit valider le certificat (et qui est donc dans le m\u00eame namespace que l'objet) :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: ServersTransport\nmetadata:\n  name: transport-selfsigned\n  namespace: {{ .Release.Namespace }}\nspec:\n  serverName: {{ .Values.externalhost }}\n  maxIdleConnsPerHost: {{ .Values.serverstransport.maxIdleConnsPerHost }}\n  disableHTTP2: {{ .Chart.Annotations.serverstransportDisableHTTP2 }}\n  forwardingTimeouts:\n    dialTimeout : {{ .Values.serverstransport.dialTimeout }}\n    responseHeaderTimeout: {{ .Values.serverstransport.responseHeaderTimeout }}\n    readIdleTimeout: {{ .Values.serverstransport.readIdleTimeout }}\n    idleConnTimeout: {{ .Values.serverstransport.idleConnTimeout }}\n  rootCAsSecrets:\n    - externca\n</code></pre> <p>Ces adaptations semblent fonctionner. Il est int\u00e9ressant de constater que la configuration propre \u00e0 chaque instance se situe dans le namespace de l'instance Civiparoisse, tandis que les r\u00e9glages globaux restent dans les namespaces de Traefik et le namespace par d\u00e9faut.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/minikube_traefik_wildcard.html#remediation-aux-gateway-timeouts-dus-au-handshake-tls","title":"Rem\u00e9diation aux gateway timeouts d\u00fbs au handshake TLS","text":"<p>Lors des tests en local, il a \u00e9t\u00e9 remarqu\u00e9 m\u00eame dans le cadre d'une configuration avec Docker qu'il y avait des timeouts d\u00fbs, selon les logs de Traefik \u00e0 des timeouts sur le handshake TLS. En effet, il semblerait qu'il y a des timeouts sur plusieurs phases de connexions avec l'impl\u00e9mentation net/http en Go (voir &lt;&gt;https://blog.cloudflare.com/the-complete-guide-to-golang-net-http-timeouts/&gt;) - ce qui est confort\u00e9 par la terminologie utilise. Malheureusement, Traefik ne permet pas de r\u00e9gler ce timeout. En revanche, il permet de r\u00e9gler d'autres timeouts, dont le dialTimeout.</p> <p>Le TLS Handshake est effectu\u00e9 apr\u00e8s le handshake TCP (SYN,SYN-ACK,ACK). Or, le handshake TCP est sous le contr\u00f4le du Kernel. En particulier, la page man de listen (voir https://www.man7.org/linux/man-pages/man2/listen.2.html) sp\u00e9cifie que la notion de Backlog a chang\u00e9 depuis le kernel 2.2 : les connexions qui entrent dans la file du backlog sont \u00e9tablies du point de vue TCP, ce qui d\u00e9clenche le d\u00e9lai d'attente sur le handshake TLS.</p> <p>Passer par le middleware inFlightReq de Traefik ne permet pas de r\u00e9soudre le probl\u00e8me, car il envoie aux clients des erreurs 429 \"Too Many Requests\",  pour lesquelles le naviguateur ne semble pas retenter de connection.</p> <p>La solution trouv\u00e9e est donc de configurer le ListenBacklog d'Apache https://httpd.apache.org/docs/2.4/mod/mpm_common.html#listenbacklog avec une valeur basse : on passe de la valeur par d\u00e9faut (511) \u00e0 une valeur de 1 (0 n'est pas autoris\u00e9 par Apache). Cette solution est admissible, car la manpage de Listen, confirm\u00e9e par une capture wireshark, montre que cela fait que certains paquets SYN sont ignor\u00e9s, ce qui permet effectivement de passer par la retransmission TCP pour retenter les connections. Du coup, les communications non \u00e9tablies au niveau TCP sont soumises au DialTimeout qui est configurable au niveau de Traefik (m\u00eame avec une valeur 0, sans timeout) - m\u00eame si on pr\u00e9f\u00e8rera mettre une valeur \u00e9lev\u00e9e que pas de valeur du tout pour \u00e9viter une saturation des capacit\u00e9s r\u00e9seau de Traefik lors de la mise en oeuvre de cette solution avec des instances Civiparoisse multiples.</p> <p>En compl\u00e9ment \u00e0 cette explication r\u00e9sum\u00e9e, il est int\u00e9ressant de voir sur https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203 que le Kernel dispose de deux files d'attentes, une avec des demandes de connexion non encore \u00e9tablies, et l'autre (celle du listen) avec des connexions \u00e9tablies au niveau TCP. L'int\u00e9r\u00eat de cette page est que l'on a des extraits du code de Kernel, avec les r\u00e9f\u00e9rences vers les fichiers sources, ce qui permet \u00e9galement d'aller voir les impl\u00e9mentations courantes des Kernel. C'est \u00e9galement l'existence de cette deuxi\u00e8me file de demandes de connexions (paquets TCP syn) qui permet de fonctionner et de l'utiliser comme file d'attente, voire tampon.</p> <p>On retiendra donc que ce contournement d\u00e9pend du Kernel. A cel\u00e0 s'ajoute que la RFC en vigueur par rapport au TCP est devenue la RFC 9293 (https://www.ietf.org/rfc/rfc9293.html) d'ao\u00fbt 2022, ce qui signifie que le protocole est sujet \u00e0 \u00e9volutions et donc que son impl\u00e9mentation peut \u00e9galement l'\u00eatre.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html","title":"Maquettage avec Traefik","text":"<p>Traefik est un reverse proxy qui s'int\u00e8gre facilement en environnement Kubernetes, car il dispose d'une installation via un chart Helm et fournit en particulier des CRDs qui permettent d'utiliser des d\u00e9clarations en YAML pour le configurer. De plus, il dipose d'une logique de configuration qui se laisse bien prendre en main :</p> <ul> <li>les ports d'\u00e9coute (entrypoints) se configurent au niveau de la chart Helm, car ces entrypoints sont configur\u00e9s de mani\u00e8re statique (le mieux est d'utiliser helm upgrade apr\u00e8s avoir modifi\u00e9 le fichier de valeurs) ; les ports d'\u00e9coutes sont nomm\u00e9s</li> <li>les routeurs permettent de sp\u00e9cifier des r\u00e8gles pour orienter le trafic vers des services d'upstream</li> <li>la configuration avec le service peut \u00eatre d\u00e9finie finement dans un ServersTransport</li> <li>des d\u00e9clarations de routes sp\u00e9cialis\u00e9es permettent de coordonner et de mettre en oeuvre els \u00e9l\u00e9mens cit\u00e9s : <ul> <li>IngressRoute pour un point d'entr\u00e9e HTTP</li> <li>IngressRouteTCP pour un point d'entr\u00e9e TCP</li> <li>IngressRouteUDP pour un point d'entr\u00e9e UDP</li> </ul> </li> </ul>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#scenarios-maquettes","title":"Sc\u00e9narios maquett\u00e9s","text":"<p>Un certain nombre de sc\u00e9narios ont \u00e9t\u00e9 maquett\u00e9s, car ils ont permis d'apprivoiser la configuration pas \u00e0 pas et certains pourraient servir dans le cas du trafic entrant du pr\u00e9poc :</p> <ul> <li>proxy HTTP-&gt;HTTP</li> <li>proxy TCP -&gt; HTTP (avec protocole PROXY uniquement, sans r\u00e8gle sur le host)</li> <li>proxy TCP -&gt; HTTPS (avec protocole PROXY et analyse du SNI)</li> <li>Offloading HTTPS-&gt;HTTP</li> <li>proxy HTTPS-&gt;HTTPS</li> <li>proxy HTTPS (avec protocole PROXY en entr\u00e9e)-&gt; HTTPS</li> <li>proxy TCP (avec protocole PROXY en entr\u00e9e) -&gt; HTTPS (avec protocole PROXY et analyse du SNI)</li> </ul> <p>A noter que les configurations n'ont pas \u00e9t\u00e9 des configurations multi-namespaces. Elles ont \u00e9t\u00e9 r\u00e9alis\u00e9es dans le namespace default.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#installation","title":"Installation","text":"<p>L'installation se fait simplement via la Chart Helm, que l'on r\u00e9cup\u00e8re depuis https://github.com/traefik/traefik-helm-chart.git. Pour simplifier le maquettage, un port d'entr\u00e9e a \u00e9t\u00e9 d\u00e9di\u00e9 \u00e0 chaque sc\u00e9nario, au travers d'un fichier d'override de <code>values.yaml</code></p> <pre><code>deployment:\n  kind: DaemonSet\nmetrics:\n  prometheus: null\nhostNetwork: true\nupdateStrategy:\n  rollingUpdate:\n    maxUnavailable: 2\n    maxSurge: \nglobalArguments:\n  - \"--global.checknewversion\"\nports:\n  websecure:\n      port: 9443\n  testhttp:\n      port: 7080\n      http:\n  testproxyhttp:\n      port: 7081\n  testhttps:\n      port: 7082\n      http:\n      tls:\n  testproxyhttps:\n      port: 7083\n  testfphttps:\n      port: 7084\n      proxyProtocol:\n        insecure: true\n      tls:\n  testfpsni:\n      port: 7086\n      proxyProtocol:\n        insecure: true\n  testoffload:\n     port: 7085\n     http:\n     tls:\n\nservice:\n  type: NodePort\n\nlogs:\n  general:\n    level: DEBUG\n  access:\n    enabled: true\n</code></pre> <p>Les \u00e9l\u00e9ments clefs de cette configuration sont :</p> <ul> <li>le type d'installation pr\u00e9vue : un DaemonSet : devrait \u00eatre arrangeant pour avoir des points d'entr\u00e9e multiples dans le cluster</li> <li>hostNetwork : permet d'utiliser les ports r\u00e9seaux du noeud K8S</li> <li>updateStrategy : cette configuration a \u00e9t\u00e9 modifi\u00e9e uniquement pour faire passer l'installation pour le DaemonSet et valider les v\u00e9rifications mise en place au niveau Helm ; des valeurs r\u00e9ellement fonctionnelles devront toutefois \u00eatre \u00e9tudi\u00e9es dans un contexte de mise en oeuvre r\u00e9elle</li> <li>globalArguments : cette configuration permet d'outrepasser la configuration par d\u00e9faut qui envoie des statistiques anonymes</li> <li>les ports : il ne faut pas utiliser le port 8443 qui est d\u00e9j\u00e0 utilis\u00e9 par Minikube, d'o\u00f9 le 8443 ; quand aux autres ports, ils ne doivent pas \u00eatre interdits par le naviguateur</li> <li>le type de service : NodePort : on utilise des ports du noeud</li> <li>la configuration des logs : cette configuration permet en particulier d'avoir des informations de debuggage sur les connexions dans les logs du container de Traefik ; cette configuration permet notamment de comprendre lorsque surviennent des probl\u00e8mes d'acceptation de certificats par Traefik</li> </ul> <p>L'installation, et les upgrades successifs pour arriver \u00e0 cette configuration, ont \u00e9t\u00e9 faits via Helm apr\u00e8s avoir r\u00e9cup\u00e9r\u00e9 le chart depuis Git, ce qui a facilit\u00e9 la lecture des d\u00e9finitions CRDs et donc l'utilisation des objets. L'installation a \u00e9t\u00e9 faite sur un minikube frais avec le cni calico, en pr\u00e9vision d'\u00e9ventuels tests conjoints.</p> <pre><code>minikube -p tp --cni calico start #cr\u00e9ation du cluster de test\nalias kubectl='minikube -p tp kubectl --' # modification de l'alias kubectl pour pointer vers le bon cluster\nhelm install --create-namespace -n traefik -f values_jm.yaml traefik . # installation de traefik en utilisant un fichier d'override de values.yaml\nhelm upgrade -n traefik -f values_jm.yaml traefik . #upgrade de traefik\n</code></pre> <p>A noter : Traefik serait install\u00e9 directement lorsqu'on passe par K3S.</p> <p>En utilisant kubectl, on peut d\u00e9crire le pod et voir les entrypoints qui ont \u00e9t\u00e9 ajout\u00e9s sur la ligne de commande via helm :</p> <pre><code>    Args:\n      --global.checknewversion\n      --entrypoints.metrics.address=:9100/tcp\n      --entrypoints.testfphttps.address=:7084/tcp\n      --entrypoints.testfpsni.address=:7086/tcp\n      --entrypoints.testhttp.address=:7080/tcp\n      --entrypoints.testhttps.address=:7082/tcp\n      --entrypoints.testoffload.address=:7085/tcp\n      --entrypoints.testproxyhttp.address=:7081/tcp\n      --entrypoints.testproxyhttps.address=:7083/tcp\n      --entrypoints.traefik.address=:9000/tcp\n      --entrypoints.web.address=:8000/tcp\n      --entrypoints.websecure.address=:9443/tcp\n      --api.dashboard=true\n      --ping=true\n      --providers.kubernetescrd\n      --providers.kubernetesingress\n      --entrypoints.testfphttps.proxyProtocol.insecure\n      --entrypoints.testfpsni.proxyProtocol.insecure\n      --entrypoints.websecure.http.tls=true\n      --log.level=DEBUG\n      --accesslog=true\n      --accesslog.fields.defaultmode=keep\n      --accesslog.fields.headers.defaultmode=drop\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#serveur-de-test","title":"Serveur de test","text":"<p>Il faut bien entendu avoir un serveur de test pour r\u00e9pondre aux requ\u00eates HTTP/HTTPS : ce serveur est un serveur Httpd, avec, lorsque c'est n\u00e9cessaire, le support SSL et Proxy (v1 uniquement, selon le maquettage) via le module RemoteIP. Un simple appel \u00e0 <code>phpinfo</code> permet d'afficher une panoplie d'informations sur l'appel, tandis qu'une capture via <code>tcpdump</code> effectu\u00e9e dans le container permet de r\u00e9cup\u00e9rer le trafic r\u00e9seau et constater notamment l'emploi du protocole PROXY.</p> <pre><code>FROM ubuntu/apache2:2.4-20.04_beta\nLABEL uepal.name=\"httpd\" uepal.version=\"0.0.4\"\nENV SERVERNAME=civicrm.test\nRUN apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y openssl ca-certificates php7.4 php7.4-cli php7.4-curl php7.4-gd php7.4-intl php7.4-mysql php7.4-opcache php7.4-xml php7.4-bcmath php7.4-mbstring php7.4-soap php7.4-xsl php7.4-zip php7.4-imagick &amp;&amp; apt-get install -y nano less tcpdump mc &amp;&amp; apt-get remove --purge --auto-remove -y \nCOPY index.php /var/www/html/\nCOPY confssl.conf /etc/apache2/sites-available/\nCOPY tproxy.conf /etc/apache2/sites-available/\nCOPY tproxyssl.conf /etc/apache2/sites-available/\nRUN mkdir /etc/apache2/KEYS\nCOPY tls.key /etc/apache2/KEYS/\nCOPY tls.crt /etc/apache2/KEYS/\nRUN service apache2 stop &amp;&amp; a2enmod ssl &amp;&amp; a2enmod remoteip &amp;&amp; a2enmod rewrite &amp;&amp; a2ensite confssl &amp;&amp; a2ensite tproxy &amp;&amp; a2ensite tproxyssl &amp;&amp; chown root:root /etc/apache2/sites-available/*.conf &amp;&amp; chmod 400 /etc/apache2/sites-available/*.conf\nEXPOSE 80\nEXPOSE 443\nEXPOSE 8080\nEXPOSE 8443\n</code></pre> <p>Port 80 : HTTP, Port 443 : HTTPS,et pendants 8080 et 8443 avec Proxy Protocol. le Proxy Protocol a cependant \u00e9t\u00e9 utilis\u00e9 de mani\u00e8re non s\u00e9curis\u00e9e car il n'y a pas eu de whitelisting d'IP source mise en oeuvre. En configuration r\u00e9elle, on devra soit r\u00e9aliser cette configuration, soit r\u00e9aliser un service mesh ou des limitations tierces par exemple avec des d\u00e9clarations NetworkPolicy.</p> <p>Configurations : </p> <ul> <li> <p>HTTP : on utilise la configuration par d\u00e9faut</p> </li> <li> <p>HTTPS : on utilise un certificat autog\u00e9n\u00e9r\u00e9</p> </li> </ul> <pre><code>&lt;VirtualHost *:443&gt;\nSSLCertificateKeyFile \"/etc/apache2/KEYS/tls.key\"\nSSLCertificateFile \"/etc/apache2/KEYS/tls.crt\"\nDocumentRoot /var/www/html\nServerName civicrm.test\n&lt;Directory /var/www/html&gt;\nOrder allow,deny\nAllow from All\n&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>Proxy + HTTP :</li> </ul> <pre><code>Listen *:8080\n&lt;VirtualHost *:8080&gt;\nDocumentRoot /var/www/html\nServerName civicrm.test\nRemoteIPProxyProtocol On\n&lt;Directory /var/www/html&gt;\nOrder allow,deny\nAllow from All\n&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>Proxy + HTTPS : </li> </ul> <pre><code>Listen *:8443\n&lt;VirtualHost *:8443&gt;\nSSLCertificateKeyFile \"/etc/apache2/KEYS/tls.key\"\nSSLCertificateFile \"/etc/apache2/KEYS/tls.crt\"\nSSLEngine on\nDocumentRoot /var/www/html\nServerName civicrm.test\nRemoteIPProxyProtocol On\nSSLOptions +StrictRequire\n&lt;Directory /var/www/html&gt;\nOrder allow,deny\nAllow from All\nSSLRequireSSL\n&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n</code></pre> <p>On constate que la configuration en proxy + https a \u00e9t\u00e9 renforc\u00e9e pour forcer l'utilisation du HTTPS, via l'activation explicite du SSLEngine, et les directions SSLOptions et SSLRequireSSL.</p> <p>En ce qui concerne l'int\u00e9gration dans Kubernetes, un simple Deployment et des services ont \u00e9t\u00e9 cr\u00e9es : </p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: default\n  name: httpd\n  labels:\n    app: httpd\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpd\n  template:\n    metadata:\n       labels:\n         app: httpd\n    spec:\n      containers:\n      - name: httpd\n        image: uepal_test/test_httpd\n        imagePullPolicy: Never\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: testhttp\nspec:\n  selector:\n    app: httpd\n  ports:\n   - protocol: TCP\n     port: 80\n     targetPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: testhttps\nspec:\n  selector:\n    app: httpd\n  ports:\n   - protocol: TCP\n     port: 443\n     targetPort: 443\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: testproxyhttp\nspec:\n  selector:\n    app: httpd\n  ports:\n   - protocol: TCP\n     port: 8080\n     targetPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: testproxyhttps\nspec:\n  selector:\n    app: httpd\n  ports:\n   - protocol: TCP\n     port: 8443\n     targetPort: 8443\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#integration-des-clefs-ssl-dans-les-secrets","title":"Int\u00e9gration des clefs SSL dans les secrets","text":"<p>Les clefs ont \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9es en-dehors du cluster K8S. </p> <p>Pour int\u00e9grer une paire de clef dans K8S, kubectl fournit un format \"g\u00e9n\u00e9rique\" :</p> <p><pre><code>kubectl create secret tls civicrm -n default --cert=tls.crt --key=tls.key\n</code></pre> La paire clef/certificat est alors disponible dans le champs tls.crt et tls.key du secret appel\u00e9 civicrm. Ce format est reconnu par Traefik.</p> <p>En revanche, pour int\u00e9grer un certificat uniquement (comme un certificat racine), on doit plut\u00f4t passer par la cr\u00e9ation g\u00e9n\u00e9rique d'un secret :</p> <pre><code>kubectl create secret generic selfsigned --type=opaque -n default --from-file=tls.ca=tls.crt\n</code></pre> <p>Le certificat sera reconnu dans la clef tls.ca du certificat appel\u00e9 selfsigned dans l'exemple au-dessus.</p> <p>A noter que Traefik peut chercher des informations sur l'identit\u00e9 couverte par le certificat dans le Subject Alt Name : d'o\u00f9 la notion de SAN qui appara\u00eet dans certains messages de debug. M\u00eame si l'on met usuellement des noms DNS dans les SAN, il semblerait (non test\u00e9) qu'on pourrait mettre \u00e9galement des IP.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-http-http","title":"Configuration HTTP-&gt;HTTP","text":"<p>Une ingressRoute assez simple suffit, puisque le trafic g\u00e9r\u00e9 est du HTTP :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: testhttp\n  namespace: default\nspec:\n  entryPoints:\n    - testhttp\n  routes:\n    - match: \"Host(`civicrm.test`)\"\n      kind: Rule\n      services:\n        - name: testhttp\n          namespace: default\n          port: 80\n</code></pre> <p>On constate l'emploi du proxy dans la r\u00e9ponse car phpinfo d\u00e9tecte les headers ajout\u00e9s, dont : * <code>HTTP_X_FORWARDED_SERVER</code> * <code>HTTP_X_FORWARDED_FOR</code> * <code>HTTP_X_FORWARDED_HOST</code> * <code>HTTP_X_FORWARDED_PORT</code> * <code>HTTP_X_FORWARDED_PROTO</code> * <code>HTTP_X_REAL_IP</code></p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-proxy-tcp-http","title":"Configuration proxy TCP -&gt; HTTP","text":"<p>La configuration est \u00e9galement assez simple, mais utilise une IngressRouteTCP du fait du travail au niveau TCP : </p> <p><pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: testproxyhttp\n  namespace: default\nspec:\n  entryPoints:\n    - testproxyhttp\n  routes:\n    - match: \"HostSNI(`*`)\"\n      services:\n        - name: testproxyhttp\n          namespace: default\n          port: 8080\n          proxyProtocol:\n            version: 1\n</code></pre> On notera toutefois la pr\u00e9sente du match sur le HostSNI avec la valeur de \u00e9toile : cette r\u00e8gle a \u00e9t\u00e9 utilis\u00e9e pour matcher dans la plupart des cas (si ce n'est tous). lLe protocole PROXY est activ\u00e9 en version 1.</p> <p>Au niveau du r\u00e9sultat, on voit dans une capture wireshark les enregistrements suivants : </p> <pre><code>PROXY TCP4 192.168.67.1 192.168.67.2 53408 7081\nGET /index.php HTTP/1.1\nHost: civicrm.test:7081\nConnection: keep-alive\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (X11; CrOS aarch64 13597.84.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nAccept-Encoding: gzip, deflate\nAccept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 22:50:57 GMT\nServer: Apache/2.4.41 (Ubuntu)\nVary: Accept-Encoding\nContent-Encoding: gzip\nContent-Length: 24575\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\nContent-Type: text/html; charset=UTF-8\n</code></pre> <p>Plus bas, dans deux extraits de la r\u00e9ponse :  <pre><code>&lt;tr&gt;&lt;td class=\"e\"&gt;REMOTE_ADDR &lt;/td&gt;&lt;td class=\"v\"&gt;192.168.67.1 &lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td class=\"e\"&gt;REMOTE_PORT &lt;/td&gt;&lt;td class=\"v\"&gt;39920 &lt;/td&gt;&lt;/tr&gt;\n</code></pre></p> <p>On constate dans la r\u00e9ponse la modification du champ REMOTE_ADDR, mais pas du remote port, sachant que les communications ont \u00e9t\u00e9 effectu\u00e9es entre 10.244.105.64/39920 et 10.244.105.80/8080 en TCP.</p> <p>Le module remote IP a donc fait son travail au niveau de l'IP, mais pas du port.</p> <p>Comme Traefik est intervenu au niveau TCP, le trafic HTTP n'a pas \u00e9t\u00e9 modifi\u00e9, et il n'y a donc pas eu des ajouts de headers <code>X_FORWARDED</code>.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-tcp-https-tls-passthrough","title":"Configuration TCP -&gt; HTTPS (tls passthrough)","text":"<p>La configuration ressemble au test effectu\u00e9 plus haut, avec toutefois une utilisation de la fonction HostSNI dans la r\u00e8gle de match, et la sp\u00e9cification du tls passthrough.</p> <p><pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: testproxyhttps\n  namespace: default\nspec:\n  entryPoints:\n    - testproxyhttps\n  routes:\n    - match: \"HostSNI(`civicrm.test`)\"\n      services:\n        - name: testproxyhttps\n          namespace: default\n          port: 8443\n          proxyProtocol:\n            version: 1\n  tls:\n     passthrough: true\n</code></pre> On voit dans la capture wireshark le protocole PROXY suivi de la n\u00e9gociation TLS, comme on s'y attendrait. Au niveau du navigateur, on voit effectivement les caract\u00e9ristiques du certificat HTTPS embarqu\u00e9 dans le d\u00e9ploiement httpd.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-ssl-offload","title":"Configuration SSL Offload","text":"<p><pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: testoffload\n  namespace: default\nspec:\n  entryPoints:\n    - testoffload\n  routes:\n    - match: \"Host(`civicrm.test`)\"\n      kind: Rule\n      services:\n        - name: testhttp\n          namespace: default\n          port: 80\n  tls:\n    secretName: civicrm\n    store:\n      name: civicrm\n      namespace: default\n</code></pre> On travaille avec une IngressRoute, car Traefik fournit un travail au niveau HTTP, en recevant une requ\u00eate via HTTPS et en faisant une sous-requ\u00eate HTTP. Le certificat est stock\u00e9 dans la clef civicrm (certificat diff\u00e9rent de celui utilis\u00e9 dans le container), et on constate son utilisation au niveau du naviguateur au niveau des caract\u00e9ristiques du certificat, ainsi que la pr\u00e9sence des headers rajout\u00e9s par le forwarding.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-https-https","title":"Configuration HTTPS-&gt;HTTPS","text":"<p>Dans ce cas, il faut faire accepter \u00e0 Traefik le certificat du serveur httpd, ce qui est fait en sp\u00e9cifiant une configuration de ServersTransport ad\u00e9quate : </p> <p><pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: ServersTransport\nmetadata:\n  name: transport-selfsigned\n  namespace: default\nspec:\n  serverName: civicrm.test\n  rootCAsSecrets:\n    - selfsigned\n</code></pre> Le secret selfsigned a \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9 comme vu plus haut.</p> <p>Il fallait donc utiliser ce ServersTransport dans une IngressRoute : </p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: testhttps\n  namespace: default\nspec:\n  entryPoints:\n    - testhttps\n  routes:\n    - match: \"Host(`civicrm.test`)\"\n      kind: Rule\n      services:\n        - name: testhttps\n          namespace: default\n          port: 443\n          serversTransport: transport-selfsigned\n  tls:\n    secretName: civicrm\n    store:\n      name: civicrm\n      namespace: default\n</code></pre> <p>Ici, on a l'utilisation de la r\u00e8gle Host, car on travaille au niveau HTTP. On constate que le certificat employ\u00e9 au niveau du navigateur est celui de Traefik alors qu'il a fallu faire accepter le certificat du serveur interne \u00e0 Trafic pour que la communication se fasse : on a donc effectivement deux communications HTTPS.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-proxyv1-tls-passthrough","title":"Configuration PROXYv1 + TLS Passthrough","text":"<p>Il s'agit d'une variante de la configuration TCP -&gt; HTTPS vue avant :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: testfpsni\n  namespace: default\nspec:\n  entryPoints:\n    - testfpsni\n  routes:\n    - match: \"HostSNI(`civicrm.test`)\"\n      services:\n        - name: testproxyhttps\n          namespace: default\n          port: 8443\n          proxyProtocol:\n            version: 1\n  tls:\n     passthrough: true\n</code></pre> <p>On se rappellera que la configuration du ProxyProtocol en entr\u00e9e a \u00e9t\u00e9 effectu\u00e9e sur l'entrypoint dans l'override du values.yaml, ce qu'on voit sur les arguments de configuration avec <code>--entrypoints.testfpsni.proxyProtocol.insecure</code>.</p> <p>On peut tester avec curl pour v\u00e9rifier si cela fonctionne : </p> <pre><code>curl --haproxy-protocol --insecure -o - --trace - https://civicrm.test:7086/index.php|less\n</code></pre> <p>Au niveau de l'\u00e9change, on voit la charge PROXY au d\u00e9but du flux de curl, et que c'est le certificat de httpd qui est pr\u00e9sent\u00e9 \u00e0 curl, et que les headers de forward ne sont donc pas pr\u00e9sents.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#configuration-proxyv1-https-https","title":"Configuration PROXYv1 + HTTPS-&gt;HTTPS","text":"<p>La configuration est quasi identique \u00e0 celle de HTTPS-&gt;HTTPS, avec surtout l'activation du protocole PROXY via l'override de values.yaml qui a conduit \u00e0 la pr\u00e9sence dans les arguments du container Traefik de <code>--entrypoints.testfphttps.proxyProtocol.insecure</code>.</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: testfphttps\n  namespace: default\nspec:\n  entryPoints:\n    - testfphttps\n  routes:\n    - match: \"Host(`civicrm.test`)\"\n      kind: Rule\n      services:\n        - name: testhttps\n          namespace: default\n          port: 443\n          serversTransport: transport-selfsigned\n  tls:\n    secretName: civicrm\n    store:\n      name: civicrm\n      namespace: default\n</code></pre> <pre><code>curl --haproxy-protocol --insecure -o - --trace - https://civicrm.test:7084/index.php|less\n</code></pre> <p>Au niveau de l'\u00e9change, curl montre la charge PROXY ajout\u00e9e, et voit le certificat fourni \u00e0 Traefik, ainsi que les headers de forward. En revanche, curl ne permet a priori pas de modifier le header PROXY g\u00e9n\u00e9r\u00e9 \u00e0 la vol\u00e9e. Il faudrait donc tester ult\u00e9rieurement si ce sont bien les informations d'entr\u00e9e qui sont recopi\u00e9es ensuite dans les headers HTTPS.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/traefik.html#conclusion","title":"Conclusion","text":"<p>En conclusion, on constate que Traefik est tr\u00e8s polyvalent et pourra servir d'ingress dans la plupart des cas. En revanche, il faudra encore approfondir la compr\u00e9hension de ses fonctions et notamment l'observabilit\u00e9, sans compter qu'il pourrait int\u00e9ressant de voir l'int\u00e9gration des r\u00e8gles mod_security (ou \u00e9quivalent).</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html","title":"Choix de l'architecture pour le trafic initiateur entrant","text":"<p>Il semble \u00eatre judicieux de placer les noeuds Kubernetes dans un r\u00e9seau priv\u00e9, s\u00e9par\u00e9 du r\u00e9seau public. Au niveau IP au niveau de Kubernetes, il sera de bon ton soit de mettre en oeuvre des objets de type NetworkPolicy pour avoir des limitations plus fortes sur le trafic li\u00e9 aux containers, soit de mettre en oeuvre un service mesh qui sera configur\u00e9 avec les limitations \u00e9quivalentes.</p> <p>Le trafic initiateur sortant sera g\u00e9r\u00e9 via du SNAT avec l'option gateway expliqu\u00e9e dans le contexte OVH dans les concepts r\u00e9seaux du public cloud, et ne pose donc pas de grand probl\u00e8me.</p> <p>En revanche, pour le trafic initiateur entrant, les choses sont plus complexes, et il y a lieu de voir comment on souhaite traiter ce trafic.</p> <p>Une configuration document\u00e9e chez OVH est le load balancer avec une IP flottante. Toutefois, l'\u00e9tude plus pr\u00e9cise des \u00e9l\u00e9ments de la solution met en \u00e9vidence qu'il y a plusieurs variantes qui peuvent \u00eatre mises en oeuvre, et qu'aucune solution ne semble parfaite. La mise en place du load balancer semble \u00e9galement devoir \u00eatre regard\u00e9e au travers de la documentation sp\u00e9cifique du LB du cloud provider openstack pour mieux comprendre les tenants et aboutissants.</p> <p>Etant donn\u00e9 qu'aucune solution parfaite ne se d\u00e9tache en utilisant directement le load balancer, on pourra \u00e9galement chercher \u00e0 \u00e9largir la discussion pour voir si un autre type de solution ne pourrait pas \u00e9galement convenir.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#mise-en-oeuvre-du-load-balancer","title":"Mise en oeuvre du load balancer","text":""},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#tronc-commun","title":"Tronc commun","text":"<p>La mise en oeuvre du load balancer consiste au niveau de Kubernetes d'instancier un service de type load balancer, et d'utiliser les s\u00e9lecteurs pour faire passer le trafic vers un contr\u00f4lleur ingress configur\u00e9 par exemple en daemonset pour \u00eatre pr\u00e9sent dans tous les noeuds de travail; le contr\u00f4lleur ingress va utiliser sa configuration pour jouer un r\u00f4le de reverse proxy et envoyer le trafic vers le container httpd de la paroisse concern\u00e9e.</p> <p>Ce tronc commun est assez int\u00e9ressant : le load balancer n\u00e9cessitant une IP virtuelle dite flottante, on peut supposer qu'il y a un m\u00e9canisme de failover entre plusieurs instances de loadbalancer qui vont se partager l'IP flottante, ce qui fait qu'il n'y a pas \u00e0 ce niveau de Single Point Of Failure (SPOF).</p> <p>De plus, au niveau du load balancer, le fait d'utiliser dans tous les cas le protocole TCP en tant que protocole de transport permet de d\u00e9tecter si un contr\u00f4lleur ingress ne r\u00e9pond plus au minimum au niveau de la couche transport. S'ajoute \u00e0 cel\u00e0 que le load balancer permet d'envoyer le trafic vers un ensemble d'endpoints gr\u00e2ce \u00e0 la configuration du service au niveau de Kubernetes, on peut donc en d\u00e9duire que le load balancer pourra envoyer le trafic vers les noeuds qui fonctionnent, ce qui fait qu'on n'introduit pas de SPOF \u00e0 ce niveau non plus.</p> <p>Au niveau d'Openstack, le service en charge de la configuration des load balancers est Octavia. Octavia peut lancer diff\u00e9rents types de load balancers, en fonction des drivers charg\u00e9s. Dans les load balancers, il y a notamment l'\u00e9ventualit\u00e9 d'utiliser HAProxy. Toutefois, selon la fiche commerciale du load balancer, on peut au minimum remarquer qu'il y a le support de plusieurs protocoles, dont TCP, HTTP, HTTPS, PROXY, PROXY2. On peut trouver une documentation assez int\u00e9ressante  dans un article sur la configuration du load balancer au niveau d'une explication d'Openstack avec Kubernetes et d'autre part, dans la documentation d'Octavia, partie end-user.</p> <p>Le fait de passer par le load balancer peut amoindrir certains risques d'attaques (par exemple, un ensemble de connexions TCP en partie ouvertes uniquement, ou dans le cas du HTTP, le load balancer peut faire certaines v\u00e9rifications sur la requ\u00eate). Ceci est en partie visible sur la description de la SSL Gateway d'OVH, qui est un produit distinct.</p> <p>En revanche, le fait de passer par le load balancer puis par le noeud ingress fait que l'IP originelle n'est plus disponible \"naturellement\", puisqu'on a au minimum plusieurs sessions TCP qui prennent part au traitement d'une requ\u00eate au niveau de la couche applicative (L7).</p> <p>De plus, en fonction des configurations, dans le cas g\u00e9n\u00e9ral de plusieurs serveurs qui peuvent traiter une requ\u00eate, peut \u00e9galement se poser la question de la notion de session, et du stockage/partage de la session utilisateur, ou de l'envoi d'une requ\u00eate vers un serveur sp\u00e9cifique s'occupant de la session de l'utilisateur. Toutefois, cette probl\u00e9matique n'a pas encore lieu dans Civiparoisse, puisqu'on ne d\u00e9ploie qu'un seul httpd par instance.</p> <p>Enfin, au niveau de chaque httpd de civiparoisse, si ce n'est plus t\u00f4t, on pourra envisager d'utiliser <code>mod_security</code> comme firewall applicatif. <code>Mod_security</code> est d'ailleurs une option sur certains h\u00e9bergements OVH.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#protocoles-proxy-et-proxy2","title":"Protocoles PROXY et PROXY2","text":"<p>Les protocoles PROXY et PROXY2 sont une innovation qui vient visiblement de HAProxy, et qui n'est vraisemblablement pas document\u00e9 dans une RFC, mais dans des sp\u00e9cifications h\u00e9berg\u00e9es sur Github. Le propre de ce protocole est de constater que les proxys L4 ne disposent pas de solution standard pour faire remonter les informations d'IP/port originelles jusqu'aux destinataires, tandis que certains proxys L7 (dont reverse proxy HTTP) le font. Le protocole PROXY ajoute au d\u00e9but du flux TCP un ent\u00eate pour faire transiter les informations originelles au destinataire. Le protocole est plut\u00f4t textuel dans le cas de PROXYv1, mais est binaire dans le cas de PROXYv2. Le protocole PROXYv2 d\u00e9finit en plus des extensions pour pouvoir v\u00e9hiculer des informations suppl\u00e9mentaires en particulier sur les n\u00e9gocations SSL (par exemple, la valeur du SNI).</p> <p>Ce protocole est donc assez simple, mais n\u00e9cessite d'\u00eatre impl\u00e9ment\u00e9 et activ\u00e9 \u00e0 la fois par le client et le serveur, et il faut en plus faire confiance au client (d'o\u00f9 des m\u00e9canismes de whitelisting par exemple) quant aux informations originelles donn\u00e9es, puisque le serveur ne peut pas les v\u00e9rifier. Un autre type de protection qui peut \u00e9galement faire l'affaire serait une protection protocolaire comme la mise en oeuvre d'IPSec, ou un \u00e9ventuel service mesh, en fonction de l'origine de l'information du protocole PROXY.</p> <p>Ce protocole est g\u00e9r\u00e9 au minimum partiellement dans certains produits : </p> <ul> <li>haproxy</li> <li>curl : l'option <code>--haproxy-protocol</code> permet de g\u00e9n\u00e9rer des ent\u00eates PROXY</li> <li>apache : le module remote_ip g\u00e8re le protocole PROXY (mais visblement pas PROXY2)</li> <li>traefik : le protocole PROXY peut \u00eatre employ\u00e9 aussi bien sur le point d'entr\u00e9e que vers un serveur \"upstream\".</li> </ul>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#deploiement-de-type-tcptls-passthrough","title":"D\u00e9ploiement de type TCP/TLS Passthrough","text":"<ul> <li>On a une communication chiffr\u00e9e de bout en bout au niveau HTTPS, c'est \u00e0 dire depuis le naviguateur client jusqu'\u00e0 l'instance HTTPD Civiparoisse cible</li> <li>On a plusieurs communications TCP, donc L4, qui vont faire l'aboutement pour la communication L7 :<ul> <li>le load balancer est configur\u00e9 pour faire uniquement du load balancing TCP : il y a donc une liaison TCP entre le naviguateur et le load balancer d'une part, et le load balancer et l'ingress d'un noeud Kubernetes d'autre part</li> <li>l'ingress Kubernetes est r\u00e9gl\u00e9 en TLS passthrough : il utilise l'information Server Name Indication pr\u00e9sente en clair dans le premier paquet de n\u00e9gociation TLS pour d\u00e9terminer quel serveur cible l'ingress doit contacter : il y a donc une liaison TCP qui va \u00eatre mise en place entre l'ingress et le serveur HTTPD de l'instance Civiparoisse concern\u00e9e</li> </ul> </li> </ul> <p>L'int\u00e9r\u00eat de cette solution est qu'une seule communication HTTPS est pr\u00e9sente de bout en bout : il n'y a pas besoin de faire confiance \u00e0 un prestataire sur le chemin. Ceci est un gage de confiance pour les paroisses. On peut supposer que le load balancer L4 pourra stopper une partie des attaques.</p> <p>En revanche, cela veut dire qu'une partie des attaques qui auraient p\u00fb \u00eatre stopp\u00e9es par un load balancer L7 ne seront pas stopp\u00e9es, et arriveront jusqu'au serveur. De plus, il y a une configuration et une maintenance de certificat \u00e0 effectuer sur chaque instance httpd, et des ressources sont prises au niveau du cluster pour les op\u00e9rations de chiffrement. Enfin,il est n\u00e9cessaire de mette en oeuvre le protocole PROXY pour r\u00e9cup\u00e9rer les informations de connexion originales, car on ne peut plus se reposer sur l'authentification mutuelle qui a \u00e9t\u00e9 supprim\u00e9e selon les directives du Codir de l'Uepal.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#deploiement-de-type-ssl-offload-depuis-le-load-balancer","title":"D\u00e9ploiement de type SSL Offload depuis le load balancer","text":"<ul> <li>On a une communication chiffr\u00e9e (HTTPS) jusqu'au load balancer,</li> <li>Le load balancer transmet une requ\u00eate HTTP au contr\u00f4lleur ingress</li> <li>Le contr\u00f4lleur ingress fait office de proxy HTTP et envoie la requ\u00eate \u00e0 l'instance civiparoisse</li> </ul> <p>L'avantage de cette configuration est que l'on n'a qu'un seul point o\u00f9 on a un certificat, et si on utilise un certificat wildcard, on facilite grandement la configuration de l'ensemble du syst\u00e8me, et \u00e9conomise des ressources du cluster pour d'\u00e9ventuels autres usages.</p> <p>L'inconv\u00e9nient est qu'il faut faire confiance au load balancer, car il aura le certificat wildcard et la clef du certificat pour l'utilisation, verra passer les mots de passe (puisqu'il d\u00e9chiffre le trafic), et il faut faire confiance au reste de l'infrastructure et donc au fournisseur, car on n'a pas la main sur l'infrastructure. Il faut \u00e9galement configurer le serveur web et le serveur ingress pour pouvoir r\u00e9cup\u00e9rer l'IP du client via des headers HTTP et tenir compte de l'offloading s'il y a r\u00e9\u00e9criture des requ\u00eates (par exemple liens en HTTPS alors que les requ\u00eates tournent sur HTTP). Le fait de faire passer du trafic non chiffr\u00e9 dans le cluster peut \u00e9galement \u00eatre consid\u00e9r\u00e9 comme probl\u00e9matique dans le contexte Civiparoisse.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#deploiement-avec-load-balancer-https-inspection-de-paquets-dans-le-load-balancer-et-ingress-en-tcptls-passthrough","title":"D\u00e9ploiement avec load balancer HTTPS, inspection de paquets dans le load balancer et ingress en TCP/TLS passthrough","text":"<p>Ce genre de configuration serait en fait le cas d'\u00e9cole d'un firewall \u00e0 inspection de paquets ; sauf que dans le cas d'\u00e9cole, on a la main sur le firewall qu'on d\u00e9ploie, et qu'on lui fait donc confiance.</p> <ul> <li>On a deux communications HTTPS : une communication HTTPS entre le naviguateur et le load balancer d'une part, et une communication HTTPS du load balancer vers une instance Civihttpd d'autre part</li> <li>Le noeud ingress fait \u00e0 nouveau du TLS passthrough gr\u00e2ce au champ SNI, ce qui conduit \u00e0 une communication TCP entre le LB et l'ingress d'une part, et l'ingress et l'instance httpd d'autre part. </li> </ul> <p>Cette configuration a l'int\u00e9r\u00eat de chiffrer le trafic de bout en bout, en faisant toutefois confiance \u00e0 l'\u00e9quipement LB. L'information de l'IP du client peut \u00eatre v\u00e9hicul\u00e9e jusqu'au serveur httpd avec la configuration ad\u00e9quate des headers HTTP. Le trafic et les requ\u00eates peuvent \u00eatre enti\u00e8rement inspect\u00e9es par le LB qui peut faire office de firewall.</p> <p>En revanche, il faut faire confiance \u00e0 l'\u00e9quipement LB, et en plus, la configuration du LB est plus compliqu\u00e9e. Au niveau d'Openstack, il est possible qu'il faille faire de la configuration ext\u00e9rieure \u00e0 Kubernetes pour faire les r\u00e9glages ad\u00e9quats, et il faut donc \u00e9tudier la faisabilit\u00e9 de cette configuration, \u00e0 cause des interactions de configuration Openstack et Kubernetes. Il y a plus de certificats \u00e0 g\u00e9rer (dont notamment une probable authentification mutuelle TLS entre le LB et le serveur HTTPD, donc probablement une PKI d\u00e9di\u00e9e), et le certificat wildcard d'entr\u00e9e est \u00e9galement \u00e0 g\u00e9rer.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#deploiement-avec-load-balancer-https-inspection-de-paquets-dans-lingress-trafic-interne-chiffre","title":"D\u00e9ploiement avec load balancer HTTPS, inspection de paquets dans l'ingress, trafic interne chiffr\u00e9","text":"<p>Ce sc\u00e9nario repose sur 3 communications HTTPS bout \u00e0 bout :  * une communication HTTPS entre le navigateur et le load balancer  * une communication HTTPS entre le load balancer et le contr\u00f4leur ingress  * une communication HTTPS entre le contr\u00f4leur ingress et une instance civihttpd</p> <p>L'int\u00e9r\u00eat de ce sc\u00e9nario est que la configuration du load balancer peut \u00eatre plus simple, ou tout du moins plus typique, mais suppose qu'il y a un certificat wildcard d'entr\u00e9e \u00e0 g\u00e9rer au niveau du load balancer. Il pr\u00e9sente aussi la particularit\u00e9 de pouvoir faire passer l'IP du client via les headers HTTP de proche en proche jusqu'\u00e0 civihttpd. Il a n\u00e9anmoins l'inconv\u00e9nient de devoir faire confiance au load balancer.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#deploiement-avec-load-balancer-tcp-inspection-de-paquets-dans-lingress-trafic-interne-chiffre","title":"D\u00e9ploiement avec load balancer TCP, inspection de paquets dans l'ingress, trafic interne chiffr\u00e9","text":"<p>Ce sc\u00e9nario repose sur : * une communication TCP entre le client et le load balancer * une communication TCP entre le load balancer et l'ingress, en mettant en oeuvre le protocole PROXY pour r\u00e9cup\u00e9rer les informations initiales de la communication * une communication HTTPS entre le client et l'ingress utilisant les deux transports TCP \u00e9voqu\u00e9s * une communication HTTPS entre l'ingress et le serveur cible</p> <p>L'int\u00e9r\u00eat de cette configuration est qu'elle permet une configuration plus simple sur les \u00e9l\u00e9ments externes \u00e0 l'infrastructure (load balancer configur\u00e9 en mode TCP), et qu'on garde la main sur la gestion des certificats. La gestion des certificats est simplifi\u00e9e car vers l'ext\u00e9rieur on garde la main sur le certificat wildcard, tandis qu'on peut g\u00e9rer ses propres PKI dans le r\u00e9seau interne, voire utiliser un service mesh. L'inconv\u00e9nient est qu'il faut faire confiance au LoadBalancer et \u00e0 l'infrastructure du fournisseur si on ne chiffre pas sp\u00e9cifiquement le trafic entre le loadBalancer et l'ingress.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#utilisation-de-linfrastructure-openstack-firewalling-quasi-traditionnel","title":"Utilisation de l'infrastructure OpenStack : firewalling quasi-traditionnel","text":"<p>L'infrastructure OpenStack fournit non seulement un support K8S, mais \u00e9galement un support plus g\u00e9n\u00e9ral de machines virtuelles (instances / server, via le service Nova ). De plus, OpenStack fournit des possibilit\u00e9s de r\u00e9seau via le service Neutron, dont en particulier des r\u00e9seaux d\u00e9di\u00e9s (internes ; par opposition au r\u00e9seau fournir par l'op\u00e9rateur, r\u00e9seau physique quailifi\u00e9 d'externe), des routeurs, du NAT (SNAT pour l'acc\u00e8s \u00e0 internet, mais \u00e9galement de l'IP Floating, qui est du NAT one-to-one (\u00e0 une IP publique correspond une IP priv\u00e9e)). Du coup, on peut songer \u00e0 d'autres infrastructures de firewall, dont :</p> <ul> <li> <p>security groups : cette fonctionnalit\u00e9 permet d'appliquer des r\u00e8gles egress et ingress au niveau des ports des r\u00e9seaux virtuels d'Openstack. C'est donc une solution standard de firewalling Openstack (selon la documentation de niveau L2 \u00e0 L4) : https://docs.openstack.org/security-guide/networking/services.html ; https://docs.openstack.org/python-openstackclient/zed/cli/command-objects/security-group-rule.html</p> </li> <li> <p>firewall as a service : cette fonctionnalit\u00e9 d'Openstack permet d'avoir un service tiers qui va instaurer des r\u00e8gles de firewalling iptables (commandes neutron firewall-rule-create) ; le but est de pouvoir fournir des configurations plus riches que celles des security groups selon https://docs.openstack.org/security-guide/networking/services.html ; https://docs.openstack.org/newton/networking-guide/fwaas.html</p> </li> <li> <p>routeur-firewall : mettre le firewall avec un port dans un r\u00e9seau s\u00e9par\u00e9 et un port dans le r\u00e9seau Kubernetes, faire pointer l'IP flottante vers le r\u00e9seau s\u00e9par\u00e9 et faire du port forwarding vers le r\u00e9seau K8S : firewall sous forme de machine virtuelle par exemple</p> </li> <li> <p>firewall transparent (bridg\u00e9) : le fonctionnement de ce firewall repose habituellement sur l'utilisation de deux VLAN qui sont de part et d'autre du firewall ; le firewall fait de la commutation L2 et applique les r\u00e8gles de firewalling au passage. Ce mode de fonctionnement est un peu d\u00e9licat \u00e0 mettre en oeuvre, car les r\u00e9seaux Openstack self-service sont pr\u00e9vus pour \u00eatre des r\u00e9seaux plats, et sont pr\u00e9vus pour une connectivit\u00e9 de niveau 3 ; donc il vaut mieux \u00e9viter ce genre de fonctionnement.</p> </li> <li> <p>bridge-routing : le fonctionnement de ce mode rend le firewall \u00e9galement quasi transparent : du c\u00f4t\u00e9 interne, on a un sous-r\u00e9seau du r\u00e9seau externe ;  depuis le c\u00f4t\u00e9 interne le firewall est vu comme un routeur L3, et le r\u00e9seau utilise ce routeur pour sortir ; c\u00f4t\u00e9 externe, le routeur fait de la proxyfication ARP pour r\u00e9pondre \u00e0 la place des machines qui sont situ\u00e9es sur le sous-r\u00e9seau interne : le routeur n'est ainsi pas consid\u00e9r\u00e9 comme un routeur, mais le trafic passera quand m\u00eame par lui. Toutefois, on va \u00e9viter de passer par ce genre de m\u00e9canisme, puisque les r\u00e9seaux Openstack sont pr\u00e9vus pour une connectivit\u00e9 de niveau 3.</p> </li> <li> <p>firewall externalis\u00e9 : proxy externalis\u00e9, avec des tunnels vers l'application.</p> </li> </ul>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/trafic_entrant.html#quelques-ressources","title":"Quelques ressources","text":"<p>https://www.fortinet.com/content/dam/fortinet/assets/data-sheets/fortigate-cnf.pdf</p> <p>https://assets.barracuda.com/assets/docs/dms/Barracuda_Web_Application_Firewall_WP_Benefits_of_Proxy_Based_WAFS.pdf</p> <p>https://assets.barracuda.com/assets/docs/dms/Barracuda_Web_Application_Firewall_Vx_DS_US_4-5.pdf</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html","title":"Web Application Firewall","text":""},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html#contexte","title":"Contexte","text":"<p>Le firewall est un outil que l'on retrouve dans la plupart des infrastructures r\u00e9seaux. Il permet de contr\u00f4ler les flux qui le traversent. Le firewall est traditionnellement vu dans son approche \"Routeur Firewall\", comme un \u00e9l\u00e9ment de protection vis \u00e0 vis du trafic Internet. Toutefois, il convient plut\u00f4t de le consid\u00e9rer comme une fonction de filtrage qui s'int\u00e8gre dans diff\u00e9rentes couches r\u00e9seaux, et qui peut procurer des services plus \u00e9tendus. Ainsi, des fonctionnalit\u00e9s de filtrages peuvent \u00eatre mis en place par exemple : </p> <ul> <li>au niveau des switchs : filtrage des adresses MAC</li> <li>au niveau des routeurs : filtrage sur les IP et ports du protocole de transport associ\u00e9s ; </li> <li>au niveau des passerelles : certaines gateways vont permettre d'att\u00e9nuer des attaques comme par exemple des Denial Of Service (DOS)</li> <li>au niveau applicatif : ces passerelles peuvent analyser les requ\u00eates et les r\u00e9ponses et chercher \u00e0 d\u00e9tecter des attaques ou des exfiltrations de donn\u00e9es.</li> </ul> <p>Lorsqu'on se place dans un contexte Kubernetes, on retrouve le firewalling traditionnel dans une contexte p\u00e9rim\u00e9trique (dans l'approche routeur-firewall traditionnelle), mais elle prend dans Kubernetes \u00e9galement des formes diff\u00e9rentes, comme par exemple les <code>Network Policies</code>, pour tenir compte de la dur\u00e9e de vie variable des containers et donc des couples IP/MAC associ\u00e9s : dans ce cas, le filtrage peut plut\u00f4t se faire en se basant par exemple sur les labels que l'on peut positionner sur la plupart des objets Kubernetes, ainsi que sur les namespaces.Dans ce cas, les fonctionnalit\u00e9s de filtrage d\u00e9pendront fortement de l'impl\u00e9mentation de CNI (Container Networking Interface) employ\u00e9e, mais d'autres types d'objets peuvent jouer \u00e9galement un r\u00f4le dans le firewalling (notamment les Pod Admission Controllers).</p> <p>Il est \u00e0 noter que le firewall est important, mais doit \u00eatre consid\u00e9r\u00e9 comme un \u00e9l\u00e9ment d'un framework de s\u00e9curit\u00e9 : ainsi il est \u00e9galement primordial de mettre en oeuvre une exploitation des logs g\u00e9n\u00e9r\u00e9 par le firewall, tout comme il est int\u00e9ressant de l'associer \u00e0 d'autres outils qui contribuent \u00e9galement aux fonctions de s\u00e9curit\u00e9s, comme les IPS/IDS (Intrusion Detection System, Intrusion Prevention System), qui peuvent prendre la forme de sondes (on peut notamment penser \u00e0 Snort comme IDS r\u00e9seau).</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html#moteur-dexecution-de-regles-modsecurity","title":"Moteur d'ex\u00e9cution de r\u00e8gles : ModSecurity","text":"<p>ModSecurity est un moteur de WAF qui \u00e9tait r\u00e9serv\u00e9 dans sa version 2 \u00e0 Apache. Il se charge de v\u00e9rifier si des r\u00e8gles s'appliquent dans diff\u00e9rentes phases de traitement d'une requ\u00eate, et des les appliquer s'il y a lieu. Les cinqs phases de traitement sont :</p> <ul> <li>Phase 1 : Request headers (REQUEST _HEADERS)</li> <li>Phase 2 : Request body (REQUEST _BODY)</li> <li>Phase 3 : Response headers (RESPONSE_HEADERS)</li> <li>Phase 4 : Response body (RESPONSE_BODY)</li> <li>Phase 5 : Logging (LOGGING)</li> </ul> <p>Le traitement proprement dit de la requ\u00eate est normalement fait entre la phase 2 et 3, ce qui veut dire qu'on peut emp\u00eacher le traitement de la requ\u00eate au niveau de la phase 1 ou 2. Par la suite, on peut \u00e9galement emp\u00eacher que la r\u00e9ponse g\u00e9n\u00e9r\u00e9e atteigne le client (en particulier en phase 4).</p> <p>Les r\u00e8gles qui s'appliquent s'appuient sur des tests sur diff\u00e9rents constituants de la requ\u00eate ou de la r\u00e9ponse. Les r\u00e8gles peuvent \u00eatre chain\u00e9es pour avoir un \u00e9quivalent d'un ET logique sur des conditions. Des variables peuvent \u00e9galement \u00eatre exploit\u00e9es entre les r\u00e8gles.</p> <p>Mod_Security connait une existence mouvement\u00e9e, si on en croit https://coreruleset.org/20211222/talking-about-modsecurity-and-the-new-coraza-waf/ : en effet, il y a deux versions majeurs qui coexistent, la version 2 qui est d\u00e9di\u00e9e et profond\u00e9ment li\u00e9e \u00e0 Apache, et la version 3 qui est une r\u00e9\u00e9criture visant \u00e0 se d\u00e9tacher des liens \u00e9troits avec Apache, mais dont le \"connecteur Apache\" serait encore consid\u00e9r\u00e9 comme exp\u00e9rimental. De plus, la soci\u00e9t\u00e9 Trustwave qui a oeuvr\u00e9 \u00e0 ce projet se d\u00e9sengage, comme l'indique https://www.trustwave.com/en-us/resources/security-resources/software-updates/end-of-sale-and-trustwave-support-for-modsecurity-web-application-firewall/, pour laisser le projet en open source. N\u00e9anmoins, d'autres moteurs existent comme Coraza.</p> <p>Le moteur d'ex\u00e9cution de r\u00e8gles peut \u00e9galement s'interfacer \u00e0 d'autres outils (notamment en utilsiant des scripts), comme l'antivirus ClamAV ou des bases de donn\u00e9es de localisation d'IP, en particulier celui de MaxMind https://dev.maxmind.com/geoip/geolite2-free-geolocation-data?lang=en. Toutefois, il est \u00e0 signaler que de telles int\u00e9grations peuvent avoir des cons\u00e9quences sur l'infrastructure : en effet, ClamAV serait id\u00e9alement selon https://docs.clamav.net/manual/Installing/Docker.html assez gourmand en RAM (3-4Go). Au niveau de Maxmind, il y a eu un changement de format des bases de donn\u00e9es de localisation : le nouveau format serait reconnu dans ModSecurity3, mais pas dans ModSecurity2 ; en revanche, Maxmind fournit une impl\u00e9mentation dans Apache selon https://dev.maxmind.com/geoip/docs/databases?lang=en#official-api-clients, en tant que module Apache ; la coop\u00e9eration avec modSecurity est \u00e9galement \u00e9voqu\u00e9e dans la documentation https://maxmind.github.io/mod_maxminddb/.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html#regles-de-firewall-coreruleset","title":"R\u00e8gles de firewall : CoreRuleSet","text":"<p>Le moteur d'ex\u00e9cution n'est utile que si des r\u00e8gles sont fournies au moteur. Une approche serait donc de cr\u00e9er un ensemble de r\u00e8gles, en d\u00e9finissant une r\u00e8gle par d\u00e9faut qui bloque le trafic, et un ensemble de r\u00e8gles qui autorisent pr\u00e9cis\u00e9ment les requ\u00eates et r\u00e9ponses autoris\u00e9es. Cette d\u00e9marche semble int\u00e9ressante, mais serait assez complexe \u00e0 mettre en eouvre et ensuite \u00e0 maintenir, notamment \u00e0 cause des \u00e9volutions de Drupal et de CiviCRM. Elles n\u00e9cessitent en outre des comp\u00e9tences accrues et beaucoup de temps.</p> <p>De l'autre c\u00f4t\u00e9, la fondation de OWASP fournit un framework avec des r\u00e8gles, appel\u00e9 CoreRuleSet (CRS)https://owasp.org/www-project-modsecurity-core-rule-set/  et https://coreruleset.org/. Ces r\u00e8gles seraient utilis\u00e9es ou adapt\u00e9es dans un certain nombre de WAF.</p> <p>Les r\u00e8gles dans la version 3 ne cherchent pas \u00e0 directement qualifier une attaque, mais cherchent plut\u00f4t \u00e0 calculer un score d'anomalies dans la requ\u00eate ou dans la r\u00e9ponse. La requ\u00eate ou la r\u00e9ponse sont bloqu\u00e9es si elles d\u00e9passent des seuils de scores.</p> <p>Les r\u00e8gles appliqu\u00e9es d\u00e9pendent d'un niveau appel\u00e9 niveau de Parano\u00efa ; plus le niveau augmente, plus le firewall devient sensible. Toutefois, cette sensibilit\u00e9 fait potentiellement appara\u00eetre des faux positifs : du trafic l\u00e9gitime mais quand m\u00eame bloqu\u00e9. De ce fait, les faux positifs doivent \u00eatre trait\u00e9s en \u00e9crivant des r\u00e8gles compl\u00e9mentaires qui vont venir corriger ou inhiber les r\u00e8gles d\u00e9j\u00e0 pr\u00e9sentes : il s'agit des exclusions. Le projet CRS fournit d'ailleurs des ensembles de r\u00e8gles d'exclusion que l'on peut activer, en particulier vis \u00e0 vis de Drupal. Toutefois, il y a lieu de v\u00e9rifier si toutes les exclusions sont pertinentes, quitte \u00e0 en d\u00e9sactiver certaines si n\u00e9cessaire.</p> <p>CoreRuleSet fournit et maintient en particulier des images avec ModSecurity et CoreRuleSet https://hub.docker.com/r/owasp/modsecurity-crs, certaines passant par Nginx et d'autres par Apache. Ces images disposent d'un certain jeu de variables d'environnement qui permettent de configurer le container ; des fichiers d'exclusions sont \u00e9galement pr\u00e9vus : ils peuvent donc \u00eatre personnalis\u00e9s via des montages de volume.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html#petit-test","title":"Petit test","text":"<p>Un test simple a \u00e9t\u00e9 r\u00e9alis\u00e9 avec l'image de base, en montant un pod dans Kubernetes et en dirigeant l'upstream vers un serveur HTTP de test, qui fournit simplement le fichier par d\u00e9faut et un phpinfo.</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-msec\ndata:\n  BACKEND: http://testhttp:80\n---\napiVersion: v1\ndata:\n  request: |\n    # https://github.com/coreruleset/coreruleset/blob/v3.4/dev/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example\n    #\n    # \"...,ctl:ruleRemoveById=942100\"\n    # \"...,ctl:ruleRemoveByTag=attack-sqli\"\n    # \"...,ctl:ruleRemoveTargetById=942100;ARGS:password\"\n    # \"...,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:password\"\n    SecAction id:1,phase:2,ctl:ruleRemoveTargetById=932160;ARGS:tutu\n    SecAction id:2,phase:2,ctl:ruleRemoveTargetById=930120;ARGS:tutu\n  response: |\n    # https://github.com/coreruleset/coreruleset/blob/v3.4/dev/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example\n    #\n    # Examples:\n    # SecRuleRemoveById 942100\n    # SecRuleRemoveByTag \"attack-sqli\"\n    # SecRuleUpdateTargetById 942100 \"!ARGS:password\"\n    # SecRuleUpdateTargetByTag \"attack-sqli\" \"!ARGS:password\"\nkind: ConfigMap\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {\"apiVersion\":\"v1\",\"data\":{\"request\":\"# https://github.com/coreruleset/coreruleset/blob/v3.4/dev/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example\\n#\\n# \\\"...,ctl:ruleRemoveById=942100\\\"\\n# \\\"...,ctl:ruleRemoveByTag=attack-sqli\\\"\\n# \\\"...,ctl:ruleRemoveTargetById=942100;ARGS:password\\\"\\n# \\\"...,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:password\\\"\\nSecAction id:1,phase:2,ctl:ruleRemoveTargetById=932160;ARGS:tutu\\nSecAction id:2,phase:2,ctl:ruleRemoveTargetById=9302120;ARGS:tutu\\n\",\"response\":\"# https://github.com/coreruleset/coreruleset/blob/v3.4/dev/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example\\n#\\n# Examples:\\n# SecRuleRemoveById 942100\\n# SecRuleRemoveByTag \\\"attack-sqli\\\"\\n# SecRuleUpdateTargetById 942100 \\\"!ARGS:password\\\"\\n# SecRuleUpdateTargetByTag \\\"attack-sqli\\\" \\\"!ARGS:password\\\"\\n\"},\"kind\":\"ConfigMap\",\"metadata\":{\"annotations\":{},\"creationTimestamp\":\"2023-03-03T14:24:19Z\",\"name\":\"exclude\",\"namespace\":\"default\",\"resourceVersion\":\"39758\",\"uid\":\"dc358d13-2384-450c-b829-ac48d796229c\"}}\n  creationTimestamp: \"2023-03-03T14:24:19Z\"\n  name: exclude\n  namespace: default\n  resourceVersion: \"40122\"\n  uid: dc358d13-2384-450c-b829-ac48d796229c\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: default\n  name: msec\n  labels:\n    app: msec\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: msec\n  template:\n    metadata:\n       labels:\n         app: msec\n    spec:\n      containers:\n      - name: msec\n        image: owasp/modsecurity-crs:apache\n        imagePullPolicy: IfNotPresent\n        envFrom:\n        - configMapRef:\n            name: config-msec\n        ports:\n        - containerPort: 80\n          name: http\n        volumeMounts: \n        - name: exclude-cm\n          mountPath: /etc/modsecurity.d/owasp-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf\n          subPath: request\n        - name: exclude-cm\n          mountPath: /etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf\n          subPath: response\n      volumes:\n      - name: exclude-cm\n        configMap:\n          name: exclude\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: testmsec\nspec:\n  selector:\n    app: msec\n  ports:\n   - protocol: TCP\n     port: 80\n     targetPort: 80\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: testmsec\n  namespace: default\nspec:\n  entryPoints:\n    - testmsec\n  routes:\n    - match: \"Host(`civicrm.test`)\"\n      kind: Rule\n      services:\n        - name: testmsec\n          namespace: default\n          port: 80\n</code></pre> <p>Le port d'entr\u00e9e nomm\u00e9 testmsec a \u00e9t\u00e9 r\u00e9gl\u00e9 via le package Helm de traefik, au niveau des valeurs (repris en dessous en supprimant les ports qui ont \u00e9t\u00e9 utilis\u00e9 pour les tests des sc\u00e9narios Traefik de l page d\u00e9di\u00e9e): </p> <pre><code>deployment:\n  kind: DaemonSet\nmetrics:\n  prometheus: null\nhostNetwork: true\nupdateStrategy:\n  rollingUpdate:\n    maxUnavailable: 2\n    maxSurge: \nglobalArguments:\n  - \"--global.checknewversion\"\nports:\n  testmsec:\n     port: 7087\n     http:     \nservice:\n  type: NodePort\n\nlogs:\n  general:\n    level: DEBUG\n  access:\n    enabled: true\n</code></pre> <p>Le test a r\u00e9v\u00e9l\u00e9 que l'affichage du phpinfo \u00e9tait bloqu\u00e9 par les r\u00e8gles du container. L'affichage de la page par d\u00e9faut n'\u00e9tait pas bloqu\u00e9, mais \u00e9tait bloqu\u00e9 du moment qu'on rajoute un argument comme <code>?tutu=/etc/passwd</code>.</p> <p>Les logs reproduits en-dessous permettent de voir le probl\u00e8me plus en d\u00e9tail. On constate que l'indication du <code>unique_id</code> est tr\u00e8s utile pour trouver l'ensemble des lignes relatives \u00e0 une requ\u00eate.</p> <pre><code>[Thu Mar 02 22:37:43.085324 2023] [security2:error] [pid 39:tid 548312240512] [client 192.168.67.2:50894] [client 192.168.67.2] ModSecurity: Warning. Matched phrase \"etc/passwd\" at ARGS:tutu. [file \"/etc/modsecurity.d/owasp-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf\"] [line \"98\"] [id \"930120\"] [msg \"OS File Access Attempt\"] [data \"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\"] [severity \"CRITICAL\"] [ver \"OWASP_CRS/3.3.4\"] [tag \"modsecurity\"] [tag \"application-multi\"] [tag \"language-multi\"] [tag \"platform-multi\"] [tag \"attack-lfi\"] [tag \"paranoia-level/1\"] [tag \"OWASP_CRS\"] [tag \"capec/1000/255/153/126\"] [tag \"PCI/6.5.4\"] [hostname \"civicrm.test\"] [uri \"/\"] [unique_id \"ZAElN3Bgqvr9Dam47TgqxgAAAIE\"]\n[Thu Mar 02 22:37:43.086374 2023] [security2:error] [pid 39:tid 548312240512] [client 192.168.67.2:50894] [client 192.168.67.2] ModSecurity: Warning. Matched phrase \"etc/passwd\" at ARGS:tutu. [file \"/etc/modsecurity.d/owasp-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf\"] [line \"501\"] [id \"932160\"] [msg \"Remote Command Execution: Unix Shell Code Found\"] [data \"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\"] [severity \"CRITICAL\"] [ver \"OWASP_CRS/3.3.4\"] [tag \"modsecurity\"] [tag \"application-multi\"] [tag \"language-shell\"] [tag \"platform-unix\"] [tag \"attack-rce\"] [tag \"paranoia-level/1\"] [tag \"OWASP_CRS\"] [tag \"capec/1000/152/248/88\"] [tag \"PCI/6.5.2\"] [hostname \"civicrm.test\"] [uri \"/\"] [unique_id \"ZAElN3Bgqvr9Dam47TgqxgAAAIE\"]\n[Thu Mar 02 22:37:43.091950 2023] [security2:error] [pid 39:tid 548312240512] [client 192.168.67.2:50894] [client 192.168.67.2] ModSecurity: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file \"/etc/modsecurity.d/owasp-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf\"] [line \"94\"] [id \"949110\"] [msg \"Inbound Anomaly Score Exceeded (Total Score: 10)\"] [severity \"CRITICAL\"] [ver \"OWASP_CRS/3.3.4\"] [tag \"modsecurity\"] [tag \"application-multi\"] [tag \"language-multi\"] [tag \"platform-multi\"] [tag \"attack-generic\"] [hostname \"civicrm.test\"] [uri \"/\"] [unique_id \"ZAElN3Bgqvr9Dam47TgqxgAAAIE\"]\n[Thu Mar 02 22:37:43.093661 2023] [security2:error] [pid 39:tid 548312240512] [client 192.168.67.2:50894] [client 192.168.67.2] ModSecurity: Warning. Operator GE matched 5 at TX:inbound_anomaly_score. [file \"/etc/modsecurity.d/owasp-crs/rules/RESPONSE-980-CORRELATION.conf\"] [line \"92\"] [id \"980130\"] [msg \"Inbound Anomaly Score Exceeded (Total Inbound Score: 10 - SQLI=0,XSS=0,RFI=0,LFI=5,RCE=5,PHPI=0,HTTP=0,SESS=0): individual paranoia level scores: 10, 0, 0, 0\"] [ver \"OWASP_CRS/3.3.4\"] [tag \"modsecurity\"] [tag \"event-correlation\"] [hostname \"civicrm.test\"] [uri \"/\"] [unique_id \"ZAElN3Bgqvr9Dam47TgqxgAAAIE\"]\n{\"transaction\":{\"time\":\"02/Mar/2023:22:37:43.094724 +0000\",\"transaction_id\":\"ZAElN3Bgqvr9Dam47TgqxgAAAIE\",\"remote_address\":\"192.168.67.2\",\"remote_port\":50894,\"local_address\":\"10.244.105.107\",\"local_port\":80},\"request\":{\"request_line\":\"GET /?tutu=/etc/passwd HTTP/1.1\",\"headers\":{\"Host\":\"civicrm.test:7087\",\"User-Agent\":\"Mozilla/5.0 (X11; CrOS aarch64 13597.84.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36\",\"Accept\":\"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\",\"Accept-Encoding\":\"gzip, deflate\",\"Accept-Language\":\"fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7\",\"Upgrade-Insecure-Requests\":\"1\",\"X-Forwarded-For\":\"192.168.67.1\",\"X-Forwarded-Host\":\"civicrm.test:7087\",\"X-Forwarded-Port\":\"7087\",\"X-Forwarded-Proto\":\"http\",\"X-Forwarded-Server\":\"tp\",\"X-Real-Ip\":\"192.168.67.1\"}},\"response\":{\"protocol\":\"HTTP/1.1\",\"status\":403,\"headers\":{\"Content-Length\":\"199\",\"Content-Type\":\"text/html; charset=iso-8859-1\"},\"body\":\"&lt;!DOCTYPE HTML PUBLIC \\\"-//IETF//DTD HTML 2.0//EN\\\"&gt;\\n&lt;html&gt;&lt;head&gt;\\n&lt;title&gt;403 Forbidden&lt;/title&gt;\\n&lt;/head&gt;&lt;body&gt;\\n&lt;h1&gt;Forbidden&lt;/h1&gt;\\n&lt;p&gt;You don't have permission to access this resource.&lt;/p&gt;\\n&lt;/body&gt;&lt;/html&gt;\\n\"},\"audit_data\":{\"messages\":[\"Warning. Matched phrase \\\"etc/passwd\\\" at ARGS:tutu. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf\\\"] [line \\\"98\\\"] [id \\\"930120\\\"] [msg \\\"OS File Access Attempt\\\"] [data \\\"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-lfi\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/255/153/126\\\"] [tag \\\"PCI/6.5.4\\\"]\",\"Warning. Matched phrase \\\"etc/passwd\\\" at ARGS:tutu. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf\\\"] [line \\\"501\\\"] [id \\\"932160\\\"] [msg \\\"Remote Command Execution: Unix Shell Code Found\\\"] [data \\\"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-shell\\\"] [tag \\\"platform-unix\\\"] [tag \\\"attack-rce\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/152/248/88\\\"] [tag \\\"PCI/6.5.2\\\"]\",\"Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf\\\"] [line \\\"94\\\"] [id \\\"949110\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Score: 10)\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-generic\\\"]\",\"Warning. Operator GE matched 5 at TX:inbound_anomaly_score. [file \\\"/etc/modsecurity.d/owasp-crs/rules/RESPONSE-980-CORRELATION.conf\\\"] [line \\\"92\\\"] [id \\\"980130\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Inbound Score: 10 - SQLI=0,XSS=0,RFI=0,LFI=5,RCE=5,PHPI=0,HTTP=0,SESS=0): individual paranoia level scores: 10, 0, 0, 0\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"event-correlation\\\"]\"],\"error_messages\":[\"[file \\\"apache2_util.c\\\"] [line 275] [level 3] [client 192.168.67.2] ModSecurity: Warning. Matched phrase \\\"etc/passwd\\\" at ARGS:tutu. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf\\\"] [line \\\"98\\\"] [id \\\"930120\\\"] [msg \\\"OS File Access Attempt\\\"] [data \\\"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-lfi\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/255/153/126\\\"] [tag \\\"PCI/6.5.4\\\"] [hostname \\\"civicrm.test\\\"] [uri \\\"/\\\"] [unique_id \\\"ZAElN3Bgqvr9Dam47TgqxgAAAIE\\\"]\",\"[file \\\"apache2_util.c\\\"] [line 275] [level 3] [client 192.168.67.2] ModSecurity: Warning. Matched phrase \\\"etc/passwd\\\" at ARGS:tutu. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf\\\"] [line \\\"501\\\"] [id \\\"932160\\\"] [msg \\\"Remote Command Execution: Unix Shell Code Found\\\"] [data \\\"Matched Data: etc/passwd found within ARGS:tutu: /etc/passwd\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-shell\\\"] [tag \\\"platform-unix\\\"] [tag \\\"attack-rce\\\"] [tag \\\"paranoia-level/1\\\"] [tag \\\"OWASP_CRS\\\"] [tag \\\"capec/1000/152/248/88\\\"] [tag \\\"PCI/6.5.2\\\"] [hostname \\\"civicrm.test\\\"] [uri \\\"/\\\"] [unique_id \\\"ZAElN3Bgqvr9Dam47TgqxgAAAIE\\\"]\",\"[file \\\"apache2_util.c\\\"] [line 275] [level 3] [client 192.168.67.2] ModSecurity: Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score. [file \\\"/etc/modsecurity.d/owasp-crs/rules/REQUEST-949-BLOCKING-EVALUATION.conf\\\"] [line \\\"94\\\"] [id \\\"949110\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Score: 10)\\\"] [severity \\\"CRITICAL\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"application-multi\\\"] [tag \\\"language-multi\\\"] [tag \\\"platform-multi\\\"] [tag \\\"attack-generic\\\"] [hostname \\\"civicrm.test\\\"] [uri \\\"/\\\"] [unique_id \\\"ZAElN3Bgqvr9Dam47TgqxgAAAIE\\\"]\",\"[file \\\"apache2_util.c\\\"] [line 275] [level 3] [client 192.168.67.2] ModSecurity: Warning. Operator GE matched 5 at TX:inbound_anomaly_score. [file \\\"/etc/modsecurity.d/owasp-crs/rules/RESPONSE-980-CORRELATION.conf\\\"] [line \\\"92\\\"] [id \\\"980130\\\"] [msg \\\"Inbound Anomaly Score Exceeded (Total Inbound Score: 10 - SQLI=0,XSS=0,RFI=0,LFI=5,RCE=5,PHPI=0,HTTP=0,SESS=0): individual paranoia level scores: 10, 0, 0, 0\\\"] [ver \\\"OWASP_CRS/3.3.4\\\"] [tag \\\"modsecurity\\\"] [tag \\\"event-correlation\\\"] [hostname \\\"civicrm.test\\\"] [uri \\\"/\\\"] [unique_id \\\"ZAElN3Bgqvr9Dam47TgqxgAAAIE\\\"]\"],\"action\":{\"intercepted\":true,\"phase\":2,\"message\":\"Operator GE matched 5 at TX:anomaly_score.\"},\"handler\":\"proxy-server\",\"stopwatch\":{\"p1\":11764,\"p2\":11186,\"p3\":0,\"p4\":0,\"p5\":1736,\"sr\":895,\"sw\":1,\"l\":0,\"gc\":0},\"response_body_dechunked\":true,\"producer\":[\"ModSecurity for Apache/2.9.7 (http://www.modsecurity.org/)\",\"OWASP_CRS/3.3.4\"],\"server\":\"Apache\",\"engine_mode\":\"ENABLED\"}}\n</code></pre> <p>Une exclusion a \u00e9t\u00e9 mise en place pour tester le syst\u00e8me. Bien entendu, cette exclusion devrait \u00eatre beaucoup plus sp\u00e9cifique en r\u00e9alit\u00e9 (et ne devrait \u00e0 vrai dire pas \u00eatre mise en place). Cela suffit cependant \u00e0 comprendre l'importance des tests et de la n\u00e9cessit\u00e9 et de l'\u00e9ventuelle complexit\u00e9 de mettre en oeuvre des r\u00e8gles d'exclusion pour solutionner les faux positifs.</p>"},{"location":"TECHNIQUE/PREPOC/ETUDES_PRECIS/waf.html#au-niveau-de-civiparoisse","title":"Au niveau de Civiparoisse","text":"<p>En ce qui concerne Civiparoisse, on n'oubliera pas qu'Apache est pr\u00e9vu pour ex\u00e9cuter les instances de Civiparoisse : il serait donc possible d'int\u00e9grer directement ModSecurity et les r\u00e8gles dans l'image du container Httpd.</p> <p>Toutefois, cela risquerait de complexifier les images, et pourrait rendre un \u00e9ventuel d\u00e9buggage plus compliqu\u00e9 (par exemple la diff\u00e9renciation entre un faux positif et un probl\u00e8me logiciel). Par ailleurs, une possibilit\u00e9 mise en avant par la litt\u00e9rature sur ModSecurity est le virtual patching : ajouter des r\u00e8gles pour \u00e9viter que des requ\u00eates faisant partie d'une attaque non encore patch\u00e9e soit ex\u00e9cut\u00e9e : il semble alors a priori plus simple et rapide de devoir modifier et red\u00e9ployer un seul container sp\u00e9cialis\u00e9 (ou \u00e9ventuellement un container par noeud) que de devoir en red\u00e9ployer un par paroisse. On n'oubliera pas que, conceptuellement la sp\u00e9cialisation des containers va dans le sens des containers et des architectures micro-services.</p> <p>La sp\u00e9cialisation d'un container WAF permettrait \u00e9galement de gagner en maintenabilit\u00e9, car son cycle de release deviendrait ind\u00e9pendant de celui des versions de Civiparoisse. Ceci est par ailleurs important, car la maintenance de ce genre d'outil n\u00e9cessitera des comp\u00e9tences et du temps : \u00e0 voir si son d\u00e9ploiement justifierait un sous-projet d\u00e9di\u00e9 ou non.</p> <p>Enfin, on n'oubliera pas que modsecurity peut b\u00e9n\u00e9ficier de services compl\u00e9mentaires comme l'antivirus ClamAV, ce qui peut entrainer des consommations de ressources suppl\u00e9mentaires qu'il conviendrait de limiter.</p> <p>En revanche, il ne faut pas oublier que pour fonctionner, le WAF a besoin dans tous les cas que le trafic soit d\u00e9chiffr\u00e9 (et d\u00e9compress\u00e9) au niveau du serveur web pour que les analyses puissent s'effectuer. D\u00e9ployer un WAF centralis\u00e9 signifie \u00e9galement qu'il y aura un point central o\u00f9 tout le trafic sera d\u00e9chiffr\u00e9, ce qui n'est pas forc\u00e9ment souhaitable.</p> <p>Il ne faut pas oublier non plus l'importance des logs, et que des logs pourraient contenir des informations en clair (par exemple dans les r\u00e9ponses).</p> <p>Enfin, il ne faut pas sous-estimer l'impact du niveau de Parano\u00efa (c'est un point qui est \u00e0 discuter en fonction notamment de https://coreruleset.org/docs/concepts/paranoia_levels/) qui est n\u00e9cessaire au projet et l'investissement qu'il faudra faire en temps et en r\u00e9activit\u00e9 sur la correction des faux positifs : les faux positifs peuvent \u00eatre particuli\u00e8rement handicapants pour les utilisateurs. La documentation de CoreRuleSet met particuli\u00e8rement l'accent sur le traitement des faux positifs (en particulier dans https://coreruleset.org/docs/concepts/false_positives_tuning/, mais de mani\u00e8re moins d\u00e9taill\u00e9e dans d'autres endroits de la documentation).</p> <p>En conclusion, la d\u00e9cision de d\u00e9ployer ou non un WAF, et de comment le d\u00e9ployer, le configurer, et le maintenir, est donc complexe. Il serait peut-\u00eatre judicieux d'\u00e9largir les recherches \u00e0 d'autres approches, comme le Firewall As A Service, pour v\u00e9rifier si les probl\u00e9matiques \u00e9voqu\u00e9es avec ModSecurity et CRS surviennent \u00e9galement avec ces solutions - en revanche, avec une approche \"As A Service\", on pourrait \u00e9ventuellement profiter - probablement moyennant finances - du support de l'\u00e9diteur du service, ce qui pourrait \u00e9ventuellement r\u00e9duire la charge des \u00e9quipes projets de Civiparoisse sur ce sujet.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/index.html","title":"Index","text":"<p>Cette section liste des documents concernant l'int\u00e9gration de Civiparoisse.</p> <ul> <li>D\u00e9ploiement instance</li> <li>Description g\u00e9n\u00e9rale Docker</li> <li>Images Docker</li> <li>Kubernetes</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/deploiement_instance.html","title":"D\u00e9ploiement d'une instance (Work In Progress)","text":"<p>On consid\u00e8re le cluster Kubernetes initialis\u00e9 avec Traefik et le certificat wildcard. Il s'agit donc de d\u00e9ployer une instance compl\u00e8te de Civiparoisse.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/deploiement_instance.html#collecte-dinformations","title":"Collecte d'informations","text":"<p>Il y a une grande quantit\u00e9 d'informations \u00e0 collecter :</p> <ul> <li>sous-domaine souhait\u00e9 sur uepal.net</li> <li>nom de la paroisse</li> <li>adresse postale de la paroisse</li> <li>adresse mail du site Drupal</li> <li>adresse mail du domaine CiviCRM</li> <li>adresse postale compl\u00e8te de la paroisse : num\u00e9ro, rue, code postal, ville</li> <li>compte SMTP : h\u00f4te, port, utilisateur, mot de passe : \u00e0 voir si on laisse le choix ou pas</li> <li>compte IMAP : h\u00f4te, port, utilisateur, mot de passe : \u00e0 voir si on laisse le choix ou pas</li> <li>configuration mailing : Return-Path, VERPlocalPart</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/deploiement_instance.html#derivation-dinformations","title":"D\u00e9rivation d'informations","text":"<ul> <li>nom du namespace : nom du sous-domaine</li> <li>externalhost  et servername : www. sous domaine</li> <li>mailDomain : FQDN du sous-domaine</li> <li>trustedHostPatterns : encodage du servername</li> <li>administrateur Drupal : adresse mail, nom description</li> <li>sitename : nom de la paroisse</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/deploiement_instance.html#etapes-dinstallation","title":"Etapes d'installation","text":"<ul> <li>g\u00e9n\u00e9ration compte mail classique IMAP/SMTP chez le provider</li> <li>g\u00e9n\u00e9ration sous-compte mailjet</li> <li>g\u00e9n\u00e9ration values.yaml</li> <li>cr\u00e9ation namespace</li> <li>cr\u00e9ation du secret des mails</li> <li>installation de l'instance via helm</li> <li>cr\u00e9ation entr\u00e9es DNS</li> <li>modification mot de passe administrateur ?</li> <li>v\u00e9rification tableaux de bords Drupal et CiviCRM</li> <li>v\u00e9rification connectivit\u00e9 SMTP et IMAP via CiviCRM</li> <li>cr\u00e9ation de 2 comptes utilisateurs : gestionnaire de paroisse et secadmin</li> <li>lockdown du compte administrateur (drush user:block ??) ??</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/deploiement_instance.html#rappel-fichier-de-valeurs-helm","title":"Rappel : fichier de valeurs Helm","text":"<pre><code>imageVersion: \"latest\"\nexternalhost: \"civicrm2.test\"\nstorageClassName: \"standard\"\nservername: \"civicrm2.test\"\nmail:\n  deployMailserver: \"1\"\n  serverKeySecret: \"mailsecret\"\n  serverKeyField: \"mailKey\"\n  serverCertSecret: \"mailsecret\"\n  serverCertField: \"mailCert\"\n  caCertSecret: \"mailsecret\"\n  caCertField: \"mailCaCert\"\n  imapUsernameSecret: \"mailsecret\"\n  imapUsernameSecretField: \"imapUsername\"\n  imapUsernameSecretMountpoint: \"/var/run/secrets/imapUsername\"\n  imapUsername2Secret: \"mailsecret\"\n  imapUsername2SecretField: \"imapUsername2\"\n  imapUsername2SecretMountpoint: \"/var/run/secrets/imapUsername2\"\n  imapPasswordSecret: \"mailsecret\"\n  imapPasswordSecretField: \"imapPassword\"\n  imapPasswordSecretMountpoint: \"/var/run/secrets/imapPassword\"\n  smtpUsernameSecret: \"mailsecret\"\n  smtpUsernameSecretField: \"smtpUsername\"\n  smtpUsernameSecretMountpoint: \"/var/run/secrets/smtpUsername\"\n  smtpPasswordSecret: \"mailsecret\"\n  smtpPasswordSecretField: \"smtpPassword\"\n  smtpPasswordSecretMountpoint: \"/var/run/secrets/smtpPassword\"\n  maildomain: \"\"\n  bounceLocalpart: \"\"\n  bounceReturnpath: \"\"\n  imapServer: \"\"\n  imapPort: \"\"\n  imapIsSSL: \"\"\n  imapInboxFolder: \"\"\n  smtpServer: \"\"\n  smtpPort: \"\"\ninit:\n  paroisseName: \"Paroisse Uepal de test2\"\n  paroisseAddr: \"2b, quai Saint Thomas\"\n  paroisseCity: \"Strasbourg2\"\n  paroissePhone: \"0011223355\"\n  paroisseZipCode: \"67002\"\n  paroisseStreetNumber: \"1\"\n  civiDomain: \"DomaineParoisse2\"\n  dbnameCivicrm: \"civicrm\"\n  dbnameDrupal: \"drupal\"\n  dbnameCivilog: \"civilog\"\n  dbhost: \"localhost\"\n  dbuser: \"exploitant\"\n  trustedHostPatterns: \"['^civicrm2\\\\.test$']\"\n  mailadmin:\n    addr: \"admin@civicrm2.test\"\n    name: \"admin2 ADMIN2\"\n    descr: \"mail admin descr2\"\n  maildir: \"/maildir\"\n  sitename: \"Site de test civicrm2\"\n  drupalAdminUserSecret: \"drupalAdminUser\"\n  drupalAdminPasswordSecret: \"drupalAdminPassword\"\n  dbsecret: \"dbsecret\"\n  mailsiteaddr: \"imapusername@civicrm2.test\"\n  maildomainaddr: \"imapusername@civicrm2.test\"\nhttpd:\n  serverCert: \"/var/run/secrets/KEYS/extern.x509\"\n  serverCertField: \"externcert\"\n  serverCertSecret: \"selfcert\"\n  serverKey: \"/var/run/secrets/KEYS/extern.pem\"\n  serverKeyField: \"externkey\"\n  serverKeySecret: \"selfcert\"      \n  internMaxConnectionsPerChild: 1\n  internMaxRequestWorkers: 4\n  internMaxSpareServers: 4\n  internMinSpareServers: 1\n  internServerLimit: 4\n  internStartServers: 4  \n  listenBacklog: 1\ndb:  \n  dbserverCertField: \"dbservercert\"\n  dbserverCertSecret: \"selfcert\"\n  dbserverKeyField: \"dbserverkey\"\n  dbserverKeySecret: \"selfcert\"\n  dbcaCertField: \"dbcacert\"\n  dbcaCertSecret: \"selfcert\"\n  dbrouterCaField: \"dbcacert\"\n  dbrouterCaSecret: \"selfcert\"\nlimits:  \n  genca:\n    memory: \"100Mi\"\n    cpu: \"100m\"\n  cron:\n    memory: \"256Mi\"\n    cpu: \"250m\"  \n  cron_init:\n    memory: \"50Mi\"\n    cpu: \"100m\"\n  httpd:\n    memory: \"1024Mi\"\n    cpu: \"1000m\"  \n  httpd_init:\n    memory: \"50Mi\"\n    cpu: \"100m\"\n  db:\n    memory: \"384Mi\"\n    cpu: \"250m\"\n  db_init:\n    memory: \"768Mi\"\n    cpu: \"1000m\"\n  db_router:\n    memory: \"100Mi\"\n    cpu: \"100m\"\nserverstransport:\n  maxIdleConnsPerHost: 0\n  dialTimeout: \"60s\"\n  responseHeaderTimeout: 0\n  readIdleTimeout: 0\n  idleConnTimeout: \"1s\"\nreplicas:\n  db: 1\n  httpd: 1\n  tools: 0\n  mailserver: 1\ncron:\n  suspend: false\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html","title":"Docker","text":"<p>Docker permet de mettre en oeuvre une architecture microservices, avec des images sp\u00e9cialis\u00e9es, adapt\u00e9es aux environnements gr\u00e2ce par exemple \u00e0 des variables d'environnement que l'on peut passer en argument de docker-run (par exemple).</p> <p>Le but des images est d'\u00eatre des images les plus stables possibles - id\u00e9alement des images que l'on pourrait utiliser en lecture seule. Les parties variables seraient id\u00e9alement toutes dans des volumes.</p> <p>Chaque Dockerfile du projet dispose d'une directive <code>LABEL</code> directement apr\u00e8s la directive <code>FROM</code> initiale, de sorte \u00e0 pouvoir invalider simplement le cache en modifiant les valeurs des labels.</p> <p>Un script de build des images ( <code>build.sh</code>) est fourni dans le d\u00e9p\u00f4t.</p> <pre><code>#!/bin/bash\nset -xev\nexport EXPBUILDVERSION=`cat VERSION`\necho ${EXPBUILDVERSION}\ndocker build --rm --no-cache -t uepal_test/selfkeys:${EXPBUILDVERSION} -t uepal_test/selfkeys --build-arg BUILDVERSION=${EXPBUILDVERSION} SELFKEYS \ndocker build --rm --no-cache -t uepal_test/keys_init:${EXPBUILDVERSION} -t uepal_test/keys_init --build-arg BUILDVERSION=${EXPBUILDVERSION} KEYS_INIT\ndocker build --rm --no-cache -t uepal_test/mysql_tls_router:${EXPBUILDVERSION} -t uepal_test/mysql_tls_router --build-arg BUILDVERSION=${EXPBUILDVERSION} MYSQL_TLS_ROUTER\ndocker build --rm --no-cache -t uepal_test/mysql_tls_server:${EXPBUILDVERSION} -t uepal_test/mysql_tls_server --build-arg BUILDVERSION=${EXPBUILDVERSION} MYSQL_TLS_SERVER\ndocker build --rm --no-cache -t uepal_test/composer_base:${EXPBUILDVERSION} -t uepal_test/composer_base --build-arg BUILDVERSION=${EXPBUILDVERSION} COMPOSER_BASE\ndocker build --rm --no-cache -t uepal_test/composer_files:${EXPBUILDVERSION} -t uepal_test/composer_files --build-arg BUILDVERSION=${EXPBUILDVERSION} COMPOSER_FILES\ndocker build --rm --no-cache -t uepal_test/tools:${EXPBUILDVERSION} -t uepal_test/tools --build-arg BUILDVERSION=${EXPBUILDVERSION} TOOLS\ndocker build --rm --no-cache -t uepal_test/tools_debug:${EXPBUILDVERSION} -t uepal_test/tools_debug --build-arg BUILDVERSION=${EXPBUILDVERSION} TOOLS_DEBUG\ndocker build --rm --no-cache -t uepal_test/init:${EXPBUILDVERSION} -t uepal_test/init --build-arg BUILDVERSION=${EXPBUILDVERSION} INIT\ndocker build --rm --no-cache -t uepal_test/cron:${EXPBUILDVERSION} -t uepal_test/cron --build-arg BUILDVERSION=${EXPBUILDVERSION} CRON\ndocker build --rm --no-cache -t uepal_test/httpd:${EXPBUILDVERSION} -t uepal_test/httpd --build-arg BUILDVERSION=${EXPBUILDVERSION} HTTPD\ndocker build --rm --no-cache -t uepal_test/httpd_debug:${EXPBUILDVERSION} -t uepal_test/httpd_debug --build-arg BUILDVERSION=${EXPBUILDVERSION} HTTPD_DEBUG\ndocker build --rm --no-cache -t uepal_test/update:${EXPBUILDVERSION} -t uepal_test/update --build-arg BUILDVERSION=${EXPBUILDVERSION} UPDATE\ndocker build --rm --no-cache -t uepal_test/test_opensmtpd_dovecot:${EXPBUILDVERSION} -t uepal_test/test_opensmtpd_dovecot --build-arg BUILDVERSION=${EXPBUILDVERSION} TEST_OPENSMTPD_DOVECOT\ndocker build --rm --no-cache -t uepal_test/gen_hashed_ca:${EXPBUILDVERSION} -t uepal_test/gen_hashed_ca --build-arg BUILDVERSION=${EXPBUILDVERSION} GEN_HASHED_CA\ndocker build --rm --no-cache -t uepal_test/traefik_docker:${EXPBUILDVERSION} -t uepal_test/traefik_docker --build-arg BUILDVERSION=${EXPBUILDVERSION} TRAEFIK_DOCKER\n</code></pre> <p>Ce script utilise un fichier nomm\u00e9 <code>VERSION</code> pour tagger chaque image g\u00e9n\u00e9r\u00e9e avec la version contenue dans le fichier, ainsi que le tag <code>latest</code>. La version est \u00e9galement positionn\u00e9e dans un argument d'un label dans chaque image Docker g\u00e9n\u00e9r\u00e9e. Ceci permet d'avoir un num\u00e9ro de version uniforme pour l'ensemble des images g\u00e9n\u00e9r\u00e9es.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#liste-des-images","title":"Liste des images","text":"<p>Un certain nombre d'images Docker est n\u00e9cessaire pour ex\u00e9cuter un environnement Civiparoisse complet.</p> <p>Ces images, dans l'ordre de build, sont :</p> <ul> <li>selfkeys</li> <li>keys_init</li> <li>mysql_tls_router</li> <li>mysql_tls_server</li> <li>composer_base</li> <li>composer_files</li> <li>tools</li> <li>tools_debug</li> <li>init</li> <li>cron</li> <li>httpd</li> <li>httpd_debug</li> <li>update</li> <li>test_opensmtpd_dovecot</li> <li>gen_hashed_ca</li> <li>traefik_docker</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#dependances-des-images-entre-elles","title":"D\u00e9pendances des images entre elles","text":"<p>En se basant sur la directive FROM des Dockerfiles, on obtient les d\u00e9pendances suivantes :</p> <ul> <li>ubuntu:focal</li> <li>test_opensmtpd_dovecot</li> <li>ubuntu:lunar</li> <li>mysql_tls_router</li> <li>keys_init</li> <li>gen_hashed_ca</li> <li>selfkeys</li> <li>composer_base<ul> <li>composer_files</li> <li>tools<ul> <li>tools_debug</li> <li>cron</li> <li>init</li> <li>update</li> </ul> </li> </ul> </li> <li>ubuntu/apache2</li> <li>httpd</li> <li>httpd_debug</li> <li>ubuntu/mysql</li> <li>mysql_tls_server</li> <li>traefik</li> <li>traefik_docker</li> </ul> <p>Toutefois, il y a \u00e9galement des injections de donn\u00e9es d'une image \u00e0 l'autre  via <code>COPY --from</code> :</p> <ul> <li>selfkeys<ul> <li>httpd</li> <li>indirectement (cf from): httpd_debug</li> <li>traefik_docker</li> <li>mysql_tls_router</li> <li>mysql_tls_server</li> <li>test_opensmtpd_dovecot</li> </ul> </li> <li>composer_files<ul> <li>httpd<ul> <li>indirectement (cf from): httpd_debug</li> </ul> </li> <li>tools<ul> <li>indirectement (cf from): cron</li> <li>indirectement (cf from): init    </li> <li>indirectement (cf from): tools_debug</li> <li>indirectement (cf from): update</li> </ul> </li> </ul> </li> </ul> <p>Le but de ces d\u00e9pendances est de \"stabiliser\" le contenu des images build\u00e9es, pour que le contenu qui doit \u00eatre pr\u00e9sent dans plusieurs images soit identique.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#principe-de-fonctionnement","title":"Principe de fonctionnement","text":"<p>Traefik va r\u00e9cup\u00e9rer tout le trafic entrant, va servir de terminaison HTTPS avec le navigateur du client web, et va utiliser le hostname pour d\u00e9terminer quelle instance de Civiparoisse contacter (via une liaison HTTPS \"interne\").</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#gestion-des-droits-sur-les-fichiers","title":"Gestion des droits sur les fichiers","text":"<p>La gestion des droits sur les fichiers est un sujet complexe. On suppose que les syst\u00e8mes de fichiers mis en oeuvre dans le syst\u00e8me proposent une gestion des droits traditionnels \"\u00e0 la Unix\", avec des droits read-write-exec que l'on peut attribuer \u00e0 un propri\u00e9taire, un groupe, et le reste du monde ; et on suppose qu'on peut identifier le propri\u00e9taire et le groupe de r\u00e9f\u00e9rence des fichiers.</p> <p>Etant donn\u00e9 qu'en principe seul le propri\u00e9taire et root peuvent changer les permissions sur un fichier, et qu'il est pr\u00e9f\u00e9rable que le compte root ne soit pas trop utilis\u00e9 (par exemple pour \u00e9viter par la suite une ex\u00e9cution en root via du bit SUID), il a \u00e9t\u00e9 privil\u00e9gi\u00e9 de cr\u00e9er un compte sp\u00e9cifique, verrouill\u00e9, dont le but est d'\u00eatre propri\u00e9taire des fichiers : le compte paroisse (UID 1001). Un groupe paroisse (GID 1001) est \u00e9galement provisionn\u00e9.</p> <p>Compte ubuntu</p> <p>Dans ubuntu:lunar, a \u00e9t\u00e9 constat\u00e9e l'existence d'un compte ubuntu (UID 1000). Ce compte a \u00e9t\u00e9 verrouill\u00e9 dans les images d\u00e9rivant de ubuntu:lunar.</p> <p>Le principe g\u00e9n\u00e9ral est que les fichiers (pour l'instant, non syst\u00e8me) qui sont pr\u00e9sents dans les images sont des fichiers destin\u00e9s \u00e0 \u00eatre en lecture seule, tandis que les fichiers des volumes seront en lecture \u00e9criture. Il s'agit d'appliquer le principe des droits minimaux pour effectuer les op\u00e9rations.</p> <p>L'id\u00e9e est de donner aux fichiers le propri\u00e9taire paroisse, et le groupe www-data. De l\u00e0, on peut positionner les droits sur les fichiers.</p> <p>De m\u00eame, il y a un compte authenticator (UID 1001) et un groupe authenticator (GID 1001) qui ont \u00e9t\u00e9 cr\u00e9es sur l'image d'authenticateur. Compte \u00e9galement verrouill\u00e9.</p> <p>En ce qui concerne les clefs, il faut se rappeler qu'Apache lit les clefs en tant que l'utilisateur lanc\u00e9 (root) avant de descendre ses droits. Du coup, les clefs n'ont pas besoin d'\u00eatre lues par www-data.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#volumes-principaux","title":"Volumes principaux","text":"<p>Ces volumes sont :</p> <ul> <li>civicomp_dbvol: le volume de base de donn\u00e9es</li> <li>civicomp_filevol: le volume des fichiers, avec les fichiers sp\u00e9cifiques \u00e0 l'instance courante</li> <li>civicomp_privatevol : le volume des fichiers priv\u00e9s</li> </ul> <p>Les volumes sont mont\u00e9s avec l'option <code>nocopy: true</code> car ce fonctionnement correspond au fonctionnement en environnement Kubernetes. En environnement Kubernetes, il y aura des montages suppl\u00e9mentaires (les secrets et les variables d'environnement, par exemple).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#docker-compose","title":"Docker-compose","text":"<p>Deux docker-compose sont disponibles. L'un d'eux, <code>docker-init.yml</code> est pr\u00e9vu pour initialiser les volumes, tandis que l'autre (<code>docker-compose.yml</code>, nom par d\u00e9faut) est utilis\u00e9 pour l'ex\u00e9cution classique.</p> <p>L'int\u00e9r\u00eat du docuker-compose r\u00e9side dans le fait que docker-compose va s'occuper de faire les liaisons n\u00e9cessaires entre les containers et les volumes, sans avoir besoin de saisir des lignes de commande fastidieuses. C'est donc un syst\u00e8me analogue \u00e0 ce qu'on retrouve dans la d\u00e9claration d'objets dans Kubernetes.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#initialisation-des-volumes","title":"Initialisation des volumes","text":"<p>On suppose qu'on se trouve dans le r\u00e9pertoire contenant les fichiers compose.</p> <pre><code>docker-compose -f docker-init.yml up\ndocker-compose -f docker-init.yml rm\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/docker.html#utilisation-de-lenvironnement-docker-au-quotidien","title":"Utilisation de l'environnement Docker au quotidien","text":"<p>Il faut penser \u00e0 mettre \u00e0 jour son <code>/etc/hosts</code> pour disposer de la r\u00e9solution de noms n\u00e9cessaire.  Ensuite, on peut faire des op\u00e9rations quotidiennes avec des commandes comme, par exemple (en \u00e9tant dans le r\u00e9pertoire contenant les fichiers compose) :</p> <pre><code>docker-compose -d up\n# [on fait le travail]\ndocker-compose stop\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/index.html","title":"Images Docker","text":"<ul> <li>selfkeys</li> <li>keys_init.md</li> <li>mysql_tls_router</li> <li>mysql_tls_server</li> <li>composer_base</li> <li>composer_files</li> <li>tools</li> <li>tools_debug</li> <li>init</li> <li>cron</li> <li>httpd</li> <li>httpd_debug</li> <li>update</li> <li>test_msmtp_dovecot</li> <li>gen_hashed_ca</li> <li>traefik_docker</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_base.html","title":"Image composer_base","text":"<p>Cette image est une des images de base du syst\u00e8me. De ce fait, cette image contient le n\u00e9cessaire commun n\u00e9cessaire aux images d\u00e9riv\u00e9es. Son but principal est de fournir une version utilisable de composer.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_base.html#contenu-necessaire-commun-aux-images-derivees","title":"Contenu n\u00e9cessaire commun aux images d\u00e9riv\u00e9es","text":"<p>Le n\u00e9cessaire int\u00e8gre la mise \u00e0 jour de l'image, la mise au bon fuseau horaire, l'installation d'outils comme wget et php et les utilitaires xml.</p> <p>De m\u00eame il y a la cr\u00e9ation de l'utilisateur et du groupe paroisse.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_base.html#bug-de-compatibilite-composersymfonycivicrm","title":"Bug de compatibilit\u00e9 composer/symfony/civicrm","text":"<p>Cette image est une image qui a \u00e9t\u00e9 construite pour r\u00e9gler une probl\u00e9matique technique li\u00e9e \u00e0 une interaction entre les d\u00e9pendances de composer et le code source natif de civicrm :</p> <pre><code>PHP Fatal error:  Uncaught TypeError: Return value of \"Civi\\CompilePlugin\\Command\\CompileCommand::execute()\" must be of the type int, \"null\" returned. in /composer/vendor/symfony/console/Command/Command.php:301\nStack trace:\n#0 /composer/vendor/symfony/console/Application.php(1015): Symfony\\Component\\Console\\Command\\Command-&gt;run()\n#1 /composer/vendor/symfony/console/Application.php(299): Symfony\\Component\\Console\\Application-&gt;doRunCommand()\n#2 /composer/vendor/composer/composer/src/Composer/Console/Application.php(336): Symfony\\Component\\Console\\Application-&gt;doRun()\n#3 /composer/vendor/symfony/console/Application.php(171): Composer\\Console\\Application-&gt;doRun()\n#4 /composer/vendor/composer/composer/src/Composer/Console/Application.php(131): Symfony\\Component\\Console\\Application-&gt;run()\n#5 /composer/vendor/composer/composer/bin/composer(84): Composer\\Console\\Application-&gt;run()\n#6 {main}\n  thrown in /composer/vendor/symfony/console/Command/Command.php on line 301\n</code></pre> <p>Composer a une d\u00e9pendance sur symfony/console ; si composer est packag\u00e9 avec une version 5.4 ou plus, la d\u00e9pendance requiert que la m\u00e9thode execute de  https://github.com/civicrm/composer-compile-plugin/blob/master/src/Command/CompileCommand.php retourne un entier (cf https://github.com/symfony/console/blob/5.4/Command/Command.php ligne 301).</p> <p>Avec l'image composer \"officielle\" je n'ai pas le probl\u00e8me car le code de la d\u00e9pendance n'inclut pas l'exception. En revanche, elle est d\u00e9clench\u00e9e par le composer packag\u00e9 par ubuntu dans la 21.10.</p> <p>La solution est donc de pr\u00e9parer un composer en utilisant une version inf\u00e9rieure de symfony : via composer.json, on peut pr\u00e9parer cette version en utilisant le composer fourni par le syst\u00e8me : </p> <pre><code>{\n\"require\":{\n\"composer/composer\":\"^2\",\n\"symfony/console\":\"^4\"\n}\n}\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html","title":"Composer_files","text":"<p>L'image composer_files permet de figer les fichiers \u00e0 d\u00e9ployer pour une instance CiviCRM, ce qui permet de comprendre les inclusions effectu\u00e9es depuis le Dockerfile (<code>COPY --from</code>, pr\u00e9sents notamment dans tools, et indirectement init et cron, ainsi que dans httpd).</p> <pre><code>{\n\"config\":{\n\"allow-plugins\":true,\n\"store-auths\":false\n},\n\"repositories\":[{\n\"type\":\"package\",\n\"package\":[{\n  \"name\":\"civipkg/uk.co.vedaconsulting.mosaico\",\n  \"type\":\"civicrm-ext\",\n  \"version\":\"2.12\",\n  \"source\":{\n     \"type\":\"git\",\n     \"url\":\"https://github.com/veda-consulting-company/uk.co.vedaconsulting.mosaico.git\",\n     \"reference\":\"2.12\"\n    }\n}]\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/ROLES\"\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/CIVIPAROISSE\"\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/SETUP\"\n},{\n\"type\":\"git\",\n\"url\":\"/composer_registry/CIVIIMPORT\"\n},{\n\"type\":\"package\",\n\"package\":[{\n    \"name\":\"eileenmcnaughton/org.wikimedia.geocoder\",\n    \"type\":\"civicrm-ext\",\n    \"version\":\"1.8\",\n    \"source\":{\n        \"type\":\"git\",\n        \"url\":\"https://github.com/eileenmcnaughton/org.wikimedia.geocoder.git\",\n        \"reference\":\"1.8\"\n     }\n},{\n    \"name\":\"civicrm/org.civicrm.recentmenu\",\n    \"version\":\"1.5\",\n    \"type\":\"civicrm-ext\",\n    \"source\":{\n        \"type\":\"git\",\n        \"url\":\"https://github.com/civicrm/org.civicrm.recentmenu.git\",\n        \"reference\":\"1.5\"\n    }\n}]\n}\n],\n    \"extra\":{\n    \"installer-paths\": {\n            \"web/core\": [\"type:drupal-core\"],\n            \"web/libraries/{$name}\": [\"type:drupal-library\"],\n            \"web/modules/contrib/{$name}\": [\"type:drupal-module\"],\n            \"web/profiles/contrib/{$name}\": [\"type:drupal-profile\"],\n            \"web/themes/contrib/{$name}\": [\"type:drupal-theme\"],\n            \"drush/Commands/contrib/{$name}\": [\"type:drupal-drush\"],\n            \"web/modules/custom/{$name}\": [\"type:drupal-custom-module\"],\n            \"web/profiles/custom/{$name}\": [\"type:drupal-custom-profile\"],\n            \"web/themes/custom/{$name}\": [\"type:drupal-custom-theme\"]\n        },\n\"drupal-scaffold\":{\n\"locations\":{\n\"web-root\":\"web/\"\n},\n\"allowed-packages\":[\"drupal/recommended-project\"]\n},\n\"compile-mode\":\"all\",\n\"compile-passthru\":\"always\",\n\"enable-patching\":true,\n\"compile-whitelist\": [\"civicrm/civicrm-core\", \"civicrm/composer-compile-lib\"],\n\"drupal-l10n\":{\n\"languages\":[\"fr\"]\n},\n\"compile\":[\n{\"run\":\"@sh /bin/bash -c pwd ; export VERSION=`xmllint -xpath '/version/version_no/text()' vendor/civicrm/civicrm-core/xml/version.xml`; wget -O- https://download.civicrm.org/civicrm-${VERSION}-l10n.tar.gz|tar -z -f- -C vendor/civicrm/civicrm-core -x --strip-components=1\"},\n{\"run\":\"@sh /bin/bash -c pwd ; cp -R vendor/civicrm/civicrm-core/ext/greenwich/extern/bootstrap3/assets/fonts/bootstrap vendor/civicrm/civicrm-core/ext/greenwich/fonts\"}\n]\n},\n\"require\":{\n\"drush/drush\":\"11.5.1\",\n\"drupal/recommended-project\":\"~9.5.8\",\n\"drupal-composer/drupal-l10n\":\"~2.0.3\",\n\"cweagans/composer-patches\":\"~1.7.3\",\n\"eileenmcnaughton/org.wikimedia.geocoder\":\"1.8\",\n\"civicrm/org.civicrm.recentmenu\":\"1.5\",\n\"civicrm/civicrm-core\":\"5.60.0\",\n\"civicrm/civicrm-packages\":\"5.60.0\",\n\"civicrm/civicrm-drupal-8\":\"5.60.0\",\n\"civicrm/civicrm-asset-plugin\":\"1.1.3\",\n\"civicrm/composer-downloads-plugin\":\"3.0.1\",\n\"civicrm/composer-compile-plugin\":\"0.20\",\n\"uepal/fr.uepalparoisse.civiparoisse\":\"0.0.1\",\n\"uepal/civisetup\":\"0.0.1\",\n\"uepal/fr.uepalparoisse.civiimport\":\"0.0.1\",\n\"uepal/civiroles\":\"0.0.1\",\n\"civipkg/uk.co.vedaconsulting.mosaico\":\"2.12\"\n},\n\"minimum-stability\":\"dev\",\n\"prefer-stable\":true\n}\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html#allow-plugins","title":"Allow plugins","text":"<p>** Pour le moment, la directive allow plugins a \u00e9t\u00e9 plac\u00e9e \u00e0 true, ce qui autorise l'ex\u00e9cution des plugins sans avoir besoin de les sp\u00e9cifier. Toutefois, on pourrait pr\u00e9f\u00e9rer une liste de plugins explicitement d\u00e9clar\u00e9s. **</p> <p>** Ce param\u00e8tre a \u00e9t\u00e9 mis \u00e0 true pour le moment car la valeur par d\u00e9faut de ce param\u00e8tre va passer en juillet 2022 de <code>null</code> \u00e0 <code>{}</code> : autorisation implicite \u00e0 aucun plugin autoris\u00e9 (voir https://getcomposer.org/doc/06-config.md#allow-plugins) **</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html#diversite-des-sources","title":"Diversit\u00e9 des sources","text":"<p>Plusieurs types de sources sont utilis\u00e9es :</p> <ul> <li>les packages de Packagist : pour les packages \"standards\"</li> <li>les packages qui viennent de d\u00e9p\u00f4t Git qui disposent d'un n\u00e9cessaire pour composer (composer.json) et de versionning (via des tags notamment) : type git</li> <li>les packages qui viennent de d\u00e9p\u00f4t Git mais qui n'ont pas le n\u00e9cessaire pour composer : ces packages sont d\u00e9clar\u00e9s de mani\u00e8re explicite, avec la r\u00e9f\u00e9rence vers la source : type package ; la source de ces packages peut en revanche \u00eatre un d\u00e9p\u00f4t git, avec une r\u00e9f\u00e9rence (tag ou nom de branche) pour s\u00e9lectionner la source correspondante.</li> </ul> <p>Les packages de sources locales de Civiparoisse sont destin\u00e9s \u00e0 \u00eatre remplac\u00e9 par les d\u00e9p\u00f4ts publics git une fois qu'une version aura \u00e9t\u00e9 stabilis\u00e9e et distribu\u00e9e.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html#presence-de-drush-dans-les-packages-requis","title":"Pr\u00e9sence de drush dans les packages requis","text":"<p>Drush est pr\u00e9sent dans les packages requis. Ceci peut surprendre a priori, mais l'exp\u00e9rimentation montre qu'il est r\u00e9ellement n\u00e9cessaire : en effet, Drush est utilis\u00e9 pour ex\u00e9cuter les appels de cron, mais en ayant acc\u00e8s aux volumes de fichiers du serveur web interne ainsi qu'\u00e0 la base de donn\u00e9es. Lors de son ex\u00e9cution, Drush supplante dans certains services (notamment les logs) les classes qu'il fournit. Si lors de l'ex\u00e9cution de Drush les caches sont reg\u00e9n\u00e9r\u00e9s, les supplantations de Drush seront pr\u00e9sents dans les caches. Lorsque le cache est r\u00e9utilis\u00e9 sur le serveur web interne, le serveur doit avoir acc\u00e8s aux classes de Drush pour ne pas tomber sur une erreur.</p> <p>** On retiendra donc que Drush est n\u00e9cessaire pour ces classes, mais qu'on peut envisager de ne pas laisser les droits en ex\u00e9cution sur les ex\u00e9cutables dans les fichiers. **</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html#scaffolding","title":"Scaffolding","text":"<p>Le scaffolding est le fait de r\u00e9partir les fichiers entre le DocumentRoot du site et un autre lieu hors du DocumentRoot. Cette r\u00e9partition est pr\u00e9vue par le package <code>drupal/recommended-project</code> ; toutefois, il a fallu reprendre la majorit\u00e9 de cette configuration dans le fichier composer.json de l'image pour que ce scaffolding puisse avoir lieu, car il est n\u00e9cessaire que cette configuration se situe dans le composer.json principal.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/composer_files.html#traductions","title":"Traductions","text":"<p>Les traductions ont deux sources : * pour Drupal, il s'agit du package <code>drupal-composer/drupal-l10n</code> * pour CiviCRM, les traductions sont r\u00e9cup\u00e9r\u00e9es via une \u00e9tape de (post)-compilation, o\u00f9 l'on va r\u00e9cup\u00e9rer d'abord la version de CiviCRM depuis un fichier XML pr\u00e9sent dans les sources, puis r\u00e9cup\u00e9rer sur le net les traductions, et enfin les d\u00e9compresser au bon endroit.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/cron.html","title":"Cron","text":"<p>Cette image est tr\u00e8s simple : elle est pr\u00e9vue pour ex\u00e9cuter les t\u00e2ches cron \u00e0 la fois de civicrm et drupal. Elle est pr\u00e9vue pour qu'on y connecte les volumes via montage, mais elle doit acc\u00e9der les BD mysql de l'instance.</p> <p>Sa planification d'ex\u00e9cution doit \u00eatre pr\u00e9vue dans Kubernetes. </p> <pre><code>#!/bin/bash\nsudo www-data cv --cwd=/app api job.execute\nsudo www-data drush --no-interaction --quiet --root /app core:cron\n</code></pre> <pre><code>FROM uepal_test/tools\nCOPY exec.sh /exec/exec.sh\nRUN chown -R root:root /exec &amp;&amp; chmod -R 500 /exec\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/gen_hashed_ca.html","title":"gen_hashed_ca : G\u00e9n\u00e9ration du r\u00e9pertoires des certificats racines","text":"<p>La reg\u00e9n\u00e9ration du r\u00e9pertoire des certificats racines est n\u00e9cessaire si on a besoin d'int\u00e9grer des certificats d'autorit\u00e9s priv\u00e9s (d'entreprise) dans les certificats d'autorit\u00e9s reconnus. C'est le cas dans le cadre de Civiparoisse lorsqu'on installe le serveur de mail de d\u00e9mo (qui ne ne doit pas \u00eatre utilis\u00e9 pour la prod), de sorte que les certificats soient valid\u00e9s au niveau PHP du fait de la configuration de openssl et de /etc/ssl/certs.</p> <p>L'id\u00e9e de cette image est de monter un volume avec les certificats d'autorit\u00e9 \u00e0 ajouter d'une part, et de monter un volume pour recueillir la version hash\u00e9e des certificats reconnus apr\u00e8s mis \u00e0 jour d'autre part.</p> <pre><code>#Image pour reg\u00e9n\u00e9rer les CA (utile pour int\u00e9gration d'une CA priv\u00e9e, surtout pour les devs)\nFROM ubuntu:lunar\nLABEL uepal.name=\"hashedCA\" uepal.version=\"0.0.1\"\nRUN usermod -L -s /usr/sbin/nologin -e 1 ubuntu\nENV LANG=C.UTF-8\nRUN mkdir /CERTS &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; apt-get install -y ca-certificates &amp;&amp; apt-get remove --purge --autoremove -y &amp;&amp; rm -rf /var/lib/apt/lists\nVOLUME /usr/local/share/ca-certificates\nVOLUME /CERTS\nCMD [\"/bin/bash\",\"-c\",\"update-ca-certificates &amp;&amp; cp -RL /etc/ssl/certs/* /CERTS/\"]\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/httpd.html","title":"Image HTTPD","text":"<p>Cette image a pour vocation de faire tourner le serveur web interne. Elle d\u00e9rive de <code>ubuntu/apache2</code> et int\u00e8gre des \u00e9l\u00e9ments issus d'images tierces par copie (<code>COPY --from</code> dans le Dockerfile).</p> <pre><code>#Image du serveur web\nFROM ubuntu/apache2\nLABEL uepal.name=\"httpd\" uepal.version=\"0.0.2\"\nRUN usermod -L -s /usr/sbin/nologin -e 1 ubuntu\nENV LANG=C.UTF-8\nENV MAX_CONNECTIONS_PER_CHILD=1 MAX_REQUEST_WORKERS=4 SERVER_LIMIT=4 START_SERVERS=4 MIN_SPARE_SERVERS=1 MAX_SPARE_SERVERS=4 LISTEN_BACKLOG=1\nENV SERVERNAME=\"civicrm.test\" SERVER_CERT=\"/var/run/secrets/KEYS/extern.x509\" SERVER_KEY=\"/var/run/secrets/KEYS/extern.pem\"\nRUN groupadd -g 1001 -f paroisse &amp;&amp; useradd -d /nonexistent -e 1 -g 1001 -u 1001 -M -N -s /usr/sbin/nologin paroisse &amp;&amp; usermod -L paroisse &amp;&amp; mkdir /exec &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y openssl ca-certificates php8.1 php8.1-cli php8.1-curl php8.1-gd php8.1-intl php8.1-mysql php8.1-opcache php8.1-xml php8.1-bcmath php8.1-mbstring php8.1-soap php8.1-xsl php8.1-zip php8.1-imagick php8.1-uploadprogress &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; mkdir /app &amp;&amp; install -d /var/run/secrets/KEYS\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/extern.* /var/run/secrets/KEYS/\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/extern_ca.x509 /var/run/secrets/KEYS/\nCOPY --from=uepal_test/composer_files /app /app/\nCOPY civicrm.conf /etc/apache2/sites-available/\nCOPY mpm_prefork.conf /etc/apache2/mods-available/\nRUN service apache2 stop &amp;&amp; a2dismod mpm_event &amp;&amp; a2enmod mpm_prefork &amp;&amp; a2enmod ssl &amp;&amp; a2enmod rewrite &amp;&amp; a2ensite civicrm &amp;&amp; chown root:root /etc/apache2/sites-available/civicrm.conf &amp;&amp; chmod 400 /etc/apache2/sites-available/civicrm.conf &amp;&amp; chown -R root:root /var/run/secrets/KEYS &amp;&amp; chgrp www-data /var/run/secrets/KEYS &amp;&amp; chmod 510 /var/run/secrets/KEYS &amp;&amp; chmod 440 /var/run/secrets/KEYS/*\nVOLUME /app/web/sites /app/private\nEXPOSE 443\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/httpd.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Description Valeur par d\u00e9faut MAX_CONNECTIONS_PER_CHILD Nombre de connexions servies par un worker avant d'\u00eatre recycl\u00e9 1 MAX_REQUEST_WORKERS Nombre de connexions simultan\u00e9es 4 SERVER_LIMIT Nombre de workers simultan\u00e9s 4 START_SERVERS Nombre de workers \u00e0 d\u00e9marrer 4 MIN_SPARE_SERVERS Nombre de workers inactifs minimum 1 MAX_SPARE_SERVERS Nombre de workers inactifs maximum 4 SERVERNAME Nom de l'h\u00f4te \"civicrm.test\" SERVER_CERT Chemin du fichier de certificat \"/var/run/secrets/KEYS/extern.x509\" SERVER_KEY Chemin du fichier de clef SSL \"/var/run/secrets/KEYS/extern.pem\""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/httpd.html#configuration-dapache","title":"Configuration d'Apache","text":"<p>La configuration d'Apache a une particularit\u00e9 : la grande utilisation des variables d'environnements d\u00e9clar\u00e9es : on retrouve cette possibilit\u00e9 dans la documentation Apache (https://httpd.apache.org/docs/current/fr/env.html).</p> <pre><code>&lt;VirtualHost 0.0.0.0:443&gt;\nServerName ${SERVERNAME}\nDocumentRoot /app/web\n&lt;Directory /app/web&gt;\nphp_admin_value upload_max_filesize 3M\nphp_admin_value date.timezone Europe/Paris\nAllowOverride All\nSSLRequireSSL\n&lt;RequireAll&gt;\nRequire ssl\n&lt;/RequireAll&gt;\n&lt;/Directory&gt;\nSSLEngine on\nSSLCertificateFile ${SERVER_CERT}\nSSLCertificateKeyFile ${SERVER_KEY}\nSSLCipherSuite HIGH:!aNULL:!MD5\nSSLOptions +StrictRequire\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/httpd_debug.html","title":"HTTPD_DEBUG : image HTTPD avec Xdebug","text":"<p>Cette image est int\u00e9ressante uniquement pour le d\u00e9veloppement (pas pour la production) : elle ajoute la configuration de Xdebug \u00e0 l'image Httpd du projet :</p> <pre><code>#Image du serveur web avec outils de d\u00e9buggage (pour dev)\nFROM uepal_test/httpd\nLABEL uepal.name=\"httpd_debug\" uepal.version=\"0.0.2\"\nRUN  apt-get update &amp;&amp; apt-get install php8.1-xdebug &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY 99-xdebug.ini /etc/php/8.1/apache2/conf.d/\nCOPY 99-xdebug.ini /etc/php/8.1/cli/conf.d/\n</code></pre> <p>La configuration de Xdebug est pr\u00e9vue pour un autostart pour aller vers la machine h\u00f4te (on suppose que le d\u00e9veloppeur d\u00e9veloppe localement) en utilisant comme cible l'h\u00f4te <code>host.docker.internal</code>.</p> <pre><code>[xdebug]\nxdebug.log=/tmp/xdebug.log\nxdebug.log_level=7\nxdebug.mode=debug\nxdebug.client_port=9003\nxdebug.client_host=host.docker.internal\nxdebug.start_with_request=yes\nxdebug.discover_client_host=false\nxdebug.idekey=phpstorm\n\nxdebug.remote_enable=On\nxdebug.remote_host=host.docker.internal\nxdebug.remote_port=9003\nxdebug.remote_autostart=On\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/init.html","title":"Image init","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/init.html#description","title":"Description","text":"<p>Cette image est pr\u00e9vue pour initialiser les volumes d'une instance. Elle est pr\u00e9vue pour effectuer les t\u00e2ches d'installation sp\u00e9cifi\u00e9es dans un script shell, utilisant grandement les variables d'environnement.</p> <p>Les secrets (dont mots de passe) sont sens\u00e9s \u00eatre pass\u00e9s via des fichiers mont\u00e9s dans l'environnement du container, comme ce qui est pr\u00e9vu dans Kubernetes pour la mise \u00e0 disposition des secrets, ce qui permet d'ailleurs la personnalisation des installations.</p> <p>A noter que si les volumes ne sont pas vides, le script est pr\u00e9vu pour ne rien faire.</p> <pre><code>#Image d'initialisation d'une instance civiparoisse\nFROM uepal_test/tools\nLABEL uepal.name=\"init\" uepal.version=\"0.0.2\"\nENV PAROISSE_NAME=\"Paroisse Uepal de test\" PAROISSE_ADDR=\"1b,quai Saint Thomas\" PAROISSE_CITY=\"Strasbourg\"  PAROISSE_PHONE=\"0011223344\" PAROISSE_ZIPCODE=\"67000\" CIVI_DOMAIN=\"DomaineParoisse\" DBNAME_CIVICRM=\"civicrm\" DBNAME_DRUPAL=\"drupal\" DBNAME_CIVILOG=\"civilog\" DBHOST=\"localhost\" DBUSER=\"exploitant\" DBSECRET=\"dbsecret\" DBROOTSECRET=\"dbrootsecret\" DRUPAL_ADMIN_USER_SECRET=\"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET=\"drupal_password\" SERVERNAME=\"civicrm.test\" TRUSTED_HOST_PATTERNS=\"['^civicrm\\\\.test$']\" MAILADMIN_ADDR=\"imapusername@civicrm.test\" MAILADMIN_NAME=\"Admin ADMIN\" MAILADMIN_DESCR=\"mail admin descr\" MAILDIR=\"/maildir\" SITENAME=\"Site de test civicrm\" IMAP_USERNAME_SECRET=\"imapUsername\" IMAP_PASSWORD_SECRET=\"imapPassword\" MAILDOMAIN=\"civicrm.test\" BOUNCE_LOCALPART=\"civibounce+\" BOUNCE_RETURNPATH=\"bounce@civicrm.test\" IMAP_SERVER=\"imap\" IMAP_PORT=\"993\" IMAP_IS_SSL=\"1\" IMAP_INBOX_FOLDER=\"INBOX\" SMTP_USERNAME_SECRET=\"smtpUsername\" SMTP_PASSWORD_SECRET=\"smtpPassword\" SMTP_HOST=\"smtp\" SMTP_PORT=\"25\" MAILSITE_ADDR=\"imapusername@civicrm.test\" MAILDOMAIN_ADDR=\"imapusername@civicrm.test\" PAROISSE_STREETNUMBER=\"1\"\nRUN rsync -av /app/web/sites/ /sites_orig &amp;&amp; rsync -av /var/lib/mysql/ /mysql_orig &amp;&amp; rm -Rf /app/web/sites/* &amp;&amp; rm -Rf /var/lib/mysql/*\nCOPY exec.sh /exec/exec.sh\nRUN chown -R root:root /exec &amp;&amp; chmod -R 500 /exec\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/init.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker PAROISSE_NAME Nom de la paroisse \"Paroisse Uepal de test\" PAROISSE_ADDR Adresse de la paroisse \"1b,quai Saint Thomas\" PAROISSE_CITY Ville de la paroisse \"Strasbourg\" PAROISSE_PHONE Num\u00e9ro de t\u00e9l\u00e9phone de la paroisse \"0011223344\" PAROISSE_ZIPCODE Code postal de la paroisse \"67000\" CIVI_DOMAIN Nom du domaine civicrm \"DomaineParoisse\" DBNAME_CIVICRM Nom DB CiviCRM \"civicrm\" DBNAME_DRUPAL Nom DB Drupal \"drupal\" DBNAME_CIVILOG Nom DB Audit CiviCRM \"civilog\" DBHOST Hote base de donn\u00e9es \"civicrmdb\" DBUSER Utilisateur au niveau des BD mysql \"exploitant\" DBSECRET Nom du secret pour le mot de passe de l'utilisateur de la BD \"dbsecret\" DBROOTSECRET Nom du secret pour le mot de passe root de la BD \"dbrootsecret\" DRUPAL_ADMIN_USER_SECRET Nom du secret pour l'utilisateur administrateur Drupal \"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET Nom du secret pour le mot de passe administrateur Drupal \"drupal_password\" SERVERNAME Nom du serveur externe \"civicrm.test\" TRUSTED_HOST_PATTERNS Patterns de hosts autoris\u00e9s pour Drupal \"['^civicrm\\.test$','^intern\\.civicrm\\.test$']\" MAILADMIN_ADDR Adresse mail de l'administrateur \"admin@civicrm.test\" MAILADMIN_NAME Nom de l'administrateur pour l'adresse mail \"Admin ADMIN\" MAILADMIN_DESCR Description de l'adresse mail admin \"mail admin descr\" MAILDIR Path du r\u00e9pertoire de mails entrants (maildir) \"/maildir\" SITENAME Nom du site \"Site de test civicrm\" IMAP_USERNAME_SECRET Nom du secret qui contient le nom d'utilisateur imap \"imapUsername\" IMAP_PASSWORD_SECRET Nom du secret contenant le mot de passe de l'utilisateur imap \"imapPassword\" MAILDOMAIN Nom du domaine pour les mails \"civicrm.test\" BOUNCE_LOCALPART Pour les adresses VERP, la partie stable du d\u00e9but d'adresse \"civibounce+\" BOUNCE_RETURNPATH L'adresse pour le header <code>Return-Path</code> \"bounce@civicrm.test\" IMAP_SERVER Le nom de l'h\u00f4te imap \u00e0 contacter \"imap\" IMAP_PORT Le num\u00e9ro du port \u00e0 utiliser pour contacter l'h\u00f4te imap \"993\" IMAP_IS_SSL Si le service imap utilise le SSL \"1\" IMAP_INBOX_FOLDER Le nom du dossier \u00e0 consulter \"INBOX\" SMTP_USERNAME_SECRET Le secret contenant le nom d'utilisateur pour le smtp \"smtpUsername\" SMTP_PASSWORD_SECRET Le secret contenant le mot de passe pour le smtp \"smtpPassword\" SMTP_HOST Le nom d'h\u00f4te du serveur smtp \"smtp\" SMTP_PORT Le port \u00e0 utiliser sur le serveur smtp \"25\" MAILSITE_ADDR L'adresse mail du site \"imapusername@civicrm.test\" MAILDOMAIN_ADDR L'adresse mail de la configuration li\u00e9e au domaine civicrm \"imapusername@civicrm.test\" PAROISSE_STREETNUMBER Le num\u00e9ro de rue de l'adresse postale de la paroisse \"1\""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/keys_init.html","title":"KEYS_INIT","text":"<p>Cette image a \u00e9t\u00e9 introduite pour pouvoir initialiser des jeux de clefs SSL en fonction du nom de domaine, du nom wildcard et du nom de serveur mail souhait\u00e9s par un d\u00e9veloppeur. Elle est pr\u00e9vue pour mettre l'ensemble des clefs dans un r\u00e9pertoire dans lequel un volume devrait \u00eatre mont\u00e9. Elle va \u00e9galement pr\u00e9parer un r\u00e9pertoire avec le hash des certificats.</p> <p>Cette image s'utilise uniquement avec l'environnement Docker, pas avec l'environnement Kubernetes (o\u00f9 ce travail sera r\u00e9alis\u00e9 par Helm).</p> <pre><code>#Image pour la g\u00e9n\u00e9ration des clefs n\u00e9cessaires au d\u00e9ploiement d'une instance (surtout pour les devs avec Docker)\nFROM ubuntu:lunar\nLABEL uepal.name=\"keys_init\" uepal.version=\"0.0.2\"\nRUN usermod -L -s /usr/sbin/nologin -e 1 ubuntu\nENV LANG=C.UTF-8\nENV SERVERNAME=civicrm.test WILDCARDNAME=*.test MAILHOST=civimail.test\nRUN  apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; apt-get install -y openssl ca-certificates &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; mkdir /CERTS\nCOPY keys_env.sh /\nWORKDIR /KEYS\nVOLUME /KEYS\nVOLUME /CERTS\nCMD [\"/keys_env.sh\"]\n</code></pre> Variable Signification Default Docker SERVERNAME Nom du serveur externe \"civicrm.test\" WILDCARDNAME Nom \u00e0 utiliser avec le certificat wildcard *.test MAILHOST Nom de l'h\u00f4te de d\u00e9mo pour les mails civimail.test"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/mysql_tls_router.html","title":"MYSQL_TLS_ROUTER","text":"<p>Cette image embarque une configuration de mysqlrouter, qui force l'utilisation du SSL pour le SGBD cible, mais ne requiert pas le SSL pour le client (d'o\u00f9 une connexion privilig\u00e9e via une socket unix). De cette mani\u00e8re, on pourra se connecter \u00e0 un serveur MySQL \"classique\" en SSL, et on ne se prive pas d'une \u00e9ventuelle utilisation d'un \"MySQL as a service\".</p> <p>Configuration mysqlrouter.conf : </p> <pre><code>[DEFAULT]\nlogging_folder = \"\"\nlevel = debug\nsinks = consolelog\n\n[routing]\nprotocol = classic\nsocket = /SOCK/mysqld.sock\ndestinations = civicrmdb:3306\nserver_ssl_verify = VERIFY_CA\nserver_ssl_mode = REQUIRED\nserver_ssl_ca = /KEYS/db_ca.x509\nclient_ssl_mode = DISABLED\nrouting_strategy = next-available\nbind_port = 3306\nbind_address = 127.0.0.1\n\n[consolelog]\ndestination = /dev/stdout\n</code></pre> <p>Cette image n'a pas de variable d'environnement notable, car MySQL ne permet d'en sp\u00e9cifier dans le fichier de configuration. Toutefois, dans le chart Helm, on pourra envisager si n\u00e9cessaire d'utiliser des variables g\u00e9r\u00e9es par Helm pour stocker le fichier de configuration. Ainsi, il pourrait \u00e9galement \u00eatre envisag\u00e9 d'utiliser une image officielle d\u00fbment configur\u00e9e au lieu d'une image personnalis\u00e9e.</p> <pre><code>#Image pour disposer de mysqlrouter pour la connexion chiffr\u00e9e vers la BD et le montage socket depuis un container du m\u00eame pod\nFROM ubuntu:lunar\nLABEL uepal.name=\"uepal/mysql_tls_router\" uepal.version=\"0.0.2\"\nRUN usermod -L -s /usr/sbin/nologin -e 1 ubuntu\nENV LANG=C.UTF-8\nRUN mkdir /KEYS &amp;&amp; mkdir /etc/mysqlrouter &amp;&amp; mkdir /SOCK\nRUN apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata &amp;&amp; apt-get install -y mysql-router &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/db_ca.x509 /KEYS/\nCOPY mysqlrouter.conf /etc/mysqlrouter/\nCOPY exec.sh /\nRUN chown root:root /etc/mysqlrouter/mysqlrouter.conf &amp;&amp; chown root:root /exec.sh &amp;&amp; chmod 444 /etc/mysqlrouter/mysqlrouter.conf &amp;&amp; chmod 500 /exec.sh\nCMD [\"/bin/sh\",\"-c\",\"/exec.sh\"]\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/mysql_tls_server.html","title":"MYSQL_TLS_SERVER","text":"<p>Cette image est nouvelle. Elle sp\u00e9cifie l'obligation d'avoir un transport chiffr\u00e9, et positionne le mode SQL tel que prescrit par CiviCRM. Le niveau d'isolation de transaction <code>READ-COMMITED</code> vient des recommandations du tableau de bord de Drupal. L'option <code>skip-log-bin</code> permet de r\u00e9gler les probl\u00e8mes sur la cr\u00e9ation des triggers, mais fait que les journaux ne seront pas utilis\u00e9s.</p> <p>Configuration mysqld : </p> <pre><code>[mysqld]\nrequire-secure-transport=ON\nssl_ca=/KEYS/db_ca.x509\nssl_cert=/KEYS/civicrmdb.x509\nssl_key=/KEYS/civicrmdb.pem\nsql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\nskip-log-bin\ntls_version=TLSv1.3\ntransaction_isolation=\"READ-COMMITTED\"\n</code></pre> <p>Configuration Dockerfile :</p> <pre><code>#Image du serveur BD\nFROM ubuntu/mysql:latest\nLABEL uepal.name=\"uepal_test/mysql_tls_server\" uepal.version=\"0.0.2\"\nENV LANG=C.UTF-8\nRUN apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nRUN mkdir /KEYS\nCOPY --from=uepal_test/selfkeys KEYS/USAGE/civicrmdb.* /KEYS/\nCOPY --from=uepal_test/selfkeys KEYS/USAGE/db_ca.x509 /KEYS/\nCOPY config_mysqld.cnf /etc/mysql/conf.d/\nRUN chgrp -R mysql /KEYS &amp;&amp; chmod 440 /KEYS/* &amp;&amp; chmod 550 /KEYS &amp;&amp; chown mysql:mysql /etc/mysql/conf.d/config_mysqld.cnf &amp;&amp; chmod 440 /etc/mysql/conf.d/config_mysqld.cnf\n</code></pre> <p>La mise \u00e0 jour des paquets de l'image cherche \u00e0 renforcer la probabilit\u00e9 que la version du SGBD de l'image sera la m\u00eame que celle utilis\u00e9e pour l'installation (puisque le probl\u00e8me s'est d\u00e9j\u00e0 pos\u00e9 lors du d\u00e9veloppement, o\u00f9 la version de l'image d'init \u00e9tait plus r\u00e9cente que celle livr\u00e9e dans l'image de base).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/selfkeys.html","title":"Selfkeys","text":"<p>Cette image permet uniquement de g\u00e9n\u00e9rer une hi\u00e9rarchie de certificats SSL pour faire un CA autosign\u00e9 et des certificats qui vont utiliser ce CA comme racine. Un r\u00e9pertoire de certificats racines va \u00eatre \u00e9galement mis \u00e0 disposition lors de l'ex\u00e9cution de l'image.</p> <p>La cr\u00e9ation de l'image Docker ne va pas cr\u00e9er les fichiers de clefs : le script keys.sh doit \u00eatre lanc\u00e9 pour g\u00e9n\u00e9rer les fichiers. Ceci est fait expr\u00e8s, pour pouvoir rebuilder une image avec les m\u00eames clefs.</p> <p>En effet, l'image a en plus le (bon) go\u00fbt de ne pas embarquer la clef priv\u00e9e CA : du coup, il n'est pas possible de g\u00e9n\u00e9rer d'autres certitificats avec le CA comme racine.</p> <p>Le seul CA sp\u00e9cifique qui doit \u00eatre embarqu\u00e9 l'est uniquement dans le cas du serveur de mail de d\u00e9mo ; sinon, on n'a pas besoin d'ex\u00e9cuter cette image.</p> <p>A noter que les certificats pr\u00e9vus pour les serveurs sont d\u00f4t\u00e9s d'un subjectAltName, comme cela semble \u00eatre requis pour Chromium.</p> <pre><code>#Image pour embarquer des clefs qui ont \u00e9t\u00e9 pr\u00e9g\u00e9n\u00e9res par le script keys.sh depuis l'\u0125\u00f4te\nFROM ubuntu:lunar\nLABEL uepal.name=\"keys\" uepal.version=\"0.0.2\"\nRUN usermod -L -s /usr/sbin/nologin -e 1 ubuntu\nENV LANG=C.UTF-8\nRUN mkdir /KEYS &amp;&amp; mkdir /KEYS/USAGE &amp;&amp; chmod -R 500 /KEYS &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; apt-get install -y ca-certificates &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists &amp;&amp; install -d /target_certs\nCOPY USAGE/* /KEYS/USAGE/\n#COPY USAGE/db_ca.x509 /usr/local/share/ca-certificates/db_ca.crt\n#COPY USAGE/extern_ca.x509 /usr/local/share/ca-certificates/extern_ca.crt\nCOPY USAGE/mail_ca.x509 /usr/local/share/ca-certificates/mail_ca.crt\nRUN chown root:root /usr/local/share/ca-certificates/* &amp;&amp; chmod 644 /usr/local/share/ca-certificates/*\nRUN update-ca-certificates &amp;&amp; cp -RL /etc/ssl/certs /dereferenced_certs\nWORKDIR /KEYS\nCMD [\"/bin/bash\",\"-c\",\"cp -LR /dereferenced_certs/* /target_certs/\"]\n#CMD [\"/bin/bash\",\"-c\", \"echo 'Hello KEYS'\"]\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/selfkeys.html#certificats-generes","title":"Certificats g\u00e9n\u00e9r\u00e9s","text":"<p>Les certificats g\u00e9n\u00e9r\u00e9s sont les suivants :</p> <ul> <li>db_ca : CA pour les liaisons DB</li> <li>extern_ca : CA pour le certificat interne g\u00e9n\u00e9r\u00e9 pour la liaison HTTPS interne</li> <li>mail_ca : CA pour les liaisons avec le serveur de mail de d\u00e9mo</li> <li>wildcard_ca : CA pour la g\u00e9n\u00e9ration du certificat de test</li> <li>civicrmdb : certificat pour le serveur de BD</li> <li>extern : certificat pour le serveur Apache</li> <li>mail : certificat pour le serveur mail de d\u00e9mo</li> <li>wildcard : certificat wildcard pour Traefik (ingress)</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html","title":"Container de test : opensmtpd et dovecot","text":"<p>La d\u00e9cision de simplification des infrastructures a fait que l'approche retenue n'est pas la sp\u00e9cialisation des mails au travers de containers d\u00e9di\u00e9s \u00e0 la r\u00e9ception et \u00e0 l'envoi, mais l'utilisation directe des containers httpd et cron pour r\u00e9aliser ces fonctions.</p> <p>Ceci entra\u00eene qu'il est bon de disposer d'un environnement de test o\u00f9 l'on peut simuler l'envoi et la r\u00e9ception des mails de mani\u00e8re approchante \u00e0 la r\u00e9alit\u00e9. Un container a \u00e9t\u00e9 r\u00e9alis\u00e9 \u00e0 ces fins, en utilisant supervisor, opensmtpd et dovecot :</p> <ul> <li>supervisor est un programme permet de g\u00e9rer le lancement de plusieurs programmes/services, en s'occupant en plus de journaliser les sorties (standard et d'erreur) des programmes. Il peut \u00eatre configur\u00e9 pour relancer les programmes s'ils s'arr\u00eatent</li> <li>opensmtpd est un MTA qui doit s'occuper de r\u00e9cup\u00e9rer les mails via le protocole SMTP, et de le transmettre ensuite au MDA</li> <li>dovecot est le MDA : on peut utiliser l'utilitaire <code>dovecot-lda</code> livr\u00e9 avec dovecot pour int\u00e9grer les mails entrants dans les boites mails des utilisateurs</li> <li>un client mail (MUA) est \u00e9galement n\u00e9cessaire : mutt a \u00e9t\u00e9 utilis\u00e9 \u00e0 cet effet, \u00e9tant donn\u00e9 qu'il est utilisable en interface texte, ce qui simplifie son int\u00e9gration dans le m\u00eame container.</li> </ul> <p>Quelques remarques :</p> <p>Danger</p> <ul> <li>le container cr\u00e9e n'a pas du tout vocation \u00e0 passer en production : il n'est pr\u00e9vu que pour de l'exp\u00e9rimentation : en particulier, les aspects de s\u00e9curit\u00e9 n'ont pas \u00e9t\u00e9 trait\u00e9s dans ce container, et les configurations n'ont pas \u00e9t\u00e9 affin\u00e9es : le but \u00e9tait d'avoir une maquette fonctionnelle mais sommaire</li> </ul> <ul> <li>un autre MTA a \u00e9t\u00e9 envisag\u00e9 : msmtpd, qui est int\u00e9gr\u00e9 dans les versions r\u00e9centes de msmtp (n\u00e9cessit\u00e9 de passer par la compilation du code source dans certaines distributions) : toutefois, l'analyse du code et de captures de trames a montr\u00e9 un probl\u00e8me de communication etnre mutt et msmtpd en SMTP, avec l'authentification PLAIN (https://www.rfc-editor.org/rfc/rfc4616) : la RFC pr\u00e9voit trois champs dans l'authentification :l'identit\u00e9 optionnelle d'autorisation, l'identit\u00e9 d'authentification et le mot de passe. Mutt envoie les trois champs, alors que msmtpd, dans le code source consult\u00e9, pr\u00e9voierait que le champ de l'identit\u00e9 d'autorisation devrait \u00eatre vide, ce qui emp\u00eache l'authentification d'\u00eatre valid\u00e9e par le serveur.</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#but","title":"But","text":"<p>Le but de l'exp\u00e9rimentation est de :</p> <ul> <li>disposer d'un compte SMTP pour l'envoi de mail, avec des identifiants distincts des identifiants IMAP</li> <li>disposer de deux comptes IMAP pour la r\u00e9ception des mails</li> <li>disposer du support TLS.</li> </ul> <p>Ces conditions refl\u00e8tent donc dans une certaine mesure les conditions r\u00e9elles, o\u00f9 l'on aura un provider de mail qui va fournir l'h\u00e9bergement du compte mail avec support IMAP et SMTP d'une part, et un provider d'envoi de mails de masse qui va supporter l'envoi de mails en masse pour le compte mail en question. Les mots de passe des deux providers seront donc diff\u00e9rents.</p> <p>Les noms des utilisateurs SMTP et IMAP, ainsi que les mots de passe, ont \u00e9t\u00e9 pass\u00e9 en variables d'environnement, si l'image venait \u00e0 \u00e9voluer et augmenter en qualit\u00e9 pour pouvoir \u00eatre int\u00e9gr\u00e9e dans des clusters de d\u00e9mo.</p> <p>Danger</p> <p>Comme indiqu\u00e9 plus haut, le but \u00e9tait de faire un maquettage sommaire, tout juste fonctionnelle. L'image obtenue n'est donc pas \u00e0 d\u00e9ployer (et surtout pas en production).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#dockerfile","title":"Dockerfile","text":"<pre><code>#Image pour disposer d'un petit environnement avec smtp et imap\n#Attention : il faut rester sur ubuntu:focal car il y a un bug dans la version embarqu\u00e9e dans les Ubuntu sup\u00e9rieures.\n#Attention : NE PAS INSTALLER EN PROD\nFROM ubuntu:focal\nLABEL uepal.name=\"uepal/test_msmtp_dovecot\" uepal.version=\"0.0.1\"\nENV LANG=C.UTF-8\nENV SMTP_USER_SECRET=smtpUsername SMTP_PASSWD_SECRET=smtpPassword IMAP_PASSWD_SECRET=imapPassword IMAP_USER_SECRET=imapUsername IMAP_USER2_SECRET=imapUsername2\nRUN apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; ln -fs /usr/share/zoneinfo/Europe/Paris /etc/localtime &amp;&amp; apt-get install -y tzdata &amp;&amp; dpkg-reconfigure --frontend noninteractive tzdata\nRUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y git build-essential wget curl mc nano less telnet autoconf automake libtool-bin gettext texinfo libgnutls28-dev gnutls-bin pkg-config net-tools tcpdump mutt opensmtpd\nRUN install -d /var/run/secrets\nCOPY secrets /var/run/secrets\n#RUN git clone https://git.marlam.de/git/msmtp.git /MSMTP\n#RUN cd /MSMTP &amp;&amp; autoreconf -i &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install\nRUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y supervisor supervisor-doc dovecot-core dovecot-imapd \nRUN mkdir /MUTT &amp;&amp; mkdir /KEYS\n#ADD server.key /KEYS\n#ADD server.crt /KEYS\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/mail.x509 /KEYS/server.crt\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/mail.pem /KEYS/server.key\n# RUN export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nRUN  groupadd -g 1000 vmail &amp;&amp; useradd -u 1000 -g 1000 vmail -d /var/vmail &amp;&amp; passwd -l vmail &amp;&amp; chown vmail:vmail /var/mail &amp;&amp; chown root:vmail /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod u+s /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod g+x /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod o-rwx /usr/lib/dovecot/dovecot-lda &amp;&amp; chmod 400 /KEYS/server.key\nADD smtpd_standalone.conf /etc/smtpd_standalone.conf\nADD standalone.conf /etc/dovecot/standalone.conf\nADD supervisor_opensmtpd.conf /etc/supervisor/conf.d/supervisor_opensmtpd.conf\nADD supervisor_dovecot.conf /etc/supervisor/conf.d/supervisor_dovecot.conf\nADD mutt* /MUTT/\nADD smtpd.sh /\nADD launcher.sh /\n#CMD [\"supervisord\",\"-c\",\"/etc/supervisor/supervisord.conf\",\"-n\"]\nCMD [\"/launcher.sh\"]\n#CMD [\"bash\"]\n</code></pre> <p>Le Dockerfile pr\u00e9sent\u00e9 au-dessus n'est pas minimal, car il pr\u00e9sente \u00e9galement le n\u00e9cessaire pour la compilation de msmtp. Le fichier de certificat est un certificat autosign\u00e9, qui contient du SubjectAltName pour le DNS localhost et l'IP 127.0.0.1. Un utilisateur et un groupe vmails ont \u00e9t\u00e9 rajout\u00e9s pour pouvoir utiliser smtpd avec un compte non root pour l'envoi des mails. De plus, le groupe vmail est positionn\u00e9 sur l'utilitaire dovecot-lda avec le bit SUID et l'owner root pour r\u00e9gler rapidement les probl\u00e8mes de droits \u00e9voqu\u00e9s dans la documentation de dovecot-lda (https://doc.dovecot.org/configuration_manual/protocols/lda/). Un autre type de solution aurait \u00e9t\u00e9 de passer par le protocole LMTP.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#supervisor","title":"Supervisor","text":"<p>La configuration de supervisor dans Ubuntu est relativement simple, car Ubuntu pr\u00e9voit d'inclure les fichiers de <code>/etc/supervisor/conf.d</code> dans sa configuration. En compl\u00e9ment du daemon supervisord, on dispose \u00e9galement de l'utilitaire supervisorctl, qui est tr\u00e8s pratique pour relire la configuration de supervisor et red\u00e9marrer un service.</p> <p>En ce qui concerne les fichiers ajout\u00e9s :</p> <ul> <li>d\u00e9marrage de dovecot :</li> </ul> <pre><code>[program:dovecot]\ncommand=/usr/sbin/dovecot -F -c /etc/dovecot/standalone.conf\nenvironment=IMAP_USER1=%(ENV_IMAP_USER1)s,IMAP_USER2=%(ENV_IMAP_USER2)s,IMAP_PASSWD=%(ENV_IMAP_PASSWD)s\n</code></pre> <p>La partie environnement n'est toutefois pas n\u00e9cessaire. En effet, supervisor passe par d\u00e9faut l'environnement aux processus qu'il contr\u00f4le. Il est toutefois possible de modifier l'environnement comme on le voit au-dessus (m\u00eame si ici, ces modifications ne servent en fait \u00e0 rien). Il est toutefois remarquable que l'environnement dans le processus Dovecot appara\u00eet comme vide dans le fichier <code>/proc/&lt;pid&gt;/environ</code> - ce qui a caus\u00e9 les recherches sur l'environnement lors du d\u00e9buggage.</p> <ul> <li>d\u00e9marrage de opensmtpd :</li> </ul> <pre><code>[program:smtpd]\ncommand=/smtpd.sh\n</code></pre> <ul> <li>Fichier smtpd.sh :</li> </ul> <pre><code>#!/bin/bash\nset -xev\necho -e \"${SMTP_USER}\\t`smtpctl encrypt ${SMTP_PASSWD}`\" &gt;/KEYS/smtp_passwd\necho -e \"@\\tvmail\" &gt;/KEYS/vusers\necho -e \"${IMAP_USER1}\" &gt;/KEYS/users\necho -e \"${IMAP_USER2}\" &gt;&gt;/KEYS/users\n\nexec /usr/sbin/smtpd -d -f /etc/smtpd_standalone.conf -v\n</code></pre> <p>Ce fichier montre une technique d'initialisation en passant par un script shell, qui va se terminer par une commande exec pour remplacer le shell par le dernier programme qui va \u00eatre utilis\u00e9. Cette m\u00e9thode est souvent utilis\u00e9e dans les fichiers de point d'entr\u00e9e des containers Docker.</p> <p>OpenSMTPD utilise des fichiers de tables, avec du format <code>clefTABvaleur</code>. Le fichier <code>/KEYS/smtp_passwd</code> est utilis\u00e9 pour le stockage des mots de passe reconnus ar OpenSMTPD ; il semblerait qu'il soit n\u00e9cessaire de passer par des fichiers pour pouvoir utiliser <code>smtpctl</code> pour effectuer le chiffrement du mot de passe, car OpenSMTPD ne semble pas accepter les mots de passe non chiffr\u00e9s dans une table directement \u00e9crite dans le fichier de configuration d'OpenSMTPD.</p> <p>Le fichier <code>/KEYS/vusers</code> est un fichier pour g\u00e9n\u00e9rer une liste d'alias, ou plut\u00f4t contient la correspondance entre adresse et mail et utilisateur virtuel (non syst\u00e8me) pour dovecot.</p> <p>Le fichier <code>/KEYS/users</code> n'est pas utilis\u00e9.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#opensmtpd","title":"OpenSMTPD","text":"<ul> <li>le passage par le code d'OpenSMTPD a \u00e9t\u00e9 \u00e9galement utile, notamment pour comprendre un probl\u00e8me de configuration li\u00e9 \u00e0 l'utilisation du compte root (code sp\u00e9cifique / limitations dans certains cas lorsque l'uid 0 est utilis\u00e9e)</li> <li>OpenSMTPD connait un probl\u00e8me au niveau du support SSL dans la Ubuntu 22.04, avec OpenSSL 3.0 : https://github.com/OpenSMTPD/OpenSMTPD/issues/1171 . Ce probl\u00e8me a n\u00e9cessit\u00e9 de repasser en Ubuntu 20.04 dans le cadre de cette exp\u00e9rimentation.</li> </ul> <pre><code>smtpuser = \"smtpuser\"\nsmtppass= \"smtppass\"\npki \"localpki\" cert \"/KEYS/server.crt\" key \"/KEYS/server.key\"\n#table passwd {$smtpuser=$smtppass}\ntable passwdt \"file:/KEYS/smtp_passwd\"\ntable vusers {imapuser1=vmail,imapuser2=vmail}\ntable users \"file:/KEYS/users\"\naction \"deliv\" mda \"/usr/lib/dovecot/dovecot-lda -c /etc/dovecot/standalone.conf -d %{rcpt.user}\" virtual &lt;vusers&gt; user vmail\n\nlisten on 0.0.0.0 pki \"localpki\" tls auth &lt;passwdt&gt;\nmatch auth from any for any action \"deliv\"\n</code></pre> <p>Les deux premi\u00e8res lignes servent \u00e0 d\u00e9finir des variables qui \u00e9taient pr\u00e9vues pour l'essai de mot de passe en dur qui est comment\u00e9.</p> <p>La table vusers utilise une variante du format autoris\u00e9, o\u00f9 on ne sp\u00e9cifie que la partie avant le nom de domaine de l'adresse mail.</p> <p>La directive listen permet d'\u00e9couter sur une socket (par d\u00e9faut port 25) en pr\u00e9cisant les clefs ssl pour le starttls et la table d'authentification \u00e0 utiliser (on notera les sup\u00e9rieurs et inf\u00e9rieurs qui entourent le nom de la table et qui font partie de la syntaxe).</p> <p>La directive match permet de d\u00e9finir comment un mail sera trait\u00e9 : en l'occurence un mail qui vient d'une source authentifi\u00e9e (dans les nouvelles versions <code>auth</code> devient <code>from auth</code>) sera trait\u00e9e par l'action nomm\u00e9e <code>deliv</code>.</p> <p>L'action <code>deliv</code> utilise la m\u00e9thode mda, de sorte \u00e0 ce qu'un programme d\u00e9fini en argument soit utilis\u00e9 pour faire transiter le mail. Le programme prend le mail sur son entr\u00e9e standard (STDIN). L'indication <code>%{rcpt.user}</code> correspond \u00e0 la partie avant le nom de domaine de l'adresse mail de destination. On utilise la table <code>vusers</code> pour faire la correspondance entre adresse et un utilisateur du syst\u00e8me (cela est n\u00e9cessaire au minimum pour cette m\u00e9thode de livraison). Enfin, on sp\u00e9cifie l'utilisateur qui sera utilis\u00e9 pour ex\u00e9cuter le programme de livraison du mail.</p> <p>Lors de l'exp\u00e9rimentation, on appr\u00e9cie particuli\u00e8rement l'utilitaire <code>smtpctl</code>, qui permet notamment d'activer les traces (dont <code>smtpctl trace all</code>), voir l'\u00e9tat des files (<code>smtpctl show queue</code>) et permet de replanifier imm\u00e9diatement l'envoi des mails (<code>smtpctl schedule all</code>).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#dovecot","title":"Dovecot","text":"<p>La configuration a \u00e9t\u00e9 tr\u00e8s largement reprise de https://github.com/dovecot/docker/blob/main/2.3.20/dovecot.conf</p> <ul> <li>/etc/dovecot/standalone.conf : </li> </ul> <pre><code>mail_debug=yes\nauth_debug=yes\ndebug_log_path=/tmp/dovecot_debug.log\nlog_path=/tmp/dovecot_log.log\ninfo_log_path=/tmp/dovecot_info.log\nmail_home=/var/mail/%Lu\nmail_location=sdbox:~/Mail\nmail_uid=1000\nmail_gid=1000\nfirst_valid_uid=1000\nlast_valid_uid=1000\ndisable_plaintext_auth=no\nprotocols = imap\nssl=yes\nssl_cert = &lt;/KEYS/server.crt\nssl_key = &lt;/KEYS/server.key\npassdb {\n  driver = static\n  args = password=%{env:IMAP_PASSWD}\n}\nnamespace {\n  inbox = yes\n  separator = /\n}\nlisten = *\nimport_environment = IMAP_USER1 IMAP_USER2 IMAP_PASSWD\n</code></pre> <p>Le param\u00e8tre <code>mail_home</code> indique le r\u00e9pertoire dans lequel sera stock\u00e9 les mails. Le format <code>%Lu</code> correspond au nom d'utilisateur en minuscule (L : transformation lowercase). Le param\u00e8tre mail_location sp\u00e9cifie le format et le stockage des mails. Le format sdbox est un format sp\u00e9cifique \u00e0 dovecot.</p> <p>Les uid et gid correspondent aux valeurs utilis\u00e9es pour l'acc\u00e8s aux mails.</p> <p>On autorise dans le cadre des tests l'utilisation de l'authentification sous forme de texte, et on ne force pas mais autorise l'utilisation du SSL.</p> <p>La section <code>passdb</code> permet d'utiliser un mot de passe statique qui sera reconnu pour les comptes ; on se r\u00e9f\u00e8re \u00e0 l'environnement pour r\u00e9cup\u00e9rer la valeur du mot de passe.</p> <p>En ce qui concerne l'espace de nom, il s'agit de r\u00e9glages qui d\u00e9pendent \u00e9galement du format de la bo\u00eete de mail.</p> <p>La directive import_environment permet de sp\u00e9cifier des variables d'environnement pass\u00e9es aux processus enfants.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/test_msmtp_dovecot.html#mutt","title":"Mutt","text":"<ul> <li>mutt_user1.sh : script pour le lancement de mutt</li> </ul> <pre><code>#!/bin/bash\nmutt -n -F /MUTT/muttrc_user1\n</code></pre> <p>Le param\u00e8tre <code>n</code> permet de ne pas utiliser la configuration syst\u00e8me, tandis que <code>F</code> sp\u00e9cifie le fichier de configuration \u00e0 utiliser, ce qui est particuli\u00e8rement arrangeant lorsqu'on veut utiliser plusieurs configuration depuis un m\u00eame compte utilisateur syst\u00e8me.</p> <ul> <li>muttrc_user1 : fichier de configuration pour Mutt</li> </ul> <pre><code>set smtp_url = \"smtp://${SMTP_USER}:${SMTP_PASSWD}@localhost:25\"\nset spoolfile = \"imaps://${IMAP_USER1}:${IMAP_PASSWD}@localhost:993/INBOX\"\nset mail_check = 60\nset realname = \"${IMAP_USER1}\"\nset from = \"${IMAP_USER1}@test.test\"\nset ssl_force_tls = yes\nset ssl_starttls = yes\nset ssl_ca_certificates_file = \"/KEYS/server.crt\"\n</code></pre> <p>Le fichier de configuration supporte l'utilisation des variables d'environnement, et la plupart des param\u00e8tres sont assez transparents. En ce qui concerne l'utilisation des ports non ssl, il convient de ne pas oublier le m\u00e9canisme STARTTLS pour passer sur une communication chiffr\u00e9e - ce qui est diff\u00e9rent d'une communication o\u00f9 le protocole applicatif utilise une sous-couche avec une session SSL.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/tools.html","title":"Tools : image des outils","text":"<p>L'image des outils est une sorte d'image g\u00e9n\u00e9rale, \u00e0 tout faire, non sp\u00e9cialis\u00e9e, qui sert de support pour les op\u00e9rations sp\u00e9cifiques (initialisation d'une instance, mise \u00e0 jour d'une instance, ex\u00e9cution de cron).</p> <pre><code>#Image avec les outils pour l'exploitation\nFROM uepal_test/composer_base\nLABEL uepal.name=\"tools\" uepal.version=\"0.0.2\"\n#ARG MYSQLVERSION=8.0.28-0ubuntu4\n#ENV MYSQLVERSIONENV=${MYSQLVERSION}\n#RUN echo \"MySQLVERSION : \"${MYSQLVERSION}\nENV DBSECRET=\"dbsecret\" DBROOTSECRET=\"dbrootsecret\" DRUPAL_ADMIN_USER_SECRET=\"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET=\"drupal_password\"\nRUN mkdir /tools &amp;&amp; mkdir /exec &amp;&amp; touch /usr/share/man/man5/maildir.maildrop.5.gz &amp;&amp; touch /usr/share/man/man7/maildirquota.maildrop.7.gz &amp;&amp; touch /usr/share/man/man1/makedat.1.gz &amp;&amp; apt-get update &amp;&amp; apt-get full-upgrade -y &amp;&amp; export DEBIAN_FRONTEND=noninteractive &amp;&amp; apt-get install -y gnupg mysql-client sudo nano openssh-client mc mysql-server maildrop rsync lftp openssh-client dnsutils &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY exec.sh /exec/exec.sh\nCOPY config_mysqld.cnf /etc/mysql/mysql.conf.d/\nWORKDIR /tools\nCOPY --from=uepal_test/composer_files /app /app/\nRUN chmod 550 /app/vendor/bin/* &amp;&amp; ln -s /app/vendor/bin/drush /usr/local/bin/drush &amp;&amp; wget https://download.civicrm.org/cv/cv.phar -O /usr/local/bin/cv &amp;&amp; chmod 755 /usr/local/bin/cv &amp;&amp; chmod 755 /exec/exec.sh &amp;&amp; maildirmake /maildir &amp;&amp; install -d /var/run/secrets &amp;&amp; chmod 555 /etc/mysql/mysql.conf.d/config_mysqld.cnf\nCOPY secrets /var/run/secrets/\nRUN chown -R root:root /var/run/secrets &amp;&amp; find /var/run/secrets -type f -exec chmod 400 '{}' \\; &amp;&amp; find /var/run/secrets -type d -exec chmod 500 '{}' \\;\nWORKDIR /app\nVOLUME /var/lib/mysql /app/web/sites /maildir /app/private\nCMD [\"/exec/exec.sh\"]\n</code></pre> <p>Cette image n'est pas pr\u00e9vue pour \u00eatre \"en contact direct\" avec des connexions entrantes, ni une utilisation comme serveur. Elle n'est en aucun cas \"durcie\".</p> <p>Les outils sont install\u00e9s de plusieurs mani\u00e8res :  * packages Ubuntu (mysql, maildrop, rsync, lftp, gnupg, nano...) * packages Composer (dont drupal-console et drush) * t\u00e9l\u00e9chargement direct (cv)</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/tools.html#variables-denvironnement","title":"Variables d'environnement","text":"<p>Certaines variables d'environnement sont pr\u00e9sentes, car elles peuvent dans certains cas pr\u00e9senter un int\u00e9r\u00eat. Toutefois, ce container n'a pas vocation \u00e0 faire quelque chose d'utile de lui-m\u00eame. Les variables pourront donc surtout aider un administrateur qui utilise l'image pour analyser un probl\u00e8me.</p> Variable Signification Default Docker DBSECRET secret du mot de passe du compte d'exploitation de la BD \"dbsecret\" DBROOTSECRET secret du mot de passe root de la BD \"dbrootsecret\" DRUPAL_ADMIN_USER_SECRET secret du username admin de drupal \"drupal_user\" DRUPAL_ADMIN_PASSWORD_SECRET secret du mot de passe admin de drupal \"drupal_password\""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/tools_debug.html","title":"Tools_debug : image des tools avec Xdebug","text":"<p>Cette image, pr\u00e9vue uniquement pour utilisation via Docker, rajoute uniquement un xdebug configur\u00e9 en autostart pour aller attaquer l'IDE dans l'h\u00f4te.</p> <pre><code>#Extension de l'image des outils avec xdebug\nFROM uepal_test/tools\nLABEL uepal.name=\"tools_debug\" uepal.version=\"0.0.2\"\nRUN  apt-get update &amp;&amp; apt-get install php8.1-xdebug &amp;&amp; rm -rf /var/lib/apt/lists\nCOPY 99-xdebug.ini /etc/php/8.1/apache2/conf.d/\nCOPY 99-xdebug.ini /etc/php/8.1/cli/conf.d/\nCMD [\"sh\",\"-c\",\"while true;do sleep 10;done\"]\n</code></pre> <pre><code>[xdebug]\nxdebug.log=/tmp/xdebug.log\nxdebug.log_level=7\nxdebug.mode=debug\nxdebug.client_port=9003\nxdebug.client_host=host.docker.internal\nxdebug.start_with_request=yes\nxdebug.discover_client_host=false\nxdebug.idekey=phpstorm\n\nxdebug.remote_enable=On\nxdebug.remote_host=host.docker.internal\nxdebug.remote_port=9003\nxdebug.remote_autostart=On\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/traefik_docker.html","title":"Traefik_docker : image pour simuler un contr\u00f4leur ingress","text":"<p>Le but de l'image traefik_docker est de simuler un ingress avec certificat wildcard en entr\u00e9e, et d'envoyer le trafic vers un autre container qui tourne au sein d'un m\u00eame docker-compose.</p> <pre><code>#Image faisant office d'ingress controller pour simuler (dans une certaine mesure) sous Docker ce qu'on met dans K8S via helm\nFROM traefik\nLABEL uepal.name=\"traefik_docker\" uepal.version=\"0.0.1\"\nENV SERVERNAME=civicrm.test\nRUN mkdir /CA &amp;&amp; mkdir /etc/traefik &amp;&amp; mkdir /etc/traefik/conf.d &amp;&amp; mkdir /KEYS\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/extern_ca.x509 /CA/extern_ca.x509\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/wildcard.x509 /KEYS/wildcard.x509\nCOPY --from=uepal_test/selfkeys /KEYS/USAGE/wildcard.pem /KEYS/wildcard.pem\nCOPY traefik.yml /etc/traefik/traefik.yml\nCOPY traefik_dynamic.yml /etc/traefik/conf.d/traefik_dynamic.yml\nRUN chown root:root -R /KEYS /CA /etc/traefik &amp;&amp; chmod 500 /KEYS /CA /etc/traefik /etc/traefik/conf.d &amp;&amp; chmod 400 /CA/* /etc/traefik/traefik.yml /etc/traefik/conf.d/* /KEYS/*\nCMD [\"traefik\",\"--configfile=/etc/traefik/traefik.yml\"]\n</code></pre> <p>La configuration de Traefik se fait dans le cas pr\u00e9sent via trois m\u00e9canismes :  * la ligne de commande : l'argument configfile, qui fait que les autres arguments de la ligne de commande seront ignor\u00e9s * le fichier de configuration mentionn\u00e9 : c'est le fichier de configuratino statique, qui va contenir un appel au provider pour le fichier \"dynamique\" (surtout un fichier o\u00f9 l'on pourra placer des variables d'environnement) * le fichier de configuration dynamique</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/traefik_docker.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Description Valeur par d\u00e9faut SERVERNAME nom externe du serveur civicrm.test"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/traefik_docker.html#configuration-statique","title":"Configuration statique","text":"<p><pre><code>entryPoints:\n  websecure:\n    address: \":443\"\n    http:\n      tls: {}\n#  traefik:\n#    address: \":8080\"\nproviders:\n  file:\n   directory: \"/etc/traefik/conf.d\"\naccessLog: {}\nlog:\n  level: DEBUG\napi:\n  dashboard: true\n  insecure: true\n</code></pre> Cette image ouvre le port 443. Le port 8080 qui est comment\u00e9 ici est quand m\u00eame ouvert surtout \u00e0 cause du <code>insecure</code> \u00e0 <code>true</code>.</p> <p>On force en revanche l'utilisation du TLS pour le port 443 du fait de la pr\u00e9sence de la section TLS dans la configuration. On utilisera donc les certificats install\u00e9s \"par d\u00e9faut\".</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/traefik_docker.html#configuration-dynamique","title":"Configuration dynamique","text":"<p><pre><code>http:\n  routers:\n    myrouter:\n      entryPoints:\n        - \"websecure\"\n      rule: \"Host(`{{ env \"SERVERNAME\" | trimAll \"\\\"\" }}`)\"\n      service: civihttpdservice\n      tls:\n  services:\n    civihttpdservice:\n      loadBalancer:\n        serversTransport: selfsigned\n        servers:\n          - url: \"https://{{ env \"SERVERNAME\" | trimAll \"\\\"\" }}/\"\n  serversTransports:\n    selfsigned:\n      disableHTTP2: true\n      maxIdleConnsPerHost: 0\n      serverName: \"{{ env \"SERVERNAME\" | trimAll \"\\\"\" }}\"\n      rootCAs:\n        - /CA/extern_ca.x509\n      forwardingTimeouts:\n        dialTimeout: \"60s\"\n        responseHeaderTimeout: 0\n        readIdleTimeout: 0\n        idleConnTimeout: \"1s\"\ntls:\n  certificates:\n    - certFile: /KEYS/wildcard.x509\n      keyFile: /KEYS/wildcard.pem\n</code></pre> La configuration sp\u00e9cifie expr\u00e8s un dialTimeout \u00e9lev\u00e9 en raison du dimensionnement du serveur Apache qui traite les requ\u00eates derri\u00e8re (existence de retransmissions TCP SYN). Le HTTP2 est d\u00e9sactiv\u00e9 car il n'est pas activ\u00e9 avec Apache (utilisation de mpm_prefork pour le moment). On notera enfin que cette configuration v\u00e9rifie quand m\u00eame le CA pour se connecter au serveur web, et v\u00e9rifie en m\u00eame temps la pr\u00e9sence du nom de serveur dans les sujets alternatifs du certificats. Le certificat utilis\u00e9 par d\u00e9faut est d\u00e9fini dans la section tls.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/update.html","title":"Image update","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/update.html#description","title":"Description","text":"<p>Cette image est pr\u00e9vue pour finaliser une mise \u00e0 jour d'une instance. La mise \u00e0 jour des fichiers de code et des fichiers de traduction se fait certes via composer, mais il y a lieu ensuite d'effectuer les mises \u00e0 jour en particulier pour le niveau BD (et \u00e9ventuellement effectuer des manipulations au niveau des fichiers dans les volumes de l'installation, s'il y a lieu).</p> <p>Cette image descend des tools, et elle est pr\u00e9vue pour monter la base de donn\u00e9es. Toutefois, une modification de l'owner des fichiers a \u00e9t\u00e9 n\u00e9cessaire, car une modification analogue est effectu\u00e9e dans l'image ubuntu/mysql, afin que l'owner des fichiers soit bien l'utilisateur mysql, mais avec l'UID de l'utilisateur mysql de l'image. Cette modification est \"d\u00e9faite\" par l'initilisation du container ubuntu/mysql.</p> <p>L'image effectue plusieurs rafra\u00eechissements de cache, afin de chercher \u00e0 tenir compte des modifications qui auraient pu avoir lieu \u00e0 l'\u00e9tape juste avant du script.</p> <p>Il est \u00e0 noter que pour les traductions, il faut, au niveau de Drupal, importer le fichier de traduction, tandis que le fichier n\u00e9cessiterait simplement d'\u00eatre remplac\u00e9 au niveau de CiviCRM, selon le fonctionnement de l'extension de mise \u00e0 jour existante https://github.com/cividesk/com.cividesk.l10n.update/.</p> <p>Le code de cette image recopie une partie du code de l'init. Il faudra donc faire \u00e9voluer les deux images de concert.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/DOCKER/update.html#variables-denvironnement","title":"Variables d'environnement","text":"Variable Signification Default Docker DBHOST Serveur DB civicrmdb SERVERNAME Nom externe du serveur civicrm.test"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/index.html","title":"Kubernetes","text":"<ul> <li>Maquettage</li> <li>Ressources utiles</li> <li>Chart Helm</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/maquettage.html","title":"Kubernetes : maquettage","text":"<p>Kubernetes est l'environnement cible pour les environnements Civiparoisse. En effet, Kubernetes permet de g\u00e9rer un cluster de machines pour pouvoir ex\u00e9cuter des conteneurs sur le cluster.</p> <p>Il va y avoir en fait deux clusters :</p> <ul> <li>un cluster que l'on pourrait assimiler \u00e0 un cluster de calcul, qui va disposer des ressources mat\u00e9rielles pour ex\u00e9cuter les charge</li> <li>un cluster de stockage</li> </ul> <p>Les deux clusters doivent \u00eatre interconnect\u00e9s avec des ressources r\u00e9seau ad\u00e9quates.</p> <p>Le travail principal avec Kubernetes consiste \u00e0 d\u00e9finir de mani\u00e8re d\u00e9clarative, via des fichiers appel\u00e9s manifestes, \u00e9crits en JSON ou YAML, des ressources qui vont servir \u00e0 configurer des charges de travail \u00e0 ex\u00e9cuter.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/maquettage.html#minikube","title":"Minikube","text":"<p>En pratique, l'environnement utilis\u00e9 pour le d\u00e9veloppement est Minikube, qui est un environnement Kubernetes packag\u00e9, pr\u00e9vu pour apprendre. Avec Minikube, on est limit\u00e9 \u00e0 un cluster Kubernetes \u00e0 un seul noeud, mais on dispose d'une \u00e9mulation simple d'un syst\u00e8me de stockage persistant qui va stocker les donn\u00e9es sur le disque dur du syst\u00e8me (default-storageclass et storage-provisionner).</p> <p>*** Remarque sur le storage-provisionner : ce provisionneur est un provisionneur tr\u00e8s simple, qui va utiliser l'espace dans /var/hostpath-provisionner du container Docker de Minikube. Cet espace est g\u00e9r\u00e9 \u00e0 l'aide du namespace et du nom de claim. Lorsque le PersistentVolumeClaim est supprim\u00e9, les donn\u00e9es ne seront pas forc\u00e9ment (et plut\u00f4t probablement pas) supprim\u00e9es. De ce fait, il convient de les effacer manuellement pour ne pas polluer une \u00e9ventuelle r\u00e9installation ult\u00e9rieure. ***</p> <p>Minikube dispose de plusieurs modes de fonctionnement, dont le mode usuel, \u00e0 savoir Docker in Docker, ce qui veut dire qu'il faut rendre les images disponibles au Docker de Minikube pour pouvoir les utiliser - c'est relativement simple puisque Minikube a pr\u00e9vu la commande n\u00e9cessaire pour attaquer le Docker de minikube gr\u00e2ce \u00e0 la configuration de l'environnement : <code>eval $(minikube -p minikube docker-env)</code>.</p> <p>L'environnement de Minikube propose enfin aussi un dashboard dans un environnement web, ce qui est utile pour d\u00e9buter, pour les d\u00e9monstrations, et le d\u00e9buggage. N\u00e9anmoins, il convient de se familiariser \u00e9galement avec kubectl, kubectl \u00e9tant une outil qui sera utilis\u00e9 dans la plupart des environnements.</p> <p>L'environnement de production ne sera \u00e9videmment pas Minikube, mais sera soit un environnement de cloud public, soit un environnement de cloud h\u00e9berg\u00e9 ; dans tous les cas, il devra \u00eatre manag\u00e9 par des ressources tierces.</p> <p>Quelques commandes utiles : </p> <ul> <li> <p><code>minikube start</code> : d\u00e9marre le cluster par d\u00e9faut</p> </li> <li> <p><code>minikube stop</code>: arr\u00eate le cluster par d\u00e9faut</p> </li> <li> <p><code>minikube ip</code>: indique l'IP de cluster de minikube : utile pour faire la r\u00e9solution de nom dans /etc/hosts pour faire pointer les noms vers le cluster minikube depuis l'h\u00f4te</p> </li> <li> <p><code>minikube ssh</code>: acc\u00e8s SSH au container de minikube</p> </li> <li> <p><code>eval $(minikube docker-env)</code> : configuration du terminal courant pour se connecter au daemon docker de minikube (pour builder et puller les images par exemple)</p> </li> </ul> <p>*** Attention : pour le moment, il est n\u00e9cessaire de builder les images dans le docker de minikube pour les rendre disponibles pour Minikube. De m\u00eame, il est n\u00e9cessaire de faire attention \u00e0 la pull policy, et id\u00e9alement de puller soi-m\u00eame les images dans le docker de minikube, afin de les rendre utilisables par Minikube ***</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/maquettage.html#principe-de-fonctionnement-dacheminement-des-communications","title":"Principe de fonctionnement d'acheminement des communications","text":"<p>Les connexions entrantes sont dirig\u00e9es vers un point d'entr\u00e9e du cluster (ex : via les enregistrements DNS). La communication est \u00e9tablie avec le contr\u00f4lleur ingress (Traefik). Traefik est configur\u00e9 pour utiliser un certificat wildcard qui sera utilis\u00e9 pour tout le trafic web entrant. Traefik utilise ensuite le nom de host pour s\u00e9lectionner le service cible. Une liaison HTTPS est ensuite \u00e9tablie entre Traefik et le service ; les requ\u00eates en r\u00e9sultant contiennent des headers suppl\u00e9mentaires rendant compte du forwarding (et donc de la source originelle du trafic).</p> <p>On a un environnement \"mod\u00e8le\" qui va \u00eatre utilis\u00e9 pour d\u00e9ployer chaque environnement de paroisse, et qui va tirer parti des images g\u00e9n\u00e9r\u00e9es au niveau de Docker. Cet environnement mod\u00e8le est packag\u00e9 gr\u00e2ce \u00e0 Helm (https://helm.sh/).</p> <p></p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/maquettage.html#recuperation-des-identifiants-drupal-apres-installation","title":"R\u00e9cup\u00e9ration des identifiants Drupal apr\u00e8s installation","text":"<p>Il est n\u00e9cessaire d'aller r\u00e9cup\u00e9rer les valeurs dans les secrets :  <pre><code>kubectl get secrets secret -n helmtls -o json\n</code></pre></p> <p>Les valeurs qui sont indiqu\u00e9es sont encod\u00e9es en base64. Il convient donc de les d\u00e9coder avec des commandes telles que :</p> <p><pre><code>echo \"valeur\"|openssl base64 -a -d -in - -out -; echo \"\"\n</code></pre> (Le deuxi\u00e8me echo est pr\u00e9sent pour ajouter une ligne vide et faciliter les copier-coller de la sortie).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/ressources.html","title":"Ressources utiles","text":"<p>Petite liste avec quelques ressources utiles :</p> <ul> <li>Concepts Kubernetes : https://kubernetes.io/docs/concepts/ : documentation des concepts tr\u00e8s int\u00e9ressante et n\u00e9cessaire pour \u00e9crire les manifestes</li> <li>Design Patterns (OpenShift): https://www.redhat.com/en/resources/oreilly-kubernetes-patterns-cloud-native-apps : \u00e9crit par un employ\u00e9 de redhat, livre Oreilly tr\u00e8s int\u00e9ressant avec des explications d\u00e9taill\u00e9es sur les fondamentaux et les concepts plus \u00e9volu\u00e9s des architectures K8S. Un livre \u00e0 garder sous la main.</li> <li>Design Patterns (Azure) : https://docs.microsoft.com/en-us/azure/architecture/patterns/</li> <li>Azure : ebook kubernetes (dont un O'Reilly) : https://azure.microsoft.com/en-us/resources/kubernetes-ebook-collection/</li> <li>K8S Operators : https://www.redhat.com/en/resources/oreilly-kubernetes-operators-automation-ebook</li> <li>K8S Storage for dummies : https://www.redhat.com/en/resources/storage-patterns-kubernetes-dummies-ebook</li> <li>Documentation installation nginx-ingress de F5 : https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/</li> <li>Ebooks chez Vmware Tanzu : https://tanzu.vmware.com/content/ebooks : dont des livres O'Reilly</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/index.html","title":"Chart Helm","text":"<ul> <li>Description g\u00e9n\u00e9rale</li> <li>DB et DB Router</li> <li>Serveur web interne</li> <li>Cron</li> <li>Volumes</li> <li>Secrets</li> <li>R\u00e9servations</li> <li>Serveur mail de d\u00e9mo</li> <li>Outils</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/cron.html","title":"Cron","text":"<p>L'impl\u00e9mentation de l'appel \u00e0 cron utilise le cronjob. Le cron est synchronis\u00e9 via le container d'initialisation sur la disponibilit\u00e9 du service de DB. On se rappelera que le service DB n'est activ\u00e9 que du moment o\u00f9 la BD elle-m\u00eame et les fichiers sont initialis\u00e9s via le container d'init de <code>stateful_set_db</code>. De plus, le container cron int\u00e8gre au d\u00e9but de son code d'ex\u00e9cution une routine d'attente pour \u00eatre certain que la BD est disponible (via  <code>mysqladmin ping</code>).</p> <p>Le pod du cron ex\u00e9cute deux containers : le container de cron proprement dit, et le container de dbrouter, qui est un sidecar pour r\u00e9aliser la connexion r\u00e9seau chiffr\u00e9e \u00e0 la BD. La particularit\u00e9 du pod de cron est que pour que le pod se termine correctement, les deux containers doivent non seulement sortir, mais \u00e9galement sortir sans erreur (code de retour 0). Ceci implique qu'il faut arr\u00eater le container de proxy db (sidecar d'acc\u00e8s \u00e0 la BD), et pour ce faire, il faut pouvoir le tuer via les signaux, d'o\u00f9 le <code>shareProcessNamespace: true</code>.</p> <p>La suspension ou non du cron peut \u00eatre r\u00e9gl\u00e9e via la valeur ad\u00e9quate <code>.Values.cron.suspend</code>.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/db_dbrouter.html","title":"DB et DB Router","text":"<p>La BD est h\u00e9berg\u00e9e dans un stateful set. La configuration de la BD est stock\u00e9e dans une config map qui r\u00e9plique la configuration du container Docker.</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-db-server\n  namespace: {{ .Release.Namespace }}\ndata:\n  mysqldcnf: |\n    [mysqld]\n    performance_schema = 0\n    require-secure-transport=ON\n    ssl_ca= {{ .Chart.Annotations.dbserversslca }}\n    ssl_cert= {{ .Chart.Annotations.dbserversslcert }}\n    ssl_key= {{ .Chart.Annotations.dbserversslkey }}\n    sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\n    skip-log-bin\n    tls_version=TLSv1.3\n    transaction_isolation=\"READ-COMMITTED\"\n</code></pre> <p>On force dans cette configuration l'utilisation d'un transport s\u00e9curis\u00e9 : soit la socket Unix, soit une communication chiffr\u00e9e via le r\u00e9seau. La communication chiffr\u00e9e est difficile \u00e0 configurer au niveau PHP, si bien qu'il est bien plus commode d'utiliser <code>mysql-router</code> en tant que sidecar pour r\u00e9aliser ces communications.</p> <p>Une cons\u00e9quence de cette architecture est qu'en PHP, si on configure correctement le chemin par d\u00e9faut des sockets, on peut utiliser le nom sp\u00e9cial <code>localhost</code> pour passer par la socket Unix.</p> <p>Cette configuration a \u00e9t\u00e9 au bout du compte pr\u00e9f\u00e9r\u00e9e \u00e0 une utilisation de tunnels socat, pour ne pas se priver de la possibilit\u00e9 de migrer la base de donn\u00e9es sur un <code>MySQL as A Service</code> si au bout du compte cette solution s'av\u00e8rerait financi\u00e8rement plus int\u00e9ressante.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/db_dbrouter.html#initialisation-et-update","title":"Initialisation et Update","text":"<p>Un container d'initialisation est charg\u00e9 d'initialiser l'ensemble des ressources (fichiers sp\u00e9cifiques au site et base de donn\u00e9es). La mise \u00e0 jour est effectu\u00e9e par un container d'initialisation suppl\u00e9mentaire.</p> <p>Il est \u00e0 noter que ce stateful set doit \u00eatre op\u00e9rationnel pour que les autres \u00e9l\u00e9ments puissent s'activer (synchronisation via containers d'initialisation).</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/db_dbrouter.html#configuration-bd","title":"Configuration BD","text":"<p>Selon la documentation de MySQL https://dev.mysql.com/doc/refman/8.0/en/memory-use.html, MySQL est pr\u00e9vu pour tenir dans environ 512M de RAM. Ceci est confirm\u00e9 en pratique par l'utilisation du performance_schema :</p> <pre><code>mysql&gt; SELECT SUBSTRING_INDEX(event_name,'/',2) AS\n    -&gt;        code_area, FORMAT_BYTES(SUM(current_alloc))\n    -&gt;        AS current_alloc\n    -&gt;        FROM sys.x$memory_global_by_current_bytes\n    -&gt;        GROUP BY SUBSTRING_INDEX(event_name,'/',2)\n    -&gt;        ORDER BY SUM(current_alloc) DESC;\n+---------------------------+---------------+\n| code_area                 | current_alloc |\n+---------------------------+---------------+\n| memory/performance_schema | 214.94 MiB    |\n| memory/innodb             | 196.09 MiB    |\n| memory/sql                | 9.39 MiB      |\n| memory/mysys              | 8.58 MiB      |\n| memory/temptable          | 1.00 MiB      |\n| memory/mysqld_openssl     | 808.83 KiB    |\n| memory/mysqlx             | 3.38 KiB      |\n| memory/vio                | 1.16 KiB      |\n| memory/myisam             |  728 bytes    |\n| memory/csv                |  120 bytes    |\n| memory/blackhole          |  120 bytes    |\n+---------------------------+---------------+\n11 rows in set (0.02 sec)\nmysql&gt; select * from sys.memory_global_total;\n+-----------------+\n| total_allocated |\n+-----------------+\n| 448.20 MiB      |\n+-----------------+\n1 row in set (0.01 sec)\n</code></pre> <pre><code>root@b64de810e1b6:/# ps -ua\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0   4140  3368 pts/0    Ss   13:45   0:00 bash\nmysql         12  1.1 10.0 2228664 389164 pts/0  Sl+  13:45   0:02 mysqld\nroot         155  0.0  0.0   4136  3392 pts/1    Ss   13:46   0:00 bash\nroot         226  0.0  0.0   6420  1600 pts/1    R+   13:49   0:00 ps -ua\n</code></pre> <p>On constate en particulier l'utilisation de 215MB de ram pour performance_schema, alors que cette partie de la BD ne va pas r\u00e9ellement \u00eatre utilis\u00e9e. Du coup, il est envisageable de d\u00e9sactiver performance_schema. Apr\u00e8s d\u00e9sactivation, on ne peut plus utiliser la requ\u00eate SQL, mais on peut continuer \u00e0 utiliser <code>ps -ua</code> :</p> <pre><code>mysql&gt; SELECT SUBSTRING_INDEX(event_name,'/',2) AS\n    -&gt;        code_area, FORMAT_BYTES(SUM(current_alloc))\n    -&gt;        AS current_alloc\n    -&gt;        FROM sys.x$memory_global_by_current_bytes\n    -&gt;        GROUP BY SUBSTRING_INDEX(event_name,'/',2)\n    -&gt;        ORDER BY SUM(current_alloc) DESC;\nEmpty set (0.01 sec)\nmysql&gt; select * from sys.memory_global_total;\n+-----------------+\n| total_allocated |\n+-----------------+\n| NULL            |\n+-----------------+\n1 row in set (0.02 sec)\n</code></pre> <p><pre><code>root@b64de810e1b6:/etc/mysql/conf.d# ps -ua\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0   4140  3368 pts/0    Ss   13:45   0:00 bash\nroot         155  0.0  0.0   4136  3400 pts/1    Ss   13:46   0:00 bash\nmysql        461  2.5  4.0 1940420 156368 pts/0  Sl+  13:52   0:01 mysqld\nroot         545  0.0  0.0   6420  1640 pts/1    R+   13:52   0:00 ps -ua\n</code></pre> Comme j'ai fait les op\u00e9rations dans un m\u00eame container, on peut voir que plus de la moiti\u00e9 de la RAM n'est plus utilis\u00e9e apr\u00e8s avoir mis <code>performance_schema = 0</code>.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/db_dbrouter.html#configuration-de-db-router","title":"Configuration de DB Router","text":"<p>La configuration de DB Router (container sidecar qui ex\u00e9cute <code>mysql-router</code> )est pour le moment int\u00e9gr\u00e9e directement dans l'image Docker, avec le nom <code>civicrmdb</code> en dur. Le fichier de certificat est rendu disponible via montage sur le fichier d\u00e9sign\u00e9 dans la configuration. En cas de passage sur du <code>MySQL As A Service</code>, on pourra simplement mettre le fichier dans une config-map, et injecter le bon nom d'h\u00f4te lors de la cr\u00e9ation de l'instance, via Helm.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/description_generale.html","title":"Chart Helm: description g\u00e9n\u00e9rale","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/description_generale.html#helm","title":"Helm","text":"<p>Helm est un syst\u00e8me de packaging pour Kubernetes. L'int\u00e9r\u00eat de Helm est qu'il permet de pr\u00e9parer des mod\u00e8les de d\u00e9ploiement d'application, dans un package appel\u00e9 \"chart\". En pratique, il permet notamment d'avoir des mod\u00e8les (templates) pour d\u00e9ployer des ressources Kubernetes, et permet d'injecter des valeurs dans ces ressources. Ces valeurs peuvent \u00eatre par exemple pr\u00e9cis\u00e9es dans des fichiers de valeurs, ou \u00eatre calcul\u00e9es depuis des commandes indiqu\u00e9es dans les fichiers, ou m\u00eame \u00eatre r\u00e9cup\u00e9r\u00e9es depuis un cluster Kubernetes (par exemple des clefs de chiffrement).</p> <p>Helm constitue donc un outil essentiel pour packager un environnement de paroisse.</p> <p>L'installation de Helm se fait assez simplement en r\u00e9cup\u00e9rant l'archive Helm depuis https://github.com/helm/helm/releases, en v\u00e9rifiant la somme de contr\u00f4le, en d\u00e9compressant l'archive, et en mettant Helm a un endroit accessible depuis le path (avec les droits d'ex\u00e9cution).</p> <p>Quelques commandes utiles : </p> <ul> <li> <p><code>helm install --create-namespace -n helmtls helmciviparoisse .</code> : depuis le package Helm de civiparoisse (le <code>.</code>), installer une release (ici nomm\u00e9e <code>helmciviparoisse</code>) dans un namespace cr\u00e9e pour l'occasion (ici <code>helmtls</code>), en utilisant les valeurs par d\u00e9faut</p> </li> <li> <p><code>helm uninstall -n helmtls helmciviparoisse</code>: d\u00e9sinstaller les ressources de la release <code>helmciviparoisse</code> dans le namespace <code>helmtls</code></p> </li> <li> <p><code>helm list -n helmtls</code> : r\u00e9cup\u00e9rer les noms de releases d'un namespace (ici <code>helmtls</code>)</p> </li> </ul> <p>** Attention : pour le moment, il faut builder les images uepal_test dans l'environnement docker de Minikube. De plus, il faut puller manuellement l'image busybox,ubuntu/apache2, ubuntu/mysql, \u00e0 cause des interactions avec le tag latest et la pull Policy mise \u00e0 none dans le package helm **</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/description_generale.html#description-des-types-dobjets-utilises-dans-le-chart-helm","title":"Description des types d'objets utilis\u00e9s dans le chart Helm","text":"<p>Il s'agit ici de d\u00e9finir une liste des types d'objets avec une br\u00e8ve description ; on se r\u00e9f\u00e8rera bien entendu \u00e0 la documentation Kubernetes (https://kubernetes.io/fr/docs/concepts/) et Nginx (https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/) pour des explications compl\u00e8tes.</p> <p>On va trouver des objets de bas niveau, qui sont des objets de base, qui vont \u00eatre employ\u00e9s et g\u00e9r\u00e9s implicitement par les objets de plus haut niveau, dont notamment :</p> <ul> <li> <p>Pod : le pod est un environnement d'ex\u00e9cution qui peut \u00eatre partag\u00e9 par un ou plusieurs containers. Les containers du pod auront tous acc\u00e8s au r\u00e9seau entre eux via le loopback (127.0.0.1), et ont un espace m\u00e9moire partag\u00e9. Outre les containers qui constituent la charge de travail pricipale du pod, on peut trouver des containers d'initialisation, qui sont lanc\u00e9s les uns apr\u00e8s les autres pour initialiser l'environnement du pod.</p> </li> <li> <p>ReplicaSet : un replicaSet se charge de maintenir actif un certain nombre de ressources de Pod bas\u00e9s sur un m\u00eame mod\u00e8le. Dans le cas de Civiparoisse, le passage par le ReplicaSet est plut\u00f4t anecdotique, dans la mesure o\u00f9 l'on ne maintiendra qu'un seul pod pour chaque t\u00e2che. Toutefois, le replicaSet est utilis\u00e9 indirectement par les d\u00e9ploiements.</p> </li> <li> <p>Namespace : le namespace est l'espace de nom, qui va permettre de regrouper les objets sp\u00e9cifiques \u00e0 une m\u00eame application (ici, un environnement Civiparoisse). Le namespace sera cr\u00e9e lors du d\u00e9ploiement du package Helm, via une option de la ligne de commande. De ce fait, on ne trouvera pas explicitement de d\u00e9finition du namespace.</p> </li> </ul> <p>En ce qui concerne les types d'objets explicitement d\u00e9clar\u00e9s, on retrouve : </p> <ul> <li> <p>PersistentVolumeClaim : cette ressource permet de d\u00e9finir un volume de stockage que l'on veut obtenir aupr\u00e8s d'un fournisseur (classe de stockage), avec des propri\u00e9t\u00e9s particuli\u00e8res (nom, taille du stockage, type d'acc\u00e8s...)</p> </li> <li> <p>ConfigMap : cette ressource permet de d\u00e9finir des couples clef-valeur qui vont ensuite \u00eatre rendus disponibles sous forme de variables d'environnement ou de montage de fichiers dans le conteneur. Ces objets ne sont pas pr\u00e9vus pour contenir des informations sensibles (mot de passes ou clefs par exemple)</p> </li> <li> <p>Secret : cette ressource permet le stockage d'informations sensibles dans le cluster Elle n'est normalement pas stock\u00e9 dans un conteneur, mais est mont\u00e9e comme fichier.</p> </li> <li> <p>CronJob : permet l'ex\u00e9cution p\u00e9riodique d'un type de pod</p> </li> <li> <p>Service : le service permet de publier au niveau du cluster la pr\u00e9sence d'un service qui est retrouv\u00e9 \u00e0 l'aide de s\u00e9lecteurs ; la publication se fait au niveau du DNS et dans les variables d'environnement.</p> </li> <li> <p>Deployment : objet d'ex\u00e9cution de charge pour les t\u00e2ches ne n\u00e9cessitant pas de gestion d'\u00e9tat ; ex : authenticateur</p> </li> <li> <p>StatefulSet : objet d'ex\u00e9cution de charge pour les t\u00e2ches n\u00e9cessitant une gestion d'\u00e9tat, et un nommage fixe ; ex : bd</p> </li> <li> <p>IngressRoute : configuration de la route vers le serveur HTTPS interne d'une instance, en fonction du nom d'h\u00f4te</p> </li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/description_generale.html#description-grosses-mailles-du-chart-helm","title":"Description grosses mailles du chart Helm","text":"<p>Le fichier principal du chart Helm est Chart.yaml. Ce fichier contient le versionning du package, mais surtout les annotations, qui peuvent \u00eatre utilis\u00e9es comme des constantes dans les templates. Dans ces annotations, on a en particulier les indications des images et des tags associ\u00e9s (pour le moment, tag latest, mais que sera \u00e0 changer pour le versionning r\u00e9el pour la production).</p> <p>Le principe de fonctionnement est d\u00e9crit dans la section d\u00e9di\u00e9e plus haut.</p> <p>Le fichier values.yaml contient des d\u00e9finitions de variables qui peuvent \u00eatre ensuite remplac\u00e9es lors de l'installation du chart. Ce sont les r\u00e9glages des valeurs de ce fichier qui va \u00eatre propre \u00e0 chaque paroisse (en plus des volumes de stockage).</p> <p>Le namespace sera d\u00e9fini \u00e0 l'installation du chart.</p> <p>Les constantes et les variables vont permettre de setter notamment les variables d'environnement ; les variables d'environnement sont expliqu\u00e9es au niveau des images Docker du projet.</p> <p>Le r\u00e9pertoire charts est pr\u00e9vu pour contenir des sous-charts. Ce r\u00e9pertoire est pour le moment vide.</p> <p>Le r\u00e9pertoire des templates contient les d\u00e9finitions des diff\u00e9rents composants pr\u00e9sent\u00e9s. Il n'y a que peu de choses \u00e0 dire, si ce n'est sur les secrets : les secrets peuvent \u00eatre r\u00e9cup\u00e9r\u00e9s depuis Kubernetes, de sorte \u00e0 ce qu'ils ne soient pas remplac\u00e9s par de nouvelles valeurs : c'est important pour les mots de passe. Ce m\u00e9canisme est \u00e9galement mis en oeuvre au niveau des clefs, car il est arriv\u00e9 que certains containers n'ont pas \u00e9t\u00e9 red\u00e9marr\u00e9s lors d'un upgrade et utilisaient les anciennes clefs, ce qui a d\u00e9clench\u00e9 un probl\u00e8me de communication entre les containers.</p> <p>Les containers d'initialisation ont plusieurs utilit\u00e9s :</p> <ul> <li>ils permettent d'initialiser des volumes avec des donn\u00e9es initiales, si les volumes sont vides</li> <li>ils permettent d'effectuer une synchronisation entre containers, en attendant qu'un service soit disponible par exemple, dans le container d'init.</li> </ul> <p>En ce qui concerne la synchronisation, l'ordre de d\u00e9marrage est fix\u00e9 dans une certaine mesure : </p> <ul> <li>le stateful set de base de donn\u00e9es d\u00e9marre en premier, en initilisant si n\u00e9cessaire la BD et les volumes persistants</li> <li>le serveur web interne d\u00e9marre ensuite</li> <li> <p>le serveur proxy d\u00e9marre enfin</p> </li> <li> <p>le cron peut d\u00e9marrer du moment que la BD est initialis\u00e9e, c'est \u00e0 dire que le stateful set de BD est pr\u00eat.</p> </li> </ul> <p>Le design pattern <code>sidecar</code> (et ses variantes) est utilis\u00e9 dans ce chart :</p> <ul> <li>les acc\u00e8s \u00e0 la BD sont effectu\u00e9s via un container <code>dbrouter</code> qui se charge de mettre en oeuvre la s\u00e9curit\u00e9 de la communication avec la BD.</li> </ul> <p>En termes de synchronisation / attentes :</p> <ul> <li>mysqladmin ping permet de v\u00e9rifier si une BD est disponible</li> <li>nslookup permet de v\u00e9rifier si un nom est r\u00e9solu ; ce test n'est toutefois pas trop int\u00e9ressant, car un service peut avoir une IP assign\u00e9e m\u00eame s'il n'y a pas de points de terminaisons associ\u00e9s au service</li> <li>nc -z permet de v\u00e9rifier si un port est ouvert</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/description_generale.html#serveur-mail-de-demo","title":"Serveur mail de d\u00e9mo","text":"<p>Un serveur mail de d\u00e9mo est pr\u00e9vu dans le package Helm. Il est install\u00e9 par d\u00e9faut, de sorte qu'un environnement de d\u00e9mo complet puisse \u00eatre install\u00e9 sans passer par un fichier de valeurs am\u00e9nag\u00e9. Le serveur mail de d\u00e9mo permet de faire un \"bouchonnage\", de sorte \u00e0 ce qu'on puisse si n\u00e9cessaire faire des tests via ce moyen. Le serveur de mails de d\u00e9mo utilise un CA d\u00e9di\u00e9 \u00e0 cet usage, et qui doit \u00eatre int\u00e9gr\u00e9 aux CA reconnus par les containers, d'o\u00f9 l'int\u00e9gration d'un volume d\u00e9di\u00e9 si le serveur de mail de d\u00e9mo est activ\u00e9.</p> <p>Attention : ** le serveur de mail de d\u00e9mo n'est pas pr\u00e9vu pour \u00eatre utilis\u00e9 en production. ** Non seulement, il utilise des versions vieilles des programmes, mais en plus il n'a pas \u00e9t\u00e9 revu/durci du point de vue s\u00e9curit\u00e9.</p> <p>Serveur mail de d\u00e9mo : ne pas utiliser en production</p> <p>Ce serveur mail de d\u00e9mo ne doit pas \u00eatre d\u00e9ploy\u00e9 en production.</p> <p>Le param\u00e8tre qui d\u00e9clenche l'utilisation du serveur mail de d\u00e9mo est la valeur <code>.Values.mail.deployMailserver</code>, qui vaut par d\u00e9faut 1. Une valeur diff\u00e9rente de 1 inhibe la mise en oeuvre du serveur mail de d\u00e9mo.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/httpd.html","title":"Serveur web interne","text":"<p>Il n'y a pas grand chose \u00e0 dire \u00e0 ce niveau, si ce n'est qu'on attend sur la disponibilit\u00e9 du service DB dans un container d'initialisation, puis qu'on utilise un sidecar pour se connecter \u00e0 la BD.</p> <p>La plupart des param\u00e8tres de configuration sont pass\u00e9s dans l'environnement via une configMap, tandis que les fichiers des clefs sont mont\u00e9s via des secrets. On se souviendra que la configMap contient notamment les param\u00e8tres de <code>mpm_prefork</code>, param\u00e8tres qui limitent dans une certaine mesure les ressources utilis\u00e9es par chaque instance Civiparoisse.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/httpd.html#configuration-de-lacces-au-serveur-web-interne","title":"Configuration de l'acc\u00e8s au serveur web interne","text":"<p>Traefik est mis \u00e0 contribution, au travers d'un objet <code>ServersTransport</code> (pour pr\u00e9ciser le CA pour le TLS et les timeouts )et d'un objet <code>IngressRoute</code> (pour la r\u00e8gle sur le nom d'h\u00f4te en particulier) :</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressproxy\n  namespace: {{ .Release.Namespace }}\nspec:\n  entryPoints:\n    - websecure\n  routes:\n    - match: \"Host(`{{ .Values.externalhost }}`)\"\n      kind: Rule\n      services:\n        - name: civicrmhttpd\n          namespace: {{ .Release.Namespace }}\n          port: 443\n          serversTransport: transport-selfsigned\n  tls: {}\n</code></pre> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: ServersTransport\nmetadata:\n  name: transport-selfsigned\n  namespace: {{ .Release.Namespace }}\nspec:\n  serverName: {{ .Values.externalhost }}\n  maxIdleConnsPerHost: {{ .Values.serverstransport.maxIdleConnsPerHost }}\n  disableHTTP2: {{ .Chart.Annotations.serverstransportDisableHTTP2 }}\n  forwardingTimeouts:\n    dialTimeout : {{ .Values.serverstransport.dialTimeout }}\n    responseHeaderTimeout: {{ .Values.serverstransport.responseHeaderTimeout }}\n    readIdleTimeout: {{ .Values.serverstransport.readIdleTimeout }}\n    idleConnTimeout: {{ .Values.serverstransport.idleConnTimeout }}\n  rootCAsSecrets:\n    - externca\n</code></pre>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/maildemo.html","title":"Serveur de mails de d\u00e9mo","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/maildemo.html#historique-et-utilite","title":"Historique et utilit\u00e9","text":"<p>Les \u00e9tudes initiales par rapport  \u00e0 l'envoi et \u00e0 la r\u00e9ception des mails avaient privil\u00e9gi\u00e9 l'utilisation de containers sp\u00e9cialis\u00e9s pour ces t\u00e2ches : de ce fait, l'interface avec le coeur de CiviCRM auraient \u00e9t\u00e9 un programme d'envoi de mail (\u00e9quivalent d'une commande sendmail) d\u00fbment configur\u00e9 pour transf\u00e9rer le mail sur une socket, et d'autre part un r\u00e9pertoire de type Maildir pour l'exploitation des mails r\u00e9cup\u00e9r\u00e9s, ce qui aurait isol\u00e9 les flux r\u00e9seaux des mails entrants et des mails sortants dans des containers sp\u00e9cifiques.</p> <p>Toutefois, il a \u00e9t\u00e9 d\u00e9cid\u00e9 de se passer des containers sp\u00e9cialis\u00e9s et d'utiliser les fonctionnalit\u00e9s r\u00e9seaux directement configurables dans CiviCRM, afin de chercher \u00e0 privil\u00e9gier une certaine accessibilit\u00e9 de la configuration. En contrepartie, l'interface entre les mails et le syst\u00e8me devient les appels r\u00e9seaux de CiviCRM. Il est entendu qu'au niveau syst\u00e8me, les mails ne sont donc pas configur\u00e9s (notamment Drupal et plus largement PHP ne profiteront pas de la configuration, de m\u00eame que d'autres \u00e9ventuels outils syst\u00e8mes).</p> <p>Il est donc devenu n\u00e9cessaire de pouvoir disposer de ces fonctionnalit\u00e9s dans un environnement de d\u00e9monstration : d'o\u00f9 la cr\u00e9ation d'une image de serveur de mails de d\u00e9mo.</p> <p>** Cette installation n'est pas pr\u00e9vue pour la production. **</p> <p>Serveur mail de d\u00e9mo : ne pas utiliser en production</p> <p>Le serveur de mail n'a pas \u00e9t\u00e9 configur\u00e9/pens\u00e9/durci pour une utilisation en production. L'utilisation \u00e9ventuelle qui doit en \u00eatre faite est un bouchonnage local \u00e9ventuellement pour des besoins de d\u00e9veloppement.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/maildemo.html#implementation","title":"Impl\u00e9mentation","text":"<p>L'image du serveur de mails de d\u00e9mo est discut\u00e9e dans la section d\u00e9di\u00e9e aux images Docker. L'impl\u00e9mentation prend la forme de code conditionnel dans Helm, comme par exemple : </p> <pre><code>{{- if eq .Values.mail.deployMailserver \"1\" }}\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: config-mailserver\n  namespace: {{ .Release.Namespace }}\ndata:\n  SMTP_USER_SECRET : {{ .Chart.Annotations.smtpUsernameRefSecret | quote }}\n  SMTP_PASSWD_SECRET: {{ .Chart.Annotations.smtpPasswordRefSecret | quote }}\n  IMAP_PASSWD_SECRET: {{ .Chart.Annotations.imapPasswordRefSecret | quote }}\n  IMAP_USER_SECRET: {{ .Chart.Annotations.imapUsernameRefSecret | quote }}\n  IMAP_USER2_SECRET: {{ .Chart.Annotations.imapUsername2RefSecret | quote }}\n{{- end }}\n</code></pre> <p>Le d\u00e9ploiement ou non du serveur de mail d\u00e9pend de la valeur de <code>.Values.mail.deployMailserver</code>.</p> <p>Le d\u00e9ploiement du serveur de mail se concr\u00e9tise en pratique par :</p> <ul> <li>une configMap pour les noms des secrets relatifs aux noms d'utilisateurs et mot de passe</li> <li>un secret contenant les clefs, mots de passe, noms d'utilisateur proprement dits ; on notera en particulier la g\u00e9n\u00e9ration du certificat du serveur de mail qui contient un grand nombre de Subject Alternative Names.</li> <li>un d\u00e9ploiement avec le serveur proprement dit</li> <li>deux services (imapdemo et smtpdemo)</li> <li>des proc\u00e9dures d'initialisation sp\u00e9cifiques de r\u00e9pertoires pour int\u00e9grer le CA des mails via des emptyDirs stock\u00e9s en m\u00e9moire, ces emptyDirs \u00e9tant ensuite mont\u00e9s dans les pods qui peuvent interagir avec les mails.</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/reservations.html","title":"R\u00e9servations de ressources","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/reservations.html#considerations-generales","title":"Consid\u00e9rations G\u00e9n\u00e9rales","text":"<p>La r\u00e9servation des ressources est un domaine important dans Kubernetes, car les r\u00e9servations permettent de mieux planifier l'ex\u00e9cution des pods. Les ressources attribu\u00e9es seraient garanties quand la demande et la limite sont \u00e9quivalentes. D'o\u00f9 la mise en oeuvre de limitations et de requ\u00eates de m\u00eames valeurs, et ce au niveau CPU et m\u00e9moire.</p> <p>Le profilage des ressources consomm\u00e9es joue sur plusieurs \u00e9l\u00e9ments :</p> <ul> <li>la RAM et l'espace disque sont des ressources critiques : en particulier, si l'on n'a plus de RAM, le container peut crasher ; en revanche, au niveau CPU, on jouera plut\u00f4t sur les performances (\u00e0 moins d'avoir des prol\u00e9matiques de temporisation)</li> <li>la BD est pr\u00e9vue initialement pour tenir dans 512Mo ; en d\u00e9sactivant performance_schema, on devrait pouvoir tenir dans 350Mo</li> <li>on peut limiter au niveau d'Apache le nombre de requ\u00eates servies simultan\u00e9ment ; ces requ\u00eates, lorsqu'elles arrivent sur du code PHP, font entrer en jeu la limite m\u00e9moire de PHP. On arrive alors \u00e0 borner la plus grosse d\u00e9pense m\u00e9moire</li> <li>le cron travaille avec un seul environnement PHP \u00e0 la fois : il devrait donc \u00eatre possible de borner sa consommation de RAM</li> <li>on ne peut pas encore d\u00e9terminer avec pr\u00e9cision les espaces disques qui seront \u00e0 allouer, que ce soit pour les volumes persistants ou pour les volumes \u00e9ph\u00e9m\u00e8res (dont logs)</li> <li>il a \u00e9t\u00e9 pr\u00e9vu de pouvoir changer les valeurs des ressources dans chaque d\u00e9ploiement de release : en effet, la charge d\u00e9pend aussi de l'utilisation (intensive ou non) qui sera faite de l'outil. Il peut \u00eatre compr\u00e9hensible de chercher \u00e0 contenter les plus gros consommateurs tant que ce n'est pas au d\u00e9triment des autres consommateurs</li> <li>il ne faut pas oublier que le nombre cible de d\u00e9ploiements est tr\u00e8s cons\u00e9quent : de ce fait, des petites \u00e9conomies de ressources peuvent avoir toutefois un effet notable</li> <li>on ne peut pas additionner aveugl\u00e9ment les ressources de tous les containers : il faut \u00e9galement consid\u00e9rer l'ordre de d\u00e9marrage des pods, et le fait que les containers d'init d'un pod n'existent pas en m\u00eame temps que les containers qui constituent la v\u00e9ritable charge de travail</li> <li>il ne faut pas oublier que toutes les ressources du cloud ont un co\u00fbt associ\u00e9, d'o\u00f9 l'apparition d'une nouvelle d\u00e9marche : le FinOps, qui cherche \u00e0 optimiser l'utilisation des ressources et le co\u00fbt.</li> </ul>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/reservations.html#estimations-des-ressources-dune-instance","title":"Estimations des ressources d'une instance","text":""},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/reservations.html#hypotheses-de-travail","title":"Hypoth\u00e8ses de travail","text":"<p>Il est n\u00e9cessaire de poser un certain nombre d'hypoth\u00e8ses de travail :</p> <ul> <li> <p>on va se baser sur un seul utilisateur simultan\u00e9 d'une instance</p> </li> <li> <p>on va se baser sur des ressources garanties (request=limit sur les r\u00e9servations), pour ne pas avoir en th\u00e9orie de probl\u00e8mes d'\u00e9viction</p> </li> <li> <p>il faudra rajouter le co\u00fbt d'une solution de firewalling qui viendra \u00e9galement probablement en coupure des flux ; toutefois une telle solution sera probablement mutualis\u00e9e du fait du certificat wildcard utilis\u00e9 : il ne faut donc pas la comptabiliser au niveau de chaque instance</p> </li> <li> <p>on va passer sur un mod\u00e8le de threading Apache en mpm_prefork, qui est de toute fa\u00e7on utilis\u00e9 pour le PHP si on n'utilise pas php-fpm</p> </li> <li> <p>le minimum de m\u00e9moire (memory_limit requis par Drupal est 64M); toutefois selon https://docs.civicrm.org/installation/en/latest/general/requirements/ il faudrait passer au moins \u00e0 256M</p> </li> <li> <p>les logs passeront par un DaemonSet EFK ou \u00e9quivalent : du coup, le conteneur de gestion des logs n'est pas comptabilis\u00e9 dans l'infrastructure d'une instance</p> </li> <li> <p>l'ingress Traefik est partag\u00e9 par l'ensemble des instances, et n'est donc pas \u00e0 prendre en compte ici. Toutefois, il entre en compte au niveau des ressources du cluster, puisque pr\u00e9vu en DaemonSet. </p> </li> <li> <p>on consid\u00e8re que le service de mails de d\u00e9mo n'a pas \u00e0 \u00eatre activ\u00e9 : la consommation de ce service n'est donc pas comptabilis\u00e9e.</p> </li> <li> <p>on consid\u00e8re que le service des tools n'a pas \u00e0 \u00eatre activ\u00e9 en situation normale : la consommation de ce service n'est donc pas comptabilis\u00e9e.</p> </li> <li> <p>configuration mpm_prefork :</p> </li> </ul> <p><pre><code>MAX_CONNECTIONS_PER_CHILD=1\nMAX_REQUEST_WORKERS=4\nSERVER_LIMIT=4\nSTART_SERVERS=4\nMIN_SPARE_SERVERS=0\nMAX_SPARE_SERVERS=4\nLISTEN_BACKLOG=1\n</code></pre> Du coup, on sert 4 connexions simultan\u00e9es, ce qui pourrait \u00eatre suffisant pour un seul utilisateur simultan\u00e9.</p> Conteneur Description Limite m\u00e9moire Limite CPU cron ex\u00e9cution cron 384Mi 250m cron_dbrouter sidecar d'acc\u00e8s \u00e0 la BD cron 100Mi 100m cron_init initialisation du pod cron 50Mi 100m httpd serveur web interne 1536Mi 1000m httpd_dbrouter sidecar d'acc\u00e8s \u00e0 la BD pour serveur web 100Mi 100m httpd_init initialisation du pod server web interne 50Mi 100m db conteneur BD 384Mi 250m db_init initialisation environnement BD 1024Mi 1000m db_update update de l'environnement fichiers et BD 1024Mi 1000m <p>Ordre de d\u00e9marrage (sans sp\u00e9cialisation du mail sortant):</p> <p>Les containeurs d'initialisation impl\u00e9mentent les contraintes suivantes :</p> <ul> <li><code>db_init</code> permet de lancer <code>db</code> </li> <li><code>httpd_init</code> d\u00e9pend de <code>dbproxy</code> pour lancer <code>httpd_dbrouter</code> et <code>httpd</code></li> <li><code>cron_init</code> d\u00e9pend de dbproxy pour lancer <code>cron</code> et <code>cron_dbrouter</code></li> </ul> <p>On en obtient un \u00e9quivalent de graphe de d\u00e9pendances :</p> <ul> <li><code>db_init</code></li> <li><code>db_update</code><ul> <li><code>db</code><ul> <li><code>httpd_init</code><ul> <li><code>httpd_dbrouter</code></li> <li><code>httpd</code> </li> </ul> </li> <li><code>cron_init</code><ul> <li><code>cron</code></li> <li><code>cron_dbrouter</code></li> </ul> </li> </ul> </li> </ul> </li> </ul> <p>On peut d\u00e9duire deux phases de lancement d'une instance :</p> <ul> <li>installation initiale : seul <code>db_init</code> est lanc\u00e9 : 1024Mi, 1000m</li> <li>ensuite : mise \u00e0 jour : seul <code>db_update</code> est lanc\u00e9 : 1024Mi, 1000m</li> <li>ensuite, le pire cas est quand tous les services tournent, car <code>httpd_init</code> et <code>cron_init</code> consomment moins que les services proprement dits. Toutefois, l'unit\u00e9 \u00e9tant le pod d'ex\u00e9cution (\u00e0 cause du scheduling sur les noeuds), il faut faire des sommes s\u00e9par\u00e9es pour chaque pod :<ul> <li>pod db : 384Mi et 250m</li> <li>pod cron : 484Mi et 350m</li> <li>pod httpd : 1636Mi et 1100m</li> </ul> </li> </ul> <p>Donc une consommation totale max de : 2504Mi et 1800m</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/secrets.html","title":"Secrets","text":"<p>Les secrets sont de deux types :</p> <ul> <li> <p>le stockage des donn\u00e9es sensibles de type \"mot de passe\" : mot de passe DB, utilisateur/mot de passe admin Drupal : ces donn\u00e9es sont g\u00e9n\u00e9r\u00e9es par d\u00e9faut (en particulier avec la fonction <code>randAlpha</code> de Helm), et r\u00e9utilis\u00e9es si elles existent</p> </li> <li> <p>les infrastructures de clef : plusieurs CA sont utilis\u00e9s :</p> <ul> <li>le CA pour le certificat wildcard : ce CA n'est pas g\u00e9r\u00e9 par l'infrastructure</li> <li>le CA utilis\u00e9 pour le certificat du serveur MySQL et la validation au niveau du DBRouter</li> <li>le CA utilis\u00e9 pour le certificat du serveur web interne : le CA est v\u00e9rifi\u00e9 par Traefik</li> <li>le CA utilis\u00e9 pour le certificat du serveur mail de d\u00e9mo, si celui-ci est d\u00e9ploy\u00e9. Ce CA est alors int\u00e9gr\u00e9 dans les certificats syst\u00e8mes pour qu'ils soient disponibles depuis PHP.</li> </ul> </li> </ul> <p>On utilise \u00e9galement la fonction <code>lookup</code> de Helm pour conserver les clefs existantes et avoir ainsi une stabilit\u00e9 des clefs.   </p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/tools.html","title":"Les outils","text":"<p>Un stateful set un peu particulier est pr\u00e9sent dans le chart Helm : il s'agit d'un pod pour ex\u00e9cuter une image des outils. Le pod est \u00e9quip\u00e9 \u00e9galement avec l'acc\u00e8s \u00e0 la BD. Ce pod est pr\u00e9vu pour pouvoir entrer rapidement dans un environnement Civiparoisse pour effectuer des op\u00e9rations manuelles - et comme il s'agit d'un stateful set, le nom du pod g\u00e9n\u00e9r\u00e9 sera stable dans le temps. Ainsi, ce pod pourra par exemple servir pour des imports de donn\u00e9es. Toutefois, comme il n'est normalement pas utilis\u00e9, son nombre de r\u00e9plicas est initialement \u00e0 z\u00e9ro.</p> <p>En revanche, il est \u00e0 noter qu'il est bien possible d'arriver dans des situations o\u00f9 le pod ne peut pas \u00eatre schedul\u00e9 simplement : en effet, il pr\u00e9voit \u00e9galement l'acc\u00e8s au volume de bases de donn\u00e9es. La difficult\u00e9 pourrait donc survenir si le pod de la base de donn\u00e9es serait sur un autre noeud que les autres services.</p> <p>Enfin, le nombre de replicas des diff\u00e9rentes charges, ainsi que la suspension ou non du cronjob, est configurable en settant les valeurs ad\u00e9quates : il est ainsi alors possible de disposer par exemple uniquement des outils, ce qui pourrait faciliter certaines op\u00e9rations manuelles, comme une \u00e9ventuelle restauration manuelle de donn\u00e9es.</p>"},{"location":"TECHNIQUE/PREPOC/INTEGRATION/KUBERNETES/HELM/volumes.html","title":"Volumes (persistants)","text":"<p>Les volumes dont il est question ici sont les volumes persistants. Les volumes temporaires sont la plupart du temps utilis\u00e9 dans le contexte d'une mise \u00e0 disposition d'une socket Unix via un emptyDir, ou de g\u00e9n\u00e9ration du r\u00e9pertoire de CA hash\u00e9s (dans le cadre du d\u00e9ploiement du serveur mail de d\u00e9mo).</p> <p>Les volumes sont g\u00e9r\u00e9s au travers de PersistentVolumeClaim sur une classe de stockage, avec un mode qui est positionn\u00e9 \u00e0 ReadWriteOnce, ce qui signifie qu'un seul noeud K8S peut monter le volume en lecture \u00e9criture \u00e0 la fois. N\u00e9anmoins, les pods ex\u00e9cut\u00e9s sur le noeud peuvent acc\u00e9der en ReadWrite au volume, et ce en parall\u00e8le. Les tailles pr\u00e9sentes dans le chart seront \u00e0 adapter \u00e0 l'usage.</p> <p>On retrouve trois volumes persistants :</p> <ul> <li>dbvolclaim : le stockage des fichiers de la BD</li> <li>filevolclaim : le stockage des fichiers du site civicrm</li> <li>privatevolclaim: le stockage des fichiers priv\u00e9s du site civicrm</li> </ul> <p>D'autres volumes pourront faire leur apparition, notamment pour la sauvegarde, les logs, les mails.</p>"},{"location":"UTILISATION/index.html","title":"Section utilisation","text":"<p>Cette section cherche \u00e0 fournir une documentation de base aux utilisateurs, en particulier novices.</p> <ul> <li>Mode d'emploi</li> </ul>"},{"location":"UTILISATION/mode_emploi/index.html","title":"Mode d'emploi de Civiparoisse","text":"<ul> <li>Introduction</li> <li>D\u00e9buter</li> <li>G\u00e9rer les fiches</li> <li>G\u00e9rer les relations</li> <li>G\u00e9rer les liens avec la paroisse</li> <li>Faire des recherches sur les contacts</li> <li>Envoyer un courriel</li> <li>G\u00e9rer les groupes</li> <li>Utiliser les listes</li> <li>Que faire quand... ?</li> <li>Gestion des dons et \u00e9dition des re\u00e7us fiscaux</li> <li>Cr\u00e9er et g\u00e9rer un \u00e9v\u00e9nement</li> <li>Op\u00e9rations \u00e0 mener r\u00e9guli\u00e8rement</li> <li>Administration locale de la base de donn\u00e9es</li> <li>Pr\u00e9parer l'installation initiale de CiviParoisse</li> <li>Les nouveaut\u00e9s dans CiviParoisse</li> <li>Ressources</li> </ul>"},{"location":"UTILISATION/mode_emploi/creer_et_gerer_un_evenement.html","title":"Cr\u00e9er et g\u00e9rer un \u00e9v\u00e9nement","text":"<p>Page en cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/debuter.html","title":"D\u00e9buter","text":""},{"location":"UTILISATION/mode_emploi/debuter.html#debuter","title":"D\u00e9buter","text":"<p>Attention</p> <p>Avant de cr\u00e9er une fiche \"individu\", v\u00e9rifiez que la fiche \"foyer\" \u00e0 laquelle elle sera li\u00e9e existe d\u00e9j\u00e0. Sinon cr\u00e9ez d'abord la fiche \"foyer\".</p>"},{"location":"UTILISATION/mode_emploi/debuter.html#enregistrer-un-nouveau-foyer","title":"Enregistrer un nouveau foyer","text":"<p>Attention</p> <p>N'utilisez pas le menu <code>Contact</code> -&gt; <code>Nouveau foyer</code>, mais suivez la proc\u00e9dure ci-dessous. Elle utilise un formulaire sp\u00e9cialement \u00e9labor\u00e9 pour les paroisses.</p> <p>Pour cr\u00e9er un nouveau \"foyer\" vous devez passer par la page d'accueil (voir La page d'accueil) et cliquez sur l'ic\u00f4ne \"Nouveau Foyer\".</p> <p>Vous obtiendrez la fen\u00eatre suivante :</p> <p></p> <p> Vous trouverez plus d'informations sur la gestion des fiches en cliquant ici.</p>"},{"location":"UTILISATION/mode_emploi/debuter.html#enregistrer-un-nouvel-individu","title":"Enregistrer un nouvel individu","text":"<p>Attention</p> <p>N'utilisez pas le menu <code>Contact</code> -&gt; <code>Nouveau particulier</code> mais suivez la proc\u00e9dure ci-dessous. Elle utilise un formulaire sp\u00e9cialement \u00e9labor\u00e9 pour les paroisses.</p> <p>Contrairement \u00e0 la fiche foyer, nous avons ici un large panel d'informations que nous pouvons enregistrer.</p> <p>Pour cr\u00e9er un nouveau \"individu\" vous devez passer par la page d'accueil (voir La page d'accueil) et cliquez sur l'ic\u00f4ne \"Nouvel Individu / Particulier\".</p> <p></p> <p> Vous trouverez plus d'informations sur la gestion des fiches en cliquant ici.</p>"},{"location":"UTILISATION/mode_emploi/debuter.html#gerer-les-relations","title":"G\u00e9rer les relations","text":"<p>Les relations explicitent le lien entre des individus, mais aussi entre des individus et la paroisse, ou des individus et des associations  (ou des entreprises) que vous aurez enregistr\u00e9es. CiviParoisse propose de nombreuses relations.</p> <p> Vous trouverez plus d'information sur les relations en cliquant ici.</p>"},{"location":"UTILISATION/mode_emploi/debuter.html#inscrire-dans-les-groupes","title":"Inscrire dans les groupes","text":"<p>Apr\u00e8s les relations, les groupes sont une autre fa\u00e7on d'\u00e9tablir un lien entre des personnes, de dire qu'elles partagent quelque chose, une activit\u00e9 par exemple. Vous pouvez ainsi cr\u00e9er un groupe qui recense tous les membres de la chorale, un autre pour les cat\u00e9ch\u00e8tes, ou encore pour les participants au groupe biblique.</p> <p> Vous trouverez plus d'informations sur la gestion des groupes en cliquant ici.</p>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html","title":"Envoyer un courriel","text":""},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#envoyer-un-courriel","title":"Envoyer un courriel","text":"<p>CiviParoisse propose deux formes de courriels, l'une qui ressemble \u00e0 ce que vous connaissez dans votre logiciel de courriel habituel, l'autre qui permet des pr\u00e9sentations bien plus \u00e9labor\u00e9es, tout en \u00e9tant relativement simple \u00e0 mettre en oeuvre. Cette deuxi\u00e8me solution est recommand\u00e9e pour vos lettres \u00e9lectroniques, la premi\u00e8re \u00e9tant plut\u00f4t pour des courriels simples n'ayant pas besoin d'une grande esth\u00e9tique.</p> <p>Attention</p> <p>Une autre diff\u00e9rence importante est le nombre de destinataires. Pour un envoi imm\u00e9diat, il est n\u00e9cessaire d'avoir moins de 50 destinataires. Un envoi massif est possible pour tout nombre de destinataires, et obligatoire au-del\u00e0 de 50 destinataires. Il est \u00e9galement possible d'en planifier l'envoi. Cela vous \u00e9vitera d'\u00eatre blacklist\u00e9s, c'est \u00e0 dire consid\u00e9r\u00e9 comme spammeurs, ce qui aurait pour effet assez rapidement que soit vos courriels soient consid\u00e9r\u00e9s comme \"ind\u00e9sirables\" (spam) ou pire n'arrivent pas du tout. CiviParoisse n'envoie pas les messages de la m\u00eame fa\u00e7on dans les deux cas.</p> <p>Pour envoyer un courriel, vous pouvez partir d'une liste de contacts obtenue gr\u00e2ce \u00e0 une recherche. Dans ce cas s\u00e9lectionnez les contacts voulus puis cliquez sur <code>Actions</code> et choisissez <code>Courriel - envoi imm\u00e9diat</code> ou <code>Courriel - planifier/envoyer un envoi massif</code>, selon le nombre de destinataires.</p> <p>Mais vous pouvez aussi proc\u00e9der des deux fa\u00e7ons d\u00e9taill\u00e9es ci-apr\u00e8s.</p>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#courriel-classique-courriel-envoi-immediat","title":"Courriel classique (\"Courriel - envoi imm\u00e9diat\")","text":"<p>Pour par exemple inviter les conseillers presbyt\u00e9raux \u00e0 la prochaine r\u00e9union, le contenu sera plus important que le contenant et aussi par souci \u00e9cologique (les illustrations ont un co\u00fbt en CO2), vous opterez sans doute pour le courriel classique qui permet d\u00e9j\u00e0 d'appliquer du gras, de l'italique, de placer un tableau, une image, d'ajouter des pi\u00e8ces jointes, etc.</p> <ul> <li>Pour y acc\u00e9der, recherchez le ou les destinataires concern\u00e9s, en utilisant les outils de recherche (cliquez ici pour en savoir plus). Apr\u00e8s les avoir s\u00e9lectionn\u00e9s, cliquez sur <code>Courriel - envoi imm\u00e9diat</code>.</li> </ul> <p></p> <ul> <li>Dans la nouvelle fen\u00eatre, choisissez l'adresse mail d'exp\u00e9dition si n\u00e9cessaire dans le champ <code>De</code>. Supprimez ou rajoutez des adresses mails dans le champ <code>A</code>. Puis indiquez l'objet du mail dans le champ <code>Sujet</code>.</li> </ul> <p>Attention</p> <p>Il est indispensable de choisir l'adresse de la paroisse comme adresse d'exp\u00e9dition (le champ <code>De</code> tout en haut du mail que vous \u00eates en train de cr\u00e9er). Ne choisissez jamais votre propre adresse mail : pour des raisons de s\u00e9curit\u00e9, ces mails ne sont pas envoy\u00e9s.</p> <ul> <li> <p>Ecrivez votre courriel dans la partie <code>Format HTML</code>, rajoutez si besoin des pi\u00e8ces jointes dans la partie <code>Pi\u00e8ce jointe</code>, et cliquez sur <code>Envoyer les courriels</code>. Votre courrier sera alors envoy\u00e9 imm\u00e9diatement.</p> </li> <li> <p>Vous avez \u00e9galement la possibilit\u00e9 de rajouter des destinataires en copie en cliquant sur le bouton <code>Ajouter CC</code>, ou en copie cach\u00e9e en cliquant sur le bouton <code>Ajouter CCC</code>.</p> </li> </ul> <p>Astuce</p> <p>CiviParoisse permet de faire du publipostage, vous pouvez donc ajouter par exemple les champs \"Formule de salutation par courriel\" suivi du champ \"nom affich\u00e9\" pour obtenir pour chaque destinataire quelque chose du type <code>Bien cher M. DUPONT Martin,</code>. Pour cela, utilisez les <code>champs de fusion</code> lors de la cr\u00e9ation du courriel.</p>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#mailing-courriel-envoi-massif","title":"Mailing (\"Courriel - envoi massif\")","text":"<p>Si votre paroisse diffuse une lettre \u00e9lectronique d'information en compl\u00e9ment du bulletin paroissial, vous voudrez sans doute que l'oeil du futur lecteur soit attir\u00e9 par une pr\u00e9sentation plus recherch\u00e9e. L\u00e0 encore, CiviParoisse vous permet de le faire.</p> <p>Pour y acc\u00e9der, cliquez sur <code>Mailings</code> et choisissez en haut de la liste <code>Nouveau mailing</code>. Vous pouvez \u00e9galement y acc\u00e9der via le bouton <code>Action</code> dans les \u00e9crans de recherche, et en choisissant <code>Courriel - planifier/envoyer un mailing</code>.</p>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#premiere-partie-le-mailing","title":"Premi\u00e8re partie : le mailing","text":"<ul> <li> <p>Indiquez un nom du mailing. Ce nom se retrouvera, une fois le courriel envoy\u00e9, dans l'onglet <code>Activit\u00e9s</code> de chaque destinataire. Prenez par cons\u00e9quent un nom suffisamment explicite pour qu'il vous parle encore des mois plus tard.</p> </li> <li> <p>Le champ <code>De</code> comporte en principe l'adresse courriel de votre paroisse. Si ce n'est pas le cas, choisissez bien l'adresse de votre paroisse.</p> </li> <li> <p>Dans <code>Destinataires</code> vous allez pouvoir choisir un groupe simplement en commen\u00e7ant \u00e0 taper son nom. Si vous \u00eates pr\u00e9alablement pass\u00e9 par une recherche, le groupe est constitu\u00e9 automatiquement. Vous pouvez \u00e9galement rappeler le nom d'un ancien mailing, si vous souhaitez \u00e9crire \u00e0 la m\u00eame liste de personnes.</p> </li> <li> <p>Le <code>Sujet</code> correspond \u00e0 ce qui est parfois \"Objet\" du courriel dans certains logiciels. C'est l'intitul\u00e9 du courriel tel qu'il s'affichera chez vos destinataires.</p> </li> </ul> <ul> <li>Cliquer sur <code>Suivant</code>.</li> </ul>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#deuxieme-partie-le-design","title":"Deuxi\u00e8me partie : le design","text":"<ul> <li>Choisissez le <code>mod\u00e8le mail UEPAL</code>. Vous obtiendrez la fen\u00eatre suivante :</li> </ul> <ul> <li> <p>Pour cr\u00e9er votre courriel, vous pouvez simplement saisir le texte au centre du mail (l\u00e0 o\u00f9 il est indiqu\u00e9 <code>Saisir ici votre texte</code>).  </p> <p>Selon les besoins, vous pouvez modifier la mise en page en glissant un \"bloc\" (ou en cliquant sur le bouton \"Add\" qui apparait lorsque la souris se place sur un bloc) de la gauche vers la droite. Vous pourrez les r\u00e9arranger \u00e0 volont\u00e9. Vous pouvez ensuite personnaliser les diff\u00e9rents blocs, placer du texte et des illustrations que vous utiliserez \u00e0 chaque envoi et pr\u00e9visualiser le r\u00e9sultat. A droite de chaque bloc se trouve une ic\u00f4ne pour le dupliquer et une autre pour le supprimer si vous d\u00e9cidez d'une autre pr\u00e9sentation. Si vous cliquez sur certains \u00e9l\u00e9ments, la partie de gauche change d'affichage pour vous permettre de personnaliser l'\u00e9l\u00e9ment (par exemple pour indiquer la page Facebook de la paroisse).</p> </li> <li> <p>Une fois le courriel compos\u00e9, cliquer sur <code>Fermer</code>.</p> </li> <li> <p>Au pr\u00e9alable, vous pourriez effectuer un test, en cliquant simplement sur <code>Tester</code>. Cela vous sera utile si vous avez mis en place une esth\u00e9tique \u00e9labor\u00e9e et que vous voudrez v\u00e9rifier que le contenu est bien conforme \u00e0 vous attentes, avant d'envoyer le courriel \u00e0 l'ensemble des destinataires.</p> </li> <li> <p>Cliquer sur <code>Suivant</code>.</p> </li> </ul>"},{"location":"UTILISATION/mode_emploi/envoyer_un_courriel.html#troisieme-partie-les-options-et-lenvoi","title":"Troisi\u00e8me partie : les options et l'envoi","text":"<ul> <li> <p>Planifiez l'envoi, soit imm\u00e9diat (<code>Envoyer imm\u00e9diatement</code>), soit \u00e0 une date/heure future (<code>Send on...</code>).</p> </li> <li> <p>Pour ajouter des pi\u00e8ces jointes, cliquez sur <code>Advanced Mailing Options</code>. Rajoutez les fichiers en suivant les instructions \u00e0 l'\u00e9cran.</p> </li> <li> <p>Lorsque votre mailing est totalement pr\u00e9par\u00e9, cliquez sur <code>Submit Mailing</code>.</p> </li> </ul> <p>D\u00e9lais d'envoi de votre mailing</p> <p>L'envoi de votre mailing commencera quelques minutes apr\u00e8s avoir valid\u00e9 l'envoi. Selon le nombre de destinataires, la distribution sera \u00e9tal\u00e9e sur plusieurs dizaines de minutes. Ceci contribue \u00e0 \u00e9viter que vos communications soient consid\u00e9r\u00e9es comme des spams.</p>"},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html","title":"Faire des recherches sur les contacts","text":""},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html#faire-des-recherches-sur-les-contacts","title":"Faire des recherches sur les contacts","text":""},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html#la-recherche-rapide","title":"La recherche rapide","text":"<p>La recherche rapide est celle accessible via l'ic\u00f4ne de loupe , tout \u00e0 gauche du menu de CiviParoisse. Par ce biais vous pouvez rapidement retrouver un contact si vous connaissez par exemple son nom, ou son num\u00e9ro de t\u00e9l\u00e9phone.</p> <p> L'ensemble des moyens de rechercher un contact permet l'utilisation du caract\u00e8re g\u00e9n\u00e9rique %. Ainsi, rechercher Mich% vous donnera tous les \"Michel\", mais aussi les \"Michelle\" et les \"Micha\u00ebl\".</p>"},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html#la-recherche-simple-des-contacts","title":"La recherche simple des contacts","text":"<p>Vous acc\u00e9dez \u00e0 la recherche simple en cliquant sur <code>Rechercher</code> puis <code>Rechercher des contacts</code>.</p> <p>Bien que consid\u00e9r\u00e9e comme simple, elle vous permet de filtrer par exemple les r\u00e9sultats par type de contact ( individu,  foyer ou  organisation), par  groupe ou encore les contacts ayant une  \u00e9tiquette pr\u00e9cise.</p> <p>Astuce</p> <p>Dans la liste des r\u00e9sultats, laissez votre souris sur l'ic\u00f4ne de la fiche (que ce soit un individu, un foyer ou une organisation) et une fen\u00eatre apparait affichant un r\u00e9sum\u00e9 de la fiche.</p>"},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html#la-recherche-avancee","title":"La recherche avanc\u00e9e","text":"<p>Vous acc\u00e9dez \u00e0 la recherche avanc\u00e9e en cliquant sur <code>Rechercher</code> puis <code>Recherche avanc\u00e9e</code>.</p> <p>Cette recherche est tr\u00e8s puissante et vous donne acc\u00e8s \u00e0 toutes les donn\u00e9es de CiviParoisse.</p> <p></p> <p>N'h\u00e9sitez pas \u00e0 explorer les diff\u00e9rentes cat\u00e9gories. Elle vous permet par exemple d'indiquer plusieurs crit\u00e8res que vous combinez en cochant \"Et\" ou \"Ou\".</p> <p>Par cette recherche vous avez plusieurs possibilit\u00e9s, la recherche par quartier par exemple. De m\u00eame vous pourriez chercher toutes les personnes sachant jouer du piano.</p> <p>Si en septembre vous voulez contacter tous les jeunes de 11 ans pour les inviter au cat\u00e9chisme, il suffit de vous rendre dans <code>Donn\u00e9es d\u00e9mographiques</code>, d'indiquer en \u00e2ge minimal et maximal \"11\" et vous aurez la liste des jeunes concern\u00e9s. De fa\u00e7on semblable pour lister tous les plus de 65 ans pour la f\u00eate des A\u00een\u00e9s.</p> <p>Il est \u00e9galement possible d'\u00e9crire aux parents des jeunes ainsi s\u00e9lectionn\u00e9s. Pour cela, saisissez d'abord les crit\u00e8res pour s\u00e9lectionner les jeunes (comme ci-dessus par exemple), puis en haut \u00e0 droite de l'\u00e9cran, dans les <code>Param\u00e8tres de recherche</code>, choisissez le type des r\u00e9sultats <code>Contacts li\u00e9s</code>. S\u00e9lectionnez ensuite le type de relation <code>Parents de</code>, et cliquez sur <code>Rechercher</code>.</p> <p>Notez qu'\u00e0 tout moment vous pouvez modifier vos crit\u00e8res de recherche en cliquant sur <code>Modifier les crit\u00e8res de recherche</code>, sans avoir besoin de tout param\u00e9trer \u00e0 nouveau.</p> <p>Astuce</p> <p>CiviParoisse \u00e9tant utilis\u00e9 dans votre navigateur pr\u00e9f\u00e9r\u00e9, faites un clic droit sur un des noms de la liste de r\u00e9sultat et choisissez <code>Ouvrir dans un nouvel onglet</code> pour ouvrir la fiche de contact dans un nouvel onglet, vous permettant de revenir ais\u00e9ment \u00e0 votre liste ensuite.</p>"},{"location":"UTILISATION/mode_emploi/faire_des_recherches_sur_les_contacts.html#utiliser-les-recherches-pour-mener-des-actions","title":"Utiliser les recherches pour mener des actions","text":"<p>Admettons que vous avez recherch\u00e9 tous les jeunes de 11 \u00e0 13 ans, et que vous souhaitez cr\u00e9er un groupe \"Liste de diffusion\" pour communiquer r\u00e9guli\u00e8rement avec eux, il vous suffit, une fois la liste des contacts affich\u00e9e, de cliquer sur <code>S\u00e9lectionner :</code> et cocher <code>Tous (x trouv\u00e9s)</code>. Cliquez ensuite sur <code>Actions</code> puis sur <code>Groupe - cr\u00e9er un groupe dynamique</code> pour cr\u00e9er votre liste de diffusion.</p> <p>Prenons un autre exemple, vous avez un groupe constitu\u00e9 des paroissiens qui ont fait un don \u00e0 la paroisse l'ann\u00e9e pr\u00e9c\u00e9dente \u00e0 qui vous voulez envoyer un mot de remerciement. Pour envoyer des courriers \u00e0 ces personnes, il vous suffit de faire une recherche en utilisant la recherche simple, et en recherchant le groupe en question. Une fois la liste affich\u00e9e, s\u00e9lectionnez tous les contacts comme vous avez appris \u00e0 le faire, puis cliquez sur <code>Actions</code> et choisissez en fin de liste <code>Etiquettes pour la poste - imprimer</code>. Dans la fen\u00eatre qui s'affiche, choisissez dans le menu <code>S\u00e9lectionner un format d'\u00e9tiquette</code> le format des \u00e9tiquettes dont dispose la paroisse, puis cliquez sur <code>Imprimer des \u00e9tiquettes pour la Poste</code>. Un PDF est g\u00e9n\u00e9r\u00e9 avec les \u00e9tiquettes des diff\u00e9rents foyers, il ne reste plus qu'\u00e0 l'imprimer sur des planches d'\u00e9tiquettes, et \u00e0 envoyer votre courrier.</p> <p>Le menu <code>Actions</code> propose \u00e9galement, selon le contexte, les possibilit\u00e9s suivantes :</p> <ul> <li>Afficher les contacts sur une carte</li> <li>Ajouter des relations aux contacts</li> <li>Supprimer les contacts (\u00e0 manier \u00e9videmment avec pr\u00e9caution !)</li> <li>Ajouter une information sur une interaction avec les contacts (activit\u00e9s)</li> <li>Envoyer des courriels (en savoir plus)</li> <li>Fusionner des doublons</li> <li>Ajouter ou enlever les contacts d'un groupe</li> <li>Inscrire les contacts \u00e0 un \u00e9v\u00e9nement</li> <li>Exporter les informations dans une feuille Excel</li> </ul>"},{"location":"UTILISATION/mode_emploi/fiches_contact.html","title":"G\u00e9rer les fiches","text":""},{"location":"UTILISATION/mode_emploi/fiches_contact.html#gerer-les-fiches-avec-les-contacts","title":"G\u00e9rer les fiches avec les contacts","text":""},{"location":"UTILISATION/mode_emploi/fiches_contact.html#enregistrer-un-nouveau-foyer","title":"Enregistrer un nouveau Foyer","text":"<p>Attention</p> <p>N'utilisez pas le menu <code>Contact</code> -&gt; <code>Nouveau foyer</code> mais suivez la proc\u00e9dure ci-dessous. Elle utilise un formulaire sp\u00e9cialement \u00e9labor\u00e9 pour les paroisses.</p> <p>Pour cr\u00e9er un nouveau \"foyer\" vous devez passer par la page d'accueil (voir La page d'accueil) et cliquez sur l'ic\u00f4ne \"Nouveau Foyer\".</p> <p>Vous obtiendrez la fen\u00eatre suivante :</p> <p></p> <p>Merci de respecter les r\u00e8gles suivantes pour maintenir la coh\u00e9rence des donn\u00e9es au sein de votre base de donn\u00e9es :</p> <p> Nom du Foyer : saisir le nom de famille en majuscules, en respectant les r\u00e8gles suivantes :</p> <ul> <li>NOM Pr\u00e9nom pour un(e) c\u00e9libataire (ex. : DUPONT Marc)</li> <li>NOM Pr\u00e9nom et Pr\u00e9nom pour un couple portant le m\u00eame nom de famille (ex. DUPONT Marc et C\u00e9cile)</li> <li>NOM Pr\u00e9nom et NOM Pr\u00e9nom pour un couple ne portant pas le m\u00eame nom de famille (ex. DUPONT Marc et DURAND C\u00e9cile)</li> </ul> <p> Adresse : la renseigner de fa\u00e7on aussi pr\u00e9cise que possible.  </p> <p> Num\u00e9ro(s) de t\u00e9l\u00e9phone fixe de la maison : seul le t\u00e9l\u00e9phone fixe est saisi dans la fiche Foyer, les num\u00e9ros de portables sont saisis sur les fiches Individu respectives. Le(s) saisir en respectant le format international (ex. +33 3 88 89 90 91). Mettre des espaces entre les num\u00e9ros et non des points.</p> <p> Quartier :  secteur g\u00e9ographique utilis\u00e9 pour la distribution de journaux paroissiaux, du Nouveau Messager, de courriers, etc... Il est possible de g\u00e9rer les noms des quartiers (en savoir plus)</p>"},{"location":"UTILISATION/mode_emploi/fiches_contact.html#enregistrer-un-nouvel-individu","title":"Enregistrer un nouvel individu","text":"<p>Attention</p> <p>N'utilisez pas le menu <code>Contact</code> -&gt; <code>Nouveau particulier</code> mais suivez la proc\u00e9dure ci-dessous. Elle utilise un formulaire sp\u00e9cialement \u00e9labor\u00e9 pour les paroisses.</p> <p>Pour cr\u00e9er un nouveau \"individu\" vous devez passer par la page d'accueil (voir La page d'accueil) et cliquez sur l'ic\u00f4ne \"Nouveau Individu / Particulier\".</p> <p>Contrairement \u00e0 la fiche foyer, nous avons ici un large panel d'informations que nous pouvons enregistrer.</p> <p></p> <p>Le premier \u00e9l\u00e9ment important est de relier l'individu \u00e0 une fiche \"foyer\" en choisissant le foyer d'appartenance.</p> <p>Cr\u00e9ation de la fiche d'un enfant</p> <p>Si vous ajoutez un enfant, en choisissant ses parents et ses fr\u00e8res et soeurs, les relations seront automatiquement \u00e9tablies.</p> <p>Il est important de respecter quelques r\u00e8gles :</p> <p> Nom de famille : le saisir en majuscules. Si besoin, saisir le nom de naissance dans la case <code>Nom de naissance</code> (en bas \u00e0 gauche, dans la partie <code>Etat Civil</code>).</p> <p> Adresse : elle est automatiquement reprise de l'adresse du foyer. Si ce n'est pas le cas, il faut rattacher l\u2019adresse \u00e0 celle du foyer. Pour cela, tapez dans le champ <code>Choisir le foyer d'appartenance</code> les premi\u00e8res lettres du nom du foyer, puis s\u00e9lectionnez le bon foyer.</p> <p> Courriel : renseignez le ou les adresses mail.</p> <p> T\u00e9l\u00e9phone : renseignez le num\u00e9ro de portable, personnel voire professionnel, en respectant le format international (ex. +33 6 00 11 22 33), avec des espaces entre les num\u00e9ros et nom des points.</p> <p> Compl\u00e9tez les donn\u00e9es Religion (dates de bapt\u00eame, de confirmation de mariage...) et indiquez dans quel paroisse cela a eu lieu. Si vous ne trouvez pas le nom de la paroisse, choisissez <code>Autres</code>. Puis apr\u00e8s la cr\u00e9ation de la fiche, rajoutez une <code>Note</code> pour indiquer le nom exact.</p> <p> Compl\u00e9tez ensuite l'\u00e9tat civil avec les \u00e9l\u00e9ments dont vous disposez.</p> <p> Ne n\u00e9gligez pas la rubrique Comp\u00e9tences lorsqu'elles sont connues, pour inviter par exemple la personne par la suite \u00e0 venir renforcer la chorale ou un groupe de musique.</p> <p> Une fois la fiche cr\u00e9\u00e9e, ajoutez une photo de la personne si vous en avez une (format conseill\u00e9 : 250 x 370 pixels, en 72 dpi)</p> <p>N'h\u00e9sitez pas \u00e0 consulter les recommandations sur le lien avec la paroisse si vous avez un doute sur le lien \u00e0 \u00e9tablir. (En savoir plus)</p> <p>Les \u00e9l\u00e9ments sur la S\u00e9curit\u00e9 sociale, le Guso, ou pour savoir si la personne est fonctionnaire, ne sont r\u00e9ellement utiles que pour la fiche d'un musicien r\u00e9mun\u00e9r\u00e9 par la paroisse.</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html","title":"Administration locale de la base de donn\u00e9es","text":""},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#gestion-de-la-base-de-donnees","title":"Gestion de la base de donn\u00e9es","text":"<p>Cette partie est destin\u00e9e aux administrateurs locaux de la base de donn\u00e9es.</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#gerer-les-acces-a-civiparoisse","title":"G\u00e9rer les acc\u00e8s \u00e0 CiviParoisse","text":""},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#donner-acces-a-la-base-de-donnees-pour-un-nouvel-utilisateur","title":"Donner acc\u00e8s \u00e0 la base de donn\u00e9es pour un nouvel utilisateur","text":"<p>Vous pouvez \u00e0 tout moment donner acc\u00e8s \u00e0 la base de donn\u00e9es \u00e0 un utilisateur.</p> <p>Attention</p> <p>Il est fortement conseill\u00e9 de toujours mettre en place des acc\u00e8s nominatifs, au nom de l'utilisateur. Evitez par exemple un acc\u00e8s Secr\u00e9tariat paroissial qui ne vous permettra pas d'identifier pr\u00e9cis\u00e9ment qui a travaill\u00e9 sur le fichier, et dont le mot de passe ne sera pas forc\u00e9ment chang\u00e9 lors du changement de secr\u00e9taire.</p> <p>Pour mettre en place l\u2019acc\u00e8s :</p> <ol> <li>Au pr\u00e9alable<ul> <li>Si ce n\u2019est pas encore fait, cr\u00e9er la fiche de l\u2019utilisateur dans la base de donn\u00e9es</li> <li>Si ce n\u2019est pas encore fait, renseigner l\u2019adresse mail de l\u2019utilisateur</li> </ul> </li> <li>Ouvrir la fiche Particulier de la personne (pas la fiche Foyer)</li> <li>Cliquer sur le bouton Actions de la fiche </li> <li>Choisir l\u2019entr\u00e9e Cr\u00e9er un compte utilisateur </li> <li>Renseigner l\u2019\u00e9cran Cr\u00e9er un compte utilisateur<ul> <li>Nom utilisateur : c\u2019est le nom qui servira pour se connecter. Il est recommand\u00e9 de choisir le pr\u00e9nom + nom de l\u2019utilisateur</li> <li>Mot de passe : il est important que le mot de passe contienne au moins une majuscule, une minuscule, un chiffre et un caract\u00e8re sp\u00e9cial. Pour garantir la s\u00e9curit\u00e9 de vos donn\u00e9es, la longueur doit \u00eatre de plus de 12 caract\u00e8res.</li> <li>Cliquer sur le bouton Ajouter</li> </ul> </li> <li>Cliquer sur le nom de l\u2019utilisateur dans l\u2019\u00e9cran de confirmation </li> <li>Cliquer sur le bouton Actions de la fiche </li> <li>Cliquer sur Compte de l'utilisateur </li> <li>Cliquer sur l\u2019onglet Modifier </li> <li>Dans la partie R\u00f4les, choisir le ou les r\u00f4le(s) \u00e0 donner \u00e0 l'utilisateur, parmi la liste suivante<ul> <li>Administrateur : possibilit\u00e9 de g\u00e9rer tout le site (Drupal comme CiviCRM). R\u00e9serv\u00e9 \u00e0 l'\u00e9quipe technique de CiviParoisse. Attention, il ne faut en aucun cas attribuer ce r\u00f4le \u00e0 un nouvel utilisateur.</li> <li>Gestionnaire paroissial : acc\u00e8s \u00e0 l'ensemble de CiviParoisse en consultation et en modification, sans les donn\u00e9es financi\u00e8res, ni l'envoi de mailing de masse ou l'administration du site. Ce r\u00f4le permet \u00e9galement de cr\u00e9er et g\u00e9rer les droits d'acc\u00e8s \u00e0 CiviParoisse.</li> <li>Utilisateur paroissial : acc\u00e8s \u00e0 CiviParoisse uniquement en consultation, sans les donn\u00e9es financi\u00e8res, et sans l'envoi de mailing de masse. Ce r\u00f4le peut tout de m\u00eame enregistrer des \u00e9v\u00e9nements, des activit\u00e9s, des notes. Il peut pr\u00e9parer des mailings, sans pouvoir en valider l'envoi. Il peut aussi cr\u00e9er de nouvelles fiches (sans pouvoir les modifier).</li> </ul> </li> <li>Il est \u00e9galement possible de rajouter les options suivantes :<ul> <li>Gestionnaire Mot de passe : option qui permet de r\u00e9initialiser les mots de passe des utilisateurs. Attention, cette option permet \u00e9galement de cr\u00e9er et g\u00e9rer les droits d'acc\u00e8s \u00e0 CiviParoisse.</li> <li>Gestion financi\u00e8re : option qui permet de modifier et consulter les donn\u00e9es financi\u00e8res (dons, ...).</li> <li>Gestion des mailing : option qui permet d'envoyer les mailings de masse.</li> </ul> </li> <li>Cliquer sur Enregistrer</li> <li>Transmettre le mot de passe \u00e0 l\u2019utilisateur, il pourra se connecter imm\u00e9diatement.  Transmettez toujours s\u00e9par\u00e9ment le nom Utilisateur et le mot de passe.</li> </ol> <p>Attention</p> <p>Selon le r\u00f4le que vous donnez \u00e0 l'utilisateur, il aura acc\u00e8s \u00e0 plus ou moins d'informations stock\u00e9es dans la base de donn\u00e9es. Il est donc fortement recommand\u00e9 de ne pas diffuser largement un r\u00f4le Gestionnaire, ceci afin de pr\u00e9server la confiance de vos paroissiens quant aux donn\u00e9es personnelles que vous recueillez.</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#modifier-son-mot-de-passe-ou-celui-dun-utilisateur","title":"Modifier son mot de passe, ou celui d'un utilisateur","text":"<p>Attention</p> <p>Votre mot de passe est la cl\u00e9 d'entr\u00e9e \u00e0 toutes les donn\u00e9es stock\u00e9es sur votre CiviParoisse. Lorsque vous choisissez un nouveau mot de passe, soyez tr\u00e8s prudent : le mot de passe doit faire plus de 12 caract\u00e8res, contenir au moins une majuscule, une minuscule, un chiffre et un caract\u00e8re sp\u00e9cial. Ce nouveau mot de passe ne doit pas non plus \u00eatre trop simple : \u00e9vitez les dates, les noms de famille ou les pr\u00e9noms, les mots courants.</p> <p>Astuce</p> <p>Le site de la CNIL propose une aide \u00e0 la cr\u00e9ation de mots de passe forts : lien vers le site de la CNIL</p> <p>Pour changer son propre mot de passe :</p> <ol> <li>Allez sur votre fiche Particulier</li> <li>Cliquez sur le bouton Actions de la fiche </li> <li>Cliquez sur Compte de l'utilisateur </li> <li>Cliquez sur l\u2019onglet Modifier </li> <li>Saisissez votre Mot de passe actuel</li> <li>Saisissez le nouveau mot de passe dans Mot de passe un peu plus bas</li> <li>Saisissez-le \u00e0 nouveau dans Confirmer le mot de passe</li> <li>V\u00e9rifiez que la S\u00e9curit\u00e9 du mot de passe soit \u00e0 Fort. Si ce n'est pas le cas, choisissez un mot de passe diff\u00e9rent</li> <li>En bas de l'\u00e9cran, cliquez sur le bouton Enregistrer. Le mot de passe est chang\u00e9</li> </ol> <p>Pour changer le mot de passe d'un autre utilisateur :</p> <ol> <li>Allez sur la ficher Particulier de l'utilisateur concern\u00e9</li> <li>D\u00e9roulez les points 2 \u00e0 9 list\u00e9s ci-dessous</li> <li>Communiquez le mot de passe \u00e0 l'utilisateur.</li> </ol> <p>Attention</p> <p>Communiquez toujours s\u00e9par\u00e9ment le Nom Utilisateur et le Mot de passe. Envoyez toujours ces informations par deux canaux diff\u00e9rents.</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#supprimer-lacces-a-la-base-de-donnees-a-un-utilisateur-existant","title":"Supprimer l\u2019acc\u00e8s \u00e0 la base de donn\u00e9es \u00e0 un utilisateur existant","text":"<p>Attention</p> <p>Il est important de v\u00e9rifier r\u00e9guli\u00e8rement que la liste des personnes ayant acc\u00e8s \u00e0 la base de donn\u00e9es corresponde bien \u00e0 la r\u00e9alit\u00e9 de votre paroisse. Un utilisateur ayant toujours acc\u00e8s \u00e0 la base de donn\u00e9es alors qu\u2019il ne s\u2019en sert plus repr\u00e9sente un risque potentiel pour la s\u00e9curit\u00e9 de votre base de donn\u00e9es. Il est donc important de supprimer rapidement les acc\u00e8s qui ne sont plus n\u00e9cessaires.</p> <p>Pour supprimer l\u2019acc\u00e8s \u00e0 un utilisateur existant :</p> <ol> <li>Ouvrir la fiche Particulier de la personne (pas la fiche Foyer)</li> <li>Cliquer sur le bouton Actions de la fiche </li> <li>Cliquer sur Compte de l'utilisateur </li> <li>Cliquer sur l\u2019onglet Modifier </li> <li>Dans la partie Statut, choisir Bloqu\u00e9 </li> <li>Dans la partie R\u00f4les, d\u00e9cocher le ou les r\u00f4le(s)</li> <li>Cliquer sur Enregistrer</li> </ol> <p>Le nom de l\u2019utilisateur dont vous voulez supprimer l\u2019acc\u00e8s restera affich\u00e9 dans la liste des personnes. De m\u00eame, sa fiche restera pr\u00e9sente dans la base de donn\u00e9es. Ceci permet de conserver l\u2019historique des modifications faite par cet utilisateur.</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#lister-lensemble-des-utilisateurs-de-la-base-de-donnees","title":"Lister l'ensemble des utilisateurs de la base de donn\u00e9es","text":"<p>En cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/gestion_base_donnees.html#modifier-la-liste-des-quartiers","title":"Modifier la liste des Quartiers","text":"<p>Dans le bandeau noir du haut, cliquer sur <code>Paroisse</code> et choisissez la ligne <code>Param\u00e8tres</code>. Dans la page des Param\u00e8tres de CiviParoisse qui s'ouvre, s\u00e9lectionner  <code>Modifier la liste des Quartiers</code>.</p> <ul> <li> <p>Si vous souhaitez modifier le nom d'un quartier :</p> <ol> <li>Cliquer sur le nom du quartier \u00e0 modifier</li> <li>Saisir le nouveau nom</li> <li>Cliquer sur la fl\u00e8che verte sous le nom</li> </ol> </li> <li> <p>Si vous souhaitez ne plus utiliser un quartier existant :</p> <ol> <li>V\u00e9rifier au pr\u00e9alable qu'aucun Foyer n'est encore attach\u00e9 \u00e0 ce quartier</li> <li>Dans la colonne Visible ?, cliquer sur <code>Oui</code></li> <li>Choisir le bouton <code>Non</code></li> <li>Cliquer sur la fl\u00e8che verte</li> </ol> </li> <li> <p>Si vous souhaitez utiliser \u00e0 nouveau un quartier actuellement Non visible :</p> <ol> <li>Dans la colonne Visible ?, cliquer sur <code>Non</code></li> <li>Choisir le bouton <code>Oui</code></li> <li>Cliquer sur la fl\u00e8che verte</li> </ol> </li> </ul>"},{"location":"UTILISATION/mode_emploi/gestion_des_dons_et_edition_des_recus_fiscaux.html","title":"Gestion des dons et \u00e9dition des re\u00e7us et \u00e9dition des re\u00e7us fiscaux","text":""},{"location":"UTILISATION/mode_emploi/gestion_des_dons_et_edition_des_recus_fiscaux.html#enregistrer-des-dons","title":"Enregistrer des dons","text":"<p>Attention</p> <p>Les dons sont uniquement \u00e0 enregistrer sur une fiche Individu. L'enregistrement du don sur une fiche Foyer ne permettra pas l'\u00e9dition du re\u00e7u fiscal le moment venu.</p> <p>Pour enregistrer un don, proc\u00e9dez comme suit :</p> <ol> <li>Ouvrez la fiche Individu du donateur.</li> <li>Cliquez sur l'onglet Contributions.</li> <li>Cliquez sur le bouton Nouvelle contribution (Ch\u00e8que, esp\u00e8ces, virement, ...).</li> <li>Dans la fen\u00eatre qui s'ouvre, s\u00e9lectionnez le Type d'op\u00e9rations comptables Dons.</li> <li>Indiquez le Montant total.</li> <li>Renseignez la Date de la contribution (il n'est pas n\u00e9cessaire de pr\u00e9ciser l'heure ).</li> <li>S\u00e9lectionnez le Moyen de paiement utilis\u00e9 par le donateur.  La case Envoyer un re\u00e7u n'est pas \u00e0 cocher pour le moment.</li> <li>Cliquez sur Enregistrer.</li> <li>En cliquant sur Enregistrer et nouvelle entr\u00e9e, vous pouvez saisir un autre don provenant du m\u00eame donateur.</li> </ol> <p> Pour le moment, vous devez enregistrer les dons en s\u00e9lectionnant chaque fiche individuellement. Ult\u00e9rieurement, il sera possible de les enregistrer en masse.</p>"},{"location":"UTILISATION/mode_emploi/gestion_des_dons_et_edition_des_recus_fiscaux.html#editer-les-recus-fiscaux","title":"Editer les re\u00e7us fiscaux","text":"<p>Partie en cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/groupes.html","title":"G\u00e9rer les groupes","text":""},{"location":"UTILISATION/mode_emploi/groupes.html#gerer-les-groupes","title":"G\u00e9rer les groupes","text":"<p>Les groupes sont une autre fa\u00e7on d'\u00e9tablir un lien entre des personnes, de dire qu'elles partagent quelque chose, une activit\u00e9 par exemple. Vous pouvez ainsi cr\u00e9er un groupe qui recense tous les membres de la chorale, un autre pour les cat\u00e9ch\u00e8tes, ou encore pour les participants au groupe biblique.</p>"},{"location":"UTILISATION/mode_emploi/groupes.html#les-deux-sortes-de-groupes","title":"Les deux sortes de groupes","text":"<ul> <li> <p>Un groupe statique est compos\u00e9 des contacts que vous rajouterez manuellement.</p> </li> <li> <p>Dans un groupe dynamique, vous n'ajoutez pas les personnes manuellement, mais elles se retrouvent automatiquement dans ce groupe de par leur \u00e2ge, une relation ou tout autre \u00e9l\u00e9ment que vous aurez d\u00e9fini au pr\u00e9alable.</p> </li> </ul>"},{"location":"UTILISATION/mode_emploi/groupes.html#creer-un-groupe-statique","title":"Cr\u00e9er un groupe statique","text":"<p>Pour cr\u00e9er un groupe statique, il vous suffit d'aller dans le menu <code>Contacts</code>, puis <code>Gestion des groupes</code>.</p> <p>En cliquant sur <code>Ajouter un groupe</code> vous obtenez la fen\u00eatre suivante :</p> <p></p> <p>Il est recommand\u00e9 d'utiliser un nom explicite et d'ajouter une description pour que la personne qui n'identifie pas le groupe par son nom puisse retrouver le bon groupe par un texte plus long et d\u00e9taill\u00e9.</p> <p>Attention</p> <p>Ne cochez pas <code>contr\u00f4le d'acc\u00e8s</code>. En revanche, si vous envisagez d'envoyer des courriels aux membres du groupe, il sera indispensable de cocher <code>Liste de diffusion</code>. Si vous voulez juste visualiser les membres sans leur \u00e9crire, ne cocher aucun des deux.</p> <p>Vous pouvez m\u00eame, comme vous l'avez sans doute remarqu\u00e9, cr\u00e9er des sous-groupes en indiquant lors de la cr\u00e9ation du sous-groupe quel est son groupe parent.</p> <p>Vous ajoutez ensuite des contacts au groupe depuis la fiche de chaque contact, onglet <code>Groupes</code>. Vous pouvez \u00e9galement faire des rajouts en nombre, \u00e0 partir d'un \u00e9cran <code>Recherches</code>.</p> <p>C'est depuis le menu <code>G\u00e9rer les groupes</code> que vous pouvez visualiser les membres en cliquant sur <code>Contacts</code> \u00e0 la fin de la ligne du groupe.</p>"},{"location":"UTILISATION/mode_emploi/groupes.html#creer-un-groupe-dynamique","title":"Cr\u00e9er un groupe dynamique","text":"<p>Il s'agit tout d'abord d'effectuer une recherche (voir Faire des recherches pour des conseils pour vous aider \u00e0 retrouver les fiches selon divers crit\u00e8res).</p> <p>Une fois la liste des contacts obtenue, s\u00e9lectionnez tout d'abord l'ensemble des contacts en cliquant sur <code>S\u00e9lection des enregistrements : Les x trouv\u00e9s</code>. Puis cliquez sur <code>Actions</code> et choisissez <code>Groupe - cr\u00e9er un groupe dynamique</code>, donnez lui un nom, une description et cochez ou non <code>Liste de diffusion</code> D\u00e9sormais, d\u00e8s qu'un contact rempli les crit\u00e8res de la recherche il est automatiquement ajout\u00e9 au groupe dynamique, et inversement, si pour un contact du groupe un crit\u00e8re n'est plus rempli, il ne sera plus membre du groupe dynamique.</p> <p>Ne pas supprimer un contact manuellement </p> <p>Pour assurer le bon fonctionnement des groupes dynamiques, il est important de ne jamais supprimer manuellement un contact pr\u00e9sent dans un Groupe dynamique. Vous risquerez de perturber gravement les prochaines mises \u00e0 jour du groupe.</p>"},{"location":"UTILISATION/mode_emploi/groupes.html#inscrire-dans-un-groupe","title":"Inscrire dans un groupe","text":"<p>Partie en cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/groupes.html#enlever-dun-groupe","title":"Enlever d'un groupe","text":"<p>Partie en cours d'\u00e9criture</p> <p>N'utilisez pas la suppression</p> <p>Afin de conserver l'historique des participations aux diff\u00e9rents groupes de la paroisse, n'utilisez jamais la touche Supprimer.</p>"},{"location":"UTILISATION/mode_emploi/introduction.html","title":"Introduction","text":""},{"location":"UTILISATION/mode_emploi/introduction.html#introduction","title":"Introduction","text":""},{"location":"UTILISATION/mode_emploi/introduction.html#quelques-principes-de-base","title":"Quelques principes de base","text":""},{"location":"UTILISATION/mode_emploi/introduction.html#trois-types-de-fiches-a-distinguer-dans-la-base","title":"Trois types de fiches \u00e0 distinguer dans la base","text":"<p>Votre fichier paroissial va s'articuler autour de trois types de fiches dont deux que vous connaissez peut \u00eatre d\u00e9j\u00e0 par l'utilisation de votre t\u00e9l\u00e9phone ou logiciel pour g\u00e9rer vos courriels : individu et organisation. CiviParoisse ajoute un troisi\u00e8me type : le foyer .</p> <p>Pas d'inqui\u00e9tude, vous allez pouvoir identifier le type de contact ais\u00e9ment par son ic\u00f4ne :</p> <ul> <li>Le foyer  qui est le lieu o\u00f9 vivent un certain nombre de personnes ayant au minimum comme relation d'habiter dans le m\u00eame foyer fiscal, mais qui souvent auront aussi des liens familiaux, que CiviParoisse sait enregistrer.</li> <li>L'individu  qui, comme son nom l'indique, va \u00eatre la fiche de contact de chaque individu que nous estimons important de garder dans notre fichier.</li> <li>L'organisation  qui pourra \u00eatre la fiche de contact d'une paroisse, ou d'une association avec laquelle on est souvent en relation, ou de l'entreprise qui entretient le chauffage du presbyt\u00e8re...</li> </ul>"},{"location":"UTILISATION/mode_emploi/introduction.html#quelles-donnees-vont-dans-quelle-fiche","title":"Quelles donn\u00e9es vont dans quelle fiche ?","text":"<p>Dans la fiche \u00ab Foyer \u00bb sont \u00e0 noter les donn\u00e9es qui ne changent pas d\u2019un individu \u00e0 l\u2019autre au sein d'un m\u00eame foyer. Et les donn\u00e9es personnelles sont \u00e0 indiquer dans la fiche \u00ab Individu \u00bb. Le tableau ci-dessous montre de fa\u00e7on non exhaustive la r\u00e9partition.</p> Fiches  Foyer  Individu Adresse postale \u2705 (lien vers l'adresse du foyer) T\u00e9l\u00e9phone fixe \u2705 Site Internet \u2705 (si familial) \u2705 (si individuel) Mode de communication pr\u00e9f\u00e9r\u00e9 \u2705 \u2705 Formules de communication foyer \u2705 Informations compl\u00e9mentaires (quartier) \u2705 Mode de distribution du journal \u2705 Courriel \u2705 T\u00e9l\u00e9phone portable \u2705 T\u00e9l\u00e9phone professionnel \u2705 Message instantan\u00e9e \u2705 Formules de communication individuelles \u2705 Etat civil \u2705 Informations religion \u2705 Comp\u00e9tences \u2705 Groupes \u2705 Relation avec la paroisse \u2705 Participation \u00e0 des \u00e9v\u00e9nements \u2705 Dons \u00e0 la paroisse \u2705 <p>Pour en savoir plus sur la gestion des fiches, cliquez ici.</p>"},{"location":"UTILISATION/mode_emploi/introduction.html#relations-et-groupes","title":"Relations et groupes","text":"<p>CiviParoisse ne permet pas seulement de cr\u00e9er des fiches de contact, mais \u00e9galement d'\u00e9tablir des liens entres les fiches et aussi de les rassembler en groupes.</p> <p>Un fils aura ainsi une relation comme enfant de avec ses parents, un b\u00e9n\u00e9vole sera b\u00e9n\u00e9vole de pour une association ou un groupe d'activit\u00e9.</p> <p>Il vous est \u00e9galement possible de constituer un groupe (dynamique ou non, voir le point d\u00e9di\u00e9 aux groupes pour plus de d\u00e9tails). Le groupe pourra par exemple recenser tous les b\u00e9n\u00e9voles de la paroisse, un autre les membres de la chorale, un autre encore les dames de l'ouvroir. Un groupe est de plus un bon moyen pour rassembler l'ensemble des personnes \u00e0 qui vous allez envoyer r\u00e9guli\u00e8rement un courriel (par exemple les membres du conseil presbyt\u00e9ral).</p> <p>Attention</p> <p>Il est important de saisir toutes les relations d\u00e8s la cr\u00e9ation d'une fiche, et de les faire \u00e9voluer dans le temps, pour bien identifier les interactions entre les personnes.</p> <p>Vous trouverez plus d'information sur les relations en cliquant ici, et sur les groupes en cliquant ici.</p>"},{"location":"UTILISATION/mode_emploi/introduction.html#interface-de-civiparoisse","title":"Interface de CiviParoisse","text":""},{"location":"UTILISATION/mode_emploi/introduction.html#la-page-daccueil","title":"La page d'accueil","text":"<p>L'adresse de votre page d'accueil est du genre : https://nomparoisse.uepal.net Elle devrait ressembler \u00e0 ceci : </p> <p>Plusieurs \u00e9l\u00e9ments sont \u00e0 identifier :</p> <ul> <li>En 1, nous avons la loupe  qui nous servira \u00e0 effectuer des recherches ponctuelles (fiche d'une personne donn\u00e9e, fiches de toutes une famille, etc...)</li> <li>En 2, le lien <code>Accueil</code> qui nous permettra toujours de revenir \u00e0 cette page en cliquant dessus.</li> <li>L\u2019ic\u00f4ne 3 nous permet d\u2019enregistrer un nouveau foyer en suivant le cadre sp\u00e9cifique \u00e0 CiviParoisse. Il est indispensable de passer par ce cadre.</li> <li>L\u2019ic\u00f4ne 4 permet d\u2019enregistrer un nouvel individu en suivant le cadre sp\u00e9cifique \u00e0 CiviParoisse, si la fiche \u00ab Foyer \u00bb dont il fait partie existe d\u00e9j\u00e0. Sinon passer d\u2019abord par le point 3.</li> <li>L\u2019ic\u00f4ne 5 nous permet d\u2019enregistrer une nouvelle entreprise ou association en suivant le cadre sp\u00e9cifique \u00e0 CiviParoisse. Il est indispensable de passer par ce cadre.</li> <li>Le point 6 vous permet d\u2019avoir une liste des anniversaires \u00e0 venir, pour par exemple envoyer un petit mot et ainsi garder le lien avec les paroissiens.</li> <li>Le point 7 vous permet d\u2019\u00e9tablir facilement diff\u00e9rentes listes. (En savoir plus)</li> <li>Le point 8 donne acc\u00e8s \u00e0 plusieurs outils permettant de v\u00e9rifier que le fichier paroissial est complet et si non, d\u2019y rem\u00e9dier. Il est conseill\u00e9 de passer par ce point plusieurs fois dans l\u2019ann\u00e9e. (En savoir plus)</li> <li>Le point 9 donne acc\u00e8s au mode d\u2019emploi de CiviParoisse.</li> <li>Le point 10 indique les anniversaires des sept prochains jours, pour vous faciliter le lien avec vos paroissiens</li> <li>Enfin, le point 11 vous donne acc\u00e8s au menu principal de CiviParoisse.</li> </ul>"},{"location":"UTILISATION/mode_emploi/introduction.html#le-menu-principal-de-civiparoisse","title":"Le menu principal de CiviParoisse","text":"<p>Le menu de CiviParoisse commence par l\u2019ic\u00f4ne d\u2019une loupe \u00e0 gauche. C\u2019est \u00e0 partir de lui que vous allez pouvoir r\u00e9aliser les diff\u00e9rentes op\u00e9rations sur votre fichier paroissial.</p> <p>Passons en revue les diff\u00e9rents \u00e9l\u00e9ments :</p> El\u00e9ment du menu Description  La loupe Raccourci qui permet de rechercher rapidement une fiche, sans passer par une fonction \u00ab rechercher \u00bb plus \u00e9volu\u00e9e, mais en choisissant sur quoi porte la recherche.  L\u2019ic\u00f4ne en forme de triangle vert Est anim\u00e9e lorsque CiviParoisse est en train d\u2019effectuer une op\u00e9ration. Elle permet une recherche rapide sur tout texte entr\u00e9. Elle permet de revenir \u00e0 l\u2019accueil.  Rechercher Vous permet soit une recherche simple, soit une recherche avanc\u00e9e, soit encore une recherche dans le contenu. Ce sera souvent par l\u00e0 que vous chercherez \u00e0 acc\u00e9der \u00e0 une fiche.  Contacts N\u2019est pas \u00e0 utiliser pour cr\u00e9er une fiche, puisque nous passons par un formulaire sp\u00e9cifique. C\u2019est en revanche ici que vous pouvez g\u00e9rer les groupes (B\u00e9n\u00e9voles, Acat, etc.).  Contributions Va nous permettre d\u2019enregistrer les dons puis d\u2019\u00e9diter les re\u00e7us fiscaux.  \u00c9v\u00e9nements Permet de cr\u00e9er un \u00e9v\u00e9nement (voyage \u00e0 Wittenberg ou repas paroissial, par exemple) et de g\u00e9rer tout ce qui y sera li\u00e9.  Mailings Permet, comme son nom l\u2019indique, d\u2019envoyer des courriels.  Adh\u00e9sions Permet d\u2019enregistrer une nouvelle adh\u00e9sion (mais il est conseill\u00e9 de le faire au moment de la cr\u00e9ation de la fiche individuelle) et d\u2019\u00e9tablir des statistiques sur les adh\u00e9sions (d\u2019o\u00f9 l\u2019importance de le faire \u00e0 la cr\u00e9ation pour avoir des dates r\u00e9alistes).  Rapports Permet d\u2019\u00e9tablir diverses statistiques.  Administrer Permet de param\u00e9trer CiviParoisse. Ce menu est r\u00e9serv\u00e9 aux personnes ayant les droits d'administration.  R\u00e9cent Vous permet d'acc\u00e9der aux derni\u00e8res fiches consult\u00e9es ou cr\u00e9\u00e9es.  Paroisse Reprend les entr\u00e9es de menu que vous trouvez en page d'accueil, et un menu de param\u00e9trage sp\u00e9cifique. <p>Vous remarquerez que sous ce menu, \u00e0 gauche, CiviParoisse vous indique toujours o\u00f9 vous \u00eates.</p>"},{"location":"UTILISATION/mode_emploi/introduction.html#linterface-de-la-fiche-foyer","title":"L'interface de la fiche \"foyer\"","text":"<p>Vous l'avez sans doute d\u00e9j\u00e0 remarqu\u00e9, une fiche foyer a comme une ic\u00f4ne une maison. C'est sur sur cette fiche que nous enregistrons toutes les informations communes aux diff\u00e9rents membres d'un foyer : l'adresse, le num\u00e9ro de t\u00e9l\u00e9phone fixe ou encore le quartier pour le portage du bulletin paroissial. Voici un aper\u00e7u d'une fiche foyer sur son onglet <code>Synth\u00e8se</code> :</p> <p></p> <p>Nous d\u00e9taillons les diff\u00e9rentes onglets \u00e0 partir de la fiche \"individu\".</p>"},{"location":"UTILISATION/mode_emploi/introduction.html#linterface-de-la-fiche-individu","title":"L'interface de la fiche \"individu\"","text":"<p>Remarquez d'embl\u00e9e deux choses :</p> <ul> <li> <p>une fiche de contact s'ouvre sur l'onglet <code>Synth\u00e8se</code> qui va vous afficher les \u00e9l\u00e9ments principaux de la fiche.</p> </li> <li> <p>elle se d\u00e9coupe en zones (ou onglets) et si vous cliquez dans l'une des zones (ou onglets) vous pouvez modifier les informations de cette zone. Notez que vous pouvez modifier l'ensemble en cliquant sous le nom et pr\u00e9nom sur <code>Modifier</code>.</p> </li> </ul> <p>Elle comporte quelques \u00e9l\u00e9ments communs avec la ficher \"foyer\", auxquels s'ajoutent, du fait que nous sommes l\u00e0 sur une fiche individu :</p> <ul> <li>Son adresse courriel personnelle s\u2019il en dispose d\u2019une ; de m\u00eame que son num\u00e9ro de t\u00e9l\u00e9phone mobile et son num\u00e9ro de t\u00e9l\u00e9phone professionnel le cas \u00e9ch\u00e9ant.</li> <li>L\u2019adresse du foyer auquel il est rattach\u00e9 (nous en dirons plus par la suite).</li> <li>Son genre, sa date de naissance et son \u00e2ge.</li> <li>En bas \u00e0 gauche les informations dont nous disposons sur son \u00e9tat civil.</li> <li>En bas \u00e0 droite les informations dont nous disposons sur sa religion, date et lieu de bapt\u00eame, etc.</li> </ul> <p>Voyons maintenant les diff\u00e9rents onglets de la fiche :</p> <p>Ils sont en bleu si la rubrique contient une information, en gris s\u2019il n\u2019y en a pas.</p> Onglet Description  Synth\u00e8se Affiche une synth\u00e8se sur la fiche et correspond \u00e0 la vue ci-dessus.  Contributions Affiche la liste des dons de la personne, et permet d\u2019en ajouter.  Adh\u00e9sion Rubrique qui contient l\u2019indication du lien avec la paroisse et permet de l\u2019ajouter ou la modifier.  \u00c9v\u00e9nements Indique si la personne participe \u00e0 un \u00e9v\u00e9nement de la paroisse.  Activit\u00e9s Consigne toute interaction avec la personne (changement sur sa fiche de type \u00ab adh\u00e9sion \u00bb, envoi d\u2019un courriel, visite, contact t\u00e9l\u00e9phonique, etc.).  Relations Indique toutes les relations connues de cette fiche avec d\u2019autres fiches (\u00ab Parent de \u00bb, \u00ab Membre de \u00bb, \u00ab Chef de famille de \u00bb, etc.). C\u2019est l\u00e0 o\u00f9 nous pouvons en ajouter, supprimer ou modifier.  Groupes Indique si l\u2019individu fait partie d\u2019un groupe de la paroisse ; et permet d\u2019ajouter, modifier ou supprimer cet \u00e9tat.  Notes Rubrique o\u00f9 nous enregistrons toute information utile ne trouvant pas sa place ailleurs. Il est utile de donner un nom explicite \u00e0 la note cr\u00e9\u00e9e et d\u2019indiquer la date de cr\u00e9ation.  \u00c9tiquettes Indique les \u00e9tiquettes attribu\u00e9es \u00e0 l\u2019individu (Officiel, Maire, etc.).  Journal des modifications Enregistre automatiquement toute modification r\u00e9alis\u00e9e sur la fiche, m\u00eame mineure."},{"location":"UTILISATION/mode_emploi/introduction.html#comment-modifier-une-fiche","title":"Comment modifier une fiche ?","text":"<p>Deux solutions s\u2019offrent \u00e0 nous :</p> <ul> <li>Cliquez approximativement \u00e0 l\u2019endroit o\u00f9 se trouve l\u2019information que vous voulez changer ou enregistrer. Ne pas oublier de cliquer sur \u00ab Enregistrer \u00bb avant de quitter.</li> <li>Cliquez sur \u00ab Modifier \u00bb (en dessous du nom de la fiche), ce qui affichera la fiche au mode \u00e9dition.</li> </ul>"},{"location":"UTILISATION/mode_emploi/introduction.html#autres-elements-des-fiches","title":"Autres \u00e9l\u00e9ments des fiches","text":"<ul> <li>Le bouton \u00ab Actions \u00bb : plac\u00e9 sous le nom de la fiche, il permet d\u2019effectuer rapidement certaines actions qui prendront cette fiche comme partie prenante : pr\u00e9voir une r\u00e9union, appeler la personne, envoyer un courriel, supprimer la fiche, etc.<ul> <li> L'action \u00ab Supprimer \u00bb n\u2019est \u00e0 utiliser que si l\u2019on est certain que cette personne a quitt\u00e9 la paroisse et que nous n\u2019aurons plus de lien avec elle ! Vigilance donc. La fiche est plac\u00e9e dans une corbeille accessible uniquement par les personnes ayant le r\u00f4le de Gestionnaire paroissial.</li> </ul> </li> <li>Les boutons \u00ab Pr\u00e9c\u00e9dent / Suivant \u00bb : Ils permettent de naviguer entre les fiches, class\u00e9es par ordre alphab\u00e9tique.</li> </ul>"},{"location":"UTILISATION/mode_emploi/introduction.html#quitter-civiparoisse","title":"Quitter CiviParoisse","text":"<p>D\u00e9connexion</p> <p>Il est fortement conseill\u00e9 de se d\u00e9connecter quand vous avez fini d\u2019intervenir sur le fichier paroissial. Ceci est encore plus recommand\u00e9 si vous utilisez un ordinateur ou un t\u00e9l\u00e9phone partag\u00e9 avec d\u2019autres personnes.</p> <p>Pour vous d\u00e9connecter, cliquer sur l'image CiviCRM  en haut \u00e0 gauche de l'\u00e9cran, et choisissez le menu <code>D\u00e9connection</code>.</p>"},{"location":"UTILISATION/mode_emploi/liens_paroisses.html","title":"G\u00e9rer les liens avec la paroisse","text":""},{"location":"UTILISATION/mode_emploi/liens_paroisses.html#gerer-les-liens-avec-la-paroisse","title":"G\u00e9rer les liens avec la paroisse","text":"<p>Dans CiviParoisse, le lien avec la paroisse est g\u00e9r\u00e9 comme une \"Adh\u00e9sion\".</p> <p>Ce lien est important</p> <p>Pour assurer le bon fonctionnement de votre base de donn\u00e9es, il est important de renseigner pour chaque individu son lien avec la paroisse, selon les r\u00e8gles ci-dessous. Ne saisissez pas de liens pour les Foyers et les Organisations.</p>"},{"location":"UTILISATION/mode_emploi/liens_paroisses.html#les-4-types-de-liens","title":"Les 4 types de liens","text":"<ul> <li>Electeur : la personne est inscrite sur la liste des \u00e9lecteurs de votre paroisse.</li> <li>Inscrit enfant : la personne a moins de 18 ans.</li> <li>Ami de la paroisse : la personne est int\u00e9ress\u00e9e par les activit\u00e9s de la paroisse, sans pour autant \u00eatre \u00e9lecteur (quelques exemples : choriste, conseiller municipal participant \u00e0 la f\u00eate paroissiale, ...).</li> <li>Non int\u00e9ress\u00e9 : la personne n'est pas int\u00e9ress\u00e9e par les activit\u00e9s de la paroisse, mais il est n\u00e9cessaire de conserver ses coordonn\u00e9es (quelques exemples : parent divorc\u00e9 d'un enfant du cat\u00e9chisme, responsable politique du territoire, enfants d'un paroissien \u00e2g\u00e9,...).</li> </ul> <p>Si un enfant participe \u00e0 des activit\u00e9s de la paroisse alors que les parents ne sont pas int\u00e9ress\u00e9s par la paroisse, il est tout de m\u00eame n\u00e9cessaire de cr\u00e9er les fiches Individu des parents, en indiquant alors comme Adh\u00e9sion \"non int\u00e9ress\u00e9\".  Vous aurez ainsi leurs coordonn\u00e9es en cas de besoin.</p>"},{"location":"UTILISATION/mode_emploi/liens_paroisses.html#creer-une-adhesion-sur-une-fiche","title":"Cr\u00e9er une adh\u00e9sion sur une fiche","text":"<p>Chaque personne doit avoir une seule et unique adh\u00e9sion. Celle-ci peut varier dans le temps, mais doit toujours rester unique.</p> <ul> <li>Positionnez-vous sur la fiche Individu de la personne concern\u00e9e.</li> <li>Cliquez sur l'onglet <code>Adh\u00e9sion</code> et cliquez sur le bouton <code>Ajouter une adh\u00e9sion</code>.</li> <li>Dans la liste d\u00e9roulante <code>- s\u00e9lectionner -</code>, choisissez le lien avec la paroisse (cf supra pour plus de d\u00e9tails sur les 4 types de liens).</li> <li>Si besoin, changez la date <code>Membre depuis le</code>.</li> <li>Indiquez la date de d\u00e9but d'adh\u00e9sion, qui est g\u00e9n\u00e9ralement la m\u00eame que la date de la ligne ci-dessus.</li> <li>Cliquez sur le bouton <code>Enregistrer</code>, et v\u00e9rifiez que l'adh\u00e9sion s'affiche \u00e0 l'\u00e9cran.</li> </ul> <p>Attention</p> <p>L'adh\u00e9sion est uniquement \u00e0 inscrire sur une fiche Individu, et jamais sur une fiche Foyer ou Organisation. La paroisse est en lien avec des personnes en chair et en os, pas avec des maisons ou des entreprises ;-)</p>"},{"location":"UTILISATION/mode_emploi/liens_paroisses.html#modifier-une-adhesion-existante","title":"Modifier une adh\u00e9sion existante","text":"<p>Partie en cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/liens_paroisses.html#mettre-fin-a-une-adhesion","title":"Mettre fin \u00e0 une adh\u00e9sion","text":"<ul> <li>Pour mettre fin \u00e0 une adh\u00e9sion, allez dans l'onglet <code>Adh\u00e9sion</code>, et \u00e0 la fin de la ligne de l'adh\u00e9sion, cliquez sur <code>Modifier</code>, renseignez la date de fin.</li> <li>Puis s\u00e9lectionnez la case <code>Forcer / Outrepasser de fa\u00e7on permanente</code> afin que son statut soit modifi\u00e9 dans les listes</li> <li>Passez le statut d'adh\u00e9sion en <code>Annul\u00e9</code>, puis validez.</li> </ul> <p>N'utilisez pas la suppression</p> <p>Afin de conserver l'historique du lien avec la paroisse, n'utilisez jamais le bouton Supprimer.</p>"},{"location":"UTILISATION/mode_emploi/listes.html","title":"Utiliser les listes","text":""},{"location":"UTILISATION/mode_emploi/listes.html#utiliser-les-listes","title":"Utiliser les listes","text":"<p>CiviParoisse met \u00e0 votre disposition des listes pr\u00eates \u00e0 l'emploi. Vous pouvez ainsi obtenir des informations sur vos paroissiens selon de multiples crit\u00e8res, et utiliser ces informations pour interagir avec vos paroissiens.</p>"},{"location":"UTILISATION/mode_emploi/listes.html#a-quoi-servent-ces-listes","title":"A quoi servent ces listes ?","text":"<p>Chaque liste permet d'obtenir en un clic diff\u00e9rentes informations sur vos paroissiens. Vous pensez \u00e9galement choisir d'affiner ces informations en utilisant les crit\u00e8res disponibles en haut de chaque liste. Vous pourrez ensuite effectuer diff\u00e9rentes actions avec ces listes.</p> <p>Exemple</p> <p>Prenons un exemple. Vous souhaitez envoyer une carte d'anniversaire \u00e0 vos jeunes paroissiens. En allant sur la liste Dates d'anniversaires, vous pouvez indiquer un \u00e2ge maximal (18 ans par exemple). La liste vous affichera l'ensemble des jeunes paroissiens, avec leur \u00e2ge, leur date de naissance, leur adresse et leur courriel. Vous pouvez ensuite trier la liste par \u00e2ge ou par date de naissance. Puis vous pouvez s\u00e9lectionner les naissances du mois de janvier, pour leur envoyer un courriel ou \u00e9ventuellement faire un export vers un tableur.</p>"},{"location":"UTILISATION/mode_emploi/listes.html#quelles-listes-sont-disponibles","title":"Quelles listes sont disponibles ?","text":"<p>Vous pouvez acc\u00e9der aux listes en passant par le menu CiviParoisse sur la page d'accueil (cliquer sur <code>Listes</code>), ou par le menu Paroisse dans le bandeau en haut de l'\u00e9cran (cliquer \u00e9galement sur <code>Listes</code>).  </p> <p>Sur la page Listes, plusieurs possibilit\u00e9s vous sont propos\u00e9es :</p> Cat\u00e9gorie Rubrique Titre de la liste Description Paroisse Paroissiens Dates d'anniversaire Affiche les dates d'anniversaires Nouveaux arrivants Affiche les informations sur les nouveaux inscrits \u00e0 la paroisse   Crit\u00e8res par d\u00e9faut : arrivants des 12 derniers mois, sans les Pas Int\u00e9ress\u00e9s Foyers paroissiens Donne la composition de chaque foyer Registre Naissances Affiche les naissances  Affichage du plus r\u00e9cent au plus ancien Bapt\u00eames Affiche les bapt\u00eames  Crit\u00e8re par d\u00e9faut : Affichage des 12 derniers mois Pr\u00e9sentations Affiche les pr\u00e9sentations  Crit\u00e8re par d\u00e9faut : Affichage des 12 derniers mois Confirmations Affiche les confirmations  Crit\u00e8re par d\u00e9faut : Affichage des 12 derniers mois B\u00e9n\u00e9dictions nuptiales Affiche les b\u00e9n\u00e9dictions nuptiales  Crit\u00e8re par d\u00e9faut : Affichage des 12 derniers mois D\u00e9c\u00e8s Affiche la liste des personnes d\u00e9c\u00e9d\u00e9es  Crit\u00e8re par d\u00e9faut : Affichage des 12 derniers mois Elections Liste \u00e9lectorale Affiche la liste des \u00e9lecteurs de la paroisse Conseil Presbyt\u00e9ral Affiche la liste des conseillers presbyt\u00e9raux Communication Foyers Foyers sans adresses mails Affiche les Foyers dont aucun des Chefs de Famille n'a d'adresse mail Individus (sera disponible ult\u00e9rieurement) Distribution Liste de distribution par Quartiers Affiche, par quartier, la liste des foyers et le mode de distribution souhait\u00e9  Crit\u00e8res par d\u00e9faut : mode de distribution = Distribu\u00e9 Liste des Quartiers Permet de renommer les quartiers, et de les g\u00e9rer Groupes Participants Participants \u00e0 un Groupe Affiche la liste des Participants \u00e0 un Groupe  Il faut choisir le Groupe dans la liste d\u00e9roulante, et cliquer sur \"Rechercher\" pour afficher le r\u00e9sultat Dates d'anniversaires Affiche les dates d'anniversaires Parents (sera disponible ult\u00e9rieurement) Comp\u00e9tences (sera disponible ult\u00e9rieurement) Ev\u00e9nements Participants Participants \u00e0 un Ev\u00e9nement Liste des participants \u00e0 l'\u00e9v\u00e9nement choisi  Il faut choisir l'Ev\u00e9nement dans la liste d\u00e9roulante, et cliquer sur \"Rechercher\" pour afficher le r\u00e9sultat Gestion Dons (sera disponible ult\u00e9rieurement) Administration (sera disponible ult\u00e9rieurement)"},{"location":"UTILISATION/mode_emploi/listes.html#quels-sont-les-criteres-de-selection","title":"Quels sont les crit\u00e8res de s\u00e9lection ?","text":"<p>Selon la liste, plusieurs crit\u00e8res de s\u00e9lection vous sont propos\u00e9s en haut de la page. En s\u00e9lectionnant un des crit\u00e8res, la liste sera r\u00e9duite aux fiches comportant ce crit\u00e8re.</p> <p>Exemple</p> <p>En s\u00e9lectionnant Chorale dans le crit\u00e8re <code>Groupes</code> pour la liste <code>Dates d'anniversaires</code>, vous obtiendrez la liste des dates d'anniversaires des Individus inscrits \u00e0 la chorale.</p> <p>Vous pouvez \u00e9galement combiner plusieurs crit\u00e8res, pour affiner votre recherche.  </p> <p>Exemple</p> <p>Reprenons l'exemple ci-dessus. Vous pourriez \u00e9galement s\u00e9lectionner Conseil Presbyt\u00e9ral dans le crit\u00e8re <code>Groupes</code>. Vous obtiendrez ainsi les dates d'anniversaire des Conseillers Presbyt\u00e9raux, ainsi que des participants \u00e0 la Chorale.  Vous pourriez \u00e9galement indiquer un \u00e2ge maximum (par exemple 37 ans) pour rep\u00e9rer les jeunes participants \u00e0 la chorale.</p> <p>Lorsque vous s\u00e9lectionnez un crit\u00e8re, la liste se met \u00e0 jour automatiquement, sans que vous n'ayez besoin de valider votre choix.</p> <p>Pour certaines listes, des crit\u00e8res pr\u00e9-d\u00e9finis sont propos\u00e9s. Ils sont indiqu\u00e9s dans le tableau ci-dessous. Selon votre besoin, vous avez bien s\u00fbr la possibilit\u00e9 de les changer lors de l'utilisation de la liste.</p> <p>Vous trouverez ci-dessous la liste des diff\u00e9rents crit\u00e8res possibles. Tous ne sont pas propos\u00e9s dans toutes les listes.</p> Nom Description Groupes Permet de choisir un ou plusieurs groupes Lien paroissial Permet de s\u00e9lectionner un ou plusieurs des liens d'appartenance \u00e0 la paroisse  (Cliquer ici pour en savoir plus) Genre Permet de choisir le genre de l'Individu Date de naissance Permet de choisir un intervalle de dates, ou une p\u00e9riode (les deux derni\u00e8res ann\u00e9es, par exemple, pour avoir les naissances des 48 derniers mois) Date de cr\u00e9ation Permet de s\u00e9lectionner la date de cr\u00e9ation de la fiche, soit sur un intervalle de dates, soit sur une p\u00e9riode (la derni\u00e8re ann\u00e9e par exemple) Date de (bapt\u00eame, pr\u00e9sentation, confirmation, b\u00e9n\u00e9diction nuptiale) Permet de s\u00e9lectionner un intervalle de dates, ou une p\u00e9riode (les deux derni\u00e8res ann\u00e9es, par exemple, pour avoir les naissances des 48 derniers mois) Mois de naissance Permet de s\u00e9lectionner un ou plusieurs mois de naissance \u00c2ge (minimum) Permet d'indiquer l'\u00e2ge minimum (en ann\u00e9es) souhait\u00e9 \u00c2ge (maximum) Permet d'indiquer l'\u00e2ge maximum (en ann\u00e9es) souhait\u00e9 Liste des Quartiers Permet de s\u00e9lectionner un ou plusieurs de vos quartiers Paroisse Permet de s\u00e9lectionner la paroisse Ev\u00e9nement Permet de choisir un ou plusieurs \u00e9v\u00e9nements R\u00f4le du Participant Permet de choisir le r\u00f4le dans un \u00e9v\u00e9nement Status Permet de choisir le statut dans un \u00e9v\u00e9nement"},{"location":"UTILISATION/mode_emploi/listes.html#que-puis-je-faire-avec-ces-listes","title":"Que puis-je faire avec ces listes ?","text":""},{"location":"UTILISATION/mode_emploi/listes.html#trier-les-informations","title":"Trier les informations","text":"<p>Dans toutes les listes, vous avez la possibilit\u00e9 de trier les informations de fa\u00e7on diff\u00e9rente. Il suffit de cliquer sur le nom de la colonne pour changer l'ordre de tri. Le petit triangle vous indique si le tri se fait de fa\u00e7on croissant (ou de A \u00e0 Z), ou de fa\u00e7on d\u00e9croissante.</p> <p>Il est possible de combiner l'ordre de tri de plusieurs colonnes, en cliquant sur la touche <code>Majuscule</code> de votre clavier en m\u00eame temps que vous cliquez sur chaque colonne \u00e0 trier.</p>"},{"location":"UTILISATION/mode_emploi/listes.html#effectuer-des-actions","title":"Effectuer des actions","text":"<p>En s\u00e9lectionnant une, plusieurs ou la totalit\u00e9 des fiches, vous pouvez effectuer diff\u00e9rentes actions.</p> <ul> <li>Pour s\u00e9lectionner une ou plusieurs fiches, cliquez simplement sur le carr\u00e9 \u00e0 gauche de la fiche.  </li> <li>Pour s\u00e9lectionner toutes les fiches, cliquer sur le premier carr\u00e9 \u00e0 gauche, au dessus de la liste. En faisant ainsi, vous verrez apparaitre une s\u00e9lection \u00e0 c\u00f4t\u00e9 de toutes les fiches.</li> </ul> <p>Une fois votre s\u00e9lection faite, vous pouvez cliquer sur le bouton <code>Actions</code>, qui vous proposera plusieurs possibilit\u00e9s</p> Nom de l'action Description de l'action Ajouter une activit\u00e9 Cette action sera document\u00e9e ult\u00e9rieurement Courriel : planifier/envoyer un mailing Permet d'envoyer un mailing de masse aux personnes s\u00e9lectionn\u00e9es Download Spreadsheet Permet de t\u00e9l\u00e9charger les informations affich\u00e9s \u00e0 l'\u00e9cran dans un fichier Excel ou PDF Exporter Contact Permet de t\u00e9l\u00e9charger de nombreuses informations concernant les fiches s\u00e9lectionn\u00e9es, en plus de celles affich\u00e9es \u00e0 l'\u00e9cran Groupes - ajouter les contacts Propose de rajouter les contacts s\u00e9lectionn\u00e9s au groupe que vous choisirez. Imprimer/fusionner un document permet de r\u00e9aliser des courriers (du type publipostage) Etiquettes pour la Poste - imprimer Permet d'imprimer des \u00e9tiquettes autocollantes Activer El\u00e9ment de liste de choix Permet la r\u00e9activation des \u00e9l\u00e9ments s\u00e9lectionn\u00e9es, et donc leur utilisation dans CiviParoisse D\u00e9sactiver El\u00e9ments de liste de choix D\u00e9sactive les \u00e9l\u00e9ments s\u00e9lectionn\u00e9es, pour qu'ils ne soient plus utilisables dans CiviParoisse (sans les supprimer d\u00e9finitivement) <p>Prise en compte du contexte de la liste</p> <p>Les actions sont propos\u00e9es selon le contexte de la liste. Cela signifie que toutes les actions ne sont pas syst\u00e9matiquement disponibles.</p>"},{"location":"UTILISATION/mode_emploi/listes.html#quelques-listes-particulieres-et-leur-utilisation","title":"Quelques listes particuli\u00e8res et leur utilisation","text":""},{"location":"UTILISATION/mode_emploi/listes.html#liste-des-conseillers-presbyteraux","title":"Liste des Conseillers Presbyt\u00e9raux","text":"<p>Cette liste affiche les Conseillers Presbyt\u00e9raux avec leur mandat actuel, et leurs \u00e9ventuels mandants pass\u00e9s. Elle n'affiche pas le nom des anciens Conseillers Presbyt\u00e9raux.</p> <p>Quelques conseils avant d'utiliser cette liste :</p> <ul> <li>Placez les Conseillers Presbyt\u00e9raux actuels dans le Groupe Conseil Presbyt\u00e9ral</li> <li>Enlevez les anciens Conseillers Presbyt\u00e9raux du Groupe Conseil Presbyt\u00e9ral</li> <li>Cr\u00e9ez une relation entre la fiche de l'Individu et celle de la paroisse pour indiquer comment le Conseiller a \u00e9t\u00e9 \u00e9lu : est Membre \u00e9lu de, est Membre de droit, est Membre invit\u00e9, etc...<ul> <li>Dans le champ Date de d\u00e9but, indiquez la date de d\u00e9but du mandat (= jour de l'\u00e9lection, sauf exceptions)</li> <li>Dans le champ Date de fin, indiquez la date de fin du mandat (= 6 ann\u00e9es apr\u00e8s le jour de l'\u00e9lection, sauf exceptions)</li> <li>Si un Conseiller est r\u00e9\u00e9lu, cr\u00e9ez une nouvelle relation. Ne pas prolonger la date de la premi\u00e8re relation, et ne supprimer pas non plus cette premi\u00e8re relation. Cela permet de savoir combien de mandats ont \u00e9t\u00e9 effectu\u00e9s.</li> </ul> </li> <li>Et cr\u00e9ez une relation entre la fiche de l'Individu et celle de la paroisse pour indiquer son \u00e9ventuel r\u00f4le au sein du Conseil Presbyt\u00e9ral : est Pr\u00e9sident de, est Tr\u00e9sorier de , est Tr\u00e9sorier, etc...<ul> <li>Dans le champ Date de d\u00e9but, indiquez la date de d\u00e9but du r\u00f4le (= jour de l'\u00e9lection du bureau, par exemple)</li> <li>Dans le champ Date de fin, ne pas indiquer la date de fin du mandat tant qu'elle n'est pas connue</li> <li>Si un Conseiller poursuit son r\u00f4le (de Tr\u00e9sorier, de Pr\u00e9sident, etc...) sur plusieurs mandats, ne pas cr\u00e9er ici de nouvelles relations (\u00e0 la diff\u00e9rence de la partie ci-dessus relative au mandat des conseillers). Indiquez la date de fin du r\u00f4le lorsque vous la connaitrez.</li> </ul> </li> </ul> <p>Quelques conseils pour bien utiliser cette liste :</p> <ul> <li>Pensez \u00e0 bien choisir le groupe Conseil Presbyt\u00e9ral dans le crit\u00e8res Groupe en haut de page. Sans ce choix, la liste s'affichera vide.</li> <li>Si n\u00e9cessaire, il est possible de limiter l'affichage \u00e0 la paroisse, en saisissant tout ou partie du nom de la paroisse dans le champ Paroisse.</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html","title":"Nouveaut\u00e9s dans CiviParoisse","text":"<p>Les informations ci-dessous vous indiquent comment \u00e9volue CiviParoisse au fil du temps, en vous d\u00e9crivant les nouveaut\u00e9s.</p>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-151-printemps-2025","title":"Version 1.51 - Printemps 2025","text":"<p>Nouvelles fonctions</p> <ul> <li>Nouvelles listes<ul> <li>Bapt\u00eames</li> <li>Pr\u00e9sentations</li> <li>Confirmations</li> <li>Mariages</li> <li>D\u00e9c\u00e8s</li> <li>Composition d'un Groupe</li> <li>Participants \u00e0 un Ev\u00e9nement</li> </ul> </li> <li>Rajouts de religions dans la liste d\u00e9roulante</li> <li>Ajout du nombre d'\u00e9lecteurs dans la Liste Electorale</li> <li>Suppression du pr\u00e9fixe Mlle (remplac\u00e9 par Mme)</li> <li>Liste Conseil Presbyt\u00e9ral : modification de l'ordre de tri (maintenant : par fonction)</li> </ul> <p>Evolutions techniques</p> <ul> <li>Mise \u00e0 jour de Drupal vers la version 10.4.6</li> <li>Moteur de recherche de la Documentation : s\u00e9paration des r\u00e9sultats venant du  Mode d'Emploi et de la Technique</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-150-hiver-2024","title":"Version 1.50 - Hiver 2024","text":"<p>Nouvelles fonctions</p> <p>Pas de nouvelles fonctions dans la version 1.50</p> <p>Evolutions techniques</p> <ul> <li>Mise \u00e0 jour de CiviCRM vers la version 5.81.0</li> <li>Mise \u00e0 jour de Drupal vers la version 10.4.0</li> <li>Mise \u00e0 jour d'extensions CiviCRM<ul> <li>Mosaico : version 3.6</li> <li>Geocoder : version 1.13</li> <li>Recent Menu : version 1.6</li> <li>Roles et D\u00e9l\u00e9gations : version 1.3</li> </ul> </li> <li>Corrections du mode d'emploi Utilisateurs, pour int\u00e9grer les changements des r\u00e9centes mises \u00e0 jour</li> </ul> <p>Les versions 1.48 et 1.49 \u00e9taient uniquement des versions techniques, sans modifications pour les utilisateurs</p>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-147-automne-2024","title":"Version 1.47 - Automne 2024","text":"<p>Nouvelles fonctions</p> <ul> <li>Rajout de nouvelles listes<ul> <li>Registre : liste des naissances</li> <li>Liste avec la composition du Conseil Presbyt\u00e9ral (pour en savoir plus)</li> </ul> </li> <li>Page des personnes ressources \u00e0 contacter (disponible en cliquant sur le bouton Aide en ligne dans CiviParoisse)</li> <li>Cr\u00e9ation automatique d'un Groupe Conseil Presbyt\u00e9ral et d'un Groupe D\u00e9sabonnement (qui est n\u00e9cessaire pour vos envois de mails en masse)</li> <li>Am\u00e9lioration de la documentation utilisateur<ul> <li>Adh\u00e9sion : cr\u00e9er une adh\u00e9sion sur une fiche</li> <li>Envoi de e-mails : effectuer un envoi de mails en masse</li> <li>Relations : mettre en place une relation</li> </ul> </li> </ul> <p>Evolutions techniques</p> <ul> <li>Am\u00e9liorations des performances techniques : CiviParoisse fonctionne plus rapidement</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-146-printemps-2024","title":"Version 1.46 - Printemps 2024","text":"<p>Nouvelles fonctions</p> <ul> <li>Refonte totale de la page Listes, pour en simplifier l'utilisation</li> <li>Rajout de nouvelles listes<ul> <li>Liste de distribution par Quartiers</li> <li>Liste des foyers n'ayant pas d'adresses mails</li> </ul> </li> <li>Rajout de crit\u00e8res de s\u00e9lection sur des listes existantes<ul> <li>Dates d'anniversaires</li> <li>Nouveaux arrivants</li> <li>Foyers paroissiaux</li> </ul> </li> <li>Am\u00e9lioration de la documentation utilisateur<ul> <li>Page Op\u00e9rations \u00e0 mener r\u00e9guli\u00e8rement</li> <li>Page Listes</li> </ul> </li> </ul> <p>Evolutions techniques</p> <ul> <li>Passage en MySQL 8.4</li> <li>Modification du mode SQL et d\u00e9sactivation du binlog</li> <li>Travaux pour faciliter la lecture des Logs</li> <li>Modification du User g\u00e9n\u00e9rique pour plus de s\u00e9curit\u00e9</li> <li>Modification des param\u00e8tres d'utilisation des ressources</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-145-hiver-2024","title":"Version 1.45 - Hiver 2024","text":"<p>Nouvelles fonctions</p> <ul> <li>Refonte totale des pages Contr\u00f4les et Am\u00e9liorations de la base de donn\u00e9es, pour en simplifier l'utilisation</li> </ul> <p>Evolutions techniques</p> <ul> <li>Installation de nouvelles extensions Drupal<ul> <li>R\u00f4le D\u00e9l\u00e9gation 1.2. Permet de mieux maitriser les r\u00f4les donn\u00e9s aux utilisateurs, en particulier d'\u00e9viter de donner le r\u00f4le d'administrateur</li> </ul> </li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-144-automne-2023","title":"Version 1.44 - Automne 2023","text":"<p>Nouvelles fonctions</p> <ul> <li>Cr\u00e9ation de tests (unitaires et automatis\u00e9s) pour faciliter la v\u00e9rification de nouvelles versions de CiviParoisse</li> </ul> <p>Evolutions techniques</p> <ul> <li>Mise \u00e0 jour d'extensions CiviCRM :<ul> <li>Geocoder vers 1.10</li> </ul> </li> <li>Modification d'intitul\u00e9s sur le formulaire Individu, et clarification des messages d'erreur</li> <li>Clarification des consignes dans les pages Contr\u00f4les</li> <li>Corrections d'erreur dans le G\u00e9ocodage des adresses</li> <li>Corrections des droits affect\u00e9s aux utilisateurs<ul> <li>Suppression des droits permettant d'afficher le Tableau de bord d'un contact</li> <li>Autorisation de g\u00e9rer les Search Kit pour les Gestionnaires paroissiaux</li> <li>Corrections de bugs dans les droits attribu\u00e9s aux diff\u00e9rents r\u00f4les</li> </ul> </li> <li>Nettoyage du code pour le simplifier et l'optimiser</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-143-ete-2023","title":"Version 1.43 - Et\u00e9 2023","text":"<p>Nouvelles fonctions</p> <p>Pas de nouvelles fonctions dans la version 1.43</p> <p>Evolutions techniques</p> <ul> <li>Mise \u00e0 jour de CiviCRM vers 5.61.4</li> <li>Mise \u00e0 jour de Drupal vers 9.5.9</li> <li>Mise \u00e0 jour d'extensions CiviCRM :<ul> <li>RecentMenu vers 1.5</li> <li>Mosaico vers 2.12</li> </ul> </li> <li>Changements d'intitul\u00e9s sur le formulaire Individu</li> <li>Suppression du menu Support dans la barre de menu</li> <li>Rajout du lien vers la documentation CiviCRM dans la page d'aide en ligne</li> <li>Corrections de bugs dans les formulaires</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-142-printemps-2023","title":"Version 1.42 - Printemps 2023","text":"<p>Nouvelles fonctions</p> <ul> <li>Affichage des anniversaires des 7 prochains jours, en page d'accueil</li> <li>Page pour changer les noms des quartiers (pour la distribution du journal, les visiteurs, etc...). Pour en savoir plus, cliquer ici.</li> </ul> <p>Evolutions techniques</p> <ul> <li>Nouvelle pr\u00e9sentation graphique, avec le th\u00e8me Claro</li> <li>Cr\u00e9ation des r\u00f4les et permissions d'acc\u00e8s \u00e0 CiviParoisse. Pour en savoir plus, cliquer ici.</li> <li>Nettoyage du code initial, pour supprimer des rapports inutiles ou redondants</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-141-hiver-2023","title":"Version 1.41 - Hiver 2023","text":"<p>Nouvelles fonctions</p> <ul> <li>Nouveaux rapports disponibles (ces rapports sont chang\u00e9s en listes et sont am\u00e9lior\u00e9s \u00e0 partir de la version 1.46):<ul> <li>Liste des nouveaux arrivants = inscriptions des 15 derniers mois</li> <li>Liste des Individus ayant moins de 18 ans</li> <li>Liste des Individus ayant plus de 75 ans</li> <li>Liste \u00e9lectorale</li> </ul> </li> <li>Sommaire CiviParoisse en page d'accueil</li> <li>Mod\u00e8le de mail aux couleurs UEPAL</li> <li>Champ Distribution du journal rajout\u00e9 \u00e0 la fiche Foyer</li> </ul> <p>Evolutions techniques</p> <ul> <li>Activation des travaux programm\u00e9s (Cron)</li> <li>Liste compl\u00e8te des paroisses de l'UEPAL dans les listes d\u00e9roulantes</li> <li>Cr\u00e9ation d'un Groupe D\u00e9sabonnement pour les mailings courriel</li> <li>Format de page A4 standardis\u00e9 pour les impressions PDF</li> </ul>"},{"location":"UTILISATION/mode_emploi/nouveautes_CiviParoisse.html#version-100-ete-2022","title":"Version 1.00 - Et\u00e9 2022","text":"<p>Evolutions techniques</p> <ul> <li>Installation de CiviCRM 5.47.0</li> <li>Installation de Drupal 9.2</li> <li>Configuration des valeurs de base</li> </ul>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html","title":"Op\u00e9rations \u00e0 mener r\u00e9guli\u00e8rement","text":""},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#operations-a-realiser-regulierement","title":"Op\u00e9rations \u00e0 r\u00e9aliser r\u00e9guli\u00e8rement","text":""},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#ameliorer-la-qualite-des-informations","title":"Am\u00e9liorer la qualit\u00e9 des informations","text":"<p>Maintenir des informations de bonne qualit\u00e9 dans votre base de donn\u00e9es est un travail r\u00e9gulier et de longue haleine. Mais ce travail est n\u00e9cessaire pour que vous puissiez \u00e9changer au mieux avec vos paroissiens.</p> <p>CiviParoisse met \u00e0 votre disposition des outils pour effectuer ce travail d'am\u00e9lioration de la qualit\u00e9 : ce sont les pages Contr\u00f4les et Am\u00e9liorations.</p> <p>Vous acc\u00e9dez \u00e0 ces pages depuis le menu en page d'accueil ou le menu Paroisse.</p> <p>Chaque page vous permet de corriger votre base de donn\u00e9es, soit directement, soit en ouvrant une fen\u00eatre d\u00e9di\u00e9e. Le d\u00e9but de chaque page vous donne le contexte et les actions \u00e0 r\u00e9aliser. Laissez-vous guider !</p>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#liste-des-controles","title":"Liste des contr\u00f4les","text":"<ul> <li>Individus Sans Genre</li> <li>Individus Sans Civilit\u00e9</li> <li>Individus sans Statut Membre</li> <li>Individus sans lien avec Foyer ou Organisation</li> <li>Individus Majeurs avec Statut Enfant</li> <li>Individus Enfants avec Statut Chef Famille</li> <li>Individus Majeur chez leurs Parents</li> <li>Foyers avec Statut Membre</li> <li>Foyers sans relation Chef Famille</li> <li>Foyer sans Relation Membre du Foyer</li> <li>Foyers sans Mode de Distribution Journal</li> <li>Organisation avec statut Adh\u00e9sion</li> <li>E-mails en erreur</li> </ul>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#liste-des-ameliorations","title":"Liste des am\u00e9liorations","text":"<ul> <li>Individus sans Date de Naissance</li> <li>Foyers sans Adresses</li> <li>Foyers avec Ev\u00e9nement</li> <li>Foyers avec Distribution Inconnu</li> <li>Organisations sans Adresses</li> <li>Organisation sans Relations</li> <li>Organisation avec Ev\u00e9nement</li> </ul>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#actions-a-realiser","title":"Actions \u00e0 r\u00e9aliser","text":"<p>Pour chaque contr\u00f4le ou am\u00e9lioration, il est possible de r\u00e9aliser diff\u00e9rentes actions : soit une correction en ligne, soir des actions de masse.</p> <p>Faux positifs</p> <p>Chaque situation individuelle et familiale de vos paroissiens est particuli\u00e8re. La programmation mise en oeuvre pour les listes ci-dessus peut parfois provoquer des faux positifs. Ce sont des fiches qui sont signal\u00e9es en anomalie, mais qui dans la r\u00e9alit\u00e9 de votre paroissien ne sont pas une erreur. Vous \u00eates toujours invit\u00e9s \u00e0 consid\u00e9rer les r\u00e9sultats \u00e0 la lumi\u00e8re de votre connaissance de chaque paroissien, avant de r\u00e9aliser des corrections.</p>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#corriger-en-ligne","title":"Corriger en ligne","text":"<p>La plupart des \u00e9crans proposent une correction en ligne. Il est possible, pour chaque fiche, de rajouter l'information manquante en peu de clics. Vous pouvez ainsi rajouter la date de naissance, la civilit\u00e9, etc... Lorsque la correction n'est pas possible directement sur l'\u00e9cran, un lien ouvre une fen\u00eatre qui permet d'effectuer la correction n\u00e9cessaire.</p>"},{"location":"UTILISATION/mode_emploi/operations_a_mener_regulierement.html#realiser-des-actions-de-masse","title":"R\u00e9aliser des actions de masse","text":"<p>Vous pouvez s\u00e9lectionner une, plusieurs ou toutes les fiches, en cliquant sur les cases \u00e0 gauche des fiches. Une fois les fiches s\u00e9lectionn\u00e9s, en cliquant sur le bouton \"Action\", vous pouvez r\u00e9aliser les actions suivantes :</p> Nom de l'action Description de l'action Ajouter une activit\u00e9 Cette action sera document\u00e9e ult\u00e9rieurement Courriel : planifier/envoyer un mailing Permet d'envoyer un mailing de masse aux personnes s\u00e9lectionn\u00e9es, pour demander les informations manquantes par exemple Download Spreadsheet Permet de t\u00e9l\u00e9charger les informations affich\u00e9s \u00e0 l'\u00e9cran dans un fichier Excel ou PDF Imprimer/fusionner un document Permet de r\u00e9aliser des courriers (du type publipostage), pour demander les informations manquantes par exemple Etiquettes pour la Poste - imprimer Permet d'imprimer des \u00e9tiquettes autocollantes"},{"location":"UTILISATION/mode_emploi/prepaper_installation.html","title":"Pr\u00e9parer l'installation d'une nouvelle base de donn\u00e9es","text":""},{"location":"UTILISATION/mode_emploi/prepaper_installation.html#preparer-les-donnees-a-importer","title":"Pr\u00e9parer les donn\u00e9es \u00e0 importer","text":"<p>Attention</p> <p>La pr\u00e9paration et le nettoyage des donn\u00e9es d\u00e9j\u00e0 existantes, avant de les importer dans CiviParoisse, est une \u00e9tape importante du projet. Plus ce nettoyage est fait en profondeur, meilleures seront les donn\u00e9es disponibles dans CiviParoisse, et donc meilleur en sera votre utilisation et votre exp\u00e9rience</p> <p>Fichier des Individus</p> <p>Fichier des Foyers (ou des familles)</p>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html","title":"Que faire quand... ?","text":""},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#que-faire-quand","title":"Que faire quand... ?","text":""},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#une-nouvelle-famille-arrive","title":"Une nouvelle famille arrive ?","text":"<p>A l'arriv\u00e9e d'une nouvelle famille au sein de la paroisse il vous faut suivre les \u00e9tapes suivantes :</p> <ul> <li>Cr\u00e9er la fiche Foyer (En savoir plus)</li> <li>Cr\u00e9er autant de fiches Individu que de personnes composant le foyer (En savoir plus)</li> <li>Renseigner le lien avec la paroisse (En savoir plus)</li> <li>Renseigner les relations (En savoir plus)</li> <li>Inscrire chaque Individu dans le(s) groupe(s) n\u00e9cessaire(s) (En savoir plus)</li> </ul>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#une-personne-quitte-la-paroisse","title":"Une personne quitte la paroisse ?","text":"<p>Si une personne, voire toutes les personnes d'un foyer, quitte la paroisse, il est important de respecter les principes suivants :</p> <ul> <li>Ne pas supprimer les fiches Individu et Foyer, car ces personnes pourraient revenir, ou leur nouvelle paroisse pourrait vous contacter pour avoir des \u00e9l\u00e9ments d'information.</li> <li>Ne supprimer aucune information figurant dans la(les) fiche(s).</li> <li>Ne pas mettre l'adresse mail en invalide.</li> <li>Ne pas toucher aux relations (sauf s'il y a s\u00e9paration).</li> </ul> <p>Ce qu'il vous faut faire :</p> <ul> <li>Mettre fin aux Adh\u00e9sions, en indiquant une date de fin dans l'adh\u00e9sion \u00e0 la paroisse. (En savoir plus)</li> <li>Retirez la(les) personne(s) des groupes concern\u00e9s. En savoir plus)</li> <li>Changez l'adresse postale si la personne a d\u00e9m\u00e9nag\u00e9 (supprimer l'ancienne adresse si vous n'arrivez pas \u00e0 conna\u00eetre la nouvelle).</li> <li>Si possible, ajoutez une note pour indiquer en quelques mots le d\u00e9part, \u00e9ventuellement les raisons, si besoin.</li> <li>Modifiez les Pr\u00e9f\u00e9rences de communication, en cliquant sur <code>Modifiez les pr\u00e9f\u00e9rences de communication</code> dans l'onglet <code>Synth\u00e8se</code> et cochant les 4 cases :<ul> <li><code>Ne pas envoyer de courriel</code></li> <li><code>Ne pas envoyer de courrier postal</code></li> <li><code>Ne pas envoyer de sms</code></li> <li><code>Pas de mailing - opposition (opt out)</code> </li> </ul> </li> <li>Enfin, dans le menu <code>Action</code>, cliquez sur le choix <code>Supprimer</code> et confirmez en cliquant sur <code>Supprimer contact(s)</code>. Attention : ne pas cliquez sur le bouton <code>Supprimer d\u00e9finitivement</code>, vous perdriez d\u00e9finitivement toutes les informations !  </li> </ul> <p> Pensez \u00e0 refaire les m\u00eames \u00e9tapes pour les diff\u00e9rentes personnes et pour leur Foyer, si c'est tout un foyer qui d\u00e9m\u00e9nage.</p>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#une-personne-decede","title":"Une personne d\u00e9c\u00e8de ?","text":"<p>Pour enregistrer le d\u00e9c\u00e8s d'une personne, rendez-vous sur la fiche Individu de la personne et effectuez les modifications suivantes :</p> <ul> <li>Dans les Donn\u00e9es d\u00e9mographiques, cochez la case <code>Le contact est d\u00e9c\u00e9d\u00e9</code> puis indiquez la date du d\u00e9c\u00e8s.</li> <li>Modifiez les Pr\u00e9f\u00e9rences de communication de la m\u00eame fa\u00e7on que pour le cas de figure d'une personne qui d\u00e9m\u00e9nage, en cochant les 4 cases :<ul> <li><code>Ne pas envoyer de courriel</code></li> <li><code>Ne pas envoyer de courrier postal</code></li> <li><code>Ne pas envoyer de sms</code></li> <li><code>Pas de mailing - opposition (opt out)</code></li> </ul> </li> <li>Au niveau de l'\u00e9tat civil, renseignez si possible la date des obs\u00e8ques et indiquez au sein de quelle paroisse ont eu lieu les obs\u00e8ques.</li> <li>Retirez la personne des groupes auxquels elle appartenait, en utilisant la fonction <code>Retirer</code>. Attention : Ne pas utiliser la fonction <code>Supprimer</code>, afin de conserver un historique de l'activit\u00e9.</li> <li>V\u00e9rifiez que les Adh\u00e9sions soient pass\u00e9es en <code>Adh\u00e9sions en attente ou exprir\u00e9es</code>. Attention : Ne pas utiliser la fonction <code>Supprimer</code> afin de conserver l'historique.</li> <li>Cr\u00e9ez une Note avec les coordonn\u00e9es de contact de la famille. Cela pourra servir \u00e0 les contacter en vue d'un culte des d\u00e9funts.</li> <li>Sur la fiche Foyer, modifiez l'intitul\u00e9 du foyer pour enlever le nom du d\u00e9funt. S'il n'y a plus personne au sein du foyer, supprimez le foyer.</li> <li>Si besoin, ajoutez la date de veuvage sur la fiche Individu du conjoint survivant.</li> </ul>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#un-couple-se-marie","title":"Un couple se marie ?","text":"<p>Partie provisoire (sera revue en 2025)</p> <p>Lorsque qu'un couple se marie et que les deux foyers \u00e9taient auparavant s\u00e9par\u00e9s au sein de votre paroisse, il vous faudra fusionner les deux foyers puis renommer le foyer unique obtenu. Pour cela :</p> <ul> <li>Ouvrez les fiches Foyers des deux foyers.</li> <li>Renommez chaque Foyer d'un m\u00eame nom provisoire (par exemple Foyer mari\u00e9)</li> <li>Allez dans le menu <code>Rechercher</code> / <code>Rechercher des contacts</code></li> <li>Saisissez le nom provisoire du Foyer, et cliquez sur <code>Rechercher</code></li> <li>Dans la fen\u00eatre de r\u00e9sultat, s\u00e9lectionnez les deux foyers puis cliquez sur <code>Actions</code> et choisissez <code>Fusionner les doublons</code>. Eventuellement apr\u00e8s avoir \"Permuter les contacts original et doublon\", pour que le foyer de Monsieur soit \u00e0 droite.</li> <li>S\u00e9lectionnez les donn\u00e9es \u00e0 conserver du Foyer en doublon.</li> <li>Changez le nom du Foyer pour y inscrire le (les) noms(s) de famille et les deux pr\u00e9noms.</li> <li>V\u00e9rifiez ensuite que les Relations se sont mises correctement, c'est-\u00e0-dire que les deux membres du foyer sont bien \"Chef de famille de\".</li> <li>Si vous ne l'avez pas fait avant, pensez \u00e0 cr\u00e9er la relation \"Conjoint de\" entre les deux fiches Individus.</li> <li>V\u00e9rifiez aussi, si besoin, que les enfants sont bien rattach\u00e9s au nouveau foyer.</li> <li>Eventuellement, modifiez le nom de famille de Madame.</li> </ul>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#un-couple-divorce-ou-se-separe","title":"Un couple divorce ou se s\u00e9pare ?","text":"<p>En cas de s\u00e9paration, il est n\u00e9cessaire de modifier le fiche Individu de chacun des conjoints comme suit :</p> <ul> <li>Modifiez la relation <code>Conjoint de</code> en indiquant une date de fin de relation. Attention : ne pas supprimer la relation pour en conserver la trace historique.</li> <li>Cocher <code>Oui</code> dans la ligne <code>Divorc\u00e9(e) ?</code> de la partie <code>Etat civil</code> dans l'onglet <code>Synth\u00e8se</code>. Si l'information est connue, indiquez aussi la date du divorce.</li> <li>Renseignez si besoin une note pour pr\u00e9ciser les informations en votre possession sur le divorce.</li> </ul> <p>Il est ensuite important de modifier les Foyers comme suit :</p> <ul> <li>Cr\u00e9er un nouveau Foyer pour l'un des conjoints et mettre en <code>Chef de famille</code> de ce foyer celui qui va y r\u00e9sider.</li> <li>Renommer le Foyer existant au nom de l'autre conjoint.</li> <li>Sur la fiche Individu de chaque conjoint, modifiez les relations <code>Chef de famille</code> et <code>Membre du foyer</code> pour qu'ils correspondent au bon foyer.</li> </ul> <p>Si les conjoints ont des enfants, il faut \u00e9galement modifier la fiche Individu de chaque enfant comme suit :</p> <ul> <li>Cr\u00e9er une relation <code>Membre de</code> dans le nouveau Foyer cr\u00e9e ci-dessus</li> <li>V\u00e9rifier que la relation <code>Membre de</code> soit bien rest\u00e9 dans l'ancien Foyer. La recr\u00e9er au besoin.</li> <li>V\u00e9rifier que la relation <code>Enfant de</code> ou <code>Parent de</code> soit toujours pr\u00e9sente entre l'enfant et ses parents</li> </ul> <p>Si une des personnes a clairement manifest\u00e9 son intention de quitter la paroisse, ne pas oublier de d\u00e9rouler la proc\u00e9dure ad\u00e9quate : \"Une personne quitte la paroisse\".</p>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#une-personne-ne-veut-plus-recevoir-de-communication","title":"Une personne ne veut plus recevoir de communication ?","text":"<p>Partie en cours d'\u00e9criture</p> <p>Lorsqu'une personne ne veut plus recevoir la feuille mensuelle, il vous suffit de la supprimer du groupe dynamique \"Feuille mensuelle - envoi\" que vous aurez pr\u00e9c\u00e9demment cr\u00e9\u00e9 pour lister tous les destinataires.</p> <p>Pour cela :</p> <ul> <li>Allez sur la fiche de la personne, dans l'onglet \"Groupe\".</li> <li>Ouvrez la partie \"Groupe dynamique\" et cliquez sur le lien du groupe \"Feuille mensuelle - Envoi\"</li> <li>Dans la liste du groupe, retrouvez la ligne de la personne \u00e0 supprimer et cochez sa case (\u00e0 gauche de son nom).</li> <li>Cliquez sur \"Actions\" et choisissez \"Contact - supprimer\".</li> </ul> <p>Cette manipulation est valable aussi pour enlever la personne d'une liste automatique de cartes d'anniversaire ou du groupe de jeunes se pr\u00e9parant \u00e0 la confirmation.</p> <p>Si par la suite la personne change d'avis, il faudra la rajouter manuellement au groupe.</p> <p>Attention</p> <p>Si vous supprimez son adresse mail, ou cochez la case <code>Ne pas envoyez de courriel</code>, la personne ne recevra plus aucun mail de votre paroisse. Soyez prudent avec cette option, et privil\u00e9giez autant que possible la suppression d'un groupe comme indiqu\u00e9 ci-dessus.</p>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#un-courrier-revient-car-la-personne-a-change-dadresse","title":"Un courrier revient car la personne a chang\u00e9 d'adresse ?","text":"<p>Partie en cours d'\u00e9criture</p> <p>Si vos tentatives pour trouver sa nouvelle adresse ont \u00e9chou\u00e9es, la proc\u00e9dure est la suivante :</p> <ul> <li>Allez sur la fiche Individu de la personne.</li> <li>Supprimez l'adresse.</li> <li>Ajoutez une note, en indiquant que le courrier revient avec la mention adresse erron\u00e9e.</li> <li>N'oubliez pas de supprimer aussi l'adresse de la fiche Foyer et sur celles des autres membres du foyer.</li> </ul>"},{"location":"UTILISATION/mode_emploi/que_faire_quand.html#une-personne-na-pas-dadresse-mail-ou-ne-veut-pas-la-communiquer","title":"Une personne n'a pas d'adresse mail ou ne veut pas la communiquer ?","text":"<p>Partie en cours d'\u00e9criture</p> <p>Si un paroissien n'a pas d'adresse mail ou ne souhaite pas nous la communiquer, il est conseill\u00e9 de renseigner CiviParoisse pour lui \u00e9viter des relances r\u00e9guli\u00e8res (dans le cadre de la fiabilisation de la base). Pour cela :</p> <ul> <li>Modifiez les pr\u00e9f\u00e9rences de communication en cliquant sur <code>Modifiez les pr\u00e9f\u00e9rences de communication</code> dans l'onglet <code>Synth\u00e8se</code> et en cochant la case <code>Ne pas envoyer de courriel</code> puis enregistrez.</li> <li>Dans l'onglet <code>Notes</code> de sa fiche, cliquez sur <code>Ajouter une note</code> puis indiquez en titre \"Courriel\" ou \"Mail\", laissez <code>Protection de la vie priv\u00e9e</code> \u00e0 <code>Aucun</code>. Puis indiquez dans la note, selon le besoin, l'une des lignes suivantes :  </li> <li>N'a pas d'adresse e-mail  </li> <li>Ne souhaite pas communiquer son adresse e-mail  </li> <li>Ne souhaite pas que son adresse e-mail (ajoutez entre parenth\u00e8se l'adresse) soit utilis\u00e9e par la paroisse.  </li> <li>Ne souhaite plus que son adresse e-mail (ajoutez entre parenth\u00e8se l'adresse) soit utilis\u00e9e par la paroisse.</li> </ul>"},{"location":"UTILISATION/mode_emploi/relations.html","title":"G\u00e9rer les relations","text":""},{"location":"UTILISATION/mode_emploi/relations.html#gerer-les-relations","title":"G\u00e9rer les relations","text":"<p>Les relations explicitent le lien entre des individus, mais aussi entre des individus et la paroisse, ou entre des individus et des associations (ou des entreprises) que vous aurez enregistr\u00e9es.</p>"},{"location":"UTILISATION/mode_emploi/relations.html#liste-des-relations","title":"Liste des relations","text":"<p>CiviParoisse propose de nombreuses relations  , que nous pouvons classer par cat\u00e9gorie :</p> Cat\u00e9gorie Liste des relations Familiale Enfant de Parent de Conjoint de Partenaire de Grand parent de Fr\u00e8re ou soeur de Parrain ou Marraine de Appartenance au Foyer Chef de famille de Membre du foyer Fonction ou \u00e9lection Membre \u00e9lu.e de Membre de droit de Membre invite.e de Membre coopte.e de Pasteur de Diacre de D\u00e9l\u00e9gu\u00e9.e de Pr\u00e9sident.e de Vice-Pr\u00e9sident.e de Secr\u00e9taire de Tr\u00e9sorier.\u00e8re de Receveur.e de B\u00e9n\u00e9vole de Employ\u00e9.e de Animateur.trice de <p>Ceci va vous permettre de tisser assez finement les liens entre les uns et les autres.</p> <p>Attention</p> <p>Il est important que chaque Individu soit en relation avec au moins un Foyer ou une Organisation. Au sein d'un Foyer, chaque Individu (parent comme enfant) est \u00e0 enregistrer comme membre du Foyer ; et les parents sont \u00e9galement \u00e0 enregistrer comme chef de famille de.</p> <p>Conseil</p> <p>Vous pouvez ainsi enregistrer la relation entre les membres du Conseil presbyt\u00e9ral et la paroisse. Pour des relations de ce genre, il est conseill\u00e9 de mettre la date de l'\u00e9lection ou de prise de fonction et la date de fin si elle est d\u00e9j\u00e0 connue.</p>"},{"location":"UTILISATION/mode_emploi/relations.html#mettre-en-place-une-relation","title":"Mettre en place une relation","text":"<p>Mise en place automatique des relations</p> <p>En utilisant les formulaires de la page d'accueil, les relations sont g\u00e9n\u00e9r\u00e9es automatiquement.</p> <p>Sur chaque fiche, il est possible de cr\u00e9er manuellement les relations.</p> <ul> <li>Commencez par s\u00e9lectionner la fiche concern\u00e9e.</li> <li>Cliquez sur l'onglet  <code>Relations</code></li> <li>Cliquer sur le bouton  <code>Ajouter une relation</code></li> <li>S\u00e9lectionnez le <code>Type de relation</code> dans la liste d\u00e9roulante</li> <li>Choisissez le ou les contacts<ul> <li> Il est possible de s\u00e9lectionner plusieurs contacts \u00e0 la fois</li> </ul> </li> <li>Si besoin, indiquez une date de d\u00e9but et/ou une date de fin</li> <li>Cliquer sur le bouton  <code>Enregistrer la relation</code></li> </ul>"},{"location":"UTILISATION/mode_emploi/relations.html#modifier-une-relation","title":"Modifier une relation","text":"<p>Partie en cours d'\u00e9criture</p>"},{"location":"UTILISATION/mode_emploi/relations.html#finir-une-relation","title":"Finir une relation","text":"<p>N'utilisez pas la suppression</p> <p>Afin de conserver l'historique des relations, n'utilisez jamais la touche Supprimer.</p> <p>Pour la fin d'une relation, deux cas possibles :</p> <ul> <li>Vous avez d\u00e9j\u00e0 indiqu\u00e9 une date de fin. La relation se d\u00e9sactivera automatiquement \u00e0 la date indiqu\u00e9e.</li> <li>Il n'y avait pas de date de fin, il suffit alors de cliquer \u00e0 la fin de la ligne de la relation sur le bouton , de cliquer sur le choix <code>Mettre \u00e0 jour la relation</code> et ajouter une date de fin.</li> </ul> <p>CiviParoisse garde en m\u00e9moire toutes les relations pr\u00e9sentes et pass\u00e9es, c'est ainsi que les relations qui ont pris fin se retrouvent en bas des relations actives, dans la rubrique <code>Relations inactives</code>.</p>"},{"location":"UTILISATION/mode_emploi/ressources.html","title":"Ressources utiles","text":"<p>Quelques documents int\u00e9ressants : </p> <ul> <li>https://docs.civicrm.org/user/en/latest/</li> </ul>"}]}